System.register([],(function(t,e){"use strict";return{execute:function(){t({BitMask:Yt,CCClass:He,CacheMode:void 0,DebugMode:void 0,ECollider2DType:void 0,EJoint2DType:void 0,EPhysics2DDrawFlags:void 0,ERaycast2DType:void 0,ERigidBody2DType:void 0,Enum:Jt,Eventify:sn,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,Overflow:void 0,Physics2DManifoldType:void 0,PhysicsGroup:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:dE,WorldNode3DToWorldNodeUI:mE,absMax:ii,absMaxComponent:ni,approx:Gn,assert:m,assertID:I,bezier:Af,bezierByTime:Gf,ccenum:$t,clamp:Un,clamp01:kn,color:Fi,computeRatioByType:xG,createDefaultPipeline:VB,debug:v,deserialize:Th,earcut:A1,enumerableProps:ri,equals:Vn,error:d,errorID:E,find:NR,fragmentText:fY,getBaselineOffset:function(){return 0},getError:R,getPathFromRoot:function(t,e){for(var n=t,i="";null!==n&&n!==e;)i=n.name+"/"+i,n=n.parent;return i.slice(0,-1)},getSerializationMetadata:function(t){return t[Qc]},getWorldTransformUntilRoot:function(t,e,n){for(Ei.identity(n);t!==e;)Ei.fromRTS(tW,t.rotation,t.position,t.scale),Ei.multiply(n,tW,n),t=t.parent;return n},instantiate:kh,inverseLerp:ei,isCustomTargetModifier:sW,isDisplayStats:D,isElementModifier:aW,isPropertyModifier:oW,isUnicodeCJK:lY,isUnicodeSpace:uY,isValid:Ze,lerp:Hn,log:f,logID:A,markAsWarning:void 0,mat4:Ii,murmurhash2_32_gc:xa,nextPow2:Zn,pingPong:ti,pseudoRandom:Kn,pseudoRandomRange:Jn,pseudoRandomRangeInt:Qn,quat:bi,randomRange:Xn,randomRangeInt:Yn,rect:Oi,removeProperty:void 0,repeat:$n,replaceProperty:void 0,safeMeasureText:hY,sampleAnimationCurve:yG,setDefaultLogTimes:function(t){t>0&&(hC=t)},setDisplayStats:B,size:Bi,toDegree:Wn,toRadian:jn,tween:Hft,tweenUtil:jft,v2:_i,v3:ci,v4:pi,warn:p,warnID:b});var n="undefined"==typeof window?global:window,i=t("cclegacy",{_global:n});i.internal={},n.CC_BUILD=!0,n.CC_TEST=!1,n.CC_EDITOR=false,n.CC_PREVIEW=!1,n.CC_DEV=!1,n.CC_DEBUG=!1,n.CC_JSB=!1,n.CC_BYTEDANCE=!1,n.CC_WECHAT=!1,n.CC_ALIPAY=!1,n.CC_XIAOMI=!1,n.CC_BAIDU=!1,n.CC_COCOSPLAY=!1,n.CC_HUAWEI=!1,n.CC_OPPO=!1,n.CC_VIVO=!1,n.CC_MINIGAME=!1,n.CC_RUNTIME_BASED=!1,n.CC_SUPPORT_JIT=!0,n.CC_UI_GPU_DRIVEN=!1;var r=t("VERSION","3.4.1");n.CocosEngine=i.ENGINE_VERSION=r,n.cc=i;var o="https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md",a=null,s=console.log.bind(console),c=s,l=s,u=function(t,e){if(!t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];console.log("ASSERT: "+_.apply(void 0,[e].concat(i)))}},h=s;function _(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return i.js.formatStr.apply(null,[t].concat(n))}function f(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return s.apply(void 0,[t].concat(n))}function p(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return c.apply(void 0,[t].concat(n))}function d(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return l.apply(void 0,[t].concat(n))}function m(t,e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return u.apply(void 0,[t,e].concat(i))}function v(){return h.apply(void 0,arguments)}function g(t){if(s=c=l=u=h=function(){},t!==w.NONE){if(t>w.ERROR){var e=function(t){if(i.game.canvas){if(!a){var e=document.createElement("Div");e.setAttribute("id","logInfoDiv"),e.setAttribute("width","200"),e.setAttribute("height",i.game.canvas.height);var n=e.style;n.zIndex="99999",n.position="absolute",n.top=n.left="0",(a=document.createElement("textarea")).setAttribute("rows","20"),a.setAttribute("cols","30"),a.setAttribute("disabled","true");var r=a.style;r.backgroundColor="transparent",r.borderBottom="1px solid #cccccc",r.borderTopWidth=r.borderLeftWidth=r.borderRightWidth="0px",r.borderTopStyle=r.borderLeftStyle=r.borderRightStyle="none",r.padding="0px",r.margin="0px",e.appendChild(a),i.game.canvas.parentNode.appendChild(e)}a.value=a.value+t+"\r\n",a.scrollTop=a.scrollHeight}};l=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];e("ERROR :  "+_.apply(void 0,[t].concat(i)))},u=function(t,n){if(!t){for(var i=arguments.length,r=new Array(i>2?i-2:0),o=2;o<i;o++)r[o-2]=arguments[o];e("ASSERT: "+_.apply(void 0,[n].concat(r)))}},t!==w.ERROR_FOR_WEB_PAGE&&(c=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];e("WARN :  "+_.apply(void 0,[t].concat(i)))}),t===w.INFO_FOR_WEB_PAGE&&(s=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];e(_.apply(void 0,[t].concat(i)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),l=console.error.bind?console.error.bind(console):function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return console.error.apply(console,[t].concat(n))},u=function(t,e){if(!t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];var o=_.apply(void 0,[e].concat(i));throw new Error(o)}});if(t!==w.ERROR&&(c=console.warn.bind?console.warn.bind(console):function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return console.warn.apply(console,[t].concat(n))}),t<=w.INFO&&(s=console.log.bind?console.log.bind(console):function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return console.log.apply(console,[t].concat(n))}),t<=w.VERBOSE&&"function"==typeof console.debug){var n=console.debug.bind(console);h=function(){return n.apply(void 0,arguments)}}}}function y(t){d(t.stack||t)}function x(t){return function(e){for(var n=t+" "+e+", please go to "+o+"#"+e+" to see details.",i=arguments.length,r=new Array(i>1?i-1:0),a=1;a<i;a++)r[a-1]=arguments[a];return 0===r.length?n:n+" Arguments: "+r.join(", ")}}var S=x("Log");function A(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];f(S.apply(void 0,[t].concat(n)))}var C=x("Warning");function b(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];p(C.apply(void 0,[t].concat(n)))}var T=x("Error");function E(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];d(T.apply(void 0,[t].concat(n)))}var w,P=x("Assert");function I(t,e){if(!t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];m(!1,P.apply(void 0,[e].concat(i)))}}function R(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return T.apply(void 0,[t].concat(n))}function D(){return!!i.profiler&&i.profiler.isShowingStats()}function B(t){i.profiler&&(t?i.profiler.showStats():i.profiler.hideStats(),i.game.config.showFPS=!!t)}!function(t){t[t.NONE=0]="NONE",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",t[t.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",t[t.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(w||(w=t("DebugMode",{})));var M=Object.freeze({__proto__:null,log:f,warn:p,error:d,assert:m,debug:v,_resetDebugSetting:g,_throw:y,logID:A,warnID:b,errorID:E,assertID:I,get DebugMode(){return w},getError:R,isDisplayStats:D,setDisplayStats:B});function O(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function N(t,e,n){return e&&O(t.prototype,e),n&&O(t,n),t}function L(){return(L=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t}).apply(this,arguments)}function F(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,V(t,e)}function z(t){return(z=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function V(t,e){return(V=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function G(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function U(t,e,n){return(U=G()?Reflect.construct:function(t,e,n){var i=[null];i.push.apply(i,e);var r=new(Function.bind.apply(t,i));return n&&V(r,n.prototype),r}).apply(null,arguments)}function k(t){var e="function"==typeof Map?new Map:void 0;return(k=function(t){if(null===t||(n=t,-1===Function.toString.call(n).indexOf("[native code]")))return t;var n;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,i)}function i(){return U(t,arguments,z(this).constructor)}return i.prototype=Object.create(t.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),V(i,t)})(t)}function H(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function j(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function W(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return j(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?j(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0;return function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=t[Symbol.iterator]()).next.bind(n)}function q(t,e,n,i){n&&Object.defineProperty(t,e,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function X(t,e,n,i,r){var o={};return Object.keys(i).forEach((function(t){o[t]=i[t]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=n.slice().reverse().reduce((function(n,i){return i(t,e,n)||n}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(t,e,o),o=null),o}var Y=function(){function t(t){this.i=0,this.array=t}var e=t.prototype;return e.remove=function(t){var e=this.array.indexOf(t);e>=0&&this.removeAt(e)},e.removeAt=function(t){this.array.splice(t,1),t<=this.i&&--this.i},e.fastRemove=function(t){var e=this.array.indexOf(t);e>=0&&this.fastRemoveAt(e)},e.fastRemoveAt=function(t){var e=this.array;e[t]=e[e.length-1],--e.length,t<=this.i&&--this.i},e.push=function(t){this.array.push(t)},N(t,[{key:"length",get:function(){return this.array.length},set:function(t){this.array.length=t,this.i>=t&&(this.i=t-1)}}]),t}();function K(t,e){t.splice(e,1)}function J(t,e){var n=t.length;e<0||e>=n||(t[e]=t[n-1],t.length=n-1)}function Q(t,e){var n=t.indexOf(e);return n>=0&&(K(t,n),!0)}function Z(t,e){var n=t.findIndex(e);if(n>=0){var i=t[n];return K(t,n),i}}function $(t,e){return t.indexOf(e)>=0}var tt=Object.freeze({__proto__:null,removeAt:K,fastRemoveAt:J,remove:Q,fastRemove:function(t,e){var n=t.indexOf(e);n>=0&&(t[n]=t[t.length-1],--t.length)},removeIf:Z,verifyType:function(t,e){if(t&&t.length>0)for(var n,i=W(t);!(n=i()).done;)if(!(n.value instanceof e))return A(1300),!1;return!0},removeArray:function(t,e){for(var n=0,i=e.length;n<i;n++)Q(t,e[n])},appendObjectsAt:function(t,e,n){return t.splice.apply(t,[n,0].concat(e)),t},contains:$,copy:function(t){for(var e=t.length,n=new Array(e),i=0;i<e;i+=1)n[i]=t[i];return n},MutableForwardIterator:Y}),et=function(){function t(t){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=t?t+".":""}return t.prototype.getNewId=function(){return this.prefix+ ++this.id},t}();et.global=new et("global");var nt=new et("TmpCId."),it="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),rt="__cid__";function ot(t){return"number"==typeof t||t instanceof Number}function at(t){return"string"==typeof t||t instanceof String}function st(t){for(var e in t)return!1;return!0}var ct,lt=(ct={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(t,e,n,i,r){ct.value=n,ct.writable=i,ct.enumerable=r,Object.defineProperty(t,e,ct),ct.value=void 0}),ut=function(){var t={get:void 0,set:void 0,enumerable:!1};return function(e,n,i,r,o,a){void 0===o&&(o=!1),void 0===a&&(a=!1),"boolean"==typeof r&&(o=r,r=void 0),t.get=i,t.set=r,t.enumerable=o,t.configurable=a,Object.defineProperty(e,n,t),t.get=void 0,t.set=void 0}}(),ht=function(){var t={get:void 0,enumerable:!1,configurable:!1};return function(e,n,i,r,o){t.get=i,t.enumerable=r,t.configurable=o,Object.defineProperty(e,n,t),t.get=void 0}}(),_t=function(){var t={set:void 0,enumerable:!1,configurable:!1};return function(e,n,i,r,o){t.set=i,t.enumerable=r,t.configurable=o,Object.defineProperty(e,n,t),t.set=void 0}}();function ft(t){var e=Object.create(null);return t&&(e["."]=1,e["/"]=1,delete e["."],delete e["/"]),e}function pt(t){if("function"==typeof t){var e=t.prototype;if(e&&e.hasOwnProperty("__classname__")&&e.__classname__)return e.__classname__;var n="";if(t.name&&(n=t.name),t.toString){var i,r=t.toString();(i="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===i.length&&(n=i[1])}return"Object"!==n?n:""}return t&&t.constructor?pt(t.constructor):""}function dt(t,e,n,i){var r=/([^.]+)$/,o=r.exec(e)[0],a=r.exec(n)[0];function s(){return this[a]}i?ut(t,o,s,(function(t){this[a]=t})):ht(t,o,s)}function mt(t,e,n,i){for(var r in n)dt(t,e+"."+r,n[r],i)}var vt=/(%d)|(%s)/,gt=/%s/;function yt(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];if(0===arguments.length)return"";if(0===n.length)return""+t;var r="string"==typeof t&&vt.test(t);if(r)for(var o,a=W(n);!(o=a()).done;){var s=o.value,c="number"==typeof s?vt:gt;if(c.test(t)){var l=""+s;t=t.replace(c,l)}else t+=" "+s}else for(var u,h=W(n);!(u=h()).done;){var _=u.value;t+=" "+_}return t}function xt(){for(var t=arguments.length-1,e=new Array(t),n=0;n<t;++n)e[n]=arguments[n+1];return e}function St(t,e){for(;t;){var n=Object.getOwnPropertyDescriptor(t,e);if(n)return n;t=Object.getPrototypeOf(t)}return null}function At(t,e,n){var i=St(e,t);i&&Object.defineProperty(n,t,i)}function Ct(t){t=t||{};for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){E(5402,a);continue}for(var s in a)s in t||At(s,a,t)}}return t}function bt(t){t=t||{};for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){E(5403,a);continue}for(var s in a)At(s,a,t)}}return t}function Tt(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t.prototype=Object.create(e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),t}function Et(t){var e=t.prototype,n=e&&Object.getPrototypeOf(e);return n&&n.constructor}function wt(t,e){if(t&&e){if("function"!=typeof t)return!1;if("function"!=typeof e)return!1;if(t===e)return!0;for(;;){if(!(t=Et(t)))return!1;if(t===e)return!0}}return!1}function Pt(t){for(var e=0,n=Object.keys(t);e<n.length;e++)delete t[n[e]]}var It=ft(!0),Rt=ft(!0);function Dt(t,e){return function(n,i){if(i.prototype.hasOwnProperty(t)&&delete e[i.prototype[t]],lt(i.prototype,t,n),n){var r=e[n];r&&r!==i?d("A Class already exists with the same "+t+' : "'+n+'".'):e[n]=i}}}var Bt=Dt("__cid__",It),Mt=Dt("__classname__",Rt);function Ot(t,e){if(Mt(t,e),!e.prototype.hasOwnProperty(rt)){var n=t||nt.getNewId();n&&Bt(n,e)}}function Nt(t,e){var n=Rt[e],i=It[e],r=!0;if(n&&n!==t&&(d('"'+e+'" has already been set as name or alias of another class.'),r=!1),i&&i!==t&&(d('"'+e+'" has already been set as id or alias of another class.'),r=!1),r){var o=t[it];o||(o=[],t[it]=o),o.push(e),Rt[e]=t,It[e]=t}}function Lt(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];for(var i=0,r=e;i<r.length;i++){var o=r[i],a=o.prototype,s=a.__cid__;s&&delete It[s];var c=a.__classname__;c&&delete Rt[c];var l=a[it];if(l)for(var u=0;u<l.length;++u){var h=l[u];delete Rt[h],delete It[h]}}}function Ft(t){return It[t]}function zt(t){return Rt[t]}function Vt(t,e){if(e=void 0===e||e,"function"==typeof t&&t.prototype.hasOwnProperty(rt))return t.prototype.__cid__;if(t&&t.constructor){var n=t.constructor.prototype;if(n&&n.hasOwnProperty(rt))return t.__cid__}return""}var Gt=function(){var t=e.prototype;function e(t,e){this.count=void 0,this._pool=void 0,this._cleanup=void 0;var n=void 0===e?t:e,i=void 0===e?null:t;this.count=0,this._pool=new Array(n),this._cleanup=i}return t.get=function(){return this._get()},t._get=function(){if(this.count>0){--this.count;var t=this._pool[this.count];return this._pool[this.count]=null,t}return null},t.put=function(t){var e=this._pool;if(this.count<e.length){if(this._cleanup&&!1===this._cleanup(t))return;e[this.count]=t,++this.count}},t.resize=function(t){t>=0&&(this._pool.length=t,this.count>t&&(this.count=t))},e}(),Ut=tt,kt={IDGenerator:et,Pool:Gt,array:tt,isNumber:ot,isString:at,isEmptyObject:st,getPropertyDescriptor:St,addon:Ct,mixin:bt,extend:Tt,getSuper:Et,isChildClassOf:wt,clear:Pt,value:lt,getset:ut,get:ht,set:_t,unregisterClass:Lt,getClassName:pt,setClassName:Ot,setClassAlias:Nt,getClassByName:zt,get _registeredClassNames(){return L({},Rt)},set _registeredClassNames(t){Pt(Rt),Object.assign(Rt,t)},get _registeredClassIds(){return L({},It)},set _registeredClassIds(t){Pt(It),Object.assign(It,t)},_getClassId:Vt,_setClassId:Bt,_getClassById:Ft,obsolete:dt,obsoletes:mt,formatStr:yt,shiftArguments:xt,createMap:ft};i.js=kt,t("js",Object.freeze({__proto__:null,array:Ut,js:kt,IDGenerator:et,Pool:Gt,isNumber:ot,isString:at,isEmptyObject:st,value:lt,getset:ut,get:ht,set:_t,createMap:ft,getClassName:pt,obsolete:dt,obsoletes:mt,formatStr:yt,shiftArguments:xt,getPropertyDescriptor:St,addon:Ct,mixin:bt,extend:Tt,getSuper:Et,isChildClassOf:wt,clear:Pt,_idToClass:It,_nameToClass:Rt,_setClassId:Bt,setClassName:Ot,setClassAlias:Nt,unregisterClass:Lt,_getClassById:Ft,getClassByName:zt,_getClassId:Vt}));var Ht=new(function(){function t(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}var e=t.prototype;return e.addContainer=function(t){-1===t._poolHandle&&(t._poolHandle=this._pools.length,this._pools.push(t))},e.removeContainer=function(t){-1!==t._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=t._poolHandle,kt.array.fastRemoveAt(this._pools,t._poolHandle),t._poolHandle=-1)},e.tryShrink=function(){for(var t=0;t<this._pools.length;t++)this._pools[t].tryShrink()},e.update=function(t){this._lastShrinkPassed+=t,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)},t}()),jt=function(){function t(){this._poolHandle=-1,Ht.addContainer(this)}return t.prototype.destroy=function(){Ht.removeContainer(this)},t}(),Wt=t("Pool",function(t){function e(e,n,i){var r;(r=t.call(this)||this)._ctor=void 0,r._elementsPerBatch=void 0,r._nextAvail=void 0,r._freepool=[],r._dtor=void 0,r._ctor=e,r._dtor=i||null,r._elementsPerBatch=Math.max(n,1),r._nextAvail=r._elementsPerBatch-1;for(var o=0;o<r._elementsPerBatch;++o)r._freepool.push(e());return r}F(e,t);var n=e.prototype;return n.alloc=function(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(var t=0;t<this._elementsPerBatch;t++)this._freepool[t]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]},n.free=function(t){this._freepool[++this._nextAvail]=t},n.freeArray=function(t){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,t),this._nextAvail+=t.length},n.tryShrink=function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var t=this._nextAvail>>1;t<=this._nextAvail;t++)this._dtor(this._freepool[t]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}},n.destroy=function(){var e=arguments.length>0?arguments[0]:null;e&&b(14100);var n=e||this._dtor;if(n)for(var i=0;i<=this._nextAvail;i++)n(this._freepool[i]);this._freepool.length=0,this._nextAvail=-1,t.prototype.destroy.call(this)},e}(jt)),qt=t("RecyclePool",function(t){function e(e,n,i){var r;(r=t.call(this)||this)._fn=void 0,r._dtor=null,r._count=0,r._data=void 0,r._initSize=0,r._fn=e,r._dtor=i||null,r._data=new Array(n),r._initSize=n;for(var o=0;o<n;++o)r._data[o]=e();return r}F(e,t);var n=e.prototype;return n.reset=function(){this._count=0},n.resize=function(t){if(t>this._data.length)for(var e=this._data.length;e<t;++e)this._data[e]=this._fn()},n.add=function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]},n.destroy=function(){if(this._dtor)for(var e=0;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=0,this._count=0,t.prototype.destroy.call(this)},n.tryShrink=function(){if(this._data.length>>2>this._count){var t=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var e=t;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=t}},n.removeAt=function(t){if(!(t>=this._count)){var e=this._count-1,n=this._data[t];this._data[t]=this._data[e],this._data[e]=n,this._count-=1}},N(e,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),e}(jt)),Xt=t("CachedArray",function(t){function e(e,n){var i;return(i=t.call(this)||this).array=void 0,i.length=0,i._compareFn=void 0,i._initSize=0,i.array=new Array(e),i._initSize=e,i.length=0,i._compareFn=void 0!==n?n:function(t,e){return t-e},i}F(e,t);var n=e.prototype;return n.push=function(t){this.array[this.length++]=t},n.pop=function(){return this.array[--this.length]},n.get=function(t){return this.array[t]},n.clear=function(){this.length=0},n.destroy=function(){this.length=0,this.array.length=0,t.prototype.destroy.call(this)},n.tryShrink=function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))},n.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},n.concat=function(t){for(var e=0;e<t.length;++e)this.array[this.length++]=t[e]},n.fastRemove=function(t){if(!(t>=this.length||t<0)){var e=--this.length;this.array[t]=this.array[e]}},n.indexOf=function(t){for(var e=0,n=this.length;e<n;++e)if(this.array[e]===t)return e;return-1},e}(jt));function Yt(t){if("__bitmask__"in t)return t;lt(t,"__bitmask__",null,!0);for(var e=-1,n=Object.keys(t),i=0;i<n.length;i++){var r=n[i],o=t[r];if(-1===o)o=++e,t[r]=o;else if("number"==typeof o)e=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&lt(t,a,r)}return t}function Kt(t,e){e>=0&&t.length,t.length}function Jt(t){return"__enums__"in t?t:(lt(t,"__enums__",null,!0),Jt.update(t))}function Qt(t){t.hasOwnProperty("__enums__")}function Zt(t){Qt(t);var e=t.__enums__||[];for(var n in e.length=0,t){var i=t[n];Number.isInteger(i)&&e.push({name:n,value:i})}return e.sort((function(t,e){return t.value-e.value})),t.__enums__=e,e}function $t(t){"__enums__"in t||lt(t,"__enums__",null,!0)}t("memop",Object.freeze({__proto__:null,Pool:Wt,RecyclePool:qt,CachedArray:Xt})),Yt.isBitMask=function(t){return t&&t.hasOwnProperty("__bitmask__")},Yt.getList=function(t){if(t.__bitmask__)return t.__bitmask__;var e=t.__bitmask__=[];for(var n in t){var i=t[n];Number.isInteger(i)&&e.push({name:n,value:i})}return e.sort((function(t,e){return t.value-e.value})),e},i.BitMask=Yt,Jt.update=function(t){for(var e=-1,n=Object.keys(t),i=0;i<n.length;i++){var r=n[i],o=t[r];if(-1===o)o=++e,t[r]=o;else if("number"==typeof o)e=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&lt(t,a,r)}return Array.isArray(t.__enums__)&&Zt(t),t},Jt||(Jt=t("Enum",{})),Jt.isEnum=function(t){return t&&t.hasOwnProperty("__enums__")},Jt.getList=function(t){return Qt(t),t.__enums__?t.__enums__:Zt(t)},i.Enum=Jt;var te=t("ValueType",function(){function t(){}var e=t.prototype;return e.clone=function(){return E(100,pt(this)+".clone"),this},e.equals=function(){return!1},e.set=function(){E(100,pt(this)+".set")},e.toString=function(){return""+{}},t}());Ot("cc.ValueType",te),i.ValueType=te;var ee=t("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144});i.macro=ee;for(var ne=/^(?:cc|dragonBones|sp|ccsg)\..+/,ie=new Array(123),re=0;re<123;++re)ie[re]=64;for(var oe=0;oe<64;++oe)ie["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(oe)]=oe;var ae=ie;function se(t,e,n){function i(t,e,n,i){var r=Object.getOwnPropertyDescriptor(t,e);if(r)r.get&&(t[n]=r.get),r.set&&i&&(t[i]=r.set);else{var o=t[n];ut(t,e,o,t[i])}}for(var r,o=t.prototype,a=0;a<e.length;a++){var s=(r=e[a])[0].toUpperCase()+r.slice(1);i(o,r,"get"+s,"set"+s)}for(r in n){var c=n[r];i(o,r,c[0],c[1])}}function ce(t,e,n,i){var r=t[e];r?Array.isArray(r)?i?(r.push(r[0]),r[0]=n):r.push(n):t[e]=i?[n,r]:[r,n]:t[e]=n}function le(t,e){if("function"==typeof t.contains)return t.contains(e);if("function"==typeof t.compareDocumentPosition)return!!(16&t.compareDocumentPosition(e));var n=e.parentNode;if(n)do{if(n===t)return!0;n=n.parentNode}while(null!==n);return!1}function ue(t){return"object"==typeof window&&"function"==typeof Node?t instanceof Node:t&&"object"==typeof t&&"number"==typeof t.nodeType&&"string"==typeof t.nodeName}function he(t,e,n){t&&setTimeout((function(){t(e,n)}),0)}function _e(t){return!(!t||t.constructor!==Object)&&st(t)}function fe(t,e,n){if(e>n){var i=e;e=n,n=i}return t<e?e:t<n?t:n}function pe(t){return t*ee.RAD}function de(t){return t*ee.DEG}i.misc={BUILTIN_CLASSID_RE:ne,BASE64_VALUES:ae,propertyDefine:se,pushToMap:ce,contains:le,isDomNode:ue,callInNextTick:he,isPlainEmptyObj_DEV:_e,clampf:fe,degreesToRadians:pe,radiansToDegrees:de},t("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:ne,BASE64_VALUES:ae,propertyDefine:se,pushToMap:ce,contains:le,isDomNode:ue,callInNextTick:he,tryCatchFunctor_EDITOR:function(t){return Function("target","try {\n  target."+t+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:_e,clampf:fe,degreesToRadians:pe,radiansToDegrees:de}));var me="$_$";function ve(t,e){var n=e?Object.create(e):{};return lt(t,"__attrs__",n),n}function ge(t){if("function"!=typeof t)return ve(t,xe(t.constructor));for(var e,n=i.Class.getInheritanceChain(t),r=n.length-1;r>=0;r--){var o=n[r];o.hasOwnProperty("__attrs__")&&o.__attrs__||ve(o,(e=n[r+1])&&e.__attrs__)}return ve(t,(e=n[0])&&e.__attrs__),t.__attrs__}function ye(t,e){var n=xe(t),i=e+me,r={};for(var o in n)o.startsWith(i)&&(r[o.slice(i.length)]=n[o]);return r}function xe(t){return t.hasOwnProperty("__attrs__")&&t.__attrs__||ge(t)}function Se(t,e,n,i){xe(t)[e+me+n]=i}var Ae=function(){function t(t,e){this.name=void 0,this.default=void 0,this.name=t,this.default=e}return t.prototype.toString=function(){return this.name},t}(),Ce=t("CCInteger",new Ae("Integer",0));i.Integer=Ce,i.CCInteger=Ce;var be=t("CCFloat",new Ae("Float",0));i.Float=be,i.CCFloat=be;var Te=t("CCBoolean",new Ae("Boolean",!1));i.Boolean=Te,i.CCBoolean=Te;var Ee=t("CCString",new Ae("String",""));function we(t,e){return function(n,i){var r='"'+pt(n)+"."+i+'"',o=ye(n,i),a=o.type;if(a===Ce||a===be?a="Number":a!==Ee&&a!==Te||(a=""+a),a===t){if(o.hasOwnProperty("default")){var s=o.default;if(void 0!==s&&!Array.isArray(s)&&!_e(s)){var c=typeof s,l=t.toLowerCase();if(c===l)if("object"===l){if(!s||s instanceof o.ctor)return;b(3605,r,pt(o.ctor))}else"Number"!==t&&b(3606,e,r,t);else{if("function"===c)return;t===Ee.default&&null==s?b(3607,r):b(3611,e,r,c)}delete o.type}}}else b(3604,r)}}i.String=Ee,i.CCString=Ee;var Pe=Object.freeze({__proto__:null,DELIMETER:me,createAttrsSingle:ve,createAttrs:ge,attr:ye,getClassAttrs:xe,setClassAttr:Se,PrimitiveType:Ae,CCInteger:Ce,CCFloat:be,CCBoolean:Te,CCString:Ee,getTypeChecker_ET:we,getObjTypeChecker_ET:function(t){return function(e,n){we("Object","type")(e,n);var r=xe(e)[n+me+"default"],o=i.Class.getDefault(r);if(!Array.isArray(o)&&wt(t,i.ValueType)){var a=pt(t),s=yt('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',pt(e),n,a);r?f(s):b(3612,s,a,pt(e),n,a)}}}}),Ie={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Re(t,e,n,i){if(!t.get&&!t.set&&t.hasOwnProperty("default")){var r="_N$"+e;t.get=function(){return this[r]},t.set=function(t){var e=this[r];this[r]=t,n.call(this,e)};var o={};for(var a in i[r]=o,Ie){var s=Ie[a];t.hasOwnProperty(a)&&(o[a]=t[a],s.canUsedInGet||delete t[a])}}}function De(t,e,n,r){if(Array.isArray(e)){if(!(e.length>0))return E(5508,n,r);t.type=e=e[0]}"function"==typeof e&&(e===String?t.type=i.String:e===Boolean?t.type=i.Boolean:e===Number&&(t.type=i.Float))}function Be(t,e,n){var i=t?{_short:!0}:{_short:!0,default:e};return n&&(i.type=n),i}function Me(t,e){if(!t||t.constructor!==Object){if(Array.isArray(t)&&t.length>0)return Be(e,[],t);if("function"==typeof t){var n=t;return Be(e,wt(n,i.ValueType)?new n:null,n)}return Be(e,t instanceof Ae?t.default:t)}return null}var Oe=[];function Ne(){return Oe[Oe.length-1]}i._RF={push:function(t,e,n,i){void 0===n&&(n=e,e=""),Oe.push({uuid:e,script:n,module:t,exports:t.exports,beh:null,importMeta:i})},pop:function(){var t=Oe.pop(),e=t.module,n=e.exports;if(n===t.exports){for(var i in n)return;e.exports=n=t.cls}},peek:Ne};var Le=me,Fe={datas:null,push:function(t){if(this.datas)this.datas.push(t);else{this.datas=[t];var e=this;setTimeout((function(){e.init()}),0)}},init:function(){var t=this.datas;if(t){for(var e=0;e<t.length;++e){var n=t[e],i=n.cls,r=n.props;"function"==typeof r&&(r=r());var o=pt(i);r?ke(i,o,r,i.$super,n.mixins):E(3633,o)}this.datas=null}}};function ze(t,e,n,i){!function(t,e){!function(t,e){t.indexOf(e)<0&&t.push(e)}(t.__props__,e)}(t,n),We(t,i,e,n)}function Ve(t,e,n,i){var r=i.get;i.set,r&&(We(t,i,e,n),Se(t,n,"serializable",!1))}function Ge(t){return"function"==typeof t?t():t}function Ue(t,e,n){for(var i in e)t.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(t,i,St(e,i))}function ke(t,e,n,i,r){if(t.__props__=[],i&&i.__props__&&(t.__props__=i.__props__.slice()),r)for(var o=0;o<r.length;++o){var a=r[o];a.__props__&&(t.__props__=t.__props__.concat(a.__props__.filter((function(e){return t.__props__.indexOf(e)<0}))))}if(n)for(var s in function(t,e){for(var n in t){var i=t[n],r=Me(i,!1);if(r&&(i=t[n]=r),i){var o=i.notify;o&&Re(i,n,o,t),"type"in i&&De(i,i.type,e,n)}}}(n,e),n){var c=n[s];c.get||c.set?Ve(t,e,s,c):ze(t,e,s,c)}var l=xe(t);t.__values__=t.__props__.filter((function(t){return!1!==l[t+Le+"serializable"]}))}function He(t){var e=t.name,n=t.extends,r=t.mixins,o=function(t,e,n,r){var o=i.Component,a=Ne();if(a&&wt(e,o)){if(wt(a.cls,o))return E(3615),null;t=t||a.script}var s=function(t,e,n,i){var r=i.ctor,o=[r],a=r;lt(a,"__ctors__",o.length>0?o:null,!0);var s=a.prototype;if(e&&(a.$super=e),n){for(var c=n.length-1;c>=0;c--){var l=n[c];Ue(s,l.prototype),He._isCCClass(l)&&Ue(xe(a),xe(l))}s.constructor=a}return Ot(t,a),a}(t,e,n,r);if(a)if(wt(e,o)){var c=a.uuid;c&&Bt(c,s),a.cls=s}else wt(a.cls,o)||(a.cls=s);return s}(e,n,r,t);e||(e=i.js.getClassName(o)),o._sealed=!0,n&&(n._sealed=!1);var a=t.properties;"function"==typeof a||n&&null===n.__props__||r&&r.some((function(t){return null===t.__props__}))?(Fe.push({cls:o,props:a,mixins:r}),o.__props__=o.__values__=null):ke(o,e,a,n,t.mixins);var s=t.editor;return s&&wt(n,i.Component)&&i.Component._registerEditorProps(o,s),o}He._isCCClass=function(t){var e;return null==t||null===(e=t.hasOwnProperty)||void 0===e?void 0:e.call(t,"__ctors__")},He.fastDefine=function(t,e,n){Ot(t,e);for(var i=e.__props__=e.__values__=Object.keys(n),r=xe(e),o=0;o<i.length;o++){var a=i[o];r[a+Le+"visible"]=!1,r[a+Le+"default"]=n[a]}},He.Attr=Pe,He.attr=ye,He.getInheritanceChain=function(t){for(var e=[];t=Et(t);)t!==Object&&e.push(t);return e};var je={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function We(t,e,n,i){var r=null,o="";function a(){return o=i+Le,r=xe(t)}"type"in e&&void 0===e.type&&b(3660,i,n);var s=e.type;s&&(je[s]?(r||a())[o+"type"]=s:"Object"===s||("object"==typeof s?Jt.isEnum(s)?((r||a())[o+"type"]="Enum",r[o+"enumList"]=Jt.getList(s)):Yt.isBitMask(s)&&((r||a())[o+"type"]="BitMask",r[o+"bitmaskList"]=Yt.getList(s)):"function"==typeof s&&((r||a())[o+"type"]="Object",r[o+"ctor"]=s))),"default"in e&&((r||a())[o+"default"]=e.default);var c,l=function(t,n){if(t in e){var i=e[t];typeof i===n&&((r||a())[o+t]=i)}};e.editorOnly&&((r||a())[o+"editorOnly"]=!0),e.__noImplicit?(r||a())[o+"serializable"]=null!==(c=e.serializable)&&void 0!==c&&c:!1===e.serializable&&((r||a())[o+"serializable"]=!1),l("formerlySerializedAs","string");var u=e.range;u&&Array.isArray(u)&&u.length>=2&&((r||a())[o+"min"]=u[0],r[o+"max"]=u[1],u.length>2&&(r[o+"step"]=u[2])),l("min","number"),l("max","number"),l("step","number")}He.isArray=function(t){return t=Ge(t),Array.isArray(t)},He.getDefault=Ge,He.escapeForJS=function(t){return JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},He.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,He.getNewValueTypeCode=function(t){for(var e=pt(t),n=t.constructor,i="new "+e+"(",r=0;r<n.__props__.length;r++)i+=t[n.__props__[r]],r<n.__props__.length-1&&(i+=",");return i+")"},i.Class=He;var qe,Xe=t("editorExtrasTag","__editorExtras__"),Ye=1<<22,Ke=[],Je=t("CCObject",function(){function t(t){void 0===t&&(t=""),this._objFlags=void 0,this._name=void 0,this._name=t,this._objFlags=0}t._deferredDestroy=function(){for(var t=Ke.length,e=0;e<t;++e){var n=Ke[e];1&n._objFlags||n._destroyImmediate()}t===Ke.length?Ke.length=0:Ke.splice(0,t)};var e=t.prototype;return e.destroy=function(){return 1&this._objFlags?(b(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,Ke.push(this),0))},e._destruct=function(){var t=this.constructor,e=t.__destruct__;e||(e=function(t,e){var n,r=t instanceof i._BaseNode||t instanceof i.Component,o=r?"_id":null,a={};for(n in t)if(t.hasOwnProperty(n)){if(n===o)continue;switch(typeof t[n]){case"string":a[n]="";break;case"object":case"function":a[n]=null}}if(He._isCCClass(e))for(var s=i.Class.Attr.getClassAttrs(e),c=e.__props__,l=0;l<c.length;l++){var u=(n=c[l])+i.Class.Attr.DELIMETER+"default";if(u in s){if(r&&"_id"===n)continue;switch(typeof s[u]){case"string":a[n]="";break;case"object":case"function":a[n]=null;break;case"undefined":a[n]=void 0}}}var h="";for(n in a){var _;_=He.IDENTIFIER_RE.test(n)?"o."+n+"=":"o["+He.escapeForJS(n)+"]=";var f=a[n];""===f&&(f='""'),h+=_+f+";\n"}return Function("o",h)}(this,t),lt(t,"__destruct__",e,!0)),e(this)},e._destroyImmediate=function(){1&this._objFlags?E(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},N(t,[{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"hideFlags",get:function(){return this._objFlags&t.Flags.AllHideMasks},set:function(e){var n=e&t.Flags.AllHideMasks;this._objFlags=this._objFlags&~t.Flags.AllHideMasks|n}},{key:"replicated",get:function(){return!!(this._objFlags&Ye)},set:function(t){t?this._objFlags|=Ye:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),t}()),Qe=Je.prototype;function Ze(t,e){return"object"==typeof t?!(!t||t._objFlags&(e?5:1)):void 0!==t}Qe._deserialize=null,Qe._onPreDestroy=null,He.fastDefine("cc.Object",Je,((qe={_name:"",_objFlags:0})[Xe]={},qe)),He.Attr.setClassAttr(Je,Xe,"editorOnly",!0),He.Attr.setClassAttr(Je,"replicated","visible",!1),lt(Je,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),i.isValid=Ze,i.Object=Je;var $e=Ut.fastRemoveAt;function tn(){}var en=function(){function t(){this.callback=tn,this.target=void 0,this.once=!1}var e=t.prototype;return e.set=function(t,e,n){this.callback=t||tn,this.target=e,this.once=!!n},e.reset=function(){this.target=void 0,this.callback=tn,this.once=!1},e.check=function(){return!(this.target instanceof Je&&!Ze(this.target,!0))},t}(),nn=new Wt((function(){return new en}),32),rn=function(){function t(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}var e=t.prototype;return e.removeByCallback=function(t){for(var e=0;e<this.callbackInfos.length;++e){var n=this.callbackInfos[e];n&&n.callback===t&&(n.reset(),nn.free(n),$e(this.callbackInfos,e),--e)}},e.removeByTarget=function(t){for(var e=0;e<this.callbackInfos.length;++e){var n=this.callbackInfos[e];n&&n.target===t&&(n.reset(),nn.free(n),$e(this.callbackInfos,e),--e)}},e.cancel=function(t){var e=this.callbackInfos[t];e&&(e.reset(),this.isInvoking?this.callbackInfos[t]=null:$e(this.callbackInfos,t),nn.free(e)),this.containCanceled=!0},e.cancelAll=function(){for(var t=0;t<this.callbackInfos.length;t++){var e=this.callbackInfos[t];e&&(e.reset(),nn.free(e),this.callbackInfos[t]=null)}this.containCanceled=!0},e.purgeCanceled=function(){for(var t=this.callbackInfos.length-1;t>=0;--t)this.callbackInfos[t]||$e(this.callbackInfos,t);this.containCanceled=!1},e.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},t}(),on=new Wt((function(){return new rn}),16),an=function(){function t(){this._callbackTable=ft(!0),this._offCallback=void 0}var e=t.prototype;return e.on=function(t,e,n,i){if(!this.hasEventListener(t,e,n)){var r=this._callbackTable[t];r||(r=this._callbackTable[t]=on.alloc());var o=nn.alloc();o.set(e,n,i),r.callbackInfos.push(o)}return e},e.hasEventListener=function(t,e,n){var i=this._callbackTable&&this._callbackTable[t];if(!i)return!1;var r=i.callbackInfos;if(!e){if(i.isInvoking){for(var o=0;o<r.length;++o)if(r[o])return!0;return!1}return r.length>0}for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.check()&&s.callback===e&&s.target===n)return!0}return!1},e.removeAll=function(t){var e=typeof t;if("string"===e||"number"===e){var n=this._callbackTable&&this._callbackTable[t];n&&(n.isInvoking?n.cancelAll():(n.clear(),on.free(n),delete this._callbackTable[t]))}else if(t)for(var i in this._callbackTable){var r=this._callbackTable[i];if(r.isInvoking)for(var o=r.callbackInfos,a=0;a<o.length;++a){var s=o[a];s&&s.target===t&&r.cancel(a)}else r.removeByTarget(t)}},e.off=function(t,e,n){var i,r=this._callbackTable&&this._callbackTable[t];if(r){var o=r.callbackInfos;if(e)for(var a=0;a<o.length;++a){var s=o[a];if(s&&s.callback===e&&s.target===n){r.cancel(a);break}}else this.removeAll(t)}null===(i=this._offCallback)||void 0===i||i.call(this)},e.emit=function(t,e,n,i,r,o){var a=this._callbackTable&&this._callbackTable[t];if(a){var s=!a.isInvoking;a.isInvoking=!0;for(var c=a.callbackInfos,l=0,u=c.length;l<u;++l){var h=c[l];if(h){var _=h.callback,f=h.target;h.once&&this.off(t,_,f),h.check()?f?_.call(f,e,n,i,r,o):_(e,n,i,r,o):this.off(t,_,f)}}s&&(a.isInvoking=!1,a.containCanceled&&a.purgeCanceled())}},e.clear=function(){for(var t in this._callbackTable){var e=this._callbackTable[t];e&&(e.clear(),on.free(e),delete this._callbackTable[t])}},e._registerOffCallback=function(t){this._offCallback=t},t}();function sn(t){for(var e=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._callbackTable=ft(!0),e}F(e,t);var n=e.prototype;return n.once=function(t,e,n){return this.on(t,e,n,!0)},n.targetOff=function(t){this.removeAll(t)},e}(t),n=an.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n)),r=0;r<i.length;++r){var o=i[r];if(!(o in e.prototype)){var a=Object.getOwnPropertyDescriptor(n,o);a&&Object.defineProperty(e.prototype,o,a)}}return e}var cn,ln,un,hn,_n,fn,pn=t("EventTarget",sn((function(){})));i.EventTarget=pn,function(t){t.UNKNOWN="unknown",t.WECHAT="wechat",t.ANDROID="androidbrowser",t.IE="ie",t.EDGE="edge",t.QQ="qqbrowser",t.MOBILE_QQ="mqqbrowser",t.UC="ucbrowser",t.UCBS="ucbs",t.BROWSER_360="360browser",t.BAIDU_APP="baiduboxapp",t.BAIDU="baidubrowser",t.MAXTHON="maxthon",t.OPERA="opera",t.OUPENG="oupeng",t.MIUI="miuibrowser",t.FIREFOX="firefox",t.SAFARI="safari",t.CHROME="chrome",t.LIEBAO="liebao",t.QZONE="qzone",t.SOUGOU="sogou",t.HUAWEI="huawei"}(cn||(cn={})),function(t){t.UNKNOWN="unknown",t.ENGLISH="en",t.CHINESE="zh",t.FRENCH="fr",t.ITALIAN="it",t.GERMAN="de",t.SPANISH="es",t.DUTCH="du",t.RUSSIAN="ru",t.KOREAN="ko",t.JAPANESE="ja",t.HUNGARIAN="hu",t.PORTUGUESE="pt",t.ARABIC="ar",t.NORWEGIAN="no",t.POLISH="pl",t.TURKISH="tr",t.UKRAINIAN="uk",t.ROMANIAN="ro",t.BULGARIAN="bg"}(ln||(ln={})),function(t){t[t.NONE=0]="NONE",t[t.LAN=1]="LAN",t[t.WWAN=2]="WWAN"}(un||(un={})),function(t){t.UNKNOWN="Unknown",t.IOS="iOS",t.ANDROID="Android",t.WINDOWS="Windows",t.LINUX="Linux",t.OSX="OS X",t.OHOS="OHOS"}(hn||(hn={})),function(t){t.UNKNOWN="UNKNOWN",t.EDITOR_PAGE="EDITOR_PAGE",t.EDITOR_CORE="EDITOR_CORE",t.MOBILE_BROWSER="MOBILE_BROWSER",t.DESKTOP_BROWSER="DESKTOP_BROWSER",t.WIN32="WIN32",t.ANDROID="ANDROID",t.IOS="IOS",t.MACOS="MACOS",t.OHOS="OHOS",t.WECHAT_GAME="WECHAT_GAME",t.BAIDU_MINI_GAME="BAIDU_MINI_GAME",t.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",t.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",t.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",t.OPPO_MINI_GAME="OPPO_MINI_GAME",t.VIVO_MINI_GAME="VIVO_MINI_GAME",t.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",t.COCOSPLAY="COCOSPLAY",t.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",t.QTT_MINI_GAME="QTT_MINI_GAME"}(_n||(_n={})),function(t){t.WEBP="WEBP",t.IMAGE_BITMAP="IMAGE_BITMAP",t.WEB_VIEW="WEB_VIEW",t.VIDEO_PLAYER="VIDEO_PLAYER",t.SAFE_AREA="SAFE_AREA",t.INPUT_TOUCH="INPUT_TOUCH",t.EVENT_KEYBOARD="EVENT_KEYBOARD",t.EVENT_MOUSE="EVENT_MOUSE",t.EVENT_TOUCH="EVENT_TOUCH",t.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER"}(fn||(fn={}));var dn=new(function(t){function e(){var e,n,i;(i=t.call(this)||this).networkType=void 0,i.isNative=void 0,i.isBrowser=void 0,i.isMobile=void 0,i.isLittleEndian=void 0,i.platform=void 0,i.language=void 0,i.nativeLanguage=void 0,i.os=void 0,i.osVersion=void 0,i.osMainVersion=void 0,i.browserType=void 0,i.browserVersion=void 0,i._battery=void 0,i._featureMap=void 0;var r,o=window.navigator,a=o.userAgent.toLowerCase();null===(e=o.getBattery)||void 0===e||e.call(o).then((function(t){i._battery=t})),i.networkType=un.LAN,i.isNative=!1,i.isBrowser=!0,i.isMobile=/mobile|android|iphone|ipad/.test(a),i.platform=i.isMobile?_n.MOBILE_BROWSER:_n.DESKTOP_BROWSER,i.isLittleEndian=(r=new ArrayBuffer(2),new DataView(r).setInt16(0,256,!0),256===new Int16Array(r)[0]);var s=o.language;i.nativeLanguage=s.toLowerCase(),s=(s=s||o.browserLanguage)?s.split("-")[0]:ln.ENGLISH,i.language=s;var c=!1,l=!1,u="",h=0,_=/android\s*(\d+(?:\.\d+)*)/i.exec(a)||/android\s*(\d+(?:\.\d+)*)/i.exec(o.platform);_&&(c=!0,u=_[1]||"",h=parseInt(u)||0),(_=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(a))?(l=!0,u=_[2]||"",h=parseInt(u)||0):(/(iPhone|iPad|iPod)/.exec(o.platform)||"MacIntel"===o.platform&&o.maxTouchPoints&&o.maxTouchPoints>1)&&(l=!0,u="",h=0);var f=hn.UNKNOWN;-1!==o.appVersion.indexOf("Win")?f=hn.WINDOWS:l?f=hn.IOS:-1!==o.appVersion.indexOf("Mac")?f=hn.OSX:-1!==o.appVersion.indexOf("X11")&&-1===o.appVersion.indexOf("Linux")?f=hn.LINUX:c?f=hn.ANDROID:-1===o.appVersion.indexOf("Linux")&&-1===a.indexOf("ubuntu")||(f=hn.LINUX),i.os=f,i.osVersion=u,i.osMainVersion=h,i.browserType=cn.UNKNOWN;var p=/wechat|weixin|micromessenger/i.exec(a)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(a)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(a)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(a),d=p?p[0].toLowerCase():hn.UNKNOWN;("safari"===d&&c||"qq"===d&&/android.*applewebkit/i.test(a))&&(d=cn.ANDROID);var m={micromessenger:cn.WECHAT,wechat:cn.WECHAT,weixin:cn.WECHAT,trident:cn.IE,edge:cn.EDGE,"360 aphone":cn.BROWSER_360,mxbrowser:cn.MAXTHON,"opr/":cn.OPERA,ubrowser:cn.UC,huaweibrowser:cn.HUAWEI};i.browserType=m[d]||d,i.browserVersion="";var v=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(a);v||(v=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(a)),i.browserVersion=v?v[4]:"";var g,y=document.createElement("canvas");y.getContext("2d");try{g=y.toDataURL("image/webp").startsWith("data:image/webp")}catch(t){g=!1}var x=!1;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(y.width=y.height=2,createImageBitmap(y,{}).then((function(t){x=!0,null==t||t.close()})).catch((function(){})));var S=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart,A=void 0!==document.documentElement.onmouseup;return i._featureMap=((n={})[fn.WEBP]=g,n[fn.IMAGE_BITMAP]=x,n[fn.WEB_VIEW]=!0,n[fn.VIDEO_PLAYER]=!0,n[fn.SAFE_AREA]=!1,n[fn.INPUT_TOUCH]=S,n[fn.EVENT_KEYBOARD]=void 0!==document.documentElement.onkeyup,n[fn.EVENT_MOUSE]=A,n[fn.EVENT_TOUCH]=S||A,n[fn.EVENT_ACCELEROMETER]=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,n),i._registerEvent(),i}F(e,t);var n=e.prototype;return n._registerEvent=function(){var t,e=this;t=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var n=!1,i=function(){n||(n=!0,e.emit("hide"))},r=function(t,i,r,o,a){n&&(n=!1,e.emit("show",t,i,r,o,a))};if(t)for(var o=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],a=0;a<o.length;a++)document.addEventListener(o[a],(function(e){var n=document[t];(n=n||e.hidden)?i():r()}));else window.addEventListener("blur",i),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",i),window.addEventListener("pageshow",r),document.addEventListener("pagehide",i),document.addEventListener("pageshow",r))},n.hasFeature=function(t){return this._featureMap[t]},n.getBatteryLevel=function(){return this._battery?this._battery.level:1},n.triggerGC=function(){},n.openURL=function(t){window.open(t)},n.now=function(){return Date.now?Date.now():+new Date},n.restartJSVM=function(){},n.close=function(){this.emit("close"),window.close()},e}(pn)),mn=/(\.[^\.\/\?\\]*)(\?.*)?$/,vn=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,gn=/[^\.\/]+\/\.\.\//;function yn(){for(var t="",e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];t=(t+(""===t?"":"/")+a).replace(/(\/|\\\\)$/,"")}return t}function xn(t){var e=mn.exec(t);return e?e[1]:""}function Sn(t){if(t){var e=t.lastIndexOf(".");if(-1!==e)return t.substring(0,e)}return t}function An(t,e){var n=t.indexOf("?");n>0&&(t=t.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(t.replace(/(\/|\\)$/,""));if(!i)return t;var r=i[2];return e&&t.substring(t.length-e.length).toLowerCase()===e.toLowerCase()?r.substring(0,r.length-e.length):r}function Cn(t){var e=vn.exec(t);return e?e[2]:""}function bn(t,e){e=e||"";var n=t.indexOf("?"),i="";return n>0&&(i=t.substring(n),t=t.substring(0,n)),(n=t.lastIndexOf("."))<0?t+e+i:t.substring(0,n)+e+i}function Tn(t,e,n){if(0===e.indexOf("."))return bn(t,e);var i=t.indexOf("?"),r="",o=n?xn(t):"";return i>0&&(r=t.substring(i),t=t.substring(0,i)),i=(i=t.lastIndexOf("/"))<=0?0:i+1,t.substring(0,i)+e+o+r}function En(t){var e=t=String(t);do{e=t,t=t.replace(gn,"")}while(e.length!==t.length);return t}function wn(t){return t.replace(/[\/\\]$/,"")}function Pn(){return dn.os===hn.WINDOWS?"\\":"/"}t("path",Object.freeze({__proto__:null,join:yn,extname:xn,mainFileName:Sn,basename:An,dirname:Cn,changeExtname:bn,changeBasename:Tn,_normalize:En,stripSep:wn,getSeperator:Pn})),i.log=f,i.warn=p,i.error=d,i.assert=m,i._throw=y,i.logID=A,i.warnID=b,i.errorID=E,i.assertID=I,i.debug=M,i.path={join:yn,extname:xn,mainFileName:Sn,basename:An,dirname:Cn,changeExtname:bn,changeBasename:Tn,_normalize:En,stripSep:wn,get sep(){return Pn()}};var In=0,Rn={};function Dn(t){var e,n;return e=(t>65535)<<4,e|=n=((t>>>=e)>255)<<3,e|=n=((t>>>=n)>15)<<2,(e|=n=((t>>>=n)>3)<<1)|(t>>>=n)>>1}function Bn(t){var e=32;return(t&=-t)&&e--,65535&t&&(e-=16),16711935&t&&(e-=8),252645135&t&&(e-=4),858993459&t&&(e-=2),1431655765&t&&(e-=1),e}function Mn(t){return--t,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,1+(t|=t>>>16)}var On=new Array(256);!function(t){for(var e=0;e<256;++e){var n=e,i=e,r=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--r;t[e]=i<<r&255}}(On);var Nn=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-2147483648,sign:function(t){return(t>0)-(t<0)},abs:function(t){var e=t>>31;return(t^e)-e},min:function(t,e){return e^(t^e)&-(t<e)},max:function(t,e){return t^(t^e)&-(t<e)},isPow2:function(t){return!(t&t-1||!t)},log2:Dn,log10:function(t){return t>=1e9?9:t>=1e8?8:t>=1e7?7:t>=1e6?6:t>=1e5?5:t>=1e4?4:t>=1e3?3:t>=100?2:t>=10?1:0},popCount:function(t){return 16843009*((t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)>>>24},countTrailingZeros:Bn,nextPow2:Mn,prevPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,(t|=t>>>16)-(t>>>1)},parity:function(t){return t^=t>>>16,t^=t>>>8,t^=t>>>4,27030>>>(t&=15)&1},reverse:function(t){return On[255&t]<<24|On[t>>>8&255]<<16|On[t>>>16&255]<<8|On[t>>>24&255]},interleave2:function(t,e){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))<<1},deinterleave2:function(t,e){return(t=65535&((t=16711935&((t=252645135&((t=858993459&((t=t>>>e&1431655765)|t>>>1))|t>>>2))|t>>>4))|t>>>16))<<16>>16},interleave3:function(t,e,n){return t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2),(t|=(e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(t,e){return(t=1023&((t=4278190335&((t=251719695&((t=3272356035&((t=t>>>e&1227133513)|t>>>2))|t>>>4))|t>>>8))|t>>>16))<<22>>22},nextCombination:function(t){var e=t|t-1;return e+1|(~e&-~e)-1>>>Bn(t)+1}});t("bits",Nn);var Ln=Math.PI/180,Fn=180/Math.PI,zn=t("EPSILON",1e-6);function Vn(t,e){return Math.abs(t-e)<=zn*Math.max(1,Math.abs(t),Math.abs(e))}function Gn(t,e,n){return n=n||zn,Math.abs(t-e)<=n}function Un(t,e,n){if(e>n){var i=e;e=n,n=i}return t<e?e:t>n?n:t}function kn(t){return t<0?0:t>1?1:t}function Hn(t,e,n){return t+(e-t)*n}function jn(t){return t*Ln}function Wn(t){return t*Fn}var qn=t("random",Math.random);function Xn(t,e){return Math.random()*(e-t)+t}function Yn(t,e){return Math.floor(Xn(t,e))}function Kn(t){return(t=(9301*t+49297)%233280)/233280}function Jn(t,e,n){return Kn(t)*(n-e)+e}function Qn(t,e,n){return Math.floor(Jn(t,e,n))}function Zn(t){return--t,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function $n(t,e){return t-Math.floor(t/e)*e}function ti(t,e){return t=$n(t,2*e),e-Math.abs(t-e)}function ei(t,e,n){return(n-t)/(e-t)}function ni(t){return Math.abs(t.x)>Math.abs(t.y)?Math.abs(t.x)>Math.abs(t.z)?t.x:t.z:Math.abs(t.y)>Math.abs(t.z)?t.y:t.z}function ii(t,e){return Math.abs(t)>Math.abs(e)?t:e}function ri(t,e){e.forEach((function(e){Object.defineProperty(t,e,{enumerable:!0})}))}var oi=t("Vec3",function(t){function e(e,n,i){var r;return r=t.call(this)||this,e&&"object"==typeof e?(r.x=e.x,r.y=e.y,r.z=e.z):(r.x=e||0,r.y=n||0,r.z=i||0),r}F(e,t),e.zero=function(t){return t.x=0,t.y=0,t.z=0,t},e.clone=function(t){return new e(t.x,t.y,t.z)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t},e.set=function(t,e,n,i){return t.x=e,t.y=n,t.z=i,t},e.add=function(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t.z=e.z+n.z,t},e.subtract=function(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t.z=e.z-n.z,t},e.multiply=function(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t.z=e.z*n.z,t},e.divide=function(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t.z=e.z/n.z,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t},e.min=function(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t.z=Math.min(e.z,n.z),t},e.max=function(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t.z=Math.max(e.z,n.z),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t},e.distance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z;return Math.sqrt(n*n+i*i+r*r)},e.squaredDistance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z;return n*n+i*i+r*r},e.len=function(t){var e=t.x,n=t.y,i=t.z;return Math.sqrt(e*e+n*n+i*i)},e.lengthSqr=function(t){var e=t.x,n=t.y,i=t.z;return e*e+n*n+i*i},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t},e.invert=function(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t},e.invertSafe=function(t,e){var n=e.x,i=e.y,r=e.z;return Math.abs(n)<zn?t.x=0:t.x=1/n,Math.abs(i)<zn?t.y=0:t.y=1/i,Math.abs(r)<zn?t.z=0:t.z=1/r,t},e.normalize=function(t,e){var n=e.x,i=e.y,r=e.z,o=n*n+i*i+r*r;return o>0&&(o=1/Math.sqrt(o),t.x=n*o,t.y=i*o,t.z=r*o),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},e.cross=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.x,s=n.y,c=n.z;return t.x=r*c-o*s,t.y=o*a-i*c,t.z=i*s-r*a,t},e.lerp=function(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t},e.random=function(t,e){e=e||1;var n=2*qn()*Math.PI,i=2*qn()-1,r=Math.sqrt(1-i*i);return t.x=r*Math.cos(n)*e,t.y=r*Math.sin(n)*e,t.z=i*e,t},e.transformMat4=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.m03*i+n.m07*r+n.m11*o+n.m15;return a=a?Math.abs(1/a):1,t.x=(n.m00*i+n.m04*r+n.m08*o+n.m12)*a,t.y=(n.m01*i+n.m05*r+n.m09*o+n.m13)*a,t.z=(n.m02*i+n.m06*r+n.m10*o+n.m14)*a,t},e.transformMat4Normal=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.m03*i+n.m07*r+n.m11*o;return a=a?Math.abs(1/a):1,t.x=(n.m00*i+n.m04*r+n.m08*o)*a,t.y=(n.m01*i+n.m05*r+n.m09*o)*a,t.z=(n.m02*i+n.m06*r+n.m10*o)*a,t},e.transformMat3=function(t,e,n){var i=e.x,r=e.y,o=e.z;return t.x=i*n.m00+r*n.m03+o*n.m06,t.y=i*n.m01+r*n.m04+o*n.m07,t.z=i*n.m02+r*n.m05+o*n.m08,t},e.transformAffine=function(t,e,n){var i=e.x,r=e.y,o=e.z;return t.x=n.m00*i+n.m04*r+n.m08*o+n.m12,t.y=n.m01*i+n.m05*r+n.m09*o+n.m13,t.x=n.m02*i+n.m06*r+n.m10*o+n.m14,t},e.transformQuat=function(t,e,n){var i=n.w*e.x+n.y*e.z-n.z*e.y,r=n.w*e.y+n.z*e.x-n.x*e.z,o=n.w*e.z+n.x*e.y-n.y*e.x,a=-n.x*e.x-n.y*e.y-n.z*e.z;return t.x=i*n.w+a*-n.x+r*-n.z-o*-n.y,t.y=r*n.w+a*-n.y+o*-n.x-i*-n.z,t.z=o*n.w+a*-n.z+i*-n.y-r*-n.x,t},e.transformRTS=function(t,e,n,i,r){var o=e.x*r.x,a=e.y*r.y,s=e.z*r.z,c=n.w*o+n.y*s-n.z*a,l=n.w*a+n.z*o-n.x*s,u=n.w*s+n.x*a-n.y*o,h=-n.x*o-n.y*a-n.z*s;return t.x=c*n.w+h*-n.x+l*-n.z-u*-n.y+i.x,t.y=l*n.w+h*-n.y+u*-n.x-c*-n.z+i.y,t.z=u*n.w+h*-n.z+c*-n.y-l*-n.x+i.z,t},e.transformInverseRTS=function(t,e,n,i,r){var o=e.x-i.x,a=e.y-i.y,s=e.z-i.z,c=n.w*o-n.y*s+n.z*a,l=n.w*a-n.z*o+n.x*s,u=n.w*s-n.x*a+n.y*o,h=n.x*o+n.y*a+n.z*s;return t.x=(c*n.w+h*n.x+l*n.z-u*n.y)/r.x,t.y=(l*n.w+h*n.y+u*n.x-c*n.z)/r.y,t.z=(u*n.w+h*n.z+c*n.y-l*n.x)/r.z,t},e.rotateX=function(t,e,n,i){var r=e.x-n.x,o=e.y-n.y,a=e.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r,u=o*s-a*c,h=o*c+a*s;return t.x=l+n.x,t.y=u+n.y,t.z=h+n.z,t},e.rotateY=function(t,e,n,i){var r=e.x-n.x,o=e.y-n.y,a=e.z-n.z,s=Math.cos(i),c=Math.sin(i),l=a*c+r*s,u=o,h=a*s-r*c;return t.x=l+n.x,t.y=u+n.y,t.z=h+n.z,t},e.rotateZ=function(t,e,n,i){var r=e.x-n.x,o=e.y-n.y,a=e.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r*s-o*c,u=r*c+o*s,h=a;return t.x=l+n.x,t.y=u+n.y,t.z=h+n.z,t},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z},e.equals=function(t,e,n){void 0===n&&(n=zn);var i=t.x,r=t.y,o=t.z,a=e.x,s=e.y,c=e.z;return Math.abs(i-a)<=n*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-s)<=n*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(o-c)<=n*Math.max(1,Math.abs(o),Math.abs(c))},e.angle=function(t,n){e.normalize(ai,t),e.normalize(si,n);var i=e.dot(ai,si);return i>1?0:i<-1?Math.PI:Math.acos(i)},e.projectOnPlane=function(t,n,i){return e.subtract(t,n,e.project(t,n,i))},e.project=function(t,n,i){var r=e.lengthSqr(i);return r<1e-6?e.set(t,0,0,0):e.multiplyScalar(t,i,e.dot(n,i)/r)};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.z)},n.set=function(t,e,n){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=n||0),this},n.equals=function(t,e){return void 0===e&&(e=zn),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))},n.equals3f=function(t,e,n,i){return void 0===i&&(i=zn),Math.abs(this.x-t)<=i*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=i*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))},n.strictEquals=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z},n.strictEquals3f=function(t,e,n){return this.x===t&&this.y===e&&this.z===n},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},n.lerp=function(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this},n.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},n.add3f=function(t,e,n){return this.x+=t,this.y+=e,this.z+=n,this},n.subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},n.subtract3f=function(t,e,n){return this.x-=t,this.y-=e,this.z-=n,this},n.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this},n.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this},n.multiply3f=function(t,e,n){return this.x*=t,this.y*=e,this.z*=n,this},n.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},n.divide3f=function(t,e,n){return this.x/=t,this.y/=e,this.z/=n,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},n.clampf=function(t,e){return this.x=Un(this.x,t.x,e.x),this.y=Un(this.y,t.y,e.y),this.z=Un(this.z,t.z,e.z),this},n.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},n.cross=function(t){var e=this.x,n=this.y,i=this.z,r=t.x,o=t.y,a=t.z;return this.x=n*a-i*o,this.y=i*r-e*a,this.z=e*o-n*r,this},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.normalize=function(){var t=this.x,e=this.y,n=this.z,i=t*t+e*e+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=t*i,this.y=e*i,this.z=n*i),this},n.transformMat4=function(t){var e=this.x,n=this.y,i=this.z,r=t.m03*e+t.m07*n+t.m11*i+t.m15;return r=r?1/r:1,this.x=(t.m00*e+t.m04*n+t.m08*i+t.m12)*r,this.y=(t.m01*e+t.m05*n+t.m09*i+t.m13)*r,this.z=(t.m02*e+t.m06*n+t.m10*i+t.m14)*r,this},e}(te));oi.UNIT_X=Object.freeze(new oi(1,0,0)),oi.UNIT_Y=Object.freeze(new oi(0,1,0)),oi.UNIT_Z=Object.freeze(new oi(0,0,1)),oi.RIGHT=Object.freeze(new oi(1,0,0)),oi.UP=Object.freeze(new oi(0,1,0)),oi.FORWARD=Object.freeze(new oi(0,0,-1)),oi.ZERO=Object.freeze(new oi(0,0,0)),oi.ONE=Object.freeze(new oi(1,1,1)),oi.NEG_ONE=Object.freeze(new oi(-1,-1,-1));var ai=new oi,si=new oi;function ci(t,e,n){return new oi(t,e,n)}He.fastDefine("cc.Vec3",oi,{x:0,y:0,z:0}),i.Vec3=oi,i.v3=ci;var li=t("Vec2",function(t){function e(e,n){var i;return i=t.call(this)||this,e&&"object"==typeof e?(i.x=e.x,i.y=e.y):(i.x=e||0,i.y=n||0),i}F(e,t),e.clone=function(t){return new e(t.x,t.y)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t},e.set=function(t,e,n){return t.x=e,t.y=n,t},e.add=function(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t},e.subtract=function(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t},e.multiply=function(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t},e.divide=function(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t},e.min=function(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t},e.max=function(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t},e.distance=function(t,e){var n=e.x-t.x,i=e.y-t.y;return Math.sqrt(n*n+i*i)},e.squaredDistance=function(t,e){var n=e.x-t.x,i=e.y-t.y;return n*n+i*i},e.len=function(t){var e=t.x,n=t.y;return Math.sqrt(e*e+n*n)},e.lengthSqr=function(t){var e=t.x,n=t.y;return e*e+n*n},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t},e.inverse=function(t,e){return t.x=1/e.x,t.y=1/e.y,t},e.inverseSafe=function(t,e){var n=e.x,i=e.y;return Math.abs(n)<zn?t.x=0:t.x=1/n,Math.abs(i)<zn?t.y=0:t.y=1/i,t},e.normalize=function(t,e){var n=e.x,i=e.y,r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r),t.x=n*r,t.y=i*r),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y},e.cross=function(t,e,n){return t instanceof oi?(t.x=t.y=0,t.z=e.x*n.y-e.y*n.x,t):t.x*e.y-t.y*e.x},e.lerp=function(t,e,n,i){var r=e.x,o=e.y;return t.x=r+i*(n.x-r),t.y=o+i*(n.y-o),t},e.random=function(t,e){e=e||1;var n=2*qn()*Math.PI;return t.x=Math.cos(n)*e,t.y=Math.sin(n)*e,t},e.transformMat3=function(t,e,n){var i=e.x,r=e.y;return t.x=n.m00*i+n.m03*r+n.m06,t.y=n.m01*i+n.m04*r+n.m07,t},e.transformMat4=function(t,e,n){var i=e.x,r=e.y;return t.x=n.m00*i+n.m04*r+n.m12,t.y=n.m01*i+n.m05*r+n.m13,t},e.str=function(t){return"Vec2("+t.x+", "+t.y+")"},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y},e.equals=function(t,e,n){return void 0===n&&(n=zn),Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))},e.angle=function(t,n){e.normalize(ui,t),e.normalize(hi,n);var i=e.dot(ui,hi);return i>1?0:i<-1?Math.PI:Math.acos(i)};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y)},n.set=function(t,e){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0),this},n.equals=function(t,e){return void 0===e&&(e=zn),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))},n.equals2f=function(t,e,n){return void 0===n&&(n=zn),Math.abs(this.x-t)<=n*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=n*Math.max(1,Math.abs(this.y),Math.abs(e))},n.strictEquals=function(t){return t&&this.x===t.x&&this.y===t.y},n.strictEquals2f=function(t,e){return this.x===t&&this.y===e},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},n.lerp=function(t,e){var n=this.x,i=this.y;return this.x=n+e*(t.x-n),this.y=i+e*(t.y-i),this},n.clampf=function(t,e){return this.x=Un(this.x,t.x,e.x),this.y=Un(this.y,t.y,e.y),this},n.add=function(t){return this.x+=t.x,this.y+=t.y,this},n.add2f=function(t,e){return this.x+=t,this.y+=e,this},n.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},n.subtract2f=function(t,e){return this.x-=t,this.y-=e,this},n.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=t,this.y*=t,this},n.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this},n.multiply2f=function(t,e){return this.x*=t,this.y*=e,this},n.divide=function(t){return this.x/=t.x,this.y/=t.y,this},n.divide2f=function(t,e){return this.x/=t,this.y/=e,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this},n.dot=function(t){return this.x*t.x+this.y*t.y},n.cross=function(t){return this.x*t.y-this.y*t.x},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y},n.normalize=function(){var t=this.x,e=this.y,n=t*t+e*e;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this},n.angle=function(t){var e=this.lengthSqr(),n=t.lengthSqr();if(0===e||0===n)return console.warn("Can't get angle between zero vector"),0;var i=this.dot(t)/Math.sqrt(e*n);return i=Un(i,-1,1),Math.acos(i)},n.signAngle=function(t){var e=this.angle(t);return this.cross(t)<0?-e:e},n.rotate=function(t){var e=this.x,n=this.y,i=Math.sin(t),r=Math.cos(t);return this.x=r*e-i*n,this.y=i*e+r*n,this},n.project=function(t){var e=this.dot(t)/t.dot(t);return this.x=t.x*e,this.y=t.y*e,this},n.transformMat4=function(t){var e=this.x,n=this.y;return this.x=t.m00*e+t.m04*n+t.m12,this.y=t.m01*e+t.m05*n+t.m13,this},e}(te));li.ZERO=Object.freeze(new li(0,0)),li.ONE=Object.freeze(new li(1,1)),li.NEG_ONE=Object.freeze(new li(-1,-1)),li.UNIT_X=Object.freeze(new li(1,0)),li.UNIT_Y=Object.freeze(new li(0,1));var ui=new li,hi=new li;function _i(t,e){return new li(t,e)}He.fastDefine("cc.Vec2",li,{x:0,y:0}),i.Vec2=li,i.v2=_i;var fi=t("Vec4",function(t){function e(e,n,i,r){var o;return o=t.call(this)||this,e&&"object"==typeof e?(o.x=e.x,o.y=e.y,o.z=e.z,o.w=e.w):(o.x=e||0,o.y=n||0,o.z=i||0,o.w=r||0),o}F(e,t),e.clone=function(t){return new e(t.x,t.y,t.z,t.w)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t},e.set=function(t,e,n,i,r){return t.x=e,t.y=n,t.z=i,t.w=r,t},e.add=function(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t.z=e.z+n.z,t.w=e.w+n.w,t},e.subtract=function(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t.z=e.z-n.z,t.w=e.w-n.w,t},e.multiply=function(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t.z=e.z*n.z,t.w=e.w*n.w,t},e.divide=function(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t.z=e.z/n.z,t.w=e.w/n.w,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t.w=Math.ceil(e.w),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t.w=Math.floor(e.w),t},e.min=function(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t.z=Math.min(e.z,n.z),t.w=Math.min(e.w,n.w),t},e.max=function(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t.z=Math.max(e.z,n.z),t.w=Math.max(e.w,n.w),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t.w=Math.round(e.w),t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t.w=e.w+n.w*i,t},e.distance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z,o=e.w-t.w;return Math.sqrt(n*n+i*i+r*r+o*o)},e.squaredDistance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z,o=e.w-t.w;return n*n+i*i+r*r+o*o},e.len=function(t){var e=t.x,n=t.y,i=t.z,r=t.w;return Math.sqrt(e*e+n*n+i*i+r*r)},e.lengthSqr=function(t){var e=t.x,n=t.y,i=t.z,r=t.w;return e*e+n*n+i*i+r*r},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=-e.w,t},e.inverse=function(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t.w=1/e.w,t},e.inverseSafe=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w;return Math.abs(n)<zn?t.x=0:t.x=1/n,Math.abs(i)<zn?t.y=0:t.y=1/i,Math.abs(r)<zn?t.z=0:t.z=1/r,Math.abs(o)<zn?t.w=0:t.w=1/o,t},e.normalize=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w,a=n*n+i*i+r*r+o*o;return a>0&&(a=1/Math.sqrt(a),t.x=n*a,t.y=i*a,t.z=r*a,t.w=o*a),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},e.lerp=function(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t.w=e.w+i*(n.w-e.w),t},e.random=function(t,e){e=e||1;var n=2*qn()*Math.PI,i=2*qn()-1,r=Math.sqrt(1-i*i);return t.x=r*Math.cos(n)*e,t.y=r*Math.sin(n)*e,t.z=i*e,t.w=0,t},e.transformMat4=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w;return t.x=n.m00*i+n.m04*r+n.m08*o+n.m12*a,t.y=n.m01*i+n.m05*r+n.m09*o+n.m13*a,t.z=n.m02*i+n.m06*r+n.m10*o+n.m14*a,t.w=n.m03*i+n.m07*r+n.m11*o+n.m15*a,t},e.transformAffine=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w;return t.x=n.m00*i+n.m01*r+n.m02*o+n.m03*a,t.y=n.m04*i+n.m05*r+n.m06*o+n.m07*a,t.x=n.m08*i+n.m09*r+n.m10*o+n.m11*a,t.w=e.w,t},e.transformQuat=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.x,s=n.y,c=n.z,l=n.w,u=l*i+s*o-c*r,h=l*r+c*i-a*o,_=l*o+a*r-s*i,f=-a*i-s*r-c*o;return t.x=u*l+f*-a+h*-c-_*-s,t.y=h*l+f*-s+_*-a-u*-c,t.z=_*l+f*-c+u*-s-h*-a,t.w=e.w,t},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t[n+3]=e.w,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t.w=e[n+3],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w},e.equals=function(t,e,n){return void 0===n&&(n=zn),Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=n*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=n*Math.max(1,Math.abs(t.w),Math.abs(e.w))};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.z,this.w)},n.set=function(t,e,n,i){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=n||0,this.w=i||0),this},n.equals=function(t,e){return void 0===e&&(e=zn),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))},n.equals4f=function(t,e,n,i,r){return void 0===r&&(r=zn),Math.abs(this.x-t)<=r*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=r*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-n)<=r*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=r*Math.max(1,Math.abs(this.w),Math.abs(i))},n.strictEquals=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},n.strictEquals4f=function(t,e,n,i){return this.x===t&&this.y===e&&this.z===n&&this.w===i},n.lerp=function(t,e){var n=this.x,i=this.y,r=this.z,o=this.w;return this.x=n+e*(t.x-n),this.y=i+e*(t.y-i),this.z=r+e*(t.z-r),this.w=o+e*(t.w-o),this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},n.clampf=function(t,e){return this.x=Un(this.x,t.x,e.x),this.y=Un(this.y,t.y,e.y),this.z=Un(this.z,t.z,e.z),this.w=Un(this.w,t.w,e.w),this},n.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},n.add4f=function(t,e,n,i){return this.x+=t,this.y+=e,this.z+=n,this.w+=i,this},n.subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},n.subtract4f=function(t,e,n,i){return this.x-=t,this.y-=e,this.z-=n,this.w-=i,this},n.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},n.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this},n.multiply4f=function(t,e,n,i){return this.x*=t,this.y*=e,this.z*=n,this.w*=i,this},n.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this},n.divide4f=function(t,e,n,i){return this.x/=t,this.y/=e,this.z/=n,this.w/=i,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},n.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},n.cross=function(t){var e=this.x,n=this.y,i=this.z,r=t.x,o=t.y,a=t.z;return this.x=n*a-i*o,this.y=i*r-e*a,this.z=e*o-n*r,this},n.length=function(){var t=this.x,e=this.y,n=this.z,i=this.w;return Math.sqrt(t*t+e*e+n*n+i*i)},n.lengthSqr=function(){var t=this.x,e=this.y,n=this.z,i=this.w;return t*t+e*e+n*n+i*i},n.normalize=function(){var t=this.x,e=this.y,n=this.z,i=this.w,r=t*t+e*e+n*n+i*i;return r>0&&(r=1/Math.sqrt(r),this.x=t*r,this.y=e*r,this.z=n*r,this.w=i*r),this},n.transformMat4=function(t){var e=this.x,n=this.y,i=this.z,r=this.w;return this.x=t.m00*e+t.m04*n+t.m08*i+t.m12*r,this.y=t.m01*e+t.m05*n+t.m09*i+t.m13*r,this.z=t.m02*e+t.m06*n+t.m10*i+t.m14*r,this.w=t.m03*e+t.m07*n+t.m11*i+t.m15*r,this},e}(te));function pi(t,e,n,i){return new fi(t,e,n,i)}fi.ZERO=Object.freeze(new fi(0,0,0,0)),fi.ONE=Object.freeze(new fi(1,1,1,1)),fi.NEG_ONE=Object.freeze(new fi(-1,-1,-1,-1)),He.fastDefine("cc.Vec4",fi,{x:0,y:0,z:0,w:0}),i.Vec4=fi,i.v4=pi;var di=t("Mat3",function(t){function e(e,n,i,r,o,a,s,c,l){var u;return void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),u=t.call(this)||this,"object"==typeof e?(u.m00=e.m00,u.m01=e.m01,u.m02=e.m02,u.m03=e.m03,u.m04=e.m04,u.m05=e.m05,u.m06=e.m06,u.m07=e.m07,u.m08=e.m08):(u.m00=e,u.m01=n,u.m02=i,u.m03=r,u.m04=o,u.m05=a,u.m06=s,u.m07=c,u.m08=l),u}F(e,t),e.clone=function(t){return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)},e.copy=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t},e.set=function(t,e,n,i,r,o,a,s,c,l){return t.m00=e,t.m01=n,t.m02=i,t.m03=r,t.m04=o,t.m05=a,t.m06=s,t.m07=c,t.m08=l,t},e.identity=function(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.transpose=function(t,e){if(t===e){var n=e.m01,i=e.m02,r=e.m05;t.m01=e.m03,t.m02=e.m06,t.m03=n,t.m05=e.m07,t.m06=i,t.m07=r}else t.m00=e.m00,t.m01=e.m03,t.m02=e.m06,t.m03=e.m01,t.m04=e.m04,t.m05=e.m07,t.m06=e.m02,t.m07=e.m05,t.m08=e.m08;return t},e.invert=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=u*a-s*l,_=-u*o+s*c,f=l*o-a*c,p=n*h+i*_+r*f;return 0===p?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t):(p=1/p,t.m00=h*p,t.m01=(-u*i+r*l)*p,t.m02=(s*i-r*a)*p,t.m03=_*p,t.m04=(u*n-r*c)*p,t.m05=(-s*n+r*o)*p,t.m06=f*p,t.m07=(-l*n+i*c)*p,t.m08=(a*n-i*o)*p,t)},e.determinant=function(t){var e=t.m00,n=t.m01,i=t.m02,r=t.m03,o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08;return e*(l*o-a*c)+n*(-l*r+a*s)+i*(c*r-o*s)},e.multiply=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=n.m00,f=n.m01,p=n.m02,d=n.m03,m=n.m04,v=n.m05,g=n.m06,y=n.m07,x=n.m08;return t.m00=_*i+f*a+p*l,t.m01=_*r+f*s+p*u,t.m02=_*o+f*c+p*h,t.m03=d*i+m*a+v*l,t.m04=d*r+m*s+v*u,t.m05=d*o+m*c+v*h,t.m06=g*i+y*a+x*l,t.m07=g*r+y*s+x*u,t.m08=g*o+y*c+x*h,t},e.multiplyMat4=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=n.m00,f=n.m01,p=n.m02,d=n.m04,m=n.m05,v=n.m06,g=n.m08,y=n.m09,x=n.m10;return t.m00=_*i+f*a+p*l,t.m01=_*r+f*s+p*u,t.m02=_*o+f*c+p*h,t.m03=d*i+m*a+v*l,t.m04=d*r+m*s+v*u,t.m05=d*o+m*c+v*h,t.m06=g*i+y*a+x*l,t.m07=g*r+y*s+x*u,t.m08=g*o+y*c+x*h,t},e.transform=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=n.x,f=n.y;return t.m00=i,t.m01=r,t.m02=o,t.m03=a,t.m04=s,t.m05=c,t.m06=_*i+f*a+l,t.m07=_*r+f*s+u,t.m08=_*o+f*c+h,t},e.scale=function(t,e,n){var i=n.x,r=n.y;return t.m00=i*e.m00,t.m01=i*e.m01,t.m02=i*e.m02,t.m03=r*e.m03,t.m04=r*e.m04,t.m05=r*e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t},e.rotate=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=Math.sin(n),f=Math.cos(n);return t.m00=f*i+_*a,t.m01=f*r+_*s,t.m02=f*o+_*c,t.m03=f*a-_*i,t.m04=f*s-_*r,t.m05=f*c-_*o,t.m06=l,t.m07=u,t.m08=h,t},e.fromMat4=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m04,t.m04=e.m05,t.m05=e.m06,t.m06=e.m08,t.m07=e.m09,t.m08=e.m10,t},e.fromViewUp=function(t,n,i){return oi.lengthSqr(n)<zn*zn?(e.identity(t),t):(i=i||oi.UNIT_Y,oi.normalize(mi,oi.cross(mi,i,n)),oi.lengthSqr(mi)<zn*zn?(e.identity(t),t):(oi.cross(vi,n,mi),e.set(t,mi.x,mi.y,mi.z,vi.x,vi.y,vi.z,n.x,n.y,n.z),t))},e.fromTranslation=function(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=e.x,t.m07=e.y,t.m08=1,t},e.fromScaling=function(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=e.y,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.fromRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=n,t.m02=0,t.m03=-n,t.m04=i,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.fromQuat=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,_=r*a,f=r*s,p=r*c,d=o*a,m=o*s,v=o*c;return t.m00=1-h-p,t.m03=u-v,t.m06=_+m,t.m01=u+v,t.m04=1-l-p,t.m07=f-d,t.m02=_-m,t.m05=f+d,t.m08=1-l-h,t},e.inverseTransposeMat4=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=e.m09,_=e.m10,f=e.m11,p=e.m12,d=e.m13,m=e.m14,v=e.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,A=i*l-o*s,C=r*l-o*c,b=u*d-h*p,T=u*m-_*p,E=u*v-f*p,w=h*m-_*d,P=h*v-f*d,I=_*v-f*m,R=g*I-y*P+x*w+S*E-A*T+C*b;return R?(R=1/R,t.m00=(s*I-c*P+l*w)*R,t.m01=(c*E-a*I-l*T)*R,t.m02=(a*P-s*E+l*b)*R,t.m03=(r*P-i*I-o*w)*R,t.m04=(n*I-r*E+o*T)*R,t.m05=(i*E-n*P-o*b)*R,t.m06=(d*C-m*A+v*S)*R,t.m07=(m*x-p*C-v*y)*R,t.m08=(p*A-d*x+v*g)*R,t):null},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.m00,t[n+1]=e.m01,t[n+2]=e.m02,t[n+3]=e.m03,t[n+4]=e.m04,t[n+5]=e.m05,t[n+6]=e.m06,t[n+7]=e.m07,t[n+8]=e.m08,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.m00=e[n+0],t.m01=e[n+1],t.m02=e[n+2],t.m03=e[n+3],t.m04=e[n+4],t.m05=e[n+5],t.m06=e[n+6],t.m07=e[n+7],t.m08=e[n+8],t},e.add=function(t,e,n){return t.m00=e.m00+n.m00,t.m01=e.m01+n.m01,t.m02=e.m02+n.m02,t.m03=e.m03+n.m03,t.m04=e.m04+n.m04,t.m05=e.m05+n.m05,t.m06=e.m06+n.m06,t.m07=e.m07+n.m07,t.m08=e.m08+n.m08,t},e.subtract=function(t,e,n){return t.m00=e.m00-n.m00,t.m01=e.m01-n.m01,t.m02=e.m02-n.m02,t.m03=e.m03-n.m03,t.m04=e.m04-n.m04,t.m05=e.m05-n.m05,t.m06=e.m06-n.m06,t.m07=e.m07-n.m07,t.m08=e.m08-n.m08,t},e.multiplyScalar=function(t,e,n){return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*n,t.m05=e.m05*n,t.m06=e.m06*n,t.m07=e.m07*n,t.m08=e.m08*n,t},e.multiplyScalarAndAdd=function(t,e,n,i){return t.m00=n.m00*i+e.m00,t.m01=n.m01*i+e.m01,t.m02=n.m02*i+e.m02,t.m03=n.m03*i+e.m03,t.m04=n.m04*i+e.m04,t.m05=n.m05*i+e.m05,t.m06=n.m06*i+e.m06,t.m07=n.m07*i+e.m07,t.m08=n.m08*i+e.m08,t},e.strictEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08},e.equals=function(t,e,n){return void 0===n&&(n=zn),Math.abs(t.m00-e.m00)<=n*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=n*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=n*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=n*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=n*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=n*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=n*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=n*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=n*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))};var n=e.prototype;return n.clone=function(){var t=this;return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)},n.set=function(t,e,n,i,r,o,a,s,c){return void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=1),"object"==typeof t?(this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08):(this.m00=t,this.m01=e,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c),this},n.equals=function(t,e){return void 0===e&&(e=zn),Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))},n.strictEquals=function(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08},n.toString=function(){var t=this;return"[\n"+t.m00+", "+t.m01+", "+t.m02+",\n"+t.m03+",\n"+t.m04+", "+t.m05+",\n"+t.m06+", "+t.m07+",\n"+t.m08+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},n.transpose=function(){var t=this.m01,e=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=t,this.m05=this.m07,this.m06=e,this.m07=n,this},n.invert=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=c*r-o*s,u=-c*i+o*a,h=s*i-r*a,_=t*l+e*u+n*h;return 0===_?(this.set(0,0,0,0,0,0,0,0,0),this):(_=1/_,this.m00=l*_,this.m01=(-c*e+n*s)*_,this.m02=(o*e-n*r)*_,this.m03=u*_,this.m04=(c*t-n*a)*_,this.m05=(-o*t+n*i)*_,this.m06=h*_,this.m07=(-s*t+e*a)*_,this.m08=(r*t-e*i)*_,this)},n.determinant=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08;return t*(c*r-o*s)+e*(-c*i+o*a)+n*(s*i-r*a)},n.add=function(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this},n.subtract=function(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this},n.multiply=function(t){var e=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=t.m00,h=t.m01,_=t.m02,f=t.m03,p=t.m04,d=t.m05,m=t.m06,v=t.m07,g=t.m08;return this.m00=u*e+h*r+_*s,this.m01=u*n+h*o+_*c,this.m02=u*i+h*a+_*l,this.m03=f*e+p*r+d*s,this.m04=f*n+p*o+d*c,this.m05=f*i+p*a+d*l,this.m06=m*e+v*r+g*s,this.m07=m*n+v*o+g*c,this.m08=m*i+v*a+g*l,this},n.multiplyScalar=function(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this},n.scale=function(t){var e=t.x,n=t.y;return this.m00=e*this.m00,this.m01=e*this.m01,this.m02=e*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},n.rotate=function(t){var e=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(t),h=Math.cos(t);return this.m00=h*e+u*r,this.m01=h*n+u*o,this.m02=h*i+u*a,this.m03=h*r-u*e,this.m04=h*o-u*n,this.m05=h*a-u*i,this.m06=s,this.m07=c,this.m08=l,this},n.fromQuat=function(t){var e=t.x,n=t.y,i=t.z,r=t.w,o=e+e,a=n+n,s=i+i,c=e*o,l=n*o,u=n*a,h=i*o,_=i*a,f=i*s,p=r*o,d=r*a,m=r*s;return this.m00=1-u-f,this.m03=l-m,this.m06=h+d,this.m01=l+m,this.m04=1-c-f,this.m07=_-p,this.m02=h-d,this.m05=_+p,this.m08=1-c-u,this},e}(te));di.IDENTITY=Object.freeze(new di);var mi=new oi,vi=new oi;He.fastDefine("cc.Mat3",di,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),i.Mat3=di;var gi=t("Quat",function(t){function e(e,n,i,r){var o;return o=t.call(this)||this,e&&"object"==typeof e?(o.x=e.x,o.y=e.y,o.z=e.z,o.w=e.w):(o.x=e||0,o.y=n||0,o.z=i||0,o.w=null!=r?r:1),o}F(e,t),e.clone=function(t){return new e(t.x,t.y,t.z,t.w)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t},e.set=function(t,e,n,i,r){return t.x=e,t.y=n,t.z=i,t.w=r,t},e.identity=function(t){return t.x=0,t.y=0,t.z=0,t.w=1,t},e.rotationTo=function(t,n,i){var r=oi.dot(n,i);return r<-.999999?(oi.cross(Si,oi.UNIT_X,n),Si.length()<1e-6&&oi.cross(Si,oi.UNIT_Y,n),oi.normalize(Si,Si),e.fromAxisAngle(t,Si,Math.PI),t):r>.999999?(t.x=0,t.y=0,t.z=0,t.w=1,t):(oi.cross(Si,n,i),t.x=Si.x,t.y=Si.y,t.z=Si.z,t.w=1+r,e.normalize(t,t))},e.getAxisAngle=function(t,e){var n=2*Math.acos(e.w),i=Math.sin(n/2);return 0!==i?(t.x=e.x/i,t.y=e.y/i,t.z=e.z/i):(t.x=1,t.y=0,t.z=0),n},e.multiply=function(t,e,n){var i=e.x*n.w+e.w*n.x+e.y*n.z-e.z*n.y,r=e.y*n.w+e.w*n.y+e.z*n.x-e.x*n.z,o=e.z*n.w+e.w*n.z+e.x*n.y-e.y*n.x,a=e.w*n.w-e.x*n.x-e.y*n.y-e.z*n.z;return t.x=i,t.y=r,t.z=o,t.w=a,t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t.w=e.w+n.w*i,t},e.rotateX=function(t,e,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=e.x,a=e.y,s=e.z,c=e.w;return t.x=o*r+c*i,t.y=a*r+s*i,t.z=s*r-a*i,t.w=c*r-o*i,t},e.rotateY=function(t,e,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=e.x,a=e.y,s=e.z,c=e.w;return t.x=o*r-s*i,t.y=a*r+c*i,t.z=s*r+o*i,t.w=c*r-a*i,t},e.rotateZ=function(t,e,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=e.x,a=e.y,s=e.z,c=e.w;return t.x=o*r+a*i,t.y=a*r-o*i,t.z=s*r+c*i,t.w=c*r-s*i,t},e.rotateAround=function(t,n,i,r){return e.invert(yi,n),oi.transformQuat(Si,i,yi),e.fromAxisAngle(yi,Si,r),e.multiply(t,n,yi),t},e.rotateAroundLocal=function(t,n,i,r){return e.fromAxisAngle(yi,i,r),e.multiply(t,n,yi),t},e.calculateW=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=Math.sqrt(Math.abs(1-e.x*e.x-e.y*e.y-e.z*e.z)),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},e.lerp=function(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t.w=e.w+i*(n.w-e.w),t},e.slerp=function(t,e,n,i){var r=0,o=0,a=n.x,s=n.y,c=n.z,l=n.w,u=e.x*n.x+e.y*n.y+e.z*n.z+e.w*n.w;if(u<0&&(u=-u,a=-a,s=-s,c=-c,l=-l),1-u>1e-6){var h=Math.acos(u),_=Math.sin(h);r=Math.sin((1-i)*h)/_,o=Math.sin(i*h)/_}else r=1-i,o=i;return t.x=r*e.x+o*a,t.y=r*e.y+o*s,t.z=r*e.z+o*c,t.w=r*e.w+o*l,t},e.sqlerp=function(t,n,i,r,o,a){return e.slerp(yi,n,o,a),e.slerp(xi,i,r,a),e.slerp(t,yi,xi,2*a*(1-a)),t},e.invert=function(t,e){var n=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w,i=n?1/n:0;return t.x=-e.x*i,t.y=-e.y*i,t.z=-e.z*i,t.w=e.w*i,t},e.conjugate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w,t},e.len=function(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w)},e.lengthSqr=function(t){return t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w},e.normalize=function(t,e){var n=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;return n>0&&(n=1/Math.sqrt(n),t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n),t},e.fromAxes=function(t,n,i,r){return di.set(Ai,n.x,n.y,n.z,i.x,i.y,i.z,r.x,r.y,r.z),e.normalize(t,e.fromMat3(t,Ai))},e.fromViewUp=function(t,n,i){return di.fromViewUp(Ai,n,i),e.normalize(t,e.fromMat3(t,Ai))},e.fromAxisAngle=function(t,e,n){n*=.5;var i=Math.sin(n);return t.x=i*e.x,t.y=i*e.y,t.z=i*e.z,t.w=Math.cos(n),t},e.fromMat3=function(t,e){var n=e.m00,i=e.m03,r=e.m06,o=e.m01,a=e.m04,s=e.m07,c=e.m02,l=e.m05,u=e.m08,h=n+a+u;if(h>0){var _=.5/Math.sqrt(h+1);t.w=.25/_,t.x=(l-s)*_,t.y=(r-c)*_,t.z=(o-i)*_}else if(n>a&&n>u){var f=2*Math.sqrt(1+n-a-u);t.w=(l-s)/f,t.x=.25*f,t.y=(i+o)/f,t.z=(r+c)/f}else if(a>u){var p=2*Math.sqrt(1+a-n-u);t.w=(r-c)/p,t.x=(i+o)/p,t.y=.25*p,t.z=(s+l)/p}else{var d=2*Math.sqrt(1+u-n-a);t.w=(o-i)/d,t.x=(r+c)/d,t.y=(s+l)/d,t.z=.25*d}return t},e.fromEuler=function(t,e,n,i){e*=Ci,n*=Ci,i*=Ci;var r=Math.sin(e),o=Math.cos(e),a=Math.sin(n),s=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return t.x=r*s*l+o*a*c,t.y=o*a*l+r*s*c,t.z=o*s*c-r*a*l,t.w=o*s*l-r*a*c,t},e.fromAngleZ=function(t,e){return e*=Ci,t.x=t.y=0,t.z=Math.sin(e),t.w=Math.cos(e),t},e.toAxisX=function(t,e){var n=2*e.y,i=2*e.z;return t.x=1-n*e.y-i*e.z,t.y=n*e.x+i*e.w,t.z=i*e.x+n*e.w,t},e.toAxisY=function(t,e){var n=2*e.x,i=2*e.y,r=2*e.z;return t.x=i*e.x-r*e.w,t.y=1-n*e.x-r*e.z,t.z=r*e.y+n*e.w,t},e.toAxisZ=function(t,e){var n=2*e.x,i=2*e.y,r=2*e.z;return t.x=r*e.x-i*e.w,t.y=r*e.y-n*e.w,t.z=1-n*e.x-i*e.y,t},e.toEuler=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w,s=0,c=0,l=0,u=i*r+o*a;if(u>.499999)s=0,c=Wn(2*Math.atan2(i,a)),l=90;else if(u<-.499999)s=0,c=-Wn(2*Math.atan2(i,a)),l=-90;else{var h=i*i,_=r*r,f=o*o;s=Wn(Math.atan2(2*i*a-2*r*o,1-2*h-2*f)),c=Wn(Math.atan2(2*r*a-2*i*o,1-2*_-2*f)),l=Wn(Math.asin(2*u)),n&&(s=-180*Math.sign(s+1e-6)+s,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return t.x=s,t.y=c,t.z=l,t},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t[n+3]=e.w,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t.w=e[n+3],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w},e.equals=function(t,e,n){return void 0===n&&(n=zn),Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=n*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=n*Math.max(1,Math.abs(t.w),Math.abs(e.w))};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.z,this.w)},n.set=function(t,e,n,i){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=n||0,this.w=null!=i?i:1),this},n.equals=function(t,e){return void 0===e&&(e=zn),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))},n.strictEquals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},n.getEulerAngles=function(t){return e.toEuler(t,this)},n.lerp=function(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this.w+=e*(t.w-this.w),this},n.slerp=function(t,n){return e.slerp(this,this,t,n)},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},e}(te));gi.IDENTITY=Object.freeze(new gi);var yi=new gi,xi=new gi,Si=new oi,Ai=new di,Ci=.5*Math.PI/180;function bi(t,e,n,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),new gi(t,e,n,i)}He.fastDefine("cc.Quat",gi,{x:0,y:0,z:0,w:1}),i.Quat=gi,i.quat=bi;var Ti=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),Ei=t("Mat4",function(t){function e(e,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m){var v;return void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=1),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===d&&(d=0),void 0===m&&(m=1),(v=t.call(this)||this).m00=void 0,v.m01=void 0,v.m02=void 0,v.m03=void 0,v.m04=void 0,v.m05=void 0,v.m06=void 0,v.m07=void 0,v.m08=void 0,v.m09=void 0,v.m10=void 0,v.m11=void 0,v.m12=void 0,v.m13=void 0,v.m14=void 0,v.m15=void 0,"object"==typeof e?(v.m00=e.m00,v.m01=e.m01,v.m02=e.m02,v.m03=e.m03,v.m04=e.m04,v.m05=e.m05,v.m06=e.m06,v.m07=e.m07,v.m08=e.m08,v.m09=e.m09,v.m10=e.m10,v.m11=e.m11,v.m12=e.m12,v.m13=e.m13,v.m14=e.m14,v.m15=e.m15):(v.m00=e,v.m01=n,v.m02=i,v.m03=r,v.m04=o,v.m05=a,v.m06=s,v.m07=c,v.m08=l,v.m09=u,v.m10=h,v.m11=_,v.m12=f,v.m13=p,v.m14=d,v.m15=m),v}F(e,t),e.clone=function(t){return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08,t.m09,t.m10,t.m11,t.m12,t.m13,t.m14,t.m15)},e.copy=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t},e.set=function(t,e,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m){return t.m00=e,t.m01=n,t.m02=i,t.m03=r,t.m04=o,t.m05=a,t.m06=s,t.m07=c,t.m08=l,t.m09=u,t.m10=h,t.m11=_,t.m12=f,t.m13=p,t.m14=d,t.m15=m,t},e.identity=function(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.transpose=function(t,e){if(t===e){var n=e.m01,i=e.m02,r=e.m03,o=e.m06,a=e.m07,s=e.m11;t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=n,t.m06=e.m09,t.m07=e.m13,t.m08=i,t.m09=o,t.m11=e.m14,t.m12=r,t.m13=a,t.m14=s}else t.m00=e.m00,t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=e.m01,t.m05=e.m05,t.m06=e.m09,t.m07=e.m13,t.m08=e.m02,t.m09=e.m06,t.m10=e.m10,t.m11=e.m14,t.m12=e.m03,t.m13=e.m07,t.m14=e.m11,t.m15=e.m15;return t},e.invert=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=e.m09,_=e.m10,f=e.m11,p=e.m12,d=e.m13,m=e.m14,v=e.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,A=i*l-o*s,C=r*l-o*c,b=u*d-h*p,T=u*m-_*p,E=u*v-f*p,w=h*m-_*d,P=h*v-f*d,I=_*v-f*m,R=g*I-y*P+x*w+S*E-A*T+C*b;return 0===R?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=0,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=0,t):(R=1/R,t.m00=(s*I-c*P+l*w)*R,t.m01=(r*P-i*I-o*w)*R,t.m02=(d*C-m*A+v*S)*R,t.m03=(_*A-h*C-f*S)*R,t.m04=(c*E-a*I-l*T)*R,t.m05=(n*I-r*E+o*T)*R,t.m06=(m*x-p*C-v*y)*R,t.m07=(u*C-_*x+f*y)*R,t.m08=(a*P-s*E+l*b)*R,t.m09=(i*E-n*P-o*b)*R,t.m10=(p*A-d*x+v*g)*R,t.m11=(h*x-u*A-f*g)*R,t.m12=(s*T-a*w-c*b)*R,t.m13=(n*w-i*T+r*b)*R,t.m14=(d*y-p*S-m*g)*R,t.m15=(u*S-h*y+_*g)*R,t)},e.determinant=function(t){var e=t.m00,n=t.m01,i=t.m02,r=t.m03,o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,_=t.m11,f=t.m12,p=t.m13,d=t.m14,m=t.m15;return(e*a-n*o)*(h*m-_*d)-(e*s-i*o)*(u*m-_*p)+(e*c-r*o)*(u*d-h*p)+(n*s-i*a)*(l*m-_*f)-(n*c-r*a)*(l*d-h*f)+(i*c-r*s)*(l*p-u*f)},e.multiply=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=e.m09,f=e.m10,p=e.m11,d=e.m12,m=e.m13,v=e.m14,g=e.m15,y=n.m00,x=n.m01,S=n.m02,A=n.m03;return t.m00=y*i+x*s+S*h+A*d,t.m01=y*r+x*c+S*_+A*m,t.m02=y*o+x*l+S*f+A*v,t.m03=y*a+x*u+S*p+A*g,y=n.m04,x=n.m05,S=n.m06,A=n.m07,t.m04=y*i+x*s+S*h+A*d,t.m05=y*r+x*c+S*_+A*m,t.m06=y*o+x*l+S*f+A*v,t.m07=y*a+x*u+S*p+A*g,y=n.m08,x=n.m09,S=n.m10,A=n.m11,t.m08=y*i+x*s+S*h+A*d,t.m09=y*r+x*c+S*_+A*m,t.m10=y*o+x*l+S*f+A*v,t.m11=y*a+x*u+S*p+A*g,y=n.m12,x=n.m13,S=n.m14,A=n.m15,t.m12=y*i+x*s+S*h+A*d,t.m13=y*r+x*c+S*_+A*m,t.m14=y*o+x*l+S*f+A*v,t.m15=y*a+x*u+S*p+A*g,t},e.transform=function(t,e,n){var i=n.x,r=n.y,o=n.z;if(e===t)t.m12=e.m00*i+e.m04*r+e.m08*o+e.m12,t.m13=e.m01*i+e.m05*r+e.m09*o+e.m13,t.m14=e.m02*i+e.m06*r+e.m10*o+e.m14,t.m15=e.m03*i+e.m07*r+e.m11*o+e.m15;else{var a=e.m00,s=e.m01,c=e.m02,l=e.m03,u=e.m04,h=e.m05,_=e.m06,f=e.m07,p=e.m08,d=e.m09,m=e.m10,v=e.m11;e.m12,e.m13,e.m14,e.m15,t.m00=a,t.m01=s,t.m02=c,t.m03=l,t.m04=u,t.m05=h,t.m06=_,t.m07=f,t.m08=p,t.m09=d,t.m10=m,t.m11=v,t.m12=a*i+u*r+p*o+e.m12,t.m13=s*i+h*r+d*o+e.m13,t.m14=c*i+_*r+m*o+e.m14,t.m15=l*i+f*r+v*o+e.m15}return t},e.translate=function(t,e,n){return console.warn("function changed"),e===t?(t.m12+=n.x,t.m13+=n.y,t.m14+=n.z):(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12+=n.x,t.m13+=n.y,t.m14+=n.z,t.m15=e.m15),t},e.scale=function(t,e,n){var i=n.x,r=n.y,o=n.z;return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*r,t.m05=e.m05*r,t.m06=e.m06*r,t.m07=e.m07*r,t.m08=e.m08*o,t.m09=e.m09*o,t.m10=e.m10*o,t.m11=e.m11*o,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t},e.rotate=function(t,e,n,i){var r=i.x,o=i.y,a=i.z,s=Math.sqrt(r*r+o*o+a*a);if(Math.abs(s)<zn)return null;r*=s=1/s,o*=s,a*=s;var c=Math.sin(n),l=Math.cos(n),u=1-l,h=e.m00,_=e.m01,f=e.m02,p=e.m03,d=e.m04,m=e.m05,v=e.m06,g=e.m07,y=e.m08,x=e.m09,S=e.m10,A=e.m11,C=r*r*u+l,b=o*r*u+a*c,T=a*r*u-o*c,E=r*o*u-a*c,w=o*o*u+l,P=a*o*u+r*c,I=r*a*u+o*c,R=o*a*u-r*c,D=a*a*u+l;return t.m00=h*C+d*b+y*T,t.m01=_*C+m*b+x*T,t.m02=f*C+v*b+S*T,t.m03=p*C+g*b+A*T,t.m04=h*E+d*w+y*P,t.m05=_*E+m*w+x*P,t.m06=f*E+v*w+S*P,t.m07=p*E+g*w+A*P,t.m08=h*I+d*R+y*D,t.m09=_*I+m*R+x*D,t.m10=f*I+v*R+S*D,t.m11=p*I+g*R+A*D,e!==t&&(t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t},e.rotateX=function(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,_=e.m11;return e!==t&&(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m04=o*r+l*i,t.m05=a*r+u*i,t.m06=s*r+h*i,t.m07=c*r+_*i,t.m08=l*r-o*i,t.m09=u*r-a*i,t.m10=h*r-s*i,t.m11=_*r-c*i,t},e.rotateY=function(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e.m00,a=e.m01,s=e.m02,c=e.m03,l=e.m08,u=e.m09,h=e.m10,_=e.m11;return e!==t&&(t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=o*r-l*i,t.m01=a*r-u*i,t.m02=s*r-h*i,t.m03=c*r-_*i,t.m08=o*i+l*r,t.m09=a*i+u*r,t.m10=s*i+h*r,t.m11=c*i+_*r,t},e.rotateZ=function(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e.m00,a=e.m01,s=e.m02,c=e.m03,l=e.m04,u=e.m05,h=e.m06,_=e.m07;return e!==t&&(t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=o*r+l*i,t.m01=a*r+u*i,t.m02=s*r+h*i,t.m03=c*r+_*i,t.m04=l*r-o*i,t.m05=u*r-a*i,t.m06=h*r-s*i,t.m07=_*r-c*i,t},e.fromTranslation=function(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=e.x,t.m13=e.y,t.m14=e.z,t.m15=1,t},e.fromScaling=function(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=e.y,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=e.z,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromRotation=function(t,e,n){var i=n.x,r=n.y,o=n.z,a=Math.sqrt(i*i+r*r+o*o);if(Math.abs(a)<zn)return null;i*=a=1/a,r*=a,o*=a;var s=Math.sin(e),c=Math.cos(e),l=1-c;return t.m00=i*i*l+c,t.m01=r*i*l+o*s,t.m02=o*i*l-r*s,t.m03=0,t.m04=i*r*l-o*s,t.m05=r*r*l+c,t.m06=o*r*l+i*s,t.m07=0,t.m08=i*o*l+r*s,t.m09=r*o*l-i*s,t.m10=o*o*l+c,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromXRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=i,t.m06=n,t.m07=0,t.m08=0,t.m09=-n,t.m10=i,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromYRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=0,t.m02=-n,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=n,t.m09=0,t.m10=i,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromZRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=n,t.m02=0,t.m03=0,t.m04=-n,t.m05=i,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromRT=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,_=i*l,f=r*c,p=r*l,d=o*l,m=a*s,v=a*c,g=a*l;return t.m00=1-(f+d),t.m01=h+g,t.m02=_-v,t.m03=0,t.m04=h-g,t.m05=1-(u+d),t.m06=p+m,t.m07=0,t.m08=_+v,t.m09=p-m,t.m10=1-(u+f),t.m11=0,t.m12=n.x,t.m13=n.y,t.m14=n.z,t.m15=1,t},e.getTranslation=function(t,e){return t.x=e.m12,t.y=e.m13,t.z=e.m14,t},e.getScaling=function(t,e){var n=Pi.m00=e.m00,i=Pi.m01=e.m01,r=Pi.m02=e.m02,o=Pi.m03=e.m04,a=Pi.m04=e.m05,s=Pi.m05=e.m06,c=Pi.m06=e.m08,l=Pi.m07=e.m09,u=Pi.m08=e.m10;return t.x=Math.sqrt(n*n+i*i+r*r),t.y=Math.sqrt(o*o+a*a+s*s),t.z=Math.sqrt(c*c+l*l+u*u),di.determinant(Pi)<0&&(t.x*=-1),t},e.getRotation=function(t,e){var n=e.m00+e.m05+e.m10,i=0;return n>0?(i=2*Math.sqrt(n+1),t.w=.25*i,t.x=(e.m06-e.m09)/i,t.y=(e.m08-e.m02)/i,t.z=(e.m01-e.m04)/i):e.m00>e.m05&&e.m00>e.m10?(i=2*Math.sqrt(1+e.m00-e.m05-e.m10),t.w=(e.m06-e.m09)/i,t.x=.25*i,t.y=(e.m01+e.m04)/i,t.z=(e.m08+e.m02)/i):e.m05>e.m10?(i=2*Math.sqrt(1+e.m05-e.m00-e.m10),t.w=(e.m08-e.m02)/i,t.x=(e.m01+e.m04)/i,t.y=.25*i,t.z=(e.m06+e.m09)/i):(i=2*Math.sqrt(1+e.m10-e.m00-e.m05),t.w=(e.m01-e.m04)/i,t.x=(e.m08+e.m02)/i,t.y=(e.m06+e.m09)/i,t.z=.25*i),t},e.toRTS=function(t,e,n,i){i.x=oi.set(wi,t.m00,t.m01,t.m02).length(),Pi.m00=t.m00/i.x,Pi.m01=t.m01/i.x,Pi.m02=t.m02/i.x,i.y=oi.set(wi,t.m04,t.m05,t.m06).length(),Pi.m03=t.m04/i.y,Pi.m04=t.m05/i.y,Pi.m05=t.m06/i.y,i.z=oi.set(wi,t.m08,t.m09,t.m10).length(),Pi.m06=t.m08/i.z,Pi.m07=t.m09/i.z,Pi.m08=t.m10/i.z,di.determinant(Pi)<0&&(i.x*=-1,Pi.m00*=-1,Pi.m01*=-1,Pi.m02*=-1),gi.fromMat3(e,Pi),oi.set(n,t.m12,t.m13,t.m14)},e.fromRTS=function(t,e,n,i){var r=e.x,o=e.y,a=e.z,s=e.w,c=r+r,l=o+o,u=a+a,h=r*c,_=r*l,f=r*u,p=o*l,d=o*u,m=a*u,v=s*c,g=s*l,y=s*u,x=i.x,S=i.y,A=i.z;return t.m00=(1-(p+m))*x,t.m01=(_+y)*x,t.m02=(f-g)*x,t.m03=0,t.m04=(_-y)*S,t.m05=(1-(h+m))*S,t.m06=(d+v)*S,t.m07=0,t.m08=(f+g)*A,t.m09=(d-v)*A,t.m10=(1-(h+p))*A,t.m11=0,t.m12=n.x,t.m13=n.y,t.m14=n.z,t.m15=1,t},e.fromRTSOrigin=function(t,e,n,i,r){var o=e.x,a=e.y,s=e.z,c=e.w,l=o+o,u=a+a,h=s+s,_=o*l,f=o*u,p=o*h,d=a*u,m=a*h,v=s*h,g=c*l,y=c*u,x=c*h,S=i.x,A=i.y,C=i.z,b=r.x,T=r.y,E=r.z;return t.m00=(1-(d+v))*S,t.m01=(f+x)*S,t.m02=(p-y)*S,t.m03=0,t.m04=(f-x)*A,t.m05=(1-(_+v))*A,t.m06=(m+g)*A,t.m07=0,t.m08=(p+y)*C,t.m09=(m-g)*C,t.m10=(1-(_+d))*C,t.m11=0,t.m12=n.x+b-(t.m00*b+t.m04*T+t.m08*E),t.m13=n.y+T-(t.m01*b+t.m05*T+t.m09*E),t.m14=n.z+E-(t.m02*b+t.m06*T+t.m10*E),t.m15=1,t},e.fromQuat=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,_=r*a,f=r*s,p=r*c,d=o*a,m=o*s,v=o*c;return t.m00=1-h-p,t.m01=u+v,t.m02=_-m,t.m03=0,t.m04=u-v,t.m05=1-l-p,t.m06=f+d,t.m07=0,t.m08=_+m,t.m09=f-d,t.m10=1-l-h,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.frustum=function(t,e,n,i,r,o,a){var s=1/(n-e),c=1/(r-i),l=1/(o-a);return t.m00=2*o*s,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=2*o*c,t.m06=0,t.m07=0,t.m08=(n+e)*s,t.m09=(r+i)*c,t.m10=(a+o)*l,t.m11=-1,t.m12=0,t.m13=0,t.m14=a*o*2*l,t.m15=0,t},e.perspective=function(t,e,n,i,r,o,a,s,c){void 0===o&&(o=!0),void 0===a&&(a=-1),void 0===s&&(s=1),void 0===c&&(c=0);var l=1/Math.tan(e/2),u=1/(i-r),h=o?l/n:l,_=(o?l:l*n)*s,f=Ti[c];return t.m00=h*f[0],t.m01=h*f[1],t.m02=0,t.m03=0,t.m04=_*f[2],t.m05=_*f[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=(r-a*i)*u,t.m11=-1,t.m12=0,t.m13=0,t.m14=r*i*u*(1-a),t.m15=0,t},e.ortho=function(t,e,n,i,r,o,a,s,c,l){void 0===s&&(s=-1),void 0===c&&(c=1),void 0===l&&(l=0);var u=1/(e-n),h=1/(i-r)*c,_=1/(o-a),f=-2*u,p=-2*h,d=(e+n)*u,m=(r+i)*h,v=Ti[l];return t.m00=f*v[0],t.m01=f*v[1],t.m02=0,t.m03=0,t.m04=p*v[2],t.m05=p*v[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=_*(1-s),t.m11=0,t.m12=d*v[0]+m*v[2],t.m13=d*v[1]+m*v[3],t.m14=(o-s*a)*_,t.m15=1,t},e.lookAt=function(t,e,n,i){var r=e.x,o=e.y,a=e.z,s=i.x,c=i.y,l=i.z,u=r-n.x,h=o-n.y,_=a-n.z,f=1/Math.sqrt(u*u+h*h+_*_),p=c*(_*=f)-l*(h*=f),d=l*(u*=f)-s*_,m=s*h-c*u,v=h*(m*=f=1/Math.sqrt(p*p+d*d+m*m))-_*(d*=f),g=_*(p*=f)-u*m,y=u*d-h*p;return t.m00=p,t.m01=v,t.m02=u,t.m03=0,t.m04=d,t.m05=g,t.m06=h,t.m07=0,t.m08=m,t.m09=y,t.m10=_,t.m11=0,t.m12=-(p*r+d*o+m*a),t.m13=-(v*r+g*o+y*a),t.m14=-(u*r+h*o+_*a),t.m15=1,t},e.inverseTranspose=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=e.m09,_=e.m10,f=e.m11,p=e.m12,d=e.m13,m=e.m14,v=e.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,A=i*l-o*s,C=r*l-o*c,b=u*d-h*p,T=u*m-_*p,E=u*v-f*p,w=h*m-_*d,P=h*v-f*d,I=_*v-f*m,R=g*I-y*P+x*w+S*E-A*T+C*b;return R?(R=1/R,t.m00=(s*I-c*P+l*w)*R,t.m01=(c*E-a*I-l*T)*R,t.m02=(a*P-s*E+l*b)*R,t.m03=0,t.m04=(r*P-i*I-o*w)*R,t.m05=(n*I-r*E+o*T)*R,t.m06=(i*E-n*P-o*b)*R,t.m07=0,t.m08=(d*C-m*A+v*S)*R,t.m09=(m*x-p*C-v*y)*R,t.m10=(p*A-d*x+v*g)*R,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t):null},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.m00,t[n+1]=e.m01,t[n+2]=e.m02,t[n+3]=e.m03,t[n+4]=e.m04,t[n+5]=e.m05,t[n+6]=e.m06,t[n+7]=e.m07,t[n+8]=e.m08,t[n+9]=e.m09,t[n+10]=e.m10,t[n+11]=e.m11,t[n+12]=e.m12,t[n+13]=e.m13,t[n+14]=e.m14,t[n+15]=e.m15,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.m00=e[n+0],t.m01=e[n+1],t.m02=e[n+2],t.m03=e[n+3],t.m04=e[n+4],t.m05=e[n+5],t.m06=e[n+6],t.m07=e[n+7],t.m08=e[n+8],t.m09=e[n+9],t.m10=e[n+10],t.m11=e[n+11],t.m12=e[n+12],t.m13=e[n+13],t.m14=e[n+14],t.m15=e[n+15],t},e.add=function(t,e,n){return t.m00=e.m00+n.m00,t.m01=e.m01+n.m01,t.m02=e.m02+n.m02,t.m03=e.m03+n.m03,t.m04=e.m04+n.m04,t.m05=e.m05+n.m05,t.m06=e.m06+n.m06,t.m07=e.m07+n.m07,t.m08=e.m08+n.m08,t.m09=e.m09+n.m09,t.m10=e.m10+n.m10,t.m11=e.m11+n.m11,t.m12=e.m12+n.m12,t.m13=e.m13+n.m13,t.m14=e.m14+n.m14,t.m15=e.m15+n.m15,t},e.subtract=function(t,e,n){return t.m00=e.m00-n.m00,t.m01=e.m01-n.m01,t.m02=e.m02-n.m02,t.m03=e.m03-n.m03,t.m04=e.m04-n.m04,t.m05=e.m05-n.m05,t.m06=e.m06-n.m06,t.m07=e.m07-n.m07,t.m08=e.m08-n.m08,t.m09=e.m09-n.m09,t.m10=e.m10-n.m10,t.m11=e.m11-n.m11,t.m12=e.m12-n.m12,t.m13=e.m13-n.m13,t.m14=e.m14-n.m14,t.m15=e.m15-n.m15,t},e.multiplyScalar=function(t,e,n){return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*n,t.m05=e.m05*n,t.m06=e.m06*n,t.m07=e.m07*n,t.m08=e.m08*n,t.m09=e.m09*n,t.m10=e.m10*n,t.m11=e.m11*n,t.m12=e.m12*n,t.m13=e.m13*n,t.m14=e.m14*n,t.m15=e.m15*n,t},e.multiplyScalarAndAdd=function(t,e,n,i){return t.m00=e.m00+n.m00*i,t.m01=e.m01+n.m01*i,t.m02=e.m02+n.m02*i,t.m03=e.m03+n.m03*i,t.m04=e.m04+n.m04*i,t.m05=e.m05+n.m05*i,t.m06=e.m06+n.m06*i,t.m07=e.m07+n.m07*i,t.m08=e.m08+n.m08*i,t.m09=e.m09+n.m09*i,t.m10=e.m10+n.m10*i,t.m11=e.m11+n.m11*i,t.m12=e.m12+n.m12*i,t.m13=e.m13+n.m13*i,t.m14=e.m14+n.m14*i,t.m15=e.m15+n.m15*i,t},e.strictEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08&&t.m09===e.m09&&t.m10===e.m10&&t.m11===e.m11&&t.m12===e.m12&&t.m13===e.m13&&t.m14===e.m14&&t.m15===e.m15},e.equals=function(t,e,n){return void 0===n&&(n=zn),Math.abs(t.m00-e.m00)<=n*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=n*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=n*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=n*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=n*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=n*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=n*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=n*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=n*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))&&Math.abs(t.m09-e.m09)<=n*Math.max(1,Math.abs(t.m09),Math.abs(e.m09))&&Math.abs(t.m10-e.m10)<=n*Math.max(1,Math.abs(t.m10),Math.abs(e.m10))&&Math.abs(t.m11-e.m11)<=n*Math.max(1,Math.abs(t.m11),Math.abs(e.m11))&&Math.abs(t.m12-e.m12)<=n*Math.max(1,Math.abs(t.m12),Math.abs(e.m12))&&Math.abs(t.m13-e.m13)<=n*Math.max(1,Math.abs(t.m13),Math.abs(e.m13))&&Math.abs(t.m14-e.m14)<=n*Math.max(1,Math.abs(t.m14),Math.abs(e.m14))&&Math.abs(t.m15-e.m15)<=n*Math.max(1,Math.abs(t.m15),Math.abs(e.m15))};var n=e.prototype;return n.clone=function(){return new e(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},n.set=function(t,e,n,i,r,o,a,s,c,l,u,h,_,f,p,d){return void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===d&&(d=1),"object"==typeof t?(this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08,this.m09=t.m09,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m13=t.m13,this.m14=t.m14,this.m15=t.m15,this.m00=t.m00):(this.m01=e,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=_,this.m13=f,this.m14=p,this.m15=d,this.m00=t),this},n.equals=function(t,e){return void 0===e&&(e=zn),Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))&&Math.abs(this.m09-t.m09)<=e*Math.max(1,Math.abs(this.m09),Math.abs(t.m09))&&Math.abs(this.m10-t.m10)<=e*Math.max(1,Math.abs(this.m10),Math.abs(t.m10))&&Math.abs(this.m11-t.m11)<=e*Math.max(1,Math.abs(this.m11),Math.abs(t.m11))&&Math.abs(this.m12-t.m12)<=e*Math.max(1,Math.abs(this.m12),Math.abs(t.m12))&&Math.abs(this.m13-t.m13)<=e*Math.max(1,Math.abs(this.m13),Math.abs(t.m13))&&Math.abs(this.m14-t.m14)<=e*Math.max(1,Math.abs(this.m14),Math.abs(t.m14))&&Math.abs(this.m15-t.m15)<=e*Math.max(1,Math.abs(this.m15),Math.abs(t.m15))},n.strictEquals=function(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08&&this.m09===t.m09&&this.m10===t.m10&&this.m11===t.m11&&this.m12===t.m12&&this.m13===t.m13&&this.m14===t.m14&&this.m15===t.m15},n.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},n.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},n.transpose=function(){var t=this.m01,e=this.m02,n=this.m03,i=this.m06,r=this.m07,o=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=t,this.m06=this.m09,this.m07=this.m13,this.m08=e,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=r,this.m14=o,this},n.invert=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,p=this.m14,d=this.m15,m=t*o-e*r,v=t*a-n*r,g=t*s-i*r,y=e*a-n*o,x=e*s-i*o,S=n*s-i*a,A=c*f-l*_,C=c*p-u*_,b=c*d-h*_,T=l*p-u*f,E=l*d-h*f,w=u*d-h*p,P=m*w-v*E+g*T+y*b-x*C+S*A;return 0===P?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(P=1/P,this.m00=(o*w-a*E+s*T)*P,this.m01=(n*E-e*w-i*T)*P,this.m02=(f*S-p*x+d*y)*P,this.m03=(u*x-l*S-h*y)*P,this.m04=(a*b-r*w-s*C)*P,this.m05=(t*w-n*b+i*C)*P,this.m06=(p*g-_*S-d*v)*P,this.m07=(c*S-u*g+h*v)*P,this.m08=(r*E-o*b+s*A)*P,this.m09=(e*b-t*E-i*A)*P,this.m10=(_*x-f*g+d*m)*P,this.m11=(l*g-c*x-h*m)*P,this.m12=(o*C-r*T-a*A)*P,this.m13=(t*T-e*C+n*A)*P,this.m14=(f*v-_*y-p*m)*P,this.m15=(c*y-l*v+u*m)*P,this)},n.determinant=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,p=this.m14,d=this.m15;return(t*o-e*r)*(u*d-h*p)-(t*a-n*r)*(l*d-h*f)+(t*s-i*r)*(l*p-u*f)+(e*a-n*o)*(c*d-h*_)-(e*s-i*o)*(c*p-u*_)+(n*s-i*a)*(c*f-l*_)},n.add=function(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this.m09+=t.m09,this.m10+=t.m10,this.m11+=t.m11,this.m12+=t.m12,this.m13+=t.m13,this.m14+=t.m14,this.m15+=t.m15,this},n.subtract=function(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this.m09-=t.m09,this.m10-=t.m10,this.m11-=t.m11,this.m12-=t.m12,this.m13-=t.m13,this.m14-=t.m14,this.m15-=t.m15,this},n.multiply=function(t){var e=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,_=this.m11,f=this.m12,p=this.m13,d=this.m14,m=this.m15,v=t.m00,g=t.m01,y=t.m02,x=t.m03;return this.m00=v*e+g*o+y*l+x*f,this.m01=v*n+g*a+y*u+x*p,this.m02=v*i+g*s+y*h+x*d,this.m03=v*r+g*c+y*_+x*m,v=t.m04,g=t.m05,y=t.m06,x=t.m07,this.m04=v*e+g*o+y*l+x*f,this.m05=v*n+g*a+y*u+x*p,this.m06=v*i+g*s+y*h+x*d,this.m07=v*r+g*c+y*_+x*m,v=t.m08,g=t.m09,y=t.m10,x=t.m11,this.m08=v*e+g*o+y*l+x*f,this.m09=v*n+g*a+y*u+x*p,this.m10=v*i+g*s+y*h+x*d,this.m11=v*r+g*c+y*_+x*m,v=t.m12,g=t.m13,y=t.m14,x=t.m15,this.m12=v*e+g*o+y*l+x*f,this.m13=v*n+g*a+y*u+x*p,this.m14=v*i+g*s+y*h+x*d,this.m15=v*r+g*c+y*_+x*m,this},n.multiplyScalar=function(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this.m09*=t,this.m10*=t,this.m11*=t,this.m12*=t,this.m13*=t,this.m14*=t,this.m15*=t,this},n.translate=function(t){return console.warn("function changed"),this.m12+=t.x,this.m13+=t.y,this.m14+=t.z,this},n.scale=function(t){var e=t.x,n=t.y,i=t.z;return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this},n.rotate=function(t,e){var n=e.x,i=e.y,r=e.z,o=Math.sqrt(n*n+i*i+r*r);if(Math.abs(o)<zn)return null;n*=o=1/o,i*=o,r*=o;var a=Math.sin(t),s=Math.cos(t),c=1-s,l=this.m00,u=this.m01,h=this.m02,_=this.m03,f=this.m04,p=this.m05,d=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,x=this.m11,S=n*n*c+s,A=i*n*c+r*a,C=r*n*c-i*a,b=n*i*c-r*a,T=i*i*c+s,E=r*i*c+n*a,w=n*r*c+i*a,P=i*r*c-n*a,I=r*r*c+s;return this.m00=l*S+f*A+v*C,this.m01=u*S+p*A+g*C,this.m02=h*S+d*A+y*C,this.m03=_*S+m*A+x*C,this.m04=l*b+f*T+v*E,this.m05=u*b+p*T+g*E,this.m06=h*b+d*T+y*E,this.m07=_*b+m*T+x*E,this.m08=l*w+f*P+v*I,this.m09=u*w+p*P+g*I,this.m10=h*w+d*P+y*I,this.m11=_*w+m*P+x*I,this},n.getTranslation=function(t){return t.x=this.m12,t.y=this.m13,t.z=this.m14,t},n.getScale=function(t){var e=Pi.m00=this.m00,n=Pi.m01=this.m01,i=Pi.m02=this.m02,r=Pi.m03=this.m04,o=Pi.m04=this.m05,a=Pi.m05=this.m06,s=Pi.m06=this.m08,c=Pi.m07=this.m09,l=Pi.m08=this.m10;return t.x=Math.sqrt(e*e+n*n+i*i),t.y=Math.sqrt(r*r+o*o+a*a),t.z=Math.sqrt(s*s+c*c+l*l),di.determinant(Pi)<0&&(t.x*=-1),t},n.getRotation=function(t){var e=this.m00+this.m05+this.m10,n=0;return e>0?(n=2*Math.sqrt(e+1),t.w=.25*n,t.x=(this.m06-this.m09)/n,t.y=(this.m08-this.m02)/n,t.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),t.w=(this.m06-this.m09)/n,t.x=.25*n,t.y=(this.m01+this.m04)/n,t.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),t.w=(this.m08-this.m02)/n,t.x=(this.m01+this.m04)/n,t.y=.25*n,t.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),t.w=(this.m01-this.m04)/n,t.x=(this.m08+this.m02)/n,t.y=(this.m06+this.m09)/n,t.z=.25*n),t},n.fromRTS=function(t,e,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,_=i*l,f=r*c,p=r*l,d=o*l,m=a*s,v=a*c,g=a*l,y=n.x,x=n.y,S=n.z;return this.m00=(1-(f+d))*y,this.m01=(h+g)*y,this.m02=(_-v)*y,this.m03=0,this.m04=(h-g)*x,this.m05=(1-(u+d))*x,this.m06=(p+m)*x,this.m07=0,this.m08=(_+v)*S,this.m09=(p-m)*S,this.m10=(1-(u+f))*S,this.m11=0,this.m12=e.x,this.m13=e.y,this.m14=e.z,this.m15=1,this},n.fromQuat=function(t){var e=t.x,n=t.y,i=t.z,r=t.w,o=e+e,a=n+n,s=i+i,c=e*o,l=n*o,u=n*a,h=i*o,_=i*a,f=i*s,p=r*o,d=r*a,m=r*s;return this.m00=1-u-f,this.m01=l+m,this.m02=h-d,this.m03=0,this.m04=l-m,this.m05=1-c-f,this.m06=_+p,this.m07=0,this.m08=h+d,this.m09=_-p,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},e}(te));Ei.IDENTITY=Object.freeze(new Ei);var wi=new oi,Pi=new di;function Ii(t,e,n,i,r,o,a,s,c,l,u,h,_,f,p,d){return new Ei(t,e,n,i,r,o,a,s,c,l,u,h,_,f,p,d)}He.fastDefine("cc.Mat4",Ei,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),i.Mat4=Ei,i.mat4=Ii;var Ri=t("AffineTransform",function(){function t(t,e,n,i,r,o){void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),this.a=t,this.b=e,this.c=n,this.d=i,this.tx=r,this.ty=o}return t.identity=function(){return new t},t.clone=function(e){return new t(e.a,e.b,e.c,e.d,e.tx,e.ty)},t.concat=function(t,e,n){var i=e.a,r=e.b,o=e.c,a=e.d,s=e.tx,c=e.ty;t.a=i*n.a+r*n.c,t.b=i*n.b+r*n.d,t.c=o*n.a+a*n.c,t.d=o*n.b+a*n.d,t.tx=s*n.a+c*n.c+n.tx,t.ty=s*n.b+c*n.d+n.ty},t.invert=function(t,e){var n=1/(e.a*e.d-e.b*e.c);t.a=n*e.d,t.b=-n*e.b,t.c=-n*e.c,t.d=n*e.a,t.tx=n*(e.c*e.ty-e.d*e.tx),t.ty=n*(e.b*e.tx-e.a*e.ty)},t.fromMat4=function(t,e){t.a=e.m00,t.b=e.m01,t.c=e.m04,t.d=e.m05,t.tx=e.m12,t.ty=e.m13},t.transformVec2=function(t,e,n,i){var r,o;void 0===i?(i=n,r=e.x,o=e.y):(r=e,o=n),t.x=i.a*r+i.c*o+i.tx,t.y=i.b*r+i.d*o+i.ty},t.transformSize=function(t,e,n){t.width=n.a*e.width+n.c*e.height,t.height=n.b*e.width+n.d*e.height},t.transformRect=function(t,e,n){var i=e.x+e.width,r=e.y+e.height,o=n.a*e.x+n.c*e.y+n.tx,a=n.b*e.x+n.d*e.y+n.ty,s=n.a*i+n.c*e.y+n.tx,c=n.b*i+n.d*e.y+n.ty,l=n.a*e.x+n.c*r+n.tx,u=n.b*e.x+n.d*r+n.ty,h=n.a*i+n.c*r+n.tx,_=n.b*i+n.d*r+n.ty,f=Math.min(o,s,l,h),p=Math.max(o,s,l,h),d=Math.min(a,c,u,_),m=Math.max(a,c,u,_);t.x=f,t.y=d,t.width=p-f,t.height=m-d},t.transformObb=function(t,e,n,i,r,o){var a=o.a*r.x+o.c*r.y+o.tx,s=o.b*r.x+o.d*r.y+o.ty,c=o.a*r.width,l=o.b*r.width,u=o.c*r.height,h=o.d*r.height;e.x=a,e.y=s,n.x=c+a,n.y=l+s,t.x=u+a,t.y=h+s,i.x=c+u+a,i.y=l+h+s},t}());i.AffineTransform=Ri;var Di=t("Size",function(t){function e(e,n){var i;return i=t.call(this)||this,e&&"object"==typeof e?(i.width=e.width,i.height=e.height):(i.width=e||0,i.height=n||0),i}F(e,t),e.lerp=function(t,e,n,i){return t.width=e.width+(n.width-e.width)*i,t.height=e.height+(n.height-e.height)*i,t};var n=e.prototype;return n.clone=function(){return new e(this.width,this.height)},n.set=function(t,e){return t&&"object"==typeof t?(this.height=t.height,this.width=t.width):(this.width=t||0,this.height=e||0),this},n.equals=function(t){return this.width===t.width&&this.height===t.height},n.lerp=function(t,e){return this.width+=(t.width-this.width)*e,this.height+=(t.height-this.height)*e,this},n.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},N(e,[{key:"x",get:function(){return this.width},set:function(t){this.width=t}},{key:"y",get:function(){return this.height},set:function(t){this.height=t}}]),e}(te));function Bi(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),new Di(t,e)}Di.ZERO=Object.freeze(new Di(0,0)),Di.ONE=Object.freeze(new Di(1,1)),He.fastDefine("cc.Size",Di,{width:0,height:0}),i.size=Bi,i.Size=Di;var Mi=t("Rect",function(t){function e(e,n,i,r){var o;return o=t.call(this)||this,e&&"object"==typeof e?(o.y=e.y,o.width=e.width,o.height=e.height,o.x=e.x):(o.x=e||0,o.y=n||0,o.width=i||0,o.height=r||0),o}F(e,t),e.fromMinMax=function(t,e,n){var i=Math.min(e.x,n.x),r=Math.min(e.y,n.y),o=Math.max(e.x,n.x),a=Math.max(e.y,n.y);return t.x=i,t.y=r,t.width=o-i,t.height=a-r,t},e.lerp=function(t,e,n,i){var r=e.x,o=e.y,a=e.width,s=e.height;return t.x=r+(n.x-r)*i,t.y=o+(n.y-o)*i,t.width=a+(n.width-a)*i,t.height=s+(n.height-s)*i,t},e.intersection=function(t,e,n){var i=e.x,r=e.y,o=e.x+e.width,a=e.y+e.height,s=n.x,c=n.y,l=n.x+n.width,u=n.y+n.height;return t.x=Math.max(i,s),t.y=Math.max(r,c),t.width=Math.min(o,l)-t.x,t.height=Math.min(a,u)-t.y,t},e.union=function(t,e,n){var i=e.x,r=e.y,o=e.width,a=e.height,s=n.x,c=n.y,l=n.width,u=n.height;return t.x=Math.min(i,s),t.y=Math.min(r,c),t.width=Math.max(i+o,s+l)-t.x,t.height=Math.max(r+a,c+u)-t.y,t};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.width,this.height)},n.set=function(t,e,n,i){return t&&"object"==typeof t?(this.y=t.y,this.width=t.width,this.height=t.height,this.x=t.x):(this.x=t||0,this.y=e||0,this.width=n||0,this.height=i||0),this},n.equals=function(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height},n.lerp=function(t,e){var n=this.x,i=this.y,r=this.width,o=this.height;return this.x=n+(t.x-n)*e,this.y=i+(t.y-i)*e,this.width=r+(t.width-r)*e,this.height=o+(t.height-o)*e,this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},n.intersects=function(t){var e=this.x+this.width,n=this.y+this.height,i=t.x+t.width,r=t.y+t.height;return!(e<t.x||i<this.x||n<t.y||r<this.y)},n.contains=function(t){return this.x<=t.x&&this.x+this.width>=t.x&&this.y<=t.y&&this.y+this.height>=t.y},n.containsRect=function(t){return this.x<=t.x&&this.x+this.width>=t.x+t.width&&this.y<=t.y&&this.y+this.height>=t.y+t.height},n.transformMat4=function(t){var e=this.x,n=this.y,i=e+this.width,r=n+this.height,o=t.m00*e+t.m04*n+t.m12,a=t.m01*e+t.m05*n+t.m13,s=t.m00*i+t.m04*n+t.m12,c=t.m01*i+t.m05*n+t.m13,l=t.m00*e+t.m04*r+t.m12,u=t.m01*e+t.m05*r+t.m13,h=t.m00*i+t.m04*r+t.m12,_=t.m01*i+t.m05*r+t.m13,f=Math.min(o,s,l,h),p=Math.max(o,s,l,h),d=Math.min(a,c,u,_),m=Math.max(a,c,u,_);return this.x=f,this.y=d,this.width=p-f,this.height=m-d,this},n.transformMat4ToPoints=function(t,e,n,i,r){var o=this.x,a=this.y,s=o+this.width,c=a+this.height;e.x=t.m00*o+t.m04*a+t.m12,e.y=t.m01*o+t.m05*a+t.m13,r.x=t.m00*s+t.m04*a+t.m12,r.y=t.m01*s+t.m05*a+t.m13,n.x=t.m00*o+t.m04*c+t.m12,n.y=t.m01*o+t.m05*c+t.m13,i.x=t.m00*s+t.m04*c+t.m12,i.y=t.m01*s+t.m05*c+t.m13},N(e,[{key:"xMin",get:function(){return this.x},set:function(t){this.width+=this.x-t,this.x=t}},{key:"yMin",get:function(){return this.y},set:function(t){this.height+=this.y-t,this.y=t}},{key:"xMax",get:function(){return this.x+this.width},set:function(t){this.width=t-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(t){this.height=t-this.y}},{key:"center",get:function(){return new li(this.x+.5*this.width,this.y+.5*this.height)},set:function(t){this.x=t.x-.5*this.width,this.y=t.y-.5*this.height}},{key:"origin",get:function(){return new li(this.x,this.y)},set:function(t){this.x=t.x,this.y=t.y}},{key:"size",get:function(){return new Di(this.width,this.height)},set:function(t){this.width=t.width,this.height=t.height}},{key:"z",get:function(){return this.width},set:function(t){this.width=t}},{key:"w",get:function(){return this.height},set:function(t){this.height=t}}]),e}(te));function Oi(t,e,n,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),new Mi(t,e,n,i)}He.fastDefine("cc.Rect",Mi,{x:0,y:0,width:0,height:0}),i.Rect=Mi,i.rect=Oi;var Ni=1/255,Li=t("Color",function(t){function e(e,n,i,r){var o;return(o=t.call(this)||this)._val=0,"string"==typeof e?o.fromHEX(e):void 0!==n?o.set(e,n,i,r):o.set(e),o}F(e,t),e.clone=function(t){var n=new e;return t._val?n._val=t._val:n._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,n},e.copy=function(t,e){return t.r=e.r,t.g=e.g,t.b=e.b,t.a=e.a,t},e.set=function(t,e,n,i,r){return t.r=e,t.g=n,t.b=i,t.a=r,t},e.fromHEX=function(t,e){e=0===e.indexOf("#")?e.substring(1):e,t.r=parseInt(e.substr(0,2),16)||0,t.g=parseInt(e.substr(2,2),16)||0,t.b=parseInt(e.substr(4,2),16)||0;var n=parseInt(e.substr(6,2),16);return t.a=Number.isNaN(n)?255:n,t._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,t},e.add=function(t,e,n){return t.r=e.r+n.r,t.g=e.g+n.g,t.b=e.b+n.b,t.a=e.a+n.a,t},e.subtract=function(t,e,n){return t.r=e.r-n.r,t.g=e.g-n.g,t.b=e.b-n.b,t.a=e.a-n.a,t},e.multiply=function(t,e,n){return t.r=e.r*n.r,t.g=e.g*n.g,t.b=e.b*n.b,t.a=e.a*n.a,t},e.divide=function(t,e,n){return t.r=e.r/n.r,t.g=e.g/n.g,t.b=e.b/n.b,t.a=e.a/n.a,t},e.scale=function(t,e,n){return t.r=e.r*n,t.g=e.g*n,t.b=e.b*n,t.a=e.a*n,t},e.lerp=function(t,e,n,i){var r=e.r,o=e.g,a=e.b,s=e.a;return r+=(n.r-r)*i,o+=(n.g-o)*i,a+=(n.b-a)*i,s+=(n.a-s)*i,t._val=Math.floor((s<<24>>>0)+(a<<16)+(o<<8)+r),t},e.toArray=function(t,n,i){void 0===i&&(i=0);var r=n instanceof e||n.a>1?1/255:1;return t[i+0]=n.r*r,t[i+1]=n.g*r,t[i+2]=n.b*r,t[i+3]=n.a*r,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),e.r=255*t[n+0],e.g=255*t[n+1],e.b=255*t[n+2],e.a=255*t[n+3],e},e.strictEquals=function(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a},e.equals=function(t,e,n){return void 0===n&&(n=zn),Math.abs(t.r-e.r)<=n*Math.max(1,Math.abs(t.r),Math.abs(e.r))&&Math.abs(t.g-e.g)<=n*Math.max(1,Math.abs(t.g),Math.abs(e.g))&&Math.abs(t.b-e.b)<=n*Math.max(1,Math.abs(t.b),Math.abs(e.b))&&Math.abs(t.a-e.a)<=n*Math.max(1,Math.abs(t.a),Math.abs(e.a))},e.hex=function(t){return(255*t.r<<24|255*t.g<<16|255*t.b<<8|255*t.a)>>>0};var n=e.prototype;return n.clone=function(){var t=new e;return t._val=this._val,t},n.equals=function(t){return t&&this._val===t._val},n.lerp=function(t,e){var n=this.r,i=this.g,r=this.b,o=this.a;return n+=(t.r-n)*e,i+=(t.g-i)*e,r+=(t.b-r)*e,o+=(t.a-o)*e,this._val=Math.floor((o<<24>>>0)+(r<<16)+(i<<8)+n),this},n.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},n.toCSS=function(t){return void 0===t&&(t="rgba"),"rgba"===t?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*Ni).toFixed(2)+")":"rgb"===t?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(t)},n.fromHEX=function(t){t=0===t.indexOf("#")?t.substring(1):t;var e=parseInt(t.substr(0,2),16)||0,n=parseInt(t.substr(2,2),16)||0,i=parseInt(t.substr(4,2),16)||0,r=parseInt(t.substr(6,2),16);return r=Number.isNaN(r)?255:r,this._val=(r<<24>>>0)+(i<<16)+(n<<8)+(0|e),this},n.toHEX=function(t){void 0===t&&(t="#rrggbb");var e="0",n=[(this.r<16?e:"")+this.r.toString(16),(this.g<16?e:"")+this.g.toString(16),(this.b<16?e:"")+this.b.toString(16)];return"#rgb"===t?(n[0]=n[0][0],n[1]=n[1][0],n[2]=n[2][0]):"#rrggbbaa"===t&&n.push((this.a<16?e:"")+this.a.toString(16)),n.join("")},n.toRGBValue=function(){return 16777215&this._val},n.fromHSV=function(t,e,n){var i=0,r=0,o=0;if(0===e)i=r=o=n;else if(0===n)i=r=o=0;else{1===t&&(t=0),t*=6;var a=Math.floor(t),s=t-a,c=n*(1-e),l=n*(1-e*s),u=n*(1-e*(1-s));switch(a){case 0:i=n,r=u,o=c;break;case 1:i=l,r=n,o=c;break;case 2:i=c,r=n,o=u;break;case 3:i=c,r=l,o=n;break;case 4:i=u,r=c,o=n;break;case 5:i=n,r=c,o=l}}return i*=255,r*=255,o*=255,this._val=(this.a<<24>>>0)+(o<<16)+(r<<8)+(0|i),this},n.toHSV=function(){var t=this.r*Ni,e=this.g*Ni,n=this.b*Ni,i={h:0,s:0,v:0},r=Math.max(t,e,n),o=Math.min(t,e,n),a=0;return i.v=r,i.s=r?(r-o)/r:0,i.s?(a=r-o,i.h=t===r?(e-n)/a:e===r?2+(n-t)/a:4+(t-e)/a,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i},n.set=function(t,e,n,i){return"object"==typeof t?null!=t._val?this._val=t._val:(e=t.g||0,n=t.b||0,i="number"==typeof t.a?t.a:255,t=t.r||0,this._val=(i<<24>>>0)+(n<<16)+(e<<8)+(0|t)):(t=t||0,e=e||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(e<<8)+(0|t)),this},n.multiply=function(t){var e=(255&this._val)*t.r>>8,n=(65280&this._val)*t.g>>8,i=(16711680&this._val)*t.b>>8,r=((4278190080&this._val)>>>8)*t.a;return this._val=4278190080&r|16711680&i|65280&n|255&e,this},n._set_r_unsafe=function(t){return this._val=(4294967040&this._val|t)>>>0,this},n._set_g_unsafe=function(t){return this._val=(4294902015&this._val|t<<8)>>>0,this},n._set_b_unsafe=function(t){return this._val=(4278255615&this._val|t<<16)>>>0,this},n._set_a_unsafe=function(t){return this._val=(16777215&this._val|t<<24)>>>0,this},N(e,[{key:"r",get:function(){return 255&this._val},set:function(t){t=~~Un(t,0,255),this._val=(4294967040&this._val|t)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(t){t=~~Un(t,0,255),this._val=(4294902015&this._val|t<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(t){t=~~Un(t,0,255),this._val=(4278255615&this._val|t<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(t){t=~~Un(t,0,255),this._val=(16777215&this._val|t<<24)>>>0}},{key:"x",get:function(){return this.r*Ni},set:function(t){this.r=255*t}},{key:"y",get:function(){return this.g*Ni},set:function(t){this.g=255*t}},{key:"z",get:function(){return this.b*Ni},set:function(t){this.b=255*t}},{key:"w",get:function(){return this.a*Ni},set:function(t){this.a=255*t}}]),e}(te));function Fi(t,e,n,i){return new Li(t,e,n,i)}Li.WHITE=Object.freeze(new Li(255,255,255,255)),Li.GRAY=Object.freeze(new Li(127,127,127,255)),Li.BLACK=Object.freeze(new Li(0,0,0,255)),Li.TRANSPARENT=Object.freeze(new Li(0,0,0,0)),Li.RED=Object.freeze(new Li(255,0,0,255)),Li.GREEN=Object.freeze(new Li(0,255,0,255)),Li.BLUE=Object.freeze(new Li(0,0,255,255)),Li.CYAN=Object.freeze(new Li(0,255,255,255)),Li.MAGENTA=Object.freeze(new Li(255,0,255,255)),Li.YELLOW=Object.freeze(new Li(255,255,0,255)),He.fastDefine("cc.Color",Li,{r:0,g:0,b:0,a:255}),i.Color=Li,i.color=Fi;var zi=t("MATH_FLOAT_ARRAY",Float64Array),Vi=t("MathBase",function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e.createFloatArray=function(t){return new zi(t)},N(e,[{key:"array",get:function(){return this._array}}]),e}(te)),Gi=Object.freeze({__proto__:null,bits:Nn,Vec2:li,v2:_i,Vec3:oi,v3:ci,Vec4:fi,v4:pi,Quat:gi,quat:bi,Mat3:di,Mat4:Ei,mat4:Ii,AffineTransform:Ri,Size:Di,size:Bi,Rect:Mi,rect:Oi,Color:Li,color:Fi,EPSILON:zn,equals:Vn,approx:Gn,clamp:Un,clamp01:kn,lerp:Hn,toRadian:jn,toDegree:Wn,random:qn,randomRange:Xn,randomRangeInt:Yn,pseudoRandom:Kn,pseudoRandomRange:Jn,pseudoRandomRangeInt:Qn,nextPow2:Zn,repeat:$n,pingPong:ti,inverseLerp:ei,absMaxComponent:ni,absMax:ii,enumerableProps:ri,MATH_FLOAT_ARRAY:zi,MathBase:Vi});t("math",Gi);var Ui=function(){function t(){this._groundAlbedoHDR=new fi(.2,.2,.2,1),this._skyColorHDR=new fi(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new fi(.2,.2,.2,1),this._skyColorLDR=new fi(.2,.5,.8,1),this._skyIllumLDR=0,this._mipmapCount=1,this._enabled=!1}var e=t.prototype;return e.initialize=function(t){this._skyColorHDR=t.skyColorHDR,this._groundAlbedoHDR.set(t.groundAlbedoHDR),this._skyIllumHDR=t.skyIllumHDR,this._skyColorLDR=t.skyColorLDR,this._groundAlbedoLDR.set(t.groundAlbedoLDR),this._skyIllumLDR=t.skyIllumLDR},e._destroy=function(){},e.destroy=function(){this._destroy()},N(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"skyColor",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(t):this._skyColorLDR.set(t)}},{key:"skyIllum",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=t:this._skyIllumLDR=t}},{key:"groundAlbedo",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(t):this._groundAlbedoLDR.set(t)}},{key:"mipmapCount",get:function(){return this._mipmapCount},set:function(t){this._mipmapCount=t}},{key:"native",get:function(){return this._nativeObj}}]),t}();Ui.SUN_ILLUM=65e3,Ui.SKY_ILLUM=2e4,i.Ambient=Ui;var ki=function(){function t(){this._enabled=!1,this._minPos=new oi(0,0,0),this._maxPos=new oi(0,0,0),this._depth=0}var e=t.prototype;return e.initialize=function(t){this._enabled=t.enabled,this._minPos=t.minPos,this._maxPos=t.maxPos,this._depth=t.depth},e._destroy=function(){},e.destroy=function(){this._destroy()},N(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"minPos",get:function(){return this._minPos},set:function(t){this._minPos=t}},{key:"maxPos",get:function(){return this._maxPos},set:function(t){this._maxPos=t}},{key:"depth",get:function(){return this._depth},set:function(t){this._depth=t}},{key:"native",get:function(){return this._nativeObj}}]),t}(),Hi=new oi,ji=new oi,Wi=new oi,qi=new oi,Xi=new oi,Yi=new oi,Ki=new Array(3),Ji=new Array(3);function Qi(t,e){return oi.dot(e.n,t)-e.d}function Zi(t,e,n){return oi.copy(t,e),oi.subtract(Xi,n.center,n.halfExtents),oi.add(Yi,n.center,n.halfExtents),t.x=t.x<Xi.x?Xi.x:t.x,t.y=t.y<Xi.y?Xi.y:t.y,t.z=t.z<Xi.z?Xi.z:t.z,t.x=t.x>Yi.x?Yi.x:t.x,t.y=t.y>Yi.y?Yi.y:t.y,t.z=t.z>Yi.z?Yi.z:t.z,t}function $i(t,e,n){oi.set(Hi,n.orientation.m00,n.orientation.m01,n.orientation.m02),oi.set(ji,n.orientation.m03,n.orientation.m04,n.orientation.m05),oi.set(Wi,n.orientation.m06,n.orientation.m07,n.orientation.m08),Ki[0]=Hi,Ki[1]=ji,Ki[2]=Wi,Ji[0]=n.halfExtents.x,Ji[1]=n.halfExtents.y,Ji[2]=n.halfExtents.z,oi.subtract(qi,e,n.center),oi.set(t,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var r=oi.dot(qi,Ki[i]);r>Ji[i]&&(r=Ji[i]),r<-Ji[i]&&(r=-Ji[i]),t.x+=r*Ki[i].x,t.y+=r*Ki[i].y,t.z+=r*Ki[i].z}return t}var tr=Object.freeze({__proto__:null,point_plane:Qi,pt_point_plane:function(t,e,n){var i=Qi(e,n);return oi.subtract(t,e,oi.multiplyScalar(t,n.n,i))},pt_point_aabb:Zi,pt_point_obb:$i,pt_point_line:function(t,e,n,i){oi.subtract(Hi,n,i);var r=Hi,o=oi.lengthSqr(r);if(0==o)oi.copy(t,n);else{oi.subtract(Hi,e,n);var a=oi.dot(Hi,r)/o;a<0?oi.copy(t,n):a>1?oi.copy(t,i):oi.scaleAndAdd(t,n,r,a)}}}),er={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},nr=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=er.SHAPE_RAY,this.o=new oi(t,e,n),this.d=new oi(i,r,o)}return t.create=function(e,n,i,r,o,a){return void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),new t(e,n,i,r,o,a)},t.clone=function(e){return new t(e.o.x,e.o.y,e.o.z,e.d.x,e.d.y,e.d.z)},t.copy=function(t,e){return oi.copy(t.o,e.o),oi.copy(t.d,e.d),t},t.fromPoints=function(t,e,n){return oi.copy(t.o,e),oi.normalize(t.d,oi.subtract(t.d,n,e)),t},t.set=function(t,e,n,i,r,o,a){return t.o.x=e,t.o.y=n,t.o.z=i,t.d.x=r,t.d.y=o,t.d.z=a,t},t.prototype.computeHit=function(t,e){oi.normalize(t,this.d),oi.scaleAndAdd(t,this.o,t,e)},N(t,[{key:"type",get:function(){return this._type}}]),t}(),ir=new oi,rr=new oi,or=new oi,ar=new oi;function sr(t){return Math.max(Math.max(t.x,t.y),t.z)}var cr,lr,ur,hr,_r,fr,pr,dr,mr,vr,gr,yr,xr,Sr,Ar,Cr,br,Tr,Er,wr,Pr,Ir,Rr,Dr,Br,Mr,Or,Nr,Lr,Fr,zr,Vr,Gr,Ur,kr,Hr,jr,Wr,qr,Xr,Yr,Kr=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),this._center=new oi(0,0,0),this._radius=0,this._type=void 0,this._type=er.SHAPE_SPHERE,this._center=new oi(t,e,n),this._radius=i}t.create=function(e,n,i,r){return new t(e,n,i,r)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.radius)},t.copy=function(t,e){return oi.copy(t.center,e.center),t.radius=e.radius,t},t.fromPoints=function(t,e,n){return oi.multiplyScalar(t.center,oi.add(ir,e,n),.5),t.radius=.5*oi.subtract(ir,n,e).length(),t},t.set=function(t,e,n,i,r){return t.center.x=e,t.center.y=n,t.center.z=i,t.radius=r,t};var e=t.prototype;return e.destroy=function(){},e.clone=function(){return t.clone(this)},e.copy=function(e){return t.copy(this,e)},e.getBoundary=function(t,e){oi.set(t,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),oi.set(e,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},e.transform=function(t,e,n,i,r){oi.transformMat4(r.center,this.center,t),r.radius=this.radius*sr(i)},e.translateAndRotate=function(t,e,n){oi.transformMat4(n.center,this.center,t)},e.setScale=function(t,e){e.radius=this.radius*sr(t)},e.mergePoint=function(t){this.radius<0&&(this.center.set(t),this.radius=0),oi.subtract(rr,t,this.center);var e=rr.length();if(e>this.radius){var n=.5*(e-this.radius);this.radius+=n,oi.multiplyScalar(rr,rr,n/e),oi.add(this.center,this.center,rr)}},e.mergePoints=function(t){var e=t.length;if(!(e<1)){this.radius=-1;for(var n=0;n<e;n++)this.mergePoint(t[n])}},e.mergeAABB=function(t){t.getBoundary(or,ar),this.mergePoint(or),this.mergePoint(ar)},N(t,[{key:"center",get:function(){return this._center},set:function(t){this._center=t}},{key:"radius",get:function(){return this._radius},set:function(t){this._radius=t}},{key:"type",get:function(){return this._type}}]),t}(),Jr=function(){function t(t,e,n,i,r,o,a,s,c){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=1),void 0===c&&(c=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=er.SHAPE_TRIANGLE,this.a=new oi(t,e,n),this.b=new oi(i,r,o),this.c=new oi(a,s,c)}return t.create=function(e,n,i,r,o,a,s,c,l){return void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),new t(e,n,i,r,o,a,s,c,l)},t.clone=function(e){return new t(e.a.x,e.a.y,e.a.z,e.b.x,e.b.y,e.b.z,e.c.x,e.c.y,e.c.z)},t.copy=function(t,e){return oi.copy(t.a,e.a),oi.copy(t.b,e.b),oi.copy(t.c,e.c),t},t.fromPoints=function(t,e,n,i){return oi.copy(t.a,e),oi.copy(t.b,n),oi.copy(t.c,i),t},t.set=function(t,e,n,i,r,o,a,s,c,l){return t.a.x=e,t.a.y=n,t.a.z=i,t.b.x=r,t.b.y=o,t.b.z=a,t.c.x=s,t.c.y=c,t.c.z=l,t},N(t,[{key:"type",get:function(){return this._type}}]),t}(),Qr=function(t,e,n){for(var i=0;i<e.length;++i)t.length<=i&&t.push(new n),t[i].copy(e[i]);t.length=e.length};!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.SWAPCHAIN=1]="SWAPCHAIN",t[t.BUFFER=2]="BUFFER",t[t.TEXTURE=3]="TEXTURE",t[t.RENDER_PASS=4]="RENDER_PASS",t[t.FRAMEBUFFER=5]="FRAMEBUFFER",t[t.SAMPLER=6]="SAMPLER",t[t.SHADER=7]="SHADER",t[t.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",t[t.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",t[t.PIPELINE_STATE=10]="PIPELINE_STATE",t[t.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",t[t.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",t[t.COMMAND_BUFFER=13]="COMMAND_BUFFER",t[t.QUEUE=14]="QUEUE",t[t.QUERY_POOL=15]="QUERY_POOL",t[t.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",t[t.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",t[t.BUFFER_BARRIER=18]="BUFFER_BARRIER",t[t.COUNT=19]="COUNT"}(cr||(cr={})),function(t){t[t.UNREADY=0]="UNREADY",t[t.FAILED=1]="FAILED",t[t.SUCCESS=2]="SUCCESS"}(lr||(lr={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.GLES2=1]="GLES2",t[t.GLES3=2]="GLES3",t[t.METAL=3]="METAL",t[t.VULKAN=4]="VULKAN",t[t.WEBGL=5]="WEBGL",t[t.WEBGL2=6]="WEBGL2",t[t.WEBGPU=7]="WEBGPU"}(ur||(ur={})),function(t){t[t.IDENTITY=0]="IDENTITY",t[t.ROTATE_90=1]="ROTATE_90",t[t.ROTATE_180=2]="ROTATE_180",t[t.ROTATE_270=3]="ROTATE_270"}(hr||(hr={})),function(t){t[t.COLOR_FLOAT=0]="COLOR_FLOAT",t[t.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",t[t.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",t[t.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",t[t.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",t[t.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",t[t.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",t[t.FORMAT_SRGB=7]="FORMAT_SRGB",t[t.FORMAT_ETC1=8]="FORMAT_ETC1",t[t.FORMAT_ETC2=9]="FORMAT_ETC2",t[t.FORMAT_DXT=10]="FORMAT_DXT",t[t.FORMAT_PVRTC=11]="FORMAT_PVRTC",t[t.FORMAT_ASTC=12]="FORMAT_ASTC",t[t.FORMAT_RGB8=13]="FORMAT_RGB8",t[t.ELEMENT_INDEX_UINT=14]="ELEMENT_INDEX_UINT",t[t.INSTANCED_ARRAYS=15]="INSTANCED_ARRAYS",t[t.MULTIPLE_RENDER_TARGETS=16]="MULTIPLE_RENDER_TARGETS",t[t.BLEND_MINMAX=17]="BLEND_MINMAX",t[t.COMPUTE_SHADER=18]="COMPUTE_SHADER",t[t.INPUT_ATTACHMENT_BENEFIT=19]="INPUT_ATTACHMENT_BENEFIT",t[t.COUNT=20]="COUNT"}(_r||(_r={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.A8=1]="A8",t[t.L8=2]="L8",t[t.LA8=3]="LA8",t[t.R8=4]="R8",t[t.R8SN=5]="R8SN",t[t.R8UI=6]="R8UI",t[t.R8I=7]="R8I",t[t.R16F=8]="R16F",t[t.R16UI=9]="R16UI",t[t.R16I=10]="R16I",t[t.R32F=11]="R32F",t[t.R32UI=12]="R32UI",t[t.R32I=13]="R32I",t[t.RG8=14]="RG8",t[t.RG8SN=15]="RG8SN",t[t.RG8UI=16]="RG8UI",t[t.RG8I=17]="RG8I",t[t.RG16F=18]="RG16F",t[t.RG16UI=19]="RG16UI",t[t.RG16I=20]="RG16I",t[t.RG32F=21]="RG32F",t[t.RG32UI=22]="RG32UI",t[t.RG32I=23]="RG32I",t[t.RGB8=24]="RGB8",t[t.SRGB8=25]="SRGB8",t[t.RGB8SN=26]="RGB8SN",t[t.RGB8UI=27]="RGB8UI",t[t.RGB8I=28]="RGB8I",t[t.RGB16F=29]="RGB16F",t[t.RGB16UI=30]="RGB16UI",t[t.RGB16I=31]="RGB16I",t[t.RGB32F=32]="RGB32F",t[t.RGB32UI=33]="RGB32UI",t[t.RGB32I=34]="RGB32I",t[t.RGBA8=35]="RGBA8",t[t.BGRA8=36]="BGRA8",t[t.SRGB8_A8=37]="SRGB8_A8",t[t.RGBA8SN=38]="RGBA8SN",t[t.RGBA8UI=39]="RGBA8UI",t[t.RGBA8I=40]="RGBA8I",t[t.RGBA16F=41]="RGBA16F",t[t.RGBA16UI=42]="RGBA16UI",t[t.RGBA16I=43]="RGBA16I",t[t.RGBA32F=44]="RGBA32F",t[t.RGBA32UI=45]="RGBA32UI",t[t.RGBA32I=46]="RGBA32I",t[t.R5G6B5=47]="R5G6B5",t[t.R11G11B10F=48]="R11G11B10F",t[t.RGB5A1=49]="RGB5A1",t[t.RGBA4=50]="RGBA4",t[t.RGB10A2=51]="RGB10A2",t[t.RGB10A2UI=52]="RGB10A2UI",t[t.RGB9E5=53]="RGB9E5",t[t.DEPTH=54]="DEPTH",t[t.DEPTH_STENCIL=55]="DEPTH_STENCIL",t[t.BC1=56]="BC1",t[t.BC1_ALPHA=57]="BC1_ALPHA",t[t.BC1_SRGB=58]="BC1_SRGB",t[t.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",t[t.BC2=60]="BC2",t[t.BC2_SRGB=61]="BC2_SRGB",t[t.BC3=62]="BC3",t[t.BC3_SRGB=63]="BC3_SRGB",t[t.BC4=64]="BC4",t[t.BC4_SNORM=65]="BC4_SNORM",t[t.BC5=66]="BC5",t[t.BC5_SNORM=67]="BC5_SNORM",t[t.BC6H_UF16=68]="BC6H_UF16",t[t.BC6H_SF16=69]="BC6H_SF16",t[t.BC7=70]="BC7",t[t.BC7_SRGB=71]="BC7_SRGB",t[t.ETC_RGB8=72]="ETC_RGB8",t[t.ETC2_RGB8=73]="ETC2_RGB8",t[t.ETC2_SRGB8=74]="ETC2_SRGB8",t[t.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",t[t.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",t[t.ETC2_RGBA8=77]="ETC2_RGBA8",t[t.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",t[t.EAC_R11=79]="EAC_R11",t[t.EAC_R11SN=80]="EAC_R11SN",t[t.EAC_RG11=81]="EAC_RG11",t[t.EAC_RG11SN=82]="EAC_RG11SN",t[t.PVRTC_RGB2=83]="PVRTC_RGB2",t[t.PVRTC_RGBA2=84]="PVRTC_RGBA2",t[t.PVRTC_RGB4=85]="PVRTC_RGB4",t[t.PVRTC_RGBA4=86]="PVRTC_RGBA4",t[t.PVRTC2_2BPP=87]="PVRTC2_2BPP",t[t.PVRTC2_4BPP=88]="PVRTC2_4BPP",t[t.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",t[t.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",t[t.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",t[t.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",t[t.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",t[t.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",t[t.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",t[t.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",t[t.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",t[t.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",t[t.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",t[t.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",t[t.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",t[t.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",t[t.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",t[t.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",t[t.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",t[t.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",t[t.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",t[t.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",t[t.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",t[t.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",t[t.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",t[t.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",t[t.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",t[t.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",t[t.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",t[t.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",t[t.COUNT=117]="COUNT"}(fr||(fr={})),function(t){t[t.NONE=0]="NONE",t[t.UNORM=1]="UNORM",t[t.SNORM=2]="SNORM",t[t.UINT=3]="UINT",t[t.INT=4]="INT",t[t.UFLOAT=5]="UFLOAT",t[t.FLOAT=6]="FLOAT"}(pr||(pr={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.BOOL=1]="BOOL",t[t.BOOL2=2]="BOOL2",t[t.BOOL3=3]="BOOL3",t[t.BOOL4=4]="BOOL4",t[t.INT=5]="INT",t[t.INT2=6]="INT2",t[t.INT3=7]="INT3",t[t.INT4=8]="INT4",t[t.UINT=9]="UINT",t[t.UINT2=10]="UINT2",t[t.UINT3=11]="UINT3",t[t.UINT4=12]="UINT4",t[t.FLOAT=13]="FLOAT",t[t.FLOAT2=14]="FLOAT2",t[t.FLOAT3=15]="FLOAT3",t[t.FLOAT4=16]="FLOAT4",t[t.MAT2=17]="MAT2",t[t.MAT2X3=18]="MAT2X3",t[t.MAT2X4=19]="MAT2X4",t[t.MAT3X2=20]="MAT3X2",t[t.MAT3=21]="MAT3",t[t.MAT3X4=22]="MAT3X4",t[t.MAT4X2=23]="MAT4X2",t[t.MAT4X3=24]="MAT4X3",t[t.MAT4=25]="MAT4",t[t.SAMPLER1D=26]="SAMPLER1D",t[t.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",t[t.SAMPLER2D=28]="SAMPLER2D",t[t.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",t[t.SAMPLER3D=30]="SAMPLER3D",t[t.SAMPLER_CUBE=31]="SAMPLER_CUBE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE1D=33]="TEXTURE1D",t[t.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",t[t.TEXTURE2D=35]="TEXTURE2D",t[t.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",t[t.TEXTURE3D=37]="TEXTURE3D",t[t.TEXTURE_CUBE=38]="TEXTURE_CUBE",t[t.IMAGE1D=39]="IMAGE1D",t[t.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",t[t.IMAGE2D=41]="IMAGE2D",t[t.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",t[t.IMAGE3D=43]="IMAGE3D",t[t.IMAGE_CUBE=44]="IMAGE_CUBE",t[t.SUBPASS_INPUT=45]="SUBPASS_INPUT",t[t.COUNT=46]="COUNT"}(dr||(dr={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.INDEX=4]="INDEX",t[t.VERTEX=8]="VERTEX",t[t.UNIFORM=16]="UNIFORM",t[t.STORAGE=32]="STORAGE",t[t.INDIRECT=64]="INDIRECT"}(mr||(mr={})),function(t){t[t.NONE=0]="NONE"}(vr||(vr={})),function(t){t[t.NONE=0]="NONE",t[t.READ_ONLY=1]="READ_ONLY",t[t.WRITE_ONLY=2]="WRITE_ONLY",t[t.READ_WRITE=3]="READ_WRITE"}(gr||(gr={})),function(t){t[t.NONE=0]="NONE",t[t.DEVICE=1]="DEVICE",t[t.HOST=2]="HOST"}(yr||(yr={})),function(t){t[t.TEX1D=0]="TEX1D",t[t.TEX2D=1]="TEX2D",t[t.TEX3D=2]="TEX3D",t[t.CUBE=3]="CUBE",t[t.TEX1D_ARRAY=4]="TEX1D_ARRAY",t[t.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(xr||(xr={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.SAMPLED=4]="SAMPLED",t[t.STORAGE=8]="STORAGE",t[t.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",t[t.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",t[t.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(Sr||(Sr={})),function(t){t[t.NONE=0]="NONE",t[t.GEN_MIPMAP=1]="GEN_MIPMAP",t[t.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(Ar||(Ar={})),function(t){t[t.ONE=0]="ONE",t[t.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",t[t.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",t[t.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(Cr||(Cr={})),function(t){t[t.OFF=0]="OFF",t[t.ON=1]="ON",t[t.RELAXED=2]="RELAXED",t[t.MAILBOX=3]="MAILBOX",t[t.HALF=4]="HALF"}(br||(br={})),function(t){t[t.NONE=0]="NONE",t[t.POINT=1]="POINT",t[t.LINEAR=2]="LINEAR",t[t.ANISOTROPIC=3]="ANISOTROPIC"}(Tr||(Tr={})),function(t){t[t.WRAP=0]="WRAP",t[t.MIRROR=1]="MIRROR",t[t.CLAMP=2]="CLAMP",t[t.BORDER=3]="BORDER"}(Er||(Er={})),function(t){t[t.NEVER=0]="NEVER",t[t.LESS=1]="LESS",t[t.EQUAL=2]="EQUAL",t[t.LESS_EQUAL=3]="LESS_EQUAL",t[t.GREATER=4]="GREATER",t[t.NOT_EQUAL=5]="NOT_EQUAL",t[t.GREATER_EQUAL=6]="GREATER_EQUAL",t[t.ALWAYS=7]="ALWAYS"}(wr||(wr={})),function(t){t[t.ZERO=0]="ZERO",t[t.KEEP=1]="KEEP",t[t.REPLACE=2]="REPLACE",t[t.INCR=3]="INCR",t[t.DECR=4]="DECR",t[t.INVERT=5]="INVERT",t[t.INCR_WRAP=6]="INCR_WRAP",t[t.DECR_WRAP=7]="DECR_WRAP"}(Pr||(Pr={})),function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_ALPHA=2]="SRC_ALPHA",t[t.DST_ALPHA=3]="DST_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",t[t.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",t[t.SRC_COLOR=6]="SRC_COLOR",t[t.DST_COLOR=7]="DST_COLOR",t[t.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",t[t.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",t[t.CONSTANT_COLOR=11]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Ir||(Ir={})),function(t){t[t.ADD=0]="ADD",t[t.SUB=1]="SUB",t[t.REV_SUB=2]="REV_SUB",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(Rr||(Rr={})),function(t){t[t.NONE=0]="NONE",t[t.R=1]="R",t[t.G=2]="G",t[t.B=4]="B",t[t.A=8]="A",t[t.ALL=15]="ALL"}(Dr||(Dr={})),function(t){t[t.NONE=0]="NONE",t[t.VERTEX=1]="VERTEX",t[t.CONTROL=2]="CONTROL",t[t.EVALUATION=4]="EVALUATION",t[t.GEOMETRY=8]="GEOMETRY",t[t.FRAGMENT=16]="FRAGMENT",t[t.COMPUTE=32]="COMPUTE",t[t.ALL=63]="ALL"}(Br||(Br={})),function(t){t[t.LOAD=0]="LOAD",t[t.CLEAR=1]="CLEAR",t[t.DISCARD=2]="DISCARD"}(Mr||(Mr={})),function(t){t[t.STORE=0]="STORE",t[t.DISCARD=1]="DISCARD"}(Or||(Or={})),function(t){t[t.NONE=0]="NONE",t[t.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",t[t.INDEX_BUFFER=2]="INDEX_BUFFER",t[t.VERTEX_BUFFER=3]="VERTEX_BUFFER",t[t.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",t[t.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",t[t.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",t[t.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",t[t.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",t[t.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",t[t.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",t[t.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",t[t.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",t[t.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",t[t.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",t[t.TRANSFER_READ=17]="TRANSFER_READ",t[t.HOST_READ=18]="HOST_READ",t[t.PRESENT=19]="PRESENT",t[t.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",t[t.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",t[t.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",t[t.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",t[t.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",t[t.TRANSFER_WRITE=25]="TRANSFER_WRITE",t[t.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",t[t.HOST_WRITE=27]="HOST_WRITE"}(Nr||(Nr={})),function(t){t[t.NONE=0]="NONE",t[t.SAMPLE_ZERO=1]="SAMPLE_ZERO",t[t.AVERAGE=2]="AVERAGE",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(Lr||(Lr={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.RAY_TRACING=2]="RAY_TRACING"}(Fr||(Fr={})),function(t){t[t.POINT_LIST=0]="POINT_LIST",t[t.LINE_LIST=1]="LINE_LIST",t[t.LINE_STRIP=2]="LINE_STRIP",t[t.LINE_LOOP=3]="LINE_LOOP",t[t.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",t[t.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",t[t.ISO_LINE_LIST=6]="ISO_LINE_LIST",t[t.TRIANGLE_LIST=7]="TRIANGLE_LIST",t[t.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=9]="TRIANGLE_FAN",t[t.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",t[t.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",t[t.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",t[t.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(zr||(zr={})),function(t){t[t.FILL=0]="FILL",t[t.POINT=1]="POINT",t[t.LINE=2]="LINE"}(Vr||(Vr={})),function(t){t[t.GOURAND=0]="GOURAND",t[t.FLAT=1]="FLAT"}(Gr||(Gr={})),function(t){t[t.NONE=0]="NONE",t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK"}(Ur||(Ur={})),function(t){t[t.NONE=0]="NONE",t[t.LINE_WIDTH=1]="LINE_WIDTH",t[t.DEPTH_BIAS=2]="DEPTH_BIAS",t[t.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",t[t.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",t[t.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",t[t.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}(kr||(kr={})),function(t){t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK",t[t.ALL=3]="ALL"}(Hr||(Hr={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",t[t.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",t[t.STORAGE_BUFFER=4]="STORAGE_BUFFER",t[t.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",t[t.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE=64]="TEXTURE",t[t.STORAGE_IMAGE=128]="STORAGE_IMAGE",t[t.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(jr||(jr={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.TRANSFER=2]="TRANSFER"}(Wr||(Wr={})),function(t){t[t.OCCLUSION=0]="OCCLUSION",t[t.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",t[t.TIMESTAMP=2]="TIMESTAMP"}(qr||(qr={})),function(t){t[t.PRIMARY=0]="PRIMARY",t[t.SECONDARY=1]="SECONDARY"}(Xr||(Xr={})),function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.DEPTH=2]="DEPTH",t[t.STENCIL=4]="STENCIL",t[t.DEPTH_STENCIL=6]="DEPTH_STENCIL",t[t.ALL=7]="ALL"}(Yr||(Yr={}));var Zr,$r=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=n}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t}(),to=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m,v,g,y,x,S){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=1),void 0===p&&(p=0),void 0===d&&(d=0),void 0===m&&(m=new $r),void 0===v&&(v=new $r),void 0===g&&(g=!1),void 0===y&&(y=-1),void 0===x&&(x=1),void 0===S&&(S=1),this.maxVertexAttributes=t,this.maxVertexUniformVectors=e,this.maxFragmentUniformVectors=n,this.maxTextureUnits=i,this.maxImageUnits=r,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=a,this.maxShaderStorageBufferBindings=s,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=u,this.maxTextureSize=h,this.maxCubeMapTextureSize=_,this.uboOffsetAlignment=f,this.maxComputeSharedMemorySize=p,this.maxComputeWorkGroupInvocations=d,this.maxComputeWorkGroupSize=m,this.maxComputeWorkGroupCount=v,this.supportQuery=g,this.clipSpaceMinZ=y,this.screenSpaceSignY=x,this.clipSpaceSignY=S}return t.prototype.copy=function(t){return this.maxVertexAttributes=t.maxVertexAttributes,this.maxVertexUniformVectors=t.maxVertexUniformVectors,this.maxFragmentUniformVectors=t.maxFragmentUniformVectors,this.maxTextureUnits=t.maxTextureUnits,this.maxImageUnits=t.maxImageUnits,this.maxVertexTextureUnits=t.maxVertexTextureUnits,this.maxColorRenderTargets=t.maxColorRenderTargets,this.maxShaderStorageBufferBindings=t.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=t.maxShaderStorageBlockSize,this.maxUniformBufferBindings=t.maxUniformBufferBindings,this.maxUniformBlockSize=t.maxUniformBlockSize,this.maxTextureSize=t.maxTextureSize,this.maxCubeMapTextureSize=t.maxCubeMapTextureSize,this.uboOffsetAlignment=t.uboOffsetAlignment,this.maxComputeSharedMemorySize=t.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=t.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(t.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(t.maxComputeWorkGroupCount),this.supportQuery=t.supportQuery,this.clipSpaceMinZ=t.clipSpaceMinZ,this.screenSpaceSignY=t.screenSpaceSignY,this.clipSpaceSignY=t.clipSpaceSignY,this},t}(),eo=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=n}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t}(),no=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=t,this.y=e,this.width=n,this.height=i}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this},t}(),io=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=1),this.width=t,this.height=e,this.depth=n}return t.prototype.copy=function(t){return this.width=t.width,this.height=t.height,this.depth=t.depth,this},t}(),ro=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=1),this.mipLevel=t,this.baseArrayLayer=e,this.layerCount=n}return t.prototype.copy=function(t){return this.mipLevel=t.mipLevel,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this},t}(),oo=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=1),this.baseMipLevel=t,this.levelCount=e,this.baseArrayLayer=n,this.layerCount=i}return t.prototype.copy=function(t){return this.baseMipLevel=t.baseMipLevel,this.levelCount=t.levelCount,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this},t}(),ao=function(){function t(t,e,n,i,r){void 0===t&&(t=new ro),void 0===e&&(e=new eo),void 0===n&&(n=new ro),void 0===i&&(i=new eo),void 0===r&&(r=new io),this.srcSubres=t,this.srcOffset=e,this.dstSubres=n,this.dstOffset=i,this.extent=r}return t.prototype.copy=function(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.extent.copy(t.extent),this},t}(),so=function(){function t(t,e,n,i,r,o){void 0===t&&(t=new ro),void 0===e&&(e=new eo),void 0===n&&(n=new io),void 0===i&&(i=new ro),void 0===r&&(r=new eo),void 0===o&&(o=new io),this.srcSubres=t,this.srcOffset=e,this.srcExtent=n,this.dstSubres=i,this.dstOffset=r,this.dstExtent=o}return t.prototype.copy=function(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.srcExtent.copy(t.srcExtent),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.dstExtent.copy(t.dstExtent),this},t}(),co=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=new eo),void 0===i&&(i=new io),void 0===r&&(r=new ro),this.buffStride=t,this.buffTexHeight=e,this.texOffset=n,this.texExtent=i,this.texSubres=r}return t.prototype.copy=function(t){return this.buffStride=t.buffStride,this.buffTexHeight=t.buffTexHeight,this.texOffset.copy(t.texOffset),this.texExtent.copy(t.texExtent),this.texSubres.copy(t.texSubres),this},t}(),lo=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),this.left=t,this.top=e,this.width=n,this.height=i,this.minDepth=r,this.maxDepth=o}return t.prototype.copy=function(t){return this.left=t.left,this.top=t.top,this.width=t.width,this.height=t.height,this.minDepth=t.minDepth,this.maxDepth=t.maxDepth,this},t}(),uo=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=n,this.w=i}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},t}(),ho=function(){function t(t,e,n){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=0),this.bufferOffsets=t,this.samplerOffsets=e,this.flexibleSet=n}return t.prototype.copy=function(t){return this.bufferOffsets=t.bufferOffsets.slice(),this.samplerOffsets=t.samplerOffsets.slice(),this.flexibleSet=t.flexibleSet,this},t}(),_o=function(){function t(t,e,n,i){void 0===t&&(t=null),void 0===e&&(e=br.ON),void 0===n&&(n=0),void 0===i&&(i=0),this.windowHandle=t,this.vsyncMode=e,this.width=n,this.height=i}return t.prototype.copy=function(t){return this.windowHandle=t.windowHandle,this.vsyncMode=t.vsyncMode,this.width=t.width,this.height=t.height,this},t}(),fo=function(){function t(t){void 0===t&&(t=new ho),this.bindingMappingInfo=t}return t.prototype.copy=function(t){return this.bindingMappingInfo.copy(t.bindingMappingInfo),this},t}(),po=function(){function t(t,e,n,i,r){void 0===t&&(t=mr.NONE),void 0===e&&(e=yr.NONE),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=vr.NONE),this.usage=t,this.memUsage=e,this.size=n,this.stride=i,this.flags=r}return t.prototype.copy=function(t){return this.usage=t.usage,this.memUsage=t.memUsage,this.size=t.size,this.stride=t.stride,this.flags=t.flags,this},t}(),mo=function(){function t(t,e,n){void 0===t&&(t=null),void 0===e&&(e=0),void 0===n&&(n=0),this.buffer=t,this.offset=e,this.range=n}return t.prototype.copy=function(t){return this.buffer=t.buffer,this.offset=t.offset,this.range=t.range,this},t}(),vo=function(){function t(t,e,n,i,r,o,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),this.vertexCount=t,this.firstVertex=e,this.indexCount=n,this.firstIndex=i,this.vertexOffset=r,this.instanceCount=o,this.firstInstance=a}return t.prototype.copy=function(t){return this.vertexCount=t.vertexCount,this.firstVertex=t.firstVertex,this.indexCount=t.indexCount,this.firstIndex=t.firstIndex,this.vertexOffset=t.vertexOffset,this.instanceCount=t.instanceCount,this.firstInstance=t.firstInstance,this},t}(),go=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=null),void 0===r&&(r=0),this.groupCountX=t,this.groupCountY=e,this.groupCountZ=n,this.indirectBuffer=i,this.indirectOffset=r}return t.prototype.copy=function(t){return this.groupCountX=t.groupCountX,this.groupCountY=t.groupCountY,this.groupCountZ=t.groupCountZ,this.indirectBuffer=t.indirectBuffer,this.indirectOffset=t.indirectOffset,this},t}(),yo=function(){function t(t){void 0===t&&(t=[]),this.drawInfos=t}return t.prototype.copy=function(t){return Qr(this.drawInfos,t.drawInfos,vo),this},t}(),xo=function(){function t(t,e,n,i,r,o,a,s,c,l,u){void 0===t&&(t=xr.TEX2D),void 0===e&&(e=Sr.NONE),void 0===n&&(n=fr.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=Ar.NONE),void 0===a&&(a=1),void 0===s&&(s=1),void 0===c&&(c=Cr.ONE),void 0===l&&(l=1),void 0===u&&(u=0),this.type=t,this.usage=e,this.format=n,this.width=i,this.height=r,this.flags=o,this.layerCount=a,this.levelCount=s,this.samples=c,this.depth=l,this.externalRes=u}return t.prototype.copy=function(t){return this.type=t.type,this.usage=t.usage,this.format=t.format,this.width=t.width,this.height=t.height,this.flags=t.flags,this.layerCount=t.layerCount,this.levelCount=t.levelCount,this.samples=t.samples,this.depth=t.depth,this.externalRes=t.externalRes,this},t}(),So=function(){function t(t,e,n,i,r,o,a){void 0===t&&(t=null),void 0===e&&(e=xr.TEX2D),void 0===n&&(n=fr.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=1),this.texture=t,this.type=e,this.format=n,this.baseLevel=i,this.levelCount=r,this.baseLayer=o,this.layerCount=a}return t.prototype.copy=function(t){return this.texture=t.texture,this.type=t.type,this.format=t.format,this.baseLevel=t.baseLevel,this.levelCount=t.levelCount,this.baseLayer=t.baseLayer,this.layerCount=t.layerCount,this},t}(),Ao=function(){function t(t,e,n,i,r,o,a,s){void 0===t&&(t=Tr.LINEAR),void 0===e&&(e=Tr.LINEAR),void 0===n&&(n=Tr.NONE),void 0===i&&(i=Er.WRAP),void 0===r&&(r=Er.WRAP),void 0===o&&(o=Er.WRAP),void 0===a&&(a=0),void 0===s&&(s=wr.ALWAYS),this.minFilter=t,this.magFilter=e,this.mipFilter=n,this.addressU=i,this.addressV=r,this.addressW=o,this.maxAnisotropy=a,this.cmpFunc=s}return t.prototype.copy=function(t){return this.minFilter=t.minFilter,this.magFilter=t.magFilter,this.mipFilter=t.mipFilter,this.addressU=t.addressU,this.addressV=t.addressV,this.addressW=t.addressW,this.maxAnisotropy=t.maxAnisotropy,this.cmpFunc=t.cmpFunc,this},t}(),Co=function(){function t(t,e,n){void 0===t&&(t=""),void 0===e&&(e=dr.UNKNOWN),void 0===n&&(n=0),this.name=t,this.type=e,this.count=n}return t.prototype.copy=function(t){return this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),bo=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=[]),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=n,this.members=i,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,Qr(this.members,t.members,Co),this.count=t.count,this},t}(),To=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=dr.UNKNOWN),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=n,this.type=i,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),Eo=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=t,this.binding=e,this.name=n,this.count=i}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this},t}(),wo=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=dr.UNKNOWN),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=n,this.type=i,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),Po=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=dr.UNKNOWN),void 0===r&&(r=0),void 0===o&&(o=gr.READ_WRITE),this.set=t,this.binding=e,this.name=n,this.type=i,this.count=r,this.memoryAccess=o}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this.memoryAccess=t.memoryAccess,this},t}(),Io=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=0),void 0===r&&(r=gr.READ_WRITE),this.set=t,this.binding=e,this.name=n,this.count=i,this.memoryAccess=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this.memoryAccess=t.memoryAccess,this},t}(),Ro=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=t,this.binding=e,this.name=n,this.count=i}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this},t}(),Do=function(){function t(t,e){void 0===t&&(t=Br.NONE),void 0===e&&(e=""),this.stage=t,this.source=e}return t.prototype.copy=function(t){return this.stage=t.stage,this.source=t.source,this},t}(),Bo=function(){function t(t,e,n,i,r,o){void 0===t&&(t=""),void 0===e&&(e=fr.UNKNOWN),void 0===n&&(n=!1),void 0===i&&(i=0),void 0===r&&(r=!1),void 0===o&&(o=0),this.name=t,this.format=e,this.isNormalized=n,this.stream=i,this.isInstanced=r,this.location=o}return t.prototype.copy=function(t){return this.name=t.name,this.format=t.format,this.isNormalized=t.isNormalized,this.stream=t.stream,this.isInstanced=t.isInstanced,this.location=t.location,this},t}(),Mo=function(){function t(t,e,n,i,r,o,a,s,c,l){void 0===t&&(t=""),void 0===e&&(e=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=[]),void 0===o&&(o=[]),void 0===a&&(a=[]),void 0===s&&(s=[]),void 0===c&&(c=[]),void 0===l&&(l=[]),this.name=t,this.stages=e,this.attributes=n,this.blocks=i,this.buffers=r,this.samplerTextures=o,this.samplers=a,this.textures=s,this.images=c,this.subpassInputs=l}return t.prototype.copy=function(t){return this.name=t.name,Qr(this.stages,t.stages,Do),Qr(this.attributes,t.attributes,Bo),Qr(this.blocks,t.blocks,bo),Qr(this.buffers,t.buffers,Io),Qr(this.samplerTextures,t.samplerTextures,To),Qr(this.samplers,t.samplers,Eo),Qr(this.textures,t.textures,wo),Qr(this.images,t.images,Po),Qr(this.subpassInputs,t.subpassInputs,Ro),this},t}(),Oo=function(){function t(t,e,n,i){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=null),void 0===i&&(i=null),this.attributes=t,this.vertexBuffers=e,this.indexBuffer=n,this.indirectBuffer=i}return t.prototype.copy=function(t){return Qr(this.attributes,t.attributes,Bo),this.vertexBuffers=t.vertexBuffers.slice(),this.indexBuffer=t.indexBuffer,this.indirectBuffer=t.indirectBuffer,this},t}(),No=function(){function t(t,e,n,i,r,o,a){void 0===t&&(t=fr.UNKNOWN),void 0===e&&(e=Cr.ONE),void 0===n&&(n=Mr.CLEAR),void 0===i&&(i=Or.STORE),void 0===r&&(r=[]),void 0===o&&(o=[Nr.COLOR_ATTACHMENT_WRITE]),void 0===a&&(a=!1),this.format=t,this.sampleCount=e,this.loadOp=n,this.storeOp=i,this.beginAccesses=r,this.endAccesses=o,this.isGeneralLayout=a}return t.prototype.copy=function(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.loadOp=t.loadOp,this.storeOp=t.storeOp,this.beginAccesses=t.beginAccesses.slice(),this.endAccesses=t.endAccesses.slice(),this.isGeneralLayout=t.isGeneralLayout,this},t}(),Lo=function(){function t(t,e,n,i,r,o,a,s,c){void 0===t&&(t=fr.UNKNOWN),void 0===e&&(e=Cr.ONE),void 0===n&&(n=Mr.CLEAR),void 0===i&&(i=Or.STORE),void 0===r&&(r=Mr.CLEAR),void 0===o&&(o=Or.STORE),void 0===a&&(a=[]),void 0===s&&(s=[Nr.DEPTH_STENCIL_ATTACHMENT_WRITE]),void 0===c&&(c=!1),this.format=t,this.sampleCount=e,this.depthLoadOp=n,this.depthStoreOp=i,this.stencilLoadOp=r,this.stencilStoreOp=o,this.beginAccesses=a,this.endAccesses=s,this.isGeneralLayout=c}return t.prototype.copy=function(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.depthLoadOp=t.depthLoadOp,this.depthStoreOp=t.depthStoreOp,this.stencilLoadOp=t.stencilLoadOp,this.stencilStoreOp=t.stencilStoreOp,this.beginAccesses=t.beginAccesses.slice(),this.endAccesses=t.endAccesses.slice(),this.isGeneralLayout=t.isGeneralLayout,this},t}(),Fo=function(){function t(t,e,n,i,r,o,a,s){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=-1),void 0===o&&(o=-1),void 0===a&&(a=Lr.NONE),void 0===s&&(s=Lr.NONE),this.inputs=t,this.colors=e,this.resolves=n,this.preserves=i,this.depthStencil=r,this.depthStencilResolve=o,this.depthResolveMode=a,this.stencilResolveMode=s}return t.prototype.copy=function(t){return this.inputs=t.inputs.slice(),this.colors=t.colors.slice(),this.resolves=t.resolves.slice(),this.preserves=t.preserves.slice(),this.depthStencil=t.depthStencil,this.depthStencilResolve=t.depthStencilResolve,this.depthResolveMode=t.depthResolveMode,this.stencilResolveMode=t.stencilResolveMode,this},t}(),zo=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=[]),void 0===i&&(i=[]),this.srcSubpass=t,this.dstSubpass=e,this.srcAccesses=n,this.dstAccesses=i}return t.prototype.copy=function(t){return this.srcSubpass=t.srcSubpass,this.dstSubpass=t.dstSubpass,this.srcAccesses=t.srcAccesses.slice(),this.dstAccesses=t.dstAccesses.slice(),this},t}(),Vo=function(){function t(t,e,n,i){void 0===t&&(t=[]),void 0===e&&(e=new Lo),void 0===n&&(n=[]),void 0===i&&(i=[]),this.colorAttachments=t,this.depthStencilAttachment=e,this.subpasses=n,this.dependencies=i}return t.prototype.copy=function(t){return Qr(this.colorAttachments,t.colorAttachments,No),this.depthStencilAttachment.copy(t.depthStencilAttachment),Qr(this.subpasses,t.subpasses,Fo),Qr(this.dependencies,t.dependencies,zo),this},t}(),Go=function(){function t(t,e){void 0===t&&(t=[]),void 0===e&&(e=[]),this.prevAccesses=t,this.nextAccesses=e}return t.prototype.copy=function(t){return this.prevAccesses=t.prevAccesses.slice(),this.nextAccesses=t.nextAccesses.slice(),this},t}(),Uo=function(){function t(t,e,n,i,r){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=!1),void 0===i&&(i=null),void 0===r&&(r=null),this.prevAccesses=t,this.nextAccesses=e,this.discardContents=n,this.srcQueue=i,this.dstQueue=r}return t.prototype.copy=function(t){return this.prevAccesses=t.prevAccesses.slice(),this.nextAccesses=t.nextAccesses.slice(),this.discardContents=t.discardContents,this.srcQueue=t.srcQueue,this.dstQueue=t.dstQueue,this},t}(),ko=function(){function t(t,e,n){void 0===t&&(t=null),void 0===e&&(e=[]),void 0===n&&(n=null),this.renderPass=t,this.colorTextures=e,this.depthStencilTexture=n}return t.prototype.copy=function(t){return this.renderPass=t.renderPass,this.colorTextures=t.colorTextures.slice(),this.depthStencilTexture=t.depthStencilTexture,this},t}(),Ho=function(){function t(t,e,n,i,r){void 0===t&&(t=-1),void 0===e&&(e=jr.UNKNOWN),void 0===n&&(n=0),void 0===i&&(i=Br.NONE),void 0===r&&(r=[]),this.binding=t,this.descriptorType=e,this.count=n,this.stageFlags=i,this.immutableSamplers=r}return t.prototype.copy=function(t){return this.binding=t.binding,this.descriptorType=t.descriptorType,this.count=t.count,this.stageFlags=t.stageFlags,this.immutableSamplers=t.immutableSamplers.slice(),this},t}(),jo=function(){function t(t){void 0===t&&(t=[]),this.bindings=t}return t.prototype.copy=function(t){return Qr(this.bindings,t.bindings,Ho),this},t}(),Wo=function(){function t(t){void 0===t&&(t=null),this.layout=t}return t.prototype.copy=function(t){return this.layout=t.layout,this},t}(),qo=function(){function t(t){void 0===t&&(t=[]),this.setLayouts=t}return t.prototype.copy=function(t){return this.setLayouts=t.setLayouts.slice(),this},t}(),Xo=function(){function t(t){void 0===t&&(t=[]),this.attributes=t}return t.prototype.copy=function(t){return Qr(this.attributes,t.attributes,Bo),this},t}(),Yo=function(){function t(t,e){void 0===t&&(t=null),void 0===e&&(e=Xr.PRIMARY),this.queue=t,this.type=e}return t.prototype.copy=function(t){return this.queue=t.queue,this.type=t.type,this},t}(),Ko=function(){function t(t){void 0===t&&(t=Wr.GRAPHICS),this.type=t}return t.prototype.copy=function(t){return this.type=t.type,this},t}(),Jo=function(){function t(t,e,n){void 0===t&&(t=qr.OCCLUSION),void 0===e&&(e=65536),void 0===n&&(n=!0),this.type=t,this.maxQueryObjects=e,this.forceWait=n}return t.prototype.copy=function(t){return this.type=t.type,this.maxQueryObjects=t.maxQueryObjects,this.forceWait=t.forceWait,this},t}(),Qo=function(t,e,n,i,r,o,a,s){void 0===t&&(t=""),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=pr.NONE),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=!1),void 0===s&&(s=!1),this.name=t,this.size=e,this.count=n,this.type=i,this.hasAlpha=r,this.hasDepth=o,this.hasStencil=a,this.isCompressed=s},Zo=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.bufferSize=t,this.textureSize=e}return t.prototype.copy=function(t){return this.bufferSize=t.bufferSize,this.textureSize=t.textureSize,this},t}(),$o=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.writeMask=t,this.compareMask=e,this.reference=n}return t.prototype.copy=function(t){return this.writeMask=t.writeMask,this.compareMask=t.compareMask,this.reference=t.reference,this},t}(),ta=function(){function t(t,e,n,i,r,o,a,s,c,l,u){void 0===t&&(t=new lo),void 0===e&&(e=new no),void 0===n&&(n=new uo),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=new $o),void 0===u&&(u=new $o),this.viewport=t,this.scissor=e,this.blendConstant=n,this.lineWidth=i,this.depthBiasConstant=r,this.depthBiasClamp=o,this.depthBiasSlope=a,this.depthMinBounds=s,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=u}return t.prototype.copy=function(t){return this.viewport.copy(t.viewport),this.scissor.copy(t.scissor),this.blendConstant.copy(t.blendConstant),this.lineWidth=t.lineWidth,this.depthBiasConstant=t.depthBiasConstant,this.depthBiasClamp=t.depthBiasClamp,this.depthBiasSlope=t.depthBiasSlope,this.depthMinBounds=t.depthMinBounds,this.depthMaxBounds=t.depthMaxBounds,this.stencilStatesFront.copy(t.stencilStatesFront),this.stencilStatesBack.copy(t.stencilStatesBack),this},t}(),ea=function(){function t(e){this._objectType=cr.UNKNOWN,this._objectID=0,this._typedID=0,this._objectType=e,this._objectID=t._idTable[cr.UNKNOWN]++,this._typedID=t._idTable[e]++}return N(t,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),t}();ea._idTable=Array(cr.COUNT).fill(65536),function(t){t.ATTR_POSITION="a_position",t.ATTR_NORMAL="a_normal",t.ATTR_TANGENT="a_tangent",t.ATTR_BITANGENT="a_bitangent",t.ATTR_WEIGHTS="a_weights",t.ATTR_JOINTS="a_joints",t.ATTR_COLOR="a_color",t.ATTR_COLOR1="a_color1",t.ATTR_COLOR2="a_color2",t.ATTR_TEX_COORD="a_texCoord",t.ATTR_TEX_COORD1="a_texCoord1",t.ATTR_TEX_COORD2="a_texCoord2",t.ATTR_TEX_COORD3="a_texCoord3",t.ATTR_TEX_COORD4="a_texCoord4",t.ATTR_TEX_COORD5="a_texCoord5",t.ATTR_TEX_COORD6="a_texCoord6",t.ATTR_TEX_COORD7="a_texCoord7",t.ATTR_TEX_COORD8="a_texCoord8",t.ATTR_BATCH_ID="a_batch_id",t.ATTR_BATCH_UV="a_batch_uv"}(Zr||(Zr={}));var na=Object.freeze([new Qo("UNKNOWN",0,0,pr.NONE,!1,!1,!1,!1),new Qo("A8",1,1,pr.UNORM,!0,!1,!1,!1),new Qo("L8",1,1,pr.UNORM,!1,!1,!1,!1),new Qo("LA8",1,2,pr.UNORM,!0,!1,!1,!1),new Qo("R8",1,1,pr.UNORM,!1,!1,!1,!1),new Qo("R8SN",1,1,pr.SNORM,!1,!1,!1,!1),new Qo("R8UI",1,1,pr.UINT,!1,!1,!1,!1),new Qo("R8I",1,1,pr.INT,!1,!1,!1,!1),new Qo("R16F",2,1,pr.FLOAT,!1,!1,!1,!1),new Qo("R16UI",2,1,pr.UINT,!1,!1,!1,!1),new Qo("R16I",2,1,pr.INT,!1,!1,!1,!1),new Qo("R32F",4,1,pr.FLOAT,!1,!1,!1,!1),new Qo("R32UI",4,1,pr.UINT,!1,!1,!1,!1),new Qo("R32I",4,1,pr.INT,!1,!1,!1,!1),new Qo("RG8",2,2,pr.UNORM,!1,!1,!1,!1),new Qo("RG8SN",2,2,pr.SNORM,!1,!1,!1,!1),new Qo("RG8UI",2,2,pr.UINT,!1,!1,!1,!1),new Qo("RG8I",2,2,pr.INT,!1,!1,!1,!1),new Qo("RG16F",4,2,pr.FLOAT,!1,!1,!1,!1),new Qo("RG16UI",4,2,pr.UINT,!1,!1,!1,!1),new Qo("RG16I",4,2,pr.INT,!1,!1,!1,!1),new Qo("RG32F",8,2,pr.FLOAT,!1,!1,!1,!1),new Qo("RG32UI",8,2,pr.UINT,!1,!1,!1,!1),new Qo("RG32I",8,2,pr.INT,!1,!1,!1,!1),new Qo("RGB8",3,3,pr.UNORM,!1,!1,!1,!1),new Qo("SRGB8",3,3,pr.UNORM,!1,!1,!1,!1),new Qo("RGB8SN",3,3,pr.SNORM,!1,!1,!1,!1),new Qo("RGB8UI",3,3,pr.UINT,!1,!1,!1,!1),new Qo("RGB8I",3,3,pr.INT,!1,!1,!1,!1),new Qo("RGB16F",6,3,pr.FLOAT,!1,!1,!1,!1),new Qo("RGB16UI",6,3,pr.UINT,!1,!1,!1,!1),new Qo("RGB16I",6,3,pr.INT,!1,!1,!1,!1),new Qo("RGB32F",12,3,pr.FLOAT,!1,!1,!1,!1),new Qo("RGB32UI",12,3,pr.UINT,!1,!1,!1,!1),new Qo("RGB32I",12,3,pr.INT,!1,!1,!1,!1),new Qo("RGBA8",4,4,pr.UNORM,!0,!1,!1,!1),new Qo("BGRA8",4,4,pr.UNORM,!0,!1,!1,!1),new Qo("SRGB8_A8",4,4,pr.UNORM,!0,!1,!1,!1),new Qo("RGBA8SN",4,4,pr.SNORM,!0,!1,!1,!1),new Qo("RGBA8UI",4,4,pr.UINT,!0,!1,!1,!1),new Qo("RGBA8I",4,4,pr.INT,!0,!1,!1,!1),new Qo("RGBA16F",8,4,pr.FLOAT,!0,!1,!1,!1),new Qo("RGBA16UI",8,4,pr.UINT,!0,!1,!1,!1),new Qo("RGBA16I",8,4,pr.INT,!0,!1,!1,!1),new Qo("RGBA32F",16,4,pr.FLOAT,!0,!1,!1,!1),new Qo("RGBA32UI",16,4,pr.UINT,!0,!1,!1,!1),new Qo("RGBA32I",16,4,pr.INT,!0,!1,!1,!1),new Qo("R5G6B5",2,3,pr.UNORM,!1,!1,!1,!1),new Qo("R11G11B10F",4,3,pr.FLOAT,!1,!1,!1,!1),new Qo("RGB5A1",2,4,pr.UNORM,!0,!1,!1,!1),new Qo("RGBA4",2,4,pr.UNORM,!0,!1,!1,!1),new Qo("RGB10A2",2,4,pr.UNORM,!0,!1,!1,!1),new Qo("RGB10A2UI",2,4,pr.UINT,!0,!1,!1,!1),new Qo("RGB9E5",2,4,pr.FLOAT,!0,!1,!1,!1),new Qo("DEPTH",4,1,pr.FLOAT,!1,!0,!1,!1),new Qo("DEPTH_STENCIL",5,2,pr.FLOAT,!1,!0,!0,!1),new Qo("BC1",1,3,pr.UNORM,!1,!1,!1,!0),new Qo("BC1_ALPHA",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("BC1_SRGB",1,3,pr.UNORM,!1,!1,!1,!0),new Qo("BC1_SRGB_ALPHA",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("BC2",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("BC2_SRGB",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("BC3",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("BC3_SRGB",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("BC4",1,1,pr.UNORM,!1,!1,!1,!0),new Qo("BC4_SNORM",1,1,pr.SNORM,!1,!1,!1,!0),new Qo("BC5",1,2,pr.UNORM,!1,!1,!1,!0),new Qo("BC5_SNORM",1,2,pr.SNORM,!1,!1,!1,!0),new Qo("BC6H_UF16",1,3,pr.UFLOAT,!1,!1,!1,!0),new Qo("BC6H_SF16",1,3,pr.FLOAT,!1,!1,!1,!0),new Qo("BC7",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("BC7_SRGB",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ETC_RGB8",1,3,pr.UNORM,!1,!1,!1,!0),new Qo("ETC2_RGB8",1,3,pr.UNORM,!1,!1,!1,!0),new Qo("ETC2_SRGB8",1,3,pr.UNORM,!1,!1,!1,!0),new Qo("ETC2_RGB8_A1",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ETC2_SRGB8_A1",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ETC2_RGBA8",2,4,pr.UNORM,!0,!1,!1,!0),new Qo("ETC2_SRGB8_A8",2,4,pr.UNORM,!0,!1,!1,!0),new Qo("EAC_R11",1,1,pr.UNORM,!1,!1,!1,!0),new Qo("EAC_R11SN",1,1,pr.SNORM,!1,!1,!1,!0),new Qo("EAC_RG11",2,2,pr.UNORM,!1,!1,!1,!0),new Qo("EAC_RG11SN",2,2,pr.SNORM,!1,!1,!1,!0),new Qo("PVRTC_RGB2",2,3,pr.UNORM,!1,!1,!1,!0),new Qo("PVRTC_RGBA2",2,4,pr.UNORM,!0,!1,!1,!0),new Qo("PVRTC_RGB4",2,3,pr.UNORM,!1,!1,!1,!0),new Qo("PVRTC_RGBA4",2,4,pr.UNORM,!0,!1,!1,!0),new Qo("PVRTC2_2BPP",2,4,pr.UNORM,!0,!1,!1,!0),new Qo("PVRTC2_4BPP",2,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_RGBA_4x4",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_RGBA_5x4",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_RGBA_5x5",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_RGBA_6x5",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_RGBA_6x6",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_RGBA_8x5",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_RGBA_8x6",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_RGBA_8x8",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_RGBA_10x5",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_RGBA_10x6",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_RGBA_10x8",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_RGBA_10x10",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_RGBA_12x10",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_RGBA_12x12",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_SRGBA_4x4",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_SRGBA_5x4",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_SRGBA_5x5",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_SRGBA_6x5",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_SRGBA_6x6",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_SRGBA_8x5",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_SRGBA_8x6",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_SRGBA_8x8",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_SRGBA_10x5",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_SRGBA_10x6",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_SRGBA_10x8",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_SRGBA_10x10",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_SRGBA_12x10",1,4,pr.UNORM,!0,!1,!1,!0),new Qo("ASTC_SRGBA_12x12",1,4,pr.UNORM,!0,!1,!1,!0)]),ia=jr.UNIFORM_BUFFER|jr.DYNAMIC_UNIFORM_BUFFER|jr.STORAGE_BUFFER|jr.DYNAMIC_STORAGE_BUFFER,ra=jr.SAMPLER_TEXTURE|jr.SAMPLER|jr.TEXTURE|jr.STORAGE_IMAGE|jr.INPUT_ATTACHMENT,oa=jr.DYNAMIC_STORAGE_BUFFER|jr.DYNAMIC_UNIFORM_BUFFER;function aa(t){return t>0&&0==(t&t-1)}function sa(t,e,n,i){if(!na[t].isCompressed)return e*n*i*na[t].size;switch(t){case fr.BC1:case fr.BC1_ALPHA:case fr.BC1_SRGB:case fr.BC1_SRGB_ALPHA:return Math.ceil(e/4)*Math.ceil(n/4)*8*i;case fr.BC2:case fr.BC2_SRGB:case fr.BC3:case fr.BC3_SRGB:case fr.BC4:case fr.BC4_SNORM:case fr.BC6H_SF16:case fr.BC6H_UF16:case fr.BC7:case fr.BC7_SRGB:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case fr.BC5:case fr.BC5_SNORM:return Math.ceil(e/4)*Math.ceil(n/4)*32*i;case fr.ETC_RGB8:case fr.ETC2_RGB8:case fr.ETC2_SRGB8:case fr.ETC2_RGB8_A1:case fr.EAC_R11:case fr.EAC_R11SN:return Math.ceil(e/4)*Math.ceil(n/4)*8*i;case fr.ETC2_RGBA8:case fr.ETC2_SRGB8_A1:case fr.EAC_RG11:case fr.EAC_RG11SN:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case fr.PVRTC_RGB2:case fr.PVRTC_RGBA2:case fr.PVRTC2_2BPP:return Math.ceil(Math.max(e,16)*Math.max(n,8)/4)*i;case fr.PVRTC_RGB4:case fr.PVRTC_RGBA4:case fr.PVRTC2_4BPP:return Math.ceil(Math.max(e,8)*Math.max(n,8)/2)*i;case fr.ASTC_RGBA_4X4:case fr.ASTC_SRGBA_4X4:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case fr.ASTC_RGBA_5X4:case fr.ASTC_SRGBA_5X4:return Math.ceil(e/5)*Math.ceil(n/4)*16*i;case fr.ASTC_RGBA_5X5:case fr.ASTC_SRGBA_5X5:return Math.ceil(e/5)*Math.ceil(n/5)*16*i;case fr.ASTC_RGBA_6X5:case fr.ASTC_SRGBA_6X5:return Math.ceil(e/6)*Math.ceil(n/5)*16*i;case fr.ASTC_RGBA_6X6:case fr.ASTC_SRGBA_6X6:return Math.ceil(e/6)*Math.ceil(n/6)*16*i;case fr.ASTC_RGBA_8X5:case fr.ASTC_SRGBA_8X5:return Math.ceil(e/8)*Math.ceil(n/5)*16*i;case fr.ASTC_RGBA_8X6:case fr.ASTC_SRGBA_8X6:return Math.ceil(e/8)*Math.ceil(n/6)*16*i;case fr.ASTC_RGBA_8X8:case fr.ASTC_SRGBA_8X8:return Math.ceil(e/8)*Math.ceil(n/8)*16*i;case fr.ASTC_RGBA_10X5:case fr.ASTC_SRGBA_10X5:return Math.ceil(e/10)*Math.ceil(n/5)*16*i;case fr.ASTC_RGBA_10X6:case fr.ASTC_SRGBA_10X6:return Math.ceil(e/10)*Math.ceil(n/6)*16*i;case fr.ASTC_RGBA_10X8:case fr.ASTC_SRGBA_10X8:return Math.ceil(e/10)*Math.ceil(n/8)*16*i;case fr.ASTC_RGBA_10X10:case fr.ASTC_SRGBA_10X10:return Math.ceil(e/10)*Math.ceil(n/10)*16*i;case fr.ASTC_RGBA_12X10:case fr.ASTC_SRGBA_12X10:return Math.ceil(e/12)*Math.ceil(n/10)*16*i;case fr.ASTC_RGBA_12X12:case fr.ASTC_SRGBA_12X12:return Math.ceil(e/12)*Math.ceil(n/12)*16*i;default:return 0}}function ca(t,e,n,i,r){for(var o=0,a=0;a<r;++a)o+=sa(t,e,n,i),e=Math.max(e>>1,1),n=Math.max(n>>1,1);return o}var la=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function ua(t){return la[t]||0}function ha(t){var e=t.size/t.count;switch(t.type){case pr.UNORM:case pr.UINT:switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case pr.SNORM:case pr.INT:switch(e){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case pr.FLOAT:return Float32Array}return Float32Array}var _a=Object.freeze({__proto__:null,get ObjectType(){return cr},get Status(){return lr},get API(){return ur},get SurfaceTransform(){return hr},get Feature(){return _r},get Format(){return fr},get FormatType(){return pr},get Type(){return dr},get BufferUsageBit(){return mr},get BufferFlagBit(){return vr},get MemoryAccessBit(){return gr},get MemoryUsageBit(){return yr},get TextureType(){return xr},get TextureUsageBit(){return Sr},get TextureFlagBit(){return Ar},get SampleCount(){return Cr},get VsyncMode(){return br},get Filter(){return Tr},get Address(){return Er},get ComparisonFunc(){return wr},get StencilOp(){return Pr},get BlendFactor(){return Ir},get BlendOp(){return Rr},get ColorMask(){return Dr},get ShaderStageFlagBit(){return Br},get LoadOp(){return Mr},get StoreOp(){return Or},get AccessType(){return Nr},get ResolveMode(){return Lr},get PipelineBindPoint(){return Fr},get PrimitiveMode(){return zr},get PolygonMode(){return Vr},get ShadeModel(){return Gr},get CullMode(){return Ur},get DynamicStateFlagBit(){return kr},get StencilFace(){return Hr},get DescriptorType(){return jr},get QueueType(){return Wr},get QueryType(){return qr},get CommandBufferType(){return Xr},get ClearFlagBit(){return Yr},Size:$r,DeviceCaps:to,Offset:eo,Rect:no,Extent:io,TextureSubresLayers:ro,TextureSubresRange:oo,TextureCopy:ao,TextureBlit:so,BufferTextureCopy:co,Viewport:lo,Color:uo,BindingMappingInfo:ho,SwapchainInfo:_o,DeviceInfo:fo,BufferInfo:po,BufferViewInfo:mo,DrawInfo:vo,DispatchInfo:go,IndirectBuffer:yo,TextureInfo:xo,TextureViewInfo:So,SamplerInfo:Ao,Uniform:Co,UniformBlock:bo,UniformSamplerTexture:To,UniformSampler:Eo,UniformTexture:wo,UniformStorageImage:Po,UniformStorageBuffer:Io,UniformInputAttachment:Ro,ShaderStage:Do,Attribute:Bo,ShaderInfo:Mo,InputAssemblerInfo:Oo,ColorAttachment:No,DepthStencilAttachment:Lo,SubpassInfo:Fo,SubpassDependency:zo,RenderPassInfo:Vo,GlobalBarrierInfo:Go,TextureBarrierInfo:Uo,FramebufferInfo:ko,DescriptorSetLayoutBinding:Ho,DescriptorSetLayoutInfo:jo,DescriptorSetInfo:Wo,PipelineLayoutInfo:qo,InputState:Xo,CommandBufferInfo:Yo,QueueInfo:Ko,QueryPoolInfo:Jo,FormatInfo:Qo,MemoryStatus:Zo,DynamicStencilStates:$o,DynamicStates:ta,GFXObject:ea,get AttributeName(){return Zr},FormatInfos:na,DESCRIPTOR_BUFFER_TYPE:ia,DESCRIPTOR_SAMPLER_TYPE:ra,DESCRIPTOR_DYNAMIC_TYPE:oa,DRAW_INFO_SIZE:28,IsPowerOf2:aa,FormatSize:sa,FormatSurfaceSize:ca,GetTypeSize:ua,getTypedArrayConstructor:ha}),fa=function(t){function e(){var e;return(e=t.call(this,cr.BUFFER)||this)._usage=mr.NONE,e._memUsage=yr.NONE,e._size=0,e._stride=1,e._count=0,e._flags=vr.NONE,e._isBufferView=!1,e}return F(e,t),N(e,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),e}(ea),pa=function(t){function e(){var e;return(e=t.call(this,cr.COMMAND_BUFFER)||this)._queue=null,e._type=Xr.PRIMARY,e._numDrawCalls=0,e._numInstances=0,e._numTris=0,e}return F(e,t),N(e,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),e}(ea),da=function(){function t(){this._gfxAPI=ur.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(_r.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new Zo,this._caps=new to,this._bindingMappingInfo=new ho,this._samplers=new Map,this._globalBarriers=new Map,this._textureBarriers=new Map}return t.prototype.hasFeature=function(t){return this._features[t]},N(t,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}}]),t}();da.canvas=void 0;var ma=function(t){function e(){var e;return(e=t.call(this,cr.SWAPCHAIN)||this)._transform=hr.IDENTITY,e._colorTexture=null,e._depthStencilTexture=null,e}return F(e,t),N(e,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]),e}(ea),va=function(t){function e(){var e;return(e=t.call(this,cr.FRAMEBUFFER)||this)._renderPass=null,e._colorTextures=[],e._depthStencilTexture=null,e}return F(e,t),N(e,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),e}(ea),ga=String.prototype.charCodeAt;function ya(t){return this[t]}function xa(t,e){for(var n=t.length,i=e^n,r=0,o="string"==typeof t?ga:ya;n>=4;){var a=255&o.call(t,r)|(255&o.call(t,++r))<<8|(255&o.call(t,++r))<<16|(255&o.call(t,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),n-=4,++r}switch(n){case 3:i^=(255&o.call(t,r+2))<<16;case 2:i^=(255&o.call(t,r+1))<<8;case 1:i=1540483477*(65535&(i^=255&o.call(t,r)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var Sa,Aa=function(t){function e(){var e;return(e=t.call(this,cr.INPUT_ASSEMBLER)||this)._attributes=[],e._attributesHash=0,e._vertexBuffers=[],e._indexBuffer=null,e._indirectBuffer=null,e._drawInfo=new vo,e}F(e,t);var n=e.prototype;return n.getVertexBuffer=function(t){return void 0===t&&(t=0),t<this._vertexBuffers.length?this._vertexBuffers[t]:null},n.computeAttributesHash=function(){for(var t="attrs",e=0;e<this.attributes.length;++e){var n=this.attributes[e];t+=","+n.name+","+n.format+","+n.isNormalized+","+n.stream+","+n.isInstanced}return xa(t,666)},N(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(t){this._drawInfo.vertexCount=t}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(t){this._drawInfo.firstVertex=t}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(t){this._drawInfo.indexCount=t}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(t){this._drawInfo.firstIndex=t}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(t){this._drawInfo.vertexOffset=t}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(t){this._drawInfo.instanceCount=t}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(t){this._drawInfo.firstInstance=t}},{key:"drawInfo",get:function(){return this._drawInfo}}]),e}(ea),Ca=function(t){function e(){var e;return(e=t.call(this,cr.DESCRIPTOR_SET)||this)._layout=null,e._buffers=[],e._textures=[],e._samplers=[],e._isDirty=!1,e}F(e,t);var n=e.prototype;return n.bindBuffer=function(t,e,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[t],r=this._layout.bindings[i];if(r&&r.descriptorType&ia){var o=this._layout.descriptorIndices[t];this._buffers[o+n]!==e&&(this._buffers[o+n]=e,this._isDirty=!0)}},n.bindSampler=function(t,e,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[t],r=this._layout.bindings[i];if(r&&r.descriptorType&ra){var o=this._layout.descriptorIndices[t];this._samplers[o+n]!==e&&(this._samplers[o+n]=e,this._isDirty=!0)}},n.bindTexture=function(t,e,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[t],r=this._layout.bindings[i];if(r&&r.descriptorType&ra){var o=this._layout.descriptorIndices[t];this._textures[o+n]!==e&&(this._textures[o+n]=e,this._isDirty=!0)}},n.getBuffer=function(t,e){void 0===e&&(e=0);var n=this._layout.descriptorIndices[t];return this._buffers[n+e]},n.getSampler=function(t,e){void 0===e&&(e=0);var n=this._layout.descriptorIndices[t];return this._samplers[n+e]},n.getTexture=function(t,e){void 0===e&&(e=0);var n=this._layout.descriptorIndices[t];return this._textures[n+e]},N(e,[{key:"layout",get:function(){return this._layout}}]),e}(ea),ba=function(t){function e(){var e;return(e=t.call(this,cr.DESCRIPTOR_SET_LAYOUT)||this)._bindings=[],e._bindingIndices=[],e._descriptorIndices=[],e}return F(e,t),N(e,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),e}(ea),Ta=function(t){function e(){var e;return(e=t.call(this,cr.PIPELINE_LAYOUT)||this)._setLayouts=[],e}return F(e,t),N(e,[{key:"setLayouts",get:function(){return this._setLayouts}}]),e}(ea),Ea=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h){void 0===t&&(t=!1),void 0===e&&(e=Vr.FILL),void 0===n&&(n=Gr.GOURAND),void 0===i&&(i=Ur.BACK),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=!0),void 0===u&&(u=!1),void 0===h&&(h=1),this.isDiscard=t,this.polygonMode=e,this.shadeModel=n,this.cullMode=i,this.isFrontFaceCCW=r,this.depthBiasEnabled=o,this.depthBias=a,this.depthBiasClamp=s,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=u,this.lineWidth=h}var e=t.prototype;return e.reset=function(){this.isDiscard=!1,this.polygonMode=Vr.FILL,this.shadeModel=Gr.GOURAND,this.cullMode=Ur.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},N(t,[{key:"native",get:function(){return this}}]),t}(),wa=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m,v,g){void 0===t&&(t=!0),void 0===e&&(e=!0),void 0===n&&(n=wr.LESS),void 0===i&&(i=!1),void 0===r&&(r=wr.ALWAYS),void 0===o&&(o=65535),void 0===a&&(a=65535),void 0===s&&(s=Pr.KEEP),void 0===c&&(c=Pr.KEEP),void 0===l&&(l=Pr.KEEP),void 0===u&&(u=1),void 0===h&&(h=!1),void 0===_&&(_=wr.ALWAYS),void 0===f&&(f=65535),void 0===p&&(p=65535),void 0===d&&(d=Pr.KEEP),void 0===m&&(m=Pr.KEEP),void 0===v&&(v=Pr.KEEP),void 0===g&&(g=1),this.depthTest=t,this.depthWrite=e,this.depthFunc=n,this.stencilTestFront=i,this.stencilFuncFront=r,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=a,this.stencilFailOpFront=s,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=u,this.stencilTestBack=h,this.stencilFuncBack=_,this.stencilReadMaskBack=f,this.stencilWriteMaskBack=p,this.stencilFailOpBack=d,this.stencilZFailOpBack=m,this.stencilPassOpBack=v,this.stencilRefBack=g}var e=t.prototype;return e.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=wr.LESS,this.stencilTestFront=!1,this.stencilFuncFront=wr.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=Pr.KEEP,this.stencilZFailOpFront=Pr.KEEP,this.stencilPassOpFront=Pr.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=wr.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=Pr.KEEP,this.stencilZFailOpBack=Pr.KEEP,this.stencilPassOpBack=Pr.KEEP,this.stencilRefBack=1},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},N(t,[{key:"native",get:function(){return this}}]),t}(),Pa=function(){function t(t,e,n,i,r,o,a,s){void 0===t&&(t=!1),void 0===e&&(e=Ir.ONE),void 0===n&&(n=Ir.ZERO),void 0===i&&(i=Rr.ADD),void 0===r&&(r=Ir.ONE),void 0===o&&(o=Ir.ZERO),void 0===a&&(a=Rr.ADD),void 0===s&&(s=Dr.ALL),this.blend=t,this.blendSrc=e,this.blendDst=n,this.blendEq=i,this.blendSrcAlpha=r,this.blendDstAlpha=o,this.blendAlphaEq=a,this.blendColorMask=s}var e=t.prototype;return e.reset=function(){this.blend=!1,this.blendSrc=Ir.ONE,this.blendDst=Ir.ZERO,this.blendEq=Rr.ADD,this.blendSrcAlpha=Ir.ONE,this.blendDstAlpha=Ir.ZERO,this.blendAlphaEq=Rr.ADD,this.blendColorMask=Dr.ALL},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},t}(),Ia=function(){function t(t,e,n,i){void 0===t&&(t=!1),void 0===e&&(e=!1),void 0===n&&(n=new uo),void 0===i&&(i=[new Pa]),this.isA2C=t,this.isIndepend=e,this.blendColor=n,this.targets=i}var e=t.prototype;return e.setTarget=function(t,e){var n=this.targets[t];n||(n=this.targets[t]=new Pa),Object.assign(n,e)},e.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},e.destroy=function(){},N(t,[{key:"native",get:function(){return this}}]),t}(),Ra=function(t,e,n,i,r,o,a,s,c,l){void 0===t&&(t=null),void 0===e&&(e=null),void 0===n&&(n=null),void 0===i&&(i=new Xo),void 0===r&&(r=new Ea),void 0===o&&(o=new wa),void 0===a&&(a=new Ia),void 0===s&&(s=zr.TRIANGLE_LIST),void 0===c&&(c=kr.NONE),void 0===l&&(l=Fr.GRAPHICS),this.shader=t,this.pipelineLayout=e,this.renderPass=n,this.inputState=i,this.rasterizerState=r,this.depthStencilState=o,this.blendState=a,this.primitive=s,this.dynamicStates=c,this.bindPoint=l},Da=function(t){function e(){var e;return(e=t.call(this,cr.PIPELINE_STATE)||this)._shader=null,e._pipelineLayout=null,e._primitive=zr.TRIANGLE_LIST,e._is=null,e._rs=new Ea,e._dss=new wa,e._bs=new Ia,e._dynamicStates=kr.NONE,e._renderPass=null,e}return F(e,t),N(e,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),e}(ea),Ba=function(t){function e(){var e;return(e=t.call(this,cr.QUEUE)||this)._type=Wr.GRAPHICS,e}return F(e,t),N(e,[{key:"type",get:function(){return this._type}}]),e}(ea),Ma=function(t){function e(){var e;return(e=t.call(this,cr.RENDER_PASS)||this)._colorInfos=[],e._depthStencilInfo=null,e._subpasses=[],e._hash=0,e}return F(e,t),e.prototype.computeHash=function(){var t="";if(this._subpasses.length)for(var e=0;e<this._subpasses.length;++e){var n=this._subpasses[e];if(n.inputs.length){t+="ia";for(var i=0;i<n.inputs.length;++i){var r=this._colorInfos[n.inputs[i]];t+=","+r.format+","+r.sampleCount}}if(n.colors.length){t+="ca";for(var o=0;o<n.inputs.length;++o){var a=this._colorInfos[n.inputs[o]];t+=","+a.format+","+a.sampleCount}}if(n.depthStencil>=0){var s=this._colorInfos[n.depthStencil];t+="ds,"+s.format+","+s.sampleCount}}else{t+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];t+=","+l.format+","+l.sampleCount}var u=this._depthStencilInfo;u&&(t+="ds,"+u.format+","+u.sampleCount)}return xa(t,666)},N(e,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),e}(ea),Oa=function(t){function e(e,n){var i;return(i=t.call(this,cr.SAMPLER)||this)._info=new Ao,i._hash=0,i._info.copy(e),i._hash=n,i}return F(e,t),e.computeHash=function(t){var e=t.minFilter;return e|=t.magFilter<<2,e|=t.mipFilter<<4,e|=t.addressU<<6,e|=t.addressV<<8,e|=t.addressW<<10,(e|=t.maxAnisotropy<<12)|t.cmpFunc<<16},e.unpackFromHash=function(t){var e=new Ao;return e.minFilter=(3&t)>>0,e.magFilter=(3&t)>>2,e.mipFilter=(3&t)>>4,e.addressU=(3&t)>>6,e.addressV=(3&t)>>8,e.addressW=(3&t)>>10,e.maxAnisotropy=(15&t)>>12,e.cmpFunc=(7&t)>>16,e},N(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(ea),Na=function(t){function e(){var e;return(e=t.call(this,cr.SHADER)||this)._name="",e._stages=[],e._attributes=[],e._blocks=[],e._samplers=[],e}return F(e,t),N(e,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),e}(ea),La=function(t){function e(){var e;return(e=t.call(this,cr.TEXTURE)||this)._type=xr.TEX2D,e._usage=Sr.NONE,e._format=fr.UNKNOWN,e._width=0,e._height=0,e._depth=1,e._layerCount=1,e._levelCount=1,e._samples=Cr.ONE,e._flags=Ar.NONE,e._isPowerOf2=!1,e._size=0,e}return F(e,t),N(e,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}}]),e}(ea),Fa=function(t){function e(e,n){var i;return(i=t.call(this,cr.GLOBAL_BARRIER)||this)._info=new Go,i._hash=0,i._info.copy(e),i._hash=n,i}return F(e,t),e.computeHash=function(t){for(var e="prev:",n=0;n<t.prevAccesses.length;++n)e+=" "+t.prevAccesses[n];e+="next:";for(var i=0;i<t.nextAccesses.length;++i)e+=" "+t.nextAccesses[i];return xa(e,666)},N(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(ea),za=function(t){function e(e,n){var i;return(i=t.call(this,cr.TEXTURE_BARRIER)||this)._info=new Uo,i._hash=0,i._info.copy(e),i._hash=n,i}return F(e,t),e.computeHash=function(t){for(var e="prev:",n=0;n<t.prevAccesses.length;++n)e+=" "+t.prevAccesses[n];e+="next:";for(var i=0;i<t.nextAccesses.length;++i)e+=" "+t.nextAccesses[i];return e+=t.discardContents,e+=t.srcQueue?t.srcQueue.type:0,xa(e+=t.dstQueue?t.dstQueue.type:0,666)},N(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(ea),Va={Device:da,Swapchain:ma,Buffer:fa,Texture:La,Sampler:Oa,Shader:Na,InputAssembler:Aa,RenderPass:Ma,Framebuffer:va,DescriptorSet:Ca,DescriptorSetLayout:ba,PipelineLayout:Ta,PipelineState:Da,CommandBuffer:pa,Queue:Ba,GlobalBarrier:Fa,TextureBarrier:za,RasterizerState:Ea,BlendState:Ia,BlendTarget:Pa,DepthStencilState:wa,PipelineStateInfo:Ra};Object.assign(Va,_a),i.gfx=Va,t("gfx",Object.freeze({__proto__:null,DescriptorSet:Ca,Buffer:fa,CommandBuffer:pa,get ObjectType(){return cr},get Status(){return lr},get API(){return ur},get SurfaceTransform(){return hr},get Feature(){return _r},get Format(){return fr},get FormatType(){return pr},get Type(){return dr},get BufferUsageBit(){return mr},get BufferFlagBit(){return vr},get MemoryAccessBit(){return gr},get MemoryUsageBit(){return yr},get TextureType(){return xr},get TextureUsageBit(){return Sr},get TextureFlagBit(){return Ar},get SampleCount(){return Cr},get VsyncMode(){return br},get Filter(){return Tr},get Address(){return Er},get ComparisonFunc(){return wr},get StencilOp(){return Pr},get BlendFactor(){return Ir},get BlendOp(){return Rr},get ColorMask(){return Dr},get ShaderStageFlagBit(){return Br},get LoadOp(){return Mr},get StoreOp(){return Or},get AccessType(){return Nr},get ResolveMode(){return Lr},get PipelineBindPoint(){return Fr},get PrimitiveMode(){return zr},get PolygonMode(){return Vr},get ShadeModel(){return Gr},get CullMode(){return Ur},get DynamicStateFlagBit(){return kr},get StencilFace(){return Hr},get DescriptorType(){return jr},get QueueType(){return Wr},get QueryType(){return qr},get CommandBufferType(){return Xr},get ClearFlagBit(){return Yr},Size:$r,DeviceCaps:to,Offset:eo,Rect:no,Extent:io,TextureSubresLayers:ro,TextureSubresRange:oo,TextureCopy:ao,TextureBlit:so,BufferTextureCopy:co,Viewport:lo,Color:uo,BindingMappingInfo:ho,SwapchainInfo:_o,DeviceInfo:fo,BufferInfo:po,BufferViewInfo:mo,DrawInfo:vo,DispatchInfo:go,IndirectBuffer:yo,TextureInfo:xo,TextureViewInfo:So,SamplerInfo:Ao,Uniform:Co,UniformBlock:bo,UniformSamplerTexture:To,UniformSampler:Eo,UniformTexture:wo,UniformStorageImage:Po,UniformStorageBuffer:Io,UniformInputAttachment:Ro,ShaderStage:Do,Attribute:Bo,ShaderInfo:Mo,InputAssemblerInfo:Oo,ColorAttachment:No,DepthStencilAttachment:Lo,SubpassInfo:Fo,SubpassDependency:zo,RenderPassInfo:Vo,GlobalBarrierInfo:Go,TextureBarrierInfo:Uo,FramebufferInfo:ko,DescriptorSetLayoutBinding:Ho,DescriptorSetLayoutInfo:jo,DescriptorSetInfo:Wo,PipelineLayoutInfo:qo,InputState:Xo,CommandBufferInfo:Yo,QueueInfo:Ko,QueryPoolInfo:Jo,FormatInfo:Qo,MemoryStatus:Zo,DynamicStencilStates:$o,DynamicStates:ta,GFXObject:ea,get AttributeName(){return Zr},FormatInfos:na,DESCRIPTOR_BUFFER_TYPE:ia,DESCRIPTOR_SAMPLER_TYPE:ra,DESCRIPTOR_DYNAMIC_TYPE:oa,DRAW_INFO_SIZE:28,IsPowerOf2:aa,FormatSize:sa,FormatSurfaceSize:ca,GetTypeSize:ua,getTypedArrayConstructor:ha,Device:da,Swapchain:ma,Framebuffer:va,InputAssembler:Aa,DescriptorSetLayout:ba,PipelineLayout:Ta,RasterizerState:Ea,DepthStencilState:wa,BlendTarget:Pa,BlendState:Ia,PipelineStateInfo:Ra,PipelineState:Da,Queue:Ba,RenderPass:Ma,Sampler:Oa,Shader:Na,Texture:La,GlobalBarrier:Fa,TextureBarrier:za})),function(t){t[t.ALL=0]="ALL",t[t.CLOSEST=1]="CLOSEST",t[t.ANY=2]="ANY"}(Sa||(Sa={}));var Ga,Ua,ka,Ha,ja,Wa,qa,Xa,Ya=(Ga=new oi(0,0,0),function(t,e){var n=oi.dot(t.d,e.n);if(Math.abs(n)<Number.EPSILON)return 0;oi.multiplyScalar(Ga,e.n,e.d);var i=oi.dot(oi.subtract(Ga,Ga,t.o),e.n)/n;return i<0?0:i}),Ka=(Ua=new oi(0,0,0),ka=new oi(0,0,0),Ha=new oi(0,0,0),ja=new oi(0,0,0),Wa=new oi(0,0,0),function(t,e,n){oi.subtract(Ua,e.b,e.a),oi.subtract(ka,e.c,e.a),oi.cross(Ha,t.d,ka);var i=oi.dot(Ua,Ha);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var r=1/i;oi.subtract(ja,t.o,e.a);var o=oi.dot(ja,Ha)*r;if(o<0||o>1)return 0;oi.cross(Wa,ja,Ua);var a=oi.dot(t.d,Wa)*r;if(a<0||o+a>1)return 0;var s=oi.dot(ka,Wa)*r;return s<0?0:s}),Ja=function(){var t=new oi(0,0,0);return function(e,n){var i=n.radius,r=n.center,o=e.o,a=e.d,s=i*i;oi.subtract(t,r,o);var c=t.lengthSqr(),l=oi.dot(t,a),u=s-(c-l*l);if(u<0)return 0;var h=Math.sqrt(u),_=c<s?l+h:l-h;return _<0?0:_}}(),Qa=(qa=new oi,Xa=new oi,function(t,e){return oi.subtract(qa,e.center,e.halfExtents),oi.add(Xa,e.center,e.halfExtents),Za(t,qa,Xa)});function Za(t,e,n){var i=t.o,r=t.d,o=1/r.x,a=1/r.y,s=1/r.z,c=(e.x-i.x)*o,l=(n.x-i.x)*o,u=(e.y-i.y)*a,h=(n.y-i.y)*a,_=(e.z-i.z)*s,f=(n.z-i.z)*s,p=Math.max(Math.max(Math.min(c,l),Math.min(u,h)),Math.min(_,f)),d=Math.min(Math.min(Math.max(c,l),Math.max(u,h)),Math.max(_,f));return d<0||p>d?0:p>0?p:d}var $a,ts,es,ns,is=function(){var t=new oi,e=new oi,n=new oi,i=new oi,r=new oi,o=new oi,a=new oi,s=new Array(3),c=new Array(3),l=new Array(3),u=new Array(6);return function(h,_){s[0]=_.halfExtents.x,s[1]=_.halfExtents.y,s[2]=_.halfExtents.z,t=_.center,e=h.o,n=h.d,oi.set(i,_.orientation.m00,_.orientation.m01,_.orientation.m02),oi.set(r,_.orientation.m03,_.orientation.m04,_.orientation.m05),oi.set(o,_.orientation.m06,_.orientation.m07,_.orientation.m08),oi.subtract(a,t,e),c[0]=oi.dot(i,n),c[1]=oi.dot(r,n),c[2]=oi.dot(o,n),l[0]=oi.dot(i,a),l[1]=oi.dot(r,a),l[2]=oi.dot(o,a);for(var f=0;f<3;++f){if(0===c[f]){if(-l[f]-s[f]>0||-l[f]+s[f]<0)return 0;c[f]=1e-7}u[2*f+0]=(l[f]+s[f])/c[f],u[2*f+1]=(l[f]-s[f])/c[f]}var p=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),d=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return d<0||p>d?0:p>0?p:d}}(),rs=function(){var t=new oi,e=new oi,n=new oi,i=new oi,r=new oi,o=new oi,a=new oi,s=new Kr;return function(c,l){var u=l.radius*l.radius,h=oi.normalize(t,c.d),_=l.ellipseCenter0,f=l.ellipseCenter1,p=oi.subtract(e,f,_);if(p.equals(oi.ZERO))return s.radius=l.radius,s.center.set(l.ellipseCenter0),ks.raySphere(c,s);var d=c.o,m=oi.subtract(n,d,_),v=oi.cross(i,h,p),g=v.lengthSqr();if(0===g){s.radius=l.radius;var y=oi.subtract(r,f,d);return m.lengthSqr()<y.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),ks.raySphere(c,s)}var x=oi.cross(r,m,p),S=p.lengthSqr(),A=2*oi.dot(v,x),C=A*A-4*g*(x.lengthSqr()-u*S);if(C<0)return 0;var b=(-A-Math.sqrt(C))/(2*g);if(b<0){s.radius=l.radius;var T=oi.subtract(o,f,d);return m.lengthSqr()<T.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),ks.raySphere(c,s)}var E=oi.scaleAndAdd(o,c.o,h,b),w=oi.subtract(a,E,_),P=oi.dot(w,p)/S;return P>=0&&P<=1?b:P<0?(s.radius=l.radius,s.center.set(l.ellipseCenter0),ks.raySphere(c,s)):P>1?(s.radius=l.radius,s.center.set(l.ellipseCenter1),ks.raySphere(c,s)):0}}(),os=($a=Jr.create(),ts={distance:1/0,doubleSided:!1,mode:Sa.ANY},es=0,ns=function(t,e,n,i,r,o){t===Sa.CLOSEST?(es>e||0===es)&&(es=e,o&&(0===o.length?o.push({distance:e,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}):(o[0].distance=e,o[0].vertexIndex0=n/3,o[0].vertexIndex1=i/3,o[0].vertexIndex2=r/3))):(es=e,o&&o.push({distance:e,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}))},function(t,e,n){if(es=0,0===e.geometricInfo.positions.length)return es;var i=void 0===n?ts:n;if(Za(t,e.geometricInfo.boundingBox.min,e.geometricInfo.boundingBox.max)){var r=e.primitiveMode,o=e.geometricInfo;!function(t,e,n,i,r){if(n===zr.TRIANGLE_LIST)for(var o=e.length,a=0;a<o;a+=3){var s=3*e[a],c=3*e[a+1],l=3*e[a+2];oi.set($a.a,t[s],t[s+1],t[s+2]),oi.set($a.b,t[c],t[c+1],t[c+2]),oi.set($a.c,t[l],t[l+1],t[l+2]);var u=ks.rayTriangle(i,$a,r.doubleSided);if(!(0===u||u>r.distance)&&(ns(r.mode,u,s,c,l,r.result),r.mode===Sa.ANY))return u}else if(n===zr.TRIANGLE_STRIP)for(var h=e.length-2,_=0,f=0;f<h;f+=1){var p=3*e[f-_],d=3*e[f+_+1],m=3*e[f+2];oi.set($a.a,t[p],t[p+1],t[p+2]),oi.set($a.b,t[d],t[d+1],t[d+2]),oi.set($a.c,t[m],t[m+1],t[m+2]),_=~_;var v=ks.rayTriangle(i,$a,r.doubleSided);if(!(0===v||v>r.distance)&&(ns(r.mode,v,p,d,m,r.result),r.mode===Sa.ANY))return v}else if(n===zr.TRIANGLE_FAN){var g=e.length-1,y=3*e[0];oi.set($a.a,t[y],t[y+1],t[y+2]);for(var x=1;x<g;x+=1){var S=3*e[x],A=3*e[x+1];oi.set($a.b,t[S],t[S+1],t[S+2]),oi.set($a.c,t[A],t[A+1],t[A+2]);var C=ks.rayTriangle(i,$a,r.doubleSided);if(!(0===C||C>r.distance)&&(ns(r.mode,C,y,S,A,r.result),r.mode===Sa.ANY))return C}}}(o.positions,o.indices,r,t,i)}return es}),as=function(){var t=0,e={distance:1/0,doubleSided:!1,mode:Sa.ANY};return function(n,i,r){t=0;var o=void 0===r?e:r,a=i.renderingSubMeshes.length,s=i.struct.minPosition,c=i.struct.maxPosition;if(s&&c&&!Za(n,s,c))return t;for(var l=0;l<a;l++){var u=i.renderingSubMeshes[l],h=os(n,u,o);if(h)if(o.mode===Sa.CLOSEST)(0===t||t>h)&&(t=h,o.subIndices&&(o.subIndices[0]=l));else if(t=h,o.subIndices&&o.subIndices.push(l),o.mode===Sa.ANY)return h}return t&&o.mode===Sa.CLOSEST&&(o.result&&(o.result[0].distance=t,o.result.length=1),o.subIndices&&(o.subIndices.length=1)),t}}(),ss=function(){var t=0,e={distance:1/0,doubleSided:!1,mode:Sa.ANY},n=new nr,i=new Ei;return function(r,o,a){t=0;var s=void 0===a?e:a,c=o.worldBounds;if(c&&!Qa(r,c))return t;nr.copy(n,r),o.node&&(Ei.invert(i,o.node.getWorldMatrix(i)),oi.transformMat4(n.o,r.o,i),oi.transformMat4Normal(n.d,r.d,i));for(var l=o.subModels,u=0;u<l.length;u++){var h=l[u].subMesh,_=os(n,h,s);if(_)if(s.mode===Sa.CLOSEST)(0===t||t>_)&&(t=_,s.subIndices&&(s.subIndices[0]=u));else if(t=_,s.subIndices&&s.subIndices.push(u),s.mode===Sa.ANY)return _}return t&&s.mode===Sa.CLOSEST&&(s.result&&(s.result[0].distance=t,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),t}}(),cs=function(){var t=new oi(0,0,0);return function(e,n){oi.subtract(t,e.e,e.s);var i=(n.d-oi.dot(e.s,n.n))/oi.dot(t,n.n);return i<0||i>1?0:i}}(),ls=function(){var t=new oi(0,0,0),e=new oi(0,0,0),n=new oi(0,0,0),i=new oi(0,0,0),r=new oi(0,0,0),o=new oi(0,0,0);return function(a,s,c){oi.subtract(t,s.b,s.a),oi.subtract(e,s.c,s.a),oi.subtract(n,a.s,a.e),oi.cross(r,t,e);var l=oi.dot(n,r);if(l<=0)return 0;oi.subtract(i,a.s,s.a);var u=oi.dot(i,r);if(u<0||u>l)return 0;oi.cross(o,n,i);var h=oi.dot(e,o);if(h<0||h>l)return 0;var _=-oi.dot(t,o);if(_<0||h+_>l)return 0;if(c){var f=1/l,p=1-(h*=f)-(_*=f);oi.set(c,s.a.x*p+s.b.x*h+s.c.x*_,s.a.y*p+s.b.y*h+s.c.y*_,s.a.z*p+s.b.z*h+s.c.z*_)}return 1}}(),us=new nr;function hs(t,e){us.o.set(t.s),oi.subtract(us.d,t.e,t.s),us.d.normalize();var n=Qa(us,e);return n<=t.length()?n:0}function _s(t,e){us.o.set(t.s),oi.subtract(us.d,t.e,t.s),us.d.normalize();var n=is(us,e);return n<=t.length()?n:0}function fs(t,e){us.o.set(t.s),oi.subtract(us.d,t.e,t.s),us.d.normalize();var n=Ja(us,e);return n<=t.length()?n:0}var ps,ds,ms,vs,gs=(ps=new oi,ds=new oi,ms=new oi,vs=new oi,function(t,e){return oi.subtract(ps,t.center,t.halfExtents),oi.add(ds,t.center,t.halfExtents),oi.subtract(ms,e.center,e.halfExtents),oi.add(vs,e.center,e.halfExtents),ps.x<=vs.x&&ds.x>=ms.x&&ps.y<=vs.y&&ds.y>=ms.y&&ps.z<=vs.z&&ds.z>=ms.z});function ys(t,e,n,i,r,o){oi.set(o[0],t.x+n.x*e.x+i.x*e.y+r.x*e.z,t.y+n.y*e.x+i.y*e.y+r.y*e.z,t.z+n.z*e.x+i.z*e.y+r.z*e.z),oi.set(o[1],t.x-n.x*e.x+i.x*e.y+r.x*e.z,t.y-n.y*e.x+i.y*e.y+r.y*e.z,t.z-n.z*e.x+i.z*e.y+r.z*e.z),oi.set(o[2],t.x+n.x*e.x-i.x*e.y+r.x*e.z,t.y+n.y*e.x-i.y*e.y+r.y*e.z,t.z+n.z*e.x-i.z*e.y+r.z*e.z),oi.set(o[3],t.x+n.x*e.x+i.x*e.y-r.x*e.z,t.y+n.y*e.x+i.y*e.y-r.y*e.z,t.z+n.z*e.x+i.z*e.y-r.z*e.z),oi.set(o[4],t.x-n.x*e.x-i.x*e.y-r.x*e.z,t.y-n.y*e.x-i.y*e.y-r.y*e.z,t.z-n.z*e.x-i.z*e.y-r.z*e.z),oi.set(o[5],t.x+n.x*e.x-i.x*e.y-r.x*e.z,t.y+n.y*e.x-i.y*e.y-r.y*e.z,t.z+n.z*e.x-i.z*e.y-r.z*e.z),oi.set(o[6],t.x-n.x*e.x+i.x*e.y-r.x*e.z,t.y-n.y*e.x+i.y*e.y-r.y*e.z,t.z-n.z*e.x+i.z*e.y-r.z*e.z),oi.set(o[7],t.x-n.x*e.x-i.x*e.y+r.x*e.z,t.y-n.y*e.x-i.y*e.y+r.y*e.z,t.z-n.z*e.x-i.z*e.y+r.z*e.z)}function xs(t,e){for(var n=oi.dot(e,t[0]),i=n,r=1;r<8;++r){var o=oi.dot(e,t[r]);n=o<n?o:n,i=o>i?o:i}return[n,i]}var Ss,As,Cs,bs=function(){for(var t=new Array(15),e=0;e<15;e++)t[e]=new oi(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new oi(0,0,0),i[r]=new oi(0,0,0);var o=new oi,a=new oi;return function(e,r){oi.set(t[0],1,0,0),oi.set(t[1],0,1,0),oi.set(t[2],0,0,1),oi.set(t[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),oi.set(t[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),oi.set(t[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)oi.cross(t[6+3*s],t[s],t[3]),oi.cross(t[7+3*s],t[s],t[4]),oi.cross(t[7+3*s],t[s],t[5]);oi.subtract(o,e.center,e.halfExtents),oi.add(a,e.center,e.halfExtents),function(t,e,n){oi.set(n[0],t.x,e.y,e.z),oi.set(n[1],t.x,e.y,t.z),oi.set(n[2],t.x,t.y,e.z),oi.set(n[3],t.x,t.y,t.z),oi.set(n[4],e.x,e.y,e.z),oi.set(n[5],e.x,e.y,t.z),oi.set(n[6],e.x,t.y,e.z),oi.set(n[7],e.x,t.y,t.z)}(o,a,n),ys(r.center,r.halfExtents,t[3],t[4],t[5],i);for(var c=0;c<15;++c){var l=xs(n,t[c]),u=xs(i,t[c]);if(u[0]>l[1]||l[0]>u[1])return 0}return 1}}(),Ts=function(t,e){var n=t.halfExtents.x*Math.abs(e.n.x)+t.halfExtents.y*Math.abs(e.n.y)+t.halfExtents.z*Math.abs(e.n.z),i=oi.dot(e.n,t.center);return i+n<e.d?-1:i-n>e.d?0:1},Es=function(t,e){for(var n=0;n<e.planes.length;n++)if(-1===Ts(t,e.planes[n]))return 0;return 1},ws=function(){for(var t=new Array(8),e=0,n=0,i=0;i<t.length;i++)t[i]=new oi(0,0,0);return function(i,r){for(var o=0,a=!1,s=0;s<r.planes.length;s++){if(-1===(o=Ts(i,r.planes[s])))return 0;1===o&&(a=!0)}if(!a)return 1;for(var c=0;c<r.vertices.length;c++)oi.subtract(t[c],r.vertices[c],i.center);e=0,n=0;for(var l=0;l<r.vertices.length;l++)t[l].x>i.halfExtents.x?e++:t[l].x<-i.halfExtents.x&&n++;if(e===r.vertices.length||n===r.vertices.length)return 0;e=0,n=0;for(var u=0;u<r.vertices.length;u++)t[u].y>i.halfExtents.y?e++:t[u].y<-i.halfExtents.y&&n++;if(e===r.vertices.length||n===r.vertices.length)return 0;e=0,n=0;for(var h=0;h<r.vertices.length;h++)t[h].z>i.halfExtents.z?e++:t[h].z<-i.halfExtents.z&&n++;return e===r.vertices.length||n===r.vertices.length?0:1}}(),Ps=(Ss=new oi(0,0,0),As=new di,function(t,e){return oi.subtract(Ss,e,t.center),oi.transformMat3(Ss,Ss,di.transpose(As,t.orientation)),n=Ss,i=t.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),Is=(Cs=function(t,e,n,i){return Math.abs(t.x*e+t.y*n+t.z*i)},function(t,e){var n=t.halfExtents.x*Cs(e.n,t.orientation.m00,t.orientation.m01,t.orientation.m02)+t.halfExtents.y*Cs(e.n,t.orientation.m03,t.orientation.m04,t.orientation.m05)+t.halfExtents.z*Cs(e.n,t.orientation.m06,t.orientation.m07,t.orientation.m08),i=oi.dot(e.n,t.center);return i+n<e.d?-1:i-n>e.d?0:1}),Rs=function(t,e){for(var n=0;n<e.planes.length;n++)if(-1===Is(t,e.planes[n]))return 0;return 1},Ds=function(){for(var t=new Array(8),e=0,n=0,i=0,r=0;r<t.length;r++)t[r]=new oi(0,0,0);var o=function(t,e,n,i){return t.x*e+t.y*n+t.z*i};return function(r,a){for(var s=0,c=!1,l=0;l<a.planes.length;l++){if(-1===(s=Is(r,a.planes[l])))return 0;1===s&&(c=!0)}if(!c)return 1;for(var u=0;u<a.vertices.length;u++)oi.subtract(t[u],a.vertices[u],r.center);n=0,i=0;for(var h=0;h<a.vertices.length;h++)(e=o(t[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?n++:e<-r.halfExtents.x&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var _=0;_<a.vertices.length;_++)(e=o(t[_],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?n++:e<-r.halfExtents.y&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var f=0;f<a.vertices.length;f++)(e=o(t[f],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?n++:e<-r.halfExtents.z&&i++;return n===a.vertices.length||i===a.vertices.length?0:1}}(),Bs=function(){for(var t=new Array(15),e=0;e<15;e++)t[e]=new oi(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new oi(0,0,0),i[r]=new oi(0,0,0);return function(e,r){oi.set(t[0],e.orientation.m00,e.orientation.m01,e.orientation.m02),oi.set(t[1],e.orientation.m03,e.orientation.m04,e.orientation.m05),oi.set(t[2],e.orientation.m06,e.orientation.m07,e.orientation.m08),oi.set(t[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),oi.set(t[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),oi.set(t[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)oi.cross(t[6+3*o],t[o],t[3]),oi.cross(t[7+3*o],t[o],t[4]),oi.cross(t[8+3*o],t[o],t[5]);ys(e.center,e.halfExtents,t[0],t[1],t[2],n),ys(r.center,r.halfExtents,t[3],t[4],t[5],i);for(var a=0;a<15;++a){var s=xs(n,t[a]),c=xs(i,t[a]);if(c[0]>s[1]||s[0]>c[1])return 0}return 1}}(),Ms=function(){for(var t=new Kr,e=new oi,n=new oi,i=new oi,r=new Array(8),o=0;o<8;o++)r[o]=new oi;for(var a=new Array(8),s=0;s<8;s++)a[s]=new oi;return function(o,s){if(0===oi.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return t.radius=s.radius,t.center.set(s.ellipseCenter0),ks.sphereOBB(t,o);e.x=o.orientation.m00,e.y=o.orientation.m01,e.z=o.orientation.m02,n.x=o.orientation.m03,n.y=o.orientation.m04,n.z=o.orientation.m05,i.x=o.orientation.m06,i.y=o.orientation.m07,i.z=o.orientation.m08,ys(o.center,o.halfExtents,e,n,i,r);var c=a,l=oi.copy(c[0],e),u=oi.copy(c[1],n),h=oi.copy(c[2],i);oi.subtract(c[3],s.center,o.center).normalize();var _=oi.subtract(c[4],s.ellipseCenter0,s.ellipseCenter1);_.normalize(),oi.cross(c[5],l,_),oi.cross(c[6],u,_),oi.cross(c[7],h,_);for(var f=0;f<8;++f){var p=xs(r,c[f]),d=oi.dot(c[f],s.ellipseCenter0),m=oi.dot(c[f],s.ellipseCenter1),v=Math.max(d,m),g=Math.min(d,m)-s.radius,y=v+s.radius;if(g>p[1]||p[0]>y)return 0}return 1}}(),Os=function(t,e){var n=oi.dot(e.n,t.center),i=t.radius*e.n.length();return n+i<e.d?-1:n-i>e.d?0:1},Ns=function(t,e){for(var n=0;n<e.planes.length;n++)if(-1===Os(t,e.planes[n]))return 0;return 1},Ls=function(){var t=new oi(0,0,0),e=[1,-1,1,-1,1,-1];return function(n,i){for(var r=0;r<6;r++){var o=i.planes[r],a=n.radius,s=n.center,c=o.n,l=o.d,u=oi.dot(c,s);if(u+a<l)return 0;if(!(u-a>l)){oi.add(t,s,oi.multiplyScalar(t,c,a));for(var h=0;h<6;h++)if(h!==r&&h!==r+e[r]){var _=i.planes[h];if(oi.dot(_.n,t)<_.d)return 0}}}return 1}}(),Fs=function(t,e){var n=t.radius+e.radius;return oi.squaredDistance(t.center,e.center)<n*n},zs=function(){var t=new oi;return function(e,n){return Zi(t,e.center,n),oi.squaredDistance(e.center,t)<e.radius*e.radius}}(),Vs=function(){var t=new oi;return function(e,n){return $i(t,e.center,n),oi.squaredDistance(e.center,t)<e.radius*e.radius}}(),Gs=function(){var t=new oi,e=new oi;return function(n,i){var r=n.radius+i.radius,o=r*r,a=oi.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===a)return oi.squaredDistance(n.center,i.center)<o;oi.subtract(t,n.center,i.ellipseCenter0),oi.subtract(e,i.ellipseCenter1,i.ellipseCenter0);var s=oi.dot(t,e)/a;return s<0?oi.squaredDistance(n.center,i.ellipseCenter0)<o:s>1?oi.squaredDistance(n.center,i.ellipseCenter1)<o:(oi.scaleAndAdd(t,i.ellipseCenter0,e,s),oi.squaredDistance(n.center,t)<o)}}(),Us=function(){var t=new oi,e=new oi,n=new oi,i=new oi,r=new oi,o=new oi;return function(a,s){var c,l,u=oi.subtract(t,a.ellipseCenter1,a.ellipseCenter0),h=oi.subtract(e,s.ellipseCenter1,s.ellipseCenter0),_=oi.subtract(n,a.ellipseCenter0,s.ellipseCenter0),f=oi.dot(u,u),p=oi.dot(u,h),d=oi.dot(h,h),m=oi.dot(u,_),v=oi.dot(h,_),g=f*d-p*p,y=g,x=g;g<zn?(c=0,y=1,l=v,x=d):(l=f*v-p*m,(c=p*v-d*m)<0?(c=0,l=v,x=d):c>y&&(c=y,l=v+p,x=d)),l<0?(l=0,-m<0?c=0:-m>f?c=y:(c=-m,y=f)):l>x&&(l=x,-m+p<0?c=0:-m+p>f?c=y:(c=-m+p,y=f));var S=Math.abs(c)<zn?0:c/y,A=Math.abs(l)<zn?0:l/x,C=i;C.set(_),C.add(oi.multiplyScalar(r,u,S)),C.subtract(oi.multiplyScalar(o,h,A));var b=a.radius+s.radius;return C.lengthSqr()<b*b}}(),ks={raySphere:Ja,rayAABB:Qa,rayOBB:is,rayPlane:Ya,rayTriangle:Ka,rayCapsule:rs,raySubMesh:os,rayMesh:as,rayModel:ss,lineSphere:fs,lineAABB:hs,lineOBB:_s,linePlane:cs,lineTriangle:ls,sphereWithSphere:Fs,sphereAABB:zs,sphereOBB:Vs,spherePlane:Os,sphereFrustum:Ns,sphereFrustumAccurate:Ls,sphereCapsule:Gs,aabbWithAABB:gs,aabbWithOBB:bs,aabbPlane:Ts,aabbFrustum:Es,aabbFrustumAccurate:ws,obbWithOBB:Bs,obbPlane:Is,obbFrustum:Rs,obbFrustumAccurate:Ds,obbPoint:Ps,obbCapsule:Ms,capsuleWithCapsule:Us,resolve:function(t,e,n){void 0===n&&(n=null);var i=t._type,r=e._type,o=this[i|r];return i<r?o(t,e,n):o(e,t,n)}};ks[er.SHAPE_RAY|er.SHAPE_SPHERE]=Ja,ks[er.SHAPE_RAY|er.SHAPE_AABB]=Qa,ks[er.SHAPE_RAY|er.SHAPE_OBB]=is,ks[er.SHAPE_RAY|er.SHAPE_PLANE]=Ya,ks[er.SHAPE_RAY|er.SHAPE_TRIANGLE]=Ka,ks[er.SHAPE_RAY|er.SHAPE_CAPSULE]=rs,ks[er.SHAPE_LINE|er.SHAPE_SPHERE]=fs,ks[er.SHAPE_LINE|er.SHAPE_AABB]=hs,ks[er.SHAPE_LINE|er.SHAPE_OBB]=_s,ks[er.SHAPE_LINE|er.SHAPE_PLANE]=cs,ks[er.SHAPE_LINE|er.SHAPE_TRIANGLE]=ls,ks[er.SHAPE_SPHERE]=Fs,ks[er.SHAPE_SPHERE|er.SHAPE_AABB]=zs,ks[er.SHAPE_SPHERE|er.SHAPE_OBB]=Vs,ks[er.SHAPE_SPHERE|er.SHAPE_PLANE]=Os,ks[er.SHAPE_SPHERE|er.SHAPE_FRUSTUM]=Ns,ks[er.SHAPE_SPHERE|er.SHAPE_FRUSTUM_ACCURATE]=Ls,ks[er.SHAPE_SPHERE|er.SHAPE_CAPSULE]=Gs,ks[er.SHAPE_AABB]=gs,ks[er.SHAPE_AABB|er.SHAPE_OBB]=bs,ks[er.SHAPE_AABB|er.SHAPE_PLANE]=Ts,ks[er.SHAPE_AABB|er.SHAPE_FRUSTUM]=Es,ks[er.SHAPE_AABB|er.SHAPE_FRUSTUM_ACCURATE]=ws,ks[er.SHAPE_OBB]=Bs,ks[er.SHAPE_OBB|er.SHAPE_PLANE]=Is,ks[er.SHAPE_OBB|er.SHAPE_FRUSTUM]=Rs,ks[er.SHAPE_OBB|er.SHAPE_FRUSTUM_ACCURATE]=Ds,ks[er.SHAPE_OBB|er.SHAPE_CAPSULE]=Ms,ks[er.SHAPE_CAPSULE]=Us;var Hs,js,Ws,qs,Xs,Ys,Ks,Js=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=er.SHAPE_LINE,this.s=new oi(t,e,n),this.e=new oi(i,r,o)}return t.create=function(e,n,i,r,o,a){return new t(e,n,i,r,o,a)},t.clone=function(e){return new t(e.s.x,e.s.y,e.s.z,e.e.x,e.e.y,e.e.z)},t.copy=function(t,e){return oi.copy(t.s,e.s),oi.copy(t.e,e.e),t},t.fromPoints=function(t,e,n){return oi.copy(t.s,e),oi.copy(t.e,n),t},t.set=function(t,e,n,i,r,o,a){return t.s.x=e,t.s.y=n,t.s.z=i,t.e.x=r,t.e.y=o,t.e.z=a,t},t.len=function(t){return oi.distance(t.s,t.e)},t.prototype.length=function(){return oi.distance(this.s,this.e)},N(t,[{key:"type",get:function(){return this._type}}]),t}(),Qs=new oi(0,0,0),Zs=new oi(0,0,0),$s=i.mat4(),tc=i.v4(),ec=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=er.SHAPE_PLANE,this.n=new oi(t,e,n),this.d=i}return t.create=function(e,n,i,r){return new t(e,n,i,r)},t.clone=function(e){return new t(e.n.x,e.n.y,e.n.z,e.d)},t.copy=function(t,e){return oi.copy(t.n,e.n),t.d=e.d,t},t.fromPoints=function(t,e,n,i){return oi.subtract(Qs,n,e),oi.subtract(Zs,i,e),oi.normalize(t.n,oi.cross(t.n,Qs,Zs)),t.d=oi.dot(t.n,e),t},t.set=function(t,e,n,i,r){return t.n.x=e,t.n.y=n,t.n.z=i,t.d=r,t},t.fromNormalAndPoint=function(t,e,n){return oi.copy(t.n,e),t.d=oi.dot(e,n),t},t.normalize=function(t,e){var n=e.n.length();return oi.normalize(t.n,e.n),n>0&&(t.d=e.d/n),t},t.prototype.transform=function(t){Ei.invert($s,t),Ei.transpose($s,$s),fi.set(tc,this.n.x,this.n.y,this.n.z,this.d),fi.transformMat4(tc,tc,$s),oi.set(this.n,tc.x,tc.y,tc.z),this.d=tc.w},N(t,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(t){this.n.x=t}},{key:"y",get:function(){return this.n.y},set:function(t){this.n.y=t}},{key:"z",get:function(){return this.n.z},set:function(t){this.n.z=t}},{key:"w",get:function(){return this.d},set:function(t){this.d=t}}]),t}(),nc=function(){function t(t,e,n){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=n*(1<<e)}return t.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},t}();!function(t){t[t.UINT32=0]="UINT32",t[t.FLOAT32=1]="FLOAT32",t[t.NEVER=2]="NEVER"}(Ks||(Ks={}));var ic,rc,oc=function(){function t(t,e,n,i,r){void 0===r&&(r=8),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=i.COUNT,this._entryBits=r,this._dataType=e,this._dataMembers=n,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new nc(t,r,this._stride);var o=Ks.NEVER,a=!1,s=!1;for(var c in e){if(a=this._hasFloat32,(s=this._hasUint32)&&a)break;o=e[c],a||o!==Ks.FLOAT32?s||o!==Ks.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var e=t.prototype;return e.alloc=function(){for(var t=0;t<this._freeLists.length;t++){var e=this._freeLists[t];if(e.length){var n=e[e.length-1];return e.length--,(t<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),r=[],o=[],a=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&r.push(new Float32Array(i,this._stride*l,this._elementCount)),c&&o.push(new Uint32Array(i,this._stride*l,this._elementCount)),l&&a.push(l);return c&&this._uint32BufferViews.push(o),s&&this._float32BufferViews.push(r),this._freeLists.push(a),this._arrayBuffers.push(i),(t<<this._entryBits)+this._poolFlag},e.getBuffer=function(t){var e=(this._chunkMask&t)>>this._entryBits,n=this._entryMask&t;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[e][n]},e.getTypedArray=function(t,e){var n=(this._chunkMask&t)>>this._entryBits,i=this._entryMask&t,r=e,o=(this._dataType[e]===Ks.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i],a=this._dataMembers[e];return o.subarray(r,r+a)},e.free=function(t){var e=(this._chunkMask&t)>>this._entryBits,n=this._entryMask&t;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[e][n].fill(0),this._freeLists[e].push(n)},t}();!function(t){t[t.NODE=0]="NODE",t[t.PASS=1]="PASS",t[t.AABB=2]="AABB"}(ic||(ic={})),function(t){t[t.DIRTY_FLAG=0]="DIRTY_FLAG",t[t.LAYER=1]="LAYER",t[t.WORLD_SCALE=2]="WORLD_SCALE",t[t.WORLD_POSITION=5]="WORLD_POSITION",t[t.WORLD_ROTATION=8]="WORLD_ROTATION",t[t.WORLD_MATRIX=12]="WORLD_MATRIX",t[t.LOCAL_SCALE=28]="LOCAL_SCALE",t[t.LOCAL_POSITION=31]="LOCAL_POSITION",t[t.LOCAL_ROTATION=34]="LOCAL_ROTATION",t[t.COUNT=38]="COUNT"}(rc||(rc={}));var ac,sc=((Hs={})[rc.DIRTY_FLAG]=Ks.UINT32,Hs[rc.LAYER]=Ks.UINT32,Hs[rc.WORLD_SCALE]=Ks.FLOAT32,Hs[rc.WORLD_POSITION]=Ks.FLOAT32,Hs[rc.WORLD_ROTATION]=Ks.FLOAT32,Hs[rc.WORLD_MATRIX]=Ks.FLOAT32,Hs[rc.LOCAL_SCALE]=Ks.FLOAT32,Hs[rc.LOCAL_POSITION]=Ks.FLOAT32,Hs[rc.LOCAL_ROTATION]=Ks.FLOAT32,Hs[rc.COUNT]=Ks.NEVER,Hs),cc=((js={})[rc.DIRTY_FLAG]=rc.LAYER-rc.DIRTY_FLAG,js[rc.LAYER]=rc.WORLD_SCALE-rc.LAYER,js[rc.WORLD_SCALE]=rc.WORLD_POSITION-rc.WORLD_SCALE,js[rc.WORLD_POSITION]=rc.WORLD_ROTATION-rc.WORLD_POSITION,js[rc.WORLD_ROTATION]=rc.WORLD_MATRIX-rc.WORLD_ROTATION,js[rc.WORLD_MATRIX]=rc.LOCAL_SCALE-rc.WORLD_MATRIX,js[rc.LOCAL_SCALE]=rc.LOCAL_POSITION-rc.LOCAL_SCALE,js[rc.LOCAL_POSITION]=rc.LOCAL_ROTATION-rc.LOCAL_POSITION,js[rc.LOCAL_ROTATION]=rc.COUNT-rc.LOCAL_ROTATION,js[rc.COUNT]=1,js),lc=new oc(ic.NODE,sc,cc,rc);!function(t){t[t.PRIORITY=0]="PRIORITY",t[t.STAGE=1]="STAGE",t[t.PHASE=2]="PHASE",t[t.PRIMITIVE=3]="PRIMITIVE",t[t.BATCHING_SCHEME=4]="BATCHING_SCHEME",t[t.DYNAMIC_STATE=5]="DYNAMIC_STATE",t[t.HASH=6]="HASH",t[t.COUNT=7]="COUNT"}(ac||(ac={}));var uc,hc=((Ws={})[ac.PRIORITY]=Ks.UINT32,Ws[ac.STAGE]=Ks.UINT32,Ws[ac.PHASE]=Ks.UINT32,Ws[ac.PRIMITIVE]=Ks.UINT32,Ws[ac.BATCHING_SCHEME]=Ks.UINT32,Ws[ac.DYNAMIC_STATE]=Ks.UINT32,Ws[ac.HASH]=Ks.UINT32,Ws[ac.COUNT]=Ks.NEVER,Ws),_c=((qs={})[ac.PRIORITY]=ac.STAGE-ac.PRIORITY,qs[ac.STAGE]=ac.PHASE-ac.STAGE,qs[ac.PHASE]=ac.PRIMITIVE-ac.PHASE,qs[ac.PRIMITIVE]=ac.BATCHING_SCHEME-ac.PRIMITIVE,qs[ac.BATCHING_SCHEME]=ac.DYNAMIC_STATE-ac.BATCHING_SCHEME,qs[ac.DYNAMIC_STATE]=ac.HASH-ac.DYNAMIC_STATE,qs[ac.HASH]=ac.COUNT-ac.HASH,qs[ac.COUNT]=1,qs),fc=new oc(ic.PASS,hc,_c,ac);!function(t){t[t.CENTER=0]="CENTER",t[t.HALFEXTENTS=3]="HALFEXTENTS",t[t.COUNT=6]="COUNT"}(uc||(uc={}));var pc=((Xs={})[uc.CENTER]=Ks.FLOAT32,Xs[uc.HALFEXTENTS]=Ks.FLOAT32,Xs[uc.COUNT]=Ks.NEVER,Xs),dc=((Ys={})[uc.CENTER]=uc.HALFEXTENTS-uc.CENTER,Ys[uc.HALFEXTENTS]=uc.COUNT-uc.HALFEXTENTS,Ys[uc.COUNT]=1,Ys),mc=new oc(ic.AABB,pc,dc,uc),vc=new oi,gc=new oi,yc=new oi,xc=new oi,Sc=new di,Ac=function(t,e,n){Sc.m00=Math.abs(n.m00),Sc.m01=Math.abs(n.m01),Sc.m02=Math.abs(n.m02),Sc.m03=Math.abs(n.m04),Sc.m04=Math.abs(n.m05),Sc.m05=Math.abs(n.m06),Sc.m06=Math.abs(n.m08),Sc.m07=Math.abs(n.m09),Sc.m08=Math.abs(n.m10),oi.transformMat3(t,e,Sc)},Cc=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=er.SHAPE_AABB,this.center=new oi(t,e,n),this.halfExtents=new oi(i,r,o)}t.create=function(e,n,i,r,o,a){return new t(e,n,i,r,o,a)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z)},t.copy=function(t,e){return oi.copy(t.center,e.center),oi.copy(t.halfExtents,e.halfExtents),t},t.fromPoints=function(t,e,n){return oi.add(vc,n,e),oi.subtract(gc,n,e),oi.multiplyScalar(t.center,vc,.5),oi.multiplyScalar(t.halfExtents,gc,.5),t},t.set=function(t,e,n,i,r,o,a){return t.center.set(e,n,i),t.halfExtents.set(r,o,a),t},t.merge=function(e,n,i){return oi.subtract(vc,n.center,n.halfExtents),oi.subtract(gc,i.center,i.halfExtents),oi.add(yc,n.center,n.halfExtents),oi.add(xc,i.center,i.halfExtents),oi.max(xc,yc,xc),oi.min(yc,vc,gc),t.fromPoints(e,yc,xc)},t.toBoundingSphere=function(t,e){return t.center.set(e.center),t.radius=e.halfExtents.length(),t},t.transform=function(t,e,n){return oi.transformMat4(t.center,e.center,n),Ac(t.halfExtents,e.halfExtents,n),t};var e=t.prototype;return e.getBoundary=function(t,e){oi.subtract(t,this.center,this.halfExtents),oi.add(e,this.center,this.halfExtents)},e.transform=function(t,e,n,i,r){oi.transformMat4(r.center,this.center,t),Ac(r.halfExtents,this.halfExtents,t)},e.clone=function(){return t.clone(this)},e.copy=function(e){return t.copy(this,e)},e.mergePoint=function(t){this.getBoundary(vc,gc),t.x<vc.x&&(vc.x=t.x),t.y<vc.y&&(vc.y=t.y),t.z<vc.z&&(vc.z=t.z),t.x>gc.x&&(gc.x=t.x),t.y>gc.y&&(gc.y=t.y),t.z>gc.z&&(gc.z=t.z),oi.add(yc,vc,gc),this.center.set(oi.multiplyScalar(yc,yc,.5)),this.halfExtents.set(gc.x-yc.x,gc.y-yc.y,gc.z-yc.z)},e.mergePoints=function(t){if(!(t.length<1))for(var e=0;e<t.length;e++)this.mergePoint(t[e])},e.mergeFrustum=function(t){return this.mergePoints(t.vertices)},N(t,[{key:"type",get:function(){return this._type}},{key:"native",get:function(){return this._nativeObj}}]),t}(),bc=new oi,Tc=new oi,Ec=new di,wc=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h,_,f,p){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=er.SHAPE_OBB,this.center=new oi(t,e,n),this.halfExtents=new oi(i,r,o),this.orientation=new di(a,s,c,l,u,h,_,f,p)}t.create=function(e,n,i,r,o,a,s,c,l,u,h,_,f,p,d){return new t(e,n,i,r,o,a,s,c,l,u,h,_,f,p,d)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z,e.orientation.m00,e.orientation.m01,e.orientation.m02,e.orientation.m03,e.orientation.m04,e.orientation.m05,e.orientation.m06,e.orientation.m07,e.orientation.m08)},t.copy=function(t,e){return oi.copy(t.center,e.center),oi.copy(t.halfExtents,e.halfExtents),di.copy(t.orientation,e.orientation),t},t.fromPoints=function(t,e,n){return oi.multiplyScalar(t.center,oi.add(bc,e,n),.5),oi.multiplyScalar(t.halfExtents,oi.subtract(Tc,n,e),.5),di.identity(t.orientation),t},t.set=function(t,e,n,i,r,o,a,s,c,l,u,h,_,f,p,d){return oi.set(t.center,e,n,i),oi.set(t.halfExtents,r,o,a),di.set(t.orientation,s,c,l,u,h,_,f,p,d),t};var e=t.prototype;return e.getBoundary=function(t,e){!function(t,e,n){Ec.m00=Math.abs(n.m00),Ec.m01=Math.abs(n.m01),Ec.m02=Math.abs(n.m02),Ec.m03=Math.abs(n.m03),Ec.m04=Math.abs(n.m04),Ec.m05=Math.abs(n.m05),Ec.m06=Math.abs(n.m06),Ec.m07=Math.abs(n.m07),Ec.m08=Math.abs(n.m08),oi.transformMat3(t,e,Ec)}(bc,this.halfExtents,this.orientation),oi.subtract(t,this.center,bc),oi.add(e,this.center,bc)},e.transform=function(t,e,n,i,r){oi.transformMat4(r.center,this.center,t),di.fromQuat(r.orientation,n),oi.multiply(r.halfExtents,this.halfExtents,i)},e.translateAndRotate=function(t,e,n){oi.transformMat4(n.center,this.center,t),di.fromQuat(n.orientation,e)},e.setScale=function(t,e){oi.multiply(e.halfExtents,this.halfExtents,t)},N(t,[{key:"type",get:function(){return this._type}}]),t}(),Pc=function(){function t(t,e,n){void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===n&&(n=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=er.SHAPE_CAPSULE,this.radius=t,this.halfHeight=e,this.axis=n,this.center=new oi,this.rotation=new gi,this.ellipseCenter0=new oi(0,e,0),this.ellipseCenter1=new oi(0,-e,0),this.updateCache()}var e=t.prototype;return e.transform=function(t,e,n,i,r){var o=i,a=ni(o);r.radius=this.radius*Math.abs(a);var s=(this.halfHeight+this.radius)*Math.abs(o.y)-r.radius;s<0&&(s=0),r.halfHeight=s,oi.transformMat4(r.center,this.center,t),gi.multiply(r.rotation,this.rotation,n),r.updateCache()},e.updateCache=function(){this.updateLocalCenter(),oi.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),oi.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},e.updateLocalCenter=function(){var t=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(t,0,0),this.ellipseCenter1.set(-t,0,0);break;case 1:this.ellipseCenter0.set(0,t,0),this.ellipseCenter1.set(0,-t,0);break;case 2:this.ellipseCenter0.set(0,0,t),this.ellipseCenter1.set(0,0,-t)}},N(t,[{key:"type",get:function(){return this._type}}]),t}(),Ic=new Array(8);Ic[0]=new oi(1,1,1),Ic[1]=new oi(-1,1,1),Ic[2]=new oi(-1,-1,1),Ic[3]=new oi(1,-1,1),Ic[4]=new oi(1,1,-1),Ic[5]=new oi(-1,1,-1),Ic[6]=new oi(-1,-1,-1),Ic[7]=new oi(1,-1,-1);var Rc,Dc,Bc=new oi,Mc=new oi,Oc=new oi,Nc=function(){function t(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=er.SHAPE_FRUSTUM,this.planes=new Array(6);for(var t=0;t<6;++t)this.planes[t]=ec.create(0,0,0,0);this.vertices=new Array(8);for(var e=0;e<8;++e)this.vertices[e]=new oi}t.createFromAABB=function(t,e){var n=new oi,i=new oi;return oi.subtract(n,e.center,e.halfExtents),oi.add(i,e.center,e.halfExtents),t.vertices[0].set(n.x,i.y,n.z),t.vertices[1].set(i.x,i.y,n.z),t.vertices[2].set(i.x,n.y,n.z),t.vertices[3].set(n.x,n.y,n.z),t.vertices[4].set(n.x,i.y,i.z),t.vertices[5].set(i.x,i.y,i.z),t.vertices[6].set(i.x,n.y,i.z),t.vertices[7].set(n.x,n.y,i.z),t._type!==er.SHAPE_FRUSTUM_ACCURATE||t.updatePlanes(),t},t.split=function(t,e,n,i,r){var o=Math.tan(.5*e.fov),a=o*e.aspect;Bc.set(i*a,i*o,i),Mc.set(r*a,r*o,r);var s=t.vertices;return Oc.set(Bc.x,Bc.y,Bc.z),oi.transformMat4(s[0],Oc,n),Oc.set(-Bc.x,Bc.y,Bc.z),oi.transformMat4(s[1],Oc,n),Oc.set(-Bc.x,-Bc.y,Bc.z),oi.transformMat4(s[2],Oc,n),Oc.set(Bc.x,-Bc.y,Bc.z),oi.transformMat4(s[3],Oc,n),Oc.set(Mc.x,Mc.y,Mc.z),oi.transformMat4(s[4],Oc,n),Oc.set(-Mc.x,Mc.y,Mc.z),oi.transformMat4(s[5],Oc,n),Oc.set(-Mc.x,-Mc.y,Mc.z),oi.transformMat4(s[6],Oc,n),Oc.set(Mc.x,-Mc.y,Mc.z),oi.transformMat4(s[7],Oc,n),t.updatePlanes(),t},t.create=function(){return new t},t.clone=function(e){return t.copy(new t,e)},t.copy=function(t,e){t._type=e._type;for(var n=0;n<6;++n)ec.copy(t.planes[n],e.planes[n]);for(var i=0;i<8;++i)oi.copy(t.vertices[i],e.vertices[i]);return t};var e=t.prototype;return e.update=function(t,e){if(oi.set(this.planes[0].n,t.m03+t.m00,t.m07+t.m04,t.m11+t.m08),this.planes[0].d=-(t.m15+t.m12),oi.set(this.planes[1].n,t.m03-t.m00,t.m07-t.m04,t.m11-t.m08),this.planes[1].d=-(t.m15-t.m12),oi.set(this.planes[2].n,t.m03+t.m01,t.m07+t.m05,t.m11+t.m09),this.planes[2].d=-(t.m15+t.m13),oi.set(this.planes[3].n,t.m03-t.m01,t.m07-t.m05,t.m11-t.m09),this.planes[3].d=-(t.m15-t.m13),oi.set(this.planes[4].n,t.m03+t.m02,t.m07+t.m06,t.m11+t.m10),this.planes[4].d=-(t.m15+t.m14),oi.set(this.planes[5].n,t.m03-t.m02,t.m07-t.m06,t.m11-t.m10),this.planes[5].d=-(t.m15-t.m14),this._type===er.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],r=1/i.n.length();oi.multiplyScalar(i.n,i.n,r),i.d*=r}for(var o=0;o<8;o++)oi.transformMat4(this.vertices[o],Ic[o],e)}},e.transform=function(t){if(this._type===er.SHAPE_FRUSTUM_ACCURATE){for(var e=0;e<8;e++)oi.transformMat4(this.vertices[e],this.vertices[e],t);ec.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),ec.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),ec.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),ec.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),ec.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),ec.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])}},e.updatePlanes=function(){ec.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),ec.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),ec.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),ec.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),ec.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),ec.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])},N(t,[{key:"accurate",set:function(t){this._type=t?er.SHAPE_FRUSTUM_ACCURATE:er.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),t}();Nc.createOrtho=function(t,e,n,i,r,o){var a=e/2,s=n/2;oi.set(Oc,a,s,-i),oi.transformMat4(t.vertices[0],Oc,o),oi.set(Oc,-a,s,-i),oi.transformMat4(t.vertices[1],Oc,o),oi.set(Oc,-a,-s,-i),oi.transformMat4(t.vertices[2],Oc,o),oi.set(Oc,a,-s,-i),oi.transformMat4(t.vertices[3],Oc,o),oi.set(Oc,a,s,-r),oi.transformMat4(t.vertices[4],Oc,o),oi.set(Oc,-a,s,-r),oi.transformMat4(t.vertices[5],Oc,o),oi.set(Oc,-a,-s,-r),oi.transformMat4(t.vertices[6],Oc,o),oi.set(Oc,a,-s,-r),oi.transformMat4(t.vertices[7],Oc,o),ec.fromPoints(t.planes[0],t.vertices[1],t.vertices[6],t.vertices[5]),ec.fromPoints(t.planes[1],t.vertices[3],t.vertices[4],t.vertices[7]),ec.fromPoints(t.planes[2],t.vertices[6],t.vertices[3],t.vertices[7]),ec.fromPoints(t.planes[3],t.vertices[0],t.vertices[5],t.vertices[4]),ec.fromPoints(t.planes[4],t.vertices[2],t.vertices[0],t.vertices[3]),ec.fromPoints(t.planes[5],t.vertices[7],t.vertices[5],t.vertices[6])},function(t){t[t.Default=0]="Default",t[t.Normal=1]="Normal",t[t.Loop=2]="Loop",t[t.ShouldWrap=4]="ShouldWrap",t[t.Clamp=8]="Clamp",t[t.PingPong=22]="PingPong",t[t.Reverse=36]="Reverse"}(Rc||(Rc={})),function(t){t[t.Default=Rc.Default]="Default",t[t.Normal=Rc.Normal]="Normal",t[t.Reverse=Rc.Reverse]="Reverse",t[t.Loop=Rc.Loop]="Loop",t[t.LoopReverse=Rc.Loop|Rc.Reverse]="LoopReverse",t[t.PingPong=Rc.PingPong]="PingPong",t[t.PingPongReverse=Rc.PingPong|Rc.Reverse]="PingPongReverse"}(Dc||(Dc={})),$t(Dc);var Lc=function(){function t(t){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}return t.prototype.set=function(t){this.ratio=t.ratio,this.time=t.time,this.direction=t.direction,this.stopped=t.stopped,this.iterations=t.iterations,this.frameIndex=t.frameIndex},t}();function Fc(t,e,n){void 0===n&&(n=1e-6);for(var i=0,r=t.length-1,o=r>>>1;i<=r;o=i+r>>>1){var a=t[o];if(a>e+n)r=o-1;else{if(!(a<e-n))return o;i=o+1}}return~i}var zc=function(){},Vc=function(){return zc},Gc=Uc((function(){}));function Uc(t){return function(e){return"function"==typeof e?t(e):function(n){return t(n,e)}}}function kc(t){return function(e){return function(n){!function(t,e,n){var i=jc(t);if(i){var r=Wc(i,"proto");Wc(r,"editor")[e]=n}}(n,t,e)}}}var Hc="__ccclassCache__";function jc(t){return Wc(t,Hc)}function Wc(t,e){return t[e]||(t[e]={})}var qc=Uc((function(t,e){var n=kt.getSuper(t);n===Object&&(n=null);var i={name:e,extends:n,ctor:t},r=t[Hc];if(r){var o=r.proto;o&&kt.mixin(i,o),t[Hc]=void 0}return He(i)})),Xc=kc("requireComponent"),Yc=kc("executionOrder"),Kc=Gc;function Jc(t,e,n){var i=null;function r(t,e,n){var r=jc(t.constructor);if(r){var o=Wc(r,"proto"),a=Wc(o,"properties");!function(t,e,n,i,r,o){var a,s=r&&(r.get||r.set);i&&(a=Me(i,s));var c=e[n],l=kt.mixin(c||{},a||i||{});if(s)r.get&&(l.get=r.get),r.set&&(l.set=r.set);else if(r)r.initializer&&(l.default=function(t){var e;try{e=t()}catch(e){return t}return"object"!=typeof e||null===e?e:t}(r.initializer));else{var u=o.default||(o.default=function(t){var e;try{e=new t}catch(t){return{}}return e}(t));u.hasOwnProperty(n)&&(l.default=u[n])}e[n]=l}(t.constructor,a,e,i,n,r)}}return void 0===t?Jc({type:void 0}):void 0===e?(i=t,r):void r(t,e,n)}var Qc=Symbol("cc:SerializationMetadata"),Zc=function(t,e,n){return Jc(el({}))(t,e,n)};function $c(t){return Jc(el({formerlySerializedAs:t}))}var tl=function(t,e,n){return Jc({editorOnly:!0})(t,e,n)};function el(t){return t.__noImplicit=!0,"serializable"in t||(t.serializable=!0),t}var nl=zc,il=Gc,rl=Vc,ol=Gc,al=Vc,sl=Vc,cl=Vc,ll=zc,ul=Vc,hl=zc,_l=Vc,fl=Vc,pl=Vc,dl=Vc,ml=Vc,vl=Vc,gl=zc,yl=Vc,xl=zc,Sl=zc,Al=El(Ce),Cl=El(be),bl=El(Te),Tl=El(Ee);function El(t){return Jc({type:t})}var wl,Pl,Il,Rl,Dl,Bl,Ml,Ol,Nl,Ll=function(t,e,n){return Jc({__noImplicit:!0,override:!0})(t,e,n)},Fl=qc("cc.KeyframeCurve")((wl=Symbol.iterator,Bl=function(){function t(){q(this,"_times",Rl,this),q(this,"_values",Dl,this)}var e=t.prototype;return e[wl]=function(){var t=this,e=0;return{next:function(){if(e>=t._times.length)return{done:!0,value:void 0};var n=[t._times[e],t._values[e]];return++e,{done:!1,value:n}}}},e.keyframes=function(){return this},e.times=function(){return this._times},e.values=function(){return this._values},e.getKeyframeTime=function(t){return this._times[t]},e.getKeyframeValue=function(t){return this._values[t]},e.addKeyFrame=function(t,e){return this._insertNewKeyframe(t,e)},e.removeKeyframe=function(t){this._times.splice(t,1),this._values.splice(t,1)},e.indexOfKeyframe=function(t){return Fc(this._times,t)},e.updateTime=function(t,e){var n=this._values[t];this.removeKeyframe(t),this._insertNewKeyframe(e,n)},e.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.slice());else{var n=Array.from(t);this.setKeyframes(n.map((function(t){return t[0]})),n.map((function(t){return t[1]})))}},e.clear=function(){this._times.length=0,this._values.length=0},e.searchKeyframe=function(t){return Fc(this._times,t)},e.setKeyframes=function(t,e){t.length,e.length,function(t){t.every((function(t,e,n){return 0===e||t>n[e-1]||Gn(t,n[e-1],1e-6)}))}(t),this._times=t,this._values=e},e._insertNewKeyframe=function(t,e){var n=this._times,i=this._values,r=n.length,o=Fc(n,t);if(o>=0)return o;var a=~o;return 0===a?(n.unshift(t),i.unshift(e)):a===r?(n.push(t),i.push(e)):(n.splice(a-1,0,t),i.splice(a-1,0,e)),a},N(t,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}}]),t}(),Rl=X((Il=Bl).prototype,"_times",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Dl=X(Il.prototype,"_values",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pl=Il))||Pl;function zl(t){return t>-1e-9&&t<1e-9}!function(t){t[t.LINEAR=0]="LINEAR",t[t.CONSTANT=1]="CONSTANT",t[t.CUBIC=2]="CUBIC"}(Ml||(Ml=t("RealInterpolationMode",{}))),function(t){t[t.LINEAR=0]="LINEAR",t[t.CLAMP=1]="CLAMP",t[t.LOOP=2]="LOOP",t[t.PING_PONG=3]="PING_PONG"}(Ol||(Ol=t("ExtrapolationMode",{}))),function(t){t[t.NONE=0]="NONE",t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.BOTH=3]="BOTH"}(Nl||(Nl=t("TangentWeightMode",{})));var Vl=function(){},Gl=Object.freeze({__proto__:null,uniquelyReferenced:nl,ccclass:qc,property:Jc,requireComponent:Xc,executionOrder:Yc,disallowMultiple:Kc,allowReplicated:function(t){He.Attr.setClassAttr(t,"replicated","visible",!0)},executeInEditMode:il,menu:rl,playOnFocus:ol,inspector:al,icon:sl,help:cl,type:El,integer:Al,float:Cl,boolean:bl,string:Tl});t("_decorator",Gl);var Ul=function(){function t(t){this._map=null,this._count=0,t?(this._map=t,this._count=Object.keys(t).length):(this._map=kt.createMap(!0),this._count=0)}var e=t.prototype;return e.add=function(t,e){return t in this._map||this._count++,this._map[t]=e},e.get=function(t){return this._map[t]},e.has=function(t){return t in this._map},e.remove=function(t){var e=this._map[t];return t in this._map&&(delete this._map[t],this._count--),e},e.clear=function(){0!==this._count&&(this._map=kt.createMap(!0),this._count=0)},e.forEach=function(t){for(var e in this._map)t(this._map[e],e)},e.find=function(t){for(var e in this._map)if(t(this._map[e],e))return this._map[e];return null},e.destroy=function(){this._map=null},N(t,[{key:"count",get:function(){return this._count}}]),t}(),kl=function(){function t(e,n){this.id=t._pipelineId++,this.name="",this.pipes=[],this.name=e;for(var i=0,r=n.length;i<r;i++)this.pipes.push(n[i])}var e=t.prototype;return e.insert=function(t,e){return e>this.pipes.length?(b(4921),this):(this.pipes.splice(e,0,t),this)},e.append=function(t){return this.pipes.push(t),this},e.remove=function(t){return this.pipes.splice(t,1),this},e.sync=function(t){var e=this.pipes;if(0===e.length)return null;t.isFinish=!1;for(var n=0,i=e.length;n<i;){var r=(0,e[n])(t);if(r)return t.isFinish=!0,r;++n!==i&&(t.input=t.output,t.output=null)}return t.isFinish=!0,t.output},e.async=function(t){0!==this.pipes.length&&(t.isFinish=!1,this._flow(0,t))},e._flow=function(t,e){var n=this;(0,this.pipes[t])(e,(function(i){i?(e.isFinish=!0,e.dispatch("complete",i)):++t<n.pipes.length?(e.input=e.output,e.output=null,n._flow(t,e)):(e.isFinish=!0,e.dispatch("complete",i,e.output))}))},t}();kl._pipelineId=0,function(){function t(t){if(this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(t)for(var e in t)this._weakMap[e]=new WeakRef(t[e])}var e=t.prototype;e.add=function(t,e){return this._weakMap[t]=new WeakRef(e),e},e.has=function(t){return t in this._weakMap&&!!this._weakMap[t].deref()},e.get=function(t){return this._weakMap[t]&&this._weakMap[t].deref()},e.remove=function(t){var e=this._weakMap[t];return delete this._weakMap[t],e&&e.deref()},e.clear=function(){this._weakMap=kt.createMap(!0)},e.forEach=function(t){for(var e in this._weakMap){var n=this.get(e);n&&t(n,e)}},e.find=function(t){for(var e in this._weakMap){var n=this.get(e);if(n&&t(n,e))return this._weakMap[e].deref()}return null},e.destroy=function(){this._weakMap={}},N(t,[{key:"count",get:function(){return Object.values(this._weakMap).filter((function(t){return t.deref()})).length}}])}();var Hl,jl=new Ul,Wl=new Ul,ql=new Ul,Xl=new Ul,Yl=new kl("normal load",[]),Kl=new kl("fetch",[]),Jl=new kl("transform url",[]);!function(t){t.UUID="uuid",t.PATH="path",t.DIR="dir",t.URL="url",t.SCENE="scene"}(Hl||(Hl={}));var Ql,Zl={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(t){t.RESOURCES="resources",t.MAIN="main",t.START_SCENE="start-scene"}(Ql||(Ql={}));var $l=function(){function t(e){this.id=t._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(e)}t.create=function(e){var n;return 0!==t._deadPool.length?(n=t._deadPool.pop()).set(e):n=new t(e),n};var e=t.prototype;return e.set=function(t){void 0===t&&(t=Object.create(null)),this.onComplete=t.onComplete||null,this.onProgress=t.onProgress||null,this.onError=t.onError||null,this.source=this.input=t.input,this.output=null,this.progress=t.progress,this.options=t.options||Object.create(null)},e.dispatch=function(t,e,n,i,r){switch(t){case"complete":this.onComplete&&this.onComplete(e,n);break;case"progress":this.onProgress&&this.onProgress(e,n,i,r);break;case"error":this.onError&&this.onError(e,n,i,r);break;default:var o="on"+t[0].toUpperCase()+t.substr(1);"function"==typeof this[o]&&this[o](e,n,i,r)}},e.recycle=function(){t._deadPool.length!==t.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,t._deadPool.push(this))},t}();$l.MAX_DEAD_NUM=500,$l._taskId=0,$l._deadPool=[];var tu="0123456789abcdef".split(""),eu=["","","",""],nu=eu.concat(eu,"-",eu,"-",eu,"-",eu,"-",eu,eu,eu),iu=nu.map((function(t,e){return"-"===t?NaN:e})).filter(isFinite);function ru(t){var e=t.split("@")[0];if(22!==e.length)return t;nu[0]=t[0],nu[1]=t[1];for(var n=2,i=2;n<22;n+=2){var r=ae[t.charCodeAt(n)],o=ae[t.charCodeAt(n+1)];nu[iu[i++]]=tu[r>>2],nu[iu[i++]]=tu[(3&r)<<2|o>>4],nu[iu[i++]]=tu[15&o]}return t.replace(e,nu.join(""))}var ou=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function au(t,e){(e=e||Object.create(null)).__isNative__=e.isNative,e.ext=e.nativeExt;var n=Xl.find((function(e){return!!e.getAssetInfo(t)}));return n&&(e.bundle=n.name),lu(t,e)}function su(t){return!!t&&(t instanceof i.SceneAsset||t instanceof i.Scene)}function cu(t){return t&&(46===t.charCodeAt(0)&&47===t.charCodeAt(1)?t=t.slice(2):47===t.charCodeAt(0)&&(t=t.slice(1))),t}function lu(t,e){var n=$l.create({input:t,options:e}),i=[];try{for(var r,o=W(Jl.sync(n));!(r=o()).done;){var a=r.value,s=a.url;a.recycle(),i.push(s)}}catch(t){for(var c,l=W(n.output);!(c=l()).done;)c.value.recycle();d(t.message,t.stack)}return n.recycle(),i.length>1?i:i[0]}var uu,hu,_u,fu,pu,du,mu,vu,gu=Object.freeze({__proto__:null,getUuidFromURL:function(t){var e=ou.exec(t);return e?e[1]:""},getUrlWithUuid:au,isScene:su,normalize:cu,transform:lu,decodeUuid:ru}),yu=new(function(){function t(){this._finalizationRegistry=null}var e=t.prototype;return e.registerGCObject=function(t){return t},e.unregisterGCObject=function(){},e.init=function(){},e.finalizationRegistryCallback=function(t){t.isValid&&t.destroy()},e.destroy=function(){},t}()),xu=qc("cc.GCObject")(uu=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return e=t.call.apply(t,[this].concat(i))||this,yu.registerGCObject(H(e))||H(e)}F(e,t);var n=e.prototype;return n.equals=function(t){return!!t&&t===this},n.destroy=function(){return yu.unregisterGCObject(this),t.prototype.destroy.call(this)},e}(Je))||uu,Su=t("Asset",qc("cc.Asset")((pu=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).loaded=!0,q(e,"_native",fu,H(e)),e._nativeUrl="",e._file=null,e._ref=0,Object.defineProperty(H(e),"_uuid",{value:"",writable:!0}),e}F(e,t),e.deserialize=function(t){return i.deserialize(t)};var n=e.prototype;return n.toString=function(){return this.nativeUrl},n.serialize=function(){},n._setRawAsset=function(t,e){void 0===e&&(e=!0),this._native=!1!==e?t||"":"/"+t},n.addRef=function(){return this._ref++,this},n.decRef=function(t){return void 0===t&&(t=!0),this._ref>0&&this._ref--,t&&i.assetManager._releaseManager.tryRelease(this),this},n.onLoaded=function(){},n.initDefault=function(t){t&&(this._uuid=t),this.isDefault=!0},n.validate=function(){return!0},n.destroy=function(){return v(R(12101,this._uuid)),t.prototype.destroy.call(this)},N(e,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var t=this._native;if(47===t.charCodeAt(0))return t.slice(1);46===t.charCodeAt(0)?this._nativeUrl=au(this._uuid,{nativeExt:t,isNative:!0}):this._nativeUrl=au(this._uuid,{__nativeName__:t,nativeExt:xn(t),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(t){this._file=t}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),e}(sn(xu)),fu=X((_u=pu).prototype,"_native",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),X(_u.prototype,"_nativeAsset",[Jc],Object.getOwnPropertyDescriptor(_u.prototype,"_nativeAsset"),_u.prototype),hu=_u))||hu);Su.prototype.createNode=null,i.Asset=Su;var Au=t("Script",qc("cc.Script")(du=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(Su))||du);i._Script=Au;var Cu=t("JavaScript",qc("cc.JavaScript")(mu=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(Au))||mu);i._JavaScript=Cu;var bu,Tu,Eu,wu,Pu,Iu,Ru,Du,Bu,Mu,Ou,Nu=t("TypeScript",qc("cc.TypeScript")(vu=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(Au))||vu);i._TypeScript=Nu;var Lu,Fu,zu,Vu,Gu=new et("Comp"),Uu=Je.Flags.IsOnLoadCalled,ku=t("Component",(bu=qc("cc.Component"),Tu=_l(),Eu=El(Au),wu=fl(),bu((Ou=Mu=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"node",Ru,H(e)),q(e,"_enabled",Du,H(e)),q(e,"__prefab",Bu,H(e)),e._sceneGetter=null,e._id=Gu.getNewId(),e}F(e,t);var n=e.prototype;return n._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene},n.addComponent=function(t){return this.node.addComponent(t)},n.getComponent=function(t){return this.node.getComponent(t)},n.getComponents=function(t){return this.node.getComponents(t)},n.getComponentInChildren=function(t){return this.node.getComponentInChildren(t)},n.getComponentsInChildren=function(t){return this.node.getComponentsInChildren(t)},n.destroy=function(){return!!t.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&i.director._compScheduler.disableComp(this),!0)},n._onPreDestroy=function(){this.unscheduleAllCallbacks(),i.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},n._instantiate=function(t){return t||(t=i.instantiate._clone(this,this)),t&&(t.node=null),t},n.schedule=function(t,e,n,r){void 0===e&&(e=0),void 0===n&&(n=i.macro.REPEAT_FOREVER),void 0===r&&(r=0),I(t,1619),I((e=e||0)>=0,1620),n=Number.isNaN(n)?i.macro.REPEAT_FOREVER:n,r=r||0;var o=i.director.getScheduler(),a=o.isTargetPaused(this);o.schedule(t,this,e,n,r,a)},n.scheduleOnce=function(t,e){void 0===e&&(e=0),this.schedule(t,0,0,e)},n.unschedule=function(t){t&&i.director.getScheduler().unschedule(t,this)},n.unscheduleAllCallbacks=function(){i.director.getScheduler().unscheduleAllForTarget(this)},N(e,[{key:"name",get:function(){if(this._name)return this._name;var t=pt(this),e=t.lastIndexOf(".");return e>=0&&(t=t.slice(e+1)),this.node?this.node.name+"<"+t+">":t},set:function(t){this._name=t}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(t){if(this._enabled!==t&&(this._enabled=t,this.node.activeInHierarchy)){var e=i.director._compScheduler;t?e.enableComp(this):e.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&Uu}}]),e}(Je),Mu.system=null,X((Iu=Ou).prototype,"__scriptAsset",[Tu,Eu,wu,Sl],Object.getOwnPropertyDescriptor(Iu.prototype,"__scriptAsset"),Iu.prototype),Ru=X(Iu.prototype,"node",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Du=X(Iu.prototype,"_enabled",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Bu=X(Iu.prototype,"__prefab",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Pu=Iu))||Pu)),Hu=ku.prototype;Hu.update=null,Hu.lateUpdate=null,Hu.__preload=null,Hu.onLoad=null,Hu.start=null,Hu.onEnable=null,Hu.onDisable=null,Hu.onDestroy=null,Hu.onFocusInEditor=null,Hu.onLostFocusInEditor=null,Hu.resetInEditor=null,Hu._getLocalBounds=null,Hu.onRestore=null,ku._requireComponent=null,ku._executionOrder=0,lt(ku,"_registerEditorProps",(function(t,e){var n=e.requireComponent;n&&(Array.isArray(n)&&(n=n.filter(Boolean)),t._requireComponent=n);var i=e.executionOrder;i&&"number"==typeof i&&(t._executionOrder=i)})),i.Component=ku;var ju,Wu=t("MissingScript",qc("cc.MissingScript")(Lu=al()((Vu=function(t){function e(){var e;return q(e=t.call(this)||this,"_$erialized",zu,H(e)),e}return F(e,t),e.safeFindClass=function(t){var e=Ft(t);if(e)return e;i.deserialize.reportMissingClass(t)},e.prototype.onLoad=function(){b(4600,this.node.name)},e}(ku),zu=X((Fu=Vu).prototype,"_$erialized",[Zc,tl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Lu=Fu))||Lu)||Lu);i._MissingScript=Wu;try{var qu=Wu.__values__;0!==qu.length&&"_$erialized"===qu[qu.length-1]||(d("The '_$erialized' prop in MissingScript is missing. Please contact jare."),d("    Error props: ['"+qu+"']"))}catch(Ji){d("Error when checking MissingScript 5, "+Ji)}!function(t){t[t.PORTRAIT=1]="PORTRAIT",t[t.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",t[t.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",t[t.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",t[t.LANDSCAPE=12]="LANDSCAPE",t[t.AUTO=13]="AUTO"}(ju||(ju={}));var Xu,Yu={auto:ju.AUTO,landscape:ju.LANDSCAPE,portrait:ju.PORTRAIT};!function(t){t[t.Unknown=0]="Unknown",t[t.SubFrame=1]="SubFrame",t[t.BrowserWindow=2]="BrowserWindow",t[t.Fullscreen=3]="Fullscreen"}(Xu||(Xu={}));var Ku=new(function(t){function e(){var e,n,i,r,o,a;(e=t.call(this)||this).isFrameRotated=!1,e.handleResizeEvent=!0,e._gameFrame=void 0,e._gameContainer=void 0,e._gameCanvas=void 0,e._isProportionalToFrame=!1,e._cachedFrameStyle={width:"0px",height:"0px"},e._cachedContainerStyle={width:"0px",height:"0px"},e._cbToUpdateFrameBuffer=void 0,e._supportFullScreen=!1,e._touchEventName=void 0,e._onFullscreenChange=void 0,e._onFullscreenError=void 0,e._orientationChangeTimeoutId=-1,e._cachedFrameSize=new Di(0,0),e._exactFitScreen=!1,e._fn={},e._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],e._resolutionScale=1,e._orientation=ju.AUTO,e._gameFrame=document.getElementById("GameDiv"),e._gameContainer=document.getElementById("Cocos3dGameContainer"),e._gameCanvas=document.getElementById("GameCanvas"),e._gameFrame||(e._gameFrame=document.createElement("div"),e._gameFrame.setAttribute("id","GameDiv"),null===(n=e._gameCanvas)||void 0===n||null===(i=n.parentNode)||void 0===i||i.insertBefore(e._gameFrame,e._gameCanvas),e._gameFrame.appendChild(e._gameCanvas)),e._gameContainer||(e._gameContainer=document.createElement("div"),e._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(r=e._gameCanvas)||void 0===r||null===(o=r.parentNode)||void 0===o||o.insertBefore(e._gameContainer,e._gameCanvas),e._gameContainer.appendChild(e._gameCanvas));for(var s=e._fnGroup,c=0;c<s.length;c++)if(a=s[c],void 0!==document[a[1]]){for(var l=0;l<a.length;l++)e._fn[s[0][l]]=a[l];break}return e._supportFullScreen=void 0!==e._fn.requestFullscreen,e._touchEventName="ontouchstart"in window?"touchend":"mousedown",e._registerEvent(),e}F(e,t);var n=e.prototype;return n.init=function(t,e){this._cbToUpdateFrameBuffer=e,this.orientation=Yu[t.configOrientation],this._exactFitScreen=t.exactFitScreen,this._resizeFrame()},n.requestFullScreen=function(){var t=this;return new Promise((function(e,n){t.isFullScreen?e():(t._cachedFrameSize=t.windowSize,t._doRequestFullScreen().then((function(){e()})).catch((function(){var i=t._getFullscreenTarget();i?i.addEventListener(t._touchEventName,(function(){t._doRequestFullScreen().then((function(){e()})).catch(n)}),{once:!0,capture:!0}):n(new Error("Cannot access fullscreen target"))})))}))},n.exitFullScreen=function(){var t=this;return new Promise((function(e,n){var i=document[t._fn.exitFullscreen]();window.Promise&&i instanceof Promise?i.then((function(){t.windowSize=t._cachedFrameSize,e()})).catch(n):(t.windowSize=t._cachedFrameSize,e())}))},n._registerEvent=function(){var t=this;document.addEventListener(this._fn.fullscreenerror,(function(){var e;null===(e=t._onFullscreenError)||void 0===e||e.call(t)})),window.addEventListener("resize",(function(){t.handleResizeEvent&&t._resizeFrame()})),"function"==typeof window.matchMedia&&function e(){var n,i,r=window.devicePixelRatio;null===(n=window.matchMedia("(resolution: "+r+"dppx)"))||void 0===n||null===(i=n.addEventListener)||void 0===i||i.call(n,"change",(function(){t.emit("window-resize"),e()}),{once:!0})}(),window.addEventListener("orientationchange",(function(){-1!==t._orientationChangeTimeoutId&&clearTimeout(t._orientationChangeTimeoutId),t._orientationChangeTimeoutId=setTimeout((function(){t.handleResizeEvent&&(t._updateFrameState(),t._resizeFrame(),t.emit("orientation-change"),t._orientationChangeTimeoutId=-1)}),200)})),document.addEventListener(this._fn.fullscreenchange,(function(){var e;null===(e=t._onFullscreenChange)||void 0===e||e.call(t),t.emit("fullscreen-change")}))},n._convertToSizeInCssPixels=function(t){var e=t.clone(),n=this.devicePixelRatio;return e.width/=n,e.height/=n,e},n._resizeFrame=function(t){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===Xu.SubFrame){if(!t)return void this._updateContainer();this._gameFrame.style.width=t.width+"px",this._gameFrame.style.height=t.height+"px"}else{var e=window.innerWidth,n=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 "+e+"px",this._gameFrame.style.width=n+"px",this._gameFrame.style.height=e+"px"):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width=e+"px",this._gameFrame.style.height=n+"px")}this._updateContainer()}},n._getFullscreenTarget=function(){var t=this._windowType;return t===Xu.Fullscreen?document[this._fn.fullscreenElement]:t===Xu.SubFrame?this._gameFrame:document.body},n._doRequestFullScreen=function(){var t=this;return new Promise((function(e,n){if(t._supportFullScreen){var i=t._getFullscreenTarget();if(i){t._onFullscreenChange=void 0,t._onFullscreenError=void 0;var r=i[t._fn.requestFullscreen]();window.Promise&&r instanceof Promise?r.then(e).catch(n):(t._onFullscreenChange=e,t._onFullscreenError=n)}else n(new Error("Cannot access fullscreen target"))}else n(new Error("fullscreen is not supported"))}))},n._updateFrameState=function(){var t=this.orientation,e=window.innerWidth>window.innerHeight;this.isFrameRotated=dn.isMobile&&(e&&t===ju.PORTRAIT||!e&&t===ju.LANDSCAPE)},n._updateContainer=function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void b(9201);var t,e,n=i.view.getDesignResolutionSize(),r=this._gameFrame,o=r.clientWidth,a=r.clientHeight,s=n.width,c=n.height,l=o/s,u=a/c,h=this._gameContainer.style;l<u?(t=o,e=c*l):(t=s*u,e=a),h.width=t+"px",h.height=e+"px"}else{var _=this._gameContainer.style;_.width="100%",_.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize"),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else b(9201)},N(e,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){var t;return Math.min(null!==(t=window.devicePixelRatio)&&void 0!==t?t:1,2)}},{key:"windowSize",get:function(){var t=this._windowSizeInCssPixels,e=this.devicePixelRatio;return t.width*=e,t.height*=e,t},set:function(t){this._windowType===Xu.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(t)):b(9202)}},{key:"resolution",get:function(){var t=this.windowSize,e=this.resolutionScale;return new Di(t.width*e,t.height*e)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(t){var e;t!==this._resolutionScale&&(this._resolutionScale=t,null===(e=this._cbToUpdateFrameBuffer)||void 0===e||e.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(t){this._orientation!==t&&(this._orientation=t,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(t){this._isProportionalToFrame!==t&&(this._isProportionalToFrame=t,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new Di(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(b(9201),new Di(0,0));var t,e,n;switch(this._windowType){case Xu.SubFrame:return this._gameFrame?new Di(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(b(9201),new Di(0,0));case Xu.Fullscreen:return t=this._getFullscreenTarget(),e=this.isFrameRotated?t.clientHeight:t.clientWidth,n=this.isFrameRotated?t.clientWidth:t.clientHeight,new Di(e,n);case Xu.BrowserWindow:return e=this.isFrameRotated?window.innerHeight:window.innerWidth,n=this.isFrameRotated?window.innerWidth:window.innerHeight,new Di(e,n);case Xu.Unknown:default:return new Di(0,0)}}},{key:"_windowType",get:function(){return this.isFullScreen?Xu.Fullscreen:this._gameFrame?this._exactFitScreen?Xu.BrowserWindow:Xu.SubFrame:(b(9201),Xu.Unknown)}}]),e}(pn)),Ju=function(){function t(){}var e=t.prototype;return e._init=function(t){Ku.init(t,(function(){var t,e=i.director;(null===(t=e.root)||void 0===t?void 0:t.pipeline)?e.root.pipeline.pipelineSceneData.shadingScale=Ku.resolutionScale:b(1220)}))},e.fullScreen=function(){return Ku.isFullScreen},e.requestFullScreen=function(t,e,n){return arguments.length>0&&b(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),Ku.requestFullScreen().then((function(){null==e||e()})).catch((function(t){console.error(t),null==n||n()}))},e.exitFullScreen=function(){return Ku.exitFullScreen()},e.autoFullScreen=function(t,e){var n;null===(n=this.requestFullScreen(t,e))||void 0===n||n.catch((function(){}))},e.disableAutoFullScreen=function(){},N(t,[{key:"devicePixelRatio",get:function(){return Ku.devicePixelRatio}},{key:"windowSize",get:function(){return Ku.windowSize},set:function(t){Ku.windowSize=t}},{key:"resolution",get:function(){return Ku.resolution}},{key:"supportsFullScreen",get:function(){return Ku.supportFullScreen}}]),t}(),Qu=t("screen",new Ju);i.screen=Qu;var Zu=t("sys",{Feature:fn,hasFeature:function(t){return dn.hasFeature(t)},NetworkType:un,Language:ln,OS:hn,Platform:_n,BrowserType:cn,isNative:dn.isNative,isBrowser:dn.isBrowser,isMobile:dn.isMobile,isLittleEndian:dn.isLittleEndian,platform:dn.platform,language:dn.language,languageCode:dn.nativeLanguage,os:dn.os,osVersion:dn.osVersion,osMainVersion:dn.osMainVersion,browserType:dn.browserType,browserVersion:dn.browserVersion,windowPixelResolution:Qu.windowSize,capabilities:{canvas:!0,opengl:!0,webp:dn.hasFeature(fn.WEBP),imageBitmap:dn.hasFeature(fn.IMAGE_BITMAP),touches:dn.hasFeature(fn.INPUT_TOUCH),mouse:dn.hasFeature(fn.EVENT_MOUSE),keyboard:dn.hasFeature(fn.EVENT_KEYBOARD),accelerometer:dn.hasFeature(fn.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return dn.networkType},getBatteryLevel:function(){return dn.getBatteryLevel()},garbageCollect:function(){dn.triggerGC()},isObjectValid:function(t){return null!=t},dump:function(){var t="";t+="isMobile : "+this.isMobile+"\r\n",t+="language : "+this.language+"\r\n",t+="browserType : "+this.browserType+"\r\n",t+="browserVersion : "+this.browserVersion+"\r\n",t+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",t+="os : "+this.os+"\r\n",t+="osVersion : "+this.osVersion+"\r\n",t+="platform : "+this.platform+"\r\n",f(t+="Using "+(i.game.renderType===i.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(t){dn.openURL(t)},now:function(){return dn.now()},restartVM:function(){dn.restartJSVM()},getSafeAreaRect:function(){var t=i.view,e=Ku.safeAreaEdge,n=Ku.windowSize,r=new li(e.left,e.bottom),o=new li(n.width-e.right,n.height-e.top);t._convertToUISpace(r),t._convertToUISpace(o);var a=r.x,s=r.y,c=o.x-r.x,l=o.y-r.y;return new Mi(a,s,c,l)}});!function(){try{var t=Zu.localStorage=window.localStorage;t.setItem("storage",""),t.removeItem("storage"),t=null}catch(t){var e=function(){b(5200)};Zu.localStorage={getItem:e,setItem:e,clear:e,removeItem:e}}Zu.__isWebIOS14OrIPadOS14Env=(Zu.os===hn.IOS||Zu.os===hn.OSX)&&dn.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent)}(),i.sys=Zu;var $u=t("serializeTag",Symbol("[[Serialize]]")),th=t("deserializeTag",Symbol("[[Deserialize]]")),eh=function(){function t(t,e){this._document=void 0,this._chunks=void 0,this._document=t,this._chunks=e}return N(t,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),t}();function nh(t){var e=t;return{chunks:e.chunks,document:e.document}}function ih(t){if(t.length<16)throw new rh(R(13102));var e=new DataView(t.buffer,t.byteOffset,t.byteLength);if(1313817411!==e.getUint32(0,!0))throw new rh(R(13100));var n=e.getUint32(4,!0);if(1!==n)throw new rh(R(13101,n));if(e.getUint32(8,!0)!==e.byteLength)throw new rh(R(13102));var i=12,r=e.getUint32(i,!0);i+=4;var o=new Uint8Array(e.buffer,i+e.byteOffset,r);i+=r;var a,s=function(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);if("Buffer"in globalThis)return globalThis.Buffer.from(t.buffer,t.byteOffset,t.byteLength).toString();throw new Error(R(13104))}(o);try{a=JSON.parse(s)}catch(t){throw new rh(t)}for(var c=[];i<e.byteLength;){i%8!=0&&(i+=8-i%8);var l=e.getUint32(i,!0);i+=4,c.push(new Uint8Array(e.buffer,i+e.byteOffset,l)),i+=l}if(i!==e.byteLength)throw new rh(R(13102));return new eh(a,c)}var rh=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(k(Error));function oh(t,e,n,r,o){if(e instanceof i.ValueType){o||t.push("if(prop){");var a=pt(e);t.push("s._deserializeFastDefinedObject(o"+n+",prop,"+a+");"),o||t.push("}else o"+n+"=null;")}else t.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, "+r+");\n} else {\n    o"+n+"=null;\n}\n")}!function(){function t(){this._viewOrPaddings=[],this._length=0}var e=t.prototype;e.alignAs=function(t){if(0!==t){var e=this._length%t;if(0!==e){var n=t-e;return this._viewOrPaddings.push(n),this._length+=n,n}}return 0},e.append=function(t){var e=this._length;return this._viewOrPaddings.push(t),this._length+=t.byteLength,e},e.get=function(){var t=new Uint8Array(this._length),e=0;return this._viewOrPaddings.forEach((function(n){"number"==typeof n?e+=n:(t.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),e),e+=n.byteLength)})),t},N(t,[{key:"byteLength",get:function(){return this._length}}])}(),i.internal.parseCCONJson=nh,i.internal.decodeCCONBinary=ih,i.internal.CCON=eh;var ah="$_$default",sh="$_$formerlySerializedAs",ch=function(t){function e(){return t.call(this,(function(t){t.clear()}),1)||this}return F(e,t),e.prototype.get=function(t,e,n,i,r){var o=this._get();return o?(o.reset(t,e,n,i,r),o):new lh(t,e,n,i,r)},e}(Gt),lh=function(){function t(t,e,n,i){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=t,this.customEnv=i,this.deserializedList=[],this.deserializedData=null,this._classFinder=e,this._reportMissingClass=n,this._onDereferenced=null==e?void 0:e.onDereferenced}var e=t.prototype;return e.reset=function(t,e,n,i){this.result=t,this.customEnv=i,this._classFinder=e,this._reportMissingClass=n,this._onDereferenced=null==e?void 0:e.onDereferenced},e.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},e.deserialize=function(t){var e,n=!1;t instanceof eh?(n=!0,e=t.document,t.chunks.length>0&&(t.chunks.length,this._mainBinChunk=t.chunks[0])):e=t,this._serializedData=e,this._context={fromCCON:n};var i=Array.isArray(e)?e[0]:e;return this.deserializedData=this._deserializeObject(i,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},e._deserializeObject=function(t,e,n,i){switch(t.__type__){case"TypedArray":return this._deserializeTypedArrayView(t);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(t);default:return t.__type__?this._deserializeTypeTaggedObject(t,e,n,i):Array.isArray(t)?this._deserializeArray(t):this._deserializePlainObject(t)}},e._deserializeTypedArrayView=function(t){return globalThis[t.ctor].from(t.array)},e._deserializeTypedArrayViewRef=function(t){var e=t.offset,n=t.length,i=t.ctor;return new globalThis[i](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+e,n)},e._deserializeArray=function(t){for(var e,n=new Array(t.length),i=0;i<t.length;i++)"object"==typeof(e=t[i])&&e?this._deserializeAndAssignField(n,e,""+i)&&(n[i]=null):n[i]=e;return n},e._deserializePlainObject=function(t){var e={};return this._fillPlainObject(e,t),e},e._deserializeTypeTaggedObject=function(t,e,n,i){var r=this,o=t.__type__,a=this._classFinder(o,t,n,i);if(!a)return this._classFinder===Ft&&this._reportMissingClass(o),null;var s=function(t){var n=new t;return e>=0&&(r.deserializedList[e]=n),n}(a);return this._deserializeInto(t,s,a),s},e._deserializeInto=function(t,e,n,r){void 0===r&&(r=!1),r||!e[th]?e._deserialize?e._deserialize(t.content,this):i.Class._isCCClass(n)?this._deserializeFireClass(e,t,n):this._deserializeFastDefinedObject(e,t,n):this._runCustomizedDeserialize(t,e,n)},e._runCustomizedDeserialize=function(t,e,n){var i=this,r={readProperty:function(e){var n=t[e];return"object"==typeof n&&n?i._deserializeObjectField(n):n},readThis:function(){i._deserializeInto(t,e,n,!0)},readSuper:function(){var r=Et(n);r&&i._deserializeInto(t,e,r)}};e[th](r,this._context)},e._deserializeFireClass=function(t,e,n){var r;if(n.hasOwnProperty("__deserialize__"))r=n.__deserialize__;else{r=function(t,e){for(var n=xe(e),r=e.__values__,o=["var prop;"],a=ne.test(Vt(e)),s=0;s<r.length;s++){var c=r[s],l=void 0,u=void 0;He.IDENTIFIER_RE.test(c)?(u='"'+c+'"',l="."+c):l="["+(u=He.escapeForJS(c))+"]";var h=l;if(n[c+sh]){var _=n[c+sh];h=He.IDENTIFIER_RE.test(_)?"."+_:"["+He.escapeForJS(_)+"]"}o.push("prop=d"+h+";"),o.push('if(typeof prop!=="undefined"){');var f=He.getDefault(n[c+ah]);if(a){var p=void 0,d=n[c+"$_$type"];if(void 0===f&&d)p=d instanceof Ae;else{var m=typeof f;p="string"===m||"number"===m||"boolean"===m}p?o.push("o"+l+"=prop;"):oh(o,f,l,u,!0)}else o.push('if(typeof prop!=="object"){o'+l+"=prop;}else{"),oh(o,f,l,u,!1),o.push("}");o.push("}")}return(i.js.isChildClassOf(e,i._BaseNode)||i.js.isChildClassOf(e,i.Component))&&o.push("d._id&&(o._id=d._id);"),"_$erialized"===r[r.length-1]&&(o.push("o._$erialized=JSON.parse(JSON.stringify(d));"),o.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",o.join(""))}(0,n);try{if(n===Wu){var o=n.__values__;0!==o.length&&"_$erialized"===o[o.length-1]||(d("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),d("    Error props: ['"+o+"']. Please contact jare."));var a=r;r=function(t,e,n,i){try{JSON.parse(JSON.stringify(n._$erialized))||d("Unable to load previously serialized data. "+JSON.stringify(n))}catch(t){d("Error when checking MissingScript 7, "+t)}a(t,e,n,i)}}}catch(t){d("Error when checking MissingScript 6, "+t)}lt(n,"__deserialize__",r,!0)}r(this,t,e,n)},e._deserializeAndAssignField=function(t,e,n){var i=e.__id__;if("number"==typeof i){var r=this.deserializedList[i];if(r)t[n]=r;else{var o,a=this._serializedData[i];t[n]=this._deserializeObject(a,i,void 0,n),null===(o=this._onDereferenced)||void 0===o||o.call(this,this.deserializedList,i,t,n)}}else{var s=e.__uuid__;if(s){var c=e.__expectedType__;this.result.push(t,n,s,c)}else t[n]=this._deserializeObject(e,-1)}return!1},e._deserializeObjectField=function(t){var e=t.__id__;if("number"==typeof e){var n=this.deserializedList[e];if(n)return n;var i=this._serializedData[e];return this._deserializeObject(i,e,void 0,void 0)}if(t.__uuid__)throw t.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(t,-1)},e._fillPlainObject=function(t,e){for(var n in e)if(e.hasOwnProperty(n)){var i=e[n];"object"!=typeof i?"__type__"!==n&&(t[n]=i):i?this._deserializeAndAssignField(t,i,n)&&(t[n]=null):t[n]=null}},e._deserializeFastDefinedObject=function(t,e,n){if(n===i.Vec2)return t.x=e.x||0,void(t.y=e.y||0);if(n===i.Vec3)return t.x=e.x||0,t.y=e.y||0,void(t.z=e.z||0);if(n!==i.Color){if(n===i.Size)return t.width=e.width||0,void(t.height=e.height||0);for(var r=xe(n),o=n.__values__,a=0;a<o.length;a++){var s=o[a],c=e[s];void 0!==c||e.hasOwnProperty(s)||(c=He.getDefault(r[s+ah])),"object"!=typeof c?t[s]=c:c?this._deserializeAndAssignField(t,c,s):t[s]=null}}else{t.r=e.r||0,t.g=e.g||0,t.b=e.b||0;var l=e.a;t.a=void 0===l?255:l}},t}();lh.pool=new ch;var uh=[li,oi,fi,gi,Li,Di,Mi,Ei];function hh(t,e){t.x=e[1],t.y=e[2],t.z=e[3],t.w=e[4]}var _h=[function(t,e){t.x=e[1],t.y=e[2]},function(t,e){t.x=e[1],t.y=e[2],t.z=e[3]},hh,hh,function(t,e){t._val=e[1]},function(t,e){t.width=e[1],t.height=e[2]},function(t,e){t.x=e[1],t.y=e[2],t.width=e[3],t.height=e[4]},function(t,e){Ei.fromArray(t,e,1)}],fh=t("Details",function(){function t(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var e=t.prototype;return e.init=function(t){t?(this.uuidObjList=t[8],this.uuidPropList=t[9],this.uuidList=t[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},e.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},e.push=function(t,e,n,i){this.uuidObjList.push(t),this.uuidPropList.push(e),this.uuidList.push(n),this.uuidTypeList.push(i||"")},t}());function ph(t,e){for(var n=t[4][e[0]],i=n[0],r=new(0,i[0]),o=i[1],a=i[2],s=n[n.length-1],c=1;c<s;++c)r[o[n[c]]]=e[c];for(;c<e.length;++c){var l=o[n[c]],u=i[n[c]+a];(0,xh[u])(t,r,l,e[c])}return r}function dh(t,e,n){var i=new e;return i._deserialize?i._deserialize(n,t[0]):E(5303,pt(e)),i}function mh(t,e,n,i){i>=0?e[n]=t[5][i]:t[7][3*~i]=e}function vh(t){return function(e,n,i,r){n[i]=r;for(var o=0;o<r.length;++o)t(e,r,o,r[o])}}function gh(t,e,n,i){e[n]=null,t[8][i]=e}function yh(t,e,n,i){e[n]=ph(t,i)}fh.pool=new Gt((function(t){t.reset()}),5),fh.pool.get=function(){return this._get()||new fh};var xh=new Array(13);function Sh(t,e,n){return t||n(e),Object}function Ah(t,e,n,i,r,o,a){var s=t(e);if(!s){if(r)return void(n[i]=function(e,n,i){return function(){var r=t(i)||Sh(o,i,a);return e[n]=r,new r}}(n,i,e));s=Sh(o,e,a)}n[i]=s}function Ch(t,e,n,i){for(var r=n||Ft,o=t[3],a=0;a<o.length;++a){var s=o[a];"string"!=typeof s?Ah(r,s[0],s,0,e,n,i):Ah(r,s,o,a,e,n,i)}}function bh(t){var e=t[4];if(e)for(var n=t[3],i=0;i<e.length;++i){var r=e[i];r[0]=n[r[0]]}}function Th(t,e,n){"string"==typeof t&&(t=JSON.parse(t));var r,o=!e;if(e=e||fh.pool.get(),function(t){if(Array.isArray(t)){var e=t[0];return"number"==typeof e||e instanceof Eh}return!1}(t)){e.init(t),n=n||{};var a,s=t[0],c=!1;if("object"==typeof s&&(c=s.preprocessed,s=s.version),s<1)throw new Error(R(5304,s));n._version=s,n.result=e,t[0]=n,c||(Ch(t,!1,n.classFinder,null!==(a=n.reportMissingClass)&&void 0!==a?a:Th.reportMissingClass),bh(t)),i.game._isCloning=!0;var l=t[5],u=function(t){var e=t[5],n=t[6],i=0===n?0:n.length,r=e[e.length-1],o=e.length-i;"number"!=typeof r?r=0:(r<0&&(r=~r),--o);for(var a=0;a<o;++a)e[a]=ph(t,e[a]);for(var s=t[3],c=0;c<i;++c,++a){var l=n[c],u=e[a];if(l>=0){var h=s[l];e[a]=dh(t,h,u)}else(0,xh[l=~l])(t,e,a,u)}return r}(t);i.game._isCloning=!1,t[7]&&function(t,e,n){for(var i=t.length-1,r=0,o=3*t[i];r<o;r+=3){var a=t[r],s=e[t[r+2]],c=t[r+1];c>=0?a[n[c]]=s:a[~c]=s}for(;r<i;r+=3){var l=e[t[r]],u=e[t[r+2]],h=t[r+1];h>=0?l[n[h]]=u:l[~h]=u}}(t[7],l,t[2]),function(t){for(var e=t[5],n=t[2],i=t[1],r=t[8],o=t[9],a=t[10],s=0;s<r.length;++s){var c=r[s];"number"==typeof c&&(r[s]=e[c]);var l=o[s];"number"==typeof l&&(l=l>=0?n[l]:~l,o[s]=l);var u=a[s];"number"==typeof u&&(a[s]=i[u])}}(t),r=l[u]}else r=function(t,e,n){var r,o=(n=n||{}).classFinder||Ft,a=n.createAssetRefs||Zu.platform===_n.EDITOR_CORE,s=n.customEnv,c=n.ignoreEditorOnly,l=null!==(r=n.reportMissingClass)&&void 0!==r?r:i.deserialize.reportMissingClass;e.init();var u=lh.pool.get(e,o,l,s,c);i.game._isCloning=!0;var h=u.deserialize(t);return i.game._isCloning=!1,lh.pool.put(u),a&&e.assignAssetsBy(EditorExtends.serialize.asAsset),h}(t,e,n);return o&&fh.pool.put(e),r}xh[0]=function(t,e,n,i){e[n]=i},xh[1]=mh,xh[2]=vh(mh),xh[3]=vh(gh),xh[4]=yh,xh[5]=function(t,e,n,i){_h[i[0]](e[n],i)},xh[6]=gh,xh[7]=function(t,e,n,i){e[n].set(i)},xh[8]=function(t,e,n,i){var r=new uh[i[0]];_h[i[0]](r,i),e[n]=r},xh[9]=vh(yh),xh[10]=function(t,e,n,i){var r=t[3][i[0]];e[n]=dh(t,r,i[1])},xh[11]=function(t,e,n,i){var r=i[0];e[n]=r;for(var o=1;o<i.length;o+=3){var a=i[o],s=i[o+1],c=i[o+2];(0,xh[s])(t,r,a,c)}},xh[12]=function(t,e,n,i){var r=i[0];e[n]=r;for(var o=0;o<r.length;++o){var a=r[o],s=i[o+1];0!==s&&(0,xh[s])(t,r,o,a)}},Th.Details=fh,Th.reportMissingClass=function(t){E(5302,t)};var Eh=function(t){this.preprocessed=!0,this.version=t};function wh(t,e,n){return[1,0,0,[t],0,n?[e,-1]:[e],[0],0,[],[],[]]}i.deserialize=Th;var Ph,Ih,Rh,Dh,Bh,Mh,Oh,Nh,Lh,Fh,zh,Vh=Je.Flags.Destroyed,Gh=Je.Flags.PersistentMask,Uh=[];function kh(t){var e;if(t instanceof Je){if(t._instantiate)return i.game._isCloning=!0,e=t._instantiate(null,!0),i.game._isCloning=!1,e;if(t instanceof i.Asset)throw new TypeError(R(6903))}return i.game._isCloning=!0,e=Hh(t),i.game._isCloning=!1,e}function Hh(t,e){var n;jh(t,n=t._iN$t?t._iN$t:t.constructor?new(0,t.constructor):Object.create(null),e);for(var i=0,r=Uh.length;i<r;++i)Uh[i]._iN$t=null;return Uh.length=0,n}function jh(t,e,n){kt.value(t,"_iN$t",e,!0),Uh.push(t);var r=t.constructor;if(i.Class._isCCClass(r))!function(t,e,n,i){for(var r=t.__values__,o=0;o<r.length;o++){var a=r[o],s=e[a];if("object"==typeof s&&s){var c=n[a];c instanceof te&&c.constructor===s.constructor?c.set(s):n[a]=s._iN$t||Wh(s,i)}else n[a]=s}}(r,t,e,n);else for(var o in t)if(t.hasOwnProperty(o)&&(95!==o.charCodeAt(0)||95!==o.charCodeAt(1)||"__type__"===o||"__prefab"===o)){var a=t[o];if("object"==typeof a&&a){if(a===e)continue;e[o]=a._iN$t||Wh(a,n)}else e[o]=a}t instanceof Je&&(e._objFlags&=Gh)}function Wh(t,e){if(t instanceof te)return t.clone();if(t instanceof i.Asset)return t;var n;if(ArrayBuffer.isView(t)){var r=t.length;n=new t.constructor(r),t._iN$t=n,Uh.push(t);for(var o=0;o<r;++o)n[o]=t[o];return n}if(Array.isArray(t)){var a=t.length;n=new Array(a),t._iN$t=n,Uh.push(t);for(var s=0;s<a;++s){var c=t[s];n[s]="object"==typeof c&&c?c._iN$t||Wh(c,e):c}return n}if(t._objFlags&Vh)return null;var l=t.constructor;if(i.Class._isCCClass(l)){if(e)if(e instanceof i.Component){if(t instanceof i._BaseNode||t instanceof i.Component)return t}else if(e instanceof i._BaseNode)if(t instanceof i._BaseNode){if(!t.isChildOf(e))return t}else if(t instanceof i.Component&&t.node&&!t.node.isChildOf(e))return t;n=new l}else if(l===Object)n={};else{if(l)return t;n=Object.create(null)}return jh(t,n,e),n}function qh(t,e){return(e<<3)+t}function Xh(t){return Kh[t]}function Yh(t){switch(t){case Fh.Uint8:return Uint8Array;case Fh.Uint16:return Uint16Array;case Fh.Uint32:return Uint32Array;case Fh.Int8:return Int8Array;case Fh.Int16:return Int16Array;case Fh.Int32:return Int32Array;case Fh.Float32:return Float32Array;case Fh.Float64:return Float64Array}}kh._clone=Hh,i.instantiate=kh,function(t){t[t.Uint8=0]="Uint8",t[t.Uint16=1]="Uint16",t[t.Uint32=2]="Uint32",t[t.Int8=3]="Int8",t[t.Int16=4]="Int16",t[t.Int32=5]="Int32",t[t.Float32=6]="Float32",t[t.Float64=7]="Float64"}(Fh||(Fh={})),function(t){t[t.Scalar=0]="Scalar",t[t.Vec2=1]="Vec2",t[t.Vec3=2]="Vec3",t[t.Vec4=3]="Vec4",t[t.Quat=4]="Quat",t[t.Mat4=5]="Mat4"}(zh||(zh={})),t("CompactValueTypeArray",qc("cc.CompactValueTypeArray")((Nh=Oh=function(){function t(){q(this,"_byteOffset",Rh,this),q(this,"_unitCount",Dh,this),q(this,"_unitElement",Bh,this),q(this,"_length",Mh,this)}return t.lengthFor=function(t,e,n){return Xh(e).requiredUnits*t.length*Yh(n).BYTES_PER_ELEMENT},t.compress=function(e,n,i,r,o,a){for(var s=Xh(n),c=Yh(i),l=s.requiredUnits*e.length,u=new c(r,o,l),h=0;h<e.length;++h)s.compress(u,h,e[h]);var _=new t;return _._unitElement=qh(i,n),_._byteOffset=a,_._unitCount=l,_._length=e.length,_},t.prototype.decompress=function(t){for(var e,n={storageUnit:7&(e=this._unitElement),elementType:e>>3},i=n.storageUnit,r=Xh(n.elementType),o=new(Yh(i))(t,this._byteOffset,this._unitCount),a=new Array(this._length),s=0;s<this._length;++s)a[s]=r.decompress(o,s);return a},t}(),Oh.StorageUnit=Fh,Oh.ElementType=zh,Rh=X((Ih=Nh).prototype,"_byteOffset",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Dh=X(Ih.prototype,"_unitCount",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bh=X(Ih.prototype,"_unitElement",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qh(Fh.Uint8,zh.Scalar)}}),Mh=X(Ih.prototype,"_length",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ph=Ih))||Ph);var Kh=((Lh={})[zh.Scalar]={requiredUnits:1,compress:function(t,e,n){t[e]=n},decompress:function(t,e){return t[e]}},Lh[zh.Vec2]={requiredUnits:2,compress:function(t,e,n){t[2*e]=n.x,t[2*e+1]=n.y},decompress:function(t,e){return new oi(t[2*e],t[2*e+1])}},Lh[zh.Vec3]={requiredUnits:3,compress:function(t,e,n){t[3*e]=n.x,t[3*e+1]=n.y,t[3*e+2]=n.z},decompress:function(t,e){return new oi(t[3*e],t[3*e+1],t[3*e+2])}},Lh[zh.Vec4]={requiredUnits:4,compress:function(t,e,n){t[4*e]=n.x,t[4*e+1]=n.y,t[4*e+2]=n.z,t[4*e+3]=n.w},decompress:function(t,e){return new fi(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])}},Lh[zh.Quat]={requiredUnits:4,compress:function(t,e,n){t[4*e]=n.x,t[4*e+1]=n.y,t[4*e+2]=n.z,t[4*e+3]=n.w},decompress:function(t,e){return new gi(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])}},Lh[zh.Mat4]={requiredUnits:16,compress:function(t,e,n){Ei.toArray(t,n,16*e)},decompress:function(t,e){return Ei.fromArray(new Ei,t,16*e)}},Lh);function Jh(){return 0}function Qh(t){return t}function Zh(t){return t*t}function $h(t){return t*(2-t)}function t_(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}function e_(t){return t*t*t}function n_(t){return--t*t*t+1}function i_(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}function r_(t){return t*t*t*t}function o_(t){return 1- --t*t*t*t}function a_(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)}function s_(t){return t*t*t*t*t}function c_(t){return--t*t*t*t*t+1}function l_(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)}function u_(t){return 1===t?1:1-Math.cos(t*Math.PI/2)}function h_(t){return Math.sin(t*Math.PI/2)}function __(t){return.5*(1-Math.cos(Math.PI*t))}function f_(t){return 0===t?0:Math.pow(1024,t-1)}function p_(t){return 1===t?1:1-Math.pow(2,-10*t)}function d_(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))}function m_(t){return 1-Math.sqrt(1-t*t)}function v_(t){return Math.sqrt(1- --t*t)}function g_(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}function y_(t){var e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4))}function x_(t){var e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*t)*Math.sin(2*(t-e)*Math.PI/.4)+1)}function S_(t){var e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),(t*=2)<1?n*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*.5+1)}function A_(t){if(1===t)return 1;var e=1.70158;return t*t*((e+1)*t-e)}function C_(t){if(0===t)return 0;var e=1.70158;return--t*t*((e+1)*t+e)+1}function b_(t){var e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)}function T_(t){return 1-E_(1-t)}function E_(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375}function w_(t){return t<.5?.5*T_(2*t):.5*E_(2*t-1)+.5}function P_(t){return t<=0?0:t>=1?1:t*t*(3-2*t)}function I_(t){return t<=0?0:t>=1?1:t*t*t*(t*(6*t-15)+10)}i._decorator=Gl;var R_=G_(Zh,$h),D_=G_(e_,n_),B_=G_(r_,o_),M_=G_(s_,c_),O_=G_(u_,h_),N_=G_(f_,p_),L_=G_(m_,v_),F_=G_(y_,x_),z_=G_(A_,C_),V_=G_(T_,E_);function G_(t,e){return function(n){return n<.5?e(2*n)/2:t(2*n-1)/2+.5}}var U_,k_,H_=Object.freeze({__proto__:null,constant:Jh,linear:Qh,quadIn:Zh,quadOut:$h,quadInOut:t_,cubicIn:e_,cubicOut:n_,cubicInOut:i_,quartIn:r_,quartOut:o_,quartInOut:a_,quintIn:s_,quintOut:c_,quintInOut:l_,sineIn:u_,sineOut:h_,sineInOut:__,expoIn:f_,expoOut:p_,expoInOut:d_,circIn:m_,circOut:v_,circInOut:g_,elasticIn:y_,elasticOut:x_,elasticInOut:S_,backIn:A_,backOut:C_,backInOut:b_,bounceIn:T_,bounceOut:E_,bounceInOut:w_,smooth:P_,fade:I_,quadOutIn:R_,cubicOutIn:D_,quartOutIn:B_,quintOutIn:M_,sineOutIn:O_,expoOutIn:N_,circOutIn:L_,elasticOutIn:F_,backOutIn:z_,bounceOutIn:V_});t("easing",H_),function(t){t[t.LINEAR=0]="LINEAR",t[t.CONSTANT=1]="CONSTANT",t[t.QUAD_IN=2]="QUAD_IN",t[t.QUAD_OUT=3]="QUAD_OUT",t[t.QUAD_IN_OUT=4]="QUAD_IN_OUT",t[t.QUAD_OUT_IN=5]="QUAD_OUT_IN",t[t.CUBIC_IN=6]="CUBIC_IN",t[t.CUBIC_OUT=7]="CUBIC_OUT",t[t.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",t[t.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",t[t.QUART_IN=10]="QUART_IN",t[t.QUART_OUT=11]="QUART_OUT",t[t.QUART_IN_OUT=12]="QUART_IN_OUT",t[t.QUART_OUT_IN=13]="QUART_OUT_IN",t[t.QUINT_IN=14]="QUINT_IN",t[t.QUINT_OUT=15]="QUINT_OUT",t[t.QUINT_IN_OUT=16]="QUINT_IN_OUT",t[t.QUINT_OUT_IN=17]="QUINT_OUT_IN",t[t.SINE_IN=18]="SINE_IN",t[t.SINE_OUT=19]="SINE_OUT",t[t.SINE_IN_OUT=20]="SINE_IN_OUT",t[t.SINE_OUT_IN=21]="SINE_OUT_IN",t[t.EXPO_IN=22]="EXPO_IN",t[t.EXPO_OUT=23]="EXPO_OUT",t[t.EXPO_IN_OUT=24]="EXPO_IN_OUT",t[t.EXPO_OUT_IN=25]="EXPO_OUT_IN",t[t.CIRC_IN=26]="CIRC_IN",t[t.CIRC_OUT=27]="CIRC_OUT",t[t.CIRC_IN_OUT=28]="CIRC_IN_OUT",t[t.CIRC_OUT_IN=29]="CIRC_OUT_IN",t[t.ELASTIC_IN=30]="ELASTIC_IN",t[t.ELASTIC_OUT=31]="ELASTIC_OUT",t[t.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",t[t.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",t[t.BACK_IN=34]="BACK_IN",t[t.BACK_OUT=35]="BACK_OUT",t[t.BACK_IN_OUT=36]="BACK_IN_OUT",t[t.BACK_OUT_IN=37]="BACK_OUT_IN",t[t.BOUNCE_IN=38]="BOUNCE_IN",t[t.BOUNCE_OUT=39]="BOUNCE_OUT",t[t.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",t[t.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",t[t.SMOOTH=42]="SMOOTH",t[t.FADE=43]="FADE"}(k_||(k_={}));var j_,W_,q_,X_,Y_,K_=((U_={})[k_.CONSTANT]=Jh,U_[k_.LINEAR]=Qh,U_[k_.QUAD_IN]=Zh,U_[k_.QUAD_OUT]=$h,U_[k_.QUAD_IN_OUT]=t_,U_[k_.QUAD_OUT_IN]=R_,U_[k_.CUBIC_IN]=e_,U_[k_.CUBIC_OUT]=n_,U_[k_.CUBIC_IN_OUT]=i_,U_[k_.CUBIC_OUT_IN]=D_,U_[k_.QUART_IN]=r_,U_[k_.QUART_OUT]=o_,U_[k_.QUART_IN_OUT]=a_,U_[k_.QUART_OUT_IN]=B_,U_[k_.QUINT_IN]=s_,U_[k_.QUINT_OUT]=c_,U_[k_.QUINT_IN_OUT]=l_,U_[k_.QUINT_OUT_IN]=M_,U_[k_.SINE_IN]=u_,U_[k_.SINE_OUT]=h_,U_[k_.SINE_IN_OUT]=__,U_[k_.SINE_OUT_IN]=O_,U_[k_.EXPO_IN]=f_,U_[k_.EXPO_OUT]=p_,U_[k_.EXPO_IN_OUT]=d_,U_[k_.EXPO_OUT_IN]=N_,U_[k_.CIRC_IN]=m_,U_[k_.CIRC_OUT]=v_,U_[k_.CIRC_IN_OUT]=g_,U_[k_.CIRC_OUT_IN]=L_,U_[k_.ELASTIC_IN]=y_,U_[k_.ELASTIC_OUT]=x_,U_[k_.ELASTIC_IN_OUT]=S_,U_[k_.ELASTIC_OUT_IN]=F_,U_[k_.BACK_IN]=A_,U_[k_.BACK_OUT]=C_,U_[k_.BACK_IN_OUT]=b_,U_[k_.BACK_OUT_IN]=z_,U_[k_.BOUNCE_IN]=T_,U_[k_.BOUNCE_OUT]=E_,U_[k_.BOUNCE_IN_OUT]=w_,U_[k_.BOUNCE_OUT_IN]=V_,U_[k_.SMOOTH]=P_,U_[k_.FADE]=I_,U_);function J_(t){return K_[t]}var Q_,Z_,$_,tf=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).interpolationMode=Ml.LINEAR,e.tangentWeightMode=Nl.NONE,e.value=0,e.rightTangent=0,e.rightTangentWeight=0,e.leftTangent=0,e.leftTangentWeight=0,e.easingMethod=k_.LINEAR,e}return F(e,t),e}(Vl);function ef(t){var e=new tf;if("number"==typeof t)e.value=t;else{var n=t.interpolationMode,i=t.tangentWeightMode,r=t.value,o=t.rightTangent,a=t.rightTangentWeight,s=t.leftTangent,c=t.leftTangentWeight,l=t.easingMethod,u=t[Xe];e.value=null!=r?r:e.value,e.rightTangent=null!=o?o:e.rightTangent,e.rightTangentWeight=null!=a?a:e.rightTangentWeight,e.leftTangent=null!=s?s:e.leftTangent,e.leftTangentWeight=null!=c?c:e.leftTangentWeight,e.interpolationMode=null!=n?n:e.interpolationMode,e.tangentWeightMode=null!=i?i:e.tangentWeightMode,e.easingMethod=null!=l?l:e.easingMethod,u&&(e[Xe]=u)}return e}He.fastDefine("cc.RealKeyframeValue",tf,{interpolationMode:Ml.LINEAR,tangentWeightMode:Nl.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:k_.LINEAR}),He.Attr.setClassAttr(tf,Xe,"editorOnly",!0),(Q_=tf,null!==($_=(Z_=Q_)[Qc])&&void 0!==$_?$_:Z_[Qc]={}).uniquelyReferenced=!0;var nf,rf=t("RealCurve",qc("cc.RealCurve")((Y_=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"preExtrapolation",q_,H(e)),q(e,"postExtrapolation",X_,H(e)),e}F(e,t);var n=e.prototype;return n.evaluate=function(t){var e=this._times,n=this._values,i=e.length;if(0===i)return 0;var r=e[0],o=e[i-1];if(t<r){var a=this.preExtrapolation,s=n[0];if(a===Ol.CLAMP||i<2)return s.value;switch(a){case Ol.LINEAR:return xf(r,n[0].value,e[1],n[1].value,t);case Ol.LOOP:t=gf(t,r,o);break;case Ol.PING_PONG:t=yf(t,r,o);break;default:return s.value}}else if(t>o){var c=this.postExtrapolation,l=n[i-1];if(c===Ol.CLAMP||i<2)return l.value;switch(c){case Ol.LINEAR:return xf(o,l.value,e[i-2],n[i-2].value,t);case Ol.LOOP:t=gf(t,r,o);break;case Ol.PING_PONG:t=yf(t,r,o);break;default:return l.value}}var u=Fc(e,t);if(u>=0)return n[u].value;var h=~u,_=h-1,f=e[_],p=n[_],d=e[h];return function(t,e,n,i,r){var o=n-t;switch(e.interpolationMode){default:case Ml.CONSTANT:return e.value;case Ml.LINEAR:var a=e.easingMethod===k_.LINEAR?r:J_(e.easingMethod)(r);return Hn(e.value,i.value,a);case Ml.CUBIC:var s=1/3,c=e.rightTangent,l=e.rightTangentWeight,u=0!=(e.tangentWeightMode&Nl.RIGHT),h=i.leftTangent,_=i.leftTangentWeight,f=0!=(i.tangentWeightMode&Nl.LEFT);if(u||f){var p=0;if(u)p=l;else{var d=o,m=o*c;p=Math.sqrt(d*d+m*m)*s}var v=Math.atan(c),g=Math.cos(v)*p+t,y=Math.sin(v)*p+e.value,x=0;if(f)x=_;else{var S=o,A=o*h;x=Math.sqrt(S*S+A*A)*s}var C=Math.atan(h),b=(g-t)/o,T=(-Math.cos(C)*x+n-t)/o,E=y,w=-Math.sin(C)*x+i.value,P=[0,0,0],I=function(t,e,n,i,r){var o=n/i,a=e/i,s=o*o,c=1/3*(-1/3*s+a),l=.5*(2/27*o*s-1/3*o*a+t/i),u=c*c*c,h=l*l+u,_=0;if(zl(h)){if(zl(l))return r[0]=0,1;var f=Math.cbrt(-l);return r[0]=2*f,r[1]=-f,2}if(h<0){var p=1/3*Math.acos(-l/Math.sqrt(-u)),d=2*Math.sqrt(-c);r[0]=d*Math.cos(p),r[1]=-d*Math.cos(p+Math.PI/3),r[2]=-d*Math.cos(p-Math.PI/3),_=3}else{var m=Math.sqrt(h),v=Math.cbrt(m-l),g=-Math.cbrt(m+l);r[0]=v+g,_=1}for(var y=1/3*o,x=0;x<_;++x)r[x]-=y;return _}(0-r,3*b,3*T-6*b,3*(b-T)+1,P),R=function(t,e,n){var i=n;if(1===e)i=t[0];else{i=-1/0;for(var r=0;r<e;++r){var o=t[r];o>=0&&o<=1&&o>i&&(i=o)}i===-1/0&&(i=0)}return i}(P,I,r);return Sf(e.value,E,w,i.value,R)}var D=e.value+s*c*o,B=i.value-s*h*o;return Sf(e.value,D,B,i.value,r)}}(f,p,d,n[h],(t-f)/(d-f))},n.addKeyFrame=function(e,n){return t.prototype.addKeyFrame.call(this,e,ef(n))},n.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((function(t){return ef(t)})));else{var n=Array.from(t);this.setKeyframes(n.map((function(t){return t[0]})),n.map((function(t){return ef(t[1])})))}},n.isConstant=function(t){if(this._values.length<=1)return!0;var e=this._values[0].value;return this._values.every((function(n){return Gn(n.value,e,t)}))},n[$u]=function(t,e){if(e.toCCON){var n=this._times,i=this._values,r=n.length,o=new DataView(new ArrayBuffer(0+of+of+af+sf*r+df*r)),a=0;o.setUint8(a,this.preExtrapolation),a+=of,o.setUint8(a,this.postExtrapolation),a+=of,o.setUint32(a,r,!0),a+=af,n.forEach((function(t,e){return o.setFloat32(a+sf*e,t,!0)})),a+=sf*r;for(var s,c=W(i);!(s=c()).done;){var l=s.value;a=mf(o,l,a)}var u=new Uint8Array(o.buffer,0,a);t.writeProperty("bytes",u);var h=i.map((function(t){return t[Xe]}));h.some((function(t){return void 0!==t}))&&t.writeProperty("keyframeValueEditorExtras",h)}else t.writeThis()},n[th]=function(t,e){if(e.fromCCON){var n=t.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0;this.preExtrapolation=i.getUint8(r),r+=of,this.postExtrapolation=i.getUint8(r),r+=of;var o=i.getUint32(r,!0);r+=af;var a=Array.from({length:o},(function(t,e){return i.getFloat32(r+sf*e,!0)}));r+=sf*o;for(var s=new Array(o),c=0;c<o;++c){var l=ef({});r=vf(i,l,r),s[c]=l}n.byteLength;var u=t.readProperty("keyframeValueEditorExtras");u&&(u.length,u.forEach((function(t,e){return s[e][Xe]=t}))),this._times=a,this._values=s}else t.readThis()},e}(Fl),q_=X((W_=Y_).prototype,"preExtrapolation",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ol.CLAMP}}),X_=X(W_.prototype,"postExtrapolation",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ol.CLAMP}}),j_=W_))||j_);!function(t){t[t.VALUE=1]="VALUE",t[t.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",t[t.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",t[t.LEFT_TANGENT=8]="LEFT_TANGENT",t[t.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",t[t.RIGHT_TANGENT=32]="RIGHT_TANGENT",t[t.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(nf||(nf={}));var of=1,af=4,sf=4,cf=ef({}),lf=cf.interpolationMode,uf=cf.tangentWeightMode,hf=cf.leftTangent,_f=cf.leftTangentWeight,ff=cf.rightTangent,pf=cf.rightTangentWeight,df=26;function mf(t,e,n){var i=0,r=n,o=r;r+=4;var a=e.value,s=e.interpolationMode,c=e.tangentWeightMode,l=e.rightTangent,u=e.rightTangentWeight,h=e.leftTangent,_=e.leftTangentWeight,f=e.easingMethod;return t.setFloat32(r,a,!0),r+=4,s!==lf&&(i|=nf.INTERPOLATION_MODE,t.setUint8(r,s),r+=1),c!==uf&&(i|=nf.TANGENT_WEIGHT_MODE,t.setUint8(r,c),r+=1),h!==hf&&(i|=nf.LEFT_TANGENT,t.setFloat32(r,h,!0),r+=4),_!==_f&&(i|=nf.LEFT_TANGENT_WEIGHT,t.setFloat32(r,_,!0),r+=4),l!==ff&&(i|=nf.RIGHT_TANGENT,t.setFloat32(r,l,!0),r+=4),u!==pf&&(i|=nf.RIGHT_TANGENT_WEIGHT,t.setFloat32(r,u,!0),r+=4),i|=f<<8,t.setUint32(o,i,!0),r}function vf(t,e,n){var i=n,r=t.getUint32(i,!0);i+=4,e.value=t.getFloat32(i,!0),i+=4,r&nf.INTERPOLATION_MODE&&(e.interpolationMode=t.getUint8(i),i+=1),r&nf.TANGENT_WEIGHT_MODE&&(e.tangentWeightMode=t.getUint8(i),i+=1),r&nf.LEFT_TANGENT&&(e.leftTangent=t.getFloat32(i,!0),i+=4),r&nf.LEFT_TANGENT_WEIGHT&&(e.leftTangentWeight=t.getFloat32(i,!0),i+=4),r&nf.RIGHT_TANGENT&&(e.rightTangent=t.getFloat32(i,!0),i+=4),r&nf.RIGHT_TANGENT_WEIGHT&&(e.rightTangentWeight=t.getFloat32(i,!0),i+=4);var o=(65280&r)>>8;return e.easingMethod=o,i}function gf(t,e,n){return e+$n(t-e,n-e)}function yf(t,e,n){return e+ti(t-e,n-e)}function xf(t,e,n,i,r){return e+(i-e)/(n-t)*(r-t)}function Sf(t,e,n,i,r){var o=1-r;return o*o*o*t+3*o*o*r*e+3*o*r*r*n+r*r*r*i}function Af(t,e,n,i,r){var o=1-r;return o*(o*(t+(3*e-t)*r)+3*n*r*r)+i*r*r*r}i.bezier=Af;var Cf,bf,Tf,Ef,wf,Pf,If,Rf,Df,Bf,Mf,Of=Math.cos,Nf=Math.acos,Lf=Math.max,Ff=2*Math.PI,zf=Math.sqrt;function Vf(t){return t<0?-Math.pow(-t,1/3):Math.pow(t,1/3)}function Gf(t,e){var n=function(t,e){var n,i,r,o,a=e-0,s=e-t[0],c=3*a,l=3*s,u=3*(e-t[2]),h=1/(-a+l-u+(e-1)),_=1/3,f=(c-6*s+u)*h,p=f*_,d=(-c+l)*h,m=(3*d-f*f)*_,v=m*_,g=(2*f*f*f-9*f*d+a*h*27)/27,y=g/2,x=y*y+v*v*v;if(x<0){var S=-m*_,A=zf(S*S*S),C=-g/(2*A),b=Nf(C<-1?-1:C>1?1:C),T=2*Vf(A);return i=T*Of(b*_)-p,r=T*Of((b+Ff)*_)-p,o=T*Of((b+2*Ff)*_)-p,i>=0&&i<=1?r>=0&&r<=1?o>=0&&o<=1?Lf(i,r,o):Lf(i,r):o>=0&&o<=1?Lf(i,o):i:r>=0&&r<=1?o>=0&&o<=1?Lf(r,o):r:o}if(0===x)return r=-(n=y<0?Vf(-y):-Vf(y))-p,(i=2*n-p)>=0&&i<=1?r>=0&&r<=1?Lf(i,r):i:r;var E=zf(x);return(n=Vf(-y+E))-Vf(y+E)-p}(t,e),i=t[1];return((1-n)*(i+(t[3]-i)*n)*3+n*n)*n}i.bezierByTime=Gf,function(t){t[t.SLERP=0]="SLERP",t[t.CONSTANT=1]="CONSTANT"}(Mf||(Mf=t("QuatInterpolationMode",{})));var Uf=qc("cc.QuatKeyframeValue")(Cf=nl((Tf=X((bf=function(t){var e=void 0===t?{}:t,n=e.value,i=e.interpolationMode,r=e.easingMethod;q(this,"interpolationMode",Tf,this),q(this,"value",Ef,this),q(this,"easingMethod",wf,this),this.value=n?gi.clone(n):this.value,this.interpolationMode=null!=i?i:this.interpolationMode,this.easingMethod=null!=r?r:this.easingMethod}).prototype,"interpolationMode",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mf.SLERP}}),Ef=X(bf.prototype,"value",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gi.clone(gi.IDENTITY)}}),wf=X(bf.prototype,"easingMethod",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return k_.LINEAR}}),Cf=bf))||Cf)||Cf;function kf(t){return new Uf(t)}var Hf,jf=t("QuatCurve",qc("cc.QuatCurve")((Bf=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"preExtrapolation",Rf,H(e)),q(e,"postExtrapolation",Df,H(e)),e}F(e,t);var n=e.prototype;return n.evaluate=function(t,e){var n;null!==(n=e)&&void 0!==n||(e=new gi);var i=this._times,r=this._values,o=this.postExtrapolation,a=this.preExtrapolation,s=i.length;if(0===s)return e;var c=i[0],l=i[s-1];if(t<c){var u=r[0];switch(a){case Ol.LOOP:t=c+$n(t-c,l-c);break;case Ol.PING_PONG:t=c+ti(t-c,l-c);break;case Ol.CLAMP:default:return gi.copy(e,u.value)}}else if(t>l){var h=r[s-1];switch(o){case Ol.LOOP:t=c+$n(t-c,l-c);break;case Ol.PING_PONG:t=c+ti(t-c,l-c);break;case Ol.CLAMP:default:return gi.copy(e,h.value)}}var _=Fc(i,t);if(_>=0)return gi.copy(e,r[_].value);var f=~_,p=f-1,d=i[p],m=r[p],v=i[f],g=r[f],y=(t-d)/(v-d);switch(m.interpolationMode){default:case Mf.CONSTANT:return gi.copy(e,m.value);case Mf.SLERP:var x=m.easingMethod,S=x===k_.LINEAR?y:Array.isArray(x)?Gf(x,y):J_(x)(y);return gi.slerp(e,m.value,g.value,S)}},n.addKeyFrame=function(e,n){var i=new Uf(n);return t.prototype.addKeyFrame.call(this,e,i)},n.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((function(t){return kf(t)})));else{var n=Array.from(t);this.setKeyframes(n.map((function(t){return t[0]})),n.map((function(t){return kf(t[1])})))}},n[$u]=function(t,e){if(e.toCCON){var n=this._times,i=this._values,r=!0;i.forEach((function(t,e,n){var i=n[0];r&&t.interpolationMode!==i.interpolationMode&&(r=!1)}));var o=n.length,a=ep*(r?1:o),s=i.reduce((function(t,e){var n=e.easingMethod;return t+(Array.isArray(n)?np+4*rp:np)}),0),c=0,l=new DataView(new ArrayBuffer(c+=Qf+Zf+$f*o+4*tp*o+s+a+0)),u=0,h=0;r&&(h|=Hf.INTERPOLATION_MODE),l.setUint32(u,h,!0),u+=Qf,l.setUint32(u,o,!0),u+=Zf,n.forEach((function(t,e){return l.setFloat32(u+$f*e,t,!0)})),u+=$f*o,i.forEach((function(t,e){var n=t.value,i=n.x,r=n.y,o=n.z,a=n.w,s=u+4*tp*e;l.setFloat32(s+0*tp,i,!0),l.setFloat32(s+1*tp,r,!0),l.setFloat32(s+2*tp,o,!0),l.setFloat32(s+3*tp,a,!0)})),u+=4*tp*o,i.forEach((function(t){var e=t.easingMethod;Array.isArray(e)?(l.setUint8(u,ip),++u,l.setFloat32(u+0*rp,e[0],!0),l.setFloat32(u+1*rp,e[1],!0),l.setFloat32(u+2*rp,e[2],!0),l.setFloat32(u+3*rp,e[3],!0),u+=4*rp):(l.setUint8(u,e),++u)}));var _=u;u+=a;var f=_;i.forEach((function(t){var e=t.interpolationMode;l.setUint8(f,e),r||(f+=ep)}));var p=new Uint8Array(l.buffer);t.writeProperty("bytes",p)}else t.writeThis()},n[th]=function(t,e){if(e.fromCCON){var n=t.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0,o=i.getUint32(r,!0);r+=Qf;var a=o&Hf.INTERPOLATION_MODE,s=i.getUint32(r,!0);r+=Zf;var c=Array.from({length:s},(function(t,e){return i.getFloat32(r+$f*e,!0)})),l=r+=$f*s;r+=4*tp*s;var u=Array.from({length:s},(function(t,e){var n=l+4*tp*e,o=i.getFloat32(n+0*tp,!0),a=i.getFloat32(n+1*tp,!0),s=i.getFloat32(n+2*tp,!0),c=i.getFloat32(n+3*tp,!0),u=i.getUint8(r);++r;var h=kf({value:{x:o,y:a,z:s,w:c}});return u!==ip?h.easingMethod=u:(h.easingMethod=[i.getFloat32(r+0*rp,!0),i.getFloat32(r+1*rp,!0),i.getFloat32(r+2*rp,!0),i.getFloat32(r+3*rp,!0)],r+=4*rp),h}));if(a){var h=i.getUint8(r);++r;for(var _=0;_<s;++_)u[_].interpolationMode=h}else{for(var f=0;f<s;++f){var p=i.getUint8(r+f);u[f].interpolationMode=p}r+=s}this._times=c,this._values=u}else t.readThis()},e}(Fl),Rf=X((If=Bf).prototype,"preExtrapolation",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ol.CLAMP}}),Df=X(If.prototype,"postExtrapolation",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ol.CLAMP}}),Pf=If))||Pf);!function(t){t[t.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(Hf||(Hf={}));var Wf,qf,Xf,Yf,Kf,Jf,Qf=1,Zf=4,$f=4,tp=4,ep=1,np=1,ip=255,rp=4,op=t("ObjectCurve",qc("cc.ObjectCurve")(Wf=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e.prototype.evaluate=function(t){var e=this.searchKeyframe(t);if(e>=0)return this._values[e];var n=Un(~e-1,0,this._values.length-1);return this._values[n]},e}(Fl))||Wf),ap=function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};He.fastDefine("cc.Keyframe",ap,{time:0,value:0,inTangent:0,outTangent:0});var sp=function(){function t(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return t.prototype.evaluate=function(t){return e=t-this.time,n=this.coefficient,e*(e*(e*n[0]+n[1])+n[2])+n[3];var e,n},t}(),cp=qc("cc.AnimationCurve")((Jf=Kf=function(){function t(t){if(void 0===t&&(t=null),q(this,"_curve",Yf,this),this.cachedKey=void 0,t instanceof rf)this._curve=t;else{var e=new rf;this._curve=e,e.preExtrapolation=Ol.LOOP,e.postExtrapolation=Ol.CLAMP,t?e.assignSorted(t.map((function(t){return[t.time,{interpolationMode:Ml.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}]}))):e.assignSorted([[0,{interpolationMode:Ml.CUBIC,value:1}],[1,{interpolationMode:Ml.CUBIC,value:1}]])}this.cachedKey=new sp}var e=t.prototype;return e.addKey=function(t){t?this._curve.addKeyFrame(t.time,{interpolationMode:Ml.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}):this._curve.clear()},e.evaluate_slow=function(t){return this._curve.evaluate(t)},e.evaluate=function(t){var e=this.cachedKey,n=this._curve,i=n.keyFramesCount-1,r=t,o=t<0?n.preExtrapolation:n.postExtrapolation,a=n.getKeyframeTime(0),s=n.getKeyframeTime(i);switch(o){case Ol.LOOP:r=$n(t-a,s-a)+a;break;case Ol.PING_PONG:r=ti(t-a,s-a)+a;break;case Ol.CLAMP:default:r=Un(t,a,s)}if(r>=e.time&&r<e.endTime)return e.evaluate(r);var c=this.findIndex(e,r),l=Math.min(c+1,i);return this.calcOptimizedKey(e,c,l),e.evaluate(r)},e.calcOptimizedKey=function(t,e,n){var i=this._curve.getKeyframeTime(e),r=this._curve.getKeyframeTime(n),o=this._curve.getKeyframeValue(e),a=o.value,s=o.leftTangent,c=this._curve.getKeyframeValue(n),l=c.value,u=c.rightTangent;t.index=e,t.time=i,t.endTime=r;var h=r-i,_=l-a,f=1/(h*h),p=s*h,d=u*h;t.coefficient[0]=(p+d-_-_)*f/h,t.coefficient[1]=(_+_+_-p-p-d)*f,t.coefficient[2]=s,t.coefficient[3]=a},e.findIndex=function(t,e){var n=this._curve,i=n.keyFramesCount,r=t.index;if(-1!==r)if(e>n.getKeyframeTime(r))for(var o=0;o<3;o++){var a=r+o;if(a+1<i&&n.getKeyframeTime(a+1)>e)return a}else for(var s=0;s<3;s++){var c=r-s;if(c>=0&&n.getKeyframeTime(c-1)<=e)return c-1}for(var l,u=0,h=i;h-u>1;)l=Math.floor((u+h)/2),n.getKeyframeTime(l)>=e?h=l:u=l;return u},N(t,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(t){var e=t[0],n=t[1],i=new ap;return i.time=e,i.value=n.value,i.inTangent=n.leftTangent,i.outTangent=n.rightTangent,i}))},set:function(t){this._curve.assignSorted(t.map((function(t){return[t.time,{interpolationMode:Ml.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}]})))}},{key:"preWrapMode",get:function(){return up(this._curve.preExtrapolation)},set:function(t){this._curve.preExtrapolation=lp(t)}},{key:"postWrapMode",get:function(){return up(this._curve.postExtrapolation)},set:function(t){this._curve.postExtrapolation=lp(t)}}]),t}(),Kf.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],Yf=X((Xf=Jf).prototype,"_curve",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),qf=Xf))||qf;function lp(t){switch(t){default:case Rc.Default:case Rc.Normal:case Rc.Clamp:return Ol.CLAMP;case Rc.PingPong:return Ol.PING_PONG;case Rc.Loop:return Ol.LOOP}}function up(t){switch(t){default:case Ol.LINEAR:case Ol.CLAMP:return Rc.Clamp;case Ol.PING_PONG:return Rc.PingPong;case Ol.LOOP:return Rc.Loop}}var hp=Object.freeze({__proto__:null,distance:tr,enums:er,intersect:ks,Line:Js,Plane:ec,Ray:nr,Triangle:Jr,Sphere:Kr,AABB:Cc,OBB:wc,Capsule:Pc,Frustum:Nc,Keyframe:ap,AnimationCurve:cp,get ERaycastMode(){return Sa}});t("geometry",hp);var _p={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},fp=t("Layers",function(){function t(){}return t.makeMaskInclude=function(t){for(var e,n=0,i=W(t);!(e=i()).done;)n|=e.value;return n},t.makeMaskExclude=function(e){return~t.makeMaskInclude(e)},t.addLayer=function(e,n){if(void 0!==n)if(n>19||n<0)console.warn("maximum layers reached.");else{var i=1<<n;t.Enum[e],R(2104,e),t.Enum[e]=i,kt.value(t.Enum,String(i),e),t.BitMask[e]=i,kt.value(t.BitMask,String(i),e)}else console.warn("bitNum can't be undefined")},t.deleteLayer=function(e){if(e>19||e<0)console.warn("do not change buildin layers.");else{var n=1<<e;delete t.Enum[t.Enum[n]],delete t.Enum[n],delete t.BitMask[t.BitMask[n]],delete t.BitMask[n]}},t.nameToLayer=function(e){return void 0===e?(console.warn("name can't be undefined"),-1):Dn(t.Enum[e])},t.layerToName=function(e){return e>31||e<0?(console.warn("Unable to access unknown layer."),""):t.Enum[1<<e]},t}());fp.Enum=Jt(_p),fp.BitMask=Yt(L({},_p)),i.Layers=fp;var pp,dp,mp="MainFlow",vp="ForwardFlow",gp="ShadowFlow";!function(t){t[t.DEFAULT=100]="DEFAULT",t[t.UI=200]="UI"}(pp||(pp={})),i.RenderPassStage=pp,function(t){t[t.MIN=0]="MIN",t[t.MAX=255]="MAX",t[t.DEFAULT=128]="DEFAULT"}(dp||(dp={}));var yp,xp={bindings:[],layouts:{}},Sp={bindings:[],layouts:{}};!function(t){t[t.UBO_GLOBAL=0]="UBO_GLOBAL",t[t.UBO_CAMERA=1]="UBO_CAMERA",t[t.UBO_SHADOW=2]="UBO_SHADOW",t[t.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",t[t.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",t[t.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",t[t.SAMPLER_DIFFUSEMAP=6]="SAMPLER_DIFFUSEMAP",t[t.COUNT=7]="COUNT"}(yp||(yp={}));var Ap,Cp=yp.SAMPLER_SHADOWMAP,bp=yp.COUNT-Cp;!function(t){t[t.UBO_LOCAL=0]="UBO_LOCAL",t[t.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",t[t.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",t[t.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",t[t.UBO_MORPH=4]="UBO_MORPH",t[t.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",t[t.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",t[t.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",t[t.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",t[t.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",t[t.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",t[t.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",t[t.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",t[t.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",t[t.COUNT=14]="COUNT"}(Ap||(Ap={}));var Tp,Ep=Ap.SAMPLER_JOINTS,wp=Ap.COUNT-Ep;!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.MATERIAL=1]="MATERIAL",t[t.LOCAL=2]="LOCAL"}(Tp||(Tp={}));var Pp=new ho;Pp.bufferOffsets=[0,Cp+Ep,Cp],Pp.samplerOffsets=[-Cp,bp+wp,bp-Ep],Pp.flexibleSet=1;var Ip=function(){};Ip.SIZE=4*(Ip.COUNT=4+(Ip.SCREEN_SIZE_OFFSET=4+(Ip.NATIVE_SIZE_OFFSET=4+(Ip.TIME_OFFSET=0)))),Ip.NAME="CCGlobal",Ip.BINDING=yp.UBO_GLOBAL,Ip.DESCRIPTOR=new Ho(Ip.BINDING,jr.UNIFORM_BUFFER,1,Br.ALL),Ip.LAYOUT=new bo(Tp.GLOBAL,Ip.BINDING,Ip.NAME,[new Co("cc_time",dr.FLOAT4,1),new Co("cc_screenSize",dr.FLOAT4,1),new Co("cc_nativeSize",dr.FLOAT4,1)],1),xp.layouts[Ip.NAME]=Ip.LAYOUT,xp.bindings[Ip.BINDING]=Ip.DESCRIPTOR;var Rp=function(){};Rp.SIZE=4*(Rp.COUNT=4+(Rp.VIEW_PORT_OFFSET=4+(Rp.NEAR_FAR_OFFSET=4+(Rp.GLOBAL_FOG_ADD_OFFSET=4+(Rp.GLOBAL_FOG_BASE_OFFSET=4+(Rp.GLOBAL_FOG_COLOR_OFFSET=4+(Rp.AMBIENT_GROUND_OFFSET=4+(Rp.AMBIENT_SKY_OFFSET=4+(Rp.MAIN_LIT_COLOR_OFFSET=4+(Rp.MAIN_LIT_DIR_OFFSET=4+(Rp.EXPOSURE_OFFSET=4+(Rp.SCREEN_SCALE_OFFSET=4+(Rp.CAMERA_POS_OFFSET=16+(Rp.MAT_VIEW_PROJ_INV_OFFSET=16+(Rp.MAT_VIEW_PROJ_OFFSET=16+(Rp.MAT_PROJ_INV_OFFSET=16+(Rp.MAT_PROJ_OFFSET=16+(Rp.MAT_VIEW_INV_OFFSET=16+(Rp.MAT_VIEW_OFFSET=0))))))))))))))))))),Rp.NAME="CCCamera",Rp.BINDING=yp.UBO_CAMERA,Rp.DESCRIPTOR=new Ho(Rp.BINDING,jr.UNIFORM_BUFFER,1,Br.ALL),Rp.LAYOUT=new bo(Tp.GLOBAL,Rp.BINDING,Rp.NAME,[new Co("cc_matView",dr.MAT4,1),new Co("cc_matViewInv",dr.MAT4,1),new Co("cc_matProj",dr.MAT4,1),new Co("cc_matProjInv",dr.MAT4,1),new Co("cc_matViewProj",dr.MAT4,1),new Co("cc_matViewProjInv",dr.MAT4,1),new Co("cc_cameraPos",dr.FLOAT4,1),new Co("cc_screenScale",dr.FLOAT4,1),new Co("cc_exposure",dr.FLOAT4,1),new Co("cc_mainLitDir",dr.FLOAT4,1),new Co("cc_mainLitColor",dr.FLOAT4,1),new Co("cc_ambientSky",dr.FLOAT4,1),new Co("cc_ambientGround",dr.FLOAT4,1),new Co("cc_fogColor",dr.FLOAT4,1),new Co("cc_fogBase",dr.FLOAT4,1),new Co("cc_fogAdd",dr.FLOAT4,1),new Co("cc_nearFar",dr.FLOAT4,1),new Co("cc_viewPort",dr.FLOAT4,1)],1),xp.layouts[Rp.NAME]=Rp.LAYOUT,xp.bindings[Rp.BINDING]=Rp.DESCRIPTOR;var Dp=function(){};Dp.SIZE=4*(Dp.COUNT=4+(Dp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=4+(Dp.SHADOW_COLOR_OFFSET=4+(Dp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(Dp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(Dp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+(Dp.SHADOW_PROJ_INFO_OFFSET=4+(Dp.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+(Dp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+(Dp.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(Dp.MAT_LIGHT_VIEW_OFFSET=16+(Dp.MAT_LIGHT_PLANE_PROJ_OFFSET=0)))))))))))),Dp.NAME="CCShadow",Dp.BINDING=yp.UBO_SHADOW,Dp.DESCRIPTOR=new Ho(Dp.BINDING,jr.UNIFORM_BUFFER,1,Br.ALL),Dp.LAYOUT=new bo(Tp.GLOBAL,Dp.BINDING,Dp.NAME,[new Co("cc_matLightPlaneProj",dr.MAT4,1),new Co("cc_matLightView",dr.MAT4,1),new Co("cc_matLightViewProj",dr.MAT4,1),new Co("cc_shadowInvProjDepthInfo",dr.FLOAT4,1),new Co("cc_shadowProjDepthInfo",dr.FLOAT4,1),new Co("cc_shadowProjInfo",dr.FLOAT4,1),new Co("cc_shadowNFLSInfo",dr.FLOAT4,1),new Co("cc_shadowWHPBInfo",dr.FLOAT4,1),new Co("cc_shadowLPNNInfo",dr.FLOAT4,1),new Co("cc_shadowColor",dr.FLOAT4,1),new Co("cc_planarNDInfo",dr.FLOAT4,1)],1),xp.layouts[Dp.NAME]=Dp.LAYOUT,xp.bindings[Dp.BINDING]=Dp.DESCRIPTOR;var Bp=yp.SAMPLER_SHADOWMAP,Mp=new Ho(Bp,jr.SAMPLER_TEXTURE,1,Br.FRAGMENT),Op=new To(Tp.GLOBAL,Bp,"cc_shadowMap",dr.SAMPLER2D,1);xp.layouts.cc_shadowMap=Op,xp.bindings[Bp]=Mp;var Np=yp.SAMPLER_ENVIRONMENT,Lp=new Ho(Np,jr.SAMPLER_TEXTURE,1,Br.FRAGMENT),Fp=new To(Tp.GLOBAL,Np,"cc_environment",dr.SAMPLER_CUBE,1);xp.layouts.cc_environment=Fp,xp.bindings[Np]=Lp;var zp=yp.SAMPLER_DIFFUSEMAP,Vp=new Ho(zp,jr.SAMPLER_TEXTURE,1,Br.FRAGMENT),Gp=new To(Tp.GLOBAL,zp,"cc_diffuseMap",dr.SAMPLER_CUBE,1);xp.layouts.cc_diffuseMap=Gp,xp.bindings[zp]=Vp;var Up=yp.SAMPLER_SPOT_LIGHTING_MAP,kp=new Ho(Up,jr.SAMPLER_TEXTURE,1,Br.FRAGMENT),Hp=new To(Tp.GLOBAL,Up,"cc_spotLightingMap",dr.SAMPLER2D,1);xp.layouts.cc_spotLightingMap=Hp,xp.bindings[Up]=kp;var jp=function(){};jp.SIZE=4*(jp.COUNT=4+(jp.LIGHTINGMAP_UVPARAM=16+(jp.MAT_WORLD_IT_OFFSET=16+(jp.MAT_WORLD_OFFSET=0)))),jp.NAME="CCLocal",jp.BINDING=Ap.UBO_LOCAL,jp.DESCRIPTOR=new Ho(jp.BINDING,jr.UNIFORM_BUFFER,1,Br.VERTEX|Br.COMPUTE),jp.LAYOUT=new bo(Tp.LOCAL,jp.BINDING,jp.NAME,[new Co("cc_matWorld",dr.MAT4,1),new Co("cc_matWorldIT",dr.MAT4,1),new Co("cc_lightingMapUVParam",dr.FLOAT4,1)],1),Sp.layouts[jp.NAME]=jp.LAYOUT,Sp.bindings[jp.BINDING]=jp.DESCRIPTOR;var Wp=function(){};Wp.SIZE=4*(Wp.COUNT=4+(Wp.WORLD_BOUND_HALF_EXTENTS=4+(Wp.WORLD_BOUND_CENTER=0))),Wp.NAME="CCWorldBound",Wp.BINDING=Ap.UBO_LOCAL,Wp.DESCRIPTOR=new Ho(Wp.BINDING,jr.UNIFORM_BUFFER,1,Br.VERTEX|Br.COMPUTE),Wp.LAYOUT=new bo(Tp.LOCAL,Wp.BINDING,Wp.NAME,[new Co("cc_worldBoundCenter",dr.FLOAT4,1),new Co("cc_worldBoundHalfExtents",dr.FLOAT4,1)],1),Sp.layouts[Wp.NAME]=Wp.LAYOUT,Sp.bindings[Wp.BINDING]=Wp.DESCRIPTOR;var qp="a_matWorld0",Xp=function(){};Xp.BATCHING_COUNT=10,Xp.MAT_WORLDS_OFFSET=0,Xp.SIZE=4*(Xp.COUNT=16*Xp.BATCHING_COUNT),Xp.NAME="CCLocalBatched",Xp.BINDING=Ap.UBO_LOCAL,Xp.DESCRIPTOR=new Ho(Xp.BINDING,jr.UNIFORM_BUFFER,1,Br.VERTEX|Br.COMPUTE),Xp.LAYOUT=new bo(Tp.LOCAL,Xp.BINDING,Xp.NAME,[new Co("cc_matWorlds",dr.MAT4,Xp.BATCHING_COUNT)],1),Sp.layouts[Xp.NAME]=Xp.LAYOUT,Sp.bindings[Xp.BINDING]=Xp.DESCRIPTOR;var Yp=function(){};Yp.LIGHTS_PER_PASS=1,Yp.SIZE=4*(Yp.COUNT=(Yp.LIGHT_DIR_OFFSET=(Yp.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(Yp.LIGHT_COLOR_OFFSET=(Yp.LIGHT_POS_OFFSET=0)+4*Yp.LIGHTS_PER_PASS)+4*Yp.LIGHTS_PER_PASS)+4*Yp.LIGHTS_PER_PASS)+4*Yp.LIGHTS_PER_PASS),Yp.NAME="CCForwardLight",Yp.BINDING=Ap.UBO_FORWARD_LIGHTS,Yp.DESCRIPTOR=new Ho(Yp.BINDING,jr.DYNAMIC_UNIFORM_BUFFER,1,Br.FRAGMENT),Yp.LAYOUT=new bo(Tp.LOCAL,Yp.BINDING,Yp.NAME,[new Co("cc_lightPos",dr.FLOAT4,Yp.LIGHTS_PER_PASS),new Co("cc_lightColor",dr.FLOAT4,Yp.LIGHTS_PER_PASS),new Co("cc_lightSizeRangeAngle",dr.FLOAT4,Yp.LIGHTS_PER_PASS),new Co("cc_lightDir",dr.FLOAT4,Yp.LIGHTS_PER_PASS)],1),Sp.layouts[Yp.NAME]=Yp.LAYOUT,Sp.bindings[Yp.BINDING]=Yp.DESCRIPTOR;var Kp=function(){};Kp.LIGHTS_PER_PASS=10;var Jp=function(){};Jp.SIZE=4*(Jp.COUNT=4+(Jp.JOINTS_TEXTURE_INFO_OFFSET=0)),Jp.NAME="CCSkinningTexture",Jp.BINDING=Ap.UBO_SKINNING_TEXTURE,Jp.DESCRIPTOR=new Ho(Jp.BINDING,jr.UNIFORM_BUFFER,1,Br.VERTEX),Jp.LAYOUT=new bo(Tp.LOCAL,Jp.BINDING,Jp.NAME,[new Co("cc_jointTextureInfo",dr.FLOAT4,1)],1),Sp.layouts[Jp.NAME]=Jp.LAYOUT,Sp.bindings[Jp.BINDING]=Jp.DESCRIPTOR;var Qp=function(){};Qp.SIZE=4*(Qp.COUNT=4+(Qp.JOINTS_ANIM_INFO_OFFSET=0)),Qp.NAME="CCSkinningAnimation",Qp.BINDING=Ap.UBO_SKINNING_ANIMATION,Qp.DESCRIPTOR=new Ho(Qp.BINDING,jr.UNIFORM_BUFFER,1,Br.VERTEX),Qp.LAYOUT=new bo(Tp.LOCAL,Qp.BINDING,Qp.NAME,[new Co("cc_jointAnimInfo",dr.FLOAT4,1)],1),Sp.layouts[Qp.NAME]=Qp.LAYOUT,Sp.bindings[Qp.BINDING]=Qp.DESCRIPTOR;var Zp=function(){};Zp.SIZE=4*(Zp.COUNT=360+(Zp.JOINTS_OFFSET=0)),Zp.NAME="CCSkinning",Zp.BINDING=Ap.UBO_SKINNING_TEXTURE,Zp.DESCRIPTOR=new Ho(Zp.BINDING,jr.UNIFORM_BUFFER,1,Br.VERTEX),Zp.LAYOUT=new bo(Tp.LOCAL,Zp.BINDING,Zp.NAME,[new Co("cc_joints",dr.FLOAT4,90)],1),Sp.layouts[Zp.NAME]=Zp.LAYOUT,Sp.bindings[Zp.BINDING]=Zp.DESCRIPTOR;var $p=function(){};$p.MAX_MORPH_TARGET_COUNT=60,$p.OFFSET_OF_WEIGHTS=0,$p.OFFSET_OF_VERTICES_COUNT=4+($p.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+($p.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*$p.MAX_MORPH_TARGET_COUNT)),$p.COUNT_BASE_4_BYTES=4*Math.ceil($p.MAX_MORPH_TARGET_COUNT/4)+4,$p.SIZE=4*$p.COUNT_BASE_4_BYTES,$p.NAME="CCMorph",$p.BINDING=Ap.UBO_MORPH,$p.DESCRIPTOR=new Ho($p.BINDING,jr.UNIFORM_BUFFER,1,Br.VERTEX),$p.LAYOUT=new bo(Tp.LOCAL,$p.BINDING,$p.NAME,[new Co("cc_displacementWeights",dr.FLOAT4,$p.MAX_MORPH_TARGET_COUNT/4),new Co("cc_displacementTextureInfo",dr.FLOAT4,1)],1),Sp.layouts[$p.NAME]=$p.LAYOUT,Sp.bindings[$p.BINDING]=$p.DESCRIPTOR;var td=function(){};td.NAME="CCUILocal",td.BINDING=Ap.UBO_UI_LOCAL,td.DESCRIPTOR=new Ho(td.BINDING,jr.DYNAMIC_UNIFORM_BUFFER,1,Br.VERTEX),td.LAYOUT=new bo(Tp.LOCAL,td.BINDING,td.NAME,[new Co("cc_local_data",dr.FLOAT4,1)],1),Sp.layouts[td.NAME]=td.LAYOUT,Sp.bindings[td.BINDING]=td.DESCRIPTOR;var ed=Ap.SAMPLER_JOINTS,nd=new Ho(ed,jr.SAMPLER_TEXTURE,1,Br.VERTEX),id=new To(Tp.LOCAL,ed,"cc_jointTexture",dr.SAMPLER2D,1);Sp.layouts.cc_jointTexture=id,Sp.bindings[ed]=nd;var rd=Ap.SAMPLER_MORPH_POSITION,od=new Ho(rd,jr.SAMPLER_TEXTURE,1,Br.VERTEX),ad=new To(Tp.LOCAL,rd,"cc_PositionDisplacements",dr.SAMPLER2D,1);Sp.layouts.cc_PositionDisplacements=ad,Sp.bindings[rd]=od;var sd=Ap.SAMPLER_MORPH_NORMAL,cd=new Ho(sd,jr.SAMPLER_TEXTURE,1,Br.VERTEX),ld=new To(Tp.LOCAL,sd,"cc_NormalDisplacements",dr.SAMPLER2D,1);Sp.layouts.cc_NormalDisplacements=ld,Sp.bindings[sd]=cd;var ud=Ap.SAMPLER_MORPH_TANGENT,hd=new Ho(ud,jr.SAMPLER_TEXTURE,1,Br.VERTEX),_d=new To(Tp.LOCAL,ud,"cc_TangentDisplacements",dr.SAMPLER2D,1);Sp.layouts.cc_TangentDisplacements=_d,Sp.bindings[ud]=hd;var fd=Ap.SAMPLER_LIGHTMAP,pd=new Ho(fd,jr.SAMPLER_TEXTURE,1,Br.FRAGMENT),dd=new To(Tp.LOCAL,fd,"cc_lightingMap",dr.SAMPLER2D,1);Sp.layouts.cc_lightingMap=dd,Sp.bindings[fd]=pd;var md=Ap.SAMPLER_SPRITE,vd=new Ho(md,jr.SAMPLER_TEXTURE,1,Br.FRAGMENT),gd=new To(Tp.LOCAL,md,"cc_spriteTexture",dr.SAMPLER2D,1);Sp.layouts.cc_spriteTexture=gd,Sp.bindings[md]=vd;var yd=Ap.SAMPLER_REFLECTION,xd=new Ho(yd,jr.SAMPLER_TEXTURE,1,Br.FRAGMENT),Sd=new To(Tp.LOCAL,yd,"cc_reflectionTexture",dr.SAMPLER2D,1);Sp.layouts.cc_reflectionTexture=Sd,Sp.bindings[yd]=xd;var Ad=Ap.STORAGE_REFLECTION,Cd=new Ho(Ad,jr.STORAGE_IMAGE,1,Br.COMPUTE),bd=new Po(Tp.LOCAL,Ad,"cc_reflectionStorage",dr.IMAGE2D,1);Sp.layouts.cc_reflectionStorage=bd,Sp.bindings[Ad]=Cd;var Td,Ed,wd,Pd,Id,Rd=fp.makeMaskExclude([fp.BitMask.UI_2D,fp.BitMask.GIZMOS,fp.BitMask.EDITOR,fp.BitMask.SCENE_GIZMO,fp.BitMask.PROFILER]),Dd=fp.makeMaskExclude([fp.BitMask.UI_2D,fp.BitMask.PROFILER]),Bd=fp.Enum.ALL;function Md(t){return t.hasFeature(_r.COLOR_FLOAT)&&t.hasFeature(_r.TEXTURE_FLOAT)&&!(t.gfxAPI===ur.WEBGL)}t("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:mp,PIPELINE_FLOW_FORWARD:vp,PIPELINE_FLOW_SHADOW:gp,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return pp},get RenderPriority(){return dp},globalDescriptorSetLayout:xp,localDescriptorSetLayout:Sp,get PipelineGlobalBindings(){return yp},get ModelLocalBindings(){return Ap},get SetIndex(){return Tp},bindingMappingInfo:Pp,UBOGlobal:Ip,UBOCamera:Rp,UBOShadow:Dp,UNIFORM_SHADOWMAP_BINDING:Bp,UNIFORM_ENVIRONMENT_BINDING:Np,UNIFORM_DIFFUSEMAP_BINDING:zp,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:Up,UBOLocal:jp,UBOWorldBound:Wp,INST_MAT_WORLD:qp,UBOLocalBatched:Xp,UBOForwardLight:Yp,UBODeferredLight:Kp,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:Jp,UBOSkinningAnimation:Qp,INST_JOINT_ANIM_INFO:"a_jointAnimInfo",UBOSkinning:Zp,UBOMorph:$p,UBOUILocal:td,UNIFORM_JOINT_TEXTURE_BINDING:ed,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:rd,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:sd,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:ud,UNIFORM_LIGHTMAP_TEXTURE_BINDING:fd,UNIFORM_SPRITE_TEXTURE_BINDING:md,UNIFORM_REFLECTION_TEXTURE_BINDING:yd,UNIFORM_REFLECTION_STORAGE_BINDING:Ad,CAMERA_DEFAULT_MASK:Rd,CAMERA_EDITOR_MASK:Dd,MODEL_ALWAYS_MASK:Bd,supportsHalfFloatTexture:function(t){return t.hasFeature(_r.COLOR_HALF_FLOAT)&&t.hasFeature(_r.TEXTURE_HALF_FLOAT)&&!(t.gfxAPI===ur.WEBGL)},supportsFloatTexture:Md})),function(t){t[t.VERTICAL=0]="VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL"}(Td||(Td={})),function(t){t[t.ORTHO=0]="ORTHO",t[t.PERSPECTIVE=1]="PERSPECTIVE"}(Ed||(Ed={})),function(t){t[t.F1_8=0]="F1_8",t[t.F2_0=1]="F2_0",t[t.F2_2=2]="F2_2",t[t.F2_5=3]="F2_5",t[t.F2_8=4]="F2_8",t[t.F3_2=5]="F3_2",t[t.F3_5=6]="F3_5",t[t.F4_0=7]="F4_0",t[t.F4_5=8]="F4_5",t[t.F5_0=9]="F5_0",t[t.F5_6=10]="F5_6",t[t.F6_3=11]="F6_3",t[t.F7_1=12]="F7_1",t[t.F8_0=13]="F8_0",t[t.F9_0=14]="F9_0",t[t.F10_0=15]="F10_0",t[t.F11_0=16]="F11_0",t[t.F13_0=17]="F13_0",t[t.F14_0=18]="F14_0",t[t.F16_0=19]="F16_0",t[t.F18_0=20]="F18_0",t[t.F20_0=21]="F20_0",t[t.F22_0=22]="F22_0"}(wd||(wd={})),function(t){t[t.ISO100=0]="ISO100",t[t.ISO200=1]="ISO200",t[t.ISO400=2]="ISO400",t[t.ISO800=3]="ISO800"}(Pd||(Pd={})),function(t){t[t.D1=0]="D1",t[t.D2=1]="D2",t[t.D4=2]="D4",t[t.D8=3]="D8",t[t.D15=4]="D15",t[t.D30=5]="D30",t[t.D60=6]="D60",t[t.D125=7]="D125",t[t.D250=8]="D250",t[t.D500=9]="D500",t[t.D1000=10]="D1000",t[t.D2000=11]="D2000",t[t.D4000=12]="D4000"}(Id||(Id={}));var Od,Nd,Ld,Fd=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],zd=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],Vd=[100,200,400,800],Gd=new oi,Ud=new oi,kd=new Ei,Hd=Yr.STENCIL<<1,jd=[],Wd=function(){function t(t){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Td.VERTICAL,this._fov=jn(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new uo(.2,.2,.2,1),this._viewport=new Mi(0,0,1,1),this._orientedViewport=new Mi(0,0,1,1),this._curTransform=hr.IDENTITY,this._isProjDirty=!0,this._matView=new Ei,this._matProj=new Ei,this._matProjInv=new Ei,this._matViewProj=new Ei,this._matViewProjInv=new Ei,this._frustum=new Nc,this._forward=new oi,this._position=new oi,this._priority=0,this._aperture=wd.F16_0,this._apertureValue=void 0,this._shutter=Id.D125,this._shutterValue=0,this._iso=Pd.ISO100,this._isoValue=0,this._ec=0,this._window=null,this._width=1,this._height=1,this._clearFlag=Yr.NONE,this._clearDepth=1,this._visibility=Rd,this._exposure=0,this._clearStencil=0,this._device=t,this._apertureValue=Fd[this._aperture],this._shutterValue=zd[this._shutter],this._isoValue=Vd[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!jd.length){var e=t.capabilities.clipSpaceSignY;jd[hr.IDENTITY]=new Ei(1,0,0,0,0,e),jd[hr.ROTATE_90]=new Ei(0,1,0,0,-e,0),jd[hr.ROTATE_180]=new Ei(-1,0,0,0,0,-e),jd[hr.ROTATE_270]=new Ei(0,-1,0,0,e,0)}}var e=t.prototype;return e._setWidth=function(t){this._width=t},e._setHeight=function(t){this._height=t},e._setScene=function(t){this._scene=t},e._updateAspect=function(t){if(void 0===t&&(t=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),t){var e=this.window.swapchain;(e&&e.surfaceTransform||hr.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},e._init=function(){},e.initialize=function(t){this._init(t),this.node=t.node,this._setWidth(1),this._setHeight(1),this.clearFlag=Yr.NONE,this.clearDepth=1,this.visibility=Rd,this._name=t.name,this._proj=t.projection,this._priority=t.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(t.window)},e._destroy=function(){},e.destroy=function(){this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},e.attachToScene=function(t){this._enabled=!0,this._setScene(t)},e.detachFromScene=function(){this._enabled=!1,this._setScene(null)},e.resize=function(t,e){this._window&&(this._setWidth(t),this._setHeight(e),this._updateAspect())},e.setFixedSize=function(t,e){this._setWidth(t),this._setHeight(e),this._updateAspect(!1),this.isWindowSize=!1},e.syncCameraEditor=function(){},e.update=function(t){var e;if(void 0===t&&(t=!1),this._node){var n=!1;(this._node.hasChangedFlags||t)&&(Ei.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),n=!0);var i=null===(e=this.window)||void 0===e?void 0:e.swapchain,r=i&&i.surfaceTransform||hr.IDENTITY;if(this._isProjDirty||this._curTransform!==r){this._curTransform=r;var o=this._device.capabilities.clipSpaceSignY;if(this._proj===Ed.PERSPECTIVE)Ei.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Td.VERTICAL,this._device.capabilities.clipSpaceMinZ,o,r);else{var a=this._orthoHeight*this._aspect,s=this._orthoHeight;Ei.ortho(this._matProj,-a,a,-s,s,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,o,r)}Ei.invert(this._matProjInv,this._matProj),n=!0,this._isProjDirty=!1}n&&(Ei.multiply(this._matViewProj,this._matProj,this._matView),Ei.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},e.setViewportInOrientedSpace=function(t){var e,n=t.x,i=t.width,r=t.height,o=this._device.capabilities.screenSpaceSignY<0?1-t.y-r:t.y,a=null===(e=this.window)||void 0===e?void 0:e.swapchain;switch(a&&a.surfaceTransform||hr.IDENTITY){case hr.ROTATE_90:this._viewport.x=1-o-r,this._viewport.y=n,this._viewport.width=r,this._viewport.height=i;break;case hr.ROTATE_180:this._viewport.x=1-n-i,this._viewport.y=1-o-r,this._viewport.width=i,this._viewport.height=r;break;case hr.ROTATE_270:this._viewport.x=o,this._viewport.y=1-n-i,this._viewport.width=r,this._viewport.height=i;break;case hr.IDENTITY:this._viewport.x=n,this._viewport.y=o,this._viewport.width=i,this._viewport.height=r}this._orientedViewport.x=n,this._orientedViewport.y=o,this._orientedViewport.width=i,this._orientedViewport.height=r,this.resize(this.width,this.height)},e.changeTargetWindow=function(t){void 0===t&&(t=null),this._window&&this._window.detachCamera(this);var e=t||i.director.root.mainWindow;if(e){e.attachCamera(this),this.window=e;var n=e.swapchain;(n&&n.surfaceTransform||hr.IDENTITY)%2?this.resize(e.height,e.width):this.resize(e.width,e.height)}},e.detachCamera=function(){this._window&&this._window.detachCamera(this)},e.screenPointToRay=function(t,e,n){if(!this._node)return null;var i=this.width,r=this.height,o=this._orientedViewport.x*i,a=this._orientedViewport.y*r,s=this._orientedViewport.width*i,c=this._orientedViewport.height*r,l=this._proj===Ed.PERSPECTIVE,u=this._device.capabilities.clipSpaceSignY,h=Ti[this._curTransform];oi.set(Gd,(e-o)/s*2-1,(n-a)/c*2-1,l?1:-1);var _=Gd.x,f=Gd.y;return Gd.x=_*h[0]+f*h[2]*u,Gd.y=_*h[1]+f*h[3]*u,oi.transformMat4(l?Gd:t.o,Gd,this._matViewProjInv),l?(this._node.getWorldPosition(Ud),nr.fromPoints(t,Ud,Gd)):oi.transformQuat(t.d,oi.FORWARD,this._node.worldRotation),t},e.screenToWorld=function(t,e){var n=this.width,i=this.height,r=this._orientedViewport.x*n,o=this._orientedViewport.y*i,a=this._orientedViewport.width*n,s=this._orientedViewport.height*i,c=this._device.capabilities.clipSpaceSignY,l=Ti[this._curTransform];if(this._proj===Ed.PERSPECTIVE){oi.set(t,(e.x-r)/a*2-1,(e.y-o)/s*2-1,1);var u=t.x,h=t.y;t.x=u*l[0]+h*l[2]*c,t.y=u*l[1]+h*l[3]*c,oi.transformMat4(t,t,this._matViewProjInv),this._node&&this._node.getWorldPosition(Gd),oi.lerp(t,Gd,t,Hn(this._nearClip/this._farClip,1,e.z))}else{oi.set(t,(e.x-r)/a*2-1,(e.y-o)/s*2-1,2*e.z-1);var _=t.x,f=t.y;t.x=_*l[0]+f*l[2]*c,t.y=_*l[1]+f*l[3]*c,oi.transformMat4(t,t,this._matViewProjInv)}return t},e.worldToScreen=function(t,e){var n=this._device.capabilities.clipSpaceSignY,i=Ti[this._curTransform];oi.transformMat4(t,e,this._matViewProj);var r=t.x,o=t.y;t.x=r*i[0]+o*i[2]*n,t.y=r*i[1]+o*i[3]*n;var a=this.width,s=this.height,c=this._orientedViewport.x*a,l=this._orientedViewport.y*s,u=this._orientedViewport.width*a,h=this._orientedViewport.height*s;return t.x=c+.5*(t.x+1)*u,t.y=l+.5*(t.y+1)*h,t.z=.5*t.z+.5,t},e.worldMatrixToScreen=function(t,e,n,i){Ei.multiply(t,this._matViewProj,e),Ei.multiply(t,jd[this._curTransform],t);var r=n/2,o=i/2;return Ei.identity(kd),Ei.transform(kd,kd,oi.set(Gd,r,o,0)),Ei.scale(kd,kd,oi.set(Gd,r,o,1)),Ei.multiply(t,kd,t),t},e.setExposure=function(t){this._exposure=.833333/Math.pow(2,t)},e.updateExposure=function(){var t=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(t)},N(t,[{key:"node",get:function(){return this._node},set:function(t){this._node=t}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(t){this._orthoHeight=t,this._isProjDirty=!0}},{key:"projectionType",get:function(){return this._proj},set:function(t){this._proj=t,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(t){this._fovAxis=t,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(t){this._fov=t,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(t){this._nearClip=t,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(t){this._farClip=t,this._isProjDirty=!0}},{key:"clearColor",get:function(){return this._clearColor},set:function(t){this._clearColor.x=t.x,this._clearColor.y=t.y,this._clearColor.z=t.z,this._clearColor.w=t.w}},{key:"viewport",get:function(){return this._viewport},set:function(t){b(8302),this.setViewportInOrientedSpace(t)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum},set:function(t){this._frustum=t}},{key:"window",get:function(){return this._window},set:function(t){this._window=t}},{key:"forward",get:function(){return this._forward},set:function(t){this._forward=t}},{key:"position",get:function(){return this._position},set:function(t){this._position=t}},{key:"visibility",get:function(){return this._visibility},set:function(t){this._visibility=t}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"aperture",get:function(){return this._aperture},set:function(t){this._aperture=t,this._apertureValue=Fd[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(t){this._shutter=t,this._shutterValue=zd[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(t){this._iso=t,this._isoValue=Vd[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",get:function(){return this._ec},set:function(t){this._ec=t}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(t){this._clearFlag=t}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(t){this._clearDepth=t}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(t){this._clearStencil=t}},{key:"native",get:function(){return this._nativeObj}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),t}();function qd(t,e){e<1e3?e=1e3:e>15e3&&(e=15e3);var n=e*e,i=(.860117757+.000154118254*e+1.28641212e-7*n)/(1+.000842420235*e+7.08145163e-7*n),r=(.317398726+422806245e-13*e+4.20481691e-8*n)/(1-289741816e-13*e+1.61456053e-7*n),o=2*i-8*r+4,a=3*i/o,s=2*r/o,c=1/s*a,l=1/s*(1-a-s);t.x=3.2404542*c-1.5371385+-.4985314*l,t.y=-.969266*c+1.8760108+.041556*l,t.z=.0556434*c-.2040259+1.0572252*l}!function(t){t[t.LOCAL=0]="LOCAL",t[t.WORLD=1]="WORLD"}(Od||(Od={})),function(t){t[t.NONE=0]="NONE",t[t.POSITION=1]="POSITION",t[t.ROTATION=2]="ROTATION",t[t.SCALE=4]="SCALE",t[t.RS=t.ROTATION|t.SCALE]="RS",t[t.TRS=t.POSITION|t.ROTATION|t.SCALE]="TRS",t[t.TRS_MASK=~t.TRS]="TRS_MASK"}(Nd||(Nd={})),i.internal.TransformBit=Nd,function(t){t[t.DIRECTIONAL=0]="DIRECTIONAL",t[t.SPHERE=1]="SPHERE",t[t.SPOT=2]="SPOT",t[t.UNKNOWN=3]="UNKNOWN"}(Ld||(Ld={}));var Xd,Yd,Kd,Jd,Qd,Zd,$d,tm=function(t){return 4*Math.PI*Math.PI*t*t},em=function(){function t(){this._baked=!1,this._color=new oi(1,1,1),this._colorTemp=6550,this._colorTempRGB=new oi(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=Ld.UNKNOWN}var e=t.prototype;return e._init=function(){},e._destroy=function(){},e.initialize=function(){this._init(),this.color=new oi(1,1,1),this.colorTemperature=6550},e.attachToScene=function(t){this._scene=t},e.detachFromScene=function(){this._scene=null},e.destroy=function(){this._name=null,this._node=null,this._destroy()},e.update=function(){},N(t,[{key:"baked",get:function(){return this._baked},set:function(t){this._baked=t}},{key:"color",get:function(){return this._color},set:function(t){this._color.set(t)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(t){this._useColorTemperature=t}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(t){this._colorTemp=t,qd(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(t){this._node=t,this._node&&(this._node.hasChangedFlags|=Nd.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]),t}(),nm=new oi(0,0,-1),im=new oi,rm=function(t){function e(){var e;return(e=t.call(this)||this)._dir=new oi(1,-1,-1),e._illuminanceHDR=Ui.SUN_ILLUM,e._illuminanceLDR=1,e._type=Ld.DIRECTIONAL,e}F(e,t);var n=e.prototype;return n.initialize=function(){t.prototype.initialize.call(this),this.illuminance=Ui.SUN_ILLUM,this.direction=new oi(1,-1,-1)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=oi.transformQuat(im,nm,this._node.worldRotation))},N(e,[{key:"direction",get:function(){return this._dir},set:function(t){oi.normalize(this._dir,t)}},{key:"illuminance",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=t:this.illuminanceLDR=t}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(t){this._illuminanceHDR=t}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(t){this._illuminanceLDR=t}}]),e}(em),om=1024;function am(t){return!!(i.sys.hasFeature(i.sys.Feature.IMAGE_BITMAP)&&t instanceof ImageBitmap)}!function(t){t[t.RGB565=fr.R5G6B5]="RGB565",t[t.RGB5A1=fr.RGB5A1]="RGB5A1",t[t.RGBA4444=fr.RGBA4]="RGBA4444",t[t.RGB888=fr.RGB8]="RGB888",t[t.RGB32F=fr.RGB32F]="RGB32F",t[t.RGBA8888=fr.RGBA8]="RGBA8888",t[t.RGBA32F=fr.RGBA32F]="RGBA32F",t[t.A8=fr.A8]="A8",t[t.I8=fr.L8]="I8",t[t.AI8=fr.LA8]="AI8",t[t.RGB_PVRTC_2BPPV1=fr.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",t[t.RGBA_PVRTC_2BPPV1=fr.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",t[t.RGB_A_PVRTC_2BPPV1=om++]="RGB_A_PVRTC_2BPPV1",t[t.RGB_PVRTC_4BPPV1=fr.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",t[t.RGBA_PVRTC_4BPPV1=fr.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",t[t.RGB_A_PVRTC_4BPPV1=om++]="RGB_A_PVRTC_4BPPV1",t[t.RGB_ETC1=fr.ETC_RGB8]="RGB_ETC1",t[t.RGBA_ETC1=om++]="RGBA_ETC1",t[t.RGB_ETC2=fr.ETC2_RGB8]="RGB_ETC2",t[t.RGBA_ETC2=fr.ETC2_RGBA8]="RGBA_ETC2",t[t.RGBA_ASTC_4x4=fr.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",t[t.RGBA_ASTC_5x4=fr.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",t[t.RGBA_ASTC_5x5=fr.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",t[t.RGBA_ASTC_6x5=fr.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",t[t.RGBA_ASTC_6x6=fr.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",t[t.RGBA_ASTC_8x5=fr.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",t[t.RGBA_ASTC_8x6=fr.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",t[t.RGBA_ASTC_8x8=fr.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",t[t.RGBA_ASTC_10x5=fr.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",t[t.RGBA_ASTC_10x6=fr.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",t[t.RGBA_ASTC_10x8=fr.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",t[t.RGBA_ASTC_10x10=fr.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",t[t.RGBA_ASTC_12x10=fr.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",t[t.RGBA_ASTC_12x12=fr.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(Xd||(Xd={})),function(t){t[t.REPEAT=Er.WRAP]="REPEAT",t[t.CLAMP_TO_EDGE=Er.CLAMP]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=Er.MIRROR]="MIRRORED_REPEAT",t[t.CLAMP_TO_BORDER=Er.BORDER]="CLAMP_TO_BORDER"}(Yd||(Yd={})),function(t){t[t.NONE=Tr.NONE]="NONE",t[t.LINEAR=Tr.LINEAR]="LINEAR",t[t.NEAREST=Tr.POINT]="NEAREST"}(Kd||(Kd={}));var sm,cm,lm,um,hm,_m,fm,pm,dm,mm,vm,gm,ym=t("ImageAsset",qc("cc.ImageAsset")(($d=Zd=function(t){function e(e){var n;return(n=t.call(this)||this)._nativeData=void 0,n._exportedExts=void 0,n._format=Xd.RGBA8888,n._width=0,n._height=0,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&n.reset(e),n}F(e,t);var n=e.prototype;return n.reset=function(t){am(t)||t instanceof HTMLElement?this._nativeData=t:(this._nativeData=t,this._format=t.format)},n.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):am(this.data)&&this.data.close&&this.data.close(),t.prototype.destroy.call(this)},n._serialize=function(){},n._deserialize=function(t){var n="";"string"==typeof t?n=t:(this._width=t.w,this._height=t.h,n=t.fmt);for(var r,o=i.director.root?i.director.root.device:null,a=n.split("_"),s=Number.MAX_VALUE,c=this._format,l="",u=i.macro.SUPPORT_TEXTURE_FORMATS,h=W(a);!(r=h()).done;){var _=r.value.split("@"),f=parseInt(_[0],void 0),p=e.extnames[f]||_[0],d=u.indexOf(p);if(-1!==d&&d<s){var m=_[1]?parseInt(_[1]):this._format;if(!(".astc"!==p||o&&o.hasFeature(_r.FORMAT_ASTC)))continue;if(!(".pvr"!==p||o&&o.hasFeature(_r.FORMAT_PVRTC)))continue;if(!(m!==Xd.RGB_ETC1&&m!==Xd.RGBA_ETC1||o&&o.hasFeature(_r.FORMAT_ETC1)))continue;if(!(m!==Xd.RGB_ETC2&&m!==Xd.RGBA_ETC2||o&&o.hasFeature(_r.FORMAT_ETC2)))continue;if(".webp"===p&&!i.sys.hasFeature(i.sys.Feature.WEBP))continue;s=d,l=p,c=m}}l?(this._setRawAsset(l),this._format=c):b(3121)},n.initDefault=function(n){if(t.prototype.initDefault.call(this,n),e._sharedPlaceHolderCanvas)this.reset(e._sharedPlaceHolderCanvas);else{var i=document.createElement("canvas"),r=i.getContext("2d"),o=i.width=i.height=2;r.fillStyle="#ff00ff",r.fillRect(0,0,o,o),this.reset(i),e._sharedPlaceHolderCanvas=i}},n.validate=function(){return!!this.data},N(e,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(t){t instanceof HTMLElement||am(t)||(t.format=t.format||this._format),this.reset(t)}},{key:"data",get:function(){return this._nativeData&&((t=this._nativeData)instanceof HTMLImageElement||t instanceof HTMLCanvasElement||am(t))?this._nativeData:this._nativeData&&this._nativeData._data;var t}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=Xd.RGB_ETC1&&this._format<=Xd.RGBA_ASTC_12x12||this._format>=Xd.RGB_A_PVRTC_2BPPV1&&this._format<=Xd.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}}]),e}(Su),Zd.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],Zd._sharedPlaceHolderCanvas=null,X((Qd=$d).prototype,"_nativeAsset",[Ll],Object.getOwnPropertyDescriptor(Qd.prototype,"_nativeAsset"),Qd.prototype),Jd=Qd))||Jd);i.ImageAsset=ym,$t(fr);var xm=new et("Tex"),Sm=qc("cc.TextureBase")((gm=vm=function(t){function e(){var e;return q(e=t.call(this)||this,"_format",lm,H(e)),q(e,"_minFilter",um,H(e)),q(e,"_magFilter",hm,H(e)),q(e,"_mipFilter",_m,H(e)),q(e,"_wrapS",fm,H(e)),q(e,"_wrapT",pm,H(e)),q(e,"_wrapR",dm,H(e)),q(e,"_anisotropy",mm,H(e)),e._width=1,e._height=1,e._id=void 0,e._samplerInfo=new Ao,e._gfxSampler=null,e._gfxDevice=null,e._textureHash=0,e._id=xm.getNewId(),e._gfxDevice=e._getGFXDevice(),e._textureHash=xa(e._id,666),e}F(e,t);var n=e.prototype;return n.getId=function(){return this._id},n.getPixelFormat=function(){return this._format},n.getAnisotropy=function(){return this._anisotropy},n.setWrapMode=function(t,e,n){void 0===n&&(n=t),this._wrapS=t,this._samplerInfo.addressU=t,this._wrapT=e,this._samplerInfo.addressV=e,this._wrapR=n,this._samplerInfo.addressW=n,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setFilters=function(t,e){this._minFilter=t,this._samplerInfo.minFilter=t,this._magFilter=e,this._samplerInfo.magFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setMipFilter=function(t){this._mipFilter=t,this._samplerInfo.mipFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setAnisotropy=function(t){this._anisotropy=t,this._samplerInfo.maxAnisotropy=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.destroy=function(){var e,n=t.prototype.destroy.call(this);return n&&(null===(e=i.director.root)||void 0===e?void 0:e.batcher2D)&&i.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),n},n.getHash=function(){return this._textureHash},n.getGFXTexture=function(){return null},n.getSamplerInfo=function(){return this._samplerInfo},n.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):E(9302)),this._gfxSampler},n._serialize=function(){return""},n._deserialize=function(t){var e=t.split(",");e.unshift(""),e.length>=5&&(this.setFilters(parseInt(e[1]),parseInt(e[2])),this.setWrapMode(parseInt(e[3]),parseInt(e[4]))),e.length>=7&&(this.setMipFilter(parseInt(e[5])),this.setAnisotropy(parseInt(e[6])))},n._getGFXDevice=function(){return i.director.root?i.director.root.device:null},n._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},n._setGFXFormat=function(t){this._format=void 0===t?Xd.RGBA8888:t},n._getGFXPixelFormat=function(t){return t===Xd.RGBA_ETC1?t=Xd.RGB_ETC1:t===Xd.RGB_A_PVRTC_4BPPV1?t=Xd.RGB_PVRTC_4BPPV1:t===Xd.RGB_A_PVRTC_2BPPV1&&(t=Xd.RGB_PVRTC_2BPPV1),t},N(e,[{key:"isCompressed",get:function(){return this._format>=Xd.RGB_ETC1&&this._format<=Xd.RGBA_ASTC_12x12||this._format>=Xd.RGB_A_PVRTC_2BPPV1&&this._format<=Xd.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),e}(Su),vm.PixelFormat=Xd,vm.WrapMode=Yd,vm.Filter=Kd,lm=X((cm=gm).prototype,"_format",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xd.RGBA8888}}),um=X(cm.prototype,"_minFilter",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kd.LINEAR}}),hm=X(cm.prototype,"_magFilter",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kd.LINEAR}}),_m=X(cm.prototype,"_mipFilter",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kd.NONE}}),fm=X(cm.prototype,"_wrapS",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yd.REPEAT}}),pm=X(cm.prototype,"_wrapT",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yd.REPEAT}}),dm=X(cm.prototype,"_wrapR",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yd.REPEAT}}),mm=X(cm.prototype,"_anisotropy",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sm=cm))||sm;i.TextureBase=Sm;var Am=new WeakMap,Cm=new WeakSet,bm=new WeakSet;function Tm(t,e){var n;n=Wu.safeFindClass;var i,r=fh.pool.get();try{i=Th(t,r,{classFinder:n,customEnv:e})}catch(t){throw d(t),fh.pool.put(r),t}i._uuid=e.__uuid__||"";for(var o=r.uuidList,a=r.uuidObjList,s=r.uuidPropList,c=r.uuidTypeList||[],l=[],u=0;u<o.length;u++){var h=o[u];l[u]={uuid:ru(h),owner:a[u],prop:s[u],type:kt._getClassById(c[u])}}return Am.set(i,l),i._native&&Cm.add(i),fh.pool.put(r),i}var Em,wm=new(function(){function t(){this._depends=new Ul}var e=t.prototype;return e.init=function(){this._depends.clear()},e.getNativeDep=function(t){var e=this._depends.get(t);return e&&e.nativeDep?L({},e.nativeDep):null},e.getDeps=function(t){return this._depends.has(t)?this._depends.get(t).deps:[]},e.getDepsRecursively=function(t){var e=Object.create(null),n=[];return this._descend(t,e,n),n},e.remove=function(t){this._depends.remove(t)},e.parse=function(t,e){var n,i,r=null;if(Array.isArray(e)||e.__type__||e instanceof eh){if(this._depends.has(t))return this._depends.get(t);if(!Array.isArray(e)||"number"==typeof(i=(n=e[5])[n.length-1])&&i<0)try{var o=Tm(e,{__uuid__:t});(r=this._parseDepsFromAsset(o)).nativeDep&&(r.nativeDep.uuid=t),ql.add(t+"@import",o)}catch(e){Wl.remove(t+"@import"),r={deps:[]}}else r={deps:this._parseDepsFromJson(e)}}else{if(this._depends.has(t)&&(r=this._depends.get(t)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(e)}return this._depends.add(t,r),r},e._parseDepsFromAsset=function(t){for(var e={deps:[],parsedFromExistAsset:!0},n=Am.get(t),i=0,r=n.length;i<r;i++)e.deps.push(n[i].uuid);return Cm.has(t)&&(e.nativeDep=t._nativeDep),e},e._parseDepsFromJson=function(t){var e=function(t){return n=(e=t)[1],e[10].map((function(t){return n[t]}));var e,n}(t);return e.forEach((function(t,n){return e[n]=ru(t)})),e},e._descend=function(t,e,n){for(var i=this.getDeps(t),r=0;r<i.length;r++){var o=i[r];e[o]||(e[o]=!0,n.push(o),this._descend(o,e,n))}},t}()),Pm=[new co];function Im(t){return t&&0==(t&t-1)}var Rm,Dm,Bm,Mm,Om,Nm,Lm=qc("cc.SimpleTexture")(Em=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gfxTexture=null,e._mipmapLevel=1,e._textureWidth=0,e._textureHeight=0,e}F(e,t);var n=e.prototype;return n.getGFXTexture=function(){return this._gfxTexture},n.destroy=function(){return this._tryDestroyTexture(),t.prototype.destroy.call(this)},n.updateImage=function(){this.updateMipmaps(0)},n.updateMipmaps=function(){},n.uploadData=function(t,e,n){if(void 0===e&&(e=0),void 0===n&&(n=0),this._gfxTexture&&!(this._mipmapLevel<=e)){var i=this._getGFXDevice();if(i){var r=Pm[0];r.texExtent.width=this._textureWidth>>e,r.texExtent.height=this._textureHeight>>e,r.texSubres.mipLevel=e,r.texSubres.baseArrayLayer=n,ArrayBuffer.isView(t)?i.copyBuffersToTexture([t],this._gfxTexture,Pm):i.copyTexImagesToTexture([t],this._gfxTexture,Pm)}}},n._assignImage=function(t,e,n){var i=t.data;if(i&&(this.uploadData(i,e,n),this._checkTextureLoaded(),ee.CLEANUP_IMAGE_CACHE)){var r=wm.getDeps(this._uuid),o=r.indexOf(t._uuid);-1!==o&&(J(r,o),t.decRef())}},n._checkTextureLoaded=function(){this._textureReady()},n._textureReady=function(){this.loaded=!0,this.emit("load")},n._setMipmapLevel=function(t){this._mipmapLevel=t<1?1:t},n._getGfxTextureCreateInfo=function(){return null},n._tryReset=function(){if(this._tryDestroyTexture(),0!==this._mipmapLevel){var t=this._getGFXDevice();t&&this._createTexture(t)}},n._createTexture=function(t){if(0!==this._width&&0!==this._height){var e=Ar.NONE;this._mipFilter!==Kd.NONE&&function(t,e,n){return!(t.gfxAPI===ur.WEBGL)||Im(e)&&Im(n)}(t,this._width,this._height)&&(this._mipmapLevel=function(t,e){for(var n=Math.max(t,e),i=0;n;)n>>=1,i++;return i}(this._width,this._height),e=Ar.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:Sr.SAMPLED|Sr.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:e});if(n){var i=t.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}}},n._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},N(e,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),e}(Sm))||Em;i.SimpleTexture=Lm;var Fm,zm,Vm,Gm,Um,km,Hm,jm=t("Texture2D",(Rm=qc("cc.Texture2D"),Dm=El([ym]),Rm((Nm=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_mipmaps",Om,H(e)),e}F(e,t);var n=e.prototype;return n.initialize=function(){this.mipmaps=this._mipmaps},n.onLoaded=function(){this.initialize()},n.reset=function(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()},n.create=function(t,e,n,i){void 0===n&&(n=Xd.RGBA8888),void 0===i&&(i=1),this.reset({width:t,height:e,format:n,mipmapLevel:i})},n.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},n.updateMipmaps=function(t,e){if(void 0===t&&(t=0),!(t>=this._mipmaps.length))for(var n=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t),i=0;i<n;++i){var r=t+i;this._assignImage(this._mipmaps[r],r)}},n.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},n.destroy=function(){return this._mipmaps=[],t.prototype.destroy.call(this)},n.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},n.releaseTexture=function(){this.destroy()},n._serialize=function(){return null},n._deserialize=function(e,n){var i=e;t.prototype._deserialize.call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new ym,i.mipmaps[r]){var o=i.mipmaps[r];n.result.push(this._mipmaps,""+r,o,kt._getClassId(ym))}},n._getGfxTextureCreateInfo=function(t){var e=new xo(xr.TEX2D);return e.width=this._width,e.height=this._height,Object.assign(e,t)},n.initDefault=function(e){t.prototype.initDefault.call(this,e);var n=new ym;n.initDefault(),this.image=n},n.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},N(e,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(t){var e=this;if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(t,n){e._assignImage(t,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(t){this.mipmaps=t?[t]:[]}}]),e}(Lm),Om=X((Mm=Nm).prototype,"_mipmaps",[Dm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Bm=Mm))||Bm));i.Texture2D=jm,function(t){t[t.right=0]="right",t[t.left=1]="left",t[t.top=2]="top",t[t.bottom=3]="bottom",t[t.front=4]="front",t[t.back=5]="back"}(Hm||(Hm={}));var Wm=t("TextureCube",qc("cc.TextureCube")((km=Um=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"isRGBE",Vm,H(e)),q(e,"_mipmaps",Gm,H(e)),e}F(e,t),e.fromTexture2DArray=function(t,n){for(var i=[],r=t.length/6,o=0;o<r;o++){var a=6*o;i.push({front:t[a+Hm.front].image,back:t[a+Hm.back].image,left:t[a+Hm.left].image,right:t[a+Hm.right].image,top:t[a+Hm.top].image,bottom:t[a+Hm.bottom].image})}return(n=n||new e).mipmaps=i,n};var n=e.prototype;return n.onLoaded=function(){this.mipmaps=this._mipmaps},n.reset=function(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()},n.updateMipmaps=function(t,e){var n=this;if(void 0===t&&(t=0),!(t>=this._mipmaps.length))for(var i=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t),r=function(e){var i=t+e;qm(n._mipmaps[i],(function(t,e){n._assignImage(t,i,e)}))},o=0;o<i;++o)r(o)},n.destroy=function(){return this._mipmaps=[],t.prototype.destroy.call(this)},n.releaseTexture=function(){this.mipmaps=[]},n._serialize=function(){return null},n._deserialize=function(e,n){var i=e;t.prototype._deserialize.call(this,i.base,n),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new ym,back:new ym,left:new ym,right:new ym,top:new ym,bottom:new ym};var o=i.mipmaps[r],a=kt._getClassId(ym);n.result.push(this._mipmaps[r],"front",o.front,a),n.result.push(this._mipmaps[r],"back",o.back,a),n.result.push(this._mipmaps[r],"left",o.left,a),n.result.push(this._mipmaps[r],"right",o.right,a),n.result.push(this._mipmaps[r],"top",o.top,a),n.result.push(this._mipmaps[r],"bottom",o.bottom,a)}},n._getGfxTextureCreateInfo=function(t){var e=new xo(xr.CUBE);return e.width=this._width,e.height=this._height,e.layerCount=6,Object.assign(e,t),e},n.initDefault=function(e){t.prototype.initDefault.call(this,e);var n=new ym;n.initDefault(),this.mipmaps=[{front:n,back:n,top:n,bottom:n,left:n,right:n}]},n.validate=function(){return 0!==this._mipmaps.length&&!this._mipmaps.find((function(t){return!(t.top&&t.bottom&&t.front&&t.back&&t.left&&t.right)}))},N(e,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(t){var e=this;if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(t,n){qm(t,(function(t,i){e._assignImage(t,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(t){this.mipmaps=t?[t]:[]}}]),e}(Lm),Um.FaceIndex=Hm,Vm=X((zm=km).prototype,"isRGBE",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gm=X(zm.prototype,"_mipmaps",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fm=zm))||Fm);function qm(t,e){e(t.front,Hm.front),e(t.back,Hm.back),e(t.left,Hm.left),e(t.right,Hm.right),e(t.top,Hm.top),e(t.bottom,Hm.bottom)}i.TextureCube=Wm;var Xm,Ym,Km=t("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:2909832090,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:2610213142,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1},{name:"a_dist",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"occlusion-query",techniques:[{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blendColorMask:0}]},program:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",hash:1571978323,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:41,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCWorldBound",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:1250077034,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:63,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"USE_VK_SHADER",type:"boolean"},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position_starttime",defines:[],format:44,location:0},{name:"a_size_uv",defines:[],format:44,location:1},{name:"a_rotation_uv",defines:[],format:44,location:2},{name:"a_color",defines:[],format:44,location:3},{name:"a_dir_life",defines:[],format:44,location:4},{name:"a_rndSeed",defines:[],format:11,location:5},{name:"a_texCoord",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",defines:["CC_RENDER_MODE"],format:44,location:9}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:1437790364,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:44,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:2766437914,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:32,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4},{name:"a_color1",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:7}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:3192452405,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2},{name:"a_color2",defines:["TWO_COLORED"],format:44,location:3}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite-gpu",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite-gpu|sprite-vs-gpu:vert|sprite-fs-gpu:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"sprite-gpu|sprite-vs-gpu:vert|sprite-fs-gpu:frag",hash:2450198964,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCUILocal",defines:[]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_batch_id",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1770338543,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],linear:!0,type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},normalStrenth:{value:[1],type:13,handleInfo:["emissiveScaleParam",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},emissiveScaleParam:{type:16,value:[1,1,1,1]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:4038009253,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:222,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_TWOSIDE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13},{name:"a_texCoord1",defines:[],format:21,location:14}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:7},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:8},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:9}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:210600745,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:183,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_texCoord1",defines:[],format:21,location:13}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:3916952624,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:70,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:61},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:12},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:13},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:14}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:4270039829,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:68,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{linear:!0,type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3319190198,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:197,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:41},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"bloom",techniques:[{passes:[{phase:"bloom-prefilter",program:"bloom|bloom-vs|prefilter-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-combine",program:"bloom|bloom-vs|combine-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"bloom|bloom-vs|prefilter-fs",hash:2185821616,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|downsample-fs",hash:1780231359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|upsample-fs",hash:3580425335,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|combine-fs",hash:3457196798,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:3788484086,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCForwardLight",defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[{name:"depth_stencil",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:4},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:5},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:6}],images:[],textures:[],samplers:[],subpassInputs:[{name:"gbuffer_albedoMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:0},{name:"gbuffer_normalMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:1},{name:"gbuffer_emissiveMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:2}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:2672216600,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:216,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:3237848814,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"ANTIALIAS_TYPE",type:"number",range:[0,3]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:0}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:3653711100,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",priority:255,depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:179162168,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},percent:{value:[.5],type:13,handleInfo:["u_percent",0,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,0,0]},u_percent:{type:13,value:[.5]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:3189094080,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:21,location:0},{name:"a_texCoord",defines:[],format:21,location:1}],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]},{name:"Factor",defines:[],binding:1,stageFlags:16,members:[{name:"u_percent",type:13,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]}]),Jm=4227858432,Qm=66060288,Zm=1044480,$m=function(t,e,n,i){return void 0===i&&(i=0),e<<26&Jm|t<<20&Qm|n<<12&Zm|4095&i},tv=function(t){return(t&Jm)>>>26},ev=function(t){return(t&Qm)>>>20},nv=function(t){return(t&Zm)>>>12},iv=function(t){return 4095&t},rv=function(t,e){return 67108863&t|e<<26&Jm},ov=((Xm={})[dr.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Xm[dr.INT]=function(t,e,n){return void 0===n&&(n=0),t[n]},Xm[dr.INT2]=function(t,e,n){return void 0===n&&(n=0),li.fromArray(e,t,n)},Xm[dr.INT3]=function(t,e,n){return void 0===n&&(n=0),oi.fromArray(e,t,n)},Xm[dr.INT4]=function(t,e,n){return void 0===n&&(n=0),fi.fromArray(e,t,n)},Xm[dr.FLOAT]=function(t,e,n){return void 0===n&&(n=0),t[n]},Xm[dr.FLOAT2]=function(t,e,n){return void 0===n&&(n=0),li.fromArray(e,t,n)},Xm[dr.FLOAT3]=function(t,e,n){return void 0===n&&(n=0),oi.fromArray(e,t,n)},Xm[dr.FLOAT4]=function(t,e,n){return void 0===n&&(n=0),fi.fromArray(e,t,n)},Xm[dr.MAT3]=function(t,e,n){return void 0===n&&(n=0),di.fromArray(e,t,n)},Xm[dr.MAT4]=function(t,e,n){return void 0===n&&(n=0),Ei.fromArray(e,t,n)},Xm),av=((Ym={})[dr.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Ym[dr.INT]=function(t,e,n){return void 0===n&&(n=0),t[n]=e},Ym[dr.INT2]=function(t,e,n){return void 0===n&&(n=0),li.toArray(t,e,n)},Ym[dr.INT3]=function(t,e,n){return void 0===n&&(n=0),oi.toArray(t,e,n)},Ym[dr.INT4]=function(t,e,n){return void 0===n&&(n=0),fi.toArray(t,e,n)},Ym[dr.FLOAT]=function(t,e,n){return void 0===n&&(n=0),t[n]=e},Ym[dr.FLOAT2]=function(t,e,n){return void 0===n&&(n=0),li.toArray(t,e,n)},Ym[dr.FLOAT3]=function(t,e,n){return void 0===n&&(n=0),oi.toArray(t,e,n)},Ym[dr.FLOAT4]=function(t,e,n){return void 0===n&&(n=0),fi.toArray(t,e,n)},Ym[dr.MAT3]=function(t,e,n){return void 0===n&&(n=0),di.toArray(t,e,n)},Ym[dr.MAT4]=function(t,e,n){return void 0===n&&(n=0),Ei.toArray(t,e,n)},Ym),sv=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function cv(t){switch(t){case dr.BOOL:case dr.INT:case dr.UINT:case dr.FLOAT:return sv[0];case dr.BOOL2:case dr.INT2:case dr.UINT2:case dr.FLOAT2:return sv[1];case dr.BOOL4:case dr.INT4:case dr.UINT4:case dr.FLOAT4:return sv[2];case dr.MAT4:return sv[3];case dr.SAMPLER2D:return"default-texture";case dr.SAMPLER_CUBE:return"default-cube-texture"}return sv[0]}function lv(t,e){for(var n=Object.entries(e),i=!1,r=0;r<n.length;r++)t[n[r][0]]!==n[r][1]&&(t[n[r][0]]=n[r][1],i=!0);return i}var uv=new jo;function hv(t){return Math.ceil(Math.log2(Math.max(t,2)))}function _v(t,e){switch(t.type){case"boolean":return"number"==typeof e?e.toString():e?"1":"0";case"string":return void 0!==e?e:t.options[0];case"number":return void 0!==e?e.toString():t.range[0].toString();default:return console.warn("unknown define type '"+t.type+"'"),"-1"}}function fv(t,e,n,i,r){for(var o=t.builtins[i],a=[],s=function(t){var e=o.blocks[t],i=n.layouts[e.name],s=i&&n.bindings.find((function(t){return t.binding===i.binding}));if(!(i&&s&&s.descriptorType&ia))return console.warn("builtin UBO '"+e.name+"' not available!"),"continue";a.push(i),r&&!r.includes(s)&&r.push(s)},c=0;c<o.blocks.length;c++)s(c);Array.prototype.unshift.apply(e.shaderInfo.blocks,a);for(var l=[],u=function(t){var e=o.samplerTextures[t],i=n.layouts[e.name],a=i&&n.bindings.find((function(t){return t.binding===i.binding}));if(!(i&&a&&a.descriptorType&ra))return console.warn("builtin samplerTexture '"+e.name+"' not available!"),"continue";l.push(i),r&&!r.includes(a)&&r.push(a)},h=0;h<o.samplerTextures.length;h++)u(h);Array.prototype.unshift.apply(e.shaderInfo.samplerTextures,l),r&&r.sort((function(t,e){return t.binding-e.binding}))}function pv(t){return t.members.reduce((function(t,e){return t+ua(e.type)*e.count}),0)}function dv(t,e){for(var n=0;n<t.length;n++){var i=t[n];if("!"===i[0]){if(e[i.slice(1)])return!1}else if(!e[i])return!1}return!0}function mv(t){switch(t.gfxAPI){case ur.GLES2:case ur.WEBGL:return"glsl1";case ur.GLES3:case ur.WEBGL2:return"glsl3";default:return"glsl4"}}var vv=new(function(){function t(){this._templates={},this._cache={},this._templateInfos={}}var e=t.prototype;return e.register=function(t){for(var e=0;e<t.shaders.length;e++)this.define(t.shaders[e]).effectName=t.name;for(var n=0;n<t.techniques.length;n++)for(var i=t.techniques[n],r=0;r<i.passes.length;r++){var o=i.passes[r];void 0!==o.propertyIndex&&void 0===o.properties&&(o.properties=i.passes[o.propertyIndex].properties)}},e.define=function(t){var e=this._templates[t.name];if(e&&e.hash===t.hash)return e;for(var n=L({},t),i=0,r=function(t){var e=n.defines[t],r=1;if("number"===e.type){var o=e.range;r=hv(o[1]-o[0]+1),e._map=function(t){return t-o[0]}}else"string"===e.type?(r=hv(e.options.length),e._map=function(t){return Math.max(0,e.options.findIndex((function(e){return e===t})))}):"boolean"===e.type&&(e._map=function(t){return t?1:0});e._offset=i,i+=r},o=0;o<n.defines.length;o++)r(o);for(var a in i>31&&(n.uber=!0),n.constantMacros="",n.builtins.statistics)n.constantMacros+="#define "+a+" "+n.builtins.statistics[a]+"\n";if(this._templates[t.name]=n,!this._templateInfos[n.hash]){var s={};s.samplerStartBinding=n.blocks.length,s.shaderInfo=new Mo,s.blockSizes=[],s.bindings=[];for(var c=0;c<n.blocks.length;c++){var l=n.blocks[c];s.blockSizes.push(pv(l)),s.bindings.push(new Ho(l.binding,jr.UNIFORM_BUFFER,1,l.stageFlags)),s.shaderInfo.blocks.push(new bo(Tp.MATERIAL,l.binding,l.name,l.members.map((function(t){return new Co(t.name,t.type,t.count)})),1))}for(var u=0;u<n.samplerTextures.length;u++){var h=n.samplerTextures[u];s.bindings.push(new Ho(h.binding,jr.SAMPLER_TEXTURE,h.count,h.stageFlags)),s.shaderInfo.samplerTextures.push(new To(Tp.MATERIAL,h.binding,h.name,h.type,h.count))}for(var _=0;_<n.samplers.length;_++){var f=n.samplers[_];s.bindings.push(new Ho(f.binding,jr.SAMPLER,f.count,f.stageFlags)),s.shaderInfo.samplers.push(new Eo(Tp.MATERIAL,f.binding,f.name,f.count))}for(var p=0;p<n.textures.length;p++){var d=n.textures[p];s.bindings.push(new Ho(d.binding,jr.TEXTURE,d.count,d.stageFlags)),s.shaderInfo.textures.push(new wo(Tp.MATERIAL,d.binding,d.name,d.type,d.count))}for(var m=0;m<n.buffers.length;m++){var v=n.buffers[m];s.bindings.push(new Ho(v.binding,jr.STORAGE_BUFFER,1,v.stageFlags)),s.shaderInfo.buffers.push(new Io(Tp.MATERIAL,v.binding,v.name,1,v.memoryAccess))}for(var g=0;g<n.images.length;g++){var y=n.images[g];s.bindings.push(new Ho(y.binding,jr.STORAGE_IMAGE,y.count,y.stageFlags)),s.shaderInfo.images.push(new Po(Tp.MATERIAL,y.binding,y.name,y.type,y.count,y.memoryAccess))}for(var x=0;x<n.subpassInputs.length;x++){var S=n.subpassInputs[x];s.bindings.push(new Ho(S.binding,jr.INPUT_ATTACHMENT,S.count,S.stageFlags)),s.shaderInfo.subpassInputs.push(new Ro(Tp.MATERIAL,S.binding,S.name,S.count))}s.gfxAttributes=[];for(var A=0;A<n.attributes.length;A++){var C=n.attributes[A];s.gfxAttributes.push(new Bo(C.name,C.format,C.isNormalized,0,C.isInstanced,C.location))}fv(n,s,Sp,"locals"),s.shaderInfo.stages.push(new Do(Br.VERTEX,"")),s.shaderInfo.stages.push(new Do(Br.FRAGMENT,"")),s.handleMap=function(t){for(var e={},n=0;n<t.blocks.length;n++)for(var i=t.blocks[n],r=i.members,o=0,a=0;a<r.length;a++){var s=r[a];e[s.name]=$m(i.binding,s.type,s.count,o),o+=(ua(s.type)>>2)*s.count}for(var c=0;c<t.samplerTextures.length;c++){var l=t.samplerTextures[c];e[l.name]=$m(l.binding,l.type,l.count)}return e}(n),s.setLayouts=[],this._templateInfos[n.hash]=s}return n},e.getTemplate=function(t){return this._templates[t]},e.getTemplateInfo=function(t){var e=this._templates[t].hash;return this._templateInfos[e]},e.getDescriptorSetLayout=function(t,e,n){void 0===n&&(n=!1);var i=this._templates[e],r=this._templateInfos[i.hash];return r.setLayouts.length||(uv.bindings=r.bindings,r.setLayouts[Tp.MATERIAL]=t.createDescriptorSetLayout(uv),uv.bindings=Sp.bindings,r.setLayouts[Tp.LOCAL]=t.createDescriptorSetLayout(uv)),r.setLayouts[n?Tp.LOCAL:Tp.MATERIAL]},e.hasProgram=function(t){return void 0!==this._templates[t]},e.getKey=function(t,e){var n=this._templates[t],i=n.defines;if(n.uber){for(var r="",o=0;o<i.length;o++){var a=i[o],s=e[a.name];if(s&&a._map){var c=a._map(s);r+=""+a._offset+c+"|"}}return""+r+n.hash}for(var l=0,u=0;u<i.length;u++){var h=i[u],_=e[h.name];_&&h._map&&(l|=h._map(_)<<h._offset)}return l.toString(16)+"|"+n.hash},e.destroyShaderByDefines=function(t){var e=this,n=Object.keys(t);if(n.length)for(var i=n.map((function(e){var n=t[e];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(""+e+n)})),r=Object.keys(this._cache).filter((function(t){return i.every((function(n){return n.test(e._cache[t].name)}))})),o=0;o<r.length;o++){var a=r[o],s=this._cache[a];v("destroyed shader "+s.name),s.destroy(),delete this._cache[a]}},e.getGFXShader=function(t,e,n,i,r){Object.assign(n,i.macros),r||(r=this.getKey(e,n));var o=this._cache[r];if(o)return o;var a=this._templates[e],s=this._templateInfos[a.hash];s.pipelineLayout||(this.getDescriptorSetLayout(t,e),fv(a,s,xp,"globals"),s.setLayouts[Tp.GLOBAL]=i.descriptorSetLayout,s.pipelineLayout=t.createPipelineLayout(new qo(s.setLayouts)));var c=function(t,e){for(var n=[],i=0;i<e.length;i++){var r=e[i],o=r.name,a=t[o],s=_v(r,a),c=!a||"0"===a;n.push({name:o,value:s,isDefault:c})}return n}(n,a.defines),l=i.constantMacros+a.constantMacros+c.reduce((function(t,e){return t+"#define "+e.name+" "+e.value+"\n"}),""),u=a.glsl3,h=mv(t);return h?u=a[h]:console.error("Invalid GFX API!"),s.shaderInfo.stages[0].source=l+u.vert,s.shaderInfo.stages[1].source=l+u.frag,s.shaderInfo.attributes=function(t,e,n){for(var i=[],r=t.attributes,o=e.gfxAttributes,a=0;a<r.length;a++)dv(r[a].defines,n)&&i.push(o[a]);return i}(a,s,n),s.shaderInfo.name=function(t,e){return t+e.reduce((function(t,e){return e.isDefault?t:t+"|"+e.name+e.value}),"")}(e,c),this._cache[r]=t.createShader(s.shaderInfo)},t}());i.programLib=vv;var gv,yv,xv,Sv={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_worldBoundCenter;\nuniform highp vec4 cc_worldBoundHalfExtents;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute float a_batch_id;\nvarying vec2 v_uv0;\nvarying float v_uvMode;\nvarying vec4 v_uvSizeOffset;\nvarying vec4 v_uvParams0;\nvarying vec4 v_uvParams1;\nstruct SpriteVertexInternalData {\nvec4 rotation;\nvec3 translation;\nvec3 scale;\nvec4 uvSizeOffset;\nfloat uvMode;\nvec4 uvParams;\nfloat filltype;\n};\nuniform vec4 cc_local_data[(CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS - CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS) / 5 * 5];\nvec3 VectorTransformQuat (vec3 v, vec4 q) {\nreturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\nvoid CCSpriteInput(out SpriteVertexData i0) {\nvec4 data0 = cc_local_data[int(a_batch_id) * 5];\nvec4 data1 = cc_local_data[int(a_batch_id) * 5 + 1];\nvec4 data2 = cc_local_data[int(a_batch_id) * 5 + 2];\nvec4 data3 = cc_local_data[int(a_batch_id) * 5 + 3];\nvec4 data4 = cc_local_data[int(a_batch_id) * 5 + 4];\nfloat rg = data0.w;\nfloat r = floor(rg);\nfloat ba = data2.z;\nfloat b = floor(ba);\nSpriteVertexInternalData i1;\ni1.rotation = data1;\ni1.translation = data0.xyz;\ni1.scale = vec3(data2.xy, 1.0);\ni1.uvSizeOffset = data3;\ni1.filltype = fract(data2.w) * 10.0;\ni1.uvMode = data2.w;\ni1.uvParams = data4;\ni0.position = vec4(VectorTransformQuat(a_position * i1.scale, i1.rotation) + i1.translation, 1.0);\ni0.color = vec4(r * (1.0 / 255.0), rg - r, b * (1.0 / 255.0), ba - b);\nvec2 uvWithRotation;\nif (i1.uvSizeOffset.x < 0.0) {\ni1.uvSizeOffset.x = abs(i1.uvSizeOffset.x);\nuvWithRotation = vec2(1.0 - a_texCoord.y, a_texCoord.x);\n} else {\nuvWithRotation = a_texCoord;\n}\nif (i1.uvMode >= 3.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nv_uvParams0 = vec4(i1.uvParams.xy, i1.filltype, 0);\nif (i1.filltype >= 2.0) {\nv_uvParams1 = i1.uvParams;\n} else if (i1.filltype >= 1.0) {\nv_uvParams0 = vec4(1.0 - v_uvParams0.y, 1.0 - v_uvParams0.x, v_uvParams0.zw);\n}\n} else if (i1.uvMode >= 2.0) {\nv_uv0 = uvWithRotation * i1.uvParams.xy;\nv_uv0.y -= fract(i1.uvParams.y);\nv_uvSizeOffset = i1.uvSizeOffset;\n} else if (i1.uvMode >= 1.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nvec4 params0 = fract(i1.uvParams);\nvec4 params1 = floor(i1.uvParams) / 2048.0;\nv_uvParams0 = vec4(params0.xy, params1.xy);\nv_uvParams1 = vec4(params0.zw, params1.zw);\n} else {\nv_uv0 = uvWithRotation * i1.uvSizeOffset.xy + i1.uvSizeOffset.zw;\n}\nv_uvMode = i1.uvMode;\n#if SAMPLE_FROM_RT\nv_uv0 = cc_cameraPos.w > 1.0 ? vec2(v_uv0.x, 1.0 - v_uv0.y) : v_uv0;\n#endif\n}\nvarying vec4 v_color;\nvec4 vert () {\nSpriteVertexData i;\nCCSpriteInput(i);\nv_color = i.color;\nvec4 pos = i.position;\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\nvarying vec2 v_uv0;\nvarying float v_uvMode;\nvarying vec4 v_uvSizeOffset;\nvarying vec4 v_uvParams0;\nvarying vec4 v_uvParams1;\nvec2 evalSlicedUV(vec2 uv) {\nvec4 p0 = mix(vec4(0.0), v_uvParams0, step(v_uvParams0.xyxy, uv.xyxy));\np0 = mix(       p0, v_uvParams1, step(v_uvParams1.xyxy, uv.xyxy));\nvec4 p1 = mix(vec4(1.0), v_uvParams1, step(uv.xyxy, v_uvParams1.xyxy));\np1 = mix(       p1, v_uvParams0, step(uv.xyxy, v_uvParams0.xyxy));\nvec2 k = (p1.zw - p0.zw) / (p1.xy - p0.xy);\nvec2 b = (p1.xy * p0.zw - p0.xy * p1.zw) / (p1.xy - p0.xy);\nreturn k * uv + b;\n}\nfloat evalFilledUV(vec2 uv, float mode) {\nfloat alpha = 1.0;\nif (mode >= 2.0) {\nfloat start = v_uvParams1.x;\nfloat range = v_uvParams1.y;\nvec2 dir = uv - v_uvParams1.zw;\nfloat angle = -atan(dir.y, dir.x) * 0.3183098861838;\nif (range < 0.0) {\nangle += mix(0.0, -2.0, step(start, angle));\nalpha = step(start + range, angle);\n} else {\nangle += mix(0.0, 2.0, step(angle, start));\nalpha = step(angle, start + range);\n}\n} else if (mode >= 1.0) {\nif (uv.y >= v_uvParams0.x && uv.y <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n} else {\nif (uv.x >= v_uvParams0.x && uv.x <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n}\nreturn alpha;\n}\nvoid CCSpriteInput(out SpriteFragmentData i) {\n#if USE_TEXTURE\nif(v_uvMode >= 3.0) {\ni.uv = v_uv0 * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 2.0) {\ni.uv = fract(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 1.0) {\ni.uv = evalSlicedUV(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else {\ni.uv = v_uv0;\n}\n#endif\n}\nvec4 CCSpriteSample(sampler2D tex, vec2 uv) {\nvec4 o = CCSampleWithAlphaSeparated(tex, uv);\nif (v_uvMode >= 3.0) {\no.a *= evalFilledUV(v_uv0, v_uvParams0.z);\n}\nreturn o;\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec4 v_color;\n#if USE_TEXTURE\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nSpriteFragmentData i;\nCCSpriteInput(i);\n#if USE_TEXTURE\nvec4 color = v_color * CCSpriteSample(cc_spriteTexture, i.uv);\n#else\nvec4 color = v_color;\n#endif\n#if IS_GRAY\ncolor.rgb = SRGBToLinear(color.rgb);\ncolor.rgb = vec3(dot(color.rgb, vec3(0.2126, 0.7152, 0.0722)));\ncolor.rgb = sqrt(color.rgb);\n#endif\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture2D(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture2D(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\ngl_FragColor = vec4(color, 1.0);\n} else {\ngl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nvoid main() {\nvec4 hdrColor = texture2D(outputResultMap, v_uv);\nvec3 bloomColor = texture2D(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\ngl_FragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewProjInv;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nvarying vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gl_LastFragData[0];\nvec4 normalMap = gl_LastFragData[1];\nvec4 emissiveMap = gl_LastFragDat[2];\n#else\nvec4 albedoMap = texture2D(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture2D(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture2D(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngl_FragData[2] = color;\n#else\ngl_FragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform mediump vec4 cc_planarNDInfo;\nvarying float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * max(0.02, 0.001 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying float v_dist;\nvec4 frag () {\nif(v_dist < 0.02)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nvarying vec2 v_uv;\nuniform sampler2D outputResultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\ngl_FragColor = texture2D(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform float u_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nin vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec2 a_texCoord;\nin float a_batch_id;\nout vec2 v_uv0;\nout float v_uvMode;\nout vec4 v_uvSizeOffset;\nout vec4 v_uvParams0;\nout vec4 v_uvParams1;\nstruct SpriteVertexInternalData {\nvec4 rotation;\nvec3 translation;\nvec3 scale;\nvec4 uvSizeOffset;\nfloat uvMode;\nvec4 uvParams;\nfloat filltype;\n};\nlayout(std140) uniform CCUILocal {\nvec4 cc_local_data[(CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS - CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS) / 5 * 5];\n};\nvec3 VectorTransformQuat (vec3 v, vec4 q) {\nreturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\nvoid CCSpriteInput(out SpriteVertexData i0) {\nvec4 data0 = cc_local_data[int(a_batch_id) * 5];\nvec4 data1 = cc_local_data[int(a_batch_id) * 5 + 1];\nvec4 data2 = cc_local_data[int(a_batch_id) * 5 + 2];\nvec4 data3 = cc_local_data[int(a_batch_id) * 5 + 3];\nvec4 data4 = cc_local_data[int(a_batch_id) * 5 + 4];\nfloat rg = data0.w;\nfloat r = floor(rg);\nfloat ba = data2.z;\nfloat b = floor(ba);\nSpriteVertexInternalData i1;\ni1.rotation = data1;\ni1.translation = data0.xyz;\ni1.scale = vec3(data2.xy, 1.0);\ni1.uvSizeOffset = data3;\ni1.filltype = fract(data2.w) * 10.0;\ni1.uvMode = data2.w;\ni1.uvParams = data4;\ni0.position = vec4(VectorTransformQuat(a_position * i1.scale, i1.rotation) + i1.translation, 1.0);\ni0.color = vec4(r * (1.0 / 255.0), rg - r, b * (1.0 / 255.0), ba - b);\nvec2 uvWithRotation;\nif (i1.uvSizeOffset.x < 0.0) {\ni1.uvSizeOffset.x = abs(i1.uvSizeOffset.x);\nuvWithRotation = vec2(1.0 - a_texCoord.y, a_texCoord.x);\n} else {\nuvWithRotation = a_texCoord;\n}\nif (i1.uvMode >= 3.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nv_uvParams0 = vec4(i1.uvParams.xy, i1.filltype, 0);\nif (i1.filltype >= 2.0) {\nv_uvParams1 = i1.uvParams;\n} else if (i1.filltype >= 1.0) {\nv_uvParams0 = vec4(1.0 - v_uvParams0.y, 1.0 - v_uvParams0.x, v_uvParams0.zw);\n}\n} else if (i1.uvMode >= 2.0) {\nv_uv0 = uvWithRotation * i1.uvParams.xy;\nv_uv0.y -= fract(i1.uvParams.y);\nv_uvSizeOffset = i1.uvSizeOffset;\n} else if (i1.uvMode >= 1.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nvec4 params0 = fract(i1.uvParams);\nvec4 params1 = floor(i1.uvParams) / 2048.0;\nv_uvParams0 = vec4(params0.xy, params1.xy);\nv_uvParams1 = vec4(params0.zw, params1.zw);\n} else {\nv_uv0 = uvWithRotation * i1.uvSizeOffset.xy + i1.uvSizeOffset.zw;\n}\nv_uvMode = i1.uvMode;\n#if SAMPLE_FROM_RT\nv_uv0 = cc_cameraPos.w > 1.0 ? vec2(v_uv0.x, 1.0 - v_uv0.y) : v_uv0;\n#endif\n}\nout vec4 v_color;\nvec4 vert () {\nSpriteVertexData i;\nCCSpriteInput(i);\nv_color = i.color;\nvec4 pos = i.position;\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\nin vec2 v_uv0;\nin float v_uvMode;\nin vec4 v_uvSizeOffset;\nin vec4 v_uvParams0;\nin vec4 v_uvParams1;\nvec2 evalSlicedUV(vec2 uv) {\nvec4 p0 = mix(vec4(0.0), v_uvParams0, step(v_uvParams0.xyxy, uv.xyxy));\np0 = mix(       p0, v_uvParams1, step(v_uvParams1.xyxy, uv.xyxy));\nvec4 p1 = mix(vec4(1.0), v_uvParams1, step(uv.xyxy, v_uvParams1.xyxy));\np1 = mix(       p1, v_uvParams0, step(uv.xyxy, v_uvParams0.xyxy));\nvec2 k = (p1.zw - p0.zw) / (p1.xy - p0.xy);\nvec2 b = (p1.xy * p0.zw - p0.xy * p1.zw) / (p1.xy - p0.xy);\nreturn k * uv + b;\n}\nfloat evalFilledUV(vec2 uv, float mode) {\nfloat alpha = 1.0;\nif (mode >= 2.0) {\nfloat start = v_uvParams1.x;\nfloat range = v_uvParams1.y;\nvec2 dir = uv - v_uvParams1.zw;\nfloat angle = -atan(dir.y, dir.x) * 0.3183098861838;\nif (range < 0.0) {\nangle += mix(0.0, -2.0, step(start, angle));\nalpha = step(start + range, angle);\n} else {\nangle += mix(0.0, 2.0, step(angle, start));\nalpha = step(angle, start + range);\n}\n} else if (mode >= 1.0) {\nif (uv.y >= v_uvParams0.x && uv.y <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n} else {\nif (uv.x >= v_uvParams0.x && uv.x <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n}\nreturn alpha;\n}\nvoid CCSpriteInput(out SpriteFragmentData i) {\n#if USE_TEXTURE\nif(v_uvMode >= 3.0) {\ni.uv = v_uv0 * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 2.0) {\ni.uv = fract(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 1.0) {\ni.uv = evalSlicedUV(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else {\ni.uv = v_uv0;\n}\n#endif\n}\nvec4 CCSpriteSample(sampler2D tex, vec2 uv) {\nvec4 o = CCSampleWithAlphaSeparated(tex, uv);\nif (v_uvMode >= 3.0) {\no.a *= evalFilledUV(v_uv0, v_uvParams0.z);\n}\nreturn o;\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec4 v_color;\n#if USE_TEXTURE\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nSpriteFragmentData i;\nCCSpriteInput(i);\n#if USE_TEXTURE\nvec4 color = v_color * CCSpriteSample(cc_spriteTexture, i.uv);\n#else\nvec4 color = v_color;\n#endif\n#if IS_GRAY\ncolor.rgb = SRGBToLinear(color.rgb);\ncolor.rgb = vec3(dot(color.rgb, vec3(0.2126, 0.7152, 0.0722)));\ncolor.rgb = sqrt(color.rgb);\n#endif\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nin vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(location = 0) inout vec4 gbuffer_albedoMap;\nlayout(location = 1) inout vec4 gbuffer_normalMap;\nlayout(location = 2) inout vec4 gbuffer_emissiveMap;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gbuffer_albedoMap;\nvec4 normalMap = gbuffer_normalMap;\nvec4 emissiveMap = gbuffer_emissiveMap;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngbuffer_emissiveMap = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nout float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * max(0.02, 0.001 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin float v_dist;\nvec4 frag () {\nif(v_dist < 0.02)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nin vec2 v_uv;\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nlayout(std140) uniform Factor {\nfloat u_percent;\n};\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},Av=function(){function t(){this._device=null,this._resources={}}var e=t.prototype;return e.initBuiltinRes=function(t){var e=this;this._device=t;for(var n=this._resources,r=new Uint8Array(16),o=new Uint8Array(16),a=new Uint8Array(16),s=new Uint8Array(16),c=new Uint8Array(16),l=0,u=0;u<4;u++)r[l]=0,r[l+1]=0,r[l+2]=0,r[l+3]=255,o[l]=0,o[l+1]=0,o[l+2]=0,o[l+3]=0,a[l]=119,a[l+1]=119,a[l+2]=119,a[l+3]=255,s[l]=255,s[l+1]=255,s[l+2]=255,s[l+3]=255,c[l]=127,c[l+1]=127,c[l+2]=255,c[l+3]=255,l+=4;var h=new Uint8Array(1024);l=0;for(var _=0;_<256;_++)h[l]=221,h[l+1]=221,h[l+2]=221,h[l+3]=255,l+=4;l=0;for(var f=0;f<8;f++){for(var p=0;p<8;p++)h[l]=85,h[l+1]=85,h[l+2]=85,h[l+3]=255,l+=4;l+=32}l+=32;for(var d=0;d<8;d++){for(var m=0;m<8;m++)h[l]=85,h[l+1]=85,h[l+2]=85,h[l+3]=255,l+=4;l+=32}var v={width:2,height:2,_data:r,_compressed:!1,format:jm.PixelFormat.RGBA8888},g={width:2,height:2,_data:o,_compressed:!1,format:jm.PixelFormat.RGBA8888},y={width:2,height:2,_data:a,_compressed:!1,format:jm.PixelFormat.RGBA8888},x={width:2,height:2,_data:s,_compressed:!1,format:jm.PixelFormat.RGBA8888},S={width:2,height:2,_data:c,_compressed:!1,format:jm.PixelFormat.RGBA8888},A={width:16,height:16,_data:h,_compressed:!1,format:jm.PixelFormat.RGBA8888},C=new ym(v),b=new jm;b._uuid="black-texture",b.image=C,n[b._uuid]=b;var T=new ym(g),E=new jm;E._uuid="empty-texture",E.image=T,n[E._uuid]=E;var w=new Wm;w._uuid="black-cube-texture",w.setMipFilter(Wm.Filter.NEAREST),w.image={front:new ym(v),back:new ym(v),left:new ym(v),right:new ym(v),top:new ym(v),bottom:new ym(v)},n[w._uuid]=w;var P=new ym(y),I=new jm;I._uuid="grey-texture",I.image=P,n[I._uuid]=I;var R=new ym(x),D=new jm;D._uuid="white-texture",D.image=R,n[D._uuid]=D;var B=new Wm;B._uuid="white-cube-texture",B.setMipFilter(Wm.Filter.NEAREST),B.image={front:new ym(x),back:new ym(x),left:new ym(x),right:new ym(x),top:new ym(x),bottom:new ym(x)},n[B._uuid]=B;var M=new ym(S),O=new jm;O._uuid="normal-texture",O.image=M,n[O._uuid]=O;var N=new ym(A),L=new jm;L._uuid="default-texture",L.image=N,n[L._uuid]=L;var F=new Wm;if(F.setMipFilter(Wm.Filter.NEAREST),F._uuid="default-cube-texture",F.image={front:new ym(A),back:new ym(A),left:new ym(A),right:new ym(A),top:new ym(A),bottom:new ym(A)},n[F._uuid]=F,i.SpriteFrame){var z=new i.SpriteFrame,V=C,G=new jm;G.image=V,z.texture=G,z._uuid="default-spriteframe",n[z._uuid]=z}var U=mv(t);if(!U)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var k=Sv[U];return k?Promise.resolve().then((function(){Km.forEach((function(t,e){var n=Object.assign(new i.EffectAsset,t);n.shaders.forEach((function(t,n){var i=k[e][n];i&&(t[U]=i)})),n.hideInEditor=!0,n.onLoaded()})),e._initMaterials()})):Promise.reject(Error("Current device is requiring builtin shaders of version "+U+" but shaders of that version are not assembled in this build."))},e.get=function(t){return this._resources[t]},e._initMaterials=function(){var t=this._resources,e=[],n=new i.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),t[n._uuid]=n,e.push(n);var r=new i.Material;r._uuid="missing-effect-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",i.color("#ffff00")),t[r._uuid]=r,e.push(r);var o=new i.Material;o._uuid="missing-material",o.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),o.setProperty("mainColor",i.color("#ff00ff")),t[o._uuid]=o,e.push(o);var a=new i.Material;a._uuid="default-clear-stencil",a.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),t[a._uuid]=a,e.push(a);var s=new i.Material;s._uuid="ui-base-material",s.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),t[s._uuid]=s,e.push(s);var c=new i.Material;c._uuid="ui-sprite-material",c.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[c._uuid]=c,e.push(c);var l=new i.Material;l._uuid="ui-alpha-test-material",l.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[l._uuid]=l,e.push(l);var u=new i.Material;u._uuid="ui-sprite-gray-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),t[u._uuid]=u,e.push(u);var h=new i.Material;h._uuid="ui-sprite-alpha-sep-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),t[h._uuid]=h,e.push(h);var _=new i.Material;_._uuid="ui-sprite-gray-alpha-sep-material",_.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),t[_._uuid]=_,e.push(_);var f=new i.Material;f._uuid="ui-graphics-material",f.initialize({effectName:"graphics"}),t[f._uuid]=f,e.push(f);var p=new i.Material;p._uuid="default-particle-material",p.initialize({effectName:"particle"}),t[p._uuid]=p,e.push(p);var d=new i.Material;d._uuid="default-particle-gpu-material",d.initialize({effectName:"particle-gpu"}),t[d._uuid]=d,e.push(d);var m=new i.Material;m._uuid="default-trail-material",m.initialize({effectName:"particle-trail"}),t[m._uuid]=m,e.push(m);var v=new i.Material;v._uuid="default-billboard-material",v.initialize({effectName:"billboard"}),t[v._uuid]=v,e.push(v);var g=new i.Material;g._uuid="default-spine-material",g.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),t[g._uuid]=g,e.push(g),i.game.on(i.Game.EVENT_GAME_INITED,(function(){for(var t=0;t<e.length;++t)for(var n=e[t],i=0;i<n.passes.length;++i)n.passes[i].tryCompile()}))},t}(),Cv=t("builtinResMgr",i.builtinResMgr=new Av),bv=t("getPhaseID",(gv=new Map,yv=0,function(t){return"number"==typeof t?t:(gv.has(t)||(gv.set(t,1<<yv),yv++),gv.get(t))})),Tv=t("InstancedBuffer",function(){function t(t){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=t.device,this.pass=t}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this.instances.length;++t){var e=this.instances[t];e.vb.destroy(),e.ia.destroy()}this.instances.length=0},e.merge=function(t,e,n,i){void 0===i&&(i=null);var r=e.buffer.length;if(r){var o=t.inputAssembler,a=t.descriptorSet.getTexture(fd),s=i;s||(s=t.shaders[n]);for(var c=t.descriptorSet,l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==o.indexBuffer||u.count>=1024)&&u.lightingMap===a&&u.stride===r){if(u.count>=u.capacity){u.capacity<<=1;var h=u.stride*u.capacity,_=u.data;u.data=new Uint8Array(h),u.data.set(_),u.vb.resize(h)}return u.shader!==s&&(u.shader=s),u.descriptorSet!==c&&(u.descriptorSet=c),u.data.set(e.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var f=this._device.createBuffer(new po(mr.VERTEX|mr.TRANSFER_DST,yr.HOST|yr.DEVICE,32*r,r)),p=new Uint8Array(32*r),d=o.vertexBuffers.slice(),m=o.attributes.slice(),v=o.indexBuffer,g=0;g<e.attributes.length;g++){var y=e.attributes[g],x=new Bo(y.name,y.format,y.isNormalized,d.length,!0);m.push(x)}p.set(e.buffer),d.push(f);var S=new Oo(m,d,v),A=this._device.createInputAssembler(S);this.instances.push({count:1,capacity:32,vb:f,data:p,ia:A,stride:r,shader:s,descriptorSet:c,lightingMap:a}),this.hasPendingModels=!0}},e.uploadBuffers=function(t){for(var e=0;e<this.instances.length;++e){var n=this.instances[e];n.count&&(n.ia.instanceCount=n.count,t.updateBuffer(n.vb,n.data))}},e.clear=function(){for(var t=0;t<this.instances.length;++t)this.instances[t].count=0;this.hasPendingModels=!1},t}()),Ev=function(){function t(t){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=t.device}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this.batches.length;++t){for(var e=this.batches[t],n=0;n<e.vbs.length;++n)e.vbs[n].destroy();e.vbIdx.destroy(),e.ia.destroy(),e.ubo.destroy()}this.batches.length=0},e.merge=function(t,e,n){var i=t.subMesh.flatBuffers;if(0!==i.length){for(var r=0,o=0,a=i[0].count,s=t.passes[e],c=t.shaders[e],l=t.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var _=this.batches[h];if(_.vbs.length===i.length&&_.mergeCount<Xp.BATCHING_COUNT){u=!0;for(var f=0;f<_.vbs.length;++f)if(_.vbs[f].stride!==i[f].stride){u=!1;break}if(u){for(var p=0;p<_.vbs.length;++p){var d=i[p],m=_.vbs[p],v=_.vbDatas[p];(r=(a+_.vbCount)*d.stride)>m.size&&(m.resize(r),_.vbDatas[p]=new Uint8Array(r),_.vbDatas[p].set(v)),_.vbDatas[p].set(d.buffer,_.vbCount*d.stride)}var g=_.vbIdxData;(o=4*(a+_.vbCount))>_.vbIdx.size&&(_.vbIdx.resize(o),_.vbIdxData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT),_.vbIdxData.set(g),g=_.vbIdxData);var y=_.vbCount,x=y+a,S=_.mergeCount;if(g[y]!==S||g[x-1]!==S)for(var A=y;A<x;A++)g[A]=S+.1;return Ei.toArray(_.uboData,n.transform.worldMatrix,Xp.MAT_WORLDS_OFFSET+16*_.mergeCount),_.mergeCount||(l.bindBuffer(Xp.BINDING,_.ubo),l.update(),_.pass=s,_.shader=c,_.descriptorSet=l),++_.mergeCount,_.vbCount+=a,void(_.ia.vertexCount+=a)}}}for(var C=[],b=[],T=[],E=0;E<i.length;++E){var w=i[E],P=this._device.createBuffer(new po(mr.VERTEX|mr.TRANSFER_DST,yr.HOST|yr.DEVICE,w.count*w.stride,w.stride));P.update(w.buffer.buffer),C.push(P),b.push(new Uint8Array(P.size)),T.push(P)}var I=this._device.createBuffer(new po(mr.VERTEX|mr.TRANSFER_DST,yr.HOST|yr.DEVICE,4*a,4)),R=new Float32Array(a);R.fill(0),I.update(R),T.push(I);for(var D=t.inputAssembler.attributes,B=new Array(D.length+1),M=0;M<D.length;++M)B[M]=D[M];B[D.length]=new Bo("a_dyn_batch_id",fr.R32F,!1,i.length);var O=new Oo(B,T),N=this._device.createInputAssembler(O),L=this._device.createBuffer(new po(mr.UNIFORM|mr.TRANSFER_DST,yr.HOST|yr.DEVICE,Xp.SIZE,Xp.SIZE));l.bindBuffer(Xp.BINDING,L),l.update();var F=new Float32Array(Xp.COUNT);Ei.toArray(F,n.transform.worldMatrix,Xp.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:C,vbDatas:b,vbIdx:I,vbIdxData:R,vbCount:a,ia:N,ubo:L,uboData:F,pass:s,shader:c,descriptorSet:l})}},e.clear=function(){for(var t=0;t<this.batches.length;++t){var e=this.batches[t];e.vbCount=0,e.mergeCount=0,e.ia.vertexCount=0}},t}(),wv=new po(mr.UNIFORM|mr.TRANSFER_DST,yr.DEVICE),Pv=new mo(null),Iv=new Wo(null);!function(t){t[t.NONE=0]="NONE",t[t.INSTANCING=1]="INSTANCING",t[t.VB_MERGING=2]="VB_MERGING"}(xv||(xv={}));var Rv=function(){function t(t){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new Ia,this._dss=new wa,this._rs=new Ea,this._priority=dp.DEFAULT,this._stage=pp.DEFAULT,this._phase=bv("default"),this._primitive=zr.TRIANGLE_LIST,this._batchingScheme=xv.NONE,this._dynamicStates=kr.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=t,this._device=t.device}t.fillPipelineInfo=function(t,e){void 0!==e.priority&&t._setPriority(e.priority),void 0!==e.primitive&&t._setPrimitive(e.primitive),void 0!==e.stage&&t._setStage(e.stage),void 0!==e.dynamicStates&&t._setDynamicState(e.dynamicStates),void 0!==e.phase&&t._setPhase(bv(e.phase));var n=t._bs;if(e.blendState){var i=e.blendState,r=i.targets;r&&r.forEach((function(t,e){n.setTarget(e,t)})),void 0!==i.isA2C&&(n.isA2C=i.isA2C),void 0!==i.isIndepend&&(n.isIndepend=i.isIndepend),void 0!==i.blendColor&&(n.blendColor=i.blendColor)}t._rs.assign(e.rasterizerState),t._dss.assign(e.depthStencilState)},t.getPassHash=function(t){var e,n=vv.getKey(t.program,t.defines)+","+t._primitive+","+t._dynamicStates;return n+=function(t){for(var e,n=",bs,"+t.isA2C,i=W(t.targets);!(e=i()).done;){var r=e.value;n+=",bt,"+r.blend+","+r.blendEq+","+r.blendAlphaEq+","+r.blendColorMask,n+=","+r.blendSrc+","+r.blendDst+","+r.blendSrcAlpha+","+r.blendDstAlpha}return n}(t._bs),n+=function(t){var e=",dss,"+t.depthTest+","+t.depthWrite+","+t.depthFunc;return e+=","+t.stencilTestFront+","+t.stencilFuncFront+","+t.stencilRefFront+","+t.stencilReadMaskFront,e+=","+t.stencilFailOpFront+","+t.stencilZFailOpFront+","+t.stencilPassOpFront+","+t.stencilWriteMaskFront,(e+=","+t.stencilTestBack+","+t.stencilFuncBack+","+t.stencilRefBack+","+t.stencilReadMaskBack)+","+t.stencilFailOpBack+","+t.stencilZFailOpBack+","+t.stencilPassOpBack+","+t.stencilWriteMaskBack}(t._dss),xa(n+=",rs,"+(e=t._rs).cullMode+","+e.depthBias+","+e.isFrontFaceCCW,666)};var e=t.prototype;return e.initialize=function(t){this._doInit(t),this.resetUBOs(),this.resetTextures(),this.tryCompile()},e.getHandle=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=dr.UNKNOWN);var i=this._propertyHandleMap[t];return i?(n?i=rv(i,n):e&&(i=rv(i,tv(i)-e)),i+e):0},e.getBinding=function(e){var n=this.getHandle(e);return n?t.getBindingFromHandle(n):-1},e.setUniform=function(e,n){var i=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),o=t.getOffsetFromHandle(e),a=this._getBlockView(r,i);av[r](a,n,o),this._setRootBufferDirty(!0)},e.getUniform=function(e,n){var i=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),o=t.getOffsetFromHandle(e),a=this._getBlockView(r,i);return ov[r](a,n,o)},e.setUniformArray=function(e,n){for(var i=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),o=ua(r)>>2,a=this._getBlockView(r,i),s=t.getOffsetFromHandle(e),c=0;c<n.length;c++,s+=o)null!==n[c]&&av[r](a,n[c],s);this._setRootBufferDirty(!0)},e.bindTexture=function(t,e,n){this._descriptorSet.bindTexture(t,e,n||0)},e.bindSampler=function(t,e,n){this._descriptorSet.bindSampler(t,e,n||0)},e.setDynamicState=function(t,e){var n=this._dynamics[t];n&&n.value===e||(n.value=e,n.dirty=!0)},e.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},e._setRootBufferDirty=function(t){this._rootBufferDirty=t},e.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update()):E(12006)},e.getInstancedBuffer=function(t){return void 0===t&&(t=0),this._instancedBuffers[t]||(this._instancedBuffers[t]=new Tv(this))},e.getBatchedBuffer=function(t){return void 0===t&&(t=0),this._batchedBuffers[t]||(this._batchedBuffers[t]=new Ev(this))},e._initNative=function(){},e._destroy=function(){},e.destroy=function(){for(var t=0;t<this._shaderInfo.blocks.length;t++){var e=this._shaderInfo.blocks[t];this._buffers[e.binding].destroy()}for(var n in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[n].destroy();for(var i in this._batchedBuffers)this._batchedBuffers[i].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()},e.resetUniform=function(e){var n=this.getHandle(e);if(n){for(var i=t.getTypeFromHandle(n),r=t.getBindingFromHandle(n),o=t.getOffsetFromHandle(n),a=t.getCountFromHandle(n),s=this._getBlockView(i,r),c=this._properties[e],l=c&&c.value||cv(i),u=(ua(i)>>2)*a,h=0;h+l.length<=u;h+=l.length)s.set(l,o+h);this._setRootBufferDirty(!0)}},e.resetTexture=function(e,n){var i=this.getHandle(e);if(i){var r=t.getTypeFromHandle(i),o=t.getBindingFromHandle(i),a=this._properties[e],s=a&&a.value,c=s?s+"-texture":cv(r),l=Cv.get(c),u=l&&l.getGFXTexture(),h=a&&void 0!==a.samplerHash?Oa.unpackFromHash(a.samplerHash):l&&l.getSamplerInfo(),_=this._device.getSampler(h);this._descriptorSet.bindSampler(o,_,n),this._descriptorSet.bindTexture(o,u,n)}},e.resetUBOs=function(){for(var t=0;t<this._shaderInfo.blocks.length;t++)for(var e=this._shaderInfo.blocks[t],n=0,i=0;i<e.members.length;i++){for(var r=e.members[i],o=this._getBlockView(r.type,e.binding),a=this._properties[r.name],s=a&&a.value||cv(r.type),c=(ua(r.type)>>2)*r.count,l=0;l+s.length<=c;l+=s.length)o.set(s,n+l);n+=c}this._setRootBufferDirty(!0)},e.resetTextures=function(){for(var t=0;t<this._shaderInfo.samplerTextures.length;t++)for(var e=this._shaderInfo.samplerTextures[t],n=0;n<e.count;n++)this.resetTexture(e.name,n)},e.tryCompile=function(){var e=this._root.pipeline;if(!e)return!1;this._syncBatchingScheme();var n=vv.getGFXShader(this._device,this._programName,this._defines,e);return n?(this._shader=n,this._setPipelineLayout(vv.getTemplateInfo(this._programName).pipelineLayout),this._setHash(t.getPassHash(this)),!0):(console.warn("create shader "+this._programName+" failed"),!1)},e.getShaderVariant=function(t){if(void 0===t&&(t=null),!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!t)return this._shader;for(var e=this._root.pipeline,n=0;n<t.length;n++){var i=t[n];this._defines[i.name]=i.value}for(var r=vv.getGFXShader(this._device,this._programName,this._defines,e),o=0;o<t.length;o++){var a=t[o];delete this._defines[a.name]}return r},e.beginChangeStatesSilently=function(){},e.endChangeStatesSilently=function(){},e._setPriority=function(t){this._priority=t},e._setStage=function(t){this._stage=t},e._setPhase=function(t){this._phase=t},e._setPrimitive=function(t){this._primitive=t},e._setState=function(t,e,n,i){this._bs=t,this._dss=e,this._rs=n,this._descriptorSet=i},e._doInit=function(e,n){void 0===n&&(n=!1),this._initNative(),this._setPriority(dp.DEFAULT),this._setStage(pp.DEFAULT),this._setPhase(bv("default")),this._setPrimitive(zr.TRIANGLE_LIST),this._passIndex=e.passIndex,this._propertyIndex=void 0!==e.propertyIndex?e.propertyIndex:e.passIndex,this._programName=e.program,this._defines=n?L({},e.defines):e.defines,this._shaderInfo=vv.getTemplate(e.program),this._properties=e.properties||this._properties;var i=this._device;t.fillPipelineInfo(this,e),e.stateOverrides&&t.fillPipelineInfo(this,e.stateOverrides),Iv.layout=vv.getDescriptorSetLayout(this._device,e.program),this._descriptorSet=this._device.createDescriptorSet(Iv),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);for(var r=this._shaderInfo.blocks,o=vv.getTemplateInfo(e.program),a=o.blockSizes,s=o.handleMap,c=i.capabilities.uboOffsetAlignment,l=[],u=0,h=0,_=0;_<r.length;_++){var f=a[_];l.push(h),h+=Math.ceil(f/c)*c,u=f}var p=l[l.length-1]+u;p&&(wv.size=16*Math.ceil(p/16),this._rootBuffer=i.createBuffer(wv),this._rootBlock=new ArrayBuffer(p));for(var d=0,m=0;d<r.length;d++){var v=r[d].binding,g=a[d];Pv.buffer=this._rootBuffer,Pv.offset=l[m++],Pv.range=16*Math.ceil(g/16);var y=this._buffers[v]=i.createBuffer(Pv);this._blocks[v]=new Float32Array(this._rootBlock,Pv.offset,g/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[v]=new Int32Array(this._blocks[v].buffer,this._blocks[v].byteOffset,this._blocks[v].length),this._descriptorSet.bindBuffer(v,y)}var x=this._propertyHandleMap=s,S={};for(var A in this._properties){var C=this._properties[A];C.handleInfo&&(S[A]=this.getHandle.apply(this,C.handleInfo))}Object.assign(x,S)},e._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(_r.INSTANCED_ARRAYS)?this._setBatchingScheme(xv.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(xv.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(xv.VB_MERGING):this._setBatchingScheme(xv.NONE)},e._setBatchingScheme=function(t){this._batchingScheme=t},e._setDynamicState=function(t){this._dynamicStates=t},e._setHash=function(t){this._hash=t},e._getBlockView=function(t,e){return t<dr.FLOAT?this._blocksInt[e]:this._blocks[e]},e._setPipelineLayout=function(t){this._pipelineLayout=t},e._initPassFromTarget=function(t,e,n,i){this._initNative(),this._setPriority(t.priority),this._setStage(t.stage),this._setPhase(t.phase),this._setBatchingScheme(t.batchingScheme),this._setPrimitive(t.primitive),this._setDynamicState(t.dynamicStates),this._setState(n,e,t.rasterizerState,t.descriptorSet),this._passIndex=t.passIndex,this._propertyIndex=t.propertyIndex,this._programName=t.program,this._defines=t.defines,this._shaderInfo=t._shaderInfo,this._properties=t._properties,this._blocks=t._blocks,this._blocksInt=t._blocksInt,this._dynamics=t._dynamics,this._shader=t._shader,this._setPipelineLayout(vv.getTemplateInfo(this._programName).pipelineLayout),this._setHash(t._hash^i)},N(t,[{key:"native",get:function(){return this._nativeObj}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return vv.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]),t}();Rv.getTypeFromHandle=tv,Rv.getBindingFromHandle=ev,Rv.getCountFromHandle=nv,Rv.getOffsetFromHandle=iv;var Dv,Bv=new Wo(null),Mv=function(){function t(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=dp.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}var e=t.prototype;return e._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},e._destroyWorldBoundDescriptorSet=function(){this._worldBoundDescriptorSet.destroy(),this._worldBoundDescriptorSet=null},e._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},e._createDescriptorSet=function(t){this._descriptorSet=this._device.createDescriptorSet(t)},e._createWorldBoundDescriptorSet=function(t){this._worldBoundDescriptorSet=this._device.createDescriptorSet(t)},e._setInputAssembler=function(t){this._inputAssembler=this._device.createInputAssembler(t)},e._setSubMesh=function(t){this._subMesh=t},e._init=function(){},e.initialize=function(t,e,n){void 0===n&&(n=null);var r=i.director.root;this._device=r.device,Bv.layout=e[0].localSetLayout,this._init(),this._setInputAssembler(t.iaInfo),this._createDescriptorSet(Bv);var o=i.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass(),a=new Wo(null);if(a.layout=o.localSetLayout,this._createWorldBoundDescriptorSet(a),this._setSubMesh(t),this._patches=n,this._passes=e,this._flushPassInfo(),e[0].batchingScheme===xv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=dp.DEFAULT,e[0].phase===bv("reflection")){var s=r.mainWindow.width,c=r.mainWindow.height,l=512;c<s?(s=l*s/c,c=l):c=l*c/(s=l),this._reflectionTex=this._device.createTexture(new xo(xr.TEX2D,Sr.STORAGE|Sr.TRANSFER_SRC|Sr.SAMPLED,fr.RGBA8,s,c)),this.descriptorSet.bindTexture(yd,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new Ao(Tr.LINEAR,Tr.LINEAR,Tr.NONE,Er.CLAMP,Er.CLAMP,Er.CLAMP)),this.descriptorSet.bindSampler(yd,this._reflectionSampler),this.descriptorSet.bindTexture(Ad,this._reflectionTex)}},e._initNativePlanarShadowShader=function(t){this._planarShader=t.getPlanarShader(this._patches)},e.initPlanarShadowShader=function(){var t=i.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(t)},e._initNativePlanarShadowInstanceShader=function(t){this._planarInstanceShader=t.getPlanarInstanceShader(this._patches)},e.initPlanarShadowInstanceShader=function(){var t=i.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(t)},e._destroy=function(){},e.destroy=function(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=dp.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()},e.update=function(){for(var t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()},e.onPipelineStateChanged=function(){var t=this._passes;if(t){for(var e=0;e<t.length;e++){var n=t[e];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},e.onMacroPatchesStateChanged=function(t){this._patches=t;var e=this._passes;if(e){for(var n=0;n<e.length;n++){var i=e[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},e._flushPassInfo=function(){var t=this._passes;if(t){this._shaders||(this._shaders=[]),this._shaders.length=t.length;for(var e=0,n=t.length;e<n;e++)this._shaders[e]=t[e].getShaderVariant(this.patches)}},N(t,[{key:"passes",get:function(){return this._passes},set:function(t){t.length>8?E(12004,8):(this._passes=t,this._flushPassInfo(),this._passes[0].batchingScheme===xv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),Bv.layout=t[0].localSetLayout,this._createDescriptorSet(Bv)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(t){this._inputAssembler.destroy(),this._inputAssembler.initialize(t.iaInfo),this._passes[0].batchingScheme===xv.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(t)}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),t}(),Ov=new Ei,Nv=[{name:"CC_RECEIVE_SHADOW",value:!0}];!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SKINNING=1]="SKINNING",t[t.BAKED_SKINNING=2]="BAKED_SKINNING",t[t.BATCH_2D=3]="BATCH_2D",t[t.PARTICLE_BATCH=4]="PARTICLE_BATCH",t[t.LINE=5]="LINE"}(Dv||(Dv={}));var Lv,Fv,zv,Vv,Gv,Uv,kv,Hv,jv=new Ao(Tr.LINEAR,Tr.LINEAR,Tr.NONE,Er.CLAMP,Er.CLAMP,Er.CLAMP),Wv=new Ao(Tr.LINEAR,Tr.LINEAR,Tr.LINEAR,Er.CLAMP,Er.CLAMP,Er.CLAMP),qv=function(){function t(){this.type=Dv.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(jp.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new fi,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._enabled=!0,this._visFlags=fp.Enum.NONE,this._device=i.director.root.device}var e=t.prototype;return e._setReceiveShadow=function(t){this._receiveShadow=t},e._init=function(){},e.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=fp.Enum.NONE,this._inited=!0)},e._destroySubmodel=function(t){t.destroy()},e._destroy=function(){},e.destroy=function(){for(var t=this._subModels,e=0;e<t.length;e++){var n=this._subModels[e];this._destroySubmodel(n)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},e.attachToScene=function(t){this.scene=t,this._localDataUpdated=!0},e.detachFromScene=function(){this.scene=null},e.updateTransform=function(){var t=this.transform;if(t.hasChangedFlags||t._dirtyFlags){t.updateWorldTransform(),this._localDataUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}},e.updateWorldBound=function(){var t=this.transform;if(null!==t){t.updateWorldTransform(),this._localDataUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}},e._applyLocalData=function(){},e._applyLocalBuffer=function(){},e._applyWorldBoundBuffer=function(){},e.updateUBOs=function(t){for(var e=this._subModels,n=0;n<e.length;n++)e[n].update();if(this._updateStamp=t,this._localDataUpdated){this._localDataUpdated=!1;var i=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var o=this.instancedAttributes.views;!function(t,e,n,i){e[0]=t.m00,e[1]=t.m01,e[2]=t.m02,e[3]=t.m12,n[0]=t.m04,n[1]=t.m05,n[2]=t.m06,n[3]=t.m13,i[0]=t.m08,i[1]=t.m09,i[2]=t.m10,i[3]=t.m14}(i,o[r],o[r+1],o[r+2])}else if(this._localBuffer){Ei.toArray(this._localData,i,jp.MAT_WORLD_OFFSET),Ei.inverseTranspose(Ov,i);var a=Math.abs(Ei.determinant(Ov)),s=1/Math.sqrt(a);Ei.multiplyScalar(Ov,Ov,s),Ei.toArray(this._localData,Ov,jp.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}},e._updateNativeBounds=function(){},e.createBoundingShape=function(t,e){t&&e&&(this._modelBounds=Cc.fromPoints(Cc.create(),t,e),this._worldBounds=Cc.clone(this._modelBounds),this._updateNativeBounds())},e._createSubModel=function(){return new Mv},e.initSubModel=function(t,e,n){this.initialize(),null==this._subModels[t]?this._subModels[t]=this._createSubModel():this._subModels[t].destroy(),this._subModels[t].initialize(e,n.passes,this.getMacroPatches(t)),this._subModels[t].initPlanarShadowShader(),this._subModels[t].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(t)},e.setSubModelMesh=function(t,e){this._subModels[t]&&(this._subModels[t].subMesh=e)},e.setSubModelMaterial=function(t,e){this._subModels[t]&&(this._subModels[t].passes=e.passes,this._updateAttributesAndBinding(t))},e.onGlobalPipelineStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onPipelineStateChanged()},e.onMacroPatchesStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onMacroPatchesStateChanged(this.getMacroPatches(e))},e.updateLightingmap=function(t,e){fi.toArray(this._localData,e,jp.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=t,this._lightmapUVParam=e,null===t&&(t=Cv.get("empty-texture"));var n=t.getGFXTexture();if(n)for(var i=this._device.getSampler(t.mipmaps.length>1?Wv:jv),r=this._subModels,o=0;o<r.length;o++){var a=r[o].descriptorSet;a.bindTexture(fd,n),a.bindSampler(fd,i),a.update()}},e.getMacroPatches=function(){return this.receiveShadow?Nv:null},e._updateAttributesAndBinding=function(t){var e=this._subModels[t];if(e){this._initLocalDescriptors(t),this._updateLocalDescriptors(t,e.descriptorSet),this._initWorldBoundDescriptors(t),this._updateWorldBoundDescriptors(t,e.worldBoundDescriptorSet);var n=e.passes[0].getShaderVariant(e.patches);this._updateInstancedAttributes(n.attributes,e.passes[0])}},e._getInstancedAttributeIndex=function(t){for(var e=this.instancedAttributes.attributes,n=0;n<e.length;n++)if(e[n].name===t)return n;return-1},e._setInstMatWorldIdx=function(t){this._instMatWorldIdx=t},e._updateInstancedAttributes=function(t,e){if(e.device.hasFeature(_r.INSTANCED_ARRAYS)){for(var n=0,i=0;i<t.length;i++){var r=t[i];r.isInstanced&&(n+=na[r.format].size)}var o=this.instancedAttributes;o.buffer=new Uint8Array(n),o.views.length=o.attributes.length=0;for(var a=0,s=0;s<t.length;s++){var c=t[s];if(c.isInstanced){var l=new Bo;l.format=c.format,l.name=c.name,l.isNormalized=c.isNormalized,l.location=c.location,o.attributes.push(l);var u=na[c.format],h=new(ha(u))(o.buffer.buffer,a,u.count);o.views.push(h),a+=u.size}}e.batchingScheme===xv.INSTANCING&&e.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(qp)),this._localDataUpdated=!0}},e._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new po(mr.UNIFORM|mr.TRANSFER_DST,yr.DEVICE,jp.SIZE,jp.SIZE)),this._applyLocalBuffer())},e._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new po(mr.UNIFORM|mr.TRANSFER_DST,yr.DEVICE,Wp.SIZE,Wp.SIZE)),this._applyWorldBoundBuffer())},e._updateLocalDescriptors=function(t,e){this._localBuffer&&e.bindBuffer(jp.BINDING,this._localBuffer)},e._updateWorldBoundDescriptors=function(t,e){this._worldBoundBuffer&&e.bindBuffer(Wp.BINDING,this._worldBoundBuffer)},N(t,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._setReceiveShadow(t),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}},{key:"node",get:function(){return this._node},set:function(t){this._node=t}},{key:"transform",get:function(){return this._transform},set:function(t){this._transform=t}},{key:"visFlags",get:function(){return this._visFlags},set:function(t){this._visFlags=t}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"native",get:function(){return this._nativeObj}}]),t}(),Xv=t("EffectAsset",qc("cc.EffectAsset")((Hv=kv=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"techniques",zv,H(e)),q(e,"shaders",Vv,H(e)),q(e,"combinations",Gv,H(e)),q(e,"hideInEditor",Uv,H(e)),e}F(e,t),e.register=function(t){e._effects[t.name]=t},e.remove=function(t){if("string"!=typeof t)e._effects[t.name]&&e._effects[t.name].equals(t)&&delete e._effects[t.name];else{if(e._effects[t])return void delete e._effects[t];for(var n in e._effects)if(e._effects[n]._uuid===t)return void delete e._effects[n]}},e.get=function(t){if(e._effects[t])return e._effects[t];for(var n in e._effects)if(e._effects[n]._uuid===t)return e._effects[n];return null},e.getAll=function(){return e._effects};var n=e.prototype;return n.onLoaded=function(){vv.register(this),e.register(this),i.game.once(i.Game.EVENT_ENGINE_INITED,this._precompile,this)},n._precompile=function(){for(var t=this,e=i.director.root,n=function(n){var i=t.shaders[n],r=t.combinations[n];if(!r)return"continue";Object.keys(r).reduce((function(t,e){return t.reduce((function(t,n){for(var i=r[e],o=0;o<i.length;++o){var a=L({},n);a[e]=i[o],t.push(a)}return t}),[])}),[{}]).forEach((function(t){return vv.getGFXShader(e.device,i.name,t,e.pipeline)}))},r=0;r<this.shaders.length;r++)n(r)},n.destroy=function(){return e.remove(this),t.prototype.destroy.call(this)},n.initDefault=function(n){t.prototype.initDefault.call(this,n);var i=e.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques},n.validate=function(){return this.techniques.length>0&&this.shaders.length>0},e}(Su),kv._effects={},zv=X((Fv=Hv).prototype,"techniques",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vv=X(Fv.prototype,"shaders",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Gv=X(Fv.prototype,"combinations",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Uv=X(Fv.prototype,"hideInEditor",[Zc,tl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Lv=Fv))||Lv);i.EffectAsset=Xv;var Yv=t("PipelineStateManager",function(){function t(){}return t.getOrCreatePipelineState=function(t,e,n,i,r){var o=e.hash^i.hash^r.attributesHash^n.typedID,a=this._PSOHashMap.get(o);if(!a){var s=e.pipelineLayout,c=new Xo(r.attributes),l=new Ra(n,s,i,c,e.rasterizerState,e.depthStencilState,e.blendState,e.primitive,e.dynamicStates);a=t.createPipelineState(l),this._PSOHashMap.set(o,a)}return a},t}());Yv._PSOHashMap=new Map;var Kv=new lo,Jv=new no;function Qv(t,e){t.x=e.x*e.x,t.y=e.y*e.y,t.z=e.z*e.z}var Zv,$v,tg,eg,ng,ig,rg,og,ag,sg,cg=null;function lg(t,e,n,i,r){if(i&&i.enabled&&r===cg){var o=i.subModels[0],a=o.inputAssembler,s=o.passes,c=o.shaders,l=o.descriptorSet;Kv.width=Jv.width=r.window.width,Kv.height=Jv.height=r.window.height;var u=Yv.getOrCreatePipelineState(t,s[0],c[0],e,a);n.setViewport(Kv),n.setScissor(Jv),n.bindPipelineState(u),n.bindDescriptorSet(Tp.MATERIAL,s[0].descriptorSet),n.bindDescriptorSet(Tp.LOCAL,l),n.bindInputAssembler(a),n.draw(a)}}var ug=new fi,hg=t("Material",(Zv=qc("cc.Material"),$v=El(Xv),Zv((sg=function(t){function e(){var e;return q(e=t.call(this)||this,"_effectAsset",ng,H(e)),q(e,"_techIdx",ig,H(e)),q(e,"_defines",rg,H(e)),q(e,"_states",og,H(e)),q(e,"_props",ag,H(e)),e._passes=[],e._hash=0,e}F(e,t),e.getHash=function(t){for(var e,n=0,i=W(t.passes);!(e=i()).done;)n^=e.value.hash;return n};var n=e.prototype;return n.initialize=function(t){this._passes.length?b(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(t),this._update())},n.reset=function(t){this.initialize(t)},n.destroy=function(){return this._doDestroy(),t.prototype.destroy.call(this)},n.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.onLoaded=function(){this._update()},n.resetUniforms=function(t){void 0===t&&(t=!0),this._props.length=this._passes.length;for(var e=0;e<this._props.length;e++)this._props[e]={};if(t)for(var n,i=W(this._passes);!(n=i()).done;){var r=n.value;r.resetUBOs(),r.resetTextures()}},n.setProperty=function(t,e,n){var i=!1;if(void 0===n)for(var r=this._passes,o=r.length,a=0;a<o;a++){var s=r[a];this._uploadProperty(s,t,e)&&(this._props[s.propertyIndex][t]=e,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: "+n+".");var c=this._passes[n];this._uploadProperty(c,t,e)&&(this._props[c.propertyIndex][t]=e,i=!0)}i||console.warn("illegal property name: "+t+".")},n.getProperty=function(t,e){if(void 0===e)for(var n=this._props,i=n.length,r=0;r<i;r++){var o=n[r];if(t in o)return o[t]}else{if(e>=this._props.length)return console.warn("illegal pass index: "+e+"."),null;var a=this._props[this._passes[e].propertyIndex];if(t in a)return a[t]}return null},n.copy=function(t,e){this._techIdx=t._techIdx,this._props.length=t._props.length;for(var n=0;n<t._props.length;n++)this._props[n]=L({},t._props[n]);this._defines.length=t._defines.length;for(var i=0;i<t._defines.length;i++)this._defines[i]=L({},t._defines[i]);this._states.length=t._states.length;for(var r=0;r<t._states.length;r++)this._states[r]=L({},t._states[r]);this._effectAsset=t._effectAsset,e&&this._fillInfo(e),this._update()},n._fillInfo=function(t){void 0!==t.technique&&(this._techIdx=t.technique),t.effectAsset?this._effectAsset=t.effectAsset:t.effectName&&(this._effectAsset=Xv.get(t.effectName)),t.defines&&this._prepareInfo(t.defines,this._defines),t.states&&this._prepareInfo(t.states,this._states)},n._prepareInfo=function(t,e){var n=t;if(!Array.isArray(n)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(i).fill(n)}for(var r=0;r<n.length;++r)Object.assign(e[r]||(e[r]={}),n[r])},n._createPasses=function(){var t=this._effectAsset.techniques[this._techIdx||0];if(!t)return[];for(var e=t.passes.length,n=[],r=0;r<e;++r){var o=t.passes[r],a=o.passIndex=r,s=o.defines=this._defines[a]||(this._defines[a]={});if(o.stateOverrides=this._states[a]||(this._states[a]={}),void 0!==o.propertyIndex&&Object.assign(s,this._defines[o.propertyIndex]),void 0!==o.embeddedMacros&&Object.assign(s,o.embeddedMacros),!o.switch||s[o.switch]){var c=new Rv(i.director.root);c.initialize(o),n.push(c)}}return n},n._update=function(t){var n=this;if(void 0===t&&(t=!0),this._effectAsset){this._passes=this._createPasses();var i=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=i,t)this._passes.forEach((function(t,e){var i=n._props[e];for(var r in i||(i=n._props[e]={}),void 0!==t.propertyIndex&&Object.assign(i,n._props[t.propertyIndex]),i)n._uploadProperty(t,r,i[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=e.getHash(this)},n._uploadProperty=function(t,e,n){var i=t.getHandle(e);if(!i)return!1;if(Rv.getTypeFromHandle(i)<dr.SAMPLER1D)if(Array.isArray(n))t.setUniformArray(i,n);else if(null!==n){var r;if(null===(r=t.properties[e])||void 0===r?void 0:r.linear){var o=n;Qv(ug,o),ug.w=o.w,n=ug}t.setUniform(i,n)}else t.resetUniform(e);else if(Array.isArray(n))for(var a=0;a<n.length;a++)this._bindTexture(t,i,n[a],a);else n?this._bindTexture(t,i,n):t.resetTexture(e);return!0},n._bindTexture=function(t,e,n,i){var r=Rv.getBindingFromHandle(e);if(n instanceof La)t.bindTexture(r,n,i);else if(n instanceof Sm){var o=n.getGFXTexture();if(!o||!o.width||!o.height)return;t.bindTexture(r,o,i),t.bindSampler(r,n.getGFXSampler(),i)}},n._doDestroy=function(){if(this._passes&&this._passes.length)for(var t,e=W(this._passes);!(t=e()).done;)t.value.destroy();this._passes.length=0},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new Li("#ff00ff"))},n.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},N(e,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),e}(Su),ng=X((eg=sg).prototype,"_effectAsset",[$v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ig=X(eg.prototype,"_techIdx",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rg=X(eg.prototype,"_defines",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),og=X(eg.prototype,"_states",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ag=X(eg.prototype,"_props",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tg=eg))||tg));i.Material=hg;var _g=Jt({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),fg=Jt({Planar:0,ShadowMap:1}),pg=Jt({HARD:0,SOFT:1,SOFT_2X:2}),dg=fg.ShadowMap+1,mg=function(){function t(){this.fixedSphere=new Kr(0,0,0,.01),this.maxReceived=4,this.firstSetCSM=!1,this.shadowCameraFar=0,this.matShadowView=new Ei,this.matShadowProj=new Ei,this.matShadowViewProj=new Ei,this._normal=new oi(0,1,0),this._shadowColor=new Li(0,0,0,76),this._matLight=new Ei,this._material=null,this._instancingMaterial=null,this._size=new li(512,512),this._enabled=!1,this._distance=0,this._type=dg,this._near=.1,this._far=10,this._invisibleOcclusionRange=200,this._shadowDistance=100,this._orthoSize=1,this._pcf=0,this._shadowMapDirty=!1,this._bias=0,this._normalBias=0,this._fixedArea=!1,this._saturation=.75}var e=t.prototype;return e.getPlanarShader=function(t){return this._material||(this._material=new hg,this._material.initialize({effectName:"planar-shadow"})),this._material.passes[0].getShaderVariant(t)},e.getPlanarInstanceShader=function(t){return this._instancingMaterial||(this._instancingMaterial=new hg,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}})),this._instancingMaterial.passes[0].getShaderVariant(t)},e._setEnable=function(t){this._enabled=t},e._setType=function(t){this._type=this.enabled?t:dg},e.initialize=function(t){this.near=t.near,this.far=t.far,this.invisibleOcclusionRange=t.invisibleOcclusionRange,this.shadowDistance=t.shadowDistance,this.orthoSize=t.orthoSize,this.size=t.size,this.pcf=t.pcf,this.normal=t.normal,this.distance=t.distance,this.shadowColor=t.shadowColor,this.bias=t.bias,this.normalBias=t.normalBias,this.maxReceived=t.maxReceived,this.fixedArea=t.fixedArea,this._setEnable(t.enabled),this._setType(t.type),this.saturation=t.saturation},e.activate=function(){this.enabled&&this.type===fg.Planar&&this._updatePlanarInfo()},e._updatePlanarInfo=function(){this._material||(this._material=new hg,this._material.initialize({effectName:"planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new hg,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}))},e._destroy=function(){},e.destroy=function(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},N(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnable(t),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(t){oi.copy(this._normal,t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance=t}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(t){this._shadowColor=t}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(t){this._invisibleOcclusionRange=t}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(t){this._shadowDistance=t}},{key:"type",get:function(){return this._type},set:function(t){this._setType(t),this.activate()}},{key:"near",get:function(){return this._near},set:function(t){this._near=t}},{key:"far",get:function(){return this._far},set:function(t){this._far=t}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(t){this._orthoSize=t}},{key:"size",get:function(){return this._size},set:function(t){this._size.set(t)}},{key:"pcf",get:function(){return this._pcf},set:function(t){this._pcf=t}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(t){this._shadowMapDirty=t}},{key:"bias",get:function(){return this._bias},set:function(t){this._bias=t}},{key:"normalBias",get:function(){return this._normalBias},set:function(t){this._normalBias=t}},{key:"saturation",get:function(){return this._saturation},set:function(t){this._saturation=t}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(t){this._fixedArea=t}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"native",get:function(){return this._nativeObj}}]),t}();mg.MAX_FAR=2e3,mg.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),i.Shadows=mg;var vg=function(){function t(t){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=t,this._createNativeObject()}t.registerCreateFunc=function(e){e._createSceneFun=function(e){return new t(e)}};var e=t.prototype;return e.initialize=function(t){return this._name=t.name,!0},e.activate=function(){},e.update=function(t){var e=this._mainLight;e&&e.update();for(var n=this._sphereLights,i=0;i<n.length;i++)n[i].update();for(var r=this._spotLights,o=0;o<r.length;o++)r[o].update();for(var a=this._models,s=0;s<a.length;s++){var c=a[s];c.enabled&&(c.updateTransform(t),c.updateUBOs(t))}},e._destroy=function(){},e.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},e.addCamera=function(t){t.attachToScene(this),this._cameras.push(t)},e.removeCamera=function(t){for(var e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return this._cameras.splice(e,1),void t.detachFromScene()},e.removeCameras=function(){for(var t,e=W(this._cameras);!(t=e()).done;)t.value.detachFromScene();this._cameras.splice(0)},e.setMainLight=function(t){this._mainLight=t},e.unsetMainLight=function(t){if(this._mainLight===t){var e=this._directionalLights;if(e.length)return this.setMainLight(e[e.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=Nd.ROTATION));this.setMainLight(null)}},e.addDirectionalLight=function(t){t.attachToScene(this),this._directionalLights.push(t)},e.removeDirectionalLight=function(t){for(var e=0;e<this._directionalLights.length;++e)if(this._directionalLights[e]===t)return t.detachFromScene(),void this._directionalLights.splice(e,1)},e.addSphereLight=function(t){t.attachToScene(this),this._sphereLights.push(t)},e.removeSphereLight=function(t){for(var e=0;e<this._sphereLights.length;++e)if(this._sphereLights[e]===t)return t.detachFromScene(),void this._sphereLights.splice(e,1)},e.addSpotLight=function(t){t.attachToScene(this),this._spotLights.push(t)},e.removeSpotLight=function(t){for(var e=0;e<this._spotLights.length;++e)if(this._spotLights[e]===t)return t.detachFromScene(),void this._spotLights.splice(e,1)},e.removeSphereLights=function(){for(var t=0;t<this._sphereLights.length;++t)this._sphereLights[t].detachFromScene();this._sphereLights.length=0},e.removeSpotLights=function(){for(var t=0;t<this._spotLights.length;++t)this._spotLights[t].detachFromScene();this._spotLights=[]},e.addModel=function(t){t.attachToScene(this),this._models.push(t)},e.removeModel=function(t){for(var e=0;e<this._models.length;++e)if(this._models[e]===t)return t.detachFromScene(),void this._models.splice(e,1)},e.removeModels=function(){for(var t,e=W(this._models);!(t=e()).done;){var n=t.value;n.detachFromScene(),n.destroy()}this._models.length=0},e.addBatch=function(t){this._batches.push(t)},e.removeBatch=function(t){for(var e=0;e<this._batches.length;++e)if(this._batches[e]===t)return void this._batches.splice(e,1)},e.removeBatches=function(){this._batches.length=0},e.onGlobalPipelineStateChanged=function(){for(var t,e=W(this._models);!(t=e()).done;)t.value.onGlobalPipelineStateChanged()},e.generateModelId=function(){return this._modelId++},e._createNativeObject=function(){},N(t,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"native",get:function(){return this._nativeObj}},{key:"batches",get:function(){return this._batches}}]),t}(),gg=function(t){function e(e,n){var i;(i=t.call(this,e.root)||this)._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=e,i._owner=n,i._doInit(i._parent,!0);for(var r=0;r<i._shaderInfo.blocks.length;r++){var o=i._shaderInfo.blocks[r],a=i._blocks[o.binding],s=i._parent.blocks[o.binding];a.set(s)}i._setRootBufferDirty(!0);for(var c=i._parent,l=0;l<i._shaderInfo.samplerTextures.length;l++)for(var u=i._shaderInfo.samplerTextures[l],h=0;h<u.count;h++){var _=c._descriptorSet.getSampler(u.binding,h),f=c._descriptorSet.getTexture(u.binding,h);i._descriptorSet.bindSampler(u.binding,_,h),i._descriptorSet.bindTexture(u.binding,f,h)}return t.prototype.tryCompile.call(H(i)),i}F(e,t);var n=e.prototype;return n.overridePipelineStates=function(t,e){this._bs.reset(),this._rs.reset(),this._dss.reset(),Rv.fillPipelineInfo(this,t),Rv.fillPipelineInfo(this,e),this._onStateChange()},n.tryCompile=function(e){if(e&&!lv(this._defines,e))return!1;var n=t.prototype.tryCompile.call(this);return this._onStateChange(),n},n.beginChangeStatesSilently=function(){this._dontNotify=!0},n.endChangeStatesSilently=function(){this._dontNotify=!1},n._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(xv.NONE)},n._onStateChange=function(){this._setHash(Rv.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},N(e,[{key:"parent",get:function(){return this._parent}}]),e}(Rv),yg=function(t){function e(e){var n;return(n=t.call(this)||this)._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=e.parent,n._owner=e.owner||null,n._subModelIdx=e.subModelIdx||0,n.copy(n._parent),n}F(e,t);var n=e.prototype;return n.recompileShaders=function(t,e){if(this._passes&&this.effectAsset)if(void 0===e)for(var n,i=W(this._passes);!(n=i()).done;)n.value.tryCompile(t);else this._passes[e].tryCompile(t)},n.overridePipelineStates=function(t,e){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===e)for(var i=0;i<this._passes.length;i++){var r=this._passes[i],o=this._states[i]||(this._states[i]={});for(var a in t)o[a]=t[a];r.overridePipelineStates(n[r.passIndex],o)}else{var s=this._states[e]||(this._states[e]={});for(var c in t)s[c]=t[c];this._passes[e].overridePipelineStates(n[e],s)}}},n.destroy=function(){return this._doDestroy(),!0},n.onPassStateChange=function(t){this._hash=hg.getHash(this),!t&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},n._createPasses=function(){var t=[],e=this._parent.passes;if(!e)return t;for(var n=0;n<e.length;++n)t.push(new gg(e[n],this));return t},N(e,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),e}(hg),xg=null,Sg=null,Ag=function(){function t(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1}var e=t.prototype;return e._setEnabled=function(t){this._enabled=t},e._setUseIBL=function(t){this._useIBL=t},e._setUseHDR=function(t){this._useHDR=t},e._setUseDiffuseMap=function(t){this._useDiffuseMap=t},e.initialize=function(t){this._setEnabled(t.enabled),this._setUseIBL(t.useIBL),this._setUseDiffuseMap(t.applyDiffuseMap),this._setUseHDR(t.useHDR)},e.setEnvMaps=function(t,e){this._envmapHDR=t,this._envmapLDR=e;var n=i.director.root;n.pipeline.pipelineSceneData.isHDR?t&&(n.pipeline.pipelineSceneData.ambient.mipmapCount=t.mipmapLevel):e&&(n.pipeline.pipelineSceneData.ambient.mipmapCount=e.mipmapLevel),this._updateGlobalBinding(),this._updatePipeline()},e.setDiffuseMaps=function(t,e){this._diffuseMapHDR=t,this._diffuseMapLDR=e,this._updateGlobalBinding(),this._updatePipeline()},e.activate=function(){var t=i.director.root.pipeline;this._globalDSManager=t.globalDSManager,this._default=Cv.get("default-cube-texture"),this._model||(this._model=i.director.root.createModel(i.renderer.scene.Model),this._model._initLocalDescriptors=function(){},this._model._initWorldBoundDescriptors=function(){});var e=this._default.isRGBE;if(this.envmap&&(e=this.envmap.isRGBE),!Sg){var n=new hg;n.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:e}}),Sg=new yg({parent:n})}this.enabled&&(xg||(xg=i.utils.createMesh(i.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,xg.renderingSubMeshes[0],Sg)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()},e._updatePipeline=function(){var t=i.director.root,e=t.pipeline,n=this.useIBL?this.isRGBE?2:1:0,r=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,o=this.useHDR;e.macros.CC_USE_IBL===n&&e.macros.CC_USE_DIFFUSEMAP===r&&e.macros.CC_USE_HDR===o||(e.macros.CC_USE_IBL=n,e.macros.CC_USE_DIFFUSEMAP=r,e.macros.CC_USE_HDR=o,t.onGlobalPipelineStateChanged()),this.enabled&&Sg&&Sg.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,Sg)},e._updateGlobalBinding=function(){if(this._globalDSManager){var t=i.director.root.device,e=this.envmap?this.envmap:this._default;if(e){var n=e.getGFXTexture(),r=t.getSampler(e.getSamplerInfo());this._globalDSManager.bindSampler(Np,r),this._globalDSManager.bindTexture(Np,n)}var o=this.diffuseMap?this.diffuseMap:this._default;if(o){var a=o.getGFXTexture(),s=t.getSampler(o.getSamplerInfo());this._globalDSManager.bindSampler(zp,s),this._globalDSManager.bindTexture(zp,a)}this._globalDSManager.update()}},e._destroy=function(){},e.destroy=function(){this._destroy()},N(t,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnabled(t),t?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(t){this._setUseHDR(t),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(t){this._setUseIBL(t),this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(t){this._useDiffuseMap=t,this.setDiffuseMaps(null,null)}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"envmap",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(t,this._envmapLDR):this.setEnvMaps(this._envmapHDR,t)}},{key:"diffuseMap",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(t,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,t)}},{key:"native",get:function(){return this._nativeObj}}]),t}();i.Skybox=Ag;var Cg,bg,Tg=function(t){F(n,t);var e=n.prototype;function n(){var e;return(e=t.call(this)||this)._needUpdate=!1,e._size=.15,e._range=1,e._luminanceHDR=0,e._luminanceLDR=0,e._pos=void 0,e._aabb=void 0,e._aabb=Cc.create(),e._pos=new oi,e._type=Ld.SPHERE,e}return e._init=function(){t.prototype._init.call(this)},e._destroy=function(){t.prototype._destroy.call(this)},e.initialize=function(){t.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminance=1700/tm(.15),this.luminanceLDR=1},e.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var t=this._range;Cc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,t,t,t),this._needUpdate=!1}},N(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._needUpdate=!0}},{key:"luminance",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(t){this._luminanceHDR=t}},{key:"luminanceLDR",set:function(t){this._luminanceLDR=t}},{key:"aabb",get:function(){return this._aabb}}]),n}(em),Eg=new oi(0,0,-1),wg=new gi,Pg=new Ei,Ig=new Ei,Rg=new Ei,Dg=new Ei,Bg=function(t){F(n,t);var e=n.prototype;function n(){var e;return(e=t.call(this)||this)._dir=new oi(1,-1,-1),e._range=5,e._spotAngle=Math.cos(Math.PI/6),e._pos=void 0,e._aabb=void 0,e._frustum=void 0,e._angle=0,e._needUpdate=!1,e._size=.15,e._luminanceHDR=0,e._luminanceLDR=0,e._aspect=0,e._aabb=Cc.create(),e._frustum=Nc.create(),e._pos=new oi,e._type=Ld.SPOT,e}return e._init=function(){t.prototype._init.call(this)},e._destroy=function(){t.prototype._destroy.call(this)},e._setDirection=function(t){this._dir.set(t)},e.initialize=function(){t.prototype.initialize.call(this),this.size=.15,this.aspect=1,this.luminance=1700/tm(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new oi(1,-1,-1))},e.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),oi.transformQuat(this._dir,Eg,this._node.getWorldRotation(wg)),oi.normalize(this._dir,this._dir),Cc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(Pg),Ei.invert(Pg,Pg),Ei.perspective(Ig,this._angle,1,.001,this._range),Ei.multiply(Rg,Ig,Pg),this._frustum.update(Rg,Dg),this._needUpdate=!1)},N(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._needUpdate=!0}},{key:"luminance",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(t){this._luminanceHDR=t}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(t){this._luminanceLDR=t}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(t){this._angle=t,this._spotAngle=Math.cos(.5*t),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aspect",get:function(){return this._aspect},set:function(t){this._aspect=t,this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),n}(em),Mg=Object.freeze({__proto__:null,Ambient:Ui,Octree:ki,get CameraFOVAxis(){return Td},get CameraProjection(){return Ed},get CameraAperture(){return wd},get CameraISO(){return Pd},get CameraShutter(){return Id},SKYBOX_FLAG:Hd,Camera:Wd,DirectionalLight:rm,ColorTemperatureToRGB:qd,get LightType(){return Ld},nt2lm:tm,Light:em,get ModelType(){return Dv},Model:qv,ShadowSize:_g,ShadowType:fg,PCFType:pg,Shadows:mg,RenderScene:vg,Skybox:Ag,SphereLight:Tg,SpotLight:Bg,SubModel:Mv,NativeNode:null,NativeScene:null,NativeAABB:null,NativeModel:null,NativeSkinningModel:null,NativeBakedAnimInfo:null,NativeBakedJointInfo:null,NativeBakedSkinningModel:null,NativeLight:null,NativeDirectionalLight:null,NativeSphereLight:null,NativeSpotLight:null,NaitveSkybox:null,NativeFog:null,NativeRenderWindow:null,NativeCamera:null,NativePass:null,NativeSubModel:null,NativeDrawBatch2D:null,NativeRenderScene:null,NativeOctree:null,NativeAmbient:null,NativeShadow:null,NativeRoot:null,NativeJointTransform:null,NativeJointInfo:null,NativePipelineSharedSceneData:null});function Og(t){return--t,t|=t>>16,t|=t>>8,t|=t>>4,t|=t>>2,t|=t>>1,++t}function Ng(t,e){return Math.ceil(t/e)*e}!function(t){t[t.OPAQUE=0]="OPAQUE",t[t.TRANSPARENT=1]="TRANSPARENT",t[t.OVERLAY=2]="OVERLAY"}(Cg||(Cg={})),function(t){t[t.DEFAULT=1]="DEFAULT",t[t.FORWARD=2]="FORWARD",t[t.SHADOWCAST=4]="SHADOWCAST"}(bg||(bg={}));var Lg=function(){function t(t){this._device=void 0,this._format=fr.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new co,this._region1=new co,this._region2=new co,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}var e=t.prototype;return e.initialize=function(t){var e=na[t.format];this._format=t.format,this._formatSize=e.size,this._channels=e.count,this._bufferViewCtor=ha(e),this._roundUpFn=t.roundUpFn||null,this._alignment=t.alignment||1,t.inOrderFree&&(this.alloc=this._McDonaldAlloc)},e.destroy=function(){for(var t=0;t<this._chunkCount;++t)this._chunks[t].texture.destroy();this._chunks.length=0,this._handles.length=0},e.alloc=function(t,e){t=Ng(t,this._alignment);var n=-1,i=-1;if(void 0!==e&&(n=e,i=this._findAvailableSpace(t,n)),i<0)for(var r=0;r<this._chunkCount&&(n=r,!((i=this._findAvailableSpace(t,n))>=0));++r);if(i>=0){var o=this._chunks[n];o.start+=t;var a={chunkIdx:n,start:i,end:i+t,texture:o.texture};return this._handles.push(a),a}var s=Math.sqrt(t/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,Og(s)),l=this._chunks[this.createChunk(c)];l.start+=t;var u={chunkIdx:this._chunkCount-1,start:0,end:t,texture:l.texture};return this._handles.push(u),u},e.free=function(t){for(var e=0;e<this._handles.length;++e)if(this._handles[e]===t)return this._chunks[t.chunkIdx].end=t.end,void this._handles.splice(e,1)},e.createChunk=function(t){var e=t*t*this._formatSize;v("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+e+", format: "+this._format);var n={texture:this._device.createTexture(new xo(xr.TEX2D,Sr.SAMPLED|Sr.TRANSFER_DST,this._format,t,t)),size:e,start:0,end:e};return this._chunks[this._chunkCount]=n,this._chunkCount++},e.update=function(t,e){var n=[],i=[],r=t.start/this._formatSize,o=e.byteLength/this._formatSize,a=r%t.texture.width,s=Math.floor(r/t.texture.width),c=Math.min(t.texture.width-a,o),l=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(e,l*this._formatSize,c*this._channels)),i.push(this._region0),a=0,s+=1,o-=c,l+=c),o>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=s,o>t.texture.width?(this._region1.texExtent.width=t.texture.width,this._region1.texExtent.height=Math.floor(o/t.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=o,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(e,l*this._formatSize,c*this._channels)),i.push(this._region1),a=0,s+=this._region1.texExtent.height,o-=c,l+=c),o>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=s,this._region2.texExtent.width=o,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(e,l*this._formatSize,o*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,t.texture,i)},e._findAvailableSpace=function(t,e){var n=this._chunks[e],i=!1,r=n.start;if(r+t<=n.size)i=!0;else{r=0;for(var o=this._handles.filter((function(t){return t.chunkIdx===e})).sort((function(t,e){return t.start-e.start})),a=0;a<o.length;a++){var s=o[a];if(r+t<=s.start){i=!0;break}r=s.end}!i&&r+t<=n.size&&(i=!0)}return i?r:-1},e._McDonaldAlloc=function(t){t=Ng(t,this._alignment);for(var e=0;e<this._chunkCount;++e){var n=this._chunks[e],i=!1,r=n.start;if(r+t<=n.end?i=!0:r>n.end?r+t<=n.size?i=!0:t<=n.end&&(n.start=r=0,i=!0):r===n.end&&(n.start=r=0,n.end=n.size,t<=n.end&&(i=!0)),i){n.start+=t;var o={chunkIdx:e,start:r,end:r+t,texture:n.texture};return this._handles.push(o),o}}var a=Math.sqrt(t/this._formatSize),s=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,Og(a)),c=this._chunks[this.createChunk(s)];c.start+=t;var l={chunkIdx:this._chunkCount,start:0,end:t,texture:c.texture};return this._handles.push(l),l},t}(),Fg=function(t){if(void 0===Rn[t]){var e=1<<In;Rn[t]=e,In+=1}},zg=Object.freeze({__proto__:null,addStage:Fg,scene:Mg,createIA:function(t,e){if(!e.positions)return console.error("The data must have positions field"),null;for(var n=[],i=e.positions.length/3,r=0;r<i;++r)n.push(e.positions[3*r],e.positions[3*r+1],e.positions[3*r+2]),e.normals&&n.push(e.normals[3*r],e.normals[3*r+1],e.normals[3*r+2]),e.uvs&&n.push(e.uvs[2*r],e.uvs[2*r+1]),e.colors&&n.push(e.colors[3*r],e.colors[3*r+1],e.colors[3*r+2]);var o=[];o.push(new Bo(Zr.ATTR_POSITION,fr.RGB32F)),e.normals&&o.push(new Bo(Zr.ATTR_NORMAL,fr.RGB32F)),e.uvs&&o.push(new Bo(Zr.ATTR_TEX_COORD,fr.RG32F)),e.colors&&o.push(new Bo(Zr.ATTR_COLOR,fr.RGB32F));var a=t.createBuffer(new po(mr.VERTEX|mr.TRANSFER_DST,yr.DEVICE,4*n.length,4*n.length/i));a.update(new Float32Array(n));var s=null;return e.indices&&(s=t.createBuffer(new po(mr.INDEX|mr.TRANSFER_DST,yr.DEVICE,2*e.indices.length,2))).update(new Uint16Array(e.indices)),t.createInputAssembler(new Oo(o,[a],s))},get RenderQueue(){return Cg},get PassStage(){return bg},genHandle:$m,getTypeFromHandle:tv,getBindingFromHandle:ev,getCountFromHandle:nv,getOffsetFromHandle:iv,customizeType:rv,type2reader:ov,type2writer:av,getDefaultFromType:cv,overrideMacros:lv,get BatchingSchemes(){return xv},Pass:Rv,getDeviceShaderVersion:mv,programLib:vv,nearestPOT:Og,TextureBufferPool:Lg,MaterialInstance:yg,PassInstance:gg,get PoolType(){return ic},NULL_HANDLE:0,get NodeView(){return rc},NodePool:lc,get PassView(){return ac},PassPool:fc,get AABBView(){return uc},AABBPool:mc});t("renderer",zg);var Vg=new oi,Gg=(new oi,new oi,new oi),Ug=new Ei,kg=new Cc,Hg=new Cc,jg=!1,Wg=Kr.create(0,0,0,1),qg=new Kr,Xg=new Nc;Xg.accurate=!0;var Yg=new Nc;Yg.accurate=!0;var Kg=new Nc,Jg=new Ei,Qg=new Ei,Zg=new Ei,$g=new Ei,ty=new Ei,ey=new Ei,ny=new Ei,iy=new oi,ry=new li,oy=new oi,ay=new oi,sy=new oi(0,0,0),cy=(new Cc,new Wt((function(){return{model:null,depth:0}}),128)),ly=new Wt((function(){return{model:null,depth:0}}),128),uy=new Wt((function(){return{model:null,depth:0}}),128);function hy(t,e){var n=0;t.node&&(oi.subtract(Vg,t.node.worldPosition,e.position),n=oi.dot(Vg,e.forward));var i=cy.alloc();return i.model=t,i.depth=n,i}function _y(t,e){var n=0;t.node&&(oi.subtract(Vg,t.node.worldPosition,e.position),n=oi.dot(Vg,e.forward));var i=ly.alloc();return i.model=t,i.depth=n,i}function fy(t,e){var n=0;t.node&&(oi.subtract(Vg,t.node.worldPosition,e.position),n=oi.dot(Vg,e.forward));var i=uy.alloc();return i.model=t,i.depth=n,i}function py(t,e,n){var i=e.direction,r=t.normal,o=t.distance+.001,a=1/oi.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,_=r.z,f=t.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,Ei.toArray(n,f,Dp.MAT_LIGHT_PLANE_PROJ_OFFSET)}function dy(t,e){oi.normalize(Vg,t.normal),e[Dp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=Vg.x,e[Dp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=Vg.y,e[Dp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=Vg.z,e[Dp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=t.distance}function my(t,e){var n=t.pipelineSceneData.validPunctualLights;n.length=0;for(var i=e.scene.spotLights,r=0;r<i.length;r++){var o=i[r];o.baked||(Kr.set(Wg,o.position.x,o.position.y,o.position.z,o.range),ks.sphereFrustum(Wg,e.frustum)&&n.push(o))}for(var a=e.scene.sphereLights,s=0;s<a.length;s++){var c=a[s];c.baked||(Kr.set(Wg,c.position.x,c.position.y,c.position.z,c.range),ks.sphereFrustum(Wg,e.frustum)&&n.push(c))}}function vy(t,e){var n=e.scene,i=n.mainLight,r=t.pipelineSceneData,o=r.shadows,a=r.skybox,s=r.renderObjects;cy.freeArray(s),s.length=0;var c=r.castShadowObjects;uy.freeArray(c),c.length=0,jg=!1;var l=null;if(o.enabled&&(t.pipelineUBO.updateShadowUBORange(Dp.SHADOW_COLOR_OFFSET,o.shadowColor),o.type===fg.ShadowMap))if(l=t.pipelineSceneData.dirShadowObjects,ly.freeArray(l),l.length=0,i&&i.node)!function(t,e,n,i,r){var o=e.device;if(r.fixedArea){var a=r.orthoSize,s=r.orthoSize,c=r.near,l=r.far;Ei.fromRT(Jg,n.node.getWorldRotation(),n.node.getWorldPosition()),Ei.invert(Qg,Jg),Ei.ortho($g,-a,a,-s,s,c,l,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),Ei.multiply(ty,$g,Qg),Ei.invert(Zg,Qg),r.matShadowView=Qg,r.matShadowProj=$g,r.matShadowViewProj=ty,Nc.createOrtho(t,2*a,2*s,c,l,Zg)}else{var u=r.invisibleOcclusionRange,h=r.size.x;!function(t,e){if(e.node){var n=e.node,i=n.getWorldPosition(),r=n.getWorldRotation();Ei.fromRT(t,r,i),t.m08*=-1,t.m09*=-1,t.m10*=-1}}(Ug,i),Nc.split(Xg,i,Ug,.1,r.shadowDistance),Yg=Nc.clone(Xg),Ei.fromRT(Jg,n.node.rotation,sy),Ei.invert(Qg,Jg),Ei.invert(Zg,Qg);var _=Qg.clone();Yg.transform(Qg),Cc.fromPoints(kg,new oi(1e7,1e7,1e7),new oi(-1e7,-1e7,-1e7)),kg.mergeFrustum(Yg);var f=2*kg.halfExtents.z;Gg.set(kg.center.x,kg.center.y,kg.center.z+kg.halfExtents.z+u),oi.transformMat4(Gg,Gg,Zg),Ei.fromRT(Jg,n.node.rotation,Gg),Ei.invert(Qg,Jg),Ei.invert(Zg,Qg);var p=oi.distance(Xg.vertices[0],Xg.vertices[6]);qg.center.set(0,0,0),qg.radius=-1,qg.mergePoints(Xg.vertices);var d=.8*p+.4*qg.radius;r.shadowCameraFar=f+u;var m=.5*d;if(Ei.ortho($g,-m,m,-m,m,.1,r.shadowCameraFar,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),h>0){Ei.multiply(ey,$g,_),oi.transformMat4(iy,Gg,ey);var v=2/h;ry.set(v,v);var g=iy.x%ry.x,y=iy.y%ry.y;oy.set(iy.x-g,iy.y-y,iy.z),Ei.invert(ny,ey),oi.transformMat4(ay,oy,ny),Ei.fromRT(Jg,n.node.rotation,ay),Ei.invert(Qg,Jg),Ei.invert(Zg,Qg),Nc.createOrtho(t,d,d,.1,r.shadowCameraFar,Zg)}else{for(var x=0;x<8;x++)t.vertices[x].set(0,0,0);t.updatePlanes()}Ei.multiply(ty,$g,Qg),r.matShadowView=Qg,r.matShadowProj=$g,r.matShadowViewProj=ty}}(Kg,t,i,e,o);else{for(var u=0;u<8;u++)Kg.vertices[u].set(0,0,0);Kg.updatePlanes()}i&&o.type===fg.Planar&&function(t,e){var n=t.pipelineSceneData.shadows,i=e.direction,r=n.normal,o=n.distance+.001,a=1/oi.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,_=r.z,f=n.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,t.pipelineUBO.updateShadowUBORange(Dp.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(t,i),a.enabled&&a.model&&e.clearFlag&Hd&&s.push(hy(a.model,e));for(var h=n.models,_=e.visibility,f=0;f<h.length;f++){var p=h[f];if(p.enabled&&(p.castShadow&&c.push(fy(p,e)),o.firstSetCSM&&p.worldBounds&&(jg||(Hg.copy(p.worldBounds),jg=!0),Cc.merge(Hg,Hg,p.worldBounds)),p.node&&(_&p.node.layer)===p.node.layer||_&p.visFlags)){if(null!=l&&p.castShadow&&p.worldBounds&&ks.aabbFrustum(p.worldBounds,Kg)&&l.push(_y(p,e)),p.worldBounds&&!ks.aabbFrustum(p.worldBounds,e.frustum))continue;s.push(hy(p,e))}}o.firstSetCSM&&(o.shadowDistance=2*Hg.halfExtents.length(),o.firstSetCSM=!1)}var gy,yy,xy,Sy,Ay,Cy,by,Ty,Ey,wy,Py=new Ao(Tr.LINEAR,Tr.LINEAR,Tr.NONE,Er.CLAMP,Er.CLAMP,Er.CLAMP),Iy=new Ao(Tr.POINT,Tr.POINT,Tr.NONE,Er.CLAMP,Er.CLAMP,Er.CLAMP),Ry=function(){function t(t){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=t.device,this._linearSampler=this._device.getSampler(Py),this._pointSampler=this._device.getSampler(Iy);var e=new jo(xp.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._globalDescriptorSet=this._device.createDescriptorSet(new Wo(this._descriptorSetLayout))}var e=t.prototype;return e.bindBuffer=function(t,e){this._globalDescriptorSet.bindBuffer(t,e);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindBuffer(t,e),i=n.next()},e.bindSampler=function(t,e){this._globalDescriptorSet.bindSampler(t,e);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindSampler(t,e),i=n.next()},e.bindTexture=function(t,e){this._globalDescriptorSet.bindTexture(t,e);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindTexture(t,e),i=n.next()},e.update=function(){this._globalDescriptorSet.update();for(var t=this._descriptorSetMap.values(),e=t.next();!e.done;)e.value.update(),e=t.next()},e.getOrCreateDescriptorSet=function(t){var e=this._device;if(!this._descriptorSetMap.has(t)){var n=this._globalDescriptorSet,i=e.createDescriptorSet(new Wo(this._descriptorSetLayout));this._descriptorSetMap.set(t,i);for(var r=yp.UBO_GLOBAL;r<yp.COUNT;r++)i.bindBuffer(r,n.getBuffer(r)),i.bindSampler(r,n.getSampler(r)),i.bindTexture(r,n.getTexture(r));var o=e.createBuffer(new po(mr.UNIFORM|mr.TRANSFER_DST,yr.HOST|yr.DEVICE,Dp.SIZE,Dp.SIZE));i.bindBuffer(Dp.BINDING,o),i.update()}return this._descriptorSetMap.get(t)},e.destroy=function(){this._descriptorSetLayout.destroy()},N(t,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),t}(),Dy=new Ei,By=new Ei,My=new Ei,Oy=new fi,Ny=new fi(0,0,1,0),Ly=function(){function t(){this._globalUBO=new Float32Array(Ip.COUNT),this._cameraUBO=new Float32Array(Rp.COUNT),this._shadowUBO=new Float32Array(Dp.COUNT)}t.updateGlobalUBOView=function(t,e){var n=i.director.root,r=e,o=Math.floor(t.width),a=Math.floor(t.height);r[Ip.TIME_OFFSET]=n.cumulativeTime,r[Ip.TIME_OFFSET+1]=n.frameTime,r[Ip.TIME_OFFSET+2]=i.director.getTotalFrames(),r[Ip.SCREEN_SIZE_OFFSET]=o,r[Ip.SCREEN_SIZE_OFFSET+1]=a,r[Ip.SCREEN_SIZE_OFFSET+2]=1/o,r[Ip.SCREEN_SIZE_OFFSET+3]=1/a,r[Ip.NATIVE_SIZE_OFFSET]=o,r[Ip.NATIVE_SIZE_OFFSET+1]=a,r[Ip.NATIVE_SIZE_OFFSET+2]=1/r[Ip.NATIVE_SIZE_OFFSET],r[Ip.NATIVE_SIZE_OFFSET+3]=1/r[Ip.NATIVE_SIZE_OFFSET+1]},t.updateCameraUBOView=function(t,e,n){var r=(n.scene?n.scene:i.director.getScene().renderScene).mainLight,o=t.pipelineSceneData,a=o.ambient,s=o.fog,c=o.shadows,l=e,u=n.exposure,h=o.isHDR;if(l[Rp.SCREEN_SCALE_OFFSET]=o.shadingScale,l[Rp.SCREEN_SCALE_OFFSET+1]=o.shadingScale,l[Rp.SCREEN_SCALE_OFFSET+2]=1/l[Rp.SCREEN_SCALE_OFFSET],l[Rp.SCREEN_SCALE_OFFSET+3]=1/l[Rp.SCREEN_SCALE_OFFSET+1],l[Rp.EXPOSURE_OFFSET]=u,l[Rp.EXPOSURE_OFFSET+1]=1/u,l[Rp.EXPOSURE_OFFSET+2]=h?1:0,l[Rp.EXPOSURE_OFFSET+3]=0,r){var _=c.enabled&&c.type===fg.ShadowMap?1:0,f=r.direction;if(Ny.set(f.x,f.y,f.z,_),fi.toArray(l,Ny,Rp.MAIN_LIT_DIR_OFFSET),oi.toArray(l,r.color,Rp.MAIN_LIT_COLOR_OFFSET),r.useColorTemperature){var p=r.colorTemperatureRGB;l[Rp.MAIN_LIT_COLOR_OFFSET]*=p.x,l[Rp.MAIN_LIT_COLOR_OFFSET+1]*=p.y,l[Rp.MAIN_LIT_COLOR_OFFSET+2]*=p.z}l[Rp.MAIN_LIT_COLOR_OFFSET+3]=h?r.illuminance*u:r.illuminance}else Ny.set(0,0,1,0),fi.toArray(l,Ny,Rp.MAIN_LIT_DIR_OFFSET),fi.toArray(l,fi.ZERO,Rp.MAIN_LIT_COLOR_OFFSET);var d=a.skyColor;d.w=h?a.skyIllum*u:a.skyIllum,l[Rp.AMBIENT_SKY_OFFSET+0]=d.x,l[Rp.AMBIENT_SKY_OFFSET+1]=d.y,l[Rp.AMBIENT_SKY_OFFSET+2]=d.z,l[Rp.AMBIENT_SKY_OFFSET+3]=d.w,l[Rp.AMBIENT_GROUND_OFFSET+0]=a.groundAlbedo.x,l[Rp.AMBIENT_GROUND_OFFSET+1]=a.groundAlbedo.y,l[Rp.AMBIENT_GROUND_OFFSET+2]=a.groundAlbedo.z,l[Rp.AMBIENT_GROUND_OFFSET+3]=a.mipmapCount,Ei.toArray(l,n.matView,Rp.MAT_VIEW_OFFSET),Ei.toArray(l,n.node.worldMatrix,Rp.MAT_VIEW_INV_OFFSET),oi.toArray(l,n.position,Rp.CAMERA_POS_OFFSET),Ei.toArray(l,n.matProj,Rp.MAT_PROJ_OFFSET),Ei.toArray(l,n.matProjInv,Rp.MAT_PROJ_INV_OFFSET),Ei.toArray(l,n.matViewProj,Rp.MAT_VIEW_PROJ_OFFSET),Ei.toArray(l,n.matViewProjInv,Rp.MAT_VIEW_PROJ_INV_OFFSET),l[Rp.CAMERA_POS_OFFSET+3]=this.getCombineSignY();var m=s.colorArray;l[Rp.GLOBAL_FOG_COLOR_OFFSET]=m.x,l[Rp.GLOBAL_FOG_COLOR_OFFSET+1]=m.y,l[Rp.GLOBAL_FOG_COLOR_OFFSET+2]=m.z,l[Rp.GLOBAL_FOG_COLOR_OFFSET+3]=m.z,l[Rp.GLOBAL_FOG_BASE_OFFSET]=s.fogStart,l[Rp.GLOBAL_FOG_BASE_OFFSET+1]=s.fogEnd,l[Rp.GLOBAL_FOG_BASE_OFFSET+2]=s.fogDensity,l[Rp.GLOBAL_FOG_ADD_OFFSET]=s.fogTop,l[Rp.GLOBAL_FOG_ADD_OFFSET+1]=s.fogRange,l[Rp.GLOBAL_FOG_ADD_OFFSET+2]=s.fogAtten,l[Rp.NEAR_FAR_OFFSET]=n.nearClip,l[Rp.NEAR_FAR_OFFSET+1]=n.farClip,l[Rp.VIEW_PORT_OFFSET]=o.shadingScale*n.window.width*n.viewport.x,l[Rp.VIEW_PORT_OFFSET+1]=o.shadingScale*n.window.height*n.viewport.y,l[Rp.VIEW_PORT_OFFSET+2]=o.shadingScale*n.window.width*n.viewport.z,l[Rp.VIEW_PORT_OFFSET+3]=o.shadingScale*n.window.height*n.viewport.w},t.updateShadowUBOView=function(t,e,n){var i=t.device,r=n.scene.mainLight,o=t.pipelineSceneData.shadows,a=e;if(o.enabled){if(r&&o.type===fg.ShadowMap){var s=.1,c=0,l=o.matShadowView,u=o.matShadowProj,h=o.matShadowViewProj;o.fixedArea?(s=o.near,c=o.far):(s=.1,c=o.shadowCameraFar),Ei.toArray(e,l,Dp.MAT_LIGHT_VIEW_OFFSET),a[Dp.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,a[Dp.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,a[Dp.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,a[Dp.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,a[Dp.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,a[Dp.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,a[Dp.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,a[Dp.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,Ei.toArray(e,h,Dp.MAT_LIGHT_VIEW_PROJ_OFFSET);var _=Md(i)?0:1;a[Dp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=s,a[Dp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=c,a[Dp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,a[Dp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-o.saturation,a[Dp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=o.size.x,a[Dp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=o.size.y,a[Dp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=o.pcf,a[Dp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=o.bias,a[Dp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,a[Dp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=_,a[Dp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=o.normalBias,a[Dp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else r&&o.type===fg.Planar&&(py(o,r,a),dy(o,a));Li.toArray(a,o.shadowColor,Dp.SHADOW_COLOR_OFFSET)}},t.updateShadowUBOLightView=function(t,e,n){var i=t.device,r=t.pipelineSceneData.shadows,o=e,a=Md(i)?0:1,s=.1,c=0,l=r.matShadowView,u=r.matShadowProj,h=r.matShadowViewProj;switch(n.type){case Ld.DIRECTIONAL:r.fixedArea?(s=r.near,c=r.far):(s=.1,c=r.shadowCameraFar),Ei.toArray(e,l,Dp.MAT_LIGHT_VIEW_OFFSET),o[Dp.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,o[Dp.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,o[Dp.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,o[Dp.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,o[Dp.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,o[Dp.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,o[Dp.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,o[Dp.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,Ei.toArray(e,h,Dp.MAT_LIGHT_VIEW_PROJ_OFFSET),Oy.set(s,c,0,1-r.saturation),fi.toArray(o,Oy,Dp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Oy.set(0,a,r.normalBias,0),fi.toArray(o,Oy,Dp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);break;case Ld.SPOT:Ei.invert(Dy,n.node.getWorldMatrix()),Ei.toArray(o,Dy,Dp.MAT_LIGHT_VIEW_OFFSET),Ei.perspective(By,n.angle,n.aspect,.001,n.range),Ei.multiply(My,By,Dy),Ei.toArray(o,My,Dp.MAT_LIGHT_VIEW_PROJ_OFFSET),Oy.set(.01,n.range,0,1-r.saturation),fi.toArray(o,Oy,Dp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Oy.set(1,a,r.normalBias,0),fi.toArray(o,Oy,Dp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}Oy.set(r.size.x,r.size.y,r.pcf,r.bias),fi.toArray(o,Oy,Dp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),Li.toArray(o,r.shadowColor,Dp.SHADOW_COLOR_OFFSET)},t.getCombineSignY=function(){return t._combineSignY};var e=t.prototype;return e._initCombineSignY=function(){var e=this._device;t._combineSignY=.5*e.capabilities.screenSpaceSignY+.5<<1|.5*e.capabilities.clipSpaceSignY+.5},e.activate=function(t,e){this._device=t,this._pipeline=e;var n=this._pipeline.descriptorSet;this._initCombineSignY();var i=t.createBuffer(new po(mr.UNIFORM|mr.TRANSFER_DST,yr.HOST|yr.DEVICE,Ip.SIZE,Ip.SIZE));n.bindBuffer(Ip.BINDING,i);var r=t.createBuffer(new po(mr.UNIFORM|mr.TRANSFER_DST,yr.HOST|yr.DEVICE,Rp.SIZE,Rp.SIZE));n.bindBuffer(Rp.BINDING,r);var o=t.createBuffer(new po(mr.UNIFORM|mr.TRANSFER_DST,yr.HOST|yr.DEVICE,Dp.SIZE,Dp.SIZE));n.bindBuffer(Dp.BINDING,o)},e.updateGlobalUBO=function(e){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;i.update(),t.updateGlobalUBOView(e,this._globalUBO),r[0].updateBuffer(i.getBuffer(Ip.BINDING),this._globalUBO),n.bindBuffer(Ip.BINDING,i.getBuffer(Ip.BINDING)),n.update()},e.updateCameraUBO=function(e){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;t.updateCameraUBOView(this._pipeline,this._cameraUBO,e),r[0].updateBuffer(i.getBuffer(Rp.BINDING),this._cameraUBO),n.bindBuffer(Rp.BINDING,i.getBuffer(Rp.BINDING)),n.update()},e.updateShadowUBO=function(e){var n=this._pipeline.pipelineSceneData;if(n.shadows.enabled){var i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,o=n.shadowFrameBufferMap,a=e.scene.mainLight;a&&o.has(a)&&i.bindTexture(Bp,o.get(a).colorTextures[0]),t.updateShadowUBOView(this._pipeline,this._shadowUBO,e),i.update(),r[0].updateBuffer(i.getBuffer(Dp.BINDING),this._shadowUBO)}},e.updateShadowUBOLight=function(e,n){t.updateShadowUBOLightView(this._pipeline,this._shadowUBO,n),e.bindTexture(Bp,Cv.get("default-texture").getGFXTexture()),e.bindTexture(Up,Cv.get("default-texture").getGFXTexture()),e.update(),e.getBuffer(Dp.BINDING).update(this._shadowUBO)},e.updateShadowUBORange=function(t,e){e instanceof Ei?Ei.toArray(this._shadowUBO,e,t):e instanceof Li&&Li.toArray(this._shadowUBO,e,t)},e.destroy=function(){},t}();Ly._combineSignY=0;var Fy,zy,Vy,Gy,Uy,ky,Hy,jy,Wy,qy,Xy,Yy,Ky,Jy=t("RenderStage",(gy=qc("RenderStage"),yy=yl(),xy=yl(),Sy=yl(),gy((wy=function(){function t(){q(this,"_name",by,this),q(this,"_priority",Ty,this),this._enabled=!0,q(this,"_tag",Ey,this)}var e=t.prototype;return e.initialize=function(t){return this._name=t.name,this._priority=t.priority,t.tag&&(this._tag=t.tag),!0},e.activate=function(t,e){this._pipeline=t,this._flow=e},N(t,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}}]),t}(),by=X((Cy=wy).prototype,"_name",[yy,Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ty=X(Cy.prototype,"_priority",[xy,Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ey=X(Cy.prototype,"_tag",[Sy,Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ay=Cy))||Ay));i.RenderStage=Jy;var Qy,Zy=t("RenderFlow",(Fy=qc("RenderFlow"),zy=yl(),Vy=yl(),Gy=yl(),Uy=yl(),ky=El([Jy]),Fy((Ky=function(){function t(){q(this,"_name",Wy,this),q(this,"_priority",qy,this),q(this,"_tag",Xy,this),q(this,"_stages",Yy,this)}var e=t.prototype;return e.initialize=function(t){return this._name=t.name,this._priority=t.priority,this._stages=t.stages,t.tag&&(this._tag=t.tag),!0},e.activate=function(t){this._pipeline=t,this._stages.sort((function(t,e){return t.priority-e.priority}));for(var e=0,n=this._stages.length;e<n;e++)this._stages[e].activate(t,this)},e.render=function(t){for(var e=0,n=this._stages.length;e<n;e++)this._stages[e].enabled&&this._stages[e].render(t)},e.destroy=function(){for(var t=0,e=this._stages.length;t<e;t++)this._stages[t].destroy();this._stages.length=0},N(t,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),t}(),Wy=X((jy=Ky).prototype,"_name",[zy,Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),qy=X(jy.prototype,"_priority",[Vy,Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xy=X(jy.prototype,"_tag",[Gy,Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Yy=X(jy.prototype,"_stages",[Uy,ky,Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Hy=jy))||Hy));i.RenderFlow=Zy,function(t){t.RENDER_FRAME_BEGIN="render-frame-begin",t.RENDER_FRAME_END="render-frame-end",t.RENDER_CAMERA_BEGIN="render-camera-begin",t.RENDER_CAMERA_END="render-camera-end",t.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(Qy||(Qy=t("PipelineEventType",{})));var $y,tx,ex,nx,ix,rx,ox,ax,sx,cx,lx,ux,hx,_x,fx,px=t("PipelineEventProcessor",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).eventTargetOn=t.prototype.on,e.eventTargetOnce=t.prototype.once,e}F(e,t);var n=e.prototype;return n.on=function(t,e,n,i){return this.eventTargetOn(t,e,n,i)},n.once=function(t,e,n){return this.eventTargetOnce(t,e,n)},e}(pn)),dx=new no,mx=new lo,vx=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},gx=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},yx=t("RenderPipeline",($y=qc("cc.RenderPipeline"),tx=yl(),ex=yl(),nx=El([Zy]),$y((sx=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_tag",ox,H(e)),q(e,"_flows",ax,H(e)),e._quadIB=null,e._quadVBOnscreen=null,e._quadVBOffscreen=null,e._quadIAOnscreen=null,e._quadIAOffscreen=null,e._eventProcessor=new px,e._commandBuffers=[],e._pipelineUBO=new Ly,e._macros={},e._constantMacros="",e._profiler=null,e._pipelineRenderData=null,e._renderPasses=new Map,e._width=0,e._height=0,e._lastUsedRenderArea=new no,e._clusterEnabled=!1,e._bloomEnabled=!1,e}F(e,t);var n=e.prototype;return n.getPipelineRenderData=function(){return this._pipelineRenderData},n.initialize=function(t){return this._flows=t.flows,t.tag&&(this._tag=t.tag),!0},n.createRenderPass=function(t,e,n){var i=this._device,r=new No,o=new Lo;r.format=e,o.format=n,o.stencilStoreOp=Or.DISCARD,o.depthStoreOp=Or.DISCARD,t&Yr.COLOR||(t&Hd?r.loadOp=Mr.DISCARD:(r.loadOp=Mr.LOAD,r.beginAccesses=[Nr.COLOR_ATTACHMENT_WRITE])),(t&Yr.DEPTH_STENCIL)!==Yr.DEPTH_STENCIL&&(t&Yr.DEPTH||(o.depthLoadOp=Mr.LOAD),t&Yr.STENCIL||(o.stencilLoadOp=Mr.LOAD)),o.beginAccesses=[Nr.DEPTH_STENCIL_ATTACHMENT_WRITE];var a=new Vo([r],o);return i.createRenderPass(a)},n.getRenderPass=function(t,e){var n=this._renderPasses.get(t);return n||(n=this.createRenderPass(t,e.colorTextures[0].format,e.depthStencilTexture.format),this._renderPasses.set(t,n),n)},n.applyFramebufferRatio=function(t){for(var e=this.pipelineSceneData,n=this._width*e.shadingScale,i=this._height*e.shadingScale,r=t.colorTextures,o=0;o<r.length;o++)r[o].resize(n,i);t.depthStencilTexture&&t.depthStencilTexture.resize(n,i),t.destroy(),t.initialize(new ko(t.renderPass,r,t.depthStencilTexture))},n.generateRenderArea=function(t,e){var n=t.viewport,i=t.window.width,r=t.window.height;e.x=n.x*i,e.y=n.y*r,e.width=n.width*i,e.height=n.height*r},n.generateViewport=function(t,e){this.generateRenderArea(t,dx),e||(e=mx);var n=this.pipelineSceneData.shadingScale;return e.left=dx.x*n,e.top=dx.y*n,e.width=dx.width*n,e.height=dx.height*n,e},n.generateScissor=function(t,e){e||(e=dx),this.generateRenderArea(t,e);var n=this.pipelineSceneData.shadingScale;return e.x*=n,e.y*=n,e.width*=n,e.height*=n,e},n.activate=function(){var t=i.director.root;this._device=t.device,this._generateConstantMacros(),this._globalDSManager=new Ry(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this);for(var e=0;e<this._flows.length;e++)this._flows[e].activate(this);return!0},n._ensureEnoughSize=function(){},n.render=function(t){if(0!==t.length){this._commandBuffers[0].begin(),this.emit(Qy.RENDER_FRAME_BEGIN,t),this._ensureEnoughSize(t),function(t){for(var e=t.length-1;e>=0;--e){var n=t[e];if(n.window.swapchain)return void(cg=n)}cg=null}(t);for(var e=0;e<t.length;e++){var n=t[e];if(n.scene){this.emit(Qy.RENDER_CAMERA_BEGIN,n),my(this,n),vy(this,n),this._pipelineUBO.updateGlobalUBO(n.window),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n);this.emit(Qy.RENDER_CAMERA_END,n)}}this.emit(Qy.RENDER_FRAME_END,t),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},n._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},n._destroyBloomData=function(){var t,e=this._pipelineRenderData.bloom;if(null!==e){e.prefiterTex&&e.prefiterTex.destroy(),e.prefilterFramebuffer&&e.prefilterFramebuffer.destroy();for(var n=0;n<e.downsampleTexs.length;++n)e.downsampleTexs[n].destroy(),e.downsampleFramebuffers[n].destroy();e.downsampleTexs.length=0,e.downsampleFramebuffers.length=0;for(var i=0;i<e.upsampleTexs.length;++i)e.upsampleTexs[i].destroy(),e.upsampleFramebuffers[i].destroy();e.upsampleTexs.length=0,e.upsampleFramebuffers.length=0,e.combineTex&&e.combineTex.destroy(),e.combineFramebuffer&&e.combineFramebuffer.destroy(),null===(t=e.renderPass)||void 0===t||t.destroy(),this._pipelineRenderData.bloom=null}},n._genQuadVertexData=function(t,e){var n=new Float32Array(16),i=e.x/this._width,r=(e.x+e.width)/this._width,o=e.y/this._height,a=(e.y+e.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var s=a;a=o,o=s}var c=0;switch(t){case hr.IDENTITY:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o;break;case hr.ROTATE_90:c=0,n[c++]=-1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=i,n[c++]=o;break;case hr.ROTATE_180:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a;break;case hr.ROTATE_270:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=r,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a}return n},n._createQuadInputAssembler=function(){var t=new gx,e=4*Float32Array.BYTES_PER_ELEMENT,n=4*e,i=this._device.createBuffer(new po(mr.VERTEX|mr.TRANSFER_DST,yr.DEVICE|yr.HOST,n,e));if(!i)return t;var r=Uint8Array.BYTES_PER_ELEMENT,o=6*r,a=this._device.createBuffer(new po(mr.INDEX|mr.TRANSFER_DST,yr.DEVICE,o,r));if(!a)return t;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,a.update(s);var c=new Array(2);c[0]=new Bo("a_position",fr.RG32F),c[1]=new Bo("a_texCoord",fr.RG32F);var l=this._device.createInputAssembler(new Oo(c,[i],a));return t.quadIB=a,t.quadVB=i,t.quadIA=l,t},n.updateQuadVertexData=function(t,e){var n=this._lastUsedRenderArea;if(n.x!==t.x||n.y!==t.y||n.width!==t.width||n.height!==t.height){var i=this._genQuadVertexData(hr.IDENTITY,t);this._quadVBOffscreen.update(i);var r=this._genQuadVertexData(e.swapchain&&e.swapchain.surfaceTransform||hr.IDENTITY,t);this._quadVBOnscreen.update(r),n.copy(t)}},n.destroy=function(){for(var e,n,i=0;i<this._flows.length;i++)this._flows[i].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(e=this._globalDSManager)||void 0===e||e.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(n=this._pipelineSceneData)||void 0===n||n.destroy(),t.prototype.destroy.call(this)},n._generateConstantMacros=function(){var t="";t+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.hasFeature(_r.TEXTURE_FLOAT)?1:0)+"\n",t+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",t+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",t+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",t+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(_r.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",t+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(dn.os===hn.ANDROID&&dn.isBrowser?1:0)+"\n",t+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(ee.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",this._constantMacros=t},n.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var t=this._pipelineRenderData.bloom=new vx,e=this.device,n=new No;n.format=fr.RGBA8,n.loadOp=Mr.CLEAR,n.storeOp=Or.STORE,n.endAccesses=[Nr.COLOR_ATTACHMENT_WRITE],t.renderPass=e.createRenderPass(new Vo([n]));var i=this._width,r=this._height;t.prefiterTex=e.createTexture(new xo(xr.TEX2D,Sr.COLOR_ATTACHMENT|Sr.SAMPLED,fr.RGBA8,i>>1,r>>1)),t.prefilterFramebuffer=e.createFramebuffer(new ko(t.renderPass,[t.prefiterTex])),i>>=1,r>>=1;for(var o=0;o<6;++o)t.downsampleTexs.push(e.createTexture(new xo(xr.TEX2D,Sr.COLOR_ATTACHMENT|Sr.SAMPLED,fr.RGBA8,i>>1,r>>1))),t.downsampleFramebuffers[o]=e.createFramebuffer(new ko(t.renderPass,[t.downsampleTexs[o]])),t.upsampleTexs.push(e.createTexture(new xo(xr.TEX2D,Sr.COLOR_ATTACHMENT|Sr.SAMPLED,fr.RGBA8,i,r))),t.upsampleFramebuffers[o]=e.createFramebuffer(new ko(t.renderPass,[t.upsampleTexs[o]])),i>>=1,r>>=1;t.combineTex=e.createTexture(new xo(xr.TEX2D,Sr.COLOR_ATTACHMENT|Sr.SAMPLED,fr.RGBA8,this._width,this._height)),t.combineFramebuffer=e.createFramebuffer(new ko(t.renderPass,[t.combineTex])),t.sampler=this.globalDSManager.linearSampler}},n.on=function(t,e,n,i){return this._eventProcessor.on(t,e,n,i)},n.once=function(t,e,n){return this._eventProcessor.once(t,e,n)},n.off=function(t,e,n){this._eventProcessor.off(t,e,n)},n.emit=function(t,e,n,i,r,o){this._eventProcessor.emit(t,e,n,i,r,o)},n.targetOff=function(t){this._eventProcessor.targetOff(t)},n.removeAll=function(t){this._eventProcessor.removeAll(t)},n.hasEventListener=function(t,e,n){return this._eventProcessor.hasEventListener(t,e,n)},N(e,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(t){this._profiler=t}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(t){this._clusterEnabled=t}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(t){this._bloomEnabled=t}}]),e}(Su),ox=X((rx=sx).prototype,"_tag",[tx,Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ax=X(rx.prototype,"_flows",[ex,nx,Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ix=rx))||ix));i.RenderPipeline=yx,function(t){t[t.BLOOM=18]="BLOOM",t[t.POST_PROCESS=19]="POST_PROCESS",t[t.UI=20]="UI"}(cx||(cx={})),function(t){t[t.FORWARD=10]="FORWARD"}(lx||(lx={})),function(t){t[t.SHADOW=0]="SHADOW",t[t.FORWARD=1]="FORWARD",t[t.UI=10]="UI"}(ux||(ux={})),function(t){t[t.GBUFFER=10]="GBUFFER",t[t.LIGHTING=15]="LIGHTING",t[t.TRANSPARENT=18]="TRANSPARENT"}(hx||(hx={})),function(t){t[t.SHADOW=0]="SHADOW",t[t.MAIN=1]="MAIN",t[t.UI=10]="UI"}(_x||(_x={}));var xx=new No;xx.format=fr.RGBA8,xx.beginAccesses=[Nr.FRAGMENT_SHADER_READ_TEXTURE],xx.endAccesses=[Nr.FRAGMENT_SHADER_READ_TEXTURE];var Sx=new Lo;Sx.format=fr.DEPTH_STENCIL;var Ax,Cx,bx,Tx,Ex,wx,Px,Ix,Rx,Dx,Bx,Mx,Ox,Nx,Lx,Fx,zx,Vx,Gx,Ux,kx,Hx,jx,Wx,qx,Xx,Yx,Kx,Jx,Qx,Zx,$x,tS,eS,nS,iS,rS,oS,aS,sS,cS,lS,uS,hS,_S,fS,pS,dS,mS,vS,gS,yS,xS,SS,AS,CS,bS,TS,ES,wS,PS,IS,RS,DS,BS,MS,OS,NS,LS,FS,zS,VS,GS,US,kS,HS,jS,WS,qS,XS=new Vo([xx],Sx),YS={width:1,height:1,renderPassInfo:XS},KS=t("RenderTexture",qc("cc.RenderTexture")(fx=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._window=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._name=t.name||"",this._width=t.width,this._height=t.height,this._initWindow(t)},n.reset=function(t){this.initialize(t)},n.destroy=function(){if(this._window){var e=i.director.root;null==e||e.destroyWindow(this._window),this._window=null}return t.prototype.destroy.call(this)},n.resize=function(t,e){this._width=Math.floor(Un(t,1,2048)),this._height=Math.floor(Un(e,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},n._serialize=function(){return{}},n._deserialize=function(e,n){var i=e;this._width=i.w,this._height=i.h,this._name=i.n,t.prototype._deserialize.call(this,i.base,n)},n.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},n.onLoaded=function(){this._initWindow()},n._initWindow=function(t){var e=i.director.root;YS.title=this._name,YS.width=this._width,YS.height=this._height,YS.renderPassInfo=t&&t.passInfo?t.passInfo:XS,this._window?(this._window.destroy(),this._window.initialize(e.device,YS)):this._window=e.createWindow(YS)},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this._width=this._height=1,this._initWindow()},n.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},n.readPixels=function(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),n=n||this.width,i=i||this.height;var o=this.getGFXTexture();if(!o)return E(7606),null;var a=4*n*i;if(void 0===r)r=new Uint8Array(a);else if(r.length<a)return E(7607,a),null;var s=this._getGFXDevice(),c=[],l=[],u=new co;return u.texOffset.x=t,u.texOffset.y=e,u.texExtent.width=n,u.texExtent.height=i,l.push(u),c.push(r),null==s||s.copyTextureToBuffers(o,c,l),r},N(e,[{key:"window",get:function(){return this._window}}]),e}(Sm))||fx);i.RenderTexture=KS,$t(xr),$t(Sr),$t(Or),$t(Mr),$t(Nr),function(t){t[t.SCENE=0]="SCENE",t[t.POSTPROCESS=1]="POSTPROCESS",t[t.UI=2]="UI"}(qS||(qS={})),$t(qS),Ax=qc("RenderTextureDesc"),Cx=El(xr),bx=El(Sr),Tx=El(fr),Ax((wx=X((Ex=function(){q(this,"name",wx,this),q(this,"type",Px,this),q(this,"usage",Ix,this),q(this,"format",Rx,this),q(this,"width",Dx,this),q(this,"height",Bx,this)}).prototype,"name",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Px=X(Ex.prototype,"type",[Cx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xr.TEX2D}}),Ix=X(Ex.prototype,"usage",[bx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sr.COLOR_ATTACHMENT}}),Rx=X(Ex.prototype,"format",[Tx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fr.UNKNOWN}}),Dx=X(Ex.prototype,"width",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Bx=X(Ex.prototype,"height",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Ex));var JS,QS=(Mx=qc("RenderTextureConfig"),Ox=El(KS),Mx((Fx=X((Lx=function(){q(this,"name",Fx,this),q(this,"texture",zx,this)}).prototype,"name",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),zx=X(Lx.prototype,"texture",[Ox],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nx=Lx))||Nx),ZS=(Vx=qc("MaterialConfig"),Gx=El(hg),Vx((kx=X((Ux=function(){q(this,"name",kx,this),q(this,"material",Hx,this)}).prototype,"name",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Hx=X(Ux.prototype,"material",[Gx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ux)),jx=qc("FrameBufferDesc"),Wx=El([Ee]),qx=El(KS),jx((Yx=X((Xx=function(){q(this,"name",Yx,this),q(this,"renderPass",Kx,this),q(this,"colorTextures",Jx,this),q(this,"depthStencilTexture",Qx,this),q(this,"texture",Zx,this)}).prototype,"name",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Kx=X(Xx.prototype,"renderPass",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jx=X(Xx.prototype,"colorTextures",[Wx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qx=X(Xx.prototype,"depthStencilTexture",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Zx=X(Xx.prototype,"texture",[qx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xx)),$x=qc("ColorDesc"),tS=El(fr),eS=El(Mr),nS=El(Or),iS=El([Nr]),rS=El([Nr]),$x((sS=X((aS=function(){q(this,"format",sS,this),q(this,"loadOp",cS,this),q(this,"storeOp",lS,this),q(this,"sampleCount",uS,this),q(this,"beginAccesses",hS,this),q(this,"endAccesses",_S,this)}).prototype,"format",[tS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fr.UNKNOWN}}),cS=X(aS.prototype,"loadOp",[eS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mr.CLEAR}}),lS=X(aS.prototype,"storeOp",[nS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Or.STORE}}),uS=X(aS.prototype,"sampleCount",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),hS=X(aS.prototype,"beginAccesses",[iS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_S=X(aS.prototype,"endAccesses",[rS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Nr.COLOR_ATTACHMENT_WRITE]}}),oS=aS))||oS),$S=(fS=qc("DepthStencilDesc"),pS=El(fr),dS=El(Mr),mS=El(Or),vS=El(Mr),gS=El(Or),yS=El([Nr]),xS=El([Nr]),fS((CS=X((AS=function(){q(this,"format",CS,this),q(this,"depthLoadOp",bS,this),q(this,"depthStoreOp",TS,this),q(this,"stencilLoadOp",ES,this),q(this,"stencilStoreOp",wS,this),q(this,"sampleCount",PS,this),q(this,"beginAccesses",IS,this),q(this,"endAccesses",RS,this)}).prototype,"format",[pS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fr.UNKNOWN}}),bS=X(AS.prototype,"depthLoadOp",[dS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mr.CLEAR}}),TS=X(AS.prototype,"depthStoreOp",[mS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Or.STORE}}),ES=X(AS.prototype,"stencilLoadOp",[vS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mr.CLEAR}}),wS=X(AS.prototype,"stencilStoreOp",[gS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Or.STORE}}),PS=X(AS.prototype,"sampleCount",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),IS=X(AS.prototype,"beginAccesses",[yS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),RS=X(AS.prototype,"endAccesses",[xS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Nr.DEPTH_STENCIL_ATTACHMENT_WRITE]}}),SS=AS))||SS);DS=qc("RenderPassDesc"),BS=El([ZS]),MS=El($S),DS((NS=X((OS=function(){q(this,"index",NS,this),q(this,"colorAttachments",LS,this),q(this,"depthStencilAttachment",FS,this)}).prototype,"index",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),LS=X(OS.prototype,"colorAttachments",[BS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),FS=X(OS.prototype,"depthStencilAttachment",[MS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $S}}),OS)),function(t){t[t.FRONT_TO_BACK=0]="FRONT_TO_BACK",t[t.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(JS||(JS={})),$t(JS);var tA=(zS=qc("RenderQueueDesc"),VS=El(JS),GS=El([Ee]),zS((HS=X((kS=function(){q(this,"isTransparent",HS,this),q(this,"sortMode",jS,this),q(this,"stages",WS,this)}).prototype,"isTransparent",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jS=X(kS.prototype,"sortMode",[VS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return JS.FRONT_TO_BACK}}),WS=X(kS.prototype,"stages",[GS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),US=kS))||US);function eA(t,e){return t.hash-e.hash||t.depth-e.depth||t.shaderId-e.shaderId}function nA(t,e){return t.hash-e.hash||e.depth-t.depth||t.shaderId-e.shaderId}var iA=function(){function t(t){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=t,this._passPool=new qt((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new Xt(64,this._passDesc.sortFunc)}var e=t.prototype;return e.clear=function(){this.queue.clear(),this._passPool.reset()},e.insertRenderPass=function(t,e,n){var i=t.model.subModels[e],r=i.passes[n],o=i.shaders[n];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var a=0|r.priority<<16|i.priority<<8|n,s=this._passPool.add();return s.hash=a,s.depth=t.depth||0,s.shaderId=o.typedID,s.subModel=i,s.passIdx=n,this.queue.push(s),!0},e.sort=function(){this.queue.sort()},e.recordCommandBuffer=function(t,e,n){for(var i=0;i<this.queue.length;++i){var r=this.queue.array[i],o=r.subModel,a=r.passIdx,s=o.inputAssembler,c=o.passes[a],l=o.shaders[a],u=Yv.getOrCreatePipelineState(t,c,l,e,s);n.bindPipelineState(u),n.bindDescriptorSet(Tp.MATERIAL,c.descriptorSet),n.bindDescriptorSet(Tp.LOCAL,o.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},t}();function rA(t){for(var e=0,n=0;n<t.stages.length;n++)e|=bv(t.stages[n]);var i=eA;switch(t.sortMode){case JS.BACK_TO_FRONT:i=nA;break;case JS.FRONT_TO_BACK:i=eA}return new iA({isTransparent:t.isTransparent,phases:e,sortFunc:i})}function oA(t){t.clear()}function aA(t){t.sort()}var sA=function(){function t(){this.queue=new Set}var e=t.prototype;return e.clear=function(){for(var t=this.queue.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this.queue.clear()},e.uploadBuffers=function(t){for(var e=this.queue.values(),n=e.next();!n.done;){for(var i=0;i<n.value.batches.length;++i){var r=n.value.batches[i];if(r.mergeCount){for(var o=0;o<r.vbs.length;++o)r.vbs[o].update(r.vbDatas[o]);t.updateBuffer(r.vbIdx,r.vbIdxData.buffer),t.updateBuffer(r.ubo,r.uboData)}}n=e.next()}},e.recordCommandBuffer=function(t,e,n){for(var i=this.queue.values(),r=i.next();!r.done;){for(var o=!1,a=0;a<r.value.batches.length;++a){var s=r.value.batches[a];if(s.mergeCount){if(!o){var c=s.shader,l=Yv.getOrCreatePipelineState(t,s.pass,c,e,s.ia);n.bindPipelineState(l),n.bindDescriptorSet(Tp.MATERIAL,s.pass.descriptorSet),o=!0}n.bindDescriptorSet(Tp.LOCAL,s.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(s.ia),n.draw(s.ia)}}r=i.next()}},t}(),cA=function(){function t(){this.queue=new Set}var e=t.prototype;return e.clear=function(){for(var t=this.queue.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this.queue.clear()},e.uploadBuffers=function(t){for(var e=this.queue.values(),n=e.next();!n.done;)n.value.hasPendingModels&&n.value.uploadBuffers(t),n=e.next()},e.recordCommandBuffer=function(t,e,n){for(var i=this.queue.values(),r=i.next();!r.done;){var o=r.value,a=o.instances,s=o.pass;if(o.hasPendingModels){n.bindDescriptorSet(Tp.MATERIAL,s.descriptorSet);for(var c=null,l=0;l<a.length;++l){var u=a[l];if(u.count){var h=u.shader,_=Yv.getOrCreatePipelineState(t,s,h,e,u.ia);c!==_&&(n.bindPipelineState(_),c=_),n.bindDescriptorSet(Tp.LOCAL,u.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(u.ia),n.draw(u.ia)}}}r=i.next()}},t}(),lA=new Wt((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),uA=new Float32Array(4),hA=[],_A=[],fA=new Ei,pA=new Ei;function dA(t,e){return!(!e.worldBounds||ks.aabbWithAABB(e.worldBounds,t.aabb))}function mA(t,e){return!(!e.worldBounds||ks.aabbWithAABB(e.worldBounds,t.aabb)&&ks.aabbFrustum(e.worldBounds,t.frustum))}var vA=bv("forward-add"),gA=[];function yA(t,e){e.length=0;for(var n=!1,i=0;i<t.length;i++){for(var r=t[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===vA){o=a,n=!0;break}e.push(o)}return n}var xA,SA,AA,CA,bA,TA,EA,wA,PA,IA,RA,DA=function(){function t(t){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._shadowUBO=new Float32Array(Dp.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=t,this._device=t.device,this._instancedQueue=new cA,this._batchedQueue=new sA;var e=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(Yp.SIZE/e)*e,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new po(mr.UNIFORM|mr.TRANSFER_DST,yr.HOST|yr.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new mo(this._lightBuffer,0,Yp.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var e=t.prototype;return e.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var t=0;t<this._lightPasses.length;t++){var e=this._lightPasses[t];e.dynamicOffsets.length=0,e.lights.length=0}lA.freeArray(this._lightPasses),this._lightPasses.length=0},e.destroy=function(){for(var t=this._pipeline.globalDSManager.descriptorSetMap,e=t.keys,n=0;n<e.length;n++){var i=e[n],r=t.get(i);r&&(r.getBuffer(Dp.BINDING).destroy(),r.getTexture(Bp).destroy(),r.getTexture(Up).destroy(),r.destroy()),t.delete(i)}},e.gatherLightPasses=function(t,e){this.clear();var n=this._pipeline.pipelineSceneData.validPunctualLights;if(n.length){this._updateUBOs(t,e),this._updateLightDescriptorSet(t,e);for(var i=this._pipeline.pipelineSceneData.renderObjects,r=0;r<i.length;r++){var o=i[r].model,a=o.subModels;if(yA(a,gA)&&(_A.length=0,this._lightCulling(o,n),_A.length))for(var s=0;s<a.length;s++){var c=gA[s];if(!(c<0)){var l=a[s],u=l.passes[c];l.passes[0].blendState.targets[0].blend||(l.descriptorSet.bindBuffer(Yp.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(u,l,o,c))}}}this._instancedQueue.uploadBuffers(e),this._batchedQueue.uploadBuffers(e)}},e.recordCommandBuffer=function(t,e,n){this._instancedQueue.recordCommandBuffer(t,e,n),this._batchedQueue.recordCommandBuffer(t,e,n);for(var i=this._pipeline.globalDSManager,r=0;r<this._lightPasses.length;r++){var o=this._lightPasses[r],a=o.subModel,s=o.passIdx,c=o.dynamicOffsets,l=o.lights,u=a.passes[s],h=a.shaders[s],_=a.inputAssembler,f=Yv.getOrCreatePipelineState(t,u,h,e,_),p=u.descriptorSet,d=a.descriptorSet;n.bindPipelineState(f),n.bindDescriptorSet(Tp.MATERIAL,p),n.bindInputAssembler(_);for(var m=0;m<c.length;++m){var v=l[m],g=i.getOrCreateDescriptorSet(v);hA[0]=c[m],n.bindDescriptorSet(Tp.GLOBAL,g),n.bindDescriptorSet(Tp.LOCAL,d,hA),n.draw(_)}}},e._lightCulling=function(t,e){for(var n=0;n<e.length;n++){var i=e[n],r=!1;switch(i.type){case Ld.SPHERE:r=dA(i,t);break;case Ld.SPOT:r=mA(i,t)}r||_A.push(n)}},e._addRenderQueue=function(t,e,n,i){var r=t.batchingScheme;if(r===xv.INSTANCING)for(var o=0;o<_A.length;o++){var a=_A[o],s=t.getInstancedBuffer(a);s.merge(e,n.instancedAttributes,i),s.dynamicOffsets[0]=this._lightBufferStride*a,this._instancedQueue.queue.add(s)}else if(r===xv.VB_MERGING)for(var c=0;c<_A.length;c++){var l=_A[c],u=t.getBatchedBuffer(l);u.merge(e,i,n),u.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(u)}else{var h=lA.alloc();h.subModel=e,h.passIdx=i;for(var _=0;_<_A.length;_++){var f=_A[_];h.lights.push(f),h.dynamicOffsets.push(this._lightBufferStride*f)}this._lightPasses.push(h)}},e._updateLightDescriptorSet=function(t,e){for(var n=this._pipeline.device,i=this._pipeline.pipelineSceneData,r=i.shadows,o=i.shadowFrameBufferMap,a=t.scene.mainLight,s=Md(n)?0:1,c=this._pipeline.globalDSManager,l=i.validPunctualLights,u=0;u<l.length;u++){var h=l[u],_=c.getOrCreateDescriptorSet(u);if(_){var f=void 0,p=void 0;switch(h.type){case Ld.SPHERE:a&&(py(r,a,this._shadowUBO),dy(r,this._shadowUBO)),this._shadowUBO[Dp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Dp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Dp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[Dp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[Dp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[Dp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Dp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[Dp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,Li.toArray(this._shadowUBO,r.shadowColor,Dp.SHADOW_COLOR_OFFSET);break;case Ld.SPOT:if(a&&(py(r,a,this._shadowUBO),dy(r,this._shadowUBO)),Ei.invert(fA,h.node.getWorldMatrix()),Ei.perspective(pA,h.angle,h.aspect,.001,h.range),f=pA.clone(),p=pA.clone().invert(),Ei.multiply(pA,pA,fA),Ei.toArray(this._shadowUBO,fA,Dp.MAT_LIGHT_VIEW_OFFSET),Ei.toArray(this._shadowUBO,pA,Dp.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[Dp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[Dp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h.range,this._shadowUBO[Dp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[Dp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-r.saturation,this._shadowUBO[Dp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Dp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Dp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[Dp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[Dp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[Dp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Dp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[Dp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[Dp.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,this._shadowUBO[Dp.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,this._shadowUBO[Dp.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,this._shadowUBO[Dp.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,this._shadowUBO[Dp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=p.m10,this._shadowUBO[Dp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=p.m14,this._shadowUBO[Dp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=p.m11,this._shadowUBO[Dp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=p.m15,this._shadowUBO[Dp.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,this._shadowUBO[Dp.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,this._shadowUBO[Dp.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,this._shadowUBO[Dp.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,Li.toArray(this._shadowUBO,r.shadowColor,Dp.SHADOW_COLOR_OFFSET),o.has(h)){var d,m=null===(d=o.get(h))||void 0===d?void 0:d.colorTextures[0];m&&_.bindTexture(Up,m)}}_.update(),e.updateBuffer(_.getBuffer(Dp.BINDING),this._shadowUBO)}}},e._updateUBOs=function(t,e){var n=t.exposure,i=this._pipeline.pipelineSceneData,r=i.isHDR,o=i.shadows,a=i.validPunctualLights;a.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=Zn(a.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new mo(this._lightBuffer,0,Yp.SIZE)));for(var s=0,c=0;s<a.length;s++,c+=this._lightBufferElementCount){var l=a[s];switch(l.type){case Ld.SPHERE:if(oi.toArray(uA,l.position),uA[3]=0,this._lightBufferData.set(uA,c+Yp.LIGHT_POS_OFFSET),uA[0]=l.size,uA[1]=l.range,uA[2]=0,uA[3]=o.enabled&&o.type===fg.ShadowMap?1:0,this._lightBufferData.set(uA,c+Yp.LIGHT_SIZE_RANGE_ANGLE_OFFSET),oi.toArray(uA,l.color),l.useColorTemperature){var u=l.colorTemperatureRGB;uA[0]*=u.x,uA[1]*=u.y,uA[2]*=u.z}uA[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(uA,c+Yp.LIGHT_COLOR_OFFSET);break;case Ld.SPOT:if(oi.toArray(uA,l.position),uA[3]=1,this._lightBufferData.set(uA,c+Yp.LIGHT_POS_OFFSET),uA[0]=l.size,uA[1]=l.range,uA[2]=l.spotAngle,uA[3]=o.enabled&&o.type===fg.ShadowMap?1:0,this._lightBufferData.set(uA,c+Yp.LIGHT_SIZE_RANGE_ANGLE_OFFSET),oi.toArray(uA,l.direction),this._lightBufferData.set(uA,c+Yp.LIGHT_DIR_OFFSET),oi.toArray(uA,l.color),l.useColorTemperature){var h=l.colorTemperatureRGB;uA[0]*=h.x,uA[1]*=h.y,uA[2]*=h.z}uA[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(uA,c+Yp.LIGHT_COLOR_OFFSET)}}e.updateBuffer(this._lightBuffer,this._lightBufferData)},t}(),BA=new Cc,MA=function(){function t(t){this._pendingModels=[],this._castModels=[],this._instancedQueue=new cA,this._pipeline=void 0,this._pipeline=t}var e=t.prototype;return e.gatherShadowPasses=function(t,e){var n=this._pipeline.pipelineSceneData,i=(this._pipeline.pipelineUBO,n.shadows);if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,i.enabled&&i.type===fg.Planar&&!(i.normal.length()<1e-6)){var r=t.scene,o=t.frustum,a=0!=(t.visibility&fp.BitMask.DEFAULT);if(r.mainLight&&a){for(var s=r.models,c=0;c<s.length;c++){var l=s[c];l.enabled&&l.node&&l.castShadow&&this._castModels.push(l)}var u=i.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(u);for(var h=0;h<this._castModels.length;h++){var _=this._castModels[h];if(!_.worldBounds||(Cc.transform(BA,_.worldBounds,i.matLight),ks.aabbFrustum(BA,o)))if(_.isInstancingEnabled)for(var f=_.subModels,p=0;p<f.length;p++){var d=f[p];u.merge(d,_.instancedAttributes,0,d.planarInstanceShader)}else this._pendingModels.push(_)}this._instancedQueue.uploadBuffers(e)}}},e.recordCommandBuffer=function(t,e,n){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===fg.Planar&&(this._instancedQueue.recordCommandBuffer(t,e,n),this._pendingModels.length)){var r=i.material.passes[0],o=r.descriptorSet;n.bindDescriptorSet(Tp.MATERIAL,o);for(var a=this._pendingModels.length,s=0;s<a;s++)for(var c=this._pendingModels[s],l=0;l<c.subModels.length;l++){var u=c.subModels[l],h=u.planarShader,_=u.inputAssembler,f=Yv.getOrCreatePipelineState(t,r,h,e,_);n.bindPipelineState(f),n.bindDescriptorSet(Tp.LOCAL,u.descriptorSet),n.bindInputAssembler(_),n.draw(_)}}},t}(),OA=function(){function t(){this._phaseID=bv("default")}var e=t.prototype;return e.activate=function(t){this._pipeline=t},e.render=function(t,e){for(var n=this._pipeline,i=n.device,r=n.commandBuffers[0],o=t.scene.batches,a=0;a<o.length;a++){var s=o[a],c=!1;if(t.visibility&s.visFlags&&(c=!0),c)for(var l=s.shaders.length,u=0;u<l;u++){var h=s.passes[u];if(h.phase===this._phaseID){var _=s.shaders[u],f=s.inputAssembler,p=Yv.getOrCreatePipelineState(i,h,_,e,f);r.bindPipelineState(p),r.bindDescriptorSet(Tp.MATERIAL,h.descriptorSet);var d=s.descriptorSet;r.bindDescriptorSet(Tp.LOCAL,d),r.bindInputAssembler(f),r.draw(f)}}}},t}(),NA=[new uo(0,0,0,1)],LA=t("ForwardStage",(xA=qc("ForwardStage"),SA=El([tA]),AA=yl(),xA((wA=EA=function(t){function e(){var e;return q(e=t.call(this)||this,"renderQueues",TA,H(e)),e._renderQueues=[],e._renderArea=new no,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=bv("default"),e._clearFlag=4294967295,e._batchedQueue=new sA,e._instancedQueue=new cA,e._uiPhase=new OA,e}F(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=rA(this.renderQueues[i]);this._additiveLightQueue=new DA(this._pipeline),this._planarQueue=new MA(this._pipeline),this._uiPhase.activate(e)},n.destroy=function(){},n.render=function(t){this._instancedQueue.clear(),this._batchedQueue.clear();var e=this._pipeline,n=e.device;this._renderQueues.forEach(oA);for(var i=e.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===xv.INSTANCING){var p=_.getInstancedBuffer();p.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(p)}else if(f===xv.VB_MERGING){var d=_.getBatchedBuffer();d.merge(u,o,c.model),this._batchedQueue.queue.add(d)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(aA);var m=e.commandBuffers[0];e.pipelineUBO.updateShadowUBO(t),this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(t,m),this._planarQueue.gatherShadowPasses(t,m),t.clearFlag&Yr.COLOR&&(NA[0].x=t.clearColor.x,NA[0].y=t.clearColor.y,NA[0].z=t.clearColor.z,NA[0].w=t.clearColor.w),e.generateRenderArea(t,this._renderArea);var v=t.window.framebuffer,g=e.getRenderPass(t.clearFlag&this._clearFlag,v);m.beginRenderPass(g,v,this._renderArea,NA,t.clearDepth,t.clearStencil),m.bindDescriptorSet(Tp.GLOBAL,e.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,g,m),this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),this._additiveLightQueue.recordCommandBuffer(n,g,m),m.bindDescriptorSet(Tp.GLOBAL,e.descriptorSet),this._planarQueue.recordCommandBuffer(n,g,m),this._renderQueues[1].recordCommandBuffer(n,g,m),this._uiPhase.render(t,g),lg(n,g,m,e.profiler,t),m.endRenderPass()},e}(Jy),EA.initInfo={name:"ForwardStage",priority:lx.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:JS.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:JS.BACK_TO_FRONT,stages:["default","planarShadow"]}]},TA=X((bA=wA).prototype,"renderQueues",[SA,Zc,AA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CA=bA))||CA)),FA=t("ForwardFlow",qc("ForwardFlow")((RA=IA=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var n=new LA;n.initialize(LA.initInfo),this._stages.push(n)}return!0},n.activate=function(e){t.prototype.activate.call(this,e)},n.render=function(e){t.prototype.render.call(this,e)},n.destroy=function(){t.prototype.destroy.call(this)},e}(Zy),IA.initInfo={name:vp,priority:ux.FORWARD,stages:[]},PA=RA))||PA),zA=new Ei,VA=new Ei,GA=new Ei,UA=new Cc,kA=bv("shadow-caster"),HA=[];function jA(t,e){e.length=0;for(var n=!1,i=0;i<t.length;i++){for(var r=t[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===kA){o=a,n=!0;break}e.push(o)}return n}var WA,qA,XA,YA,KA,JA,QA=function(){function t(t){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=t,this._instancedQueue=new cA,this._batchedQueue=new sA}var e=t.prototype;return e.gatherLightPasses=function(t,e,n,i){this.clear();var r=this._pipeline.pipelineSceneData,o=r.shadows;if(n&&o.enabled&&o.type===fg.ShadowMap){var a=r.dirShadowObjects,s=r.castShadowObjects;switch(n.type){case Ld.DIRECTIONAL:for(var c=0;c<a.length;c++){var l=a[c].model;jA(l.subModels,HA)&&this.add(l,HA)}break;case Ld.SPOT:Ei.invert(zA,n.node.getWorldMatrix()),Ei.perspective(VA,n.angle,n.aspect,.001,n.range),Ei.multiply(GA,VA,zA);for(var u=0;u<s.length;u++){var h=s[u].model;jA(h.subModels,HA)&&(h.worldBounds&&(Cc.transform(UA,h.worldBounds,GA),!ks.aabbFrustum(UA,e.frustum))||this.add(h,HA))}}this._instancedQueue.uploadBuffers(i),this._batchedQueue.uploadBuffers(i)}},e.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},e.add=function(t,e){for(var n=t.subModels,i=0;i<n.length;i++){var r=n[i],o=e[i],a=r.passes[o];if(a.batchingScheme===xv.INSTANCING){var s=a.getInstancedBuffer();s.merge(r,t.instancedAttributes,o),this._instancedQueue.queue.add(s)}else if(a.batchingScheme===xv.VB_MERGING){var c=a.getBatchedBuffer();c.merge(r,o,t),this._batchedQueue.queue.add(c)}else{var l=r.shaders[o];this._subModelsArray.push(r),l&&this._shaderArray.push(l),this._passArray.push(a)}}},e.recordCommandBuffer=function(t,e,n){this._instancedQueue.recordCommandBuffer(t,e,n),this._batchedQueue.recordCommandBuffer(t,e,n);for(var i=0;i<this._subModelsArray.length;++i){var r=this._subModelsArray[i],o=this._shaderArray[i],a=this._passArray[i],s=r.inputAssembler,c=Yv.getOrCreatePipelineState(t,a,o,e,s),l=a.descriptorSet;n.bindPipelineState(c),n.bindDescriptorSet(Tp.MATERIAL,l),n.bindDescriptorSet(Tp.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},t}(),ZA=[new uo(1,1,1,1)],$A=t("ShadowStage",qc("ShadowStage")((XA=qA=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._shadowFrameBuffer=null,e._renderArea=new no,e._light=null,e._globalDS=null,e}F(e,t);var n=e.prototype;return n.setUsage=function(t,e,n){this._globalDS=t,this._light=e,this._shadowFrameBuffer=n},n.destroy=function(){var t;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(t=this._additiveShadowQueue)||void 0===t||t.clear()},n.clearFramebuffer=function(t){if(this._light&&this._shadowFrameBuffer){ZA[0].w=t.clearColor.w;var e=this._pipeline.commandBuffers[0],n=this._shadowFrameBuffer.renderPass;e.beginRenderPass(n,this._shadowFrameBuffer,this._renderArea,ZA,t.clearDepth,t.clearStencil),e.endRenderPass()}},n.render=function(t){var e=this._pipeline,n=e.pipelineSceneData,i=n.shadows,r=n.shadingScale,o=this._globalDS,a=e.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(o,this._light),this._additiveShadowQueue.gatherLightPasses(o,t,this._light,a);var s=t.viewport,c=i.size;this._renderArea.x=s.x*c.x,this._renderArea.y=s.y*c.y,this._renderArea.width=s.width*c.x*r,this._renderArea.height=s.height*c.y*r;var l=e.device,u=this._shadowFrameBuffer.renderPass;a.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,ZA,t.clearDepth,t.clearStencil),a.bindDescriptorSet(Tp.GLOBAL,o),this._additiveShadowQueue.recordCommandBuffer(l,u,a),a.endRenderPass()}},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._additiveShadowQueue=new QA(e)},e}(Jy),qA.initInfo={name:"ShadowStage",priority:lx.FORWARD,tag:0},WA=XA))||WA),tC=[],eC=t("ShadowFlow",qc("ShadowFlow")((JA=KA=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._shadowRenderPass=null,e}F(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var n=new $A;n.initialize($A.initInfo),this._stages.push(n)}return!0},n.render=function(t){var e=this._pipeline,n=e.pipelineSceneData.shadows,i=e.pipelineSceneData.shadowFrameBufferMap,r=e.pipelineSceneData.castShadowObjects,o=this._pipeline.pipelineSceneData.validPunctualLights;if(n.enabled&&n.type===fg.ShadowMap){for(var a=0,s=0;a<n.maxReceived&&s<o.length;){var c=o[s];c.type===Ld.SPOT&&(tC.push(c),a++),s++}if(0!==r.length){n.shadowMapDirty&&this.resizeShadowMap();var l=t.scene.mainLight;if(l){var u=e.descriptorSet;i.has(l)||this._initShadowFrameBuffer(e,l,t.window.swapchain);for(var h=i.get(l),_=0;_<this._stages.length;_++){var f=this._stages[_];f.setUsage(u,l,h),f.render(t)}}for(var p=0;p<tC.length;p++){var d=tC[p],m=e.globalDSManager.getOrCreateDescriptorSet(p);i.has(d)||this._initShadowFrameBuffer(e,d,t.window.swapchain);for(var v=i.get(d),g=0;g<this._stages.length;g++){var y=this._stages[g];y.setUsage(m,d,v),y.render(t)}}tC.length=0}else this.clearShadowMap(tC,t)}},n.destroy=function(){if(t.prototype.destroy.call(this),this._pipeline){for(var e=this._pipeline.pipelineSceneData.shadowFrameBufferMap,n=Array.from(e.values()),i=0;i<n.length;i++){var r=n[i];if(r){for(var o=r.colorTextures,a=0;a<o.length;a++){var s=o[i];s&&s.destroy()}o.length=0;var c=r.depthStencilTexture;c&&c.destroy(),r.destroy()}}e.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},n._initShadowFrameBuffer=function(t,e){var n=t.device,i=t.pipelineSceneData.shadows.size,r=t.pipelineSceneData.shadowFrameBufferMap,o=Md(n)?fr.R32F:fr.RGBA8;if(!this._shadowRenderPass){var a=new No;a.format=o,a.loadOp=Mr.CLEAR,a.storeOp=Or.STORE,a.sampleCount=1;var s=new Lo;s.format=fr.DEPTH_STENCIL,s.depthLoadOp=Mr.CLEAR,s.depthStoreOp=Or.DISCARD,s.stencilLoadOp=Mr.CLEAR,s.stencilStoreOp=Or.DISCARD,s.sampleCount=1;var c=new Vo([a],s);this._shadowRenderPass=n.createRenderPass(c)}var l=[];l.push(n.createTexture(new xo(xr.TEX2D,Sr.COLOR_ATTACHMENT|Sr.SAMPLED,o,i.x,i.y)));var u=n.createTexture(new xo(xr.TEX2D,Sr.DEPTH_STENCIL_ATTACHMENT,fr.DEPTH_STENCIL,i.x,i.y)),h=n.createFramebuffer(new ko(this._shadowRenderPass,l,u));r.set(e,h)},n.clearShadowMap=function(t,e){var n=this._pipeline,i=n.pipelineSceneData,r=e.scene.mainLight;if(r){var o=this._pipeline.descriptorSet;i.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,e.window.swapchain);for(var a=i.shadowFrameBufferMap.get(r),s=0;s<this._stages.length;s++){var c=this._stages[s];c.setUsage(o,r,a),c.render(e)}}for(var l=0;l<t.length;l++){var u=t[l],h=i.shadowFrameBufferMap.get(u),_=n.globalDSManager.getOrCreateDescriptorSet(l);if(i.shadowFrameBufferMap.has(u))for(var f=0;f<this._stages.length;f++){var p=this._stages[f];p.setUsage(_,u,h),p.clearFramebuffer(e)}}},n.resizeShadowMap=function(){for(var t=this._pipeline.pipelineSceneData.shadows,e=t.size,n=this._pipeline,i=n.device,r=n.pipelineSceneData.shadowFrameBufferMap,o=Md(i)?fr.R32F:fr.RGBA8,a=r.values(),s=a.next();!s.done;){var c=s.value;if(c){var l=[];l.push(n.device.createTexture(new xo(xr.TEX2D,Sr.COLOR_ATTACHMENT|Sr.SAMPLED,o,e.x,e.y)));var u=c.depthStencilTexture;u&&u.resize(e.x,e.y);var h=c.renderPass;c.destroy(),c.initialize(new ko(h,l,u)),s=a.next()}else s=a.next()}t.shadowMapDirty=!1},e}(Zy),KA.initInfo={name:gp,priority:ux.SHADOW,tag:qS.SCENE,stages:[]},YA=JA))||YA),nC=new fi,iC=Jt({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),rC=iC.LAYERED+1,oC=function(){function t(){this._fogColor=new Li("#C8C8C8"),this._colorArray=new fi(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2}var e=t.prototype;return e._setType=function(t){this._type=this.enabled?t:rC},e._setEnable=function(t){this._enabled=t},e._setAccurate=function(t){this._accurate=t},e.initialize=function(t){this.fogColor=t.fogColor,this._setEnable(t.enabled),this._setAccurate(t.accurate),this._setType(t.type),this.fogDensity=t.fogDensity,this.fogStart=t.fogStart,this.fogEnd=t.fogEnd,this.fogAtten=t.fogAtten,this.fogTop=t.fogTop,this.fogRange=t.fogRange},e.activate=function(){this._updatePipeline()},e._updatePipeline=function(){var t=i.director.root,e=this.enabled?this.type:rC,n=this.accurate?1:0,r=t.pipeline;r.macros.CC_USE_FOG===e&&r.macros.CC_USE_ACCURATE_FOG===n||(r.macros.CC_USE_FOG=e,r.macros.CC_USE_ACCURATE_FOG=n,t.onGlobalPipelineStateChanged())},e._destroy=function(){},e.destroy=function(){this._destroy()},N(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnable(t),t?this.activate():(this._type=rC,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(t){this._setAccurate(t),this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(t){this._fogColor.set(t),nC.set(t.x,t.y,t.z,t.w),Qv(this._colorArray,nC)}},{key:"type",get:function(){return this._type},set:function(t){this._setType(t),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(t){this._fogDensity=t}},{key:"fogStart",get:function(){return this._fogStart},set:function(t){this._fogStart=t}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(t){this._fogEnd=t}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(t){this._fogAtten=t}},{key:"fogTop",get:function(){return this._fogTop},set:function(t){this._fogTop=t}},{key:"fogRange",get:function(){return this._fogRange},set:function(t){this._fogRange=t}},{key:"colorArray",get:function(){return this._colorArray}},{key:"native",get:function(){return this._nativeObj}}]),t}();i.Fog=oC;var aC,sC,cC,lC,uC,hC=10,_C=0,fC=new Map;function pC(t,e){for(var n,i=W(e);!(n=i()).done;){var r=n.value;Array.isArray(r)?pC(t,r):t.push(r)}}function dC(t){var e=[];return pC(e,t),e.join("")}cC=function(t,e,n,i,r,o,a){var s=fC.get(o);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead. "+a,t+"."+e,n+"."+i),s.count++)},aC=t("replaceProperty",(function(t,e,n){null!=t&&n.forEach((function(n){var i=_C++;fC.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:hC});var r=null!=n.target?n.target:t,o=null!=n.newName?n.newName:n.name,a=null!=n.targetName?n.targetName:e,s=r===t,c=n.suggest?"("+n.suggest+")":"";if(null!=n.customFunction)t[n.name]=function(){var t;return cC(e,n.name,a,o,p,i,c),(t=n.customFunction).call.apply(t,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=n.customSetter||null!=n.customGetter){var l=null!=n.customSetter,u=null!=n.customGetter;l&&u?Object.defineProperty(t,n.name,{get:function(){return cC(e,n.name,a,o,p,i,c),n.customGetter.call(this)},set:function(t){cC(e,n.name,a,o,p,i,c),n.customSetter.call(this,t)},enumerable:!1}):l?Object.defineProperty(t,n.name,{set:function(t){cC(e,n.name,a,o,p,i,c),n.customSetter.call(this,t)},enumerable:!1}):u&&Object.defineProperty(t,n.name,{get:function(){return cC(e,n.name,a,o,p,i,c),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(t,n.name,{get:function(){return cC(e,n.name,a,o,p,i,c),s?this[o]:r[o]},set:function(t){cC(e,n.name,a,o,p,i,c),s?this[o]=t:r[o]=t},enumerable:!1})}))})),uC=function(t,e,n,i,r){var o=fC.get(i);o&&o.logTimes>o.count&&(n("'%s' has been removed. "+r,t+"."+e),o.count++)},sC=t("removeProperty",(function(t,e,n){null!=t&&n.forEach((function(n){var i=_C++;fC.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:hC});var r=n.suggest?"("+n.suggest+")":"";Object.defineProperty(t,n.name,{get:function(){return uC(e,n.name,d,i,r)},set:function(){uC(e,n.name,d,i,r)},enumerable:!1})}))})),lC=function(t,e,n,i,r){var o=fC.get(i);o&&o.logTimes>o.count&&(n("'%s' is deprecated. "+r,t+"."+e),o.count++)},t("markAsWarning",(function(t,e,n){null!=t&&n.forEach((function(n){var i=n.name,r=Object.getOwnPropertyDescriptor(t,i);if(r&&r.configurable){var o=_C++;fC.set(o,{id:o,count:0,logTimes:void 0!==n.logTimes?n.logTimes:hC});var a=n.suggest?"("+n.suggest+")":"";if(void 0!==r.value)if("function"==typeof r.value){var s=r.value;t[i]=function(){return lC(e,i,p,o,a),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else{var c=r.value;Object.defineProperty(t,i,{configurable:!0,get:function(){return lC(e,i,p,o,a),c}}),r.writable&&Object.defineProperty(t,i,{set:function(t){lC(e,i,p,o,a),c=t}})}else!function(e,n,i,r,o,a){if(e.get){var s=e.get;e.get=function(){return lC(n,i,r,o,a),s.call(this)}}if(e.set){var c=e.set;e.set=function(t){lC(n,i,r,o,a),c.call(this,t)}}Object.defineProperty(t,i,e)}(r,e,i,p,o,a);Object.defineProperty(t,i,{enumerable:!1})}}))}));var mC=Je.Flags.Destroyed,vC=Je.Flags.PersistentMask,gC=He.IDENTIFIER_RE,yC="var ",xC="o",SC={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},AC=He.escapeForJS,CC=function(){function t(t,e){this.varName=void 0,this.expression=void 0,this.varName=t,this.expression=e}return t.prototype.toString=function(){return yC+this.varName+"="+this.expression+";"},t}();function bC(t,e){return e instanceof CC?new CC(e.varName,t+e.expression):t+e}function TC(t,e,n){Array.isArray(n)?(n[0]=bC(e,n[0]),t.push(n)):t.push(bC(e,n)+";")}var EC=function(){function t(t){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=t}var e=t.prototype;return e.append=function(t,e){this._exps.push([t,e])},e.writeCode=function(t){var e;if(this._exps.length>1)t.push("t="+this._targetExp+";"),e="t";else{if(1!==this._exps.length)return;e=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];TC(t,e+wC(i[0])+"=",i[1])}},t}();function wC(t){return gC.test(t)?"."+t:"["+AC(t)+"]"}EC.pool=void 0,EC.pool=new Gt((function(t){t._exps.length=0,t._targetExp=null}),1),EC.pool.get=function(t){var e=this._get()||new EC;return e._targetExp=t,e};var PC=function(){function t(t,e){var n;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=e,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=ft(),bt(this.funcModuleCache,SC),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(t.constructor,!0)+"();","}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(n=yC+this.globalVariables.join(",")+";");var i=dC(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",i)(this.objs,this.funcs);for(var r=0,o=this.objsToClear_iN$t.length;r<o;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}var e=t.prototype;return e.getFuncModule=function(t,e){var n=pt(t);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var r=-1!==n.indexOf(".");if(r)try{if(r=t===Function("return "+n)())return this.funcModuleCache[n]=n,n}catch(t){}}}var o=this.funcs.indexOf(t);o<0&&(o=this.funcs.length,this.funcs.push(t));var a="F["+o+"]";return e&&(a="("+a+")"),this.funcModuleCache[n]=a,a},e.getObjRef=function(t){var e=this.objs.indexOf(t);return e<0&&(e=this.objs.length,this.objs.push(t)),"O["+e+"]"},e.setValueType=function(t,e,n,i){var r=EC.pool.get(i),o=e.constructor.__props__;o||(o=Object.keys(e));for(var a=0;a<o.length;a++){var s=o[a],c=n[s];if(e[s]!==c){var l=this.enumerateField(n,s,c);r.append(s,l)}}r.writeCode(t),EC.pool.put(r)},e.enumerateCCClass=function(t,e,n){for(var r=n.__values__,o=xe(n),a=0;a<r.length;a++){var s=r[a],c=e[s],l=o[s+"$_$default"];if(!IC(l,c))if("object"==typeof c&&c instanceof i.ValueType&&(l=He.getDefault(l))&&l.constructor===c.constructor){var u=xC+wC(s);this.setValueType(t,l,c,u)}else this.setObjProp(t,e,s,c)}},e.instantiateArray=function(t){if(0===t.length)return"[]";var e="a"+ ++this.localVariableId,n=[new CC(e,"new Array("+t.length+")")];t._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(t);for(var i=0;i<t.length;++i)TC(n,e+"["+i+"]=",this.enumerateField(t,i,t[i]));return n},e.instantiateTypedArray=function(t){var e=t.constructor.name;if(0===t.length)return"new "+e;var n="a"+ ++this.localVariableId,i=[new CC(n,"new "+e+"("+t.length+")")];t._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(t);for(var r=0;r<t.length;++r)0!==t[r]&&TC(i,n+"["+r+"]=",t[r]);return i},e.enumerateField=function(t,e,n){if("object"==typeof n&&n){var i=n._iN$t;if(i){var r=i.globalVar;if(!r){r=i.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var o=i.source[0];i.source[0]=bC(r+"=",o)}return r}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?AC(n):("_objFlags"===e&&t instanceof Je&&(n&=vC),n)},e.setObjProp=function(t,e,n,i){TC(t,xC+wC(n)+"=",this.enumerateField(e,n,i))},e.enumerateObject=function(t,e){var n=e.constructor;if(i.Class._isCCClass(n))this.enumerateCCClass(t,e,n);else for(var r in e)if(e.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var o=e[r];"object"==typeof o&&o&&o===e._iN$t||this.setObjProp(t,e,r,o)}},e.instantiateObj=function(t){if(t instanceof i.ValueType)return He.getNewValueTypeCode(t);if(t instanceof i.Asset)return this.getObjRef(t);if(t._objFlags&mC)return null;var e,n=t.constructor;if(i.Class._isCCClass(n)){if(this.parent)if(this.parent instanceof i.Component){if(t instanceof i._BaseNode||t instanceof i.Component)return this.getObjRef(t)}else if(this.parent instanceof i._BaseNode)if(t instanceof i._BaseNode){if(!t.isChildOf(this.parent))return this.getObjRef(t)}else if(t instanceof i.Component&&!t.node.isChildOf(this.parent))return this.getObjRef(t);e=new CC(xC,"new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)e=new CC(xC,"{}");else{if(n)return this.getObjRef(t);e=new CC(xC,"Object.create(null)")}var r=[e];return t._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(t),this.enumerateObject(r,t),["(function(){",r,"return o;})();"]},t}();function IC(t,e){if("function"==typeof t)try{t=t()}catch(t){return!1}if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e&&t.constructor===e.constructor)if(t instanceof i.ValueType){if(t.equals(e))return!0}else{if(Array.isArray(t))return 0===t.length&&0===e.length;if(t.constructor===Object)return st(t)&&st(e)}return!1}var RC,DC,BC,MC,OC,NC,LC,FC,zC,VC,GC=function(){function t(t){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=t}return t.prototype.applyOpacity=function(t){this._opacity=this._localOpacity*t},t.markOpacityTree=function(){},N(t,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(t){this._uiTransformComp=t}},{key:"uiComp",get:function(){return this._uiComp},set:function(t){this._uiComp&&t?b(12002):this._uiComp=t}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(t){this._localOpacity=t,this.colorDirty=!0}}]),t}();Je.Flags.Destroying,function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed",t.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed"}(RC||(RC={}));var UC=Je.Flags.Destroying,kC=Je.Flags.DontDestroy,HC=Je.Flags.Deactivating,jC=new et("Node");function WC(t){return t?"string"==typeof t?zt(t):t:(E(3804),null)}var qC,XC,YC,KC,JC,QC,ZC,$C,tb,eb,nb,ib=t("BaseNode",qc("cc.BaseNode")((VC=zC=function(t){F(n,t),n._setScene=function(t){t._updateScene()},n._findComponent=function(t,e){var n=e,i=t._components;if(n._sealed)for(var r=0;r<i.length;++r){var o=i[r];if(o.constructor===e)return o}else for(var a=0;a<i.length;++a){var s=i[a];if(s instanceof e)return s}return null},n._findComponents=function(t,e,n){var i=e,r=t._components;if(i._sealed)for(var o=0;o<r.length;++o){var a=r[o];a.constructor===e&&n.push(a)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof e&&n.push(c)}},n._findChildComponent=function(t,e){for(var i=0;i<t.length;++i){var r=t[i],o=n._findComponent(r,e);if(o)return o;if(r._children.length>0&&(o=n._findChildComponent(r._children,e)))return o}return null},n._findChildComponents=function(t,e,i){for(var r=0;r<t.length;++r){var o=t[r];n._findComponents(o,e,i),o._children.length>0&&n._findChildComponents(o._children,e,i)}};var e=n.prototype;function n(e){var n;return q(n=t.call(this,e)||this,"_parent",MC,H(n)),q(n,"_children",OC,H(n)),q(n,"_active",NC,H(n)),q(n,"_components",LC,H(n)),q(n,"_prefab",FC,H(n)),n._scene=null,n._activeInHierarchy=!1,n._id=jC.getNewId(),n._name=void 0,n._eventProcessor=new i.NodeEventProcessor(H(n)),n._eventMask=0,n._siblingIndex=0,n._originalSceneId="",n._registerIfAttached=void 0,n._name=void 0!==e?e:"New Node",n}return e._updateScene=function(){null==this._parent?d("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},e.attr=function(t){bt(this,t)},e.getParent=function(){return this._parent},e.setParent=function(t,e){if(void 0===e&&(e=!1),this._parent!==t){var n=this._parent,i=t;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,e),this.emit&&this.emit(RC.PARENT_CHANGED,n),n&&!(n._objFlags&UC)){var r=n._children.indexOf(this);n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(RC.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(RC.CHILD_ADDED,this)),this._onHierarchyChanged(n)}},e.getChildByUuid=function(t){if(!t)return f("Invalid uuid"),null;for(var e=this._children,n=0,i=e.length;n<i;n++)if(e[n]._id===t)return e[n];return null},e.getChildByName=function(t){if(!t)return f("Invalid name"),null;for(var e=this._children,n=0,i=e.length;n<i;n++)if(e[n]._name===t)return e[n];return null},e.getChildByPath=function(t){for(var e=t.split("/"),n=this,i=function(t){var i=e[t];if(0===i.length)return"continue";var r=n.children.find((function(t){return t.name===i}));if(!r)return{v:null};n=r},r=0;r<e.length;++r){var o=i(r);if("continue"!==o&&"object"==typeof o)return o.v}return n},e.addChild=function(t){t.setParent(this)},e.insertChild=function(t,e){t.parent=this,t.setSiblingIndex(e)},e.getSiblingIndex=function(){return this._siblingIndex},e.setSiblingIndex=function(t){if(this._parent)if(this._parent._objFlags&HC)E(3821);else{var e=this._parent._children;t=-1!==t?t:e.length-1;var n=e.indexOf(this);t!==n&&(e.splice(n,1),t<e.length?e.splice(t,0,this):e.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(t))}},e.walk=function(t,e){var i=1,r=null,o=null,a=0,s=n._stacks[n._stackId];s||(s=[],n._stacks.push(s)),n._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(o=s[--i])if(!l&&t?t(o):l&&e&&e(o),s[i]=null,l){if(c===this._parent)break;if(l=!1,r)if(r[++a])s[i]=r[a],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(a=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),a<0))break}else o._children.length>0?(c=o,r=o._children,a=0,s[i]=r[a],i++):(s[i]=o,i++,l=!0);s.length=0,n._stackId--},e.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},e.removeChild=function(t){this._children.indexOf(t)>-1&&(t.parent=null)},e.removeAllChildren=function(){for(var t=this._children,e=t.length-1;e>=0;e--){var n=t[e];n&&(n.parent=null)}this._children.length=0},e.isChildOf=function(t){var e=this;do{if(e===t)return!0;e=e._parent}while(e);return!1},e.getComponent=function(t){var e=WC(t);return e?n._findComponent(this,e):null},e.getComponents=function(t){var e=WC(t),i=[];return e&&n._findComponents(this,e,i),i},e.getComponentInChildren=function(t){var e=WC(t);return e?n._findChildComponent(this._children,e):null},e.getComponentsInChildren=function(t){var e=WC(t),i=[];return e&&(n._findComponents(this,e,i),n._findChildComponents(this._children,e,i)),i},e.addComponent=function(t){var e;if("string"==typeof t){if(!(e=zt(t)))throw i._RF.peek()&&E(3808,t),TypeError(R(3807,t))}else{if(!t)throw TypeError(R(3804));e=t}if("function"!=typeof e)throw TypeError(R(3809));if(!wt(e,i.Component))throw TypeError(R(3810));var n=e._requireComponent;if(n)if(Array.isArray(n))for(var r=0;r<n.length;r++){var o=n[r];this.getComponent(o)||this.addComponent(o)}else{var a=n;this.getComponent(a)||this.addComponent(a)}var s=new e;return s.node=this,this._components.push(s),this._activeInHierarchy&&i.director._nodeActivator.activateComp(s),s},e.removeComponent=function(t){if(t){var e=null;(e=t instanceof ku?t:this.getComponent(t))&&e.destroy()}else E(3813)},e.on=function(t,e,n,i){switch(void 0===i&&(i=!1),t){case RC.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(t,e,n,i)},e.off=function(t,e,n,i){if(void 0===i&&(i=!1),this._eventProcessor.off(t,e,n,i),!this._eventProcessor.hasEventListener(t))switch(t){case RC.TRANSFORM_CHANGED:this._eventMask&=-2}},e.once=function(t,e,n,i){this._eventProcessor.once(t,e,n,i)},e.emit=function(t,e,n,i,r,o){this._eventProcessor.emit(t,e,n,i,r,o)},e.dispatchEvent=function(t){this._eventProcessor.dispatchEvent(t)},e.hasEventListener=function(t,e,n){return this._eventProcessor.hasEventListener(t,e,n)},e.targetOff=function(t){this._eventProcessor.targetOff(t),1&this._eventMask&&!this._eventProcessor.hasEventListener(RC.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},e.destroy=function(){return!!t.prototype.destroy.call(this)&&(this.active=!1,!0)},e.destroyAllChildren=function(){for(var t=this._children,e=0;e<t.length;++e)t[e].destroy()},e._removeComponent=function(t){if(t){if(!(this._objFlags&UC)){var e=this._components.indexOf(t);-1!==e?this._components.splice(e,1):t.node!==this&&E(3815)}}else E(3814)},e._updateSiblingIndex=function(){for(var t=0;t<this._children.length;++t)this._children[t]._siblingIndex=t;this.emit(RC.SIBLING_ORDER_CHANGED)},e._onSetParent=function(t){this._parent&&(null!=t&&t._scene===this._parent._scene||null==this._parent._scene||this.walk(n._setScene))},e._onPostActivated=function(){},e._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},e._onPreDestroy=function(){this._onPreDestroyBase()},e._onHierarchyChanged=function(t){return this._onHierarchyChangedBase(t)},e._instantiate=function(t,e){return t||(t=i.instantiate._clone(this,this)),t._prefab,t._parent=null,t._onBatchCreated(e),t},e._onHierarchyChangedBase=function(){var t=this._parent;!this._persistNode||t instanceof i.Scene||i.game.removePersistRootNode(this);var e=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==e&&i.director._nodeActivator.activateNode(this,e)},e._onPreDestroyBase=function(){this._objFlags|=UC;var t=this._parent,e=!!t&&0!=(t._objFlags&UC);if(this._persistNode&&i.game.removePersistRootNode(this),!e&&t){this.emit(RC.PARENT_CHANGED,this);var n=t._children.indexOf(this);t._children.splice(n,1),this._siblingIndex=0,t._updateSiblingIndex(),t.emit&&t.emit(RC.CHILD_REMOVED,this)}this.emit(RC.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var r=this._children,o=0;o<r.length;++o)r[o]._destroyImmediate();for(var a=this._components,s=0;s<a.length;++s)a[s]._destroyImmediate();return e},N(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&kC)>0},set:function(t){t?this._objFlags|=kC:this._objFlags&=~kC}},{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(t){if(this._active!==t){this._active=t;var e=this._parent;e&&e._activeInHierarchy&&i.director._nodeActivator.activateNode(this,t)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(t){this.setParent(t)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),n}(Je),zC.idGenerator=jC,zC._stacks=[[]],zC._stackId=0,X((BC=VC).prototype,"_persistNode",[Jc],Object.getOwnPropertyDescriptor(BC.prototype,"_persistNode"),BC.prototype),X(BC.prototype,"name",[ll],Object.getOwnPropertyDescriptor(BC.prototype,"name"),BC.prototype),X(BC.prototype,"children",[ll],Object.getOwnPropertyDescriptor(BC.prototype,"children"),BC.prototype),X(BC.prototype,"active",[ll],Object.getOwnPropertyDescriptor(BC.prototype,"active"),BC.prototype),X(BC.prototype,"activeInHierarchy",[ll],Object.getOwnPropertyDescriptor(BC.prototype,"activeInHierarchy"),BC.prototype),X(BC.prototype,"parent",[ll],Object.getOwnPropertyDescriptor(BC.prototype,"parent"),BC.prototype),MC=X(BC.prototype,"_parent",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),OC=X(BC.prototype,"_children",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),NC=X(BC.prototype,"_active",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),LC=X(BC.prototype,"_components",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),FC=X(BC.prototype,"_prefab",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DC=BC))||DC);i._BaseNode=ib;var rb=new oi,ob=new gi,ab=new gi,sb=new gi,cb=new di,lb=new di,ub=new Ei,hb=[],_b=[],fb=[],pb=function(){function t(){this._chunks=[],this._freelists=[],this._createChunk()}var e=t.prototype;return e.alloc=function(){for(var t=this._freelists.length,e=0;e<t;++e)if(this._freelists[e].length)return this._createView(e);return this._createChunk(),this._createView(t)},e.free=function(t,e){for(var n=this._freelists.length,i=0;i<n;++i)if(this._chunks[i]===t)return void this._freelists[i].push(e)},e.clear=function(){for(var t=this._chunks.length,e=0;e<t;++e)this._chunks[e].fill(0)},e._createChunk=function(){this._chunks.push(new Uint32Array(t.CAPACITY_PER_CHUNK));for(var e=[],n=t.CAPACITY_PER_CHUNK-1;n>=0;n--)e.push(n);this._freelists.push(e)},e._createView=function(t){return fb[0]=this._chunks[t],fb[1]=this._freelists[t].pop(),fb},t}();pb.CAPACITY_PER_CHUNK=256;var db,mb,vb,gb,yb,xb,Sb,Ab,Cb,bb,Tb,Eb,wb,Pb,Ib,Rb,Db,Bb,Mb,Ob,Nb,Lb,Fb,zb,Vb,Gb,Ub,kb,Hb,jb,Wb,qb,Xb,Yb,Kb,Jb,Qb,Zb,$b,tT,eT,nT,iT,rT,oT,aT,sT,cT,lT,uT,hT,_T,fT,pT,dT,mT,vT,gT,yT,xT,ST,AT,CT,bT,TT,ET,wT,PT,IT,RT=new pb,DT=Symbol("ReserveContentsForAllSyncablePrefab"),BT=t("Node",(qC=qc("cc.Node"),XC=El(oi),qC((nb=eb=function(t){F(n,t);var e=n.prototype;function n(e){var n;return(n=t.call(this,e)||this)._uiProps=new GC(H(n)),n._static=!1,q(n,"_lpos",JC,H(n)),q(n,"_lrot",QC,H(n)),q(n,"_lscale",ZC,H(n)),q(n,"_layer",$C,H(n)),q(n,"_euler",tb,H(n)),n._dirtyFlagsPri=Nd.NONE,n._eulerDirty=!1,n._nodeHandle=0,n._init(),n}return e._init=function(){var t=RT.alloc(),e=t[0],n=t[1];this._hasChangedFlagsChunk=e,this._hasChangedFlagsOffset=n;var i=new Uint32Array(e.buffer,e.byteOffset+4*n,1);this._hasChangedFlags=i,this._pos=new oi,this._rot=new gi,this._scale=new oi(1,1,1),this._mat=new Ei},n.isNode=function(t){return t instanceof n&&(t.constructor===n||!(t instanceof i.Scene))},e._onPreDestroy=function(){var t=this._onPreDestroyBase();return RT.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),t},e[$u]=function(t){t.writeThis()},e.setParent=function(e,n){void 0===n&&(n=!1),n&&this.updateWorldTransform(),t.prototype.setParent.call(this,e,n)},e._onSetParent=function(e,n){if(t.prototype._onSetParent.call(this,e,n),n){var i=this._parent;i?(i.updateWorldTransform(),Ei.multiply(ub,Ei.invert(ub,i._mat),this._mat),Ei.toRTS(ub,this._lrot,this._lpos,this._lscale)):(oi.copy(this._lpos,this._pos),gi.copy(this._lrot,this._rot),oi.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(Nd.TRS)},e._onHierarchyChanged=function(e){this.eventProcessor.reattach(),t.prototype._onHierarchyChangedBase.call(this,e)},e._onBatchCreated=function(t){this.hasChangedFlags=Nd.TRS,this._dirtyFlags|=Nd.TRS;for(var e=this._children.length,n=0;n<e;++n)this._children[n]._siblingIndex=n,this._children[n]._onBatchCreated(t)},e._onBeforeSerialize=function(){this.eulerAngles},e._onPostActivated=function(t){t?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(Nd.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)},e.translate=function(t,e){var n=e||Od.LOCAL;if(n===Od.LOCAL)oi.transformQuat(rb,t,this._lrot),this._lpos.x+=rb.x,this._lpos.y+=rb.y,this._lpos.z+=rb.z;else if(n===Od.WORLD)if(this._parent){gi.invert(ob,this._parent.worldRotation),oi.transformQuat(rb,t,ob);var i=this.worldScale;this._lpos.x+=rb.x/i.x,this._lpos.y+=rb.y/i.y,this._lpos.z+=rb.z/i.z}else this._lpos.x+=t.x,this._lpos.y+=t.y,this._lpos.z+=t.z;this.invalidateChildren(Nd.POSITION),1&this._eventMask&&this.emit(RC.TRANSFORM_CHANGED,Nd.POSITION)},e.rotate=function(t,e){var n=e||Od.LOCAL;if(gi.normalize(ob,t),n===Od.LOCAL)gi.multiply(this._lrot,this._lrot,ob);else if(n===Od.WORLD){var i=this.worldRotation;gi.multiply(ab,ob,i),gi.invert(ob,i),gi.multiply(ab,ob,ab),gi.multiply(this._lrot,this._lrot,ab)}this._eulerDirty=!0,this.invalidateChildren(Nd.ROTATION),1&this._eventMask&&this.emit(RC.TRANSFORM_CHANGED,Nd.ROTATION)},e.lookAt=function(t,e){this.getWorldPosition(rb),oi.subtract(rb,rb,t),oi.normalize(rb,rb),gi.fromViewUp(ob,rb,e),this.setWorldRotation(ob)},e._setDirtyNode=function(t,e){hb[t]=e},e.invalidateChildren=function(t){var e,n,i,r=0,o=0,a=0,s=0,c=0,l=t|Nd.POSITION;for(hb[0]=this;r>=0;){if(c=(e=hb[r--])._hasChangedFlags[0],s=e._dirtyFlagsPri,e.isValid&&(s&c&t)!==t)for(s|=t,e._dirtyFlagsPri=s,e._hasChangedFlags[0]=c|t,a=(i=e._children).length,o=0;o<a;o++)n=i[o],hb[++r]=n;t=l}},e.updateWorldTransform=function(){if(this._dirtyFlags){for(var t,e=this,n=0;e&&e._dirtyFlags;)this._setDirtyNode(n++,e),e=e._parent;for(var i=0;n;)i|=(t=hb[--n])._dirtyFlags,e?(i&Nd.POSITION&&(oi.transformMat4(t._pos,t._lpos,e._mat),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),i&Nd.RS&&(Ei.fromRTS(t._mat,t._lrot,t._lpos,t._lscale),Ei.multiply(t._mat,e._mat,t._mat),i&Nd.ROTATION&&gi.multiply(t._rot,e._rot,t._lrot),di.fromQuat(cb,gi.conjugate(sb,t._rot)),di.multiplyMat4(cb,cb,t._mat),t._scale.x=cb.m00,t._scale.y=cb.m04,t._scale.z=cb.m08)):(i&Nd.POSITION&&(oi.copy(t._pos,t._lpos),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),i&Nd.RS&&(i&Nd.ROTATION&&gi.copy(t._rot,t._lrot),i&Nd.SCALE&&(oi.copy(t._scale,t._lscale),Ei.fromRTS(t._mat,t._rot,t._pos,t._scale)))),t._dirtyFlags=Nd.NONE,e=t}},e.setPosition=function(t,e,n){void 0===e&&void 0===n?oi.copy(this._lpos,t):void 0===n?oi.set(this._lpos,t,e,this._lpos.z):oi.set(this._lpos,t,e,n),this.invalidateChildren(Nd.POSITION),1&this._eventMask&&this.emit(RC.TRANSFORM_CHANGED,Nd.POSITION)},e.getPosition=function(t){return t?oi.set(t,this._lpos.x,this._lpos.y,this._lpos.z):oi.copy(new oi,this._lpos)},e.setRotation=function(t,e,n,i){void 0===e||void 0===n||void 0===i?gi.copy(this._lrot,t):gi.set(this._lrot,t,e,n,i),this._eulerDirty=!0,this.invalidateChildren(Nd.ROTATION),1&this._eventMask&&this.emit(RC.TRANSFORM_CHANGED,Nd.ROTATION)},e.setRotationFromEuler=function(t,e,n){var i=void 0===n?this._euler.z:n;void 0===e?(oi.copy(this._euler,t),gi.fromEuler(this._lrot,t.x,t.y,t.z)):(oi.set(this._euler,t,e,i),gi.fromEuler(this._lrot,t,e,i)),this._eulerDirty=!1,this.invalidateChildren(Nd.ROTATION),1&this._eventMask&&this.emit(RC.TRANSFORM_CHANGED,Nd.ROTATION)},e.getRotation=function(t){return t?gi.set(t,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):gi.copy(new gi,this._lrot)},e.setScale=function(t,e,n){void 0===e&&void 0===n?oi.copy(this._lscale,t):void 0===n?oi.set(this._lscale,t,e,this._lscale.z):oi.set(this._lscale,t,e,n),this.invalidateChildren(Nd.SCALE),1&this._eventMask&&this.emit(RC.TRANSFORM_CHANGED,Nd.SCALE)},e.getScale=function(t){return t?oi.set(t,this._lscale.x,this._lscale.y,this._lscale.z):oi.copy(new oi,this._lscale)},e.inverseTransformPoint=function(t,e){oi.copy(t,e);for(var n=this,i=0;n._parent;)this._setDirtyNode(i++,n),n=n._parent;for(;i>=0;)oi.transformInverseRTS(t,t,n._lrot,n._lpos,n._lscale),n=hb[--i];return t},e.setWorldPosition=function(t,e,n){void 0===e||void 0===n?oi.copy(this._pos,t):oi.set(this._pos,t,e,n);var i=this._parent,r=this._lpos;i?(i.updateWorldTransform(),oi.transformMat4(r,this._pos,Ei.invert(ub,i._mat))):oi.copy(r,this._pos),this.invalidateChildren(Nd.POSITION),1&this._eventMask&&this.emit(RC.TRANSFORM_CHANGED,Nd.POSITION)},e.getWorldPosition=function(t){return this.updateWorldTransform(),t?oi.copy(t,this._pos):oi.copy(new oi,this._pos)},e.setWorldRotation=function(t,e,n,i){void 0===e||void 0===n||void 0===i?gi.copy(this._rot,t):gi.set(this._rot,t,e,n,i),this._parent?(this._parent.updateWorldTransform(),gi.multiply(this._lrot,gi.conjugate(this._lrot,this._parent._rot),this._rot)):gi.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Nd.ROTATION),1&this._eventMask&&this.emit(RC.TRANSFORM_CHANGED,Nd.ROTATION)},e.setWorldRotationFromEuler=function(t,e,n){gi.fromEuler(this._rot,t,e,n),this._parent?(this._parent.updateWorldTransform(),gi.multiply(this._lrot,gi.conjugate(this._lrot,this._parent._rot),this._rot)):gi.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Nd.ROTATION),1&this._eventMask&&this.emit(RC.TRANSFORM_CHANGED,Nd.ROTATION)},e.getWorldRotation=function(t){return this.updateWorldTransform(),t?gi.copy(t,this._rot):gi.copy(new gi,this._rot)},e.setWorldScale=function(t,e,n){void 0===e||void 0===n?oi.copy(this._scale,t):oi.set(this._scale,t,e,n);var i=this._parent;i?(i.updateWorldTransform(),di.fromQuat(cb,gi.conjugate(sb,i._rot)),di.multiplyMat4(cb,cb,i._mat),lb.m00=this._scale.x,lb.m04=this._scale.y,lb.m08=this._scale.z,di.multiply(cb,lb,di.invert(cb,cb)),this._lscale.x=oi.set(rb,cb.m00,cb.m01,cb.m02).length(),this._lscale.y=oi.set(rb,cb.m03,cb.m04,cb.m05).length(),this._lscale.z=oi.set(rb,cb.m06,cb.m07,cb.m08).length()):oi.copy(this._lscale,this._scale),this.invalidateChildren(Nd.SCALE),1&this._eventMask&&this.emit(RC.TRANSFORM_CHANGED,Nd.SCALE)},e.getWorldScale=function(t){return this.updateWorldTransform(),t?oi.copy(t,this._scale):oi.copy(new oi,this._scale)},e.getWorldMatrix=function(t){this.updateWorldTransform();var e=t||new Ei;return Ei.copy(e,this._mat)},e.getWorldRS=function(t){this.updateWorldTransform();var e=t||new Ei;return Ei.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e},e.getWorldRT=function(t){this.updateWorldTransform();var e=t||new Ei;return Ei.fromRT(e,this._rot,this._pos)},e.setRTS=function(t,e,n){var i=0;t&&(i|=Nd.ROTATION,void 0!==t.w?(gi.copy(this._lrot,t),this._eulerDirty=!0):(oi.copy(this._euler,t),gi.fromEuler(this._lrot,t.x,t.y,t.z),this._eulerDirty=!1)),e&&(oi.copy(this._lpos,e),i|=Nd.POSITION),n&&(oi.copy(this._lscale,n),i|=Nd.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(RC.TRANSFORM_CHANGED,i))},e.pauseSystemEvents=function(t){this._eventProcessor.setEnabled(!1,t)},e.resumeSystemEvents=function(t){this._eventProcessor.setEnabled(!0,t)},n.resetHasChangedFlags=function(){RT.clear()},n.clearNodeArray=function(){n.ClearFrame<n.ClearRound?n.ClearFrame++:(n.ClearFrame=0,hb.length=0,_b.length=0)},N(n,[{key:"_dirtyFlags",get:function(){return this._dirtyFlagsPri},set:function(t){this._dirtyFlagsPri=t}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return this._lpos},set:function(t){this.setPosition(t)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(t){this.setWorldPosition(t)}},{key:"rotation",get:function(){return this._lrot},set:function(t){this.setRotation(t)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(gi.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(t){this.setRotationFromEuler(t.x,t.y,t.z)}},{key:"angle",get:function(){return this._euler.z},set:function(t){oi.set(this._euler,0,0,t),gi.fromAngleZ(this._lrot,t),this._eulerDirty=!1,this.invalidateChildren(Nd.ROTATION),1&this._eventMask&&this.emit(RC.TRANSFORM_CHANGED,Nd.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(t){this.setWorldRotation(t)}},{key:"scale",get:function(){return this._lscale},set:function(t){this.setScale(t)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(t){this.setWorldScale(t)}},{key:"matrix",set:function(t){Ei.toRTS(t,this._lrot,this._lpos,this._lscale),this.invalidateChildren(Nd.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(RC.TRANSFORM_CHANGED,Nd.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return oi.transformQuat(new oi,oi.FORWARD,this.worldRotation)},set:function(t){var e=t.length();oi.multiplyScalar(rb,t,-1/e),gi.fromViewUp(ob,rb),this.setWorldRotation(ob)}},{key:"up",get:function(){return oi.transformQuat(new oi,oi.UP,this.worldRotation)}},{key:"right",get:function(){return oi.transformQuat(new oi,oi.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(t){this._layer=t,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(RC.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]},set:function(t){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=t}}]),n}(ib),eb.EventType=RC,eb.NodeSpace=Od,eb.TransformDirtyBit=Nd,eb.TransformBit=Nd,eb.reserveContentsForAllSyncablePrefabTag=DT,eb.ClearFrame=0,eb.ClearRound=1e3,JC=X((KC=nb).prototype,"_lpos",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oi}}),QC=X(KC.prototype,"_lrot",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new gi}}),ZC=X(KC.prototype,"_lscale",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oi(1,1,1)}}),$C=X(KC.prototype,"_layer",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fp.Enum.DEFAULT}}),tb=X(KC.prototype,"_euler",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oi}}),X(KC.prototype,"eulerAngles",[XC],Object.getOwnPropertyDescriptor(KC.prototype,"eulerAngles"),KC.prototype),X(KC.prototype,"angle",[ll],Object.getOwnPropertyDescriptor(KC.prototype,"angle"),KC.prototype),X(KC.prototype,"layer",[ll],Object.getOwnPropertyDescriptor(KC.prototype,"layer"),KC.prototype),YC=KC))||YC));i.Node=BT;var MT=qc("cc.TargetInfo")((vb=X((mb=function(){q(this,"localID",vb,this)}).prototype,"localID",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),db=mb))||db,OT=(gb=qc("cc.TargetOverrideInfo"),yb=El(Je),xb=El(MT),Sb=El(BT),Ab=El(MT),gb((Tb=X((bb=function(){q(this,"source",Tb,this),q(this,"sourceInfo",Eb,this),q(this,"propertyPath",wb,this),q(this,"target",Pb,this),q(this,"targetInfo",Ib,this)}).prototype,"source",[Zc,yb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Eb=X(bb.prototype,"sourceInfo",[Zc,xb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wb=X(bb.prototype,"propertyPath",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pb=X(bb.prototype,"target",[Zc,Sb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ib=X(bb.prototype,"targetInfo",[Zc,Ab],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Cb=bb))||Cb),NT=qc("cc.CompPrefabInfo")((Bb=X((Db=function(){q(this,"fileId",Bb,this)}).prototype,"fileId",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Rb=Db))||Rb,LT=(Mb=qc("CCPropertyOverrideInfo"),Ob=El(MT),Mb((Gb=function(){function t(){q(this,"targetInfo",Fb,this),q(this,"propertyPath",zb,this),q(this,"value",Vb,this)}return t.prototype.isTarget=function(){},t}(),Fb=X((Lb=Gb).prototype,"targetInfo",[Zc,Ob],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zb=X(Lb.prototype,"propertyPath",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vb=X(Lb.prototype,"value",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Nb=Lb))||Nb),FT=(Ub=qc("cc.MountedChildrenInfo"),kb=El(MT),Hb=El([BT]),Ub((Yb=function(){function t(){q(this,"targetInfo",qb,this),q(this,"nodes",Xb,this)}return t.prototype.isTarget=function(){},t}(),qb=X((Wb=Yb).prototype,"targetInfo",[Zc,kb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xb=X(Wb.prototype,"nodes",[Zc,Hb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jb=Wb))||jb),zT=(Kb=qc("cc.MountedComponentsInfo"),Jb=El(MT),Qb=El([ku]),Kb((nT=function(){function t(){q(this,"targetInfo",tT,this),q(this,"components",eT,this)}return t.prototype.isTarget=function(){},t}(),tT=X(($b=nT).prototype,"targetInfo",[Zc,Jb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eT=X($b.prototype,"components",[Zc,Qb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zb=$b))||Zb),VT=(iT=qc("cc.PrefabInstance"),rT=El(BT),oT=El([FT]),aT=El([zT]),sT=El([LT]),cT=El([MT]),iT((vT=function(){function t(){q(this,"fileId",hT,this),q(this,"prefabRootNode",_T,this),q(this,"mountedChildren",fT,this),q(this,"mountedComponents",pT,this),q(this,"propertyOverrides",dT,this),q(this,"removedComponents",mT,this),this.targetMap={}}var e=t.prototype;return e.findPropertyOverride=function(){},e.removePropertyOverride=function(){},t}(),hT=X((uT=vT).prototype,"fileId",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_T=X(uT.prototype,"prefabRootNode",[Zc,rT],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),fT=X(uT.prototype,"mountedChildren",[Zc,oT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pT=X(uT.prototype,"mountedComponents",[Zc,aT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dT=X(uT.prototype,"propertyOverrides",[Zc,sT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mT=X(uT.prototype,"removedComponents",[Zc,cT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lT=uT))||lT),GT=(gT=qc("cc.PrefabInfo"),yT=El(BT),xT=El(VT),ST=El([OT]),gT((bT=X((CT=function(){q(this,"root",bT,this),q(this,"asset",TT,this),q(this,"fileId",ET,this),q(this,"instance",wT,this),q(this,"targetOverrides",PT,this),q(this,"nestedPrefabInstanceRoots",IT,this)}).prototype,"root",[Zc,yT],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),TT=X(CT.prototype,"asset",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ET=X(CT.prototype,"fileId",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),wT=X(CT.prototype,"instance",[Zc,xT],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),PT=X(CT.prototype,"targetOverrides",[Zc,ST],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),IT=X(CT.prototype,"nestedPrefabInstanceRoots",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),AT=CT))||AT);function UT(t){var e=t._prefab;if(e&&e.instance){if(!e.asset)return E(3701,t.name),void(e.instance=void 0);var n=t._objFlags,r=t._parent,o=t._id,a=t._prefab;t[Xe],i.game._isCloning=!0,e.asset._doInstantiate(t),i.game._isCloning=!1,t._objFlags=n,t._parent=r,t._id=o,t._prefab&&(t._prefab.instance=null==a?void 0:a.instance)}}function kT(t,e,n){var i;if(e&&t){var r=e,o=null===(i=t._prefab)||void 0===i?void 0:i.instance;!n&&o&&(e[o.fileId]={},r=e[o.fileId]);var a=t._prefab;a&&(r[a.fileId]=t);for(var s=t.components,c=0;c<s.length;c++){var l=s[c];l.__prefab&&(r[l.__prefab.fileId]=l)}for(var u=0;u<t.children.length;u++)kT(t.children[u],r,!1)}}function HT(t,e){if(!t)return null;for(var n=e,i=0;i<t.length;i++){if(!n)return null;n=n[t[i]]}return n}function jT(t,e,n){if(e)for(var i=0;i<e.length;i++){var r=e[i];if(r&&r.targetInfo){var o=HT(r.targetInfo.localID,n);if(!o)continue;var a=n,s=r.targetInfo.localID;if(s.length>0)for(var c=0;c<s.length-1;c++)a=a[s[c]];if(r.nodes)for(var l=0;l<r.nodes.length;l++){var u=r.nodes[l];u&&(o._children.push(u),u._parent=o,kT(u,a,!1),u._siblingIndex=o._children.length-1,KT(u,!0))}}}}function WT(t,e,n){if(e)for(var i=0;i<e.length;i++){var r=e[i];if(r&&r.targetInfo){var o=HT(r.targetInfo.localID,n);if(!o)continue;if(r.components)for(var a=0;a<r.components.length;a++){var s=r.components[a];s&&(s.node=o,o._components.push(s))}}}}function qT(t,e,n){if(e)for(var i=0;i<e.length;i++){var r=e[i];if(r){var o=HT(r.localID,n);if(!o||!o.node)continue;var a=o.node.components.indexOf(o);a>=0&&o.node._components.splice(a,1)}}}function XT(t,e,n){if(!(e.length<=0))for(var i=null,r=0;r<e.length;r++){var o=e[r];if(o&&o.targetInfo){if(!(i=HT(o.targetInfo.localID,n)))continue;var a=i,s=o.propertyPath.slice();if(s.length>0){var c=s.pop();if(!c)continue;for(var l=0;l<s.length&&(a=a[s[l]]);l++);if(!a)continue;if(Array.isArray(a))if("length"===c)a[c]=o.value;else{var u=Number.parseInt(c);Number.isInteger(u)&&u<a.length&&(a[c]=o.value)}else a[c]instanceof te?a[c].set(o.value):a[c]=o.value}}}}function YT(t){var e,n=null===(e=t._prefab)||void 0===e?void 0:e.targetOverrides;if(n)for(var i=0;i<n.length;i++){var r,o,a=n[i],s=a.source,c=a.sourceInfo;if(c){var l,u,h=null===(l=a.source)||void 0===l||null===(u=l._prefab)||void 0===u?void 0:u.instance;h&&h.targetMap&&(s=HT(c.localID,h.targetMap))}if(s){var _,f=a.targetInfo;if(f){var p=null===(r=a.target)||void 0===r||null===(o=r._prefab)||void 0===o?void 0:o.instance;if(p&&p.targetMap&&(_=HT(f.localID,p.targetMap))){var d=a.propertyPath.slice(),m=s;if(d.length>0){var v=d.pop();if(!v)return;for(var g=0;g<d.length&&(m=m[d[g]]);g++);if(!m)continue;m[v]=_}}}}}}function KT(t,e){void 0===e&&(e=!1);var n=t._prefab,i=null==n?void 0:n.instance;if(i){UT(t);var r={};i.targetMap=r,kT(t,r,!0),jT(0,i.mountedChildren,r),qT(0,i.removedComponents,r),WT(0,i.mountedComponents,r),XT(0,i.propertyOverrides,r)}e&&t&&t.children&&t.children.forEach((function(t){KT(t,!0)}))}function JT(t){var e=t._prefab;e&&e.nestedPrefabInstanceRoots&&e.nestedPrefabInstanceRoots.forEach((function(t){KT(t)}))}i._PrefabInfo=GT;var QT,ZT,$T,tE,eE,nE,iE,rE,oE,aE,sE,cE,lE,uE,hE=Object.freeze({__proto__:null,TargetInfo:MT,TargetOverrideInfo:OT,CompPrefabInfo:NT,PropertyOverrideInfo:LT,MountedChildrenInfo:FT,MountedComponentsInfo:zT,PrefabInstance:VT,PrefabInfo:GT,createNodeWithPrefab:UT,generateTargetMap:kT,getTarget:HT,applyMountedChildren:jT,applyMountedComponents:WT,applyRemovedComponents:qT,applyPropertyOverrides:XT,applyTargetOverrides:YT,expandPrefabInstanceNode:KT,expandNestedPrefabInstanceNode:JT}),_E=Jt({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),fE=t("Prefab",qc("cc.Prefab")((iE=nE=function(t){function e(){var e;return q(e=t.call(this)||this,"data",$T,H(e)),q(e,"optimizationPolicy",tE,H(e)),q(e,"persistent",eE,H(e)),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}F(e,t);var n=e.prototype;return n.createNode=function(t){var e=i.instantiate(this);e.name=this.name,t(null,e)},n.compileCreateFunction=function(){var t,e;this._createFunction=(e=(t=this.data)instanceof i._BaseNode&&t,new PC(t,e).result)},n._doInstantiate=function(t){return this.data._prefab||b(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(t)},n._instantiate=function(){var t;return this.optimizationPolicy!==_E.SINGLE_INSTANCE&&(this.optimizationPolicy===_E.MULTI_INSTANCE||this._instantiatedTimes+1>=e.OptimizationPolicyThreshold)?(t=this._doInstantiate(),this.data._instantiate(t)):t=this.data._instantiate(),++this._instantiatedTimes,t},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.data=new BT,this.data.name="(Missing Node)";var n=new i._PrefabInfo;n.asset=this,n.root=this.data,this.data._prefab=n},n.validate=function(){return!!this.data},n.onLoaded=function(){var t=this.data;JT(t),YT(t)},e}(Su),nE.OptimizationPolicy=_E,nE.OptimizationPolicyThreshold=3,$T=X((ZT=iE).prototype,"data",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tE=X(ZT.prototype,"optimizationPolicy",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _E.AUTO}}),eE=X(ZT.prototype,"persistent",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),QT=ZT))||QT);kt.value(fE,"_utils",hE),i.Prefab=fE,dt(i,"cc._Prefab","Prefab"),t("PrefabLink",(rE=qc("cc.PrefabLink"),oE=El(fE),aE=ul(),rE((uE=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"prefab",lE,H(e)),e}return F(e,t),e}(ku),lE=X((cE=uE).prototype,"prefab",[oE,Zc,aE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sE=cE))||sE));var pE=new oi;function dE(t,e,n,i){i||(i=new oi),t.convertToUINode(e,n,i);var r=n.position;return i.add(r),i}function mE(t,e,n){return n||(n=new oi),t.worldToScreen(e,n),n.x/=i.view.getScaleX(),n.y/=i.view.getScaleY(),n}var vE,gE,yE=t("convertUtils",{WorldNode3DToLocalNodeUI:dE,WorldNode3DToWorldNodeUI:mE});i.pipelineUtils=yE,aC(i.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];var i=e[0],r=e[3]||pE;return i.convertToUINode(e[1],e[2],r),r.add(e[2].position),e[3]||r.clone()}}]),sC(Sm.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),aC(KS.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var xE,SE=t("BufferAsset",qc("cc.BufferAsset")((X((gE=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._buffer=null,e}F(e,t);var n=e.prototype;return n.buffer=function(){return this._buffer},n.validate=function(){return!!this.buffer},N(e,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(t){t instanceof ArrayBuffer?this._buffer=t:this._buffer=t.buffer}}]),e}(Su)).prototype,"_nativeAsset",[Ll],Object.getOwnPropertyDescriptor(gE.prototype,"_nativeAsset"),gE.prototype),vE=gE))||vE);i.BufferAsset=SE;var AE=((xE={})[pr.UNORM]="Uint",xE[pr.SNORM]="Int",xE[pr.UINT]="Uint",xE[pr.INT]="Int",xE[pr.UFLOAT]="Float",xE[pr.FLOAT]="Float",xE.default="Uint",xE);function CE(t){return""+(AE[t.type]||AE.default)+t.size/t.count*8}function bE(t,e,n,i,r){void 0===n&&(n=fr.R32F),void 0===i&&(i=0),void 0===r&&(r=0);var o=na[n];r||(r=o.size);for(var a="set"+CE(o),s=o.size/o.count,c=Math.floor(e.length/o.count),l=Zu.isLittleEndian,u=0;u<c;++u)for(var h=i+r*u,_=0;_<o.count;++_){var f=h+s*_;t[a](f,e[o.count*u+_],l)}}function TE(t,e,n,i,r,o,a){void 0===n&&(n=fr.R32F),void 0===i&&(i=0),void 0===r&&(r=t.byteLength-i),void 0===o&&(o=0),a||(a=new DataView(t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)));var s=na[n];o||(o=s.size);for(var c="set"+CE(s),l="get"+CE(s),u=s.size/s.count,h=Math.floor(r/o),_=Zu.isLittleEndian,f=0;f<h;++f)for(var p=i+o*f,d=0;d<s.count;++d){var m=p+u*d,v=t[l](m,_);a[c](m,e(v,d,t),_)}return a}var EE,wE,PE=t("RenderingSubMesh",function(){var t=e.prototype;function e(t,e,n,i,r){void 0===i&&(i=null),void 0===r&&(r=null),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._attributes=e,this._vertexBuffers=t,this._indexBuffer=i,this._indirectBuffer=r,this._primitiveMode=n,this._iaInfo=new Oo(e,t,i,r),this._init()}return t._init=function(){},t.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var t=this.mesh,e=0,n=t.struct.primitives[this.subMeshIdx];n.indexView&&(e=n.indexView.count);for(var i=0;i<n.vertexBundelIndices.length;i++){var r=n.vertexBundelIndices[i],o=t.struct.vertexBundles[r],a=n.indexView?n.indexView.count:o.view.count,s=o.view.stride,c=s*a,l=new Uint8Array(t.data.buffer,o.view.offset,o.view.length),u=new Uint8Array(n.indexView?c:o.view.length);if(n.indexView){for(var h=t.readIndices(this.subMeshIdx),_=0;_<e;++_)for(var f=_*s,p=h[_]*s,d=0;d<s;++d)u[f+d]=l[p+d];this._flatBuffers.push({stride:s,count:a,buffer:u})}else u.set(t.data.subarray(o.view.offset,o.view.offset+o.view.length)),this._flatBuffers.push({stride:s,count:a,buffer:u})}}},t.destroy=function(){for(var t=0;t<this.vertexBuffers.length;t++)this.vertexBuffers[t].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var e=0;e<this._jointMappedBufferIndices.length;e++)this._jointMappedBuffers[this._jointMappedBufferIndices[e]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},t.enableVertexIdChannel=function(t){if(!this._vertexIdChannel){var e=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(t);this._vertexBuffers.push(i),this._attributes.push(new Bo("a_vertexId",fr.R32F,!1,e)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:e,index:n}}},t._allocVertexIdBuffer=function(t){for(var e=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(e),i=0;i<e;++i)n[i]=i+.5;var r=t.createBuffer(new po(mr.VERTEX|mr.TRANSFER_DST,yr.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return r.update(n),r},N(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:oi.ZERO,max:oi.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:oi.ZERO,max:oi.ZERO}};var t=this.mesh,e=this.subMeshIdx,n=t.readAttribute(e,Zr.ATTR_POSITION),i=t.readIndices(e),r=new oi,o=new oi,a=this.attributes.find((function(t){return t.name===Zr.ATTR_POSITION}));if(a){var s=na[a.format].count;2===s?(r.set(n[0],n[1],0),o.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),o.set(n[0],n[1],n[2]));for(var c=0;c<n.length;c+=s)2===s?(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y):(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,r.z=n[c+2]>r.z?n[c+2]:r.z,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y,o.z=n[c+2]<o.z?n[c+2]:o.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:r,min:o}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var t=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var e=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var r,o,a=this.mesh.struct,s=a.primitives[this.subMeshIdx];if(!a.jointMaps||void 0===s.jointMapIndex||!a.jointMaps[s.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var c=i.director.root.device,l=0;l<s.vertexBundelIndices.length;l++){var u=a.vertexBundles[s.vertexBundelIndices[l]];o=0,r=fr.UNKNOWN;for(var h=0;h<u.attributes.length;h++){var _=u.attributes[h];if(_.name===Zr.ATTR_JOINTS){r=_.format;break}o+=na[_.format].size}r?function(){var i=new Uint8Array(t.mesh.data.buffer,u.view.offset,u.view.length),h=new DataView(i.slice().buffer),_=a.jointMaps[s.jointMapIndex];TE(h,(function(t){return _.indexOf(t)}),r,o,u.view.length,u.view.stride,h);var f=c.createBuffer(new po(mr.VERTEX|mr.TRANSFER_DST,yr.DEVICE,u.view.length,u.view.stride));f.update(h.buffer),e.push(f),n.push(l)}():e.push(this.vertexBuffers[s.vertexBundelIndices[l]])}return this._vertexIdChannel&&e.push(this._allocVertexIdBuffer(c)),e}},{key:"iaInfo",get:function(){return this._iaInfo}}]),e}());!function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed"}(EE||(EE=t("SystemEventType",{}))),function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.KEY_DOWN="keydown",t.KEY_PRESSING="key-pressing",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion"}(wE||(wE={})),i.SystemEventType=EE;var IE,RE=new Array(16),DE=null,BE=new li,ME=[RC.TOUCH_START,RC.TOUCH_MOVE,RC.TOUCH_END,RC.TOUCH_CANCEL],OE=[RC.MOUSE_DOWN,RC.MOUSE_ENTER,RC.MOUSE_MOVE,RC.MOUSE_LEAVE,RC.MOUSE_UP,RC.MOUSE_WHEEL];!function(t){t[t.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",t[t.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",t[t.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(IE||(IE={}));var NE,LE,FE,zE,VE,GE,UE,kE,HE,jE,WE,qE,XE,YE,KE,JE,QE,ZE,$E,tw,ew,nw,iw,rw,ow,aw,sw,cw,lw,uw,hw,_w,fw,pw,dw,mw,vw,gw,yw,xw,Sw,Aw,Cw,bw,Tw,Ew,ww,Pw,Iw,Rw,Dw,Bw,Mw,Ow,Nw,Lw,Fw,zw,Vw,Gw,Uw,kw,Hw,jw,Ww,qw,Xw,Yw,Kw,Jw,Qw,Zw,$w,tP,eP,nP,iP,rP,oP,aP,sP,cP,lP,uP,hP,_P,fP,pP,dP,mP,vP,gP,yP,xP,SP,AP,CP,bP,TP,EP,wP,PP,IP,RP,DP,BP,MP,OP,NP,LP,FP,zP,VP,GP,UP,kP,HP,jP,WP,qP,XP,YP,KP,JP,QP,ZP,$P,tI,eI,nI,iI,rI,oI,aI,sI,cI,lI,uI,hI,_I,fI,pI,dI,mI,vI,gI,yI,xI,SI,AI,CI,bI,TI,EI,wI,PI,II,RI,DI,BI,MI,OI,NI,LI,FI,zI,VI,GI,UI,kI,HI,jI,WI,qI,XI,YI,KI,JI,QI,ZI,$I,tR,eR,nR,iR,rR,oR,aR,sR,cR,lR,uR,hR,_R,fR,pR,dR=function(){var t=e.prototype;function e(t){this._isEnabled=!1,this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._node=void 0,this._node=t}return t.setEnabled=function(t,n){if(void 0===n&&(n=!1),this._isEnabled!==t){this._isEnabled=t;var i=this.node.children;if(t&&this._attachMask(),e.callbacksInvoker.emit(IE.MARK_LIST_DIRTY),n&&i.length>0)for(var r=0;r<i.length;++r)i[r]._eventProcessor.setEnabled(t,!0)}},t._searchComponentsInParent=function(t){var e=this.node;if(t){for(var n=0,i=[],r=e;r&&BT.isNode(r);r=r.parent,++n){var o=r.getComponent(t);if(o){var a={index:n,comp:o};i?i.push(a):i=[a]}}return i.length>0?i:null}return null},t._attachMask=function(){this.maskList=this._searchComponentsInParent(e._maskComp)},t.reattach=function(){var t,n=this;this.node.walk((function(i){t||(t=n._searchComponentsInParent(e._maskComp)),i.eventProcessor.maskList=t}))},t.destroy=function(){DE===this._node&&(DE=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),e.callbacksInvoker.emit(IE.REMOVE_POINTER_EVENT_PROCESSOR,this)},t._isTouchEvent=function(t){return-1!==ME.indexOf(t)},t._isMouseEvent=function(t){return-1!==OE.indexOf(t)},t._hasTouchListeners=function(){for(var t=0;t<ME.length;++t){var e=ME[t];if(this.hasEventListener(e))return!0}return!1},t._hasMouseListeners=function(){for(var t=0;t<OE.length;++t){var e=OE[t];if(this.hasEventListener(e))return!0}return!1},t._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},t._tryEmittingAddEvent=function(t){var n=this._isTouchEvent(t),i=this._isMouseEvent(t);n?this.shouldHandleEventTouch=!0:i&&(this.shouldHandleEventMouse=!0),!n&&!i||this._hasPointerListeners()||e.callbacksInvoker.emit(IE.ADD_POINTER_EVENT_PROCESSOR,this)},t._newCallbacksInvoker=function(){var t=this,n=new an;return n._registerOffCallback((function(){t.shouldHandleEventTouch&&!t._hasTouchListeners()&&(t.shouldHandleEventTouch=!1),t.shouldHandleEventMouse&&!t._hasMouseListeners()&&(t.shouldHandleEventMouse=!1),t._hasPointerListeners()||e.callbacksInvoker.emit(IE.REMOVE_POINTER_EVENT_PROCESSOR,t)})),n},t.on=function(t,e,n,i){var r,o;return this._tryEmittingAddEvent(t),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(t,e,n),e},t.once=function(t,e,n,i){var r,o;return this._tryEmittingAddEvent(t),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(t,e,n,!0),e},t.off=function(t,e,n,i){var r;null===(r=(i=!!i)?this.capturingTarget:this.bubblingTarget)||void 0===r||r.off(t,e,n)},t.targetOff=function(t){var n,i;null===(n=this.capturingTarget)||void 0===n||n.removeAll(t),null===(i=this.bubblingTarget)||void 0===i||i.removeAll(t),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||e.callbacksInvoker.emit(IE.REMOVE_POINTER_EVENT_PROCESSOR,this)},t.emit=function(t,e,n,i,r,o){var a;null===(a=this.bubblingTarget)||void 0===a||a.emit(t,e,n,i,r,o)},t.dispatchEvent=function(t){var e,n=this.node,i=0;for(t.target=n,RE.length=0,this.getCapturingTargets(t.type,RE),t.eventPhase=1,i=RE.length-1;i>=0;--i)if((e=RE[i]).eventProcessor.capturingTarget&&(t.currentTarget=e,e.eventProcessor.capturingTarget.emit(t.type,t,RE),t.propagationStopped))return void(RE.length=0);if(RE.length=0,t.eventPhase=2,t.currentTarget=n,this.capturingTarget&&this.capturingTarget.emit(t.type,t),!t.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(this.getBubblingTargets(t.type,RE),t.eventPhase=3,i=0;i<RE.length;++i)if((e=RE[i]).eventProcessor.bubblingTarget&&(t.currentTarget=e,e.eventProcessor.bubblingTarget.emit(t.type,t),t.propagationStopped))return void(RE.length=0);RE.length=0},t.hasEventListener=function(t,e,n){var i=!1;return this.bubblingTarget&&(i=this.bubblingTarget.hasEventListener(t,e,n)),!i&&this.capturingTarget&&(i=this.capturingTarget.hasEventListener(t,e,n)),i},t.getCapturingTargets=function(t,e){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.capturingTarget)||void 0===i?void 0:i.hasEventListener(t))&&e.push(n),n=n.parent}},t.getBubblingTargets=function(t,e){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.bubblingTarget)||void 0===i?void 0:i.hasEventListener(t))&&e.push(n),n=n.parent}},t._handleEventMouse=function(t){switch(t.type){case wE.MOUSE_DOWN:return this._handleMouseDown(t);case wE.MOUSE_MOVE:return this._handleMouseMove(t);case wE.MOUSE_UP:return this._handleMouseUp(t);case wE.MOUSE_WHEEL:return this._handleMouseWheel(t);default:return!1}},t._handleMouseDown=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(BE=t.getUILocation(),!e._uiProps.uiTransformComp.isHit(BE)||(t.type=RC.MOUSE_DOWN,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},t._handleMouseMove=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(BE=t.getUILocation(),e._uiProps.uiTransformComp.isHit(BE)?(this.previousMouseIn||(DE&&DE!==e&&(t.type=RC.MOUSE_LEAVE,DE.dispatchEvent(t),DE.eventProcessor.previousMouseIn=!1),DE=e,t.type=RC.MOUSE_ENTER,e.dispatchEvent(t),this.previousMouseIn=!0),t.type=RC.MOUSE_MOVE,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0):(this.previousMouseIn&&(t.type=RC.MOUSE_LEAVE,e.dispatchEvent(t),this.previousMouseIn=!1,DE=null),1)))},t._handleMouseUp=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(BE=t.getUILocation(),!e._uiProps.uiTransformComp.isHit(BE)||(t.type=RC.MOUSE_UP,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},t._handleMouseWheel=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(BE=t.getUILocation(),!e._uiProps.uiTransformComp.isHit(BE)||(t.type=RC.MOUSE_WHEEL,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},t._handleEventTouch=function(t){switch(t.type){case wE.TOUCH_START:return this._handleTouchStart(t);case wE.TOUCH_MOVE:return this._handleTouchMove(t);case wE.TOUCH_END:return this._handleTouchEnd(t);case wE.TOUCH_CANCEL:return this._handleTouchCancel(t);default:return!1}},t._handleTouchStart=function(t){var e=this.node;return!(!e||!e._uiProps.uiTransformComp||(t.getUILocation(BE),!e._uiProps.uiTransformComp.isHit(BE)||(t.type=RC.TOUCH_START,t.bubbles=!0,e.dispatchEvent(t),0)))},t._handleTouchMove=function(t){var e=this.node;return!(!e||!e._uiProps.uiTransformComp||(t.type=RC.TOUCH_MOVE,t.bubbles=!0,e.dispatchEvent(t),0))},t._handleTouchEnd=function(t){var e=this.node;e&&e._uiProps.uiTransformComp&&(t.getUILocation(BE),e._uiProps.uiTransformComp.isHit(BE)?t.type=RC.TOUCH_END:t.type=RC.TOUCH_CANCEL,t.bubbles=!0,e.dispatchEvent(t))},t._handleTouchCancel=function(t){var e=this.node;e&&e._uiProps.uiTransformComp&&(t.type=RC.TOUCH_CANCEL,t.bubbles=!0,e.dispatchEvent(t))},N(e,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]),e}();dR._maskComp=null,dR.callbacksInvoker=new an,i.NodeEventProcessor=dR;var mR=new oi(0,1,0),vR=new oi,gR=new fi,yR=new Li,xR=new gi,SR=function(t){var e=1/Math.max(Math.max(Math.max(t.x,t.y),t.z),1e-4);e<1&&(t.x*=e,t.y*=e,t.z*=e)},AR=(NE=qc("cc.AmbientInfo"),LE=cl(),FE=$c("_skyColor"),zE=$c("_skyIllum"),VE=$c("_groundAlbedo"),GE=ul(),UE=fl(),kE=El(be),HE=fl(),jE=ul(),WE=fl(),NE(qE=LE((tw=function(){function t(){q(this,"_skyColorHDR",YE,this),q(this,"_skyIllumHDR",KE,this),q(this,"_groundAlbedoHDR",JE,this),q(this,"_skyColorLDR",QE,this),q(this,"_skyIllumLDR",ZE,this),q(this,"_groundAlbedoLDR",$E,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this)},N(t,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var t=i.director.root.pipeline.pipelineSceneData.isHDR;return gR.set(t?this._skyColorHDR:this._skyColorLDR),SR(gR),yR.set(255*gR.x,255*gR.y,255*gR.z,255)},set:function(t){gR.set(t.x,t.y,t.z,t.w),i.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(gR):this._skyColorLDR.set(gR),this._resource&&this._resource.skyColor.set(gR)}},{key:"skyColor",set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(t):this._skyColorLDR.set(t),this._resource&&this._resource.skyColor.set(t)}},{key:"skyIllum",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=t:this._skyIllumLDR=t,this._resource&&(this._resource.skyIllum=t)}},{key:"groundLightingColor",get:function(){var t=i.director.root.pipeline.pipelineSceneData.isHDR;return gR.set(t?this._groundAlbedoHDR:this._groundAlbedoLDR),SR(gR),yR.set(255*gR.x,255*gR.y,255*gR.z,255)},set:function(t){gR.set(t.x,t.y,t.z,t.w),i.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(gR):this._groundAlbedoLDR.set(gR),this._resource&&this._resource.groundAlbedo.set(gR)}},{key:"groundAlbedo",set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(t):this._groundAlbedoLDR.set(t),this._resource&&this._resource.groundAlbedo.set(t)}}]),t}(),YE=X((XE=tw).prototype,"_skyColorHDR",[Zc,FE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new fi(.2,.5,.8,1)}}),KE=X(XE.prototype,"_skyIllumHDR",[Zc,zE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ui.SKY_ILLUM}}),JE=X(XE.prototype,"_groundAlbedoHDR",[Zc,VE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new fi(.2,.2,.2,1)}}),QE=X(XE.prototype,"_skyColorLDR",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new fi(.2,.5,.8,1)}}),ZE=X(XE.prototype,"_skyIllumLDR",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ui.SKY_ILLUM}}),$E=X(XE.prototype,"_groundAlbedoLDR",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new fi(.2,.2,.2,1)}}),X(XE.prototype,"skyLightingColor",[GE,ll,UE],Object.getOwnPropertyDescriptor(XE.prototype,"skyLightingColor"),XE.prototype),X(XE.prototype,"skyIllum",[ll,kE,HE],Object.getOwnPropertyDescriptor(XE.prototype,"skyIllum"),XE.prototype),X(XE.prototype,"groundLightingColor",[jE,ll,WE],Object.getOwnPropertyDescriptor(XE.prototype,"groundLightingColor"),XE.prototype),qE=XE))||qE)||qE);i.AmbientInfo=AR;var CR=(ew=qc("cc.SkyboxInfo"),nw=cl(),iw=El(Wm),rw=$c("_envmap"),ow=El(Wm),aw=El(Wm),sw=El(Wm),cw=ul(),lw=fl(),uw=fl(),hw=fl(),_w=fl(),fw=El(Wm),pw=fl(),dw=ul(),mw=El(Wm),ew(vw=nw((ww=function(){function t(){q(this,"_applyDiffuseMap",yw,this),q(this,"_envmapHDR",xw,this),q(this,"_envmapLDR",Sw,this),q(this,"_diffuseMapHDR",Aw,this),q(this,"_diffuseMapLDR",Cw,this),q(this,"_enabled",bw,this),q(this,"_useIBL",Tw,this),q(this,"_useHDR",Ew,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.activate()},N(t,[{key:"applyDiffuseMap",get:function(){return this._applyDiffuseMap},set:function(t){this._applyDiffuseMap=t,this._resource&&(this._resource.useDiffuseMap=t)}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=this._enabled))}},{key:"useIBL",get:function(){return this._useIBL},set:function(t){this._useIBL=t,this._resource&&(this._resource.useIBL=this._useIBL)}},{key:"useHDR",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR=t,this._useHDR=t,this._resource&&(this.envmap=this._resource.envmap,this.diffuseMap=this._resource.diffuseMap,null==this.diffuseMap&&(this.applyDiffuseMap=!1)),this._resource&&(this._resource.useHDR=this._useHDR)}},{key:"envmap",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR=t:this._envmapLDR=t,this._envmapHDR||(this._diffuseMapHDR=null,this._applyDiffuseMap=!1,this.useIBL=!1),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.useDiffuseMap=this._applyDiffuseMap,this._resource.envmap=t)}},{key:"diffuseMap",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(t){i.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=t:this._diffuseMapLDR=t,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}}]),t}(),yw=X((gw=ww).prototype,"_applyDiffuseMap",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xw=X(gw.prototype,"_envmapHDR",[Zc,iw,rw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sw=X(gw.prototype,"_envmapLDR",[Zc,ow],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Aw=X(gw.prototype,"_diffuseMapHDR",[Zc,aw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Cw=X(gw.prototype,"_diffuseMapLDR",[Zc,sw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bw=X(gw.prototype,"_enabled",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Tw=X(gw.prototype,"_useIBL",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ew=X(gw.prototype,"_useHDR",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X(gw.prototype,"applyDiffuseMap",[cw,ll,lw],Object.getOwnPropertyDescriptor(gw.prototype,"applyDiffuseMap"),gw.prototype),X(gw.prototype,"enabled",[ll,uw],Object.getOwnPropertyDescriptor(gw.prototype,"enabled"),gw.prototype),X(gw.prototype,"useIBL",[ll,hw],Object.getOwnPropertyDescriptor(gw.prototype,"useIBL"),gw.prototype),X(gw.prototype,"useHDR",[ll,_w],Object.getOwnPropertyDescriptor(gw.prototype,"useHDR"),gw.prototype),X(gw.prototype,"envmap",[ll,fw,pw],Object.getOwnPropertyDescriptor(gw.prototype,"envmap"),gw.prototype),X(gw.prototype,"diffuseMap",[dw,ll,hl,mw],Object.getOwnPropertyDescriptor(gw.prototype,"diffuseMap"),gw.prototype),vw=gw))||vw)||vw);i.SkyboxInfo=CR;var bR=(Pw=qc("cc.FogInfo"),Iw=cl(),Rw=fl(),Dw=fl(),Bw=fl(),Mw=El(iC),Ow=fl(),Nw=ul(),Lw=El(be),Fw=pl(),zw=vl(),Vw=yl(),Gw=fl(),Uw=ul(),kw=El(be),Hw=vl(),jw=yl(),Ww=fl(),qw=ul(),Xw=El(be),Yw=vl(),Kw=yl(),Jw=fl(),Qw=ul(),Zw=El(be),$w=dl(),tP=vl(),eP=yl(),nP=fl(),iP=ul(),rP=El(be),oP=vl(),aP=yl(),sP=fl(),cP=ul(),lP=El(be),uP=vl(),hP=yl(),_P=fl(),Pw(fP=Iw((EP=TP=function(){function t(){q(this,"_type",dP,this),q(this,"_fogColor",mP,this),q(this,"_enabled",vP,this),q(this,"_fogDensity",gP,this),q(this,"_fogStart",yP,this),q(this,"_fogEnd",xP,this),q(this,"_fogAtten",SP,this),q(this,"_fogTop",AP,this),q(this,"_fogRange",CP,this),q(this,"_accurate",bP,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this),this._resource.activate()},N(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(t){this._accurate!==t&&(this._accurate=t,this._resource&&(this._resource.accurate=t,t&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(t){this._fogColor.set(t),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._resource&&(this._resource.type=t)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(t){this._fogDensity=t,this._resource&&(this._resource.fogDensity=t)}},{key:"fogStart",get:function(){return this._fogStart},set:function(t){this._fogStart=t,this._resource&&(this._resource.fogStart=t)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(t){this._fogEnd=t,this._resource&&(this._resource.fogEnd=t)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(t){this._fogAtten=t,this._resource&&(this._resource.fogAtten=t)}},{key:"fogTop",get:function(){return this._fogTop},set:function(t){this._fogTop=t,this._resource&&(this._resource.fogTop=t)}},{key:"fogRange",get:function(){return this._fogRange},set:function(t){this._fogRange=t,this._resource&&(this._resource.fogRange=t)}}]),t}(),TP.FogType=iC,dP=X((pP=EP).prototype,"_type",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iC.LINEAR}}),mP=X(pP.prototype,"_fogColor",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Li("#C8C8C8")}}),vP=X(pP.prototype,"_enabled",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gP=X(pP.prototype,"_fogDensity",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),yP=X(pP.prototype,"_fogStart",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),xP=X(pP.prototype,"_fogEnd",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),SP=X(pP.prototype,"_fogAtten",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),AP=X(pP.prototype,"_fogTop",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),CP=X(pP.prototype,"_fogRange",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),bP=X(pP.prototype,"_accurate",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(pP.prototype,"enabled",[ll,Rw],Object.getOwnPropertyDescriptor(pP.prototype,"enabled"),pP.prototype),X(pP.prototype,"accurate",[ll,Dw],Object.getOwnPropertyDescriptor(pP.prototype,"accurate"),pP.prototype),X(pP.prototype,"fogColor",[ll,Bw],Object.getOwnPropertyDescriptor(pP.prototype,"fogColor"),pP.prototype),X(pP.prototype,"type",[ll,Mw,Ow],Object.getOwnPropertyDescriptor(pP.prototype,"type"),pP.prototype),X(pP.prototype,"fogDensity",[Nw,Lw,Fw,zw,gl,Vw,Gw],Object.getOwnPropertyDescriptor(pP.prototype,"fogDensity"),pP.prototype),X(pP.prototype,"fogStart",[Uw,kw,Hw,jw,Ww],Object.getOwnPropertyDescriptor(pP.prototype,"fogStart"),pP.prototype),X(pP.prototype,"fogEnd",[qw,Xw,Yw,Kw,Jw],Object.getOwnPropertyDescriptor(pP.prototype,"fogEnd"),pP.prototype),X(pP.prototype,"fogAtten",[Qw,Zw,$w,tP,eP,nP],Object.getOwnPropertyDescriptor(pP.prototype,"fogAtten"),pP.prototype),X(pP.prototype,"fogTop",[iP,rP,oP,aP,sP],Object.getOwnPropertyDescriptor(pP.prototype,"fogTop"),pP.prototype),X(pP.prototype,"fogRange",[cP,lP,uP,hP,_P],Object.getOwnPropertyDescriptor(pP.prototype,"fogRange"),pP.prototype),fP=pP))||fP)||fP),TR=(wP=qc("cc.ShadowsInfo"),PP=cl(),IP=fl(),RP=El(fg),DP=ul(),BP=ul(),MP=fl(),OP=El(be),NP=fl(),LP=ul(),FP=pl(),zP=El(be),VP=fl(),GP=ul(),UP=El(pg),kP=fl(),HP=ul(),jP=El(Ce),WP=ul(),qP=El(be),XP=fl(),YP=ul(),KP=El(be),JP=fl(),QP=ul(),ZP=El(_g),$P=fl(),tI=ul(),eI=El(Te),nI=fl(),iI=ul(),rI=El(be),oI=fl(),aI=ul(),sI=El(be),cI=fl(),lI=ul(),uI=pl(),hI=El(be),_I=fl(),fI=ul(),pI=pl(),dI=El(be),mI=fl(),vI=ul(),gI=El(be),yI=fl(),xI=ul(),wP(SI=PP((UI=function(){function t(){q(this,"_type",CI,this),q(this,"_enabled",bI,this),q(this,"_normal",TI,this),q(this,"_distance",EI,this),q(this,"_shadowColor",wI,this),q(this,"_firstSetCSM",PI,this),q(this,"_fixedArea",II,this),q(this,"_pcf",RI,this),q(this,"_bias",DI,this),q(this,"_normalBias",BI,this),q(this,"_near",MI,this),q(this,"_far",OI,this),q(this,"_shadowDistance",NI,this),q(this,"_invisibleOcclusionRange",LI,this),q(this,"_orthoSize",FI,this),q(this,"_maxReceived",zI,this),q(this,"_size",VI,this),q(this,"_saturation",GI,this),this._resource=null}var e=t.prototype;return e.setPlaneFromNode=function(t){t.getWorldRotation(xR),this.normal=oi.transformQuat(vR,mR,xR),t.getWorldPosition(vR),this.distance=oi.dot(this._normal,vR)},e.activate=function(t){this.pcf=Math.min(this._pcf,pg.SOFT_2X),this._resource=t,this._resource.initialize(this),this._resource.activate()},N(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._resource&&(this._resource.type=t)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(t){this._shadowColor.set(t),this._resource&&(this._resource.shadowColor=t)}},{key:"normal",get:function(){return this._normal},set:function(t){oi.copy(this._normal,t),this._resource&&(this._resource.normal=t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance=t,this._resource&&(this._resource.distance=t)}},{key:"saturation",get:function(){return this._saturation},set:function(t){t>1?(this._saturation=t/t,this._resource&&(this._resource.saturation=t/t)):(this._saturation=t,this._resource&&(this._resource.saturation=t))}},{key:"pcf",get:function(){return this._pcf},set:function(t){this._pcf=t,this._resource&&(this._resource.pcf=t)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(t){this._maxReceived=t,this._resource&&(this._resource.maxReceived=t)}},{key:"bias",get:function(){return this._bias},set:function(t){this._bias=t,this._resource&&(this._resource.bias=t)}},{key:"normalBias",get:function(){return this._normalBias},set:function(t){this._normalBias=t,this._resource&&(this._resource.normalBias=t)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(t){this._size.set(t,t),this._resource&&(this._resource.size.set(t,t),this._resource.shadowMapDirty=!0)}},{key:"size",get:function(){return this._size}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(t){this._fixedArea=t,this._resource&&(this._resource.fixedArea=t)}},{key:"near",get:function(){return this._near},set:function(t){this._near=t,this._resource&&(this._resource.near=t)}},{key:"far",get:function(){return this._far},set:function(t){this._far=Math.min(t,mg.MAX_FAR),this._resource&&(this._resource.far=this._far)}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(t){this._invisibleOcclusionRange=Math.min(t,mg.MAX_FAR),this._resource&&(this._resource.invisibleOcclusionRange=this._invisibleOcclusionRange)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(t){this._shadowDistance=Math.min(t,mg.MAX_FAR),this._resource&&(this._resource.shadowDistance=this._shadowDistance)}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(t){this._orthoSize=t,this._resource&&(this._resource.orthoSize=t)}}]),t}(),CI=X((AI=UI).prototype,"_type",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fg.Planar}}),bI=X(AI.prototype,"_enabled",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),TI=X(AI.prototype,"_normal",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oi(0,1,0)}}),EI=X(AI.prototype,"_distance",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wI=X(AI.prototype,"_shadowColor",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Li(0,0,0,76)}}),PI=X(AI.prototype,"_firstSetCSM",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),II=X(AI.prototype,"_fixedArea",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),RI=X(AI.prototype,"_pcf",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pg.HARD}}),DI=X(AI.prototype,"_bias",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),BI=X(AI.prototype,"_normalBias",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),MI=X(AI.prototype,"_near",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),OI=X(AI.prototype,"_far",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),NI=X(AI.prototype,"_shadowDistance",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),LI=X(AI.prototype,"_invisibleOcclusionRange",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 200}}),FI=X(AI.prototype,"_orthoSize",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),zI=X(AI.prototype,"_maxReceived",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),VI=X(AI.prototype,"_size",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new li(512,512)}}),GI=X(AI.prototype,"_saturation",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.75}}),X(AI.prototype,"enabled",[ll,IP],Object.getOwnPropertyDescriptor(AI.prototype,"enabled"),AI.prototype),X(AI.prototype,"type",[ll,RP],Object.getOwnPropertyDescriptor(AI.prototype,"type"),AI.prototype),X(AI.prototype,"shadowColor",[DP],Object.getOwnPropertyDescriptor(AI.prototype,"shadowColor"),AI.prototype),X(AI.prototype,"normal",[BP,MP],Object.getOwnPropertyDescriptor(AI.prototype,"normal"),AI.prototype),X(AI.prototype,"distance",[OP,NP,LP],Object.getOwnPropertyDescriptor(AI.prototype,"distance"),AI.prototype),X(AI.prototype,"saturation",[ll,FP,gl,zP,VP,GP],Object.getOwnPropertyDescriptor(AI.prototype,"saturation"),AI.prototype),X(AI.prototype,"pcf",[UP,kP,HP],Object.getOwnPropertyDescriptor(AI.prototype,"pcf"),AI.prototype),X(AI.prototype,"maxReceived",[jP,WP],Object.getOwnPropertyDescriptor(AI.prototype,"maxReceived"),AI.prototype),X(AI.prototype,"bias",[qP,XP,YP],Object.getOwnPropertyDescriptor(AI.prototype,"bias"),AI.prototype),X(AI.prototype,"normalBias",[KP,JP,QP],Object.getOwnPropertyDescriptor(AI.prototype,"normalBias"),AI.prototype),X(AI.prototype,"shadowMapSize",[ZP,$P,tI],Object.getOwnPropertyDescriptor(AI.prototype,"shadowMapSize"),AI.prototype),X(AI.prototype,"fixedArea",[eI,nI,iI],Object.getOwnPropertyDescriptor(AI.prototype,"fixedArea"),AI.prototype),X(AI.prototype,"near",[rI,oI,aI],Object.getOwnPropertyDescriptor(AI.prototype,"near"),AI.prototype),X(AI.prototype,"far",[sI,cI,lI],Object.getOwnPropertyDescriptor(AI.prototype,"far"),AI.prototype),X(AI.prototype,"invisibleOcclusionRange",[ll,uI,gl,hI,_I,fI],Object.getOwnPropertyDescriptor(AI.prototype,"invisibleOcclusionRange"),AI.prototype),X(AI.prototype,"shadowDistance",[ll,pI,gl,dI,mI,vI],Object.getOwnPropertyDescriptor(AI.prototype,"shadowDistance"),AI.prototype),X(AI.prototype,"orthoSize",[gI,yI,xI],Object.getOwnPropertyDescriptor(AI.prototype,"orthoSize"),AI.prototype),SI=AI))||SI)||SI);i.ShadowsInfo=TR;var ER,wR,PR,IR,RR=new oi(-1024,-1024,-1024),DR=new oi(1024,1024,1024),BR=(kI=qc("cc.OctreeInfo"),HI=cl(),jI=fl(),WI=fl(),qI=_l(),XI=fl(),YI=_l(),KI=pl(),JI=El(Ce),QI=fl(),kI(ZI=HI((rR=function(){function t(){q(this,"_enabled",tR,this),q(this,"_minPos",eR,this),q(this,"_maxPos",nR,this),q(this,"_depth",iR,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this)},N(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t))}},{key:"minPos",get:function(){return this._minPos},set:function(t){this._minPos=t,this._resource&&(this._resource.minPos=t)}},{key:"maxPos",get:function(){return this._maxPos},set:function(t){this._maxPos=t,this._resource&&(this._resource.maxPos=t)}},{key:"depth",get:function(){return this._depth},set:function(t){this._depth=t,this._resource&&(this._resource.depth=t)}}]),t}(),tR=X(($I=rR).prototype,"_enabled",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),eR=X($I.prototype,"_minPos",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oi(RR)}}),nR=X($I.prototype,"_maxPos",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oi(DR)}}),iR=X($I.prototype,"_depth",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),X($I.prototype,"enabled",[ll,jI],Object.getOwnPropertyDescriptor($I.prototype,"enabled"),$I.prototype),X($I.prototype,"minPos",[ll,WI,qI],Object.getOwnPropertyDescriptor($I.prototype,"minPos"),$I.prototype),X($I.prototype,"maxPos",[ll,XI,YI],Object.getOwnPropertyDescriptor($I.prototype,"maxPos"),$I.prototype),X($I.prototype,"depth",[ll,KI,JI,QI],Object.getOwnPropertyDescriptor($I.prototype,"depth"),$I.prototype),ZI=$I))||ZI)||ZI),MR=(oR=qc("cc.SceneGlobals"),aR=El(CR),oR((pR=function(){function t(){q(this,"ambient",lR,this),q(this,"shadows",uR,this),q(this,"_skybox",hR,this),q(this,"fog",_R,this),q(this,"octree",fR,this)}return t.prototype.activate=function(){var t=i.director.root.pipeline.pipelineSceneData;this.skybox.activate(t.skybox),this.ambient.activate(t.ambient),this.shadows.activate(t.shadows),this.fog.activate(t.fog),this.octree.activate(t.octree)},N(t,[{key:"skybox",get:function(){return this._skybox},set:function(t){this._skybox=t}}]),t}(),lR=X((cR=pR).prototype,"ambient",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new AR}}),uR=X(cR.prototype,"shadows",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new TR}}),hR=X(cR.prototype,"_skybox",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CR}}),_R=X(cR.prototype,"fog",[ll,Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new bR}}),X(cR.prototype,"skybox",[ll,aR],Object.getOwnPropertyDescriptor(cR.prototype,"skybox"),cR.prototype),fR=X(cR.prototype,"octree",[ll,Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new BR}}),sR=cR))||sR);i.SceneGlobals=MR;var OR=t("Scene",qc("cc.Scene")((X((wR=function(t){F(n,t);var e=n.prototype;function n(e){var n;return q(n=t.call(this,e)||this,"autoReleaseAssets",PR,H(n)),q(n,"_globals",IR,H(n)),n.dependAssets=null,n._renderScene=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=oi.ZERO,n._rot=gi.IDENTITY,n._scale=oi.ONE,n._mat=Ei.IDENTITY,n._dirtyFlags=0,n._lpos=oi.ZERO,n._lrot=gi.IDENTITY,n._lscale=oi.ONE,n._activeInHierarchy=!1,i.director&&i.director.root&&(n._renderScene=i.director.root.createScene({})),n._inited=!i.game||!i.game._isCloning,n._init(),n}return e._updateScene=function(){this._scene=this},e._init=function(){},e.destroy=function(){var t=Je.prototype.destroy.call(this);if(t)for(var e=this._children,n=0;n<e.length;++n)e[n].active=!1;return this._renderScene&&i.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,t},e.addComponent=function(){throw new Error(R(3822))},e._onHierarchyChanged=function(){},e._onBatchCreated=function(e){t.prototype._onBatchCreated.call(this,e);for(var n=this._children.length,i=0;i<n;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(e)},e.getPosition=function(t){return oi.copy(t||new oi,oi.ZERO)},e.getRotation=function(t){return gi.copy(t||new gi,gi.IDENTITY)},e.getScale=function(t){return oi.copy(t||new oi,oi.ONE)},e.getWorldPosition=function(t){return oi.copy(t||new oi,oi.ZERO)},e.getWorldRotation=function(t){return gi.copy(t||new gi,gi.IDENTITY)},e.getWorldScale=function(t){return oi.copy(t||new oi,oi.ONE)},e.getWorldMatrix=function(t){return Ei.copy(t||new Ei,Ei.IDENTITY)},e.getWorldRS=function(t){return Ei.copy(t||new Ei,Ei.IDENTITY)},e.getWorldRT=function(t){return Ei.copy(t||new Ei,Ei.IDENTITY)},e.updateWorldTransform=function(){},e._instantiate=function(){},e._load=function(){this._inited||(JT(this),YT(this),this._onBatchCreated(false),this._inited=!0),this.walk(ib._setScene)},e._activate=function(t){t=!1!==t,i.director._nodeActivator.activateNode(this,t),this._globals.activate(),this._renderScene&&this._renderScene.activate()},N(n,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return oi.ZERO}},{key:"worldPosition",get:function(){return oi.ZERO}},{key:"rotation",get:function(){return gi.IDENTITY}},{key:"worldRotation",get:function(){return gi.IDENTITY}},{key:"scale",get:function(){return oi.ONE}},{key:"worldScale",get:function(){return oi.ONE}},{key:"eulerAngles",get:function(){return oi.ZERO}},{key:"worldMatrix",get:function(){return Ei.IDENTITY}}]),n}(ib)).prototype,"globals",[ll],Object.getOwnPropertyDescriptor(wR.prototype,"globals"),wR.prototype),PR=X(wR.prototype,"autoReleaseAssets",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),IR=X(wR.prototype,"_globals",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new MR}}),ER=wR))||ER);function NR(t,e){if(!e){var n=i.director.getScene();if(!n)return null;e=n}return e.getChildByPath(t)}i.Scene=OR,i.find=NR;var LR=Ut.fastRemoveAt,FR=Je.Flags.IsStartCalled,zR=Je.Flags.IsOnEnableCalled;function VR(t,e){for(var n=e.constructor._executionOrder,i=e._id,r=0,o=t.length-1,a=o>>>1;r<=o;a=r+o>>>1){var s=t[a],c=s.constructor._executionOrder;if(c>n)o=a-1;else if(c<n)r=a+1;else{var l=s._id;if(l>i)o=a-1;else{if(!(l<i))return a;r=a+1}}}return~r}function GR(t,e){for(var n=t.array,i=t.i+1;i<n.length;){var r=n[i];r.node._activeInHierarchy?++i:(t.removeAt(i),e&&(r._objFlags&=~e))}}Je.Flags.IsEditorOnEnableCalled;var UR=function(t){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var e=Y;this._zero=new e([]),this._neg=new e([]),this._pos=new e([]),this._invoke=t};function kR(t,e){return t.constructor._executionOrder-e.constructor._executionOrder}UR.stableRemoveInactive=GR;var HR=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.add=function(t){var e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).array.push(t)},n.remove=function(t){var e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).fastRemove(t)},n.cancelInactive=function(t){GR(this._zero,t),GR(this._neg,t),GR(this._pos,t)},n.invoke=function(){var t=this._neg;t.array.length>0&&(t.array.sort(kR),this._invoke(t),t.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var e=this._pos;e.array.length>0&&(e.array.sort(kR),this._invoke(e),e.array.length=0)},e}(UR),jR=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.add=function(t){var e=t.constructor._executionOrder;if(0===e)this._zero.array.push(t);else{var n=e<0?this._neg.array:this._pos.array,i=VR(n,t);i<0&&n.splice(~i,0,t)}},n.remove=function(t){var e=t.constructor._executionOrder;if(0===e)this._zero.fastRemove(t);else{var n=e<0?this._neg:this._pos,i=VR(n.array,t);i>=0&&n.removeAt(i)}},n.invoke=function(t){this._neg.array.length>0&&this._invoke(this._neg,t),this._invoke(this._zero,t),this._pos.array.length>0&&this._invoke(this._pos,t)},e}(UR);function WR(t,e,n){var r="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+t+"}",o=e?Function("it","dt",r):Function("it",r);return function(t,e,n){return function(r,o){try{e(r,o)}catch(e){i._throw(e);var a=r.array;for(n&&(a[r.i]._objFlags|=n),++r.i;r.i<a.length;++r.i)try{t(a[r.i],o)}catch(t){i._throw(t),n&&(a[r.i]._objFlags|=n)}}}}(Function("c","dt",t),o,n)}var qR=WR("c.start();c._objFlags|="+FR,!1,FR),XR=WR("c.update(dt)",!0),YR=WR("c.lateUpdate(dt)",!0),KR=function(t){var e=i.director._compScheduler,n=t.array;for(t.i=0;t.i<n.length;++t.i){var r=n[t.i];r._enabled&&(r.onEnable(),!r.node._activeInHierarchy||e._onEnabled(r))}},JR=function(){function t(){this._deferredComps=[],this.unscheduleAll()}var e=t.prototype;return e.unscheduleAll=function(){this.startInvoker=new HR(qR),this.updateInvoker=new jR(XR),this.lateUpdateInvoker=new jR(YR),this._updating=!1},e._onEnabled=function(t){i.director.getScheduler().resumeTarget(t),t._objFlags|=zR,this._updating?this._deferredComps.push(t):this._scheduleImmediate(t)},e._onDisabled=function(t){i.director.getScheduler().pauseTarget(t),t._objFlags&=~zR;var e=this._deferredComps.indexOf(t);e>=0?LR(this._deferredComps,e):(!t.start||t._objFlags&FR||this.startInvoker.remove(t),t.update&&this.updateInvoker.remove(t),t.lateUpdate&&this.lateUpdateInvoker.remove(t))},e.enableComp=function(t,e){if(!(t._objFlags&zR)){if(t.onEnable){if(e)return void e.add(t);if(t.onEnable(),!t.node._activeInHierarchy)return}this._onEnabled(t)}},e.disableComp=function(t){t._objFlags&zR&&(t.onDisable&&t.onDisable(),this._onDisabled(t))},e.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},e.updatePhase=function(t){this.updateInvoker.invoke(t)},e.lateUpdatePhase=function(t){this.lateUpdateInvoker.invoke(t),this._updating=!1,this._startForNewComps()},e._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},e._scheduleImmediate=function(t){"function"!=typeof t.start||t._objFlags&FR||this.startInvoker.add(t),"function"==typeof t.update&&this.updateInvoker.add(t),"function"==typeof t.lateUpdate&&this.lateUpdateInvoker.add(t)},e._deferredSchedule=function(){for(var t=this._deferredComps,e=0,n=t.length;e<n;e++)this._scheduleImmediate(t[e]);t.length=0},t}(),QR=Je.Flags.IsPreloadStarted,ZR=Je.Flags.IsOnLoadStarted,$R=Je.Flags.IsOnLoadCalled,tD=Je.Flags.Deactivating,eD=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.add=function(t){this._zero.array.push(t)},n.remove=function(t){this._zero.fastRemove(t)},n.cancelInactive=function(t){UR.stableRemoveInactive(this._zero,t)},n.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},e}(UR),nD=WR("c.__preload();"),iD=WR("c.onLoad();c._objFlags|="+$R,!1,$R),rD=new Gt(4);function oD(t,e,n){E(3817,t.name,n),console.log("Corrupted component value:",e),e?t._removeComponent(e):Ut.removeAt(t._components,n)}rD.get=function(){var t=this._get()||{preload:new eD(nD),onLoad:new HR(iD),onEnable:new HR(KR)};t.preload._zero.i=-1;var e=t.onLoad;return e._zero.i=-1,e._neg.i=-1,e._pos.i=-1,(e=t.onEnable)._zero.i=-1,e._neg.i=-1,e._pos.i=-1,t};var aD,sD,cD,lD,uD,hD,_D,fD,pD=t("NodeActivator",function(){function t(){this.resetComp=void 0,this.reset()}var e=t.prototype;return e.reset=function(){this._activatingStack=[]},e.activateNode=function(t,e){if(e){var n=rD.get();this._activatingStack.push(n),this._activateNodeRecursively(t,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),rD.put(n)}else{this._deactivateNodeRecursively(t);for(var i,r=W(this._activatingStack);!(i=r()).done;){var o=i.value;o.preload.cancelInactive(QR),o.onLoad.cancelInactive(ZR),o.onEnable.cancelInactive()}}t.emit(RC.ACTIVE_IN_HIERARCHY_CHANGED,t)},e.activateComp=function(t,e,n,r){if(Ze(t,!0)&&(t._objFlags&QR||(t._objFlags|=QR,t.__preload&&(e?e.add(t):t.__preload())),t._objFlags&ZR||(t._objFlags|=ZR,t.onLoad?n?n.add(t):(t.onLoad(),t._objFlags|=$R):t._objFlags|=$R),t._enabled)){if(!t.node._activeInHierarchy)return;i.director._compScheduler.enableComp(t,r)}},e.destroyComp=function(t){i.director._compScheduler.disableComp(t),t.onDestroy&&t._objFlags&$R&&t.onDestroy()},e._activateNodeRecursively=function(t,e,n,r){if(t._objFlags&tD)E(3816,t.name);else{t._activeInHierarchy=!0;for(var o=t._components.length,a=0;a<o;++a){var s=t._components[a];s instanceof i.Component?this.activateComp(s,e,n,r):(oD(t,s,a),--a,--o)}for(var c=0,l=t._children.length;c<l;++c){var u=t._children[c];u._active&&this._activateNodeRecursively(u,e,n,r)}t._onPostActivated(!0)}},e._deactivateNodeRecursively=function(t){t._objFlags|=tD,t._activeInHierarchy=!1;for(var e=t._components.length,n=0;n<e;++n){var r=t._components[n];if(r._enabled&&(i.director._compScheduler.disableComp(r),t._activeInHierarchy))return void(t._objFlags&=~tD)}for(var o=0,a=t._children.length;o<a;++o){var s=t._children[o];if(s._activeInHierarchy&&(this._deactivateNodeRecursively(s),t._activeInHierarchy))return void(t._objFlags&=~tD)}t._onPostActivated(!1),t._objFlags&=~tD},t}()),dD=t("SceneAsset",qc("cc.SceneAsset")((lD=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"scene",cD,H(e)),e}F(e,t);var n=e.prototype;return n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.scene=new OR("New Scene")},n.validate=function(){return!!this.scene},e}(Su),cD=X((sD=lD).prototype,"scene",[ll,Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aD=sD))||aD);i.SceneAsset=dD;var mD,vD,gD,yD,xD=t("TextAsset",qc("cc.TextAsset")((fD=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"text",_D,H(e)),e}return F(e,t),e.prototype.toString=function(){return this.text},e}(Su),_D=X((hD=fD).prototype,"text",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),uD=hD))||uD);i.TextAsset=xD;var SD=t("JsonAsset",qc("cc.JsonAsset")((yD=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"json",gD,H(e)),e}return F(e,t),e}(Su),gD=X((vD=yD).prototype,"json",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mD=vD))||mD);i.JsonAsset=SD;var AD,CD,bD,TD,ED,wD,PD,ID,RD,DD,BD,MD,OD,ND,LD,FD,zD,VD,GD,UD,kD,HD,jD,WD,qD,XD,YD,KD,JD,QD,ZD,$D,tB,eB,nB,iB,rB,oB,aB=function(){var t=e.prototype;function e(){this.fog=new oC,this.ambient=new Ui,this.skybox=new Ag,this.shadows=new mg,this.octree=new ki,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}return t._init=function(){},t.activate=function(t,e){return this._device=t,this._pipeline=e,this.initOcclusionQuery(),!0},t.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var t=new hg;t._uuid="default-occlusion-query-material",t.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=t,this._occlusionQueryShader=t.passes[0].getShaderVariant()}},t.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial.passes[0]},t.onGlobalPipelineStateChanged=function(){},t.destroy=function(){var t,e,n;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null===(t=this._occlusionQueryInputAssembler)||void 0===t||t.destroy(),this._occlusionQueryInputAssembler=null,null===(e=this._occlusionQueryVertexBuffer)||void 0===e||e.destroy(),this._occlusionQueryVertexBuffer=null,null===(n=this._occlusionQueryIndicesBuffer)||void 0===n||n.destroy(),this._occlusionQueryIndicesBuffer=null},t._createOcclusionQueryIA=function(){var t=this._device,e=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),n=3*Float32Array.BYTES_PER_ELEMENT,i=8*n;this._occlusionQueryVertexBuffer=t.createBuffer(new po(mr.VERTEX|mr.TRANSFER_DST,yr.DEVICE,i,n)),this._occlusionQueryVertexBuffer.update(e);var r=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),o=Uint16Array.BYTES_PER_ELEMENT,a=36*o;this._occlusionQueryIndicesBuffer=t.createBuffer(new po(mr.INDEX|mr.TRANSFER_DST,yr.DEVICE,a,o)),this._occlusionQueryIndicesBuffer.update(r);var s=[new Bo("a_position",fr.RGB32F)],c=new Oo(s,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return t.createInputAssembler(c)},N(e,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(t){this._isHDR=t}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(t){this._shadingScale!==t&&(this._shadingScale=t,this._pipeline.emit(Qy.ATTACHMENT_SCALE_CAHNGED,t))}}]),e}(),sB=t("ForwardPipeline",(AD=qc("ForwardPipeline"),CD=El([QS]),bD=yl(),AD((PD=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"renderTextures",wD,H(e)),e._postRenderPass=null,e}F(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._flows.length){var n=new eC;n.initialize(eC.initInfo),this._flows.push(n);var i=new FA;i.initialize(FA.initInfo),this._flows.push(i)}return!0},n.activate=function(e){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new aB,!(!t.prototype.activate.call(this,e)||!this._activeRenderer(e)&&(E(2402),1))},n._ensureEnoughSize=function(t){for(var e=this._width,n=this._height,i=0;i<t.length;++i){var r=t[i].window;e=Math.max(r.width,e),n=Math.max(r.height,n)}e===this._width&&n===this._height||(this._width=e,this._height=n)},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var e=this._renderPasses.values(),n=e.next();!n.done;)n.value.destroy(),n=e.next();return this._commandBuffers.length=0,t.prototype.destroy.call(this)},n._activeRenderer=function(){var t=this.device;this._commandBuffers.push(t.commandBuffer);var e=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(Bp,e),this._descriptorSet.bindTexture(Bp,Cv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Up,e),this._descriptorSet.bindTexture(Up,Cv.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Ip.BINDING).destroy(),this._descriptorSet.getBuffer(Dp.BINDING).destroy(),this._descriptorSet.getBuffer(Rp.BINDING).destroy(),this._descriptorSet.getTexture(Bp).destroy(),this._descriptorSet.getTexture(Up).destroy())},N(e,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),e}(yx),wD=X((ED=PD).prototype,"renderTextures",[CD,Zc,bD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),TD=ED))||TD)),cB=[new uo(0,0,0,0),new uo(0,0,0,0),new uo(0,0,0,0)],lB=t("GbufferStage",(ID=qc("GbufferStage"),RD=El([tA]),DD=yl(),ID((LD=ND=function(t){function e(){var e;return q(e=t.call(this)||this,"renderQueues",OD,H(e)),e._renderQueues=[],e._renderArea=new no,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=bv("default"),e._batchedQueue=new sA,e._instancedQueue=new cA,e}F(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=rA(this.renderQueues[i])},n.destroy=function(){},n.render=function(t){this._instancedQueue.clear(),this._batchedQueue.clear();var e=this._pipeline,n=e.device;this._renderQueues.forEach(oA),e.generateRenderArea(t,this._renderArea),e.updateQuadVertexData(this._renderArea,t.window);for(var i=e.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===xv.INSTANCING){var p=_.getInstancedBuffer();p.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(p)}else if(f===xv.VB_MERGING){var d=_.getBatchedBuffer();d.merge(u,o,c.model),this._batchedQueue.queue.add(d)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(aA);var m=e.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),t.clearFlag&Yr.COLOR&&(e.pipelineSceneData.isHDR?Qv(cB[0],t.clearColor):(cB[0].x=t.clearColor.x,cB[0].y=t.clearColor.y,cB[0].z=t.clearColor.z)),cB[0].w=t.clearColor.w;var v=e.getPipelineRenderData().gbufferFrameBuffer,g=v.renderPass;m.beginRenderPass(g,v,this._renderArea,cB,t.clearDepth,t.clearStencil),m.setScissor(e.generateScissor(t)),m.setViewport(e.generateViewport(t)),m.bindDescriptorSet(Tp.GLOBAL,e.descriptorSet);for(var y=0;y<this.renderQueues.length;y++)this._renderQueues[y].recordCommandBuffer(n,g,m);this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),m.endRenderPass()},e}(Jy),ND.initInfo={name:"GbufferStage",priority:hx.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:JS.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:JS.BACK_TO_FRONT,stages:["default"]}]},OD=X((MD=LD).prototype,"renderQueues",[RD,Zc,DD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),BD=MD))||BD)),uB=[new uo(0,0,0,1)],hB=t("LightingStage",(FD=qc("LightingStage"),zD=El(hg),VD=yl(),GD=El([tA]),UD=yl(),FD((XD=qD=function(t){function e(){var e;return(e=t.call(this)||this)._deferredLitsBufs=null,e._maxDeferredLights=Kp.LIGHTS_PER_PASS,e._lightMeterScale=1e4,e._descriptorSet=null,e._renderArea=new no,e._uiPhase=void 0,q(e,"_deferredMaterial",jD,H(e)),q(e,"renderQueues",WD,H(e)),e._phaseID=bv("default"),e._renderQueues=[],e._uiPhase=new OA,e}F(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),!0},n.gatherLights=function(t){for(var e=this._pipeline,n=e.commandBuffers[0],i=t.scene.sphereLights,r=t.scene.spotLights,o=Kr.create(0,0,0,1),a=new Float32Array(4),s=t.exposure,c=0,l=fi.length,u=l*this._maxDeferredLights,h=0;h<i.length&&c<this._maxDeferredLights;h++,++c){var _=i[h];if(Kr.set(o,_.position.x,_.position.y,_.position.z,_.range),ks.sphereFrustum(o,t.frustum)){if(oi.toArray(a,_.position),a[3]=0,this._lightBufferData.set(a,c*l),oi.toArray(a,_.color),_.useColorTemperature){var f=_.colorTemperatureRGB;a[0]*=f.x,a[1]*=f.y,a[2]*=f.z}e.pipelineSceneData.isHDR?a[3]=_.luminance*s*this._lightMeterScale:a[3]=_.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=_.size,a[1]=_.range,a[2]=0,this._lightBufferData.set(a,c*l+2*u)}}for(var p=0;p<r.length&&c<this._maxDeferredLights;p++,++c){var d=r[p];if(Kr.set(o,d.position.x,d.position.y,d.position.z,d.range),ks.sphereFrustum(o,t.frustum)){if(oi.toArray(a,d.position),a[3]=1,this._lightBufferData.set(a,c*l+0*u),oi.toArray(a,d.color),d.useColorTemperature){var m=d.colorTemperatureRGB;a[0]*=m.x,a[1]*=m.y,a[2]*=m.z}e.pipelineSceneData.isHDR?a[3]=d.luminance*s*this._lightMeterScale:a[3]=d.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=d.size,a[1]=d.range,a[2]=d.spotAngle,this._lightBufferData.set(a,c*l+2*u),oi.toArray(a,d.direction),this._lightBufferData.set(a,c*l+3*u)}}var v=3*u+3;this._lightBufferData.set([c],v),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._uiPhase.activate(e);for(var i=e.device,r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=rA(this.renderQueues[r]);var o=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;o=Math.ceil(o/i.capabilities.uboOffsetAlignment)*i.capabilities.uboOffsetAlignment,this._deferredLitsBufs=i.createBuffer(new po(mr.UNIFORM|mr.TRANSFER_DST,yr.HOST|yr.DEVICE,o,i.capabilities.uboOffsetAlignment));var a=i.createBuffer(new mo(this._deferredLitsBufs,0,o));this._lightBufferData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT);var s=new jo(Sp.bindings);this._descriptorSetLayout=i.createDescriptorSetLayout(s),this._descriptorSet=i.createDescriptorSet(new Wo(this._descriptorSetLayout)),this._descriptorSet.bindBuffer(Yp.BINDING,a),this._planarQueue=new MA(this._pipeline),this._deferredMaterial&&(e.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},n.destroy=function(){var t;null===(t=this._deferredLitsBufs)||void 0===t||t.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},n.render=function(t){var e=this._pipeline,n=e.device,i=e.commandBuffers[0],r=e.pipelineSceneData,o=r.renderObjects;this.gatherLights(t),this._descriptorSet.update(),this._planarQueue.gatherShadowPasses(t,i),i.bindDescriptorSet(Tp.LOCAL,this._descriptorSet,[0]),e.generateRenderArea(t,this._renderArea),t.clearFlag&Yr.COLOR&&(uB[0].x=t.clearColor.x,uB[0].y=t.clearColor.y,uB[0].z=t.clearColor.z),uB[0].w=0;var a=e.getPipelineRenderData(),s=a.outputFrameBuffer,c=s.renderPass;e.pipelineUBO.updateShadowUBO(t),i.beginRenderPass(c,s,this._renderArea,uB,t.clearDepth,t.clearStencil),i.setScissor(e.generateScissor(t)),i.setViewport(e.generateViewport(t)),i.bindDescriptorSet(Tp.GLOBAL,e.descriptorSet);for(var l=r.deferredLightingMaterial.passes[0],u=l.getShaderVariant(),h=0;h<3;++h)l.descriptorSet.bindTexture(h,a.gbufferRenderTargets[h]),l.descriptorSet.bindSampler(h,a.sampler);l.descriptorSet.bindTexture(3,a.outputDepth),l.descriptorSet.bindSampler(3,a.sampler),l.descriptorSet.update(),i.bindDescriptorSet(Tp.MATERIAL,l.descriptorSet);var _=e.quadIAOffscreen,f=null;null!=l&&null!=u&&null!=_&&(f=Yv.getOrCreatePipelineState(n,l,u,c,_)),null!=f&&(i.bindPipelineState(f),i.bindInputAssembler(_),i.draw(_)),this._renderQueues.forEach(oA);for(var p=0,d=0,m=0,v=0;v<o.length;++v){var g=o[v],y=g.model.subModels;for(p=0;p<y.length;++p){var x=y[p].passes;for(d=0;d<x.length;++d)if(x[d].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(g,p,d)}}if(o.length>0){this._renderQueues.forEach(aA);for(var S=0;S<this._renderQueues.length;S++)this._renderQueues[S].recordCommandBuffer(n,c,i);this._planarQueue.recordCommandBuffer(n,c,i)}this._uiPhase.render(t,c),i.endRenderPass()},e}(Jy),qD.initInfo={name:"LightingStage",priority:hx.LIGHTING,tag:0},jD=X((HD=XD).prototype,"_deferredMaterial",[zD,Zc,VD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WD=X(HD.prototype,"renderQueues",[GD,Zc,UD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kD=HD))||kD)),_B=[new uo(0,0,0,1)],fB=t("PostProcessStage",(YD=qc("PostProcessStage"),KD=El(hg),JD=yl(),QD=El([tA]),ZD=yl(),YD((rB=iB=function(t){function e(){var e;return q(e=t.call(this)||this,"_postProcessMaterial",eB,H(e)),q(e,"renderQueues",nB,H(e)),e._renderArea=new no,e._uiPhase=new OA,e}F(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._postProcessMaterial&&(e.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(e)},n.destroy=function(){},n.render=function(t){var e=this._pipeline,n=e.device,i=e.pipelineSceneData,r=e.commandBuffers[0];e.pipelineUBO.updateCameraUBO(t);var o=t.viewport;this._renderArea.x=o.x*t.window.width,this._renderArea.y=o.y*t.window.height,this._renderArea.width=o.width*t.window.width,this._renderArea.height=o.height*t.window.height;var a=e.getPipelineRenderData(),s=t.window.framebuffer,c=e.getRenderPass(t.clearFlag,s);t.clearFlag&Yr.COLOR&&(_B[0].x=t.clearColor.x,_B[0].y=t.clearColor.y,_B[0].z=t.clearColor.z),_B[0].w=t.clearColor.w,r.beginRenderPass(c,s,this._renderArea,_B,t.clearDepth,t.clearStencil),r.bindDescriptorSet(Tp.GLOBAL,e.descriptorSet);var l=i.postprocessMaterial.passes[0],u=l.getShaderVariant();e.bloomEnabled?l.descriptorSet.bindTexture(0,a.bloom.combineTex):l.descriptorSet.bindTexture(0,a.outputRenderTargets[0]),l.descriptorSet.bindSampler(0,a.sampler),l.descriptorSet.update(),r.bindDescriptorSet(Tp.MATERIAL,l.descriptorSet);var h=t.window.swapchain?e.quadIAOnscreen:e.quadIAOffscreen,_=null;null!=l&&null!=u&&null!=h&&(_=Yv.getOrCreatePipelineState(n,l,u,c,h));var f=e.pipelineSceneData.renderObjects;null!=_&&f.length>0&&(r.bindPipelineState(_),r.bindInputAssembler(h),r.draw(h)),this._uiPhase.render(t,c),lg(n,c,r,e.profiler,t),r.endRenderPass()},e}(Jy),iB.initInfo={name:"PostProcessStage",priority:cx.POST_PROCESS,tag:0},eB=X((tB=rB).prototype,"_postProcessMaterial",[KD,Zc,JD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nB=X(tB.prototype,"renderQueues",[QD,Zc,ZD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$D=tB))||$D));!function(t){t[t.NONE=0]="NONE",t[t.FXAA=1]="FXAA"}(oB||(oB={}));var pB,dB,mB,vB,gB,yB,xB,SB,AB=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._antiAliasing=oB.NONE,e}F(e,t);var n=e.prototype;return n.onGlobalPipelineStateChanged=function(){this.updatePipelinePassInfo()},n.updateBloomPass=function(){if(this._bloomMaterial){var t=this._bloomMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently();for(var e=[],n=[],i=0;i<6;++i){var r=this._bloomMaterial.passes[1+i];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently();var o=this._bloomMaterial.passes[7+i];o.beginChangeStatesSilently(),o.tryCompile(),o.endChangeStatesSilently(),e.push(r.native),n.push(o.native)}var a=this._bloomMaterial.passes[13];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently()}},n.updatePostProcessPass=function(){if(this.postprocessMaterial){var t=this.postprocessMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently()}},n.initPipelinePassInfo=function(){var t=new hg;t._uuid="builtin-deferred-material",t.initialize({effectName:"deferred-lighting"});for(var e=0;e<t.passes.length;++e)t.passes[e].tryCompile();this._deferredLightingMaterial=t;var n=new hg;n._uuid="builtin-bloom-material",n.initialize({effectName:"bloom"});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._bloomMaterial=n;var r=new hg;r._uuid="builtin-post-process-material",ee.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=oB.FXAA),r.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var o=0;o<r.passes.length;++o)r.passes[o].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()},n.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},n.activate=function(e,n){return t.prototype.activate.call(this,e,n),this.initPipelinePassInfo(),!0},n.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},n.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1);var t=this._deferredLightingMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently()}},N(e,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(t){if(this._antiAliasing=t,this._postprocessMaterial){var e=this._postprocessMaterial.passes[0].defines;Object.assign(e,{ANTIALIAS_TYPE:t});var n=new hg;n.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:e});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._postprocessMaterial=n}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(t){this._bloomMaterial!==t&&t&&(this._bloomMaterial=t,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(t){this._postprocessMaterial!==t&&t&&(this._postprocessMaterial=t,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(t){this._deferredLightingMaterial!==t&&t&&(this._deferredLightingMaterial=t,this.updatePipelinePassInfo())}}]),e}(aB),CB=[new uo(0,0,0,1)],bB=function(){};bB.SIZE=4*(bB.COUNT=4+(bB.TEXTURE_SIZE_OFFSET=0));var TB,EB,wB,PB,IB,RB,DB,BB,MB,OB,NB=t("BloomStage",(pB=qc("BloomStage"),dB=El(hg),mB=yl(),pB((SB=xB=function(t){function e(){var e;return(e=t.call(this)||this).threshold=1,e.intensity=.8,e.iterations=2,q(e,"_bloomMaterial",yB,H(e)),e._renderArea=new no,e._bloomUBO=[],e}F(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._bloomMaterial&&(e.pipelineSceneData.bloomMaterial=this._bloomMaterial)},n.destroy=function(){},n.render=function(t){var e,n=this._pipeline;if(n.generateBloomRenderData(),((null===(e=t.window)||void 0===e?void 0:e.swapchain)||n.macros.CC_PIPELINE_TYPE)&&n.bloomEnabled&&0!==n.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var i=0;i<14;++i)this._bloomUBO[i]=n.device.createBuffer(new po(mr.UNIFORM|mr.TRANSFER_DST,yr.HOST|yr.DEVICE,bB.SIZE,bB.SIZE));t.clearFlag&Yr.COLOR&&(CB[0].x=t.clearColor.x,CB[0].y=t.clearColor.y,CB[0].z=t.clearColor.z),CB[0].w=t.clearColor.w,this._prefilterPass(t,n),this._downsamplePass(t,n),this._upsamplePass(t,n),this._combinePass(t,n)}},n._prefilterPass=function(t,e){e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var n=e.commandBuffers[0],i=e.pipelineSceneData.bloomMaterial.passes[0],r=e.getPipelineRenderData(),o=r.bloom,a=new Float32Array(bB.COUNT);a[bB.TEXTURE_SIZE_OFFSET+2]=this.threshold,n.updateBuffer(this._bloomUBO[0],a),n.beginRenderPass(o.renderPass,o.prefilterFramebuffer,this._renderArea,CB,0,0),n.bindDescriptorSet(Tp.GLOBAL,e.descriptorSet),i.descriptorSet.bindBuffer(0,this._bloomUBO[0]),i.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),i.descriptorSet.bindSampler(1,o.sampler),i.descriptorSet.update(),n.bindDescriptorSet(Tp.MATERIAL,i.descriptorSet);var s=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,c=null,l=i.getShaderVariant();null!=i&&null!=l&&null!=s&&(c=Yv.getOrCreatePipelineState(e.device,i,l,o.renderPass,s)),null!=c&&(n.bindPipelineState(c),n.bindInputAssembler(s),n.draw(s)),n.endRenderPass()},n._downsamplePass=function(t,e){e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var n=e.commandBuffers[0],i=e.pipelineSceneData.bloomMaterial,r=e.getPipelineRenderData().bloom,o=new Float32Array(bB.COUNT),a=0;a<this.iterations;++a){o[bB.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[bB.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[a+1],o),this._renderArea.width>>=1,this._renderArea.height>>=1,n.beginRenderPass(r.renderPass,r.downsampleFramebuffers[a],this._renderArea,CB,0,0);var s=i.passes[1+a],c=s.getShaderVariant();s.descriptorSet.bindBuffer(0,this._bloomUBO[a+1]),0===a?s.descriptorSet.bindTexture(1,r.prefiterTex):s.descriptorSet.bindTexture(1,r.downsampleTexs[a-1]),s.descriptorSet.bindSampler(1,r.sampler),s.descriptorSet.update(),n.bindDescriptorSet(Tp.MATERIAL,s.descriptorSet);var l=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,u=null;null!=s&&null!=c&&null!=l&&(u=Yv.getOrCreatePipelineState(e.device,s,c,r.renderPass,l)),null!=u&&(n.bindPipelineState(u),n.bindInputAssembler(l),n.draw(l)),n.endRenderPass()}},n._upsamplePass=function(t,e){var n=e.getPipelineRenderData().bloom;e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var i=e.commandBuffers[0],r=e.pipelineSceneData.bloomMaterial,o=new Float32Array(bB.COUNT),a=0;a<this.iterations;++a){var s=a+6+1;o[bB.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[bB.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[s],o),this._renderArea.width<<=1,this._renderArea.height<<=1,i.beginRenderPass(n.renderPass,n.upsampleFramebuffers[this.iterations-1-a],this._renderArea,CB,0,0);var c=r.passes[7+a],l=c.getShaderVariant();c.descriptorSet.bindBuffer(0,this._bloomUBO[s]),0===a?c.descriptorSet.bindTexture(1,n.downsampleTexs[this.iterations-1]):c.descriptorSet.bindTexture(1,n.upsampleTexs[this.iterations-a]),c.descriptorSet.bindSampler(1,n.sampler),c.descriptorSet.update(),i.bindDescriptorSet(Tp.MATERIAL,c.descriptorSet);var u=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,h=null;null!=c&&null!=l&&null!=u&&(h=Yv.getOrCreatePipelineState(e.device,c,l,n.renderPass,u)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()}},n._combinePass=function(t,e){e.generateRenderArea(t,this._renderArea);var n=e.commandBuffers[0],i=e.pipelineSceneData.bloomMaterial,r=e.getPipelineRenderData(),o=r.bloom,a=new Float32Array(bB.COUNT);a[bB.TEXTURE_SIZE_OFFSET+3]=this.intensity,n.updateBuffer(this._bloomUBO[13],a),n.beginRenderPass(o.renderPass,o.combineFramebuffer,this._renderArea,CB,0,0),n.bindDescriptorSet(Tp.GLOBAL,e.descriptorSet);var s=i.passes[13];s.descriptorSet.bindBuffer(0,this._bloomUBO[13]),s.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),s.descriptorSet.bindTexture(2,o.upsampleTexs[0]),s.descriptorSet.bindSampler(1,o.sampler),s.descriptorSet.bindSampler(2,o.sampler),s.descriptorSet.update(),n.bindDescriptorSet(Tp.MATERIAL,s.descriptorSet);var c=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,l=null,u=s.getShaderVariant();null!=s&&null!=u&&null!=c&&(l=Yv.getOrCreatePipelineState(e.device,s,u,o.renderPass,c)),null!=l&&(n.bindPipelineState(l),n.bindInputAssembler(c),n.draw(c)),n.endRenderPass()},e}(Jy),xB.initInfo={name:"BloomStage",priority:cx.BLOOM,tag:0},yB=X((gB=SB).prototype,"_bloomMaterial",[dB,Zc,mB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vB=gB))||vB)),LB=t("MainFlow",qc("MainFlow")((wB=EB=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var n=new lB;n.initialize(lB.initInfo),this._stages.push(n);var i=new hB;i.initialize(hB.initInfo),this._stages.push(i);var r=new NB;r.initialize(NB.initInfo),this._stages.push(r);var o=new fB;o.initialize(fB.initInfo),this._stages.push(o)}return!0},n.activate=function(e){t.prototype.activate.call(this,e)},n.render=function(e){t.prototype.render.call(this,e)},n.destroy=function(){t.prototype.destroy.call(this)},e}(Zy),EB.initInfo={name:mp,priority:_x.MAIN,stages:[]},TB=wB))||TB),FB=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).gbufferFrameBuffer=null,e.gbufferRenderTargets=[],e}return F(e,t),e}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),zB=t("DeferredPipeline",(PB=qc("DeferredPipeline"),IB=El([QS]),RB=yl(),PB((OB=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gbufferRenderPass=null,e._lightingRenderPass=null,q(e,"renderTextures",MB,H(e)),e}F(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._flows.length){var n=new eC;n.initialize(eC.initInfo),this._flows.push(n);var i=new LB;i.initialize(LB.initInfo),this._flows.push(i)}return!0},n.activate=function(e){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new AB,!(!t.prototype.activate.call(this,e)||!this._activeRenderer(e)&&(E(2402),1))},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var e=this._renderPasses.values(),n=e.next();!n.done;)n.value.destroy(),n=e.next();return this._commandBuffers.length=0,t.prototype.destroy.call(this)},n.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},n._activeRenderer=function(t){var e=this.device;this._commandBuffers.push(e.commandBuffer);var n=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(Bp,n),this._descriptorSet.bindTexture(Bp,Cv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Up,n),this._descriptorSet.bindTexture(Up,Cv.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new gx;if(!(i=this._createQuadInputAssembler()).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var r=this._createQuadInputAssembler();if(!r.quadIB||!r.quadVB||!r.quadIA)return!1;if(this._quadVBOnscreen=r.quadVB,this._quadIAOnscreen=r.quadIA,!this._gbufferRenderPass){var o=new No;o.format=fr.RGBA16F,o.loadOp=Mr.CLEAR,o.storeOp=Or.STORE;var a=new No;a.format=fr.RGBA16F,a.loadOp=Mr.CLEAR,a.storeOp=Or.STORE;var s=new No;s.format=fr.RGBA16F,s.loadOp=Mr.CLEAR,s.storeOp=Or.STORE;var c=new Lo;c.format=fr.DEPTH_STENCIL,c.depthLoadOp=Mr.CLEAR,c.depthStoreOp=Or.STORE,c.stencilLoadOp=Mr.CLEAR,c.stencilStoreOp=Or.STORE;var l=new Vo([o,a,s],c);this._gbufferRenderPass=e.createRenderPass(l)}if(!this._lightingRenderPass){var u=new No;u.format=fr.RGBA8,u.loadOp=Mr.CLEAR,u.storeOp=Or.STORE,u.endAccesses=[Nr.COLOR_ATTACHMENT_WRITE];var h=new Lo;h.format=fr.DEPTH_STENCIL,h.depthLoadOp=Mr.LOAD,h.depthStoreOp=Or.DISCARD,h.stencilLoadOp=Mr.LOAD,h.stencilStoreOp=Or.DISCARD,h.beginAccesses=[Nr.DEPTH_STENCIL_ATTACHMENT_WRITE],h.endAccesses=[Nr.DEPTH_STENCIL_ATTACHMENT_WRITE];var _=new Vo([u],h);this._lightingRenderPass=e.createRenderPass(_)}return this._width=t.width,this._height=t.height,this._generateDeferredRenderData(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Ip.BINDING).destroy(),this._descriptorSet.getBuffer(Dp.BINDING).destroy(),this._descriptorSet.getBuffer(Rp.BINDING).destroy(),this._descriptorSet.getTexture(Bp).destroy(),this._descriptorSet.getTexture(Up).destroy())},n._destroyDeferredData=function(){var t=this._pipelineRenderData;if(t){t.gbufferFrameBuffer&&t.gbufferFrameBuffer.destroy(),t.outputFrameBuffer&&t.outputFrameBuffer.destroy(),t.outputDepth&&t.outputDepth.destroy();for(var e=0;e<t.gbufferRenderTargets.length;e++)t.gbufferRenderTargets[e].destroy();t.gbufferRenderTargets.length=0;for(var n=0;n<t.outputRenderTargets.length;n++)t.outputRenderTargets[n].destroy();t.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},n._ensureEnoughSize=function(t){for(var e=this._width,n=this._height,i=0;i<t.length;++i){var r=t[i].window;e=Math.max(r.width,e),n=Math.max(r.height,n)}e===this._width&&n===this._height||(this._width=e,this._height=n,this._destroyDeferredData(),this._generateDeferredRenderData())},n._generateDeferredRenderData=function(){for(var t=this,e=this.device,n=this._pipelineRenderData=new FB,i=this.pipelineSceneData,r=0;r<3;++r)n.gbufferRenderTargets.push(e.createTexture(new xo(xr.TEX2D,Sr.COLOR_ATTACHMENT|Sr.SAMPLED,fr.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale)));n.outputDepth=e.createTexture(new xo(xr.TEX2D,Sr.DEPTH_STENCIL_ATTACHMENT|Sr.SAMPLED,fr.DEPTH_STENCIL,this._width*i.shadingScale,this._height*i.shadingScale)),n.gbufferFrameBuffer=e.createFramebuffer(new ko(this._gbufferRenderPass,n.gbufferRenderTargets,n.outputDepth)),n.outputRenderTargets.push(e.createTexture(new xo(xr.TEX2D,Sr.COLOR_ATTACHMENT|Sr.SAMPLED,fr.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale))),n.outputFrameBuffer=e.createFramebuffer(new ko(this._lightingRenderPass,n.outputRenderTargets,null)),this.on(Qy.ATTACHMENT_SCALE_CAHNGED,(function(e){n.sampler=e<1?t.globalDSManager.pointSampler:t.globalDSManager.linearSampler,t.applyFramebufferRatio(n.gbufferFrameBuffer),t.applyFramebufferRatio(n.outputFrameBuffer)})),n.sampler=this.globalDSManager.linearSampler},e}(yx),MB=X((BB=OB).prototype,"renderTextures",[IB,Zc,RB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),DB=BB))||DB));function VB(){var t=new sB;return t.initialize({flows:[]}),t}var GB=new li,UB=function(){var t=e.prototype;function e(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.isPause=!1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return t.pauseRendering=function(){this.isPause=!0},t.resumeRendering=function(){this.isPause=!1},t.main=function(t){if(null!=t){if(window._CCSettings&&window._CCSettings.splashScreen){var e=this.settings=window._CCSettings.splashScreen;e.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,e.base64src=this.settings.base64src||"",e.effect=this.settings.effect||"FADE-INOUT",e.clearColor=this.settings.clearColor||new uo(.88,.88,.88,1),e.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,e.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new uo(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{i.view.resizeWithBrowserSize(!0);var n=window._CCSettings.designResolution;n?i.view.setDesignResolutionSize(n.width,n.height,n.policy):i.view.setDesignResolutionSize(960,640,4),this.device=t.device,this.swapchain=t.mainWindow.swapchain,this.framebuffer=t.mainWindow.framebuffer,i.game.once(i.Game.EVENT_GAME_INITED,(function(){i.director._lateUpdate=performance.now()}),i.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else d("RENDER ROOT IS NULL.")},t.setOnFinish=function(t){if(this._directCall&&t)return e._ins=void 0,void t();this.callBack=t},t._tryToStart=function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),i.game.resume())},t.preInit=function(){var t=this.settings.clearColor;this.clearColors=[new uo(t.x,t.y,t.z,t.w)];var e=this.device,n=this.swapchain;this.renderArea=new no(0,0,n.width,n.height),this.cmdBuff=e.commandBuffer;var i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),r=4*Float32Array.BYTES_PER_ELEMENT,o=4*r;this.vertexBuffers=e.createBuffer(new po(mr.VERTEX|mr.TRANSFER_DST,yr.DEVICE,o,r)),this.vertexBuffers.update(i);var a=new Uint16Array([0,1,2,1,3,2]),s=Uint16Array.BYTES_PER_ELEMENT,c=6*s;this.indicesBuffers=e.createBuffer(new po(mr.INDEX|mr.TRANSFER_DST,yr.DEVICE,c,s)),this.indicesBuffers.update(a);var l=[new Bo("a_position",fr.RG32F),new Bo("a_texCoord",fr.RG32F)],u=new Oo(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=e.createInputAssembler(u),this.projection=new Ei,Ei.ortho(this.projection,-1,1,-1,1,-1,1,e.capabilities.clipSpaceMinZ,e.capabilities.clipSpaceSignY,n.surfaceTransform)},t.init=function(){var t=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),i.game.pause(),this.handle=requestAnimationFrame((function e(n){if(!t.cancelAnimate){var i=t.settings,r=t.device,o=t.swapchain;Ei.ortho(t.projection,-1,1,-1,1,-1,1,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY,o.surfaceTransform);var a=o.width,s=o.height,c=a<s?a:s;t.startTime<0&&(t.startTime=n);var l=n-t.startTime,u=n_(kn(l/i.totalTime));"NONE"===i.effect&&(u=1);var h=t.logoTexture.width,_=t.logoTexture.height,f=c*i.displayRatio,p=f*h/_,d=f;if(o.surfaceTransform!==hr.ROTATE_90&&o.surfaceTransform!==hr.ROTATE_270||(p=f*a/s,d=f*_/h*s/a),t.logoMat.setProperty("resolution",GB.set(a,s),0),t.logoMat.setProperty("scale",GB.set(p,d),0),t.logoMat.setProperty("translate",GB.set(.5*a,.5*s),0),t.logoMat.setProperty("percent",u),t.logoMat.setProperty("u_projection",t.projection),t.logoMat.passes[0].update(),i.displayWatermark&&t.watermarkMat){var m=.5*c,v=t.watermarkTexture.width,g=m,y=m*t.watermarkTexture.height/v;o.surfaceTransform!==hr.ROTATE_90&&o.surfaceTransform!==hr.ROTATE_270||(g=.5*m,y=m*a/s*.5),t.watermarkMat.setProperty("resolution",GB.set(a,s),0),t.watermarkMat.setProperty("scale",GB.set(g,y),0),t.watermarkMat.setProperty("translate",GB.set(.5*a,.1*s),0),t.watermarkMat.setProperty("percent",u),t.watermarkMat.setProperty("u_projection",t.projection),t.watermarkMat.passes[0].update()}t.isPause||(t.frame(),l>i.totalTime&&(t.splashFinish=!0)),requestAnimationFrame(e)}}))},t.hide=function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))},t.initLogo=function(){var t=this.device;this.logoMat=new hg,this.logoMat.initialize({effectName:"splash-screen"});var e=new Ao;e.addressU=Er.CLAMP,e.addressV=Er.CLAMP,e.addressW=Er.CLAMP,this.sampler=t.getSampler(e),this.logoTexture=t.createTexture(new xo(xr.TEX2D,Sr.SAMPLED|Sr.TRANSFER_DST,fr.RGBA8,this.logoImage.width,this.logoImage.height));var n=this.logoMat.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.logoTexture),this.shader=n.getShaderVariant();var r=n.descriptorSet;r.bindSampler(i,this.sampler),r.update();var o=new co;o.texExtent.width=this.logoImage.width,o.texExtent.height=this.logoImage.height,o.texExtent.depth=1,t.copyTexImagesToTexture([this.logoImage],this.logoTexture,[o])},t.initWarterMark=function(){var t=document.createElement("canvas");t.width=330,t.height=30,t.style.width=""+t.width,t.style.height=""+t.height;var e=t.getContext("2d");e.font="18px Arial",e.textBaseline="top",e.textAlign="left",e.fillStyle="`#424242`";var n="Powered by Cocos Creator",i=e.measureText(n);e.fillText(n,(330-i.width)/2,6);var r=new co;r.texExtent.width=t.width,r.texExtent.height=t.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new xo(xr.TEX2D,Sr.SAMPLED|Sr.TRANSFER_DST,fr.RGBA8,t.width,t.height)),this.device.copyTexImagesToTexture([t],this.watermarkTexture,[r]),this.watermarkMat=new hg,this.watermarkMat.initialize({effectName:"splash-screen"});var o=this.watermarkMat.passes[0],a=o.getBinding("mainTexture");o.bindTexture(a,this.watermarkTexture),o.descriptorSet.update()},t.frame=function(){var t=this.device,e=this.swapchain;t.acquire([e]);var n=this.cmdBuff,i=this.framebuffer,r=this.renderArea;r.width=e.width,r.height=e.height,n.begin(),n.beginRenderPass(i.renderPass,i,r,this.clearColors,1,0);var o=this.logoMat.passes[0],a=Yv.getOrCreatePipelineState(t,o,this.shader,i.renderPass,this.quadAssmebler);if(n.bindPipelineState(a),n.bindDescriptorSet(Tp.MATERIAL,o.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var s=this.watermarkMat.passes[0],c=Yv.getOrCreatePipelineState(t,s,this.shader,i.renderPass,this.quadAssmebler);n.bindPipelineState(c),n.bindDescriptorSet(Tp.MATERIAL,s.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler)}n.endRenderPass(),n.end(),t.flushCommands([n]),t.queue.submit([n]),t.present()},t.destroy=function(){this.callBack=null,this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,e._ins=void 0},N(e,[{key:"splashFinish",set:function(t){this._splashFinish=t,this._tryToStart()}},{key:"loadFinish",set:function(t){this._loadFinish=t,this._tryToStart()}}],[{key:"instance",get:function(){return e._ins||(e._ins=new e),e._ins}}]),e}();UB._ins=void 0,i.internal.SplashScreen=UB;var kB={topLeft:i.v2(0,0),topRight:i.v2(0,0),top:i.v2(0,0),bottomLeft:i.v2(0,0),bottomRight:i.v2(0,0),bottom:i.v2(0,0),center:i.v2(0,0),left:i.v2(0,0),right:i.v2(0,0),width:0,height:0,init:function(t){var e=this.width=t.width,n=this.height=t.height,i=t.x,r=t.y,o=r+n,a=i+e;this.topLeft.x=i,this.topLeft.y=o,this.topRight.x=a,this.topRight.y=o,this.top.x=i+e/2,this.top.y=o,this.bottomLeft.x=i,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=i+e/2,this.bottom.y=r,this.center.x=i+e/2,this.center.y=r+n/2,this.left.x=i,this.left.y=r+n/2,this.right.x=a,this.right.y=r+n/2}};i.visibleRect=kB;var HB=t("Event",function(){function t(t,e){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=t,this.bubbles=!!e}var e=t.prototype;return e.unuse=function(){this.type=t.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=t.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},e.reuse=function(t,e){this.type=t,this.bubbles=e||!1},e.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},e.getCurrentTarget=function(){return this.currentTarget},e.getType=function(){return this.type},t}());HB.NO_TYPE="no_type",HB.TOUCH="touch",HB.MOUSE="mouse",HB.KEYBOARD="keyboard",HB.ACCELERATION="acceleration",HB.NONE=0,HB.CAPTURING_PHASE=1,HB.AT_TARGET=2,HB.BUBBLING_PHASE=3,i.Event=HB;var jB=t("EventAcceleration",function(t){function e(e,n){var i;return(i=t.call(this,EE.DEVICEMOTION,n)||this).acc=void 0,i.acc=e,i}return F(e,t),e}(HB));HB.EventAcceleration=jB;var WB=t("EventKeyboard",function(t){function e(e,n,i){var r;return"boolean"==typeof n&&(n=n?EE.KEY_DOWN:EE.KEY_UP),(r=t.call(this,n,i)||this).keyCode=void 0,r.rawEvent=void 0,r._isPressed=void 0,r._isPressed=n!==EE.KEY_UP,"number"==typeof e?r.keyCode=e:(r.keyCode=e.keyCode,r.rawEvent=e),r}return F(e,t),N(e,[{key:"isPressed",get:function(){return this._isPressed}}]),e}(HB));HB.EventKeyboard=WB;var qB=t("EventMouse",function(t){function e(n,i,r){var o;return(o=t.call(this,n,i)||this).movementX=0,o.movementY=0,o.preventSwallow=!1,o._eventType=void 0,o._button=e.BUTTON_MISSING,o._x=0,o._y=0,o._prevX=0,o._prevY=0,o._scrollX=0,o._scrollY=0,o._eventType=n,r&&(o._prevX=r.x,o._prevY=r.y),o}F(e,t);var n=e.prototype;return n.setScrollData=function(t,e){this._scrollX=t,this._scrollY=e},n.getScrollX=function(){return this._scrollX},n.getScrollY=function(){return this._scrollY},n.setLocation=function(t,e){this._x=t,this._y=e},n.getLocation=function(t){return t||(t=new li),li.set(t,this._x,this._y),t},n.getLocationInView=function(t){return t||(t=new li),li.set(t,this._x,i.view._designResolutionSize.height-this._y),t},n.getUILocation=function(t){return t||(t=new li),li.set(t,this._x,this._y),i.view._convertToUISpace(t),t},n.getPreviousLocation=function(t){return t||(t=new li),li.set(t,this._prevX,this._prevY),t},n.getUIPreviousLocation=function(t){return t||(t=new li),li.set(t,this._prevX,this._prevY),i.view._convertToUISpace(t),t},n.getDelta=function(t){return t||(t=new li),li.set(t,this._x-this._prevX,this._y-this._prevY),t},n.getDeltaX=function(){return this._x-this._prevX},n.getDeltaY=function(){return this._y-this._prevY},n.getUIDelta=function(t){return t||(t=new li),li.set(t,(this._x-this._prevX)/i.view.getScaleX(),(this._y-this._prevY)/i.view.getScaleY()),t},n.getUIDeltaX=function(){return(this._x-this._prevX)/i.view.getScaleX()},n.getUIDeltaY=function(){return(this._y-this._prevY)/i.view.getScaleY()},n.setButton=function(t){this._button=t},n.getButton=function(){return this._button},n.getLocationX=function(){return this._x},n.getLocationY=function(){return this._y},n.getUILocationX=function(){var t=i.view.getViewportRect();return(this._x-t.x)/i.view.getScaleX()},n.getUILocationY=function(){var t=i.view.getViewportRect();return(this._y-t.y)/i.view.getScaleY()},N(e,[{key:"eventType",get:function(){return this._eventType}}]),e}(HB));qB.BUTTON_MISSING=-1,qB.BUTTON_LEFT=0,qB.BUTTON_RIGHT=2,qB.BUTTON_MIDDLE=1,qB.BUTTON_4=3,qB.BUTTON_5=4,qB.BUTTON_6=5,qB.BUTTON_7=6,qB.BUTTON_8=7,HB.EventMouse=qB;var XB=new li,YB=t("EventTouch",function(t){function e(e,n,i,r){var o;return void 0===r&&(r=[]),(o=t.call(this,i,n)||this).touch=null,o.simulate=!1,o.preventSwallow=!1,o._eventCode=void 0,o._touches=void 0,o._allTouches=void 0,o._eventCode=i,o._touches=e||[],o._allTouches=r,o}F(e,t);var n=e.prototype;return n.getEventCode=function(){return this._eventCode},n.getTouches=function(){return this._touches},n.getAllTouches=function(){return this._allTouches},n.setLocation=function(t,e){this.touch&&this.touch.setTouchInfo(this.touch.getID(),t,e)},n.getLocation=function(t){return this.touch?this.touch.getLocation(t):new li},n.getUILocation=function(t){return this.touch?this.touch.getUILocation(t):new li},n.getLocationInView=function(t){return this.touch?this.touch.getLocationInView(t):new li},n.getPreviousLocation=function(t){return this.touch?this.touch.getPreviousLocation(t):new li},n.getStartLocation=function(t){return this.touch?this.touch.getStartLocation(t):new li},n.getUIStartLocation=function(t){return this.touch?this.touch.getUIStartLocation(t):new li},n.getID=function(){return this.touch?this.touch.getID():null},n.getDelta=function(t){return this.touch?this.touch.getDelta(t):new li},n.getUIDelta=function(t){return this.touch?this.touch.getUIDelta(t):new li},n.getDeltaX=function(){return this.touch?this.touch.getDelta(XB).x:0},n.getDeltaY=function(){return this.touch?this.touch.getDelta(XB).y:0},n.getLocationX=function(){return this.touch?this.touch.getLocationX():0},n.getLocationY=function(){return this.touch?this.touch.getLocationY():0},e}(HB));YB.MAX_TOUCHES=5,HB.EventTouch=YB;var KB,JB=t("Acceleration",(function(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=e,this.z=n,this.timestamp=i}));!function(t){t[t.NONE=0]="NONE",t[t.MOBILE_BACK=6]="MOBILE_BACK",t[t.BACKSPACE=8]="BACKSPACE",t[t.TAB=9]="TAB",t[t.ENTER=13]="ENTER",t[t.SHIFT_LEFT=16]="SHIFT_LEFT",t[t.CTRL_LEFT=17]="CTRL_LEFT",t[t.ALT_LEFT=18]="ALT_LEFT",t[t.PAUSE=19]="PAUSE",t[t.CAPS_LOCK=20]="CAPS_LOCK",t[t.ESCAPE=27]="ESCAPE",t[t.SPACE=32]="SPACE",t[t.PAGE_UP=33]="PAGE_UP",t[t.PAGE_DOWN=34]="PAGE_DOWN",t[t.END=35]="END",t[t.HOME=36]="HOME",t[t.ARROW_LEFT=37]="ARROW_LEFT",t[t.ARROW_UP=38]="ARROW_UP",t[t.ARROW_RIGHT=39]="ARROW_RIGHT",t[t.ARROW_DOWN=40]="ARROW_DOWN",t[t.INSERT=45]="INSERT",t[t.DELETE=46]="DELETE",t[t.DIGIT_0=48]="DIGIT_0",t[t.DIGIT_1=49]="DIGIT_1",t[t.DIGIT_2=50]="DIGIT_2",t[t.DIGIT_3=51]="DIGIT_3",t[t.DIGIT_4=52]="DIGIT_4",t[t.DIGIT_5=53]="DIGIT_5",t[t.DIGIT_6=54]="DIGIT_6",t[t.DIGIT_7=55]="DIGIT_7",t[t.DIGIT_8=56]="DIGIT_8",t[t.DIGIT_9=57]="DIGIT_9",t[t.KEY_A=65]="KEY_A",t[t.KEY_B=66]="KEY_B",t[t.KEY_C=67]="KEY_C",t[t.KEY_D=68]="KEY_D",t[t.KEY_E=69]="KEY_E",t[t.KEY_F=70]="KEY_F",t[t.KEY_G=71]="KEY_G",t[t.KEY_H=72]="KEY_H",t[t.KEY_I=73]="KEY_I",t[t.KEY_J=74]="KEY_J",t[t.KEY_K=75]="KEY_K",t[t.KEY_L=76]="KEY_L",t[t.KEY_M=77]="KEY_M",t[t.KEY_N=78]="KEY_N",t[t.KEY_O=79]="KEY_O",t[t.KEY_P=80]="KEY_P",t[t.KEY_Q=81]="KEY_Q",t[t.KEY_R=82]="KEY_R",t[t.KEY_S=83]="KEY_S",t[t.KEY_T=84]="KEY_T",t[t.KEY_U=85]="KEY_U",t[t.KEY_V=86]="KEY_V",t[t.KEY_W=87]="KEY_W",t[t.KEY_X=88]="KEY_X",t[t.KEY_Y=89]="KEY_Y",t[t.KEY_Z=90]="KEY_Z",t[t.NUM_0=96]="NUM_0",t[t.NUM_1=97]="NUM_1",t[t.NUM_2=98]="NUM_2",t[t.NUM_3=99]="NUM_3",t[t.NUM_4=100]="NUM_4",t[t.NUM_5=101]="NUM_5",t[t.NUM_6=102]="NUM_6",t[t.NUM_7=103]="NUM_7",t[t.NUM_8=104]="NUM_8",t[t.NUM_9=105]="NUM_9",t[t.NUM_MULTIPLY=106]="NUM_MULTIPLY",t[t.NUM_PLUS=107]="NUM_PLUS",t[t.NUM_SUBTRACT=109]="NUM_SUBTRACT",t[t.NUM_DECIMAL=110]="NUM_DECIMAL",t[t.NUM_DIVIDE=111]="NUM_DIVIDE",t[t.F1=112]="F1",t[t.F2=113]="F2",t[t.F3=114]="F3",t[t.F4=115]="F4",t[t.F5=116]="F5",t[t.F6=117]="F6",t[t.F7=118]="F7",t[t.F8=119]="F8",t[t.F9=120]="F9",t[t.F10=121]="F10",t[t.F11=122]="F11",t[t.F12=123]="F12",t[t.NUM_LOCK=144]="NUM_LOCK",t[t.SCROLL_LOCK=145]="SCROLL_LOCK",t[t.SEMICOLON=186]="SEMICOLON",t[t.EQUAL=187]="EQUAL",t[t.COMMA=188]="COMMA",t[t.DASH=189]="DASH",t[t.PERIOD=190]="PERIOD",t[t.SLASH=191]="SLASH",t[t.BACK_QUOTE=192]="BACK_QUOTE",t[t.BRACKET_LEFT=219]="BRACKET_LEFT",t[t.BACKSLASH=220]="BACKSLASH",t[t.BRACKET_RIGHT=221]="BRACKET_RIGHT",t[t.QUOTE=222]="QUOTE",t[t.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",t[t.CTRL_RIGHT=2001]="CTRL_RIGHT",t[t.ALT_RIGHT=2002]="ALT_RIGHT",t[t.NUM_ENTER=2003]="NUM_ENTER"}(KB||(KB=t("KeyCode",{})));var QB=new li,ZB=t("Touch",function(){function t(t,e,n){void 0===n&&(n=0),this._point=new li,this._prevPoint=new li,this._lastModified=0,this._id=0,this._startPoint=new li,this._startPointCaptured=!1,this.setTouchInfo(n,t,e)}var e=t.prototype;return e.getLocation=function(t){return t||(t=new li),t.set(this._point.x,this._point.y),t},e.getLocationX=function(){return this._point.x},e.getLocationY=function(){return this._point.y},e.getUILocation=function(t){return t||(t=new li),t.set(this._point.x,this._point.y),i.view._convertToUISpace(t),t},e.getUILocationX=function(){var t=i.view.getViewportRect();return(this._point.x-t.x)/i.view.getScaleX()},e.getUILocationY=function(){var t=i.view.getViewportRect();return(this._point.y-t.y)/i.view.getScaleY()},e.getPreviousLocation=function(t){return t||(t=new li),t.set(this._prevPoint.x,this._prevPoint.y),t},e.getUIPreviousLocation=function(t){return t||(t=new li),t.set(this._prevPoint.x,this._prevPoint.y),i.view._convertToUISpace(t),t},e.getStartLocation=function(t){return t||(t=new li),t.set(this._startPoint.x,this._startPoint.y),t},e.getUIStartLocation=function(t){return t||(t=new li),t.set(this._startPoint.x,this._startPoint.y),i.view._convertToUISpace(t),t},e.getDelta=function(t){return t||(t=new li),t.set(this._point),t.subtract(this._prevPoint),t},e.getUIDelta=function(t){return t||(t=new li),QB.set(this._point),QB.subtract(this._prevPoint),t.set(i.view.getScaleX(),i.view.getScaleY()),li.divide(t,QB,t),t},e.getLocationInView=function(t){return t||(t=new li),t.set(this._point.x,i.view._designResolutionSize.height-this._point.y),t},e.getPreviousLocationInView=function(t){return t||(t=new li),t.set(this._prevPoint.x,i.view._designResolutionSize.height-this._prevPoint.y),t},e.getStartLocationInView=function(t){return t||(t=new li),t.set(this._startPoint.x,i.view._designResolutionSize.height-this._startPoint.y),t},e.getID=function(){return this._id},e.setTouchInfo=function(t,e,n){void 0===t&&(t=0),this._prevPoint=this._point,this._point=new li(e||0,n||0),this._id=t,this._startPointCaptured||(this._startPoint=new li(this._point),this._startPointCaptured=!0)},e.setPoint=function(t,e){"object"==typeof t?(this._point.x=t.x,this._point.y=t.y):(this._point.x=t||0,this._point.y=e||0),this._lastModified=i.game.frameStartTime},e.setPrevPoint=function(t,e){this._prevPoint="object"==typeof t?new li(t.x,t.y):new li(t||0,e||0),this._lastModified=i.game.frameStartTime},N(t,[{key:"lastModified",get:function(){return this._lastModified}}]),t}());i.Touch=ZB;var $B,tM,eM=function(){function t(){this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new pn,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,dn.browserType===cn.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}var e=t.prototype;return e._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},e._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},e._didAccelerate=function(t){var e=performance.now();if(!(e-this._accelTimer<this._intervalInMileSeconds)){this._accelTimer=e;var n=0,i=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){var o=t.accelerationIncludingGravity;n=.1*((null==o?void 0:o.x)||0),i=.1*((null==o?void 0:o.y)||0),r=.1*((null==o?void 0:o.z)||0)}else{var a=t;n=(a.gamma||0)/90*.981,i=-(a.beta||0)/90*.981,r=(a.alpha||0)/90*.981}if(Ku.isFrameRotated){var s=n;n=-i,i=s}var c=n;90===window.orientation?(n=-i,i=c):-90===window.orientation?(n=i,i=-c):180===window.orientation&&(n=-n,i=-i),dn.os===hn.ANDROID&&dn.browserType!==cn.MOBILE_QQ&&(n=-n,i=-i);var l=performance.now(),u=new JB(n,i,r,l),h=new jB(u);this._eventTarget.emit(wE.DEVICEMOTION,h)}},e.start=function(){var t=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(e){"granted"===e&&t._registerEvent()})).catch((function(){})):this._registerEvent()},e.stop=function(){this._unregisterEvent()},e.setInterval=function(t){this._intervalInMileSeconds=t},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}(),nM={Backspace:KB.BACKSPACE,Tab:KB.TAB,Enter:KB.ENTER,ShiftLeft:KB.SHIFT_LEFT,ControlLeft:KB.CTRL_LEFT,AltLeft:KB.ALT_LEFT,ShiftRight:KB.SHIFT_RIGHT,ControlRight:KB.CTRL_RIGHT,AltRight:KB.ALT_RIGHT,Pause:KB.PAUSE,CapsLock:KB.CAPS_LOCK,Escape:KB.ESCAPE,Space:KB.SPACE,PageUp:KB.PAGE_UP,PageDown:KB.PAGE_DOWN,End:KB.END,Home:KB.HOME,ArrowLeft:KB.ARROW_LEFT,ArrowUp:KB.ARROW_UP,ArrowRight:KB.ARROW_RIGHT,ArrowDown:KB.ARROW_DOWN,Insert:KB.INSERT,Delete:KB.DELETE,Digit0:KB.DIGIT_0,Digit1:KB.DIGIT_1,Digit2:KB.DIGIT_2,Digit3:KB.DIGIT_3,Digit4:KB.DIGIT_4,Digit5:KB.DIGIT_5,Digit6:KB.DIGIT_6,Digit7:KB.DIGIT_7,Digit8:KB.DIGIT_8,Digit9:KB.DIGIT_9,KeyA:KB.KEY_A,KeyB:KB.KEY_B,KeyC:KB.KEY_C,KeyD:KB.KEY_D,KeyE:KB.KEY_E,KeyF:KB.KEY_F,KeyG:KB.KEY_G,KeyH:KB.KEY_H,KeyI:KB.KEY_I,KeyJ:KB.KEY_J,KeyK:KB.KEY_K,KeyL:KB.KEY_L,KeyM:KB.KEY_M,KeyN:KB.KEY_N,KeyO:KB.KEY_O,KeyP:KB.KEY_P,KeyQ:KB.KEY_Q,KeyR:KB.KEY_R,KeyS:KB.KEY_S,KeyT:KB.KEY_T,KeyU:KB.KEY_U,KeyV:KB.KEY_V,KeyW:KB.KEY_W,KeyX:KB.KEY_X,KeyY:KB.KEY_Y,KeyZ:KB.KEY_Z,Numpad0:KB.NUM_0,Numpad1:KB.NUM_1,Numpad2:KB.NUM_2,Numpad3:KB.NUM_3,Numpad4:KB.NUM_4,Numpad5:KB.NUM_5,Numpad6:KB.NUM_6,Numpad7:KB.NUM_7,Numpad8:KB.NUM_8,Numpad9:KB.NUM_9,NumpadMultiply:KB.NUM_MULTIPLY,NumpadAdd:KB.NUM_PLUS,NumpadSubtract:KB.NUM_SUBTRACT,NumpadDecimal:KB.NUM_DECIMAL,NumpadDivide:KB.NUM_DIVIDE,NumpadEnter:KB.NUM_ENTER,F1:KB.F1,F2:KB.F2,F3:KB.F3,F4:KB.F4,F5:KB.F5,F6:KB.F6,F7:KB.F7,F8:KB.F8,F9:KB.F9,F10:KB.F10,F11:KB.F11,F12:KB.F12,NumLock:KB.NUM_LOCK,ScrollLock:KB.SCROLL_LOCK,Semicolon:KB.SEMICOLON,Equal:KB.EQUAL,Comma:KB.COMMA,Minus:KB.DASH,Period:KB.PERIOD,Slash:KB.SLASH,Backquote:KB.BACK_QUOTE,BracketLeft:KB.BRACKET_LEFT,Backslash:KB.BACKSLASH,BracketRight:KB.BRACKET_RIGHT,Quote:KB.QUOTE},iM=function(){function t(){this._eventTarget=new pn,this._registerEvent()}var e=t.prototype;return e._registerEvent=function(){var t=this,e=document.getElementById("GameCanvas");null==e||e.addEventListener("keydown",(function(e){if(e.stopPropagation(),e.preventDefault(),e.repeat){var n=t._getInputEvent(e,wE.KEY_PRESSING);t._eventTarget.emit(wE.KEY_PRESSING,n)}else{var i=t._getInputEvent(e,wE.KEY_DOWN);t._eventTarget.emit(wE.KEY_DOWN,i)}})),null==e||e.addEventListener("keyup",(function(e){var n=t._getInputEvent(e,wE.KEY_UP);e.stopPropagation(),e.preventDefault(),t._eventTarget.emit(wE.KEY_UP,n)}))},e._getInputEvent=function(t,e){var n,i=(n=t.code,nM[n]||KB.NONE);return new WB(i,e)},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}(),rM=function(){function t(){this._canvas=void 0,this._eventTarget=new pn,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new li,dn.hasFeature(fn.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var e=t.prototype;return e._getCanvasRect=function(){var t=this._canvas,e=null==t?void 0:t.getBoundingClientRect();return e?new Mi(e.x,e.y,e.width,e.height):new Mi(0,0,0,0)},e._getLocation=function(t){var e=this._getCanvasRect(),n=Ku.devicePixelRatio,i=this._pointLocked?this._preMousePos.x/n+t.movementX:t.clientX-e.x,r=this._pointLocked?this._preMousePos.y/n-t.movementY:e.y+e.height-t.clientY;return new li(i*=n,r*=n)},e._registerEvent=function(){var t,e,n,i,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(t=this._canvas)||void 0===t||t.addEventListener("mousedown",this._createCallback(wE.MOUSE_DOWN)),null===(e=this._canvas)||void 0===e||e.addEventListener("mousemove",this._createCallback(wE.MOUSE_MOVE));var o=this._createCallback(wE.MOUSE_UP);window.addEventListener("mouseup",o),null===(n=this._canvas)||void 0===n||n.addEventListener("mouseup",o),null===(i=this._canvas)||void 0===i||i.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()},e._registerPointerLockEvent=function(){var t=this,e=function(){var e=t._canvas;document.pointerLockElement===e||document.mozPointerLockElement===e?t._pointLocked=!0:t._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",e,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",e,!1)},e._createCallback=function(t){var e=this;return function(n){var i,r=e._getLocation(n),o=n.button;switch(t){case wE.MOUSE_DOWN:null===(i=e._canvas)||void 0===i||i.focus(),e._isPressed=!0;break;case wE.MOUSE_UP:e._isPressed=!1;break;case wE.MOUSE_MOVE:e._isPressed||(o=qB.BUTTON_MISSING)}var a=new qB(t,!1,e._preMousePos);a.setLocation(r.x,r.y),a.setButton(o),a.movementX=n.movementX,a.movementY=n.movementY,e._preMousePos.set(r.x,r.y),n.stopPropagation(),n.target===e._canvas&&n.preventDefault(),e._eventTarget.emit(t,a)}},e._handleMouseWheel=function(t){var e=wE.MOUSE_WHEEL,n=this._getLocation(t),i=t.button,r=new qB(e,!1,this._preMousePos);r.setLocation(n.x,n.y),r.setButton(i),r.movementX=t.movementX,r.movementY=t.movementY,r.setScrollData(5*t.deltaX,5*-t.deltaY),this._preMousePos.set(n.x,n.y),t.stopPropagation(),t.target===this._canvas&&t.preventDefault(),this._eventTarget.emit(e,r)},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}(),oM=new li,aM=new(function(){function t(){this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}var e=t.prototype;return e._cloneTouch=function(t){var e=t.getID();t.getStartLocation(oM);var n=new ZB(oM.x,oM.y,e);return t.getLocation(oM),n.setPoint(oM.x,oM.y),t.getPreviousLocation(oM),n.setPrevPoint(oM),n},e._createTouch=function(t,e,n){if(this._touchMap.has(t))console.log("Cannot create the same touch object.");else{if(!this._checkTouchMapSizeMoreThanMax(t)){var i=new ZB(e,n,t);return this._touchMap.set(t,i),this._updateTouch(i,e,n),this._cloneTouch(i)}console.log("The touches is more than MAX_TOUCHES.")}},e.releaseTouch=function(t){this._touchMap.has(t)&&this._touchMap.delete(t)},e.getTouch=function(t,e,n){var i=this._touchMap.get(t);return i?this._updateTouch(i,e,n):i=this._createTouch(t,e,n),i?this._cloneTouch(i):void 0},e.getAllTouches=function(){var t=this,e=[];return this._touchMap.forEach((function(n){if(n){var i=t._cloneTouch(n);e.push(i)}})),e},e._updateTouch=function(t,e,n){t.getLocation(oM),t.setPrevPoint(oM),t.setPoint(e,n)},e._checkTouchMapSizeMoreThanMax=function(t){var e=this;if(this._touchMap.has(t))return!1;var n=ee.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<n)return!1;var i=performance.now();return this._touchMap.forEach((function(t){i-t.lastModified>ee.TOUCH_TIMEOUT&&(console.log("The touches is more than MAX_TOUCHES, release touch id "+t.getID()+"."),e.releaseTouch(t.getID()))})),n>=this._touchMap.size},t}()),sM=function(){function t(){this._canvas=void 0,this._eventTarget=new pn,dn.hasFeature(fn.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var e=t.prototype;return e._registerEvent=function(){var t,e,n,i;null===(t=this._canvas)||void 0===t||t.addEventListener("touchstart",this._createCallback(wE.TOUCH_START)),null===(e=this._canvas)||void 0===e||e.addEventListener("touchmove",this._createCallback(wE.TOUCH_MOVE)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchend",this._createCallback(wE.TOUCH_END)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchcancel",this._createCallback(wE.TOUCH_CANCEL))},e._createCallback=function(t){var e=this;return function(n){for(var i,r=e._getCanvasRect(),o=[],a=n.changedTouches.length,s=0;s<a;++s){var c=n.changedTouches[s],l=c.identifier;if(null!==l){var u=e._getLocation(c,r),h=aM.getTouch(l,u.x,u.y);h&&(t!==wE.TOUCH_END&&t!==wE.TOUCH_CANCEL||aM.releaseTouch(l),o.push(h))}}if(n.stopPropagation(),n.target===e._canvas&&n.preventDefault(),t===wE.TOUCH_START&&(null===(i=e._canvas)||void 0===i||i.focus()),o.length>0){var _=new YB(o,!1,t,ee.ENABLE_MULTI_TOUCH?aM.getAllTouches():o);e._eventTarget.emit(t,_)}}},e._getCanvasRect=function(){var t=this._canvas,e=null==t?void 0:t.getBoundingClientRect();return e?new Mi(e.x,e.y,e.width,e.height):new Mi(0,0,0,0)},e._getLocation=function(t,e){var n=t.clientX-e.x,i=e.y+e.height-t.clientY;if(Ku.isFrameRotated){var r=n;n=e.height-i,i=r}var o=Ku.devicePixelRatio;return new li(n*=o,i*=o)},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}();!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.UI=1]="UI"}(tM||(tM={}));var cM=function(){function t(t){this.priority=tM.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=t}return t.prototype.dispatchEvent=function(t){return this._inputEventTarget.emit(t.type,t),!0},t}(),lM=(($B={})[wE.MOUSE_DOWN]=wE.TOUCH_START,$B[wE.MOUSE_MOVE]=wE.TOUCH_MOVE,$B[wE.MOUSE_UP]=wE.TOUCH_END,$B),uM=t("Input",function(){function t(){this._dispatchImmediately=!0,this._eventTarget=new pn,this._touchInput=new sM,this._mouseInput=new rM,this._keyboardInput=new iM,this._accelerometerInput=new eM,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new cM(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher)}var e=t.prototype;return e.on=function(t,e,n){return this._eventTarget.on(t,e,n),e},e.once=function(t,e,n){return this._eventTarget.once(t,e,n),e},e.off=function(t,e,n){this._eventTarget.off(t,e,n)},e.setAccelerometerEnabled=function(t){t?this._accelerometerInput.start():this._accelerometerInput.stop()},e.setAccelerometerInterval=function(t){this._accelerometerInput.setInterval(t)},e._simulateEventTouch=function(t){var e=lM[t.type],n=aM.getTouch(0,t.getLocationX(),t.getLocationY());if(n){var i=[n],r=new YB(i,!1,e,i);e===wE.TOUCH_END&&aM.releaseTouch(0),this._dispatchOrPushEventTouch(r,this._eventTouchList)}},e._registerEventDispatcher=function(t){this._eventDispatcherList.push(t),this._eventDispatcherList.sort((function(t,e){return e.priority-t.priority}))},e._emitEvent=function(t){for(var e=this._eventDispatcherList.length,n=0;n<e&&this._eventDispatcherList[n].dispatchEvent(t);++n);},e._registerEvent=function(){var t=this;if(Zu.hasFeature(Zu.Feature.INPUT_TOUCH)){var e=this._eventTouchList;this._touchInput.on(wE.TOUCH_START,(function(n){t._dispatchOrPushEventTouch(n,e)})),this._touchInput.on(wE.TOUCH_MOVE,(function(n){t._dispatchOrPushEventTouch(n,e)})),this._touchInput.on(wE.TOUCH_END,(function(n){t._dispatchOrPushEventTouch(n,e)})),this._touchInput.on(wE.TOUCH_CANCEL,(function(n){t._dispatchOrPushEventTouch(n,e)}))}if(Zu.hasFeature(Zu.Feature.EVENT_MOUSE)){var n=this._eventMouseList;this._mouseInput.on(wE.MOUSE_DOWN,(function(e){t._needSimulateTouchMoveEvent=!0,t._simulateEventTouch(e),t._dispatchOrPushEvent(e,n)})),this._mouseInput.on(wE.MOUSE_MOVE,(function(e){t._needSimulateTouchMoveEvent&&t._simulateEventTouch(e),t._dispatchOrPushEvent(e,n)})),this._mouseInput.on(wE.MOUSE_UP,(function(e){t._needSimulateTouchMoveEvent=!1,t._simulateEventTouch(e),t._dispatchOrPushEvent(e,n)})),this._mouseInput.on(wE.MOUSE_WHEEL,(function(e){t._dispatchOrPushEvent(e,n)}))}if(Zu.hasFeature(Zu.Feature.EVENT_KEYBOARD)){var i=this._eventKeyboardList;this._keyboardInput.on(wE.KEY_DOWN,(function(e){t._dispatchOrPushEvent(e,i)})),this._keyboardInput.on(wE.KEY_PRESSING,(function(e){t._dispatchOrPushEvent(e,i)})),this._keyboardInput.on(wE.KEY_UP,(function(e){t._dispatchOrPushEvent(e,i)}))}if(Zu.hasFeature(Zu.Feature.EVENT_ACCELEROMETER)){var r=this._eventAccelerationList;this._accelerometerInput.on(wE.DEVICEMOTION,(function(e){t._dispatchOrPushEvent(e,r)}))}},e._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0},e._dispatchOrPushEvent=function(t,e){this._dispatchImmediately?this._emitEvent(t):e.push(t)},e._dispatchOrPushEventTouch=function(t,e){if(this._dispatchImmediately)for(var n=t.getTouches(),i=n.length,r=0;r<i;++r)t.touch=n[r],t.propagationStopped=t.propagationImmediateStopped=!1,this._emitEvent(t);else e.push(t)},e._frameDispatchEvents=function(){for(var t=this._eventMouseList,e=0,n=t.length;e<n;++e){var i=t[e];this._emitEvent(i)}for(var r=this._eventTouchList,o=0,a=r.length;o<a;++o)for(var s=r[o],c=s.getTouches(),l=c.length,u=0;u<l;++u)s.touch=c[u],s.propagationStopped=s.propagationImmediateStopped=!1,this._emitEvent(s);for(var h=this._eventKeyboardList,_=0,f=h.length;_<f;++_){var p=h[_];this._emitEvent(p)}for(var d=this._eventAccelerationList,m=0,v=d.length;m<v;++m){var g=d[m];this._emitEvent(g)}this._clearEvents()},t}());uM.EventType=wE;var hM=t("input",new uM),_M=t("SystemEvent",function(t){function e(){var e;return e=t.call(this)||this,hM.on(wE.MOUSE_DOWN,(function(t){e.emit(EE.MOUSE_DOWN,t)})),hM.on(wE.MOUSE_MOVE,(function(t){e.emit(EE.MOUSE_MOVE,t)})),hM.on(wE.MOUSE_UP,(function(t){e.emit(EE.MOUSE_UP,t)})),hM.on(wE.MOUSE_WHEEL,(function(t){e.emit(EE.MOUSE_WHEEL,t)})),hM.on(wE.TOUCH_START,(function(t){e.emit(EE.TOUCH_START,t.touch,t)})),hM.on(wE.TOUCH_MOVE,(function(t){e.emit(EE.TOUCH_MOVE,t.touch,t)})),hM.on(wE.TOUCH_END,(function(t){e.emit(EE.TOUCH_END,t.touch,t)})),hM.on(wE.TOUCH_CANCEL,(function(t){e.emit(EE.TOUCH_CANCEL,t.touch,t)})),hM.on(wE.KEY_DOWN,(function(t){e.emit(EE.KEY_DOWN,t)})),hM.on(wE.KEY_PRESSING,(function(t){e.emit(EE.KEY_DOWN,t)})),hM.on(wE.KEY_UP,(function(t){e.emit(EE.KEY_UP,t)})),hM.on(wE.DEVICEMOTION,(function(t){e.emit(EE.DEVICEMOTION,t)})),e}F(e,t);var n=e.prototype;return n.setAccelerometerEnabled=function(t){hM.setAccelerometerEnabled(t)},n.setAccelerometerInterval=function(t){hM.setAccelerometerInterval(t)},n.on=function(e,n,i,r){return t.prototype.on.call(this,e,n,i,r),n},n.off=function(e,n,i){t.prototype.off.call(this,e,n,i)},e}(pn));_M.EventType=EE,i.SystemEvent=_M;var fM=t("systemEvent",new _M);i.systemEvent=fM;var pM=t("Game",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).frame=null,e.container=null,e.canvas=null,e.renderType=-1,e.eventTargetOn=t.prototype.on,e.eventTargetOnce=t.prototype.once,e.config={},e.onStart=null,e.frameTime=1e3/60,e.collisionMatrix=[],e.groupList=[],e._persistRootNodes={},e._gfxDevice=null,e._swapchain=null,e._configLoaded=!1,e._isCloning=!1,e._inited=!1,e._engineInited=!1,e._rendererInitialized=!1,e._paused=!0,e._frameRate=60,e._intervalId=0,e._initTime=0,e._startTime=0,e._deltaTime=0,e._onEngineInitedCallback=[],e}F(e,t);var n=e.prototype;return n.setFrameRate=function(t){this.frameRate=t},n.getFrameRate=function(){return this.frameRate},n.step=function(){i.director.tick(this.frameTime/1e3)},n.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},n.resume=function(){this._paused&&(hM._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},n.isPaused=function(){return this._paused},n.restart=function(){var t=this;return new Promise((function(t){return i.director.once(i.Director.EVENT_END_FRAME,(function(){return t()}))})).then((function(){for(var n in t._persistRootNodes)t.removePersistRootNode(t._persistRootNodes[n]);return i.director.getScene().destroy(),i.Object._deferredDestroy(),i.director.reset(),i.profiler.reset(),t.pause(),t._setRenderPipelineNShowSplash().then((function(){t.resume(),t._safeEmit(e.EVENT_RESTART)}))}))},n.end=function(){dn.close()},n.on=function(t,n,i,r){return(this._engineInited&&t===e.EVENT_ENGINE_INITED||this._inited&&t===e.EVENT_GAME_INITED||this._rendererInitialized&&t===e.EVENT_RENDERER_INITED)&&n.call(i),this.eventTargetOn(t,n,i,r)},n.once=function(t,n,i){return this._engineInited&&t===e.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOnce(t,n,i)},n.init=function(t){var e=this;if(this._initConfig(t),Qu._init({configOrientation:t.orientation||"auto",exactFitScreen:t.exactFitScreen}),this.config.assetOptions&&i.assetManager.init(this.config.assetOptions),this.config.layers)for(var n=this.config.layers,r=0;r<n.length;r++){var o=n[r],a=Dn(o.value);fp.addLayer(o.name,a)}return this._initEngine().then((function(){return e._initEvents(),i.director.root&&i.director.root.dataPoolManager&&i.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(t.customJointTextureLayouts),e._engineInited}))},n.run=function(t,e){var n,i=this;return"function"!=typeof t&&t?(n=this.init(t),this.onStart=null!=e?e:null):this.onStart=null!=t?t:null,yu.init(),Promise.resolve(n).then((function(){return i._setRenderPipelineNShowSplash()})).then((function(){}))},n.addPersistRootNode=function(t){if(i.Node.isNode(t)&&t.uuid){var e=t.uuid;if(!this._persistRootNodes[e]){var n=i.director._scene;if(i.isValid(n))if(t.parent){if(!(t.parent instanceof i.Scene))return void b(3801);if(t.parent!==n)return void b(3802);t._originalSceneId=n.uuid}else t.parent=n;this._persistRootNodes[e]=t,t._persistNode=!0,i.assetManager._releaseManager._addPersistNodeRef(t)}}else b(3800)},n.removePersistRootNode=function(t){var e=t.uuid||"";t===this._persistRootNodes[e]&&(delete this._persistRootNodes[e],t._persistNode=!1,t._originalSceneId="",i.assetManager._releaseManager._removePersistNodeRef(t))},n.isPersistRootNode=function(t){return!!t._persistNode},n.onEngineInitedAsync=function(t){this._onEngineInitedCallback.push(t)},n._initEngine=function(){var t=this;this._initDevice();var n=i.director;return Promise.resolve(n._init()).then((function(){i.view.init(),f("Cocos Creator v"+r),t.emit(e.EVENT_ENGINE_INITED),t._engineInited=!0,i.internal.dynamicAtlasManager&&(i.internal.dynamicAtlasManager.enabled=!ee.CLEANUP_IMAGE_CACHE)})).then((function(){var e=t._onEngineInitedCallback.map((function(t){return t()})).filter(Boolean);return t._onEngineInitedCallback.length=0,Promise.all(e)}))},n._setAnimFrame=function(){var t=this._frameRate,e=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==t&&30!==t?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=e||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},n._stTime=function(t){var e=performance.now(),n=Math.max(0,e-this._startTime),i=Math.max(0,this.frameTime-n);return window.setTimeout(t,i)},n._ctTime=function(t){window.clearTimeout(t)},n._calculateDT=function(t){return t||(t=performance.now()),this._deltaTime=t>this._startTime?(t-this._startTime)/1e3:0,this._deltaTime>e.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=t,this._deltaTime},n._updateCallback=function(){var t,e=this,n=i.director;if(30===this._frameRate){var r=!0;t=function(t){e._intervalId=window.rAF(e._frameCB),(r=!r)||n.tick(e._calculateDT(t))}}else t=function(t){n.tick(e._calculateDT(t)),e._intervalId=window.rAF(e._frameCB)};this._frameCB=t},n._runMainLoop=function(){if(this._inited){var t=this.config,e=i.director;B(!!t.showFPS),e.startAnimation(),this.resume()}},n._initConfig=function(t){"number"!=typeof t.debugMode&&(t.debugMode=w.NONE),t.exposeClassName=!!t.exposeClassName,"number"!=typeof t.frameRate&&(t.frameRate=60);var e=t.renderMode;("number"!=typeof e||e>3||e<0)&&(t.renderMode=0),t.showFPS=!!t.showFPS,g(t.debugMode),this.config=t,this._configLoaded=!0,this.frameRate=t.frameRate},n._determineRenderType=function(){var t=this.config,n=parseInt(t.renderMode,10);this.renderType=e.RENDER_TYPE_CANVAS;var i=!1;if(1===n?(this.renderType=e.RENDER_TYPE_CANVAS,i=!0):0===n||2===n?(this.renderType=e.RENDER_TYPE_WEBGL,i=!0):3===n&&(this.renderType=e.RENDER_TYPE_HEADLESS,i=!0),!i)throw new Error(R(3820,n))},n._initDevice=function(){if(!this._rendererInitialized){var t=this.config.adapter;if(t&&(this.canvas=t.canvas,this.frame=t.frame,this.container=t.container),this._determineRenderType(),this.renderType===e.RENDER_TYPE_WEBGL){var n=new fo(Pp),r=!!window.WebGL2RenderingContext,o=window.navigator.userAgent.toLowerCase();(-1!==o.indexOf("safari")&&-1===o.indexOf("chrome")||Zu.browserType===cn.UC)&&(r=!1);var a=[];r&&i.WebGL2Device&&a.push(i.WebGL2Device),i.WebGLDevice&&a.push(i.WebGLDevice),i.EmptyDevice&&a.push(i.EmptyDevice),da.canvas=this.canvas;for(var s=0;s<a.length&&(this._gfxDevice=new a[s],!this._gfxDevice.initialize(n));s++);}else this.renderType===e.RENDER_TYPE_HEADLESS&&i.EmptyDevice&&(this._gfxDevice=new i.EmptyDevice,this._gfxDevice.initialize(new fo(Pp)));if(!this._gfxDevice)return d("can not support canvas rendering in 3D"),void(this.renderType=e.RENDER_TYPE_CANVAS);var c=new _o(this.canvas),l=Qu.windowSize;c.width=l.width,c.height=l.height,this._swapchain=this._gfxDevice.createSwapchain(c),this.canvas.oncontextmenu=function(){return!1}}},n._initEvents=function(){dn.on("show",this._onShow,this),dn.on("hide",this._onHide,this)},n._onHide=function(){this.emit(e.EVENT_HIDE),this.pause()},n._onShow=function(){this.emit(e.EVENT_SHOW),this.resume()},n._setRenderPipelineNShowSplash=function(){var t=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(t._showSplashScreen()).then((function(){t._inited=!0,t._initTime=performance.now(),t._runMainLoop(),t._safeEmit(e.EVENT_GAME_INITED),t.onStart&&t.onStart()}))}))},n._setupRenderPipeline=function(){var t=this,e=this.config.renderPipeline;return e?new Promise((function(t,n){i.assetManager.loadAny(e,(function(e,i){return!e&&i instanceof yx?t(i):n(e)}))})).then((function(e){t._setRenderPipeline(e)})).catch((function(n){p(n),p("Failed load render pipeline: "+e+", engine failed to initialize, will fallback to default pipeline"),t._setRenderPipeline()})):this._setRenderPipeline()},n._showSplashScreen=function(){if(i.internal.SplashScreen){var t=i.internal.SplashScreen.instance;return t.main(i.director.root),new Promise((function(e){t.setOnFinish((function(){return e()})),t.loadFinish=!0}))}return null},n._setRenderPipeline=function(t){i.director.root.setRenderPipeline(t)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(e.EVENT_RENDERER_INITED)},n._safeEmit=function(t){this.emit(t)},N(e,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(t){"number"!=typeof t&&(t=parseInt(t,10),Number.isNaN(t)&&(t=60)),this._frameRate=t,this.frameTime=1e3/t,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),e}(pn));pM.EVENT_HIDE="game_on_hide",pM.EVENT_SHOW="game_on_show",pM.EVENT_LOW_MEMORY="game_on_low_memory",pM.EVENT_GAME_INITED="game_inited",pM.EVENT_ENGINE_INITED="engine_inited",pM.EVENT_RENDERER_INITED="renderer_inited",pM.EVENT_RESTART="game_on_restart",pM.RENDER_TYPE_CANVAS=0,pM.RENDER_TYPE_WEBGL=1,pM.RENDER_TYPE_OPENGL=2,pM.RENDER_TYPE_HEADLESS=3,pM.DEBUG_DT_THRESHOLD=1,i.Game=pM;var dM,mM=t("game",i.game=new pM),vM=new Di,gM=((dM={})[ee.ORIENTATION_AUTO]=ju.AUTO,dM[ee.ORIENTATION_LANDSCAPE]=ju.LANDSCAPE,dM[ee.ORIENTATION_PORTRAIT]=ju.PORTRAIT,dM),yM=t("View",function(t){function e(){var e;(e=t.call(this)||this)._designResolutionSize=void 0,e._scaleX=void 0,e._scaleY=void 0,e._viewportRect=void 0,e._visibleRect=void 0,e._autoFullScreen=void 0,e._retinaEnabled=void 0,e._resizeCallback=void 0,e._resolutionPolicy=void 0,e._rpExactFit=void 0,e._rpShowAll=void 0,e._rpNoBorder=void 0,e._rpFixedHeight=void 0,e._rpFixedWidth=void 0;var n=xM,i=SM;return e._designResolutionSize=new Di(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new Mi(0,0,0,0),e._visibleRect=new Mi(0,0,0,0),e._autoFullScreen=!1,e._retinaEnabled=!1,e._resizeCallback=null,e._rpExactFit=new AM(n.EQUAL_TO_FRAME,i.EXACT_FIT),e._rpShowAll=new AM(n.EQUAL_TO_FRAME,i.SHOW_ALL),e._rpNoBorder=new AM(n.EQUAL_TO_FRAME,i.NO_BORDER),e._rpFixedHeight=new AM(n.EQUAL_TO_FRAME,i.FIXED_HEIGHT),e._rpFixedWidth=new AM(n.EQUAL_TO_FRAME,i.FIXED_WIDTH),e._resolutionPolicy=e._rpShowAll,e}F(e,t);var n=e.prototype;return n.init=function(){var t=Qu.windowSize,e=t.width,n=t.height;this._designResolutionSize.width=e,this._designResolutionSize.height=n,this._viewportRect.width=e,this._viewportRect.height=n,this._visibleRect.width=e,this._visibleRect.height=n,vM.width=this._visibleRect.width,vM.height=this._visibleRect.height,kB&&kB.init(this._visibleRect),Ku.on("window-resize",this._updateAdaptResult,this),Ku.on("orientation-change",this._updateAdaptResult,this),Ku.on("fullscreen-change",this._updateAdaptResult,this)},n.resizeWithBrowserSize=function(t){Ku.handleResizeEvent=t},n.setResizeCallback=function(t){"function"!=typeof t&&null!=t||(this._resizeCallback=t)},n.setOrientation=function(t){Ku.orientation=gM[t]},n.adjustViewportMeta=function(){},n.enableRetina=function(t){this._retinaEnabled=!!t},n.isRetinaEnabled=function(){return this._retinaEnabled},n.enableAutoFullScreen=function(t){t!==this._autoFullScreen&&(this._autoFullScreen=t,t&&Qu.requestFullScreen().catch((function(){})))},n.isAutoFullScreenEnabled=function(){return this._autoFullScreen},n.setCanvasSize=function(t,e){Ku.resolutionScale=1;var n=Ku.devicePixelRatio,i=new Di(t*n,e*n);Qu.windowSize=i},n.getCanvasSize=function(){return Qu.windowSize},n.getFrameSize=function(){var t=Ku.devicePixelRatio,e=Qu.windowSize;return e.width/=t,e.height/=t,e},n.setFrameSize=function(t,e){var n=Ku.devicePixelRatio;Qu.windowSize=new Di(t*n,e*n)},n.getVisibleSize=function(){return new Di(this._visibleRect.width,this._visibleRect.height)},n.getVisibleSizeInPixel=function(){return new Di(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},n.getVisibleOrigin=function(){return new li(this._visibleRect.x,this._visibleRect.y)},n.getVisibleOriginInPixel=function(){return new li(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},n.getResolutionPolicy=function(){return this._resolutionPolicy},n._updateResolutionPolicy=function(t){if(t instanceof AM)this._resolutionPolicy=t;else{var e=AM;t===e.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),t===e.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),t===e.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),t===e.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),t===e.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},n.setResolutionPolicy=function(t){this._updateResolutionPolicy(t);var e=CM.getDesignResolutionSize();CM.setDesignResolutionSize(e.width,e.height,t)},n.setDesignResolutionSize=function(t,e,n){if(t>0&&e>0){this._updateResolutionPolicy(n);var i=this._resolutionPolicy;i&&i.preApply(this),this._designResolutionSize.width=t,this._designResolutionSize.height=e;var r=i.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var o=this._viewportRect,a=this._visibleRect,s=r.viewport;o.x=s.x,o.y=s.y,o.width=s.width,o.height=s.height,a.x=0,a.y=0,a.width=s.width/this._scaleX,a.height=s.height/this._scaleY}i.postApply(this),vM.width=this._visibleRect.width,vM.height=this._visibleRect.height,kB&&kB.init(this._visibleRect),this.emit("design-resolution-changed")}else E(2200)},n.getDesignResolutionSize=function(){return new Di(this._designResolutionSize.width,this._designResolutionSize.height)},n.setRealPixelResolution=function(t,e,n){document.documentElement.style.width=t+"px",document.body.style.width=t+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(t,e,n)},n.getViewportRect=function(){return this._viewportRect},n.getScaleX=function(){return this._scaleX},n.getScaleY=function(){return this._scaleY},n.getDevicePixelRatio=function(){return Ku.devicePixelRatio},n.convertToLocationInView=function(t,e,n,i){void 0===i&&(i=new li);var r=Ku.devicePixelRatio*(t-n.left),o=Ku.devicePixelRatio*(n.top+n.height-e);return Ku.isFrameRotated?(i.x=Qu.windowSize.width-o,i.y=r):(i.x=r,i.y=o),i},n._convertToUISpace=function(t){var e=this._viewportRect;t.x=(t.x-e.x)/this._scaleX,t.y=(t.y-e.y)/this._scaleY},n._updateAdaptResult=function(){var t;i.director.root.resize(Qu.windowSize.width,Qu.windowSize.height);var e=this._designResolutionSize.width,n=this._designResolutionSize.height;e>0&&this.setDesignResolutionSize(e,n,this._resolutionPolicy),this.emit("canvas-resize"),null===(t=this._resizeCallback)||void 0===t||t.call(this)},e}(pn));yM.instance=void 0;var xM=function(){function t(){this.name="ContainerStrategy"}var e=t.prototype;return e.preApply=function(){},e.apply=function(){},e.postApply=function(){},e._setupCanvas=function(){var t=mM.canvas;if(t){var e=Qu.windowSize;t.width=e.width,t.height=e.height}},t}();xM.EQUAL_TO_FRAME=void 0,xM.PROPORTION_TO_FRAME=void 0;var SM=function(){function t(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var e=t.prototype;return e.preApply=function(){},e.apply=function(){return{scale:[1,1]}},e.postApply=function(){},e._buildResult=function(t,e,n,i,r,o){Math.abs(t-n)<2&&(n=t),Math.abs(e-i)<2&&(i=e);var a=new Mi(Math.round((t-n)/2),Math.round((e-i)/2),n,i);return this._result.scale=[r,o],this._result.viewport=a,this._result},t}();SM.EXACT_FIT=void 0,SM.SHOW_ALL=void 0,SM.NO_BORDER=void 0,SM.FIXED_HEIGHT=void 0,SM.FIXED_WIDTH=void 0,function(){var t=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="EqualToFrame",e}return F(e,t),e.prototype.apply=function(){Ku.isProportionalToFrame=!1,this._setupCanvas()},e}(xM),e=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="ProportionalToFrame",e}return F(e,t),e.prototype.apply=function(){Ku.isProportionalToFrame=!0,this._setupCanvas()},e}(xM);xM.EQUAL_TO_FRAME=new t,xM.PROPORTION_TO_FRAME=new e;var n=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="ExactFit",e}return F(e,t),e.prototype.apply=function(t,e){var n=Qu.windowSize,i=n.width,r=n.height,o=i/e.width,a=r/e.height;return this._buildResult(i,r,i,r,o,a)},e}(SM),i=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="ShowAll",e}return F(e,t),e.prototype.apply=function(t,e){var n,i,r=Qu.windowSize,o=r.width,a=r.height,s=e.width,c=e.height,l=o/s,u=a/c,h=0;return l<u?(n=o,i=c*(h=l)):(n=s*(h=u),i=a),this._buildResult(o,a,n,i,h,h)},e}(SM),r=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="NoBorder",e}return F(e,t),e.prototype.apply=function(t,e){var n,i,r,o=Qu.windowSize,a=o.width,s=o.height,c=e.width,l=e.height,u=a/c,h=s/l;return u<h?(i=c*(n=h),r=s):(i=a,r=l*(n=u)),this._buildResult(a,s,i,r,n,n)},e}(SM),o=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="FixedHeight",e}return F(e,t),e.prototype.apply=function(t,e){var n=Qu.windowSize,i=n.width,r=n.height,o=r/e.height,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},e}(SM),a=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="FixedWidth",e}return F(e,t),e.prototype.apply=function(t,e){var n=Qu.windowSize,i=n.width,r=n.height,o=i/e.width,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},e}(SM);SM.EXACT_FIT=new n,SM.SHOW_ALL=new i,SM.NO_BORDER=new r,SM.FIXED_HEIGHT=new o,SM.FIXED_WIDTH=new a}();var AM=t("ResolutionPolicy",function(){function t(t,e){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(t),this.setContentStrategy(e)}var e=t.prototype;return e.preApply=function(t){this._contentStrategy.preApply(t)},e.apply=function(t,e){return this._containerStrategy.apply(t,e),this._contentStrategy.apply(t,e)},e.postApply=function(t){this._contentStrategy.postApply(t)},e.setContainerStrategy=function(t){t instanceof xM&&(this._containerStrategy=t)},e.setContentStrategy=function(t){t instanceof SM&&(this._contentStrategy=t)},N(t,[{key:"canvasSize",get:function(){return Qu.windowSize}}]),t}());AM.EXACT_FIT=0,AM.NO_BORDER=1,AM.SHOW_ALL=2,AM.FIXED_HEIGHT=3,AM.FIXED_WIDTH=4,AM.UNKNOWN=5,AM.ContainerStrategy=xM,AM.ContentStrategy=SM,i.ResolutionPolicy=AM;var CM=t("view",yM.instance=i.view=new yM);i.winSize=vM;var bM=t("System",function(){function t(){this._id="",this._priority=0,this._executeInEditMode=!1}t.sortByPriority=function(t,e){return t._priority<e._priority?1:t._priority>e.priority?-1:0};var e=t.prototype;return e.init=function(){},e.update=function(){},e.postUpdate=function(){},N(t,[{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"id",get:function(){return this._id},set:function(t){this._id=t}}]),t}());bM.Priority=Jt({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var TM=new et("Scheduler"),EM=function(t,e,n,i){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=e,this.paused=n,this.markedForDeletion=i};EM.get=function(t,e,n,i){var r=EM._listEntries.pop();return r?(r.target=t,r.priority=e,r.paused=n,r.markedForDeletion=i):r=new EM(t,e,n,i),r},EM.put=function(t){EM._listEntries.length<20&&(t.target=null,EM._listEntries.push(t))},EM._listEntries=[];var wM=function(t,e,n,i){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=e,this.target=n,this.callback=i};wM.get=function(t,e,n,i){var r=wM._hashUpdateEntries.pop();return r?(r.list=t,r.entry=e,r.target=n,r.callback=i):r=new wM(t,e,n,i),r},wM.put=function(t){wM._hashUpdateEntries.length<20&&(t.list=t.entry=t.target=t.callback=null,wM._hashUpdateEntries.push(t))},wM._hashUpdateEntries=[];var PM=function(t,e,n,i,r,o){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=e,this.timerIndex=n,this.currentTimer=i,this.currentTimerSalvaged=r,this.paused=o};PM.get=function(t,e,n,i,r,o){var a=PM._hashTimerEntries.pop();return a?(a.timers=t,a.target=e,a.timerIndex=n,a.currentTimer=i,a.currentTimerSalvaged=r,a.paused=o):a=new PM(t,e,n,i,r,o),a},PM.put=function(t){PM._hashTimerEntries.length<20&&(t.timers=t.target=t.currentTimer=null,PM._hashTimerEntries.push(t))},PM._hashTimerEntries=[];var IM=function(){function t(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var e=t.prototype;return e.initWithCallback=function(t,e,n,r,o,a){return this._lock=!1,this._scheduler=t,this._target=n,this._callback=e,this._elapsed=-1,this._interval=r,this._delay=a,this._useDelay=this._delay>0,this._repeat=o,this._runForever=this._repeat===i.macro.REPEAT_FOREVER,!0},e.getInterval=function(){return this._interval},e.setInterval=function(t){this._interval=t},e.update=function(t){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=t,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},e.getCallback=function(){return this._callback},e.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},e.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},t}();IM._timers=[],IM.get=function(){return IM._timers.pop()||new IM},IM.put=function(t){IM._timers.length<20&&!t._lock&&(t._scheduler=t._target=t._callback=null,IM._timers.push(t))};var RM,DM=t("Scheduler",function(t){function e(){var e;return(e=t.call(this)||this)._timeScale=void 0,e._updatesNegList=void 0,e._updates0List=void 0,e._updatesPosList=void 0,e._hashForUpdates=void 0,e._hashForTimers=void 0,e._currentTarget=void 0,e._currentTargetSalvaged=void 0,e._updateHashLocked=void 0,e._arrayForTimers=void 0,e._timeScale=1,e._updatesNegList=[],e._updates0List=[],e._updatesPosList=[],e._hashForUpdates=ft(!0),e._hashForTimers=ft(!0),e._currentTarget=null,e._currentTargetSalvaged=!1,e._updateHashLocked=!1,e._arrayForTimers=[],e}F(e,t),e.enableForTarget=function(t){var e=!1;(t.uuid||t.id)&&(e=!0),e||(t.__instanceId?b(1513):t.id=TM.getNewId())};var n=e.prototype;return n.setTimeScale=function(t){this._timeScale=t},n.getTimeScale=function(){return this._timeScale},n.update=function(t){var e,n,i,r,o;for(this._updateHashLocked=!0,1!==this._timeScale&&(t*=this._timeScale),e=0,i=(n=this._updatesNegList).length;e<i;e++)(r=n[e]).paused||r.markedForDeletion||r.target.update(t);for(e=0,i=(n=this._updates0List).length;e<i;e++)(r=n[e]).paused||r.markedForDeletion||r.target.update(t);for(e=0,i=(n=this._updatesPosList).length;e<i;e++)(r=n[e]).paused||r.markedForDeletion||r.target.update(t);var a=this._arrayForTimers;for(e=0;e<a.length;e++){if(o=a[e],this._currentTarget=o,this._currentTargetSalvaged=!1,!o.paused)for(o.timerIndex=0;o.timerIndex<o.timers.length;++o.timerIndex)o.currentTimer=o.timers[o.timerIndex],o.currentTimerSalvaged=!1,o.currentTimer.update(t),o.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--e)}for(e=0,n=this._updatesNegList;e<n.length;)(r=n[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;for(e=0,n=this._updates0List;e<n.length;)(r=n[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;for(e=0,n=this._updatesPosList;e<n.length;)(r=n[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;this._updateHashLocked=!1,this._currentTarget=null},n.schedule=function(t,e,n,r,o,a){if("function"!=typeof t){var s=t;t=e,e=s}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(a=!!r,r=i.macro.REPEAT_FOREVER,o=0),I(e,1502);var c=e.uuid||e.id;if(c){var l,u,h=this._hashForTimers[c];if(h?h.paused!==a&&b(1511):(h=PM.get(null,e,0,null,null,a),this._arrayForTimers.push(h),this._hashForTimers[c]=h),null==h.timers)h.timers=[];else for(u=0;u<h.timers.length;++u)if((l=h.timers[u])&&t===l._callback)return A(1507,l.getInterval(),n),void(l._interval=n);(l=IM.get()).initWithCallback(this,t,e,n,r,o),h.timers.push(l),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else E(1510)},n.scheduleUpdate=function(t,e,n){var i=t.uuid||t.id;if(i){var r=this._hashForUpdates[i];if(r&&r.entry){if(r.entry.priority===e)return r.entry.markedForDeletion=!1,void(r.entry.paused=n);if(this._updateHashLocked)return A(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=n);this.unscheduleUpdate(t)}var o,a=EM.get(t,e,n,!1);0===e?(o=this._updates0List,this._appendIn(o,a)):(o=e<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,a,e)),this._hashForUpdates[i]=wM.get(o,a,t,null)}else E(1510)},n.unschedule=function(t,e){if(e&&t){var n=e.uuid||e.id;if(n){var i=this._hashForTimers[n];if(i)for(var r=i.timers,o=0,a=r.length;o<a;o++){var s=r[o];if(t===s._callback)return s!==i.currentTimer||i.currentTimerSalvaged||(i.currentTimerSalvaged=!0),r.splice(o,1),IM.put(s),i.timerIndex>=o&&i.timerIndex--,void(0===r.length&&(this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)))}}else E(1510)}},n.unscheduleUpdate=function(t){if(t){var e=t.uuid||t.id;if(e){var n=this._hashForUpdates[e];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}else E(1510)}},n.unscheduleAllForTarget=function(t){if(t){var e=t.uuid||t.id;if(e){var n=this._hashForTimers[e];if(n){var i=n.timers;i.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(var r=0,o=i.length;r<o;r++)IM.put(i[r]);i.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(t)}else E(1510)}},n.unscheduleAll=function(){this.unscheduleAllWithMinPriority(bM.Priority.SCHEDULER)},n.unscheduleAllWithMinPriority=function(t){var e,n,i,r=this._arrayForTimers;for(e=r.length-1;e>=0;e--)n=r[e],this.unscheduleAllForTarget(n.target);var o=0;if(t<0)for(e=0;e<this._updatesNegList.length;)o=this._updatesNegList.length,(i=this._updatesNegList[e])&&i.priority>=t&&this.unscheduleUpdate(i.target),o===this._updatesNegList.length&&e++;if(t<=0)for(e=0;e<this._updates0List.length;)o=this._updates0List.length,(i=this._updates0List[e])&&this.unscheduleUpdate(i.target),o===this._updates0List.length&&e++;for(e=0;e<this._updatesPosList.length;)o=this._updatesPosList.length,(i=this._updatesPosList[e])&&i.priority>=t&&this.unscheduleUpdate(i.target),o===this._updatesPosList.length&&e++},n.isScheduled=function(t,e){I(t,1508),I(e,1509);var n=e.uuid||e.id;if(!n)return E(1510),!1;var i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;for(var r=i.timers,o=0;o<r.length;++o)if(t===r[o]._callback)return!0;return!1},n.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(bM.Priority.SCHEDULER)},n.pauseAllTargetsWithMinPriority=function(t){var e,n,i,r,o=[],a=this._arrayForTimers;for(n=0,i=a.length;n<i;n++)(e=a[n])&&(e.paused=!0,o.push(e.target));if(t<0)for(n=0;n<this._updatesNegList.length;n++)(r=this._updatesNegList[n])&&r.priority>=t&&(r.paused=!0,o.push(r.target));if(t<=0)for(n=0;n<this._updates0List.length;n++)(r=this._updates0List[n])&&(r.paused=!0,o.push(r.target));for(n=0;n<this._updatesPosList.length;n++)(r=this._updatesPosList[n])&&r.priority>=t&&(r.paused=!0,o.push(r.target));return o},n.resumeTargets=function(t){if(t)for(var e=0;e<t.length;e++)this.resumeTarget(t[e])},n.pauseTarget=function(t){I(t,1503);var e=t.uuid||t.id;if(e){var n=this._hashForTimers[e];n&&(n.paused=!0);var i=this._hashForUpdates[e];i&&(i.entry.paused=!0)}else E(1510)},n.resumeTarget=function(t){I(t,1504);var e=t.uuid||t.id;if(e){var n=this._hashForTimers[e];n&&(n.paused=!1);var i=this._hashForUpdates[e];i&&(i.entry.paused=!1)}else E(1510)},n.isTargetPaused=function(t){I(t,1505);var e=t.uuid||t.id;if(!e)return E(1510),!1;var n=this._hashForTimers[e];if(n)return n.paused;var i=this._hashForUpdates[e];return!!i&&i.entry.paused},n._removeHashElement=function(t){var e=t.target.uuid||t.target.id;delete this._hashForTimers[e];for(var n=this._arrayForTimers,i=0,r=n.length;i<r;i++)if(n[i]===t){n.splice(i,1);break}PM.put(t)},n._removeUpdateFromHash=function(t){var e=t.target.uuid||t.target.id,n=this._hashForUpdates[e];if(n){for(var i=n.list,r=n.entry,o=0,a=i.length;o<a;o++)if(i[o]===r){i.splice(o,1);break}delete this._hashForUpdates[e],EM.put(r),wM.put(n)}},n._priorityIn=function(t,e,n){for(var i=0;i<t.length;i++)if(n<t[i].priority)return void t.splice(i,0,e);t.push(e)},n._appendIn=function(t,e){t.push(e)},e}(bM));DM.ID="scheduler",i.Scheduler=DM;var BM=((RM={})[ju.PORTRAIT]=hr.IDENTITY,RM[ju.LANDSCAPE_RIGHT]=hr.ROTATE_90,RM[ju.PORTRAIT_UPSIDE_DOWN]=hr.ROTATE_180,RM[ju.LANDSCAPE_LEFT]=hr.ROTATE_270,RM),MM=function(){function t(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}t.registerCreateFunc=function(e){e._createWindowFun=function(e){return new t(e)}};var e=t.prototype;return e.initialize=function(t,e){if(this._init(),void 0!==e.title&&(this._title=e.title),void 0!==e.swapchain&&(this._swapchain=e.swapchain),this._width=e.width,this._height=e.height,this._renderPass=t.createRenderPass(e.renderPassInfo),e.swapchain)this._setSwapchain(e.swapchain),this._colorTextures.push(e.swapchain.colorTexture),this._depthStencilTexture=e.swapchain.depthStencilTexture;else{for(var n=0;n<e.renderPassInfo.colorAttachments.length;n++)this._colorTextures.push(t.createTexture(new xo(xr.TEX2D,Sr.COLOR_ATTACHMENT|Sr.SAMPLED|Sr.TRANSFER_SRC,e.renderPassInfo.colorAttachments[n].format,this._width,this._height)));e.renderPassInfo.depthStencilAttachment.format!==fr.UNKNOWN&&(this._depthStencilTexture=t.createTexture(new xo(xr.TEX2D,Sr.DEPTH_STENCIL_ATTACHMENT|Sr.SAMPLED,e.renderPassInfo.depthStencilAttachment.format,this._width,this._height)))}return this._setFrameBuffer(t.createFramebuffer(new ko(this._renderPass,this._colorTextures,this._depthStencilTexture))),!0},e.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var t=0;t<this._colorTextures.length;t++){var e=this._colorTextures[t];e&&e.destroy()}this._colorTextures.length=0,this._destroy()},e.resize=function(t,e){if(this._swapchain)this._swapchain.resize(t,e,BM[Ku.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var n=0;n<this._colorTextures.length;n++)this._colorTextures[n].resize(t,e);this._depthStencilTexture&&this._depthStencilTexture.resize(t,e),this._width=t,this._height=e}this.framebuffer&&(this.framebuffer.destroy(),this.framebuffer.initialize(new ko(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var i,r=W(this._cameras);!(i=r()).done;)i.value.resize(t,e)},e.extractRenderCameras=function(t){for(var e=0;e<this._cameras.length;e++){var n=this._cameras[e];n.enabled&&(n.update(),t.push(n))}},e.attachCamera=function(t){for(var e=0;e<this._cameras.length;e++)if(this._cameras[e]===t)return;this._cameras.push(t),this.sortCameras()},e.detachCamera=function(t){for(var e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return void this._cameras.splice(e,1)},e.clearCameras=function(){this._cameras.length=0},e.sortCameras=function(){this._cameras.sort((function(t,e){return t.priority-e.priority}))},e._init=function(){},e._destroy=function(){},e._setSwapchain=function(t){this._swapchain=t},e._setFrameBuffer=function(t){this._framebuffer=t},N(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}},{key:"native",get:function(){return this._nativeObj}}]),t}(),OM=function(){var t=e.prototype;function e(t){var e=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=t,this._dataPoolMgr=i.internal.DataPoolManager&&new i.internal.DataPoolManager(t),vg.registerCreateFunc(this),MM.registerCreateFunc(this),this._cameraPool=new Wt((function(){return new Wd(e._device)}),4,(function(t){return t.destroy()}))}return t._init=function(){},t._destroy=function(){},t._setCumulativeTime=function(t){this._cumulativeTime+=t},t._setFrameTime=function(t){this._frameTime=t},t.initialize=function(){this._init();var t=i.game._swapchain,e=new No;e.format=t.colorTexture.format;var n=new Lo;n.format=t.depthStencilTexture.format,n.depthStoreOp=Or.DISCARD,n.stencilStoreOp=Or.DISCARD;var r=new Vo([e],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:t.width,height:t.height,renderPassInfo:r,swapchain:t}),this._curWindow=this._mainWindow,Promise.resolve(Cv.initBuiltinRes(this._device))},t.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()},t.resize=function(t,e){for(var n,i=W(this._windows);!(n=i()).done;){var r=n.value;r.swapchain&&r.resize(t,e)}},t.setRenderPipeline=function(t){t instanceof zB&&(this._useDeferredPipeline=!0);var e=!1;if(t||(t=VB(),e=!0),this._pipeline=t,this._useDeferredPipeline&&this.device.hasFeature(_r.COMPUTE_SHADER)||(this._pipeline.clusterEnabled=!1),this._pipeline.bloomEnabled=!1,!this._pipeline.activate(this._mainWindow.swapchain))return e&&this._pipeline.destroy(),this._pipeline=null,!1;var n=i.director.getScene();return n&&n.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&i.internal.Batcher2D&&(this._batcher=new i.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},t.onGlobalPipelineStateChanged=function(){for(var t=0;t<this._scenes.length;t++)this._scenes[t].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()},t.activeWindow=function(t){this._curWindow=t},t.resetCumulativeTime=function(){this._setCumulativeTime(0)},t.frameMove=function(t){this._setFrameTime(t),++this._frameCount,this._setCumulativeTime(t),this._fpsTime+=t,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var e=0;e<this._scenes.length;++e)this._scenes[e].removeBatches();for(var n=this._windows,r=[],o=0;o<n.length;o++)n[o].extractRenderCameras(r);if(this._pipeline&&r.length>0){this._device.acquire([i.game._swapchain]);var a=this._scenes,s=i.director.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var c=0;c<a.length;c++)a[c].update(s);i.director.emit(i.Director.EVENT_BEFORE_COMMIT),r.sort((function(t,e){return t.priority-e.priority})),this._pipeline.render(r),this._device.present()}this._batcher&&this._batcher.reset()},t.createWindow=function(t){var e=this._createWindowFun(this);return e.initialize(this.device,t),this._windows.push(e),e},t.destroyWindow=function(t){for(var e=0;e<this._windows.length;++e)if(this._windows[e]===t)return t.destroy(),void this._windows.splice(e,1)},t.destroyWindows=function(){for(var t,e=W(this._windows);!(t=e()).done;)t.value.destroy();this._windows.length=0},t.createScene=function(t){var e=this._createSceneFun(this);return e.initialize(t),this._scenes.push(e),e},t.destroyScene=function(t){for(var e=0;e<this._scenes.length;++e)if(this._scenes[e]===t)return t.destroy(),void this._scenes.splice(e,1)},t.destroyScenes=function(){for(var t,e=W(this._scenes);!(t=e()).done;)t.value.destroy();this._scenes.length=0},t.createModel=function(t){var e=this._modelPools.get(t);e||(this._modelPools.set(t,new Wt((function(){return new t}),10,(function(t){return t.destroy()}))),e=this._modelPools.get(t));var n=e.alloc();return n.initialize(),n},t.destroyModel=function(t){var e=this._modelPools.get(t.constructor);e?(e.free(t),t.scene&&t.scene.removeModel(t)):b(1300,t.constructor.name),t.destroy()},t.createCamera=function(){return this._cameraPool.alloc()},t.createLight=function(t){var e=this._lightPools.get(t);e||(this._lightPools.set(t,new Wt((function(){return new t}),4,(function(t){return t.destroy()}))),e=this._lightPools.get(t));var n=e.alloc();return n.initialize(),n},t.destroyLight=function(t){var e=this._lightPools.get(t.constructor);if(e&&(e.free(t),t.scene))switch(t.type){case Ld.SPHERE:t.scene.removeSphereLight(t);break;case Ld.SPOT:t.scene.removeSpotLight(t)}t.destroy()},N(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(t){this._curWindow=t}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(t){this._tempWindow=t}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(t){t>0?(this._fixedFPS=t,this._fixedFPSFrameTime=1e3/t):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),e}();i.Root=OM;var NM=t("Director",function(t){function e(){var e;return(e=t.call(this)||this)._compScheduler=void 0,e._nodeActivator=void 0,e._invalid=void 0,e._paused=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._scheduler=void 0,e._systems=void 0,e._invalid=!1,e._paused=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._scheduler=new DM,e._compScheduler=new JR,e._nodeActivator=new pD,e._systems=[],mM.once(pM.EVENT_RENDERER_INITED,e._initOnRendererInitialized,H(e)),e}F(e,t);var n=e.prototype;return n.calculateDeltaTime=function(){},n.end=function(){var t=this;this.once(e.EVENT_END_FRAME,(function(){t.purgeDirector()}))},n.pause=function(){this._paused||(this._paused=!0)},n.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),i.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),i.assetManager.releaseAll()},n.reset=function(){this.purgeDirector(),this.emit(e.EVENT_RESET),this.startAnimation()},n.runSceneImmediate=function(t,e,n){t instanceof dD&&(t=t.scene),I(t instanceof OR,1216),t._load();for(var r=Object.keys(mM._persistRootNodes).map((function(t){return mM._persistRootNodes[t]})),o=0;o<r.length;o++){var a=r[o];a.emit(i.Node.SCENE_CHANGED_FOR_PERSISTS,t.renderScene);var s=t.uuid===a._originalSceneId&&t.getChildByUuid(a.uuid);if(s){var c=s.getSiblingIndex();s._destroyImmediate(),t.insertChild(a,c)}else a.parent=t}var l=this._scene;i.isValid(l)&&l.destroy(),i.assetManager._releaseManager._autoRelease(l,t,mM._persistRootNodes),this._scene=null,Je._deferredDestroy(),e&&e(),this.emit(i.Director.EVENT_BEFORE_SCENE_LAUNCH,t),this._scene=t,t._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,t),this.emit(i.Director.EVENT_AFTER_SCENE_LAUNCH,t)},n.runScene=function(t,e,n){var r=this;t instanceof dD&&(t=t.scene),I(t,1205),I(t instanceof OR,1216),t._load(),this.once(i.Director.EVENT_END_FRAME,(function(){r.runSceneImmediate(t,e,n)}))},n.loadScene=function(t,e,n){var r=this;if(this._loadingScene)return b(1208,t,this._loadingScene),!1;var o=i.assetManager.bundles.find((function(e){return!!e.getSceneInfo(t)}));return o?(this.emit(i.Director.EVENT_BEFORE_SCENE_LOADING,t),this._loadingScene=t,console.time("LoadScene "+t),o.loadScene(t,(function(i,o){console.timeEnd("LoadScene "+t),r._loadingScene="",i?(d(i),e&&e(i)):r.runSceneImmediate(o,n,e)})),!0):(E(1209,t),!1)},n.preloadScene=function(t,e,n){var r=i.assetManager.bundles.find((function(e){return!!e.getSceneInfo(t)}));if(r)r.preloadScene(t,null,e,n);else{var o='Can not preload the scene "'+t+'" because it is not in the build settings.';n&&n(new Error(o)),d("preloadScene: "+o)}},n.resume=function(){this._paused&&(this._paused=!1)},n.getScene=function(){return this._scene},n.getDeltaTime=function(){return mM.deltaTime},n.getTotalTime=function(){return mM.totalTime},n.getCurrentTime=function(){return mM.frameStartTime},n.getTotalFrames=function(){return this._totalFrames},n.isPaused=function(){return this._paused},n.getScheduler=function(){return this._scheduler},n.setScheduler=function(t){this._scheduler!==t&&(this.unregisterSystem(this._scheduler),this._scheduler=t,this.registerSystem(DM.ID,t,200))},n.registerSystem=function(t,e,n){e.id=t,e.priority=n,e.init(),this._systems.push(e),this._systems.sort(bM.sortByPriority)},n.unregisterSystem=function(t){Ut.fastRemove(this._systems,t),this._systems.sort(bM.sortByPriority)},n.getSystem=function(t){return this._systems.find((function(e){return e.id===t}))},n.getAnimationManager=function(){return this.getSystem(i.AnimationManager.ID)},n.startAnimation=function(){this._invalid=!1},n.stopAnimation=function(){this._invalid=!0},n.mainLoop=function(t){var e;e=mM._calculateDT(t),this.tick(e)},n.tick=function(t){if(!this._invalid){if(this.emit(e.EVENT_BEGIN_FRAME),hM._frameDispatchEvents(),!this._paused){this.emit(e.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(t);for(var n=0;n<this._systems.length;++n)this._systems[n].update(t);this._compScheduler.lateUpdatePhase(t),this.emit(e.EVENT_AFTER_UPDATE),Je._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(t)}this.emit(e.EVENT_BEFORE_DRAW),this._root.frameMove(t),this.emit(e.EVENT_AFTER_DRAW),BT.resetHasChangedFlags(),BT.clearNodeArray(),Ht.update(t),this.emit(e.EVENT_END_FRAME),this._totalFrames++}},n._initOnRendererInitialized=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(DM.ID,this._scheduler,200),this.emit(e.EVENT_INIT)},n._init=function(){return this._root=new OM(mM._gfxDevice),this._root.initialize({}).catch((function(t){return E(1217),Promise.reject(t)}))},N(e,[{key:"root",get:function(){return this._root}}]),e}(pn));NM.EVENT_INIT="director_init",NM.EVENT_RESET="director_reset",NM.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",NM.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",NM.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",NM.EVENT_BEFORE_UPDATE="director_before_update",NM.EVENT_AFTER_UPDATE="director_after_update",NM.EVENT_BEFORE_DRAW="director_before_draw",NM.EVENT_AFTER_DRAW="director_after_draw",NM.EVENT_BEFORE_COMMIT="director_before_commit",NM.EVENT_BEFORE_PHYSICS="director_before_physics",NM.EVENT_AFTER_PHYSICS="director_after_physics",NM.EVENT_BEGIN_FRAME="director_begin_frame",NM.EVENT_END_FRAME="director_end_frame",NM.instance=void 0,i.Director=NM;var LM=t("director",NM.instance=i.director=new NM),FM=function(){function t(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new Ul,this.scenes=new Ul,this.paths=new Ul}var e=t.prototype;return e.init=function(t){var e=this;!function(t){var e=t.uuids,n=t.paths,i=t.types,r=t.deps,o=t.paths=Object.create(null);if(!1===t.debug){for(var a=0,s=e.length;a<s;a++)e[a]=ru(e[a]);for(var c in n){var l=n[c],u=l[1];l[1]=i[u]}}else{for(var h=Object.create(null),_=0,f=e.length;_<f;_++){var p=e[_];e[_]=h[p]=ru(p)}e=h}for(var d in n){var m=n[d];o[e[d]]=m}var v=t.scenes;for(var g in v){var y=v[g];v[g]=e[y]}var x=t.packs;for(var S in x)for(var A=x[S],C=0;C<A.length;++C)A[C]=e[A[C]];var b=t.versions;if(b)for(var T in b)for(var E=b[T],w=0;w<E.length;w+=2){var P=E[w];E[w]=e[P]||P}var I=t.redirect;if(I)for(var R=0;R<I.length;R+=2)I[R]=e[I[R]],I[R+1]=r[I[R+1]];if(t.extensionMap){var D=function(n){if(!Object.prototype.hasOwnProperty.call(t.extensionMap,n))return"continue";t.extensionMap[n].forEach((function(i,r){t.extensionMap[n][r]=e[i]||i}))};for(var B in t.extensionMap)D(B)}}(t),this.importBase=t.importBase||"",this.nativeBase=t.nativeBase||"",this.base=t.base||"",this.name=t.name||"",this.deps=t.deps||[],this._initUuid(t.uuids),this._initPath(t.paths),this._initScene(t.scenes),this._initPackage(t.packs),this._initVersion(t.versions),this._initRedirect(t.redirect);var n=function(n){if(!Object.prototype.hasOwnProperty.call(t.extensionMap,n))return"continue";t.extensionMap[n].forEach((function(t){var i=e.assetInfos.get(t);i&&(i.extension=n)}))};for(var i in t.extensionMap)n(i)},e.getInfoWithPath=function(t,e){if(!t)return null;t=cu(t);var n=this.paths.get(t);if(n){if(!e)return n[0];for(var i=0,r=n.length;i<r;i++){var o=n[i];if(kt.isChildClassOf(o.ctor,e))return o}}return null},e.getDirWithPath=function(t,e,n){"/"===(t=cu(t))[t.length-1]&&(t=t.slice(0,-1));var i=n||[];return this.paths.forEach((function(n,r){if(r.startsWith(t)&&function(t,e){return!(t.length>e.length)||47===t.charCodeAt(e.length)}(r,t)||!t)for(var o=0,a=n.length;o<a;o++){var s=n[o];e&&!kt.isChildClassOf(s.ctor,e)||i.push(s)}})),i},e.getAssetInfo=function(t){return this.assetInfos.get(t)||null},e.getSceneInfo=function(t){return t.endsWith(".scene")||(t+=".scene"),"/"===t[0]||t.startsWith("db://")||(t="/"+t),this.scenes.find((function(e,n){return n.endsWith(t)}))},e.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},e._initUuid=function(t){if(t){this.assetInfos.clear();for(var e=0,n=t.length;e<n;e++){var i=t[e];this.assetInfos.add(i,{uuid:i})}}},e._initPath=function(t){if(t){var e=this.paths;for(var n in e.clear(),t){var i=t[n],r=i[0],o=i[1],a=3===i.length,s=this.assetInfos.get(n);s.path=r,s.ctor=kt._getClassById(o),e.has(r)?a?e.get(r).push(s):e.get(r).unshift(s):e.add(r,[s])}}},e._initScene=function(t){if(t){var e=this.scenes;e.clear();var n=this.assetInfos;for(var i in t){var r=t[i],o=n.get(r);o.url=i,e.add(i,o)}}},e._initPackage=function(t){if(t){var e=this.assetInfos;for(var n in t){var i=t[n],r={uuid:n,packedUuids:i,ext:".json"};e.add(n,r);for(var o=0,a=i.length;o<a;o++){var s=i[o],c=e.get(s),l=c.packs;l?1===a?l.unshift(r):l.push(r):c.packs=[r]}}}},e._initVersion=function(t){if(t){var e=this.assetInfos,n=t.import;if(n)for(var i=0,r=n.length;i<r;i+=2){var o=n[i];e.get(o).ver=n[i+1]}if(n=t.native)for(var a=0,s=n.length;a<s;a+=2){var c=n[a];e.get(c).nativeVer=n[a+1]}}},e._initRedirect=function(t){if(t)for(var e=this.assetInfos,n=0,i=t.length;n<i;n+=2){var r=t[n];e.get(r).redirect=t[n+1]}},t}();function zM(t,e){t._uuid&&e.push(t._uuid)}function VM(t,e){for(var n=Object.getOwnPropertyNames(t),i=0;i<n.length;i++){var r=n[i];if("node"!==r&&"__eventTargets"!==r){var o=t[r];if("object"==typeof o&&o)if(Array.isArray(o))for(var a=0;a<o.length;a++){var s=o[a];s instanceof Su&&zM(s,e)}else if(o.constructor&&o.constructor!==Object)o instanceof Su&&zM(o,e);else for(var c=Object.getOwnPropertyNames(o),l=0;l<c.length;l++){var u=o[c[l]];u instanceof Su&&zM(u,e)}}}}function GM(t,e){for(var n=0;n<t._components.length;n++)VM(t._components[n],e);for(var i=0;i<t._children.length;i++)GM(t._children[i],e)}function UM(t,e,n,i){n.push(t._uuid);for(var r=wm.getDeps(t._uuid),o=0,a=r.length;o<a;o++){var s=jl.get(r[o]);if(s){var c=s._uuid;c in e?e[c]+=i:e[c]=s.refCount+i,n.includes(c)||UM(s,e,n,i)}}}var kM=[],HM=new(function(){function t(){this._persistNodeDeps=new Ul,this._toDelete=new Ul,this._eventListener=!1}var e=t.prototype;return e.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},e._addPersistNodeRef=function(t){var e=[];GM(t,e);for(var n=0,i=e.length;n<i;n++){var r=jl.get(e[n]);r&&r.addRef()}this._persistNodeDeps.add(t.uuid,e)},e._removePersistNodeRef=function(t){if(this._persistNodeDeps.has(t.uuid)){for(var e=this._persistNodeDeps.get(t.uuid),n=0,i=e.length;n<i;n++){var r=jl.get(e[n]);r&&r.decRef()}this._persistNodeDeps.remove(t.uuid)}},e._autoRelease=function(t,e,n){if(t){for(var i=wm.getDeps(t.uuid),r=0,o=i.length;r<o;r++){var a=jl.get(i[r]);a&&a.decRef(t.autoReleaseAssets)}var s=wm._depends.get(t.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=jl.get(c[l]);h&&h.decRef(t.autoReleaseAssets)}t.uuid!==e.uuid&&wm.remove(t.uuid)}var _=wm._depends.get(e.uuid);for(var f in _&&(_.persistDeps=[]),n){for(var p,d,m=n[f],v=this._persistNodeDeps.get(m.uuid),g=W(v);!(d=g()).done;){var y=d.value,x=jl.get(y);x&&x.addRef()}_&&(p=_.persistDeps).push.apply(p,v)}},e.tryRelease=function(t,e){void 0===e&&(e=!1),t instanceof Su&&(e?this._free(t,e):(this._toDelete.add(t._uuid,t),this._eventListener||(this._eventListener=!0,he(this._freeAssets.bind(this)))))},e._freeAssets=function(){var t=this;this._eventListener=!1,this._toDelete.forEach((function(e){t._free(e)})),this._toDelete.clear()},e._free=function(t,e){void 0===e&&(e=!1);var n=t._uuid;if(this._toDelete.remove(n),Ze(t,!0)&&!(!e&&t.refCount>0&&function(t){var e=Object.create(null);if(e[t._uuid]=t.refCount,UM(t,e,kM,-1),kM.length=0,0!==e[t._uuid])return e[t._uuid];for(var n in e)0!==e[n]&&UM(jl.get(n),e,kM,1);return kM.length=0,e[t._uuid]}(t)>0)){jl.remove(n);for(var i=wm.getDeps(n),r=0,o=i.length;r<o;r++){var a=jl.get(i[r]);a&&(a.decRef(!1),this._free(a,!1))}t.destroy(),wm.remove(n)}},t}());function jM(t,e){for(var n=0,i=t.input.length;n<i;n++){var r=t.input[n];e&&!r.isNative&&r.content instanceof Su&&r.content.decRef(!1),r.recycle()}t.input=null}function WM(t,e){return e?/\?/.test(t)?t+"&_t="+Date.now():t+"?_t="+Date.now():t}function qM(t,e,n,i,r){void 0===r&&(r=0),t(r,(function(o,a){r++,!o||r>e?i&&i(o,a):setTimeout((function(){qM(t,e,n,i,r)}),n)}))}function XM(t,e,n,i,r){try{for(var o=wm.parse(t,e),a=0,s=o.deps.length;a<s;a++){var c=o.deps[a];c in n||(n[c]=!0,i.push({uuid:c,bundle:r&&r.name}))}o.nativeDep&&(r&&(o.nativeDep.bundle=r.name),i.push(L({},o.nativeDep)))}catch(t){d(t.message,t.stack)}}function YM(t,e,n){e&&(n=void 0!==n?n:i.assetManager.cacheAsset,su(e)||!n||e.isDefault||jl.add(t,e))}function KM(t,e,n){var i=0,r=[],o=t.length;0===o&&n&&n(r);for(var a=function(t){t&&r.push(t),++i===o&&n&&n(r)},s=0;s<o;s++)e(t[s],a)}function JM(t,e,n){var i=t,r=e,o=n;if(void 0===n){var a="function"==typeof t;e?(o=e,a||(r=null)):void 0===e&&a&&(o=t,i=null,r=null),void 0!==e&&a&&(r=t,i=null)}return{options:i||Object.create(null),onProgress:r,onComplete:o}}function QM(t,e,n){var i=t,r=e,o=n;if(void 0===n){var a=kt.isChildClassOf(t,Su);e?(o=e,a&&(r=null)):void 0!==e||a||(o=t,r=null,i=null),void 0===e||a||(r=t,i=null)}return{type:i,onProgress:r||null,onComplete:o}}function ZM(t,e,n,i){if(void 0===i&&(i={}),!n[e]||i[e])return!1;i[e]=!0;var r=!1,o=wm.getDeps(e);if(o)for(var a=0,s=o.length;a<s;a++){var c=o[a];if(c===t||ZM(t,c,n,i)){r=!0;break}}return r}function $M(t){return function(e,n){if(t){var i=[];Array.isArray(n)?n.forEach((function(t){return t instanceof Su&&i.push(t.addRef())})):n instanceof Su&&i.push(n.addRef()),he((function(){i.forEach((function(t){return t.decRef(!1)})),t(e,n)}))}}}var tO=function(){function t(){this._config=new FM}var e=t.prototype;return e.getInfoWithPath=function(t,e){return this._config.getInfoWithPath(t,e)},e.getDirWithPath=function(t,e,n){return this._config.getDirWithPath(t,e,n)},e.getAssetInfo=function(t){return this._config.getAssetInfo(t)},e.getSceneInfo=function(t){return this._config.getSceneInfo(t)},e.init=function(t){this._config.init(t),Xl.add(t.name,this)},e.load=function(t,e,n,r){var o=QM(e,n,r),a=o.type,s=o.onProgress,c=o.onComplete,l={__requestType__:Hl.PATH,type:a,bundle:this.name,__outputAsArray__:Array.isArray(t)};i.assetManager.loadAny(t,l,s,c)},e.preload=function(t,e,n,r){var o=QM(e,n,r),a=o.type,s=o.onProgress,c=o.onComplete;i.assetManager.preloadAny(t,{__requestType__:Hl.PATH,type:a,bundle:this.name},s,c)},e.loadDir=function(t,e,n,r){var o=QM(e,n,r),a=o.type,s=o.onProgress,c=o.onComplete;i.assetManager.loadAny(t,{__requestType__:Hl.DIR,type:a,bundle:this.name,__outputAsArray__:!0},s,c)},e.preloadDir=function(t,e,n,r){var o=QM(e,n,r),a=o.type,s=o.onProgress,c=o.onComplete;i.assetManager.preloadAny(t,{__requestType__:Hl.DIR,type:a,bundle:this.name},s,c)},e.loadScene=function(t,e,n,r){var o=JM(e,n,r),a=o.options,s=o.onProgress,c=o.onComplete;a.preset=a.preset||"scene",a.bundle=this.name,i.assetManager.loadAny({scene:t},a,s,(function(t,e){if(t)d(t.message,t.stack);else if(e instanceof dD&&e.scene){var n=e.scene;n._id=e._uuid,n.name=e.name}else t=new Error("The asset "+e._uuid+" is not a scene");c&&c(t,e)}))},e.preloadScene=function(t,e,n,r){var o=JM(e,n,r),a=o.options,s=o.onProgress,c=o.onComplete;a.bundle=this.name,i.assetManager.preloadAny({scene:t},a,s,(function(e){e&&E(1210,t,e.message),c&&c(e)}))},e.get=function(t,e){var n=this.getInfoWithPath(t,e);return n&&jl.get(n.uuid)||null},e.release=function(t,e){var n=this.get(t,e);n&&HM.tryRelease(n,!0)},e.releaseUnusedAssets=function(){var t=this;jl.forEach((function(e){var n=t.getAssetInfo(e._uuid);n&&!n.redirect&&HM.tryRelease(e)}))},e.releaseAll=function(){var t=this;jl.forEach((function(e){var n=t.getAssetInfo(e._uuid);n&&!n.redirect&&HM.tryRelease(e,!0)}))},e._destroy=function(){this._config.destroy()},N(t,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),t}(),eO=t("resources",new tO);function nO(t,e,n){var i=new Image;function r(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(null,i)}function o(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(new Error(R(4930,t)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",r),i.addEventListener("error",o),i.src=t,i}function iO(t,e,n,i){var r=new XMLHttpRequest,o="download failed: "+t+", status: ";if(r.open("GET",t,!0),void 0!==e.xhrResponseType&&(r.responseType=e.xhrResponseType),void 0!==e.xhrWithCredentials&&(r.withCredentials=e.xhrWithCredentials),void 0!==e.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(e.xhrMimeType),void 0!==e.xhrTimeout&&(r.timeout=e.xhrTimeout),e.xhrHeader)for(var a in e.xhrHeader)r.setRequestHeader(a,e.xhrHeader[a]);return r.onload=function(){200===r.status||0===r.status?i&&i(null,r.response):i&&i(new Error(""+o+r.status+"(no response)"))},n&&(r.onprogress=function(t){t.lengthComputable&&n(t.loaded,t.total)}),r.onerror=function(){i&&i(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){i&&i(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){i&&i(new Error(""+o+r.status+"(abort)"))},r.send(null),r}i.resources=eO;var rO={};function oO(t,e,n){if(rO[t])return n&&n(null),null;var i=document.createElement("script");function r(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),rO[t]=!0,n&&n(null)}function o(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),n&&n(new Error(R(4928,t)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=e.scriptAsyncLoading||!1,i.src=t,i.addEventListener("load",r,!1),i.addEventListener("error",o,!1),document.body.appendChild(i),i}var aO=/^(?:\w+:\/\/|\.+\/).+/,sO=function(t,e,n){(Zu.hasFeature(Zu.Feature.IMAGE_BITMAP)&&i.assetManager.allowImageBitmap?cO:nO)(t,e,n)},cO=function(t,e,n){e.xhrResponseType="blob",iO(t,e,e.onFileProgress,n)},lO=function(t,e,n){e.xhrResponseType="json",iO(t,e,e.onFileProgress,n)},uO=function(t,e,n){e.xhrResponseType="arraybuffer",iO(t,e,e.onFileProgress,n)},hO=function(t,e,n){lO(t,e,(function(e,i){if(e)n(e);else{var r=nh(i);Promise.all(r.chunks.map((function(n){return new Promise((function(i,r){uO(""+Sn(t)+n,{},(function(t,n){e?r(e):i(new Uint8Array(n))}))}))}))).then((function(t){var e=new eh(r.document,t);n(null,e)})).catch((function(t){n(t)}))}}))},_O=function(t,e,n){uO(t,e,(function(t,e){if(t)n(t);else try{var i=ih(new Uint8Array(e));n(null,i)}catch(t){n(t)}}))},fO=function(t,e,n){e.xhrResponseType="text",iO(t,e,e.onFileProgress,n)},pO=function(t,e,n){var i=An(t),r=t;aO.test(r)||(r=-1!==dO.remoteBundles.indexOf(i)?dO.remoteServerAddress+"remote/"+i:"assets/"+i);var o=e.version||dO.bundleVers[i],a=0,s=null,c=null;lO(r+"/config."+(o?o+".":"")+"json",e,(function(t,e){c=t,(s=e)&&(s.base=r+"/"),2==++a&&n(c,s)})),oO(r+"/index."+(o?o+".":"")+"js",e,(function(t){c=t,2==++a&&n(t,s)}))},dO=new(function(){function t(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=nO,this.downloadDomAudio=null,this.downloadFile=iO,this.downloadScript=oO,this._downloaders={".png":sO,".jpg":sO,".bmp":sO,".jpeg":sO,".gif":sO,".ico":sO,".tiff":sO,".webp":sO,".image":sO,".pvr":uO,".pkm":uO,".astc":uO,".txt":fO,".xml":fO,".vsh":fO,".fsh":fO,".atlas":fO,".tmx":fO,".tsx":fO,".json":lO,".ExportJson":lO,".plist":fO,".ccon":hO,".cconb":_O,".fnt":fO,".binary":uO,".bin":uO,".dbbin":uO,".skel":uO,".js":oO,bundle:pO,default:fO},this._downloading=new Ul,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}var e=t.prototype;return e.init=function(t,e,n){void 0===t&&(t=""),void 0===e&&(e={}),void 0===n&&(n=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=t,this.bundleVers=e,this.remoteBundles=n},e.register=function(t,e){"object"==typeof t?bt(this._downloaders,t):this._downloaders[t]=e},e.download=function(t,e,n,i,r){var o=this,a=Wl.get(t);if(a)r(null,a);else{var s=this._downloading.get(t);if(s){s.push(r);var c=this._queue.find((function(e){return e.id===t}));if(!c)return;var l=i.priority||0;c.priority<l&&(c.priority=l,this._queueDirty=!0)}else{var u=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,h=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,_=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,f=this._downloaders[n]||this._downloaders.default;qM((function(n,a){if(0===n&&o._downloading.add(t,[r]),o.limited){o._updateTime();var s=function(t,e){o._totalNum--,o._handleQueueInNextFrame(h,_),a(t,e)};o._totalNum<h&&o._totalNumThisPeriod<_?(f(WM(e,o.appendTimeStamp),i,s),o._totalNum++,o._totalNumThisPeriod++):(o._queue.push({id:t,priority:i.priority||0,url:e,options:i,done:s,handler:f}),o._queueDirty=!0,o._totalNum<h&&o._handleQueueInNextFrame(h,_))}else f(WM(e,o.appendTimeStamp),i,a)}),u,this.retryInterval,(function(e,n){e||Wl.add(t,n);for(var i=o._downloading.remove(t),r=0,a=i.length;r<a;r++)i[r](e,n)}))}}},e.loadSubpackage=function(t,e){i.assetManager.loadBundle(t,null,e)},e._updateTime=function(){var t=performance.now(),e=i.game.deltaTime,n=e>this._maxInterval?this._maxInterval:e;t-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=t)},e._handleQueue=function(t,e){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<t&&this._totalNumThisPeriod<e;){this._queueDirty&&(this._queue.sort((function(t,e){return t.priority-e.priority})),this._queueDirty=!1);var n=this._queue.pop();if(!n)break;this._totalNum++,this._totalNumThisPeriod++,n.handler(WM(n.url,this.appendTimeStamp),n.options,n.done)}this._handleQueueInNextFrame(t,e)},e._handleQueueInNextFrame=function(t,e){!this._checkNextPeriod&&this._queue.length>0&&(he(this._handleQueue.bind(this),t,e),this._checkNextPeriod=!0)},N(t,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),t}());function mO(t,e,n,i){var r=null,o=null;try{(r=new ym)._nativeUrl=t,r._nativeAsset=e}catch(t){o=t}i(o,r)}function vO(t,e,n,i){var r=new SD;r.json=e,i(null,r)}function gO(t,e,n,i){var r=new xD;r.text=e,i(null,r)}function yO(t,e,n,i){var r=new SE;r._nativeUrl=t,r._nativeAsset=e,i(null,r)}function xO(t,e,n,i){var r=new Su;r._nativeUrl=t,r._nativeAsset=e,i(null,r)}function SO(t,n,i,r){var o=Xl.get(n.name);o||(o=n.name===Ql.RESOURCES?eO:new tO,n.base=n.base||t+"/",o.init(n)),e.import("virtual:///prerequisite-imports/"+o.name).then((function(){r(null,o)})).catch(r)}var AO=new(function(){function t(){this._creating=new Ul,this._producers={".png":mO,".jpg":mO,".bmp":mO,".jpeg":mO,".gif":mO,".ico":mO,".tiff":mO,".webp":mO,".image":mO,".pvr":mO,".pkm":mO,".txt":gO,".xml":gO,".vsh":gO,".fsh":gO,".atlas":gO,".tmx":gO,".tsx":gO,".fnt":gO,".json":vO,".ExportJson":vO,".binary":yO,".bin":yO,".dbbin":yO,".skel":yO,bundle:SO,default:xO}}var e=t.prototype;return e.register=function(t,e){"object"==typeof t?kt.mixin(this._producers,t):this._producers[t]=e},e.create=function(t,e,n,i,r){var o=this,a=this._producers[n]||this._producers.default,s=jl.get(t);if(i.reloadAsset||!s){var c=this._creating.get(t);c?c.push(r):(this._creating.add(t,[r]),a(t,e,i,(function(e,n){!e&&n instanceof Su&&(n._uuid=t,YM(t,n,i.cacheAsset));for(var r=o._creating.remove(t),a=0,s=r.length;a<s;a++)r[a](e,n)})))}else r(null,s)},t}()),CO=new(function(){function t(){this._loading=new Ul,this._unpackers={".json":this.unpackJson}}var e=t.prototype;return e.unpackJson=function(t,e,n,i){var r=kt.createMap(!0),o=null;if(Array.isArray(e)){(e=function(t){if(t[0]<1)throw new Error(R(5304,t[0]));Ch(t,!0,void 0,Th.reportMissingClass),bh(t);for(var e=new Eh(t[0]),n=t[1],i=t[2],r=t[3],o=t[4],a=t[5],s=0;s<a.length;++s)a[s].unshift(e,n,i,r,o);return a}(e)).length!==t.length&&E(4915);for(var a=0;a<t.length;a++)r[t[a]+"@import"]=e[a]}else{var s=kt._getClassId(jm),c=kt._getClassId(ym);if(e.type===s&&e.data){var l=e.data;l.length!==t.length&&E(4915);for(var u=0;u<t.length;u++)r[t[u]+"@import"]=wh(s,{base:l[u][0],mipmaps:l[u][1]})}else if(e.type===c&&e.data){var h=e.data;h.length!==t.length&&E(4915);for(var _=0;_<t.length;_++)r[t[_]+"@import"]=h[_]}else o=new Error("unmatched type pack!"),r=null}i(o,r)},e.init=function(){this._loading.clear()},e.register=function(t,e){"object"==typeof t?kt.mixin(this._unpackers,t):this._unpackers[t]=e},e.unpack=function(t,e,n,i,r){e?(0,this._unpackers[n])(t,e,i,r):r(new Error("package data is wrong!"))},e.load=function(t,e,n){var i=this;if(!t.isNative&&t.info&&t.info.packs)if(Wl.has(t.id))n(null,Wl.get(t.id));else{var r=t.info.packs,o=r.find((function(t){return i._loading.has(t.uuid)}));if(o)this._loading.get(o.uuid).push({onComplete:n,id:t.id});else{o=r[0],this._loading.add(o.uuid,[{onComplete:n,id:t.id}]);var a=lu(o.uuid,{ext:o.ext,bundle:t.config.name});dO.download(o.uuid,a,o.ext,t.options,(function(e,n){Wl.remove(o.uuid),e&&d(e.message,e.stack),i.unpack(o.packedUuids,n,o.ext,t.options,(function(t,n){if(!t)for(var r in n)Wl.add(r,n[r]);for(var a=i._loading.remove(o.uuid),s=0,c=a.length;s<c;s++){var l=a[s];if(e||t)l.onComplete(e||t);else{var u=n[l.id];u?l.onComplete(null,u):l.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else dO.download(t.id,t.url,t.ext,t.options,n)},t}());function bO(t,e){var n=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},n=!0);var r=t.options,o=t.progress,a=[],s=o.total,c=r.__exclude__=r.__exclude__||Object.create(null);t.output=[],KM(t.input,(function(r,l){if(!r.isNative&&jl.has(r.uuid)){var u=jl.get(r.uuid);return r.content=u.addRef(),t.output.push(r),o.canInvoke&&t.dispatch("progress",++o.finish,o.total,r),void l()}CO.load(r,t.options,(function(u,h){u?t.isFinish||(!i.assetManager.force||n?(d(u.message,u.stack),o.canInvoke=!1,e(u)):(t.output.push(r),o.canInvoke&&t.dispatch("progress",++o.finish,o.total,r))):t.isFinish||(r.file=h,t.output.push(r),r.isNative||(c[r.uuid]=!0,XM(r.uuid,h,c,a,r.config),o.total=s+a.length),o.canInvoke&&t.dispatch("progress",++o.finish,o.total,r)),l()}))}),(function(){if(t.isFinish)return jM(t,!0),void t.dispatch("error");if(a.length>0){var i=$l.create({input:a,progress:o,options:r,onProgress:t.onProgress,onError:$l.prototype.recycle,onComplete:function(r){var o;r||((o=t.output).push.apply(o,i.output),i.recycle()),n&&TO(t),e(r)}});Kl.async(i)}else n&&TO(t),e()}))}function TO(t){for(var e=t.output,n=0,i=e.length;n<i;n++)e[n].content&&e[n].content.decRef(!1)}var EO=new(function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.parse=function(t){var e=this._parseXML(t).documentElement;if("plist"!==e.tagName)return b(5100),{};for(var n=null,i=0,r=e.childNodes.length;i<r&&1!==(n=e.childNodes[i]).nodeType;i++);return this._parseNode(n)},n._parseNode=function(t){var e=null,n=t.tagName;if("dict"===n)e=this._parseDict(t);else if("array"===n)e=this._parseArray(t);else if("string"===n)if(1===t.childNodes.length)e=t.firstChild.nodeValue;else{e="";for(var i=0;i<t.childNodes.length;i++)e+=t.childNodes[i].nodeValue}else"false"===n?e=!1:"true"===n?e=!0:"real"===n?e=parseFloat(t.firstChild.nodeValue):"integer"===n&&(e=parseInt(t.firstChild.nodeValue,10));return e},n._parseArray=function(t){for(var e=[],n=0,i=t.childNodes.length;n<i;n++){var r=t.childNodes[n];1===r.nodeType&&e.push(this._parseNode(r))}return e},n._parseDict=function(t){for(var e={},n="",i=0,r=t.childNodes.length;i<r;i++){var o=t.childNodes[i];1===o.nodeType&&("key"===o.tagName?n=o.firstChild.nodeValue:e[n]=this._parseNode(o))}return e},e}(function(){function t(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}var e=t.prototype;return e.parse=function(t){return this._parseXML(t)},e._parseXML=function(t){if(this._parser)return this._parser.parseFromString(t,"text/xml");throw new Error("Dom parser is not supported in this platform!")},t}()));function wO(t,e){return t[e]<<8|t[e+1]}var PO=new(function(){function t(){this._parsing=new Ul,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}var e=t.prototype;return e.parseImage=function(t,e,n){t instanceof HTMLImageElement?n(null,t):createImageBitmap(t,{premultiplyAlpha:"none"}).then((function(t){n(null,t)}),(function(t){n(t,null)}))},e.parsePVRTex=function(t,e,n){var i=null,r=null;try{var o=t instanceof ArrayBuffer?t:t.buffer,a=new Int32Array(o,0,13);if(55727696===a[0]){var s=a[7],c=a[6],l=a[12]+52;r={_data:new Uint8Array(o,l),_compressed:!0,width:s,height:c,format:0}}else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var u=a[0],h=a[1],_=a[2];r={_data:new Uint8Array(o,u),_compressed:!0,width:_,height:h,format:0}}}catch(t){i=t}n(i,r)},e.parsePKMTex=function(t,e,n){var i=null,r=null;try{var o=t instanceof ArrayBuffer?t:t.buffer,a=new Uint8Array(o),s=wO(a,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=wO(a,12),l=wO(a,14);wO(a,8),wO(a,10),r={_data:new Uint8Array(o,16),_compressed:!0,width:c,height:l,format:0}}catch(t){i=t}n(i,r)},e.parseASTCTex=function(t,e,n){var i=null,r=null;try{var o=t instanceof ArrayBuffer?t:t.buffer,a=new Uint8Array(o);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=a[4],c=a[5],l=a[6];if((s<3||s>6||c<3||c>6||l<3||l>6)&&(s<4||7===s||9===s||11===s||s>12||c<4||7===c||9===c||11===c||c>12||1!==l))throw new Error("Invalid block number in ASTC header");var u=function(t,e){return 4===t?Xd.RGBA_ASTC_4x4:5===t?4===e?Xd.RGBA_ASTC_5x4:Xd.RGBA_ASTC_5x5:6===t?5===e?Xd.RGBA_ASTC_6x5:Xd.RGBA_ASTC_6x6:8===t?5===e?Xd.RGBA_ASTC_8x5:6===e?Xd.RGBA_ASTC_8x6:Xd.RGBA_ASTC_8x8:10===t?5===e?Xd.RGBA_ASTC_10x5:6===e?Xd.RGBA_ASTC_10x6:8===e?Xd.RGBA_ASTC_10x8:Xd.RGBA_ASTC_10x10:10===e?Xd.RGBA_ASTC_12x10:Xd.RGBA_ASTC_12x12}(s,c),h=a[7]+(a[8]<<8)+(a[9]<<16),_=a[10]+(a[11]<<8)+(a[12]<<16);a[13],a[14],a[15],r={_data:new Uint8Array(o,16),_compressed:!0,width:h,height:_,format:u}}catch(t){i=t}n(i,r)},e.parsePlist=function(t,e,n){var i=null,r=EO.parse(t);r||(i=new Error("parse failed")),n(i,r)},e.parseImport=function(t,e,n){if(t){var i=null,r=null;try{i=Tm(t,e)}catch(t){r=t}n(r,i)}else n(new Error("The json file of asset "+e.__uuid__+" is empty or missing"))},e.init=function(){this._parsing.clear()},e.register=function(t,e){"object"==typeof t?bt(this._parsers,t):this._parsers[t]=e},e.parse=function(t,e,n,i,r){var o=this,a=ql.get(t);if(a)r(null,a);else{var s=this._parsing.get(t);if(s)s.push(r);else{var c=this._parsers[n];c?(this._parsing.add(t,[r]),c(e,i,(function(e,n){e?Wl.remove(t):su(n)||ql.add(t,n);for(var i=o._parsing.remove(t),r=0,a=i.length;r<a;r++)i[r](e,n)}))):r(null,e)}}},t}());function IO(t,e){var n=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},n=!0);var r=t.options,o=t.progress;r.__exclude__=r.__exclude__||Object.create(null),t.output=[],KM(t.input,(function(a,s){var c=$l.create({input:a,onProgress:t.onProgress,options:r,progress:o,onComplete:function(r,l){r&&!t.isFinish&&(!i.assetManager.force||n?(d(r.message,r.stack),o.canInvoke=!1,e(r)):o.canInvoke&&t.dispatch("progress",++o.finish,o.total,a)),t.output.push(l),c.recycle(),s(null)}});RO.async(c)}),(function(){if(r.__exclude__=null,t.isFinish)return jM(t,!0),void t.dispatch("error");!function(t){var e=t.source;if(t.options.__outputAsArray__||1!==e.length)for(var n=t.output=[],i=0,r=e.length;i<r;i++)n.push(e[i].content);else t.output=e[0].content}(t),jM(t,!0),e()}))}var RO=new kl("loadOneAsset",[function(t,e){var n=t.output=t.input,i=n.options,r=n.isNative,o=n.uuid,a=n.file,s=i.reloadAsset;a||!s&&!r&&jl.has(o)?e():CO.load(n,t.options,(function(t,i){n.file=i,e(t)}))},function(t,e){var n=t.output=t.input,i=t.progress,r=t.options.__exclude__,o=n.id,a=n.file,s=n.options;if(n.isNative)PO.parse(o,a,n.ext,s,(function(r,a){r?e(r):(n.content=a,i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),Wl.remove(o),ql.remove(o),e())}));else{var c=n.uuid;if(c in r){var l=r[c],u=l.finish,h=l.content,_=l.err,f=l.callbacks;i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),u||ZM(c,c,r)?(h&&h.addRef(),n.content=h,e(_)):f.push({done:e,item:n})}else if(!s.reloadAsset&&jl.has(c)){var p=jl.get(c);n.content=p.addRef(),i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),e()}else s.__uuid__=c,PO.parse(o,a,"import",s,(function(n,i){n?e(n):function(t,e,n){var i=t.input,r=t.progress,o=i,a=o.uuid,s=o.id,c=o.options,l=o.config,u=c.cacheAsset,h=[];e.addRef&&e.addRef(),XM(a,e,Object.create(null),h,l),r.canInvoke&&t.dispatch("progress",++r.finish,r.total+=h.length,i);var _=t.options.__exclude__[a]={content:e,finish:!1,callbacks:[{done:n,item:i}]},f=$l.create({input:h,options:t.options,onProgress:t.onProgress,onError:$l.prototype.recycle,progress:r,onComplete:function(t){if(e.decRef&&e.decRef(!1),_.finish=!0,_.err=t,!t){for(var n,i=Array.isArray(f.output)?f.output:[f.output],r=Object.create(null),o=W(i);!(n=o()).done;){var c=n.value;c&&(r[c instanceof Su?c._uuid+"@import":a+"@native"]=c)}!function(t,e,n){var i=Am.get(e);if(i){for(var r=0,o=i.length;r<o;r++){var a=i[r],s=n[a.uuid+"@import"];if(s)a.owner[a.prop]=s.addRef();else{if(d("The asset "+a.uuid+" is missing!"),a.type&&a.type!==Su){var c=new a.type;c.initDefault(a.uuid),a.owner[a.prop]=c}!0}}Am.delete(e)}Cm.has(e)&&(n[t+"@native"]?e._nativeAsset=n[t+"@native"]:(!0,console.error("the native asset of "+t+" is missing!")),Cm.delete(e))}(a,e,r);try{"function"!=typeof e.onLoaded||bm.has(e)||Cm.has(e)||(e.onLoaded(),bm.add(e))}catch(t){d("The asset "+a+" is invalid for some reason, detail message: "+t.message+", stack: "+t.stack)}Wl.remove(s),ql.remove(s),YM(a,e,u),f.recycle()}for(var l=_.callbacks,h=0,p=l.length;h<p;h++){var m=l[h];e.addRef&&e.addRef(),m.item.content=e,m.done(t)}l.length=0}});Yl.async(f)}(t,i,e)}))}}]);function DO(t,e){var n=t.options,i=Object.create(null),r=Object.create(null);for(var o in n)switch(o){case Hl.PATH:case Hl.UUID:case Hl.DIR:case Hl.SCENE:case Hl.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[o]=n[o];break;case"__exclude__":case"__outputAsArray__":r[o]=n[o];break;default:i[o]=n[o],r[o]=n[o]}t.options=r;var a=$l.create({input:t.input,options:i}),s=null;try{t.output=t.source=Jl.sync(a)}catch(t){s=t;for(var c=0,l=a.output.length;c<l;c++)a.output[c].recycle()}a.recycle(),e(s)}var BO=function(){function t(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return t.create=function(){return 0!==t._deadPool.length?t._deadPool.pop():new t},t.prototype.recycle=function(){t._deadPool.length!==t.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),t._deadPool.push(this))},N(t,[{key:"id",get:function(){return this._id||(this._id=this.uuid+"@"+(this.isNative?"native":"import")),this._id}}]),t}();BO.MAX_DEAD_NUM=500,BO._deadPool=[];var MO=[];function OO(t){var e=t.options,n=Array.isArray(t.input)?t.input:[t.input];t.output=[];for(var i=function(i){var r,o=n[i],a=BO.create(),s=null,c=null;if("string"==typeof o&&((o=Object.create(null))[e.__requestType__||Hl.UUID]=n[i]),"object"==typeof o)for(var l in Ct(o,e),o.preset&&Ct(o,Zl[o.preset]),o){switch(l){case Hl.UUID:if("break"===function(){var t,e=a.uuid=ru(o.uuid);if(!o.bundle){var n=Xl.find((function(t){return!!t.getAssetInfo(e)}));o.bundle=n&&n.name}if(Xl.has(o.bundle)){if(s=Xl.get(o.bundle).config,(c=s.getAssetInfo(e))&&c.redirect){if(!Xl.has(c.redirect))throw new Error("Please load bundle "+c.redirect+" first");s=Xl.get(c.redirect).config,c=s.getAssetInfo(e)}a.config=s,a.info=c}return a.ext=o.ext||(null===(t=c)||void 0===t?void 0:t.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case Hl.DIR:if(Xl.has(o.bundle)){Xl.get(o.bundle).config.getDirWithPath(o.dir,o.type,MO);for(var u,h=W(MO);!(u=h()).done;){var _=u.value;n.push({uuid:_.uuid,__isNative__:!1,ext:_.extension||".json",bundle:o.bundle})}MO.length=0}a.recycle(),a=null;break;case Hl.PATH:if(Xl.has(o.bundle)){if(s=Xl.get(o.bundle).config,(c=s.getInfoWithPath(o.path,o.type))&&c.redirect){if(!Xl.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=Xl.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+o.bundle+" doesn't contain "+o.path);a.config=s,a.uuid=c.uuid,a.info=c}a.ext=o.ext||(null===(r=c)||void 0===r?void 0:r.extension)||".json";break;case Hl.SCENE:if(!o.bundle){var f=Xl.find((function(t){return!!t.getSceneInfo(o.scene)}));o.bundle=f&&f.name}if(Xl.has(o.bundle)){if(s=Xl.get(o.bundle).config,(c=s.getSceneInfo(o.scene))&&c.redirect){if(!Xl.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=Xl.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+s.name+" doesn't contain scene "+o.scene);a.config=s,a.uuid=c.uuid,a.info=c}break;case"__isNative__":a.isNative=o.__isNative__;break;case Hl.URL:a.url=o.url,a.uuid=o.uuid||o.url,a.ext=o.ext||xn(o.url),a.isNative=void 0===o.__isNative__||o.__isNative__;break;default:a.options[l]=o[l]}if(!a)break}if(!a)return"continue";if(t.output.push(a),!a.uuid&&!a.url)throw new Error("Can not parse this input:"+JSON.stringify(o))},r=0;r<n.length;r++)i(r);return null}function NO(t){for(var e=t.output=t.input,n=0;n<e.length;n++){var r=e[n];if(!r.url){var o,a,s=r.config;a=r.isNative?s&&s.nativeBase?s.base+s.nativeBase:i.assetManager.generalNativeBase:s&&s.importBase?s.base+s.importBase:i.assetManager.generalImportBase;var c=r.uuid,l="";r.info&&(l=r.isNative?r.info.nativeVer?"."+r.info.nativeVer:"":r.info.ver?"."+r.info.ver:""),o=".ttf"===r.ext?a+"/"+c.slice(0,2)+"/"+c+l+"/"+r.options.__nativeName__:a+"/"+c.slice(0,2)+"/"+c+l+r.ext,r.url=o}}return null}var LO=t("AssetManager",function(){function t(){this.pipeline=Yl.append(DO).append(IO),this.fetchPipeline=Kl.append(DO).append(bO),this.transformPipeline=Jl.append(OO).append(NO),this.bundles=Xl,this.assets=jl,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=wm,this.force=!1,this.allowImageBitmap=!Zu.isMobile,this.utils=gu,this.downloader=dO,this.parser=PO,this.packManager=CO,this.cacheAsset=!0,this.cacheManager=null,this.presets=Zl,this.factory=AO,this.preprocessPipe=DO,this.fetchPipe=bO,this.loadPipe=IO,this.references=null,this._releaseManager=HM,this._files=Wl,this._parsed=ql,this._parsePipeline=null}var e=t.prototype;return e.init=function(t){void 0===t&&(t={}),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(t.server,t.bundleVers,t.remoteBundles),this.parser.init(),this.dependUtil.init();var e=t.importBase||"";e&&e.endsWith("/")&&(e=e.substr(0,e.length-1));var n=t.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=e,this.generalNativeBase=n},e.getBundle=function(t){return Xl.get(t)||null},e.removeBundle=function(t){t._destroy(),Xl.remove(t.name)},e.loadAny=function(t,e,n,i){var r=JM(e,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"default",t=Array.isArray(t)?t.slice():t;var c=$l.create({input:t,onProgress:a,onComplete:$M(s),options:o});Yl.async(c)},e.preloadAny=function(t,e,n,i){var r=JM(e,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"preload",t=Array.isArray(t)?t.slice():t;var c=$l.create({input:t,onProgress:a,onComplete:$M(s),options:o});Kl.async(c)},e.loadRemote=function(t,e,n){var i=JM(e,void 0,n),r=i.options,o=i.onComplete;r.reloadAsset||!this.assets.has(t)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:t},r,null,(function(e,n){e?(d(e.message,e.stack),o&&o(e,n)):AO.create(t,n,r.ext||xn(t),r,(function(t,e){o&&o(t,e)}))}))):$M(o)(null,this.assets.get(t))},e.loadBundle=function(t,e,n){var i=JM(e,void 0,n),r=i.options,o=i.onComplete,a=An(t);this.bundles.has(a)?$M(o)(null,this.getBundle(a)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:t},r,null,(function(e,n){e?(d(e.message,e.stack),o&&o(e,n)):AO.create(t,n,"bundle",r,(function(t,e){o&&o(t,e)}))})))},e.releaseAsset=function(t){HM.tryRelease(t,!0)},e.releaseUnusedAssets=function(){jl.forEach((function(t){HM.tryRelease(t)}))},e.releaseAll=function(){jl.forEach((function(t){HM.tryRelease(t,!0)}))},e.loadWithJson=function(){throw new Error("Only valid in Editor")},N(t,[{key:"main",get:function(){return Xl.get(Ql.MAIN)||null}},{key:"resources",get:function(){return Xl.get(Ql.RESOURCES)||null}}]),t}());LO.Pipeline=kl,LO.Task=$l,LO.Cache=Ul,LO.RequestItem=BO,LO.Bundle=tO,LO.BuiltinBundleName=Ql;var FO,zO,VO,GO,UO,kO,HO,jO,WO,qO,XO,YO,KO,JO,QO=t("assetManager",i.assetManager=new LO);i.AssetManager=LO;var ZO,$O,tN,eN,nN,iN,rN,oN,aN,sN,cN,lN,uN,hN,_N,fN,pN,dN,mN,vN,gN,yN,xN,SN,AN,CN,bN,TN,EN,wN,PN,IN,RN,DN,BN,MN,ON,NN,LN,FN,zN,VN,GN,UN,kN,HN,jN,WN,qN,XN,YN,KN,JN,QN,ZN,$N,tL,eL,nL,iL,rL,oL,aL,sL,cL,lL,uL,hL=t("EventHandler",(FO=qc("cc.ClickEvent"),zO=El(i.Node),VO=fl(),GO=fl(),UO=fl(),kO=fl(),FO((JO=function(){function t(){q(this,"target",WO,this),q(this,"component",qO,this),q(this,"_componentId",XO,this),q(this,"handler",YO,this),q(this,"customEventData",KO,this)}t.emitEvents=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var o=0,a=e.length;o<a;o++){var s=e[o];s instanceof t&&s.emit(i)}};var e=t.prototype;return e.emit=function(t){var e=this.target;if(i.isValid(e)){this._genCompIdIfNeeded();var n=i.js._getClassById(this._componentId),r=e.getComponent(n);if(i.isValid(r)){var o=r[this.handler];"function"==typeof o&&(null!=this.customEventData&&""!==this.customEventData&&(t=t.slice()).push(this.customEventData),o.apply(r,t))}}},e._compName2Id=function(t){var e=i.js.getClassByName(t);return i.js._getClassId(e)},e._compId2Name=function(t){var e=i.js._getClassById(t);return i.js.getClassName(e)},e._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},N(t,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(t){this._componentId=this._compName2Id(t)}}]),t}(),WO=X((jO=JO).prototype,"target",[Zc,zO,Zc,VO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qO=X(jO.prototype,"component",[Zc,ll,GO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),XO=X(jO.prototype,"_componentId",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),YO=X(jO.prototype,"handler",[Zc,ll,UO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),KO=X(jO.prototype,"customEventData",[Zc,ll,kO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),HO=jO))||HO));i.Component.EventHandler=hL;var _L,fL,pL,dL,mL,vL,gL,yL,xL,SL,AL=new oi,CL=Jt(Ed),bL=Jt(Td),TL=Jt(wd),EL=Jt(Id),wL=Jt(Pd),PL=Jt({SKYBOX:Hd|Yr.DEPTH_STENCIL,SOLID_COLOR:Yr.ALL,DEPTH_ONLY:Yr.DEPTH_STENCIL,DONT_CLEAR:Yr.NONE}),IL=t("Camera",(ZO=qc("cc.Camera"),$O=cl(),tN=rl(),eN=yl(),nN=fl(),iN=El(fp.BitMask),rN=yl(),oN=fl(),aN=El(PL),sN=yl(),cN=fl(),lN=yl(),uN=fl(),hN=yl(),_N=fl(),fN=yl(),pN=fl(),dN=El(CL),mN=yl(),vN=fl(),gN=El(bL),yN=yl(),xN=fl(),SN=yl(),AN=fl(),CN=yl(),bN=fl(),TN=yl(),EN=fl(),wN=yl(),PN=fl(),IN=El(TL),RN=yl(),DN=fl(),BN=El(EL),MN=yl(),ON=fl(),NN=El(wL),LN=yl(),FN=fl(),zN=yl(),VN=fl(),GN=El(KS),UN=yl(),kN=fl(),ZO(HN=$O(HN=tN(HN=il((uL=lL=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_projection",WN,H(e)),q(e,"_priority",qN,H(e)),q(e,"_fov",XN,H(e)),q(e,"_fovAxis",YN,H(e)),q(e,"_orthoHeight",KN,H(e)),q(e,"_near",JN,H(e)),q(e,"_far",QN,H(e)),q(e,"_color",ZN,H(e)),q(e,"_depth",$N,H(e)),q(e,"_stencil",tL,H(e)),q(e,"_clearFlags",eL,H(e)),q(e,"_rect",nL,H(e)),q(e,"_aperture",iL,H(e)),q(e,"_shutter",rL,H(e)),q(e,"_iso",oL,H(e)),q(e,"_screenScale",aL,H(e)),q(e,"_visibility",sL,H(e)),q(e,"_targetTexture",cL,H(e)),e._camera=null,e._inEditorMode=!1,e._flows=void 0,e}F(e,t);var n=e.prototype;return n.onLoad=function(){this._createCamera()},n.onEnable=function(){this.node.hasChangedFlags|=Nd.POSITION,this._camera&&this._attachToScene()},n.onDisable=function(){this._camera&&this._detachFromScene()},n.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},n.screenPointToRay=function(t,e,n){return n||(n=nr.create()),this._camera&&this._camera.screenPointToRay(n,t,e),n},n.worldToScreen=function(t,e){return e||(e=new oi),this._camera&&this._camera.worldToScreen(e,t),e},n.screenToWorld=function(t,e){return e||(e=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(e,t),e},n.convertToUINode=function(t,e,n){if(n||(n=new oi),!this._camera)return n;this.worldToScreen(t,AL);var r=e.getComponent("cc.UITransform"),o=CM.getVisibleSize(),a=AL.x-.5*this._camera.width,s=AL.y-.5*this._camera.height;return AL.x=a/i.view.getScaleX()+.5*o.width,AL.y=s/i.view.getScaleY()+.5*o.height,r&&r.convertToNodeSpaceAR(AL,n),n},n._createCamera=function(){this._camera||(this._camera=i.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?i.director.root&&i.director.root.mainWindow:i.director.root&&i.director.root.tempWindow,priority:this._priority}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=jn(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},n._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},n._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},n._checkTargetTextureEvent=function(t){var e=this;t&&t.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(t){e._camera&&e._camera.setFixedSize(t.width,t.height)}),this)},n._updateTargetTexture=function(){if(this._camera&&this._targetTexture){var t=this._targetTexture.window;this._camera.changeTargetWindow(t),this._camera.setFixedSize(t.width,t.height)}},N(e,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t,this._camera&&(this._camera.priority=t)}},{key:"visibility",get:function(){return this._visibility},set:function(t){this._visibility=t,this._camera&&(this._camera.visibility=t)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(t){this._clearFlags=t,this._camera&&(this._camera.clearFlag=t)}},{key:"clearColor",get:function(){return this._color},set:function(t){this._color.set(t),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(t){this._depth=t,this._camera&&(this._camera.clearDepth=t)}},{key:"clearStencil",get:function(){return this._stencil},set:function(t){this._stencil=t,this._camera&&(this._camera.clearStencil=t)}},{key:"projection",get:function(){return this._projection},set:function(t){this._projection=t,this._camera&&(this._camera.projectionType=t)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(t){t!==this._fovAxis&&(this._fovAxis=t,this._camera&&(this._camera.fovAxis=t,t===Td.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(t){this._fov=t,this._camera&&(this._camera.fov=jn(t))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(t){this._orthoHeight=t,this._camera&&(this._camera.orthoHeight=t)}},{key:"near",get:function(){return this._near},set:function(t){this._near=t,this._camera&&(this._camera.nearClip=t)}},{key:"far",get:function(){return this._far},set:function(t){this._far=t,this._camera&&(this._camera.farClip=t)}},{key:"aperture",get:function(){return this._aperture},set:function(t){this._aperture=t,this._camera&&(this._camera.aperture=t)}},{key:"shutter",get:function(){return this._shutter},set:function(t){this._shutter=t,this._camera&&(this._camera.shutter=t)}},{key:"iso",get:function(){return this._iso},set:function(t){this._iso=t,this._camera&&(this._camera.iso=t)}},{key:"rect",get:function(){return this._rect},set:function(t){this._rect=t,this._camera&&this._camera.setViewportInOrientedSpace(t)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(t){if(this._targetTexture!==t){var n=this._targetTexture;this._targetTexture=t,this._checkTargetTextureEvent(n),this._updateTargetTexture(),!t&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(e.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(t){this._screenScale=t,this._camera&&(this._camera.screenScale=t)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(t){this._inEditorMode=t,this._camera&&this._camera.changeTargetWindow(t?i.director.root&&i.director.root.mainWindow:i.director.root&&i.director.root.tempWindow)}}]),e}(ku),lL.ProjectionType=CL,lL.FOVAxis=bL,lL.ClearFlag=PL,lL.Aperture=TL,lL.Shutter=EL,lL.ISO=wL,lL.TARGET_TEXTURE_CHANGE="tex-change",WN=X((jN=uL).prototype,"_projection",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CL.PERSPECTIVE}}),qN=X(jN.prototype,"_priority",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),XN=X(jN.prototype,"_fov",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),YN=X(jN.prototype,"_fovAxis",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bL.VERTICAL}}),KN=X(jN.prototype,"_orthoHeight",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),JN=X(jN.prototype,"_near",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),QN=X(jN.prototype,"_far",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),ZN=X(jN.prototype,"_color",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Li("#333333")}}),$N=X(jN.prototype,"_depth",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),tL=X(jN.prototype,"_stencil",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eL=X(jN.prototype,"_clearFlags",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return PL.SOLID_COLOR}}),nL=X(jN.prototype,"_rect",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mi(0,0,1,1)}}),iL=X(jN.prototype,"_aperture",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TL.F16_0}}),rL=X(jN.prototype,"_shutter",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return EL.D125}}),oL=X(jN.prototype,"_iso",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wL.ISO100}}),aL=X(jN.prototype,"_screenScale",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sL=X(jN.prototype,"_visibility",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rd}}),cL=X(jN.prototype,"_targetTexture",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(jN.prototype,"priority",[eN,nN],Object.getOwnPropertyDescriptor(jN.prototype,"priority"),jN.prototype),X(jN.prototype,"visibility",[iN,rN,oN],Object.getOwnPropertyDescriptor(jN.prototype,"visibility"),jN.prototype),X(jN.prototype,"clearFlags",[aN,sN,cN],Object.getOwnPropertyDescriptor(jN.prototype,"clearFlags"),jN.prototype),X(jN.prototype,"clearColor",[lN,uN],Object.getOwnPropertyDescriptor(jN.prototype,"clearColor"),jN.prototype),X(jN.prototype,"clearDepth",[hN,_N],Object.getOwnPropertyDescriptor(jN.prototype,"clearDepth"),jN.prototype),X(jN.prototype,"clearStencil",[fN,pN],Object.getOwnPropertyDescriptor(jN.prototype,"clearStencil"),jN.prototype),X(jN.prototype,"projection",[dN,mN,vN],Object.getOwnPropertyDescriptor(jN.prototype,"projection"),jN.prototype),X(jN.prototype,"fovAxis",[gN,yN,xN],Object.getOwnPropertyDescriptor(jN.prototype,"fovAxis"),jN.prototype),X(jN.prototype,"fov",[SN,AN],Object.getOwnPropertyDescriptor(jN.prototype,"fov"),jN.prototype),X(jN.prototype,"orthoHeight",[CN,bN],Object.getOwnPropertyDescriptor(jN.prototype,"orthoHeight"),jN.prototype),X(jN.prototype,"near",[TN,EN],Object.getOwnPropertyDescriptor(jN.prototype,"near"),jN.prototype),X(jN.prototype,"far",[wN,PN],Object.getOwnPropertyDescriptor(jN.prototype,"far"),jN.prototype),X(jN.prototype,"aperture",[IN,RN,DN],Object.getOwnPropertyDescriptor(jN.prototype,"aperture"),jN.prototype),X(jN.prototype,"shutter",[BN,MN,ON],Object.getOwnPropertyDescriptor(jN.prototype,"shutter"),jN.prototype),X(jN.prototype,"iso",[NN,LN,FN],Object.getOwnPropertyDescriptor(jN.prototype,"iso"),jN.prototype),X(jN.prototype,"rect",[zN,VN],Object.getOwnPropertyDescriptor(jN.prototype,"rect"),jN.prototype),X(jN.prototype,"targetTexture",[GN,UN,kN],Object.getOwnPropertyDescriptor(jN.prototype,"targetTexture"),jN.prototype),HN=jN))||HN)||HN)||HN)||HN));i.Camera=IL;var RL,DL,BL,ML,OL,NL,LL,FL,zL={parent:null,owner:null,subModelIdx:0},VL=t("RenderableComponent",(_L=qc("cc.RenderableComponent"),fL=El([hg]),pL=El(hg),dL=yl(),mL=_l(),_L((SL=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_materials",yL,H(e)),q(e,"_visFlags",xL,H(e)),e._materialInstances=[],e._models=[],e}F(e,t);var n=e.prototype;return n.getMaterial=function(t){return t<0||t>=this._materials.length?null:this._materials[t]},n.setMaterial=function(t,e){t&&t instanceof yg&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[e]=t;var n=this._materialInstances[e];n&&(n.destroy(),this._materialInstances[e]=null),this._onMaterialModified(e,this._materials[e])},n.getMaterialInstance=function(t){if(!this._materials[t])return null;if(!this._materialInstances[t]){zL.parent=this._materials[t],zL.owner=this,zL.subModelIdx=t;var e=new yg(zL);zL.parent=null,zL.owner=null,zL.subModelIdx=0,this.setMaterialInstance(e,t)}return this._materialInstances[t]},n.setMaterialInstance=function(t,e){if("number"==typeof t){b(12007);var n=t;t=e,e=n}var i=this._materialInstances[e];t&&t.parent?t!==i&&(this._materialInstances[e]=t,this._onMaterialModified(e,t)):(t!==this._materials[e]||i)&&this.setMaterial(t,e)},n.getRenderMaterial=function(t){return this._materialInstances[t]||this._materials[t]},n._collectModels=function(){return this._models},n._attachToScene=function(){},n._detachFromScene=function(){},n._onMaterialModified=function(){},n._onRebuildPSO=function(){},n._clearMaterials=function(){},n._onVisibilityChange=function(){},N(e,[{key:"visibility",get:function(){return this._visFlags},set:function(t){this._visFlags=t,this._onVisibilityChange(t)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(t){for(var e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(var n=t.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(t.length)}}},{key:"materials",get:function(){for(var t=0;t<this._materials.length;t++)this._materialInstances[t]=this.getMaterialInstance(t);return this._materialInstances},set:function(t){var e=t.length-this._materials.length;if(e>0)this._materials.length=t.length,this._materialInstances.length=t.length;else if(e<0)for(var n=this._materials.length-e;n<this._materials.length;++n)this.setMaterialInstance(null,n);for(var i=0;i<this._materialInstances.length;i++)this._materialInstances[i]!=t[i]&&this.setMaterialInstance(t[i],i)}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(t){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==t)&&this.setMaterialInstance(t,0)}}]),e}(ku),yL=X((gL=SL).prototype,"_materials",[fL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xL=X(gL.prototype,"_visFlags",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fp.Enum.NONE}}),X(gL.prototype,"sharedMaterials",[pL,dL,mL],Object.getOwnPropertyDescriptor(gL.prototype,"sharedMaterials"),gL.prototype),vL=gL))||vL));function GL(t){return"string"==typeof t||"number"==typeof t}i.RenderableComponent=VL;var UL,kL,HL,jL,WL,qL,XL,YL,KL,JL,QL,ZL,$L,tF,eF,nF,iF,rF,oF,aF,sF,cF,lF=qc("cc.animation.HierarchyPath")((ML=function(){function t(t){q(this,"path",BL,this),this.path=t||""}return t.prototype.get=function(t){return t instanceof BT?t.getChildByPath(this.path)||(b(3926,t.name,this.path),null):(b(3925),null)},t}(),BL=X((DL=ML).prototype,"path",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),RL=DL))||RL,uF=qc("cc.animation.ComponentPath")((FL=function(){function t(t){q(this,"component",LL,this),this.component=t||""}return t.prototype.get=function(t){return t instanceof BT?t.getComponent(this.component)||(b(3928,t.name,this.component),null):(b(3927),null)},t}(),LL=X((NL=FL).prototype,"component",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),OL=NL))||OL,hF=qc("cc.animation.UniformProxyFactory")((qL=function(){function t(t,e){q(this,"passIndex",HL,this),q(this,"uniformName",jL,this),q(this,"channelIndex",WL,this),this.passIndex=e||0,this.uniformName=t||""}return t.prototype.forTarget=function(t){var e=t.passes[this.passIndex],n=e.getHandle(this.uniformName);if(!n)throw new Error('Material "'+t.name+'" has no uniform "'+this.uniformName+'"');if(Rv.getTypeFromHandle(n)<dr.SAMPLER1D){var r=void 0===this.channelIndex?n:e.getHandle(this.uniformName,this.channelIndex,dr.FLOAT);if(!r)throw new Error('Uniform "'+this.uniformName+" (in material "+t.name+") has no channel "+this.channelIndex+'"');return function(t,e){for(var n,i=W(t.shaderInfo.blocks);!(n=i()).done;)for(var r,o=W(n.value.members);!(r=o()).done;){var a=r.value;if(a.name===e)return a.count>1}return!1}(e,this.uniformName)?{set:function(t){e.setUniformArray(r,t)}}:{set:function(t){e.setUniform(r,t)}}}var o=Rv.getBindingFromHandle(n),a=e.properties[this.uniformName],s=a&&a.value?a.value+"-texture":cv(a.type),c=Cv.get(s);return c||(p("Illegal texture default value: "+s+"."),c=Cv.get("default-texture")),{set:function(t){t||(t=c);var n=t.getGFXTexture();n&&n.width&&n.height&&(e.bindTexture(o,n),t instanceof Sm&&e.bindSampler(o,i.game._gfxDevice.getSampler(t.getSamplerInfo())))}}},t}(),HL=X((kL=qL).prototype,"passIndex",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jL=X(kL.prototype,"uniformName",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),WL=X(kL.prototype,"channelIndex",[Cl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),UL=kL))||UL,_F=qc("cc.animation.MorphWeightValueProxy")((QL=function(){function t(){q(this,"subMeshIndex",KL,this),q(this,"shapeIndex",JL,this)}return t.prototype.forTarget=function(t){var e=this;return{set:function(n){t.setWeight(n,e.subMeshIndex,e.shapeIndex)}}},t}(),KL=X((YL=QL).prototype,"subMeshIndex",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),JL=X(YL.prototype,"shapeIndex",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),XL=YL))||XL,fF=qc("cc.animation.MorphWeightsValueProxy")((eF=function(){function t(){q(this,"subMeshIndex",tF,this)}return t.prototype.forTarget=function(t){var e=this;return{set:function(n){t.setWeights(n,e.subMeshIndex)}}},t}(),tF=X(($L=eF).prototype,"subMeshIndex",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ZL=$L))||ZL,pF=qc("cc.animation.MorphWeightsAllValueProxy")(nF=function(){function t(){}return t.prototype.forTarget=function(t){return{set:function(e){for(var n,i,r=null!==(n=null===(i=t.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0,o=0;o<r;++o)t.setWeights(e,o)}}},t}())||nF;function dF(t,e,n,i){var r,o,a,s,c,l,u=new e,h=new e,_=new e,f=qc(t)((l=function(){function t(t,n,i){q(this,"dataPoint",a,this),q(this,"inTangent",s,this),q(this,"outTangent",c,this),this.dataPoint=t||new e,this.inTangent=n||new e,this.outTangent=i||new e}var r=t.prototype;return r.lerp=function(t,e,r){var o=this.dataPoint,a=t.dataPoint;h=n(h,this.inTangent,r),_=n(_,t.outTangent,r);var s=e*e*e,c=e*e,l=s-2*c+e,f=-2*s+3*c,p=s-c;return u=n(u,o,2*s-3*c+1),u=i(u,u,h,l),u=i(u,u,a,f),u=i(u,u,_,p)},r.getNoLerp=function(){return this.dataPoint},t}(),a=X((o=l).prototype,"dataPoint",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),s=X(o.prototype,"inTangent",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),c=X(o.prototype,"outTangent",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),r=o))||r;if(e===gi){var p=f.prototype.lerp;f.prototype.lerp=function(t,e,n){var i=p.call(this,t,e,n);return gi.normalize(i,i),i}}return f}var mF=t("CubicSplineVec2Value",dF("cc.CubicSplineVec2Value",li,li.multiplyScalar,li.scaleAndAdd));i.CubicSplineVec2Value=mF;var vF=t("CubicSplineVec3Value",dF("cc.CubicSplineVec3Value",oi,oi.multiplyScalar,oi.scaleAndAdd));i.CubicSplineVec3Value=vF;var gF=t("CubicSplineVec4Value",dF("cc.CubicSplineVec4Value",fi,fi.multiplyScalar,fi.scaleAndAdd));i.CubicSplineVec4Value=gF;var yF=t("CubicSplineQuatValue",dF("cc.CubicSplineQuatValue",gi,gi.multiplyScalar,gi.scaleAndAdd));i.CubicSplineQuatValue=yF;var xF=t("CubicSplineNumberValue",qc("cc.CubicSplineNumberValue")((cF=function(){function t(t,e,n){q(this,"dataPoint",oF,this),q(this,"inTangent",aF,this),q(this,"outTangent",sF,this),this.dataPoint=t,this.inTangent=e,this.outTangent=n}var e=t.prototype;return e.lerp=function(t,e,n){var i=this.dataPoint,r=t.dataPoint,o=e*e*e,a=e*e;return i*(2*o-3*a+1)+this.outTangent*n*(o-2*a+e)+r*(-2*o+3*a)+t.inTangent*n*(o-a)},e.getNoLerp=function(){return this.dataPoint},t}(),oF=X((rF=cF).prototype,"dataPoint",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aF=X(rF.prototype,"inTangent",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sF=X(rF.prototype,"outTangent",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iF=rF))||iF);i.CubicSplineNumberValue=xF;var SF,AF,CF,bF,TF,EF,wF,PF,IF,RF,DF,BF,MF,OF,NF,LF,FF,zF,VF,GF,UF,kF,HF,jF,WF,qF,XF,YF=Symbol("CreateEval"),KF=Symbol("NormalizedFollow"),JF=Symbol("ConvertAsTrsPath"),QF=Symbol("TrackBinding"),ZF=qc("cc.animation.TrackPath")((bF=function(){function t(){q(this,"_paths",CF,this)}var e=t.prototype;return e.toProperty=function(t){return this._paths.push(t),this},e.toElement=function(t){return this._paths.push(t),this},e.toHierarchy=function(t){return this._paths.push(new lF(t)),this},e.toComponent=function(t){var e=new uF("string"==typeof t?t:kt.getClassName(t));return this._paths.push(e),this},e.toCustomized=function(t){return this._paths.push(t),this},e.append=function(){for(var t,e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];var r=(t=this._paths).concat.apply(t,n.map((function(t){return t._paths})));return this._paths=r,this},e.isPropertyAt=function(t){return"string"==typeof this._paths[t]},e.parsePropertyAt=function(t){return this._paths[t]},e.isElementAt=function(t){return"number"==typeof this._paths[t]},e.parseElementAt=function(t){return this._paths[t]},e.isHierarchyAt=function(t){return this._paths[t]instanceof lF},e.parseHierarchyAt=function(t){return this.isHierarchyAt(t),this._paths[t].path},e.isComponentAt=function(t){return this._paths[t]instanceof uF},e.parseComponentAt=function(t){return this.isComponentAt(t),this._paths[t].component},e.slice=function(e,n){var i=new t;return i._paths=this._paths.slice(e,n),i},e.trace=function(t,e,n){var i,r;return null!==(i=e)&&void 0!==i||(e=0),null!==(r=n)&&void 0!==r||(n=this._paths.length),this[KF](t,e,n)},e[JF]=function(){for(var t,e=this._paths,n=e.length,i=0,r="";i<n;++i){var o=e[i];if(!(o instanceof lF))break;o.path&&(r?r+="/"+o.path:r=o.path)}if(i===n)return null;if(i!==n-1)return null;switch(e[i]){case"position":case"scale":case"rotation":case"eulerAngles":t=e[i];break;default:return null}return{node:r,property:t}},e[KF]=function(t,e,n){for(var i=this._paths,r=t,o=e;o<n;++o){var a=i[o];if(GL(a)){if(!(a in r))return b(3929,a),null;r=r[a]}else r=a.get(r);if(null===r)break}return r},N(t,[{key:"length",get:function(){return this._paths.length}}]),t}(),CF=X((AF=bF).prototype,"_paths",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),SF=AF))||SF,$F=qc("cc.animation.TrackBinding")(TF=nl((IF=function(){function t(){q(this,"path",wF,this),q(this,"proxy",PF,this)}var e=t.prototype;return e.parseTrsPath=function(){return this.proxy?null:this.path[JF]()},e.createRuntimeBinding=function(t,e,n){var i=this.path,r=this.proxy,o=i.length,a=o-1;if(0===o||!i.isPropertyAt(a)&&!i.isElementAt(a)||r){if(r){var s=i[KF](t,0,o);if(null===s)return null;var c=r.forTarget(s),l={setValue:function(t){c.set(t)}},u=c.get;return u&&(l.getValue=function(){return u.call(c)}),l}return E(3921),null}var h,_=i.isPropertyAt(a)?i.parsePropertyAt(a):i.parseElementAt(a),f=i[KF](t,0,o-1);return null===f?null:e&&f instanceof BT&&("position"===(h=_)||"rotation"===h||"scale"===h||"eulerAngles"===h)?e.createPoseWriter(f,_,n):{setValue:function(t){f[_]=t},getValue:function(){return f[_]}}},t}(),wF=X((EF=IF).prototype,"path",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ZF}}),PF=X(EF.prototype,"proxy",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),TF=EF))||TF)||TF,tz=qc("cc.animation.Track")((MF=function(){function t(){q(this,"_binding",BF,this)}var e=t.prototype;return e.channels=function(){return[]},e.range=function(){for(var t,e={min:1/0,max:-1/0},n=W(this.channels());!(t=n()).done;){var i=t.value;e.min=Math.min(e.min,i.curve.rangeMin),e.max=Math.max(e.max,i.curve.rangeMax)}return e},N(t,[{key:"path",get:function(){return this._binding.path},set:function(t){this._binding.path=t}},{key:"proxy",get:function(){return this._binding.proxy},set:function(t){this._binding.proxy=t}},{key:QF,get:function(){return this._binding}}]),t}(),BF=X((DF=MF).prototype,"_binding",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $F}}),RF=DF))||RF,ez=qc("cc.animation.Channel")((FF=function(){function t(t){this.name="",q(this,"_curve",LF,this),this._curve=t}return N(t,[{key:"curve",get:function(){return this._curve}}]),t}(),LF=X((NF=FF).prototype,"_curve",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),OF=NF))||OF,nz=qc("cc.animation.SingleChannelTrack")((UF=function(t){function e(){var e;return q(e=t.call(this)||this,"_channel",GF,H(e)),e._channel=new ez(e.createCurve()),e}F(e,t);var n=e.prototype;return n.channels=function(){return[this._channel]},n.createCurve=function(){throw new Error("Not impl")},n[YF]=function(){var t=this._channel.curve;return new iz(t)},N(e,[{key:"channel",get:function(){return this._channel}}]),e}(tz),GF=X((VF=UF).prototype,"_channel",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),zF=VF))||zF,iz=function(){function t(t){this._curve=t}return t.prototype.evaluate=function(t){return this._curve.evaluate(t)},t}(),rz=qc("cc.animation.RealTrack")(kF=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e.prototype.createCurve=function(){return new rf},e}(nz))||kF;function oz(t){return 0===t.keyFramesCount?void 0:t}var az,sz,cz,lz,uz,hz,_z,fz,pz,dz,mz=["X","Y","Z","W"],vz=qc("cc.animation.VectorTrack")((XF=function(t){function e(){var e;q(e=t.call(this)||this,"_channels",WF,H(e)),q(e,"_nComponents",qF,H(e)),e._channels=new Array(4);for(var n=0;n<e._channels.length;++n){var i=new ez(new rf);i.name=mz[n],e._channels[n]=i}return e}F(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[YF]=function(){switch(this._nComponents){default:case 2:return new gz(oz(this._channels[0].curve),oz(this._channels[1].curve));case 3:return new yz(oz(this._channels[0].curve),oz(this._channels[1].curve),oz(this._channels[2].curve));case 4:return new xz(oz(this._channels[0].curve),oz(this._channels[1].curve),oz(this._channels[2].curve),oz(this._channels[3].curve))}},N(e,[{key:"componentsCount",get:function(){return this._nComponents},set:function(t){this._nComponents=t}}]),e}(tz),WF=X((jF=XF).prototype,"_channels",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),qF=X(jF.prototype,"_nComponents",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),HF=jF))||HF,gz=function(){function t(t,e){this._result=new li,this._x=t,this._y=e}return t.prototype.evaluate=function(t,e){return this._x&&this._y||!e.getValue||li.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._result},t}(),yz=function(){function t(t,e,n){this._result=new oi,this._x=t,this._y=e,this._z=n}return t.prototype.evaluate=function(t,e){return this._x&&this._y&&this._z||!e.getValue||oi.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._z&&(this._result.z=this._z.evaluate(t)),this._result},t}(),xz=function(){function t(t,e,n,i){this._result=new fi,this._x=t,this._y=e,this._z=n,this._w=i}return t.prototype.evaluate=function(t,e){return this._x&&this._y&&this._z&&this._w||!e.getValue||fi.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._z&&(this._result.z=this._z.evaluate(t)),this._w&&(this._result.w=this._w.evaluate(t)),this._result},t}(),Sz=qc("cc.animation.QuatTrack")(az=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.createCurve=function(){return new jf},n[YF]=function(){return new Az(this.channels()[0].curve)},e}(nz))||az,Az=function(){function t(t){this._result=new gi,this._curve=t}return t.prototype.evaluate=function(t){return this._curve.evaluate(t,this._result),this._result},t}(),Cz=["Red","Green","Blue","Alpha"],bz=qc("cc.animation.ColorTrack")((uz=function(t){function e(){var e;q(e=t.call(this)||this,"_channels",lz,H(e)),e._channels=new Array(4);for(var n=0;n<e._channels.length;++n){var i=new ez(new rf);i.name=Cz[n],e._channels[n]=i}return e}F(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[YF]=function(){return new Tz(oz(this._channels[0].curve),oz(this._channels[1].curve),oz(this._channels[2].curve),oz(this._channels[3].curve))},e}(tz),lz=X((cz=uz).prototype,"_channels",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),sz=cz))||sz,Tz=function(){function t(t,e,n,i){this._result=new Li,this._x=t,this._y=e,this._z=n,this._w=i}return t.prototype.evaluate=function(t,e){return this._x&&this._y&&this._z&&this._w||!e.getValue||Li.copy(this._result,e.getValue()),this._x&&(this._result.r=this._x.evaluate(t)),this._y&&(this._result.g=this._y.evaluate(t)),this._z&&(this._result.b=this._z.evaluate(t)),this._w&&(this._result.a=this._w.evaluate(t)),this._result},t}(),Ez=["Width","Height"],wz=qc("cc.animation.SizeTrack")((pz=function(t){function e(){var e;q(e=t.call(this)||this,"_channels",fz,H(e)),e._channels=new Array(2);for(var n=0;n<e._channels.length;++n){var i=new ez(new rf);i.name=Ez[n],e._channels[n]=i}return e}F(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[YF]=function(){return new Pz(oz(this._channels[0].curve),oz(this._channels[1].curve))},e}(tz),fz=X((_z=pz).prototype,"_channels",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),hz=_z))||hz,Pz=function(){function t(t,e){this._result=new Di,this._width=t,this._height=e}return t.prototype.evaluate=function(t,e){if((!this._width||!this._height)&&e.getValue){var n=e.getValue();this._result.x=n.x,this._result.y=n.y}return this._width&&(this._result.width=this._width.evaluate(t)),this._height&&(this._result.height=this._height.evaluate(t)),this._result},t}(),Iz=qc("cc.animation.ObjectTrack")(dz=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e.prototype.createCurve=function(){return new op},e}(nz))||dz,Rz=Symbol("[[Owner]]");function Dz(t){t[Rz]}var Bz,Mz,Oz,Nz,Lz,Fz,zz,Vz,Gz,Uz,kz,Hz,jz,Wz,qz,Xz,Yz,Kz,Jz,Qz=function(t){function e(e){var n;return(n=t.call(this,e+" transition is invalid")||this).name="TransitionRejectError",n}return F(e,t),e}(k(Error)),Zz=function(t){function e(e){return t.call(this,"Graph variable "+e+" is not defined")||this}return F(e,t),e}(k(Error)),$z=function(t){function e(e,n,i){return t.call(this,"Expect graph variable "+e+" to have type '"+n+"' instead of received '"+(null!=i?i:typeof i)+"'")||this}return F(e,t),e}(k(Error)),tV=Symbol("[[createEval]]"),eV=Symbol("[[Outgoing transitions]]"),nV=Symbol("[[Incoming transitions]]"),iV=qc("cc.animation.State")((Nz=function(t){function e(){var e;return q(e=t.call(this)||this,"name",Oz,H(e)),e[eV]=[],e[nV]=[],e}return F(e,t),e}(Vl),Oz=X((Mz=Nz).prototype,"name",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Bz=Mz))||Bz,rV=qc("cc.animation.InteractiveState")((Vz=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_components",zz,H(e)),e}F(e,t);var n=e.prototype;return n.addComponent=function(t){var e=new t;return this._components.push(e),e},n.removeComponent=function(t){Q(this._components,t)},n.instantiateComponents=function(){return this._components.map((function(t){return kh(t)}))},N(e,[{key:"components",get:function(){return this._components}}]),e}(iV),zz=X((Fz=Vz).prototype,"_components",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Lz=Fz))||Lz;!function(t){t[t.FLOAT=0]="FLOAT",t[t.BOOLEAN=1]="BOOLEAN",t[t.TRIGGER=2]="TRIGGER",t[t.INTEGER=3]="INTEGER"}(Jz||(Jz={}));var oV,aV,sV,cV,lV,uV=qc("cc.animation.BindableNumber")((jz=function(){function t(t){void 0===t&&(t=0),q(this,"variable",kz,this),q(this,"value",Hz,this),this.value=t}return t.prototype.clone=function(){var e=new t;return e.value=this.value,e.variable=this.variable,e},t}(),kz=X((Uz=jz).prototype,"variable",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Hz=X(Uz.prototype,"value",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Gz=Uz))||Gz,hV=qc("cc.animation.BindableBoolean")((Kz=function(){function t(t){void 0===t&&(t=!1),q(this,"variable",Xz,this),q(this,"value",Yz,this),this.value=t}return t.prototype.clone=function(){var e=new t;return e.value=this.value,e.variable=this.variable,e},t}(),Xz=X((qz=Kz).prototype,"variable",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Yz=X(qz.prototype,"value",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Wz=qz))||Wz;function _V(t,e,n,i,r){var o=e.variable,a=e.value;if(!o)return a;var s=t.getVar(o);if(!pV(s,o))return a;if(s.type!==n)throw new $z(o,"number");for(var c=arguments.length,l=new Array(c>5?c-5:0),u=5;u<c;u++)l[u-5]=arguments[u];var h=s.bind.apply(s,[i,r].concat(l));return h}function fV(t,e,n,i,r){var o=e.variable,a=e.value;if(!o)return a;var s=t.getVar(o);if(!pV(s,o))return a;if(n!==Jz.FLOAT&&n!==Jz.INTEGER)throw new $z(o,"number or integer");for(var c=arguments.length,l=new Array(c>5?c-5:0),u=5;u<c;u++)l[u-5]=arguments[u];var h=s.bind.apply(s,[i,r].concat(l));return h}function pV(t,e){if(t)return!0;throw new Zz(e)}var dV,mV,vV,gV,yV,xV,SV,AV,CV,bV,TV,EV,wV,PV,IV,RV,DV,BV,MV,OV,NV,LV,FV,zV,VV,GV,UV,kV,HV,jV,WV,qV,XV,YV,KV,JV,QV,ZV,$V,tG,eG,nG,iG,rG=qc("cc.animation.Motion")((lV=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"motion",sV,H(e)),q(e,"speed",cV,H(e)),e}return F(e,t),e.prototype.clone=function(){var t,n,i=new e;return i.motion=null!==(t=null===(n=this.motion)||void 0===n?void 0:n.clone())&&void 0!==t?t:null,i.speed=this.speed.clone(),i},e}(rV),sV=X((aV=lV).prototype,"motion",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cV=X(aV.prototype,"speed",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new uV(1)}}),oV=aV))||oV,oG=Symbol("[[OnAfterDeserialized]]"),aG=qc("cc.animation.Transition")((xV=function(t){function e(e,n,i){var r;return q(r=t.call(this)||this,"from",vV,H(r)),q(r,"to",gV,H(r)),q(r,"conditions",yV,H(r)),r[Rz]=void 0,r.from=e,r.to=n,i&&(r.conditions=i),r}return F(e,t),e}(Vl),vV=X((mV=xV).prototype,"from",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),gV=X(mV.prototype,"to",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),yV=X(mV.prototype,"conditions",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dV=mV))||dV,sG=qc("cc.animation.AnimationTransition")((wV=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"duration",CV,H(e)),q(e,"relativeDuration",bV,H(e)),q(e,"exitConditionEnabled",TV,H(e)),q(e,"_exitCondition",EV,H(e)),e}return F(e,t),N(e,[{key:"exitCondition",get:function(){return this._exitCondition},set:function(t){this._exitCondition=t}}]),e}(aG),CV=X((AV=wV).prototype,"duration",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),bV=X(AV.prototype,"relativeDuration",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),TV=X(AV.prototype,"exitConditionEnabled",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),EV=X(AV.prototype,"_exitCondition",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),SV=AV))||SV;function cG(t){return t instanceof sG}var lG,uG=qc("cc.animation.StateMachine")((NV=function(t){F(n,t);var e=n.prototype;function n(){var e;return q(e=t.call(this)||this,"_states",RV,H(e)),q(e,"_transitions",DV,H(e)),q(e,"_entryState",BV,H(e)),q(e,"_exitState",MV,H(e)),q(e,"_anyState",OV,H(e)),e._entryState=e._addState(new iV),e._entryState.name="Entry",e._exitState=e._addState(new iV),e._exitState.name="Exit",e._anyState=e._addState(new iV),e._anyState.name="Any",e}return e.__callOnAfterDeserializeRecursive=function(){this[oG]();for(var t=this._states.length,e=0;e<t;++e){var n=this._states[e];n instanceof hG&&n.stateMachine.__callOnAfterDeserializeRecursive()}},e[oG]=function(){this._states.forEach((function(){})),this._transitions.forEach((function(t){t.from[eV].push(t),t.to[nV].push(t)}))},e[tV]=function(){throw new Error("Method not implemented.")},e.states=function(){return this._states},e.transitions=function(){return this._transitions},e.getTransitionsBetween=function(t,e){return Dz(t),Dz(e),t[eV].filter((function(t){return t.to===e}))},e.getOutgoings=function(t){return Dz(t),t[eV]},e.getIncomings=function(t){return Dz(t),t[nV]},e.addMotion=function(){return this._addState(new rG)},e.addSubStateMachine=function(){return this._addState(new hG)},e.remove=function(t){Dz(t),t!==this.entryState&&t!==this.exitState&&t!==this.anyState&&(this.eraseTransitionsIncludes(t),Q(this._states,t))},e.connect=function(t,e,n){if(Dz(t),Dz(e),e===this.entryState)throw new Qz("to-entry");if(e===this.anyState)throw new Qz("to-any");if(t===this.exitState)throw new Qz("from-exit");var i=t instanceof rG||t===this._anyState?new sG(t,e,n):new aG(t,e,n);return this._transitions.push(i),t[eV].push(i),e[nV].push(i),i},e.disconnect=function(t,e){Dz(t),Dz(e);for(var n=t[eV],i=e[nV],r=this._transitions,o=n.filter((function(t){return t.to===e})),a=o.length,s=function(t){var e=o[t];Q(n,e),Q(r,e),Z(i,(function(t){return t===e}))},c=0;c<a;++c)s(c)},e.removeTransition=function(t){Q(this._transitions,t),Z(t.from[eV],(function(e){return e===t})),Z(t.to[nV],(function(e){return e===t}))},e.eraseOutgoings=function(t){var e=this;Dz(t);for(var n=t[eV],i=function(t){var i=n[t],r=i.to;Q(e._transitions,i),Z(r[nV],(function(t){return t===i}))},r=0;r<n.length;++r)i(r);n.length=0},e.eraseIncomings=function(t){var e=this;Dz(t);for(var n=t[nV],i=function(t){var i=n[t],r=i.from;Q(e._transitions,i),Z(r[eV],(function(t){return t===i}))},r=0;r<n.length;++r)i(r);n.length=0},e.eraseTransitionsIncludes=function(t){this.eraseIncomings(t),this.eraseOutgoings(t)},e.clone=function(){for(var t,e=new n,i=new Map,r=W(this._states);!(t=r()).done;){var o=t.value;switch(o){case this._entryState:i.set(o,e._entryState);break;case this._exitState:i.set(o,e._exitState);break;case this._anyState:i.set(o,e._anyState);break;default:if(o instanceof rG||o instanceof hG){var a=o.clone();e._addState(a),i.set(o,a)}}}for(var s,c=W(this._transitions);!(s=c()).done;){var l=s.value,u=i.get(l.from),h=i.get(l.to),_=e.connect(u,h);_.conditions=l.conditions.map((function(t){return t.clone()})),_ instanceof sG&&(_.duration=l.duration,_.exitConditionEnabled=l.exitConditionEnabled,_.exitCondition=l.exitCondition)}return e},e._addState=function(t){return this._states.push(t),t},N(n,[{key:"entryState",get:function(){return this._entryState}},{key:"exitState",get:function(){return this._exitState}},{key:"anyState",get:function(){return this._anyState}}]),n}(Vl),RV=X((IV=NV).prototype,"_states",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),DV=X(IV.prototype,"_transitions",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),BV=X(IV.prototype,"_entryState",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),MV=X(IV.prototype,"_exitState",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),OV=X(IV.prototype,"_anyState",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),PV=IV))||PV,hG=qc("cc.animation.SubStateMachine")((VV=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_stateMachine",zV,H(e)),e}return F(e,t),e.prototype.clone=function(){var t=new e;return t._stateMachine=this._stateMachine.clone(),t},N(e,[{key:"stateMachine",get:function(){return this._stateMachine}}]),e}(rV),zV=X((FV=VV).prototype,"_stateMachine",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new uG}}),LV=FV))||LV,_G=qc("cc.animation.Layer")((XV=function(){function t(){this[Rz]=void 0,q(this,"_stateMachine",kV,this),q(this,"name",HV,this),q(this,"weight",jV,this),q(this,"mask",WV,this),q(this,"blending",qV,this),this._stateMachine=new uG}return N(t,[{key:"stateMachine",get:function(){return this._stateMachine}}]),t}(),kV=X((UV=XV).prototype,"_stateMachine",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),HV=X(UV.prototype,"name",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),jV=X(UV.prototype,"weight",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),WV=X(UV.prototype,"mask",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qV=X(UV.prototype,"blending",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lG.additive}}),GV=UV))||GV;!function(t){t[t.override=0]="override",t[t.additive=1]="additive"}(lG||(lG={}));var fG=qc("cc.animation.Variable")((ZV=function(){function t(t){if(q(this,"_type",JV,this),q(this,"_value",QV,this),void 0!==t)switch(this._type=t,t){default:break;case Jz.FLOAT:case Jz.INTEGER:this._value=0;break;case Jz.BOOLEAN:case Jz.TRIGGER:this._value=!1}}return N(t,[{key:"type",get:function(){return this._type}},{key:"value",get:function(){return this._value},set:function(t){this._value=t}}]),t}(),JV=X((KV=ZV).prototype,"_type",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Jz.FLOAT}}),QV=X(KV.prototype,"_value",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),YV=KV))||YV,pG=qc("cc.animation.AnimationGraph")((iG=function(t){function e(){var e;return q(e=t.call(this)||this,"_layers",eG,H(e)),q(e,"_variables",nG,H(e)),e}F(e,t);var n=e.prototype;return n.onLoaded=function(){for(var t=this._layers,e=t.length,n=0;n<e;++n)t[n].stateMachine.__callOnAfterDeserializeRecursive()},n.addLayer=function(){var t=new _G;return this._layers.push(t),t},n.removeLayer=function(t){Ut.removeAt(this._layers,t)},n.moveLayer=function(t,e){!function(t,e,n){if(Kt(t,e),Kt(t,n),e===n)return t;var i=t[e];if(e<n)for(var r=e+1;r<=n;++r)t[r-1]=t[r];else for(var o=e;o!==n;--o)t[o]=t[o-1];t[n]=i}(this._layers,t,e)},n.addVariable=function(t,e,n){var i=new fG(e);void 0!==n&&(i.value=n),this._variables[t]=i},n.removeVariable=function(t){delete this._variables[t]},n.getVariable=function(t){return this._variables[t]},N(e,[{key:"layers",get:function(){return this._layers}},{key:"variables",get:function(){return Object.entries(this._variables)}}]),e}(Su),eG=X((tG=iG).prototype,"_layers",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nG=X(tG.prototype,"_variables",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),$V=tG))||$V,dG=Symbol("BakeNodeCurves"),mG=function(){function t(){}return t.getOrExtract=function(e){var n=t.pool.get(e);if(!n||n.samples!==e.sample){n&&i.director.root.dataPoolManager.releaseAnimationClip(e);var r=Math.ceil(e.sample*e.duration)+1,o=e.sample;n=e[dG](0,o,r),t.pool.set(e,n)}return n},t.destroy=function(e){t.pool.delete(e)},t}();mG.pool=new Map;var vG=t("RatioSampler",function(){function t(t){var e,n;this.ratios=void 0,this._findRatio=void 0,this.ratios=t;for(var i=!0,r=1,o=t.length;r<o;r++)if(e=t[r]-t[r-1],1===r)n=e;else if(Math.abs(e-n)>1e-6){i=!1;break}this._findRatio=i?SG:Fc}return t.prototype.sample=function(t){return this._findRatio(this.ratios,t)},t}());i.RatioSampler=vG;var gG=t("AnimCurve",function(){function t(e,n){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=n,this._values=e.values;var i=function(e){return"string"==typeof e?e:Array.isArray(e)?e[0]===e[1]&&e[2]===e[3]?t.Linear:t.Bezier(e):t.Linear};if(void 0!==e.easingMethod)this.type=i(e.easingMethod);else if(Array.isArray(e.easingMethods))this.types=e.easingMethods.map(i);else if(void 0!==e.easingMethods){this.types=new Array(this._values.length).fill(null);for(var r=0,o=Object.keys(e.easingMethods);r<o.length;r++){var a=o[r];this.types[a]=i(e.easingMethods[a])}}else this.type=null;var s=e.values[0];(void 0===e.interpolate||e.interpolate)&&(this._lerp=RG(s)),void 0!==e._arrayLength&&(this._array=new Array(e._arrayLength))}t.Bezier=function(t){return t};var e=t.prototype;return e.hasLerp=function(){return!!this._lerp},e.valueAt=function(t){if(void 0===this._array){var e=this._values[t];return e&&e.getNoLerp?e.getNoLerp():e}for(var n=0;n<this._array.length;++n)this._array[n]=this._values[this._array.length*t+n];return this._array},e.valueBetween=function(t,e,n,i,r){if(this._lerp){var o=this.types?this.types[e]:this.type,a=r-n,s=(t-n)/a;if(o&&(s=xG(s,o)),void 0===this._array){var c=this._values[e],l=this._values[i];return this._lerp(c,l,s,a*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*e+u],_=this._values[this._array.length*i+u];this._array[u]=this._lerp(h,_,s,a*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(e);for(var f=0;f<this._array.length;++f)this._array[f]=this._values[this._array.length*e+f];return this._array},e.empty=function(){return 0===this._values.length},e.constant=function(){return 1===this._values.length},t}());function yG(t,e,n){var i=e.sample(n);if(i<0)if((i=~i)<=0)i=0;else{if(!(i>=e.ratios.length))return t.valueBetween(n,i-1,e.ratios[i-1],i,e.ratios[i]);i=e.ratios.length-1}return t.valueAt(i)}function xG(t,e){if("string"==typeof e){var n=H_[e];n?t=n(t):E(3906,e)}else Array.isArray(e)&&(t=Gf(e,t));return t}function SG(t,e){var n=t.length-1;if(0===n)return 0;var i=t[0];if(e<i)return 0;var r=t[n];if(e>r)return n;var o=(e=(e-i)/(r-i))/(1/n),a=0|o,s=1e-6;return o-a<s?a:a+1-o<s?a+1:~(a+1)}gG.Linear=null,i.AnimCurve=gG,t("EventInfo",function(){function t(){this.events=[]}return t.prototype.add=function(t,e){this.events.push({func:t||"",params:e||[]})},t}()),i.sampleAnimationCurve=yG;var AG,CG,bG,TG,EG,wG,PG,IG,RG=function(){function t(t,e,n,i){return t.lerp(e,n,i)}return function(e){if(null!==e){if("number"==typeof e)return Hn;if("object"==typeof e&&e.constructor){if(e instanceof gi)return n=new gi,function(t,e,i){return gi.slerp(n,t,e,i)};if(e instanceof te)return function(t){var e=new t;return function(n,i,r){return t.lerp(e,n,i,r),e}}(e.constructor);if(e.constructor===Number)return Hn;if("function"==typeof e.lerp)return t}var n}}}(),DG=qc("cc.animation.UntypedTrackChannel")((TG=function(t){function e(){var e;return q(e=t.call(this,new rf)||this,"property",bG,H(e)),e}return F(e,t),e}(ez),bG=X((CG=TG).prototype,"property",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),AG=CG))||AG,BG=qc("cc.animation.UntypedTrack")((IG=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_channels",PG,H(e)),e}F(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[YF]=function(t){var e=this;if(!t.getValue)throw new Error(R(3930));var n=function(t){var n;return null===(n=e._channels.find((function(e){return e.property===t})))||void 0===n?void 0:n.curve},i=t.getValue();switch(!0){default:throw new Error(R(3931));case i instanceof li:return new gz(n("x"),n("y"));case i instanceof oi:return new yz(n("x"),n("y"),n("z"));case i instanceof fi:return new xz(n("x"),n("y"),n("z"),n("w"));case i instanceof Li:return new Tz(n("r"),n("g"),n("b"),n("a"));case i instanceof Di:return new Pz(n("width"),n("height"))}},n.addChannel=function(t){var e=new DG;return e.property=t,this._channels.push(e),e},n.upgrade=function(t){var e=this,n=function(t,n){var i=e.channels().find((function(e){return e.property===t}));i&&(n.name=i.name,n.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=t(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":var r=new vz;r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===i?2:"vec3"===i?3:4;var o=r.channels(),a=o[0],s=o[1],c=o[2],l=o[3];switch(i){case"vec4":n("w",l);case"vec3":n("z",c);default:case"vec2":n("x",a),n("y",s)}return r;case"color":var u=new bz,h=u.channels(),_=h[0],f=h[1],p=h[2],d=h[3];return n("r",_),n("g",f),n("b",p),n("a",d),n("x",_),n("y",f),n("z",p),n("w",d),u;case"size":}return null},e}(tz),PG=X((wG=IG).prototype,"_channels",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),EG=wG))||EG,MG=function(){function t(t){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=t}var e=t.prototype;return e.getPropertyCurves=function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves},e.toTracks=function(){for(var t,e=[],n=this.keys,i=this.curves,r=this.commonTargets,o=function(t,e,n){for(var i,r=new ZF,o=W(e);!(i=o()).done;){var a=i.value;"string"==typeof a?r.toProperty(a):"number"==typeof a?r.toElement(a):a instanceof lF?r.toHierarchy(a.path):a instanceof uF?r.toComponent(a.component):r.toCustomized(a)}t.path=r,t.proxy=n},a=r.map((function(t){var n=new BG;return o(n,t.modifiers,t.valueAdapter),e.push(n),n})),s=function(){var i,r=t.value,s=r.data,c=s.values;if(0===c.length)return"continue";var l=s.keys<0?[0]:n[s.keys],u=c[0],h=null===(i=s.interpolate)||void 0===i||i;s._arrayLength;var _=new NG(s,l.length),f=function(t){o(t,r.modifiers,r.valueAdapter)},p=void 0;if("number"==typeof r.commonTarget){if(!c.every((function(t){return"number"==typeof t})))return b(3932),"continue";if(r.valueAdapter||1!==r.modifiers.length||"string"!=typeof r.modifiers[0])return b(3933),"continue";var d=r.modifiers[0],m=a[r.commonTarget].addChannel(d).curve;p=m}!function(){if("number"==typeof u){if(!c.every((function(t){return"number"==typeof t})))return void b(3934);var t;if(p)t=p;else{var n=new rz;f(n),e.push(n),t=n.channel.curve}var i=h?Ml.LINEAR:Ml.CONSTANT;return t.assignSorted(l,c.map((function(t){return{value:t,interpolationMode:i}}))),void _.convert(t)}if("object"==typeof u)switch(!0){default:break;case OG(c,li):case OG(c,oi):case OG(c,fi):var r=u instanceof li?2:u instanceof oi?3:4,o=new vz;f(o),o.componentsCount=r;var a=o.channels(),s=a[0].curve,d=a[1].curve,m=a[2].curve,v=a[3].curve,g=h?Ml.LINEAR:Ml.CONSTANT,y=function(t){return{value:t,interpolationMode:g}};switch(r){case 4:v.assignSorted(l,c.map((function(t){return y(t.w)}))),_.convert(v);case 3:m.assignSorted(l,c.map((function(t){return y(t.z)}))),_.convert(m);default:s.assignSorted(l,c.map((function(t){return y(t.x)}))),_.convert(s),d.assignSorted(l,c.map((function(t){return y(t.y)}))),_.convert(d)}return void e.push(o);case OG(c,gi):var x=new Sz;f(x);var S=h?Mf.SLERP:Mf.CONSTANT;return x.channel.curve.assignSorted(l,c.map((function(t){return{value:gi.clone(t),interpolationMode:S}}))),_.convertQuatCurve(x.channel.curve),void e.push(x);case OG(c,Li):var A=new bz;f(A);var C=A.channels(),T=C[0].curve,E=C[1].curve,w=C[2].curve,P=C[3].curve,I=h?Ml.LINEAR:Ml.CONSTANT,R=function(t){return{value:t,interpolationMode:I}};return T.assignSorted(l,c.map((function(t){return R(t.r)}))),_.convert(T),E.assignSorted(l,c.map((function(t){return R(t.g)}))),_.convert(E),w.assignSorted(l,c.map((function(t){return R(t.b)}))),_.convert(w),P.assignSorted(l,c.map((function(t){return R(t.a)}))),_.convert(P),void e.push(A);case OG(c,Di):var D=new wz;f(D);var B=D.channels(),M=B[0].curve,O=B[1].curve,N=h?Ml.LINEAR:Ml.CONSTANT,L=function(t){return{value:t,interpolationMode:N}};return M.assignSorted(l,c.map((function(t){return L(t.width)}))),_.convert(M),O.assignSorted(l,c.map((function(t){return L(t.height)}))),_.convert(O),void e.push(D);case OG(c,xF):var F=new rz;f(F);var z=h?Ml.CUBIC:Ml.CONSTANT;return F.channel.curve.assignSorted(l,c.map((function(t){return{value:t.dataPoint,leftTangent:t.inTangent,rightTangent:t.outTangent,interpolationMode:z}}))),void e.push(F);case OG(c,mF):case OG(c,vF):case OG(c,gF):var V=u instanceof mF?2:u instanceof vF?3:4,G=new vz;f(G),G.componentsCount=V;var U=G.channels(),k=U[0],H=U[1],j=U[2],W=U[3],q=h?Ml.LINEAR:Ml.CONSTANT,X=function(t,e,n){return{value:t,leftTangent:e,rightTangent:n,interpolationMode:q}};switch(V){case 4:W.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.w,t.inTangent.w,t.outTangent.w)})));case 3:j.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.z,t.inTangent.z,t.outTangent.z)})));default:k.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.y,t.inTangent.y,t.outTangent.y)}))),H.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.x,t.inTangent.x,t.outTangent.x)})))}return void e.push(G);case c.every((function(t){return t instanceof yF})):b(3935)}var Y=new Iz;f(Y),Y.channel.curve.assignSorted(l,c),e.push(Y)}()},c=W(i);!(t=c()).done;)s();return e},e._createPropertyCurves=function(){var t=this;this._ratioSamplers=this._keys.map((function(e){return new vG(e.map((function(e){return e/t._duration})))})),this._runtimeCurves=this._curves.map((function(e){return{curve:new gG(e.data,t._duration),modifiers:e.modifiers,valueAdapter:e.valueAdapter,sampler:t._ratioSamplers[e.data.keys],commonTarget:e.commonTarget}}))},N(t,[{key:"keys",get:function(){return this._keys},set:function(t){this._keys=t}},{key:"curves",get:function(){return this._curves},set:function(t){this._curves=t,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(t){this._commonTargets=t}},{key:"data",get:function(){return this._data}}]),t}();function OG(t,e){return t.every((function(t){return t instanceof e}))}var NG=function(){function t(t,e){this._easingMethods=void 0;var n=t.easingMethods;Array.isArray(n)?0===n.length&&0!==e?this._easingMethods=new Array(e).fill(null):this._easingMethods=n:this._easingMethods=void 0===n?new Array(e).fill(t.easingMethod):Array.from({length:e},(function(t,e){var i;return null!==(i=n[e])&&void 0!==i?i:null}))}var e=t.prototype;return e.convert=function(t){var e,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m,v,g,y,x,S,A,C=this._easingMethods;if(C){var b=t.keyFramesCount;if(!(t.keyFramesCount<2)){Array.isArray(C)&&C.length;for(var T=b-1,E=0;E<T;++E){var w=C[E];w&&(Array.isArray(w)?(e=w,n=t.getKeyframeTime(E),i=t.getKeyframeValue(E),r=t.getKeyframeTime(E+1),o=t.getKeyframeValue(E+1),a=void 0,s=void 0,c=void 0,l=void 0,u=void 0,h=void 0,_=void 0,f=void 0,p=void 0,d=void 0,m=void 0,v=void 0,g=void 0,y=void 0,x=void 0,S=void 0,A=void 0,s=e[0],c=e[1],l=e[2],u=e[3],h=i.value,_=3*(r-n),f=3*(o.value-h),m=(1-l)*_,v=(1-u)*f,g=1/3,y=(d=c*f)/(p=s*_),x=Math.sqrt(p*p+d*d)*g,S=v/m,A=Math.sqrt(m*m+v*v)*g,i.interpolationMode=Ml.CUBIC,i.tangentWeightMode=(a=i.tangentWeightMode)===Nl.NONE?Nl.RIGHT:a===Nl.LEFT?Nl.BOTH:a,i.rightTangent=y,i.rightTangentWeight=x,o.tangentWeightMode=function(t){return t===Nl.NONE?Nl.LEFT:t===Nl.RIGHT?Nl.BOTH:t}(o.tangentWeightMode),o.leftTangent=S,o.leftTangentWeight=A):LG(w,t,E))}}}},e.convertQuatCurve=function(t){var e=this._easingMethods;if(e){var n=t.keyFramesCount;if(!(t.keyFramesCount<2)){Array.isArray(e)&&e.length;for(var i=n-1,r=0;r<i;++r){var o=e[r];o&&(Array.isArray(o)?t.getKeyframeValue(r).easingMethod=o.slice():FG(o,t,r))}}}},N(t,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every((function(t){return null==t}))}}]),t}();function LG(t,e,n){e.keyFramesCount;var i=e.getKeyframeValue(n),r=fU[t];r===k_.CONSTANT?i.interpolationMode=Ml.CONSTANT:(i.interpolationMode=Ml.LINEAR,i.easingMethod=r)}function FG(t,e,n){e.keyFramesCount;var i=e.getKeyframeValue(n),r=fU[t];i.easingMethod=r}var zG,VG,GG,UG,kG,HG,jG,WG,qG,XG,YG,KG,JG,QG,ZG,$G,tU,eU,nU,iU,rU,oU,aU,sU,cU,lU,uU,hU,_U,fU={constant:k_.CONSTANT,linear:k_.LINEAR,quadIn:k_.QUAD_IN,quadOut:k_.QUAD_OUT,quadInOut:k_.QUAD_IN_OUT,quadOutIn:k_.QUAD_OUT_IN,cubicIn:k_.CUBIC_IN,cubicOut:k_.CUBIC_OUT,cubicInOut:k_.CUBIC_IN_OUT,cubicOutIn:k_.CUBIC_OUT_IN,quartIn:k_.QUART_IN,quartOut:k_.QUART_OUT,quartInOut:k_.QUART_IN_OUT,quartOutIn:k_.QUART_OUT_IN,quintIn:k_.QUINT_IN,quintOut:k_.QUINT_OUT,quintInOut:k_.QUINT_IN_OUT,quintOutIn:k_.QUINT_OUT_IN,sineIn:k_.SINE_IN,sineOut:k_.SINE_OUT,sineInOut:k_.SINE_IN_OUT,sineOutIn:k_.SINE_OUT_IN,expoIn:k_.EXPO_IN,expoOut:k_.EXPO_OUT,expoInOut:k_.EXPO_IN_OUT,expoOutIn:k_.EXPO_OUT_IN,circIn:k_.CIRC_IN,circOut:k_.CIRC_OUT,circInOut:k_.CIRC_IN_OUT,circOutIn:k_.CIRC_OUT_IN,elasticIn:k_.ELASTIC_IN,elasticOut:k_.ELASTIC_OUT,elasticInOut:k_.ELASTIC_IN_OUT,elasticOutIn:k_.ELASTIC_OUT_IN,backIn:k_.BACK_IN,backOut:k_.BACK_OUT,backInOut:k_.BACK_IN_OUT,backOutIn:k_.BACK_OUT_IN,bounceIn:k_.BOUNCE_IN,bounceOut:k_.BOUNCE_OUT,bounceInOut:k_.BOUNCE_IN_OUT,bounceOutIn:k_.BOUNCE_OUT_IN,smooth:k_.SMOOTH,fade:k_.FADE};function pU(){throw new Error("split() only valid in Editor.")}qc("cc.animation.ExoticAnimation")((GG=function(){function t(){q(this,"_nodeAnimations",VG,this)}var e=t.prototype;return e.createEvaluator=function(t){return new bU(this._nodeAnimations,t)},e.addNodeAnimation=function(t){var e=new dU(t);return this._nodeAnimations.push(e),e},e.collectAnimatedJoints=function(){return Array.from(new Set(this._nodeAnimations.map((function(t){return t.path}))))},e.split=function(){return pU()},e.toHashString=function(){return this._nodeAnimations.map((function(t){return t.toHashString()})).join("\n")},t}(),VG=X((zG=GG).prototype,"_nodeAnimations",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zG));var dU=qc("cc.animation.ExoticNodeAnimation")((XG=function(){function t(t){q(this,"_path",HG,this),q(this,"_position",jG,this),q(this,"_rotation",WG,this),q(this,"_scale",qG,this),this._path=t}var e=t.prototype;return e.createPosition=function(t,e){this._position=new SU(t,new yU(e))},e.createRotation=function(t,e){this._rotation=new SU(t,new xU(e))},e.createScale=function(t,e){this._scale=new SU(t,new yU(e))},e.createEvaluator=function(t){return new TU(this._path,this._position,this._rotation,this._scale,t)},e.split=function(){return pU()},e.toHashString=function(){var t,e,n,i,r,o;return this._path+"\n"+(null!==(t=null===(e=this._position)||void 0===e?void 0:e.toHashString())&&void 0!==t?t:"")+(null!==(n=null===(i=this._scale)||void 0===i?void 0:i.toHashString())&&void 0!==n?n:"")+(null!==(r=null===(o=this._rotation)||void 0===o?void 0:o.toHashString())&&void 0!==r?r:"")},N(t,[{key:"path",get:function(){return this._path}}]),t}(),HG=X((kG=XG).prototype,"_path",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),jG=X(kG.prototype,"_position",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WG=X(kG.prototype,"_rotation",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qG=X(kG.prototype,"_scale",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),UG=kG))||UG;function mU(t){return t.toPrecision(2)}function vU(t){return t.map(mU).join(" ")}var gU=qc("cc.animation.ExoticVectorLikeTrackValues")((ZG=function(){function t(t){q(this,"_values",JG,this),q(this,"_isQuantized",QG,this),this._values=t,this._isQuantized=!1}var e=t.prototype;return e.quantize=function(t){this._isQuantized,this._values=function(t,e){var n=wU[e],i=1<<n.BYTES_PER_ELEMENT,r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;t.forEach((function(t){r=Math.min(t,r),o=Math.max(t,o)}));var a=o-r,s=n.from(t,(function(t){return(t-r)/a*i}));return new kU(PU(t),s,a,r)}(this._values,t),this._isQuantized=!0},e.toHashString=function(){var t=this._isQuantized,e=this._values;return t+" "+(t?e.toHashString():vU(e))},N(t,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:PU(this._values)}}]),t}(),JG=X((KG=ZG).prototype,"_values",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),QG=X(KG.prototype,"_isQuantized",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),YG=KG))||YG,yU=qc("cc.animation.ExoticVec3TrackValues")($G=function(t){function e(){return t.apply(this,arguments)||this}F(e,t),e.imitate=function(t,n){var i=new e(t);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=e.prototype;return n.get=function(t,e){var n=this._values;this._isQuantized?WU(n,t,e):oi.fromArray(e,n,3*t)},n.lerp=function(t,e,n,i,r,o){var a=this._values;this._isQuantized?(WU(a,t,i),WU(a,e,r)):(oi.fromArray(i,a,3*t),oi.fromArray(r,a,3*e)),oi.lerp(o,i,r,n)},e}(gU))||$G,xU=qc("cc.animation.ExoticQuatTrackValues")(tU=function(t){function e(){return t.apply(this,arguments)||this}F(e,t),e.imitate=function(t,n){var i=new e(t);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=e.prototype;return n.get=function(t,e){var n=this._values;this._isQuantized?qU(n,t,e):gi.fromArray(e,n,4*t)},n.lerp=function(t,e,n,i,r,o){var a=this._values;this._isQuantized?(qU(a,t,i),qU(a,e,r)):(gi.fromArray(i,a,4*t),gi.fromArray(r,a,4*e)),gi.slerp(o,i,r,n)},e}(gU))||tU,SU=qc("cc.animation.ExoticTrack")((oU=function(){function t(t,e){q(this,"times",iU,this),q(this,"values",rU,this),this.times=t,this.values=e}return t.prototype.toHashString=function(){var t=this.times,e=this.values;return"times: "+vU(t)+"; values: "+e.toHashString()},t}(),iU=X((nU=oU).prototype,"times",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),rU=X(nU.prototype,"values",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),eU=nU))||eU;function AU(t,e){t.length,t.length;var n=0,i=0,r=Fc(t,e);if(r>=0)n=r;else{var o=~r,a=o-1;n=a;var s=t[o],c=t[a];i=(e-c)/(s-c)}return{index:n,ratio:i}}!function(){function t(){this._reset()}var e=t.prototype;e.transformTime=function(t){return t-this._timeOffset},e.calculate=function(t,e,n){this._reset();var i=t.length;if(i){var r=t[0],o=t[i-1],a=Un(e,r,o),s=Un(n,r,o);this._timeOffset=a;var c=function(t,e,n){var i=t.length;n>=e&&e>=t[0]&&t[i-1];var r=AU(t,e),o=r.index,a=r.ratio,s=AU(t,n);return{fromIndex:o,fromRatio:a,toIndex:s.index,toRatio:s.ratio}}(t,a,s),l=c.fromIndex,u=c.fromRatio,h=c.toIndex,_=c.toRatio,f=!u,p=!_;l!==h||u!==_?(f||(this.preLerpIndex=l,this.preLerpRatio=u),this.directKeyframesBegin=f?l:l+1,this.directKeyframesEnd=h+1,p||(this.postLerpIndex=h,this.postLerpRatio=_)):f?(this.directKeyframesBegin=l,this.directKeyframesEnd=l+1):(this.preLerpIndex=l,this.preLerpRatio=u)}},e._reset=function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0},N(t,[{key:"keyframesCount",get:function(){var t=this.preLerpIndex,e=this.directKeyframesBegin;return 0+(t<0?0:1)+(this.directKeyframesEnd-e)+(this.postLerpIndex<0?0:1)}}])}();var CU,bU=function(){function t(t,e){this._nodeEvaluations=void 0,this._nodeEvaluations=t.map((function(t){return t.createEvaluator(e)}))}return t.prototype.evaluate=function(t){this._nodeEvaluations.forEach((function(e){e.evaluate(t)}))},t}(),TU=function(){function t(t,e,n,i,r){this._position=null,this._rotation=null,this._scale=null,e&&(this._position=jU(e.times,e.values,oi,t,"position",r)),n&&(this._rotation=jU(n.times,n.values,gi,t,"rotation",r)),i&&(this._scale=jU(i.times,i.values,oi,t,"scale",r))}return t.prototype.evaluate=function(t){if(this._position){var e=this._position.evaluator.evaluate(t);this._position.runtimeBinding.setValue(e)}if(this._rotation){var n=this._rotation.evaluator.evaluate(t);this._rotation.runtimeBinding.setValue(n)}if(this._scale){var i=this._scale.evaluator.evaluate(t);this._scale.runtimeBinding.setValue(i)}},t}(),EU=function(){function t(t,e,n){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=t,this._values=e,this._prevValue=new n,this._nextValue=new n,this._resultValue=new n}return t.prototype.evaluate=function(t){var e=this._times,n=this._values,i=this._resultValue;if(0===e.length)return i;var r=function(t,e,n){var i=t.length,r=t[0],o=t[i-1];if(e<r)n.just=!0,n.index=0;else if(e>o)n.just=!0,n.index=i-1;else{var a=Fc(t,e);if(a>=0)n.just=!0,n.index=a;else{var s=~a,c=s-1,l=t[c],u=t[s],h=(e-t[c])/(u-l);n.just=!1,n.index=c,n.nextIndex=s,n.ratio=h}}return n}(e,t,this._inputSampleResultCache);return r.just?n.get(r.index,i):n.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,i),i},t}(),wU={uint8:Uint8Array,uint16:Uint16Array};function PU(t){switch(t.BYTES_PER_ELEMENT){default:case 4:return CU.FLOAT_32;case 8:return CU.FLOAT_64}}!function(t){t[t.FLOAT_32=0]="FLOAT_32",t[t.FLOAT_64=1]="FLOAT_64"}(CU||(CU={}));var IU,RU,DU,BU,MU,OU,NU,LU,FU,zU,VU,GU,UU,kU=qc("cc.animation.QuantizedFloatArray")((_U=function(){function t(t,e,n,i){void 0===i&&(i=0),q(this,"originalPrecision",cU,this),q(this,"min",lU,this),q(this,"extent",uU,this),q(this,"values",hU,this),this.originalPrecision=t,this.values=e,this.extent=n,this.min=i}return t.prototype.toHashString=function(){var t=this.originalPrecision,e=this.min,n=this.extent,i=this.values;return t+" "+mU(e)+" "+mU(n)+" "+i.join(" ")},N(t,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}}]),t}(),cU=X((sU=_U).prototype,"originalPrecision",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),lU=X(sU.prototype,"min",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),uU=X(sU.prototype,"extent",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),hU=X(sU.prototype,"values",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),aU=sU))||aU;function HU(t,e){return t.values[e]/(1<<t.values.BYTES_PER_ELEMENT)*t.extent+t.min}function jU(t,e,n,i,r,o){var a=new $F;a.path=(new ZF).toHierarchy(i).toProperty(r);var s=o(a);return s?{runtimeBinding:s,evaluator:new EU(t,e,n)}:null}function WU(t,e,n){oi.set(n,HU(t,3*e+0),HU(t,3*e+1),HU(t,3*e+2))}function qU(t,e,n){gi.set(n,HU(t,4*e+0),HU(t,4*e+1),HU(t,4*e+2),HU(t,4*e+3))}var XU=Symbol("SearchForRootBonePath"),YU=Symbol("ExoticAnimation"),KU=t("AnimationClip",qc("cc.AnimationClip")((UU=GU=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"sample",DU,H(e)),q(e,"speed",BU,H(e)),q(e,"wrapMode",MU,H(e)),q(e,"enableTrsBlending",OU,H(e)),q(e,"_duration",NU,H(e)),q(e,"_hash",LU,H(e)),e.frameRate=0,q(e,"_tracks",FU,H(e)),q(e,"_exoticAnimation",zU,H(e)),e._legacyData=void 0,e._legacyDataDirty=!1,q(e,"_events",VU,H(e)),e._runtimeEvents={ratios:[],eventGroups:[]},e}F(e,t),e.createWithSpriteFrames=function(t,n){var i=new e;i.sample=n||i.sample,i.duration=t.length/i.sample;var r=1/i.sample,o=new Iz;return o.path=(new ZF).toComponent("cc.Sprite").toProperty("spriteFrame"),o.channels()[0].curve.assignSorted(t.map((function(t,e){return[r*e,t]}))),i.addTrack(o),i};var n=e.prototype;return n.onLoaded=function(){this.frameRate=this.sample,this.events=this._events},n.range=function(){for(var t={min:1/0,max:-1/0},e=this._tracks,n=e.length,i=0;i<n;++i){var r=e[i].range();t.min=Math.min(t.min,r.min),t.max=Math.max(t.max,r.max)}return t},n.getTrack=function(t){return this._tracks[t]},n.addTrack=function(t){var e=this._tracks.length;return this._tracks.push(t),e},n.removeTrack=function(t){this._tracks.splice(t,1)},n.clearTracks=function(){this._tracks.length=0},n.createEventEvaluator=function(t){return new ik(t,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)},n.createEvaluator=function(t){var e=this,n=t.target;return this._createEvalWithBinder(n,(function(i){var r=i.createRuntimeBinding(n,e.enableTrsBlending?t.pose:void 0,!1);return null!=r?r:void 0}),t.rootMotion)},n.destroy=function(){var e;return(null===(e=i.director.root)||void 0===e?void 0:e.dataPoolManager)&&i.director.root.dataPoolManager.releaseAnimationClip(this),mG.destroy(this),t.prototype.destroy.call(this)},n[dG]=function(t,e,n){for(var i=1/e,r=this._collectAnimatedJoints(),o=r.length,a={},s=0;s<o;++s)a[r[s]]={transforms:Array.from({length:n},(function(){return new Ei}))};var c=r.reduce((function(t,e){return t[e]=new ZU,t}),{});for(var l in c){var u=c[l],h=l.lastIndexOf("/");if(h>=0){var _=l.substring(0,h),f=c[_];f&&(u.parent=f)}}for(var p=this._createEvalWithBinder(void 0,(function(t){var e=t.parseTrsPath();if(e){var n=c[e.node];if(n)return nk(n,e.property)}}),void 0),d=0;d<n;++d){var m=t+i*d;p.evaluate(m);for(var v=0;v<o;++v){var g=r[v];Ei.copy(a[g].transforms[d],c[g].globalTransform)}for(var y=0;y<o;++y){var x=r[y];c[x].invalidate()}}return{samples:e,frames:n,joints:a}},n.upgradeUntypedTracks=function(t){for(var e=[],n=[],i=this._tracks,r=i.length,o=0;o<r;++o){var a=i[o];if(a instanceof BG){var s=a.upgrade(t);s&&(e.push(s),n.push(a))}}for(var c=n.length,l=0;l<c;++l)Ut.remove(i,n[l]);i.push.apply(i,e)},n[XU]=function(){return this._searchForRootBonePath()},n.getPropertyCurves=function(){return this._getLegacyData().getPropertyCurves()},n.updateEventDatas=function(){this.events=this._events},n.hasEvents=function(){return 0!==this.events.length},n.syncLegacyData=function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)},n._createEvalWithBinder=function(t,e,n){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var i,r=[];n&&(i=this._createRootMotionEvaluation(t,n,r));for(var o,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l];if(!r.includes(u)&&!Array.from(u.channels()).every((function(t){return 0===t.curve.keyFramesCount}))){var h=e(u[QF]);if(h){var _=u[YF](h);a.push({binding:h,trackEval:_})}}}return this._exoticAnimation&&(o=this._exoticAnimation.createEvaluator(e)),new JU(a,o,i)},n._createRootMotionEvaluation=function(t,e,n){if(t instanceof BT){var i=this._searchForRootBonePath();if(i){var r=t.getChildByPath(i);if(r){for(var o=new QU,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l],h=u[QF].parseTrsPath();if(h&&h.node===i){n.push(u);var _=nk(o,h.property);if(_){var f=u[YF](_);a.push({binding:_,trackEval:f})}}}return new tk(r,this._duration,o,a)}b(3924)}else b(3923)}else E(3920)},n._searchForRootBonePath=function(){var t=this._tracks.map((function(t){var e=t[QF].parseTrsPath();if(e){var n=e.node;return{path:n,rank:n.split("/").length}}return{path:"",rank:0}}));t.sort((function(t,e){return t.rank-e.rank}));var e=t.findIndex((function(t){return 0!==t.rank}));if(e<0)return"";for(var n=t.length,i=t[e],r=!0,o=e+1;o<n;++o){var a=t[o];if(a.rank!==i.rank)break;if(a.path!==i.path){r=!1;break}}return r?i.path:""},n._getLegacyData=function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData},n._toLegacy=function(){var t=new MG(this._duration);return t.keys=[],t.curves=[],t.commonTargets=[],t},n._fromLegacy=function(t){for(var e=t.toTracks(),n=e.length,i=0;i<n;++i)this.addTrack(e[i])},n._collectAnimatedJoints=function(){for(var t=new Set,e=this._tracks,n=e.length,i=0;i<n;++i){var r=e[i][QF].parseTrsPath();r&&t.add(r.node)}if(this._exoticAnimation)for(var o=this._exoticAnimation.collectAnimatedJoints(),a=o.length,s=0;s<a;++s)t.add(o[s]);return Array.from(t)},N(e,[{key:"duration",get:function(){return this._duration},set:function(t){this._duration=t}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){var t,e;if(this._hash)return this._hash;var n="Exotic:"+(null!==(t=null===(e=this._exoticAnimation)||void 0===e?void 0:e.toHashString())&&void 0!==t?t:"");return this._hash=xa(n,666)}},{key:"events",get:function(){return this._events},set:function(t){var e=this;this._events=t;for(var n=[],i=[],r=this.events.sort((function(t,e){return t.frame-e.frame})),o=r.length,a=function(t){var o=r[t],a=o.frame/e._duration,s=n.findIndex((function(t){return t===a}));s<0&&(s=n.length,n.push(a),i.push({events:[]})),i[s].events.push({functionName:o.func,parameters:o.params})},s=0;s<o;++s)a(s);this._runtimeEvents={ratios:n,eventGroups:i}}},{key:YU,get:function(){return this._exoticAnimation}},{key:YU,set:function(t){this._exoticAnimation=t}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(t){this._legacyDataDirty=!0,this._getLegacyData().keys=t}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(t){this._getLegacyData().curves=t}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(t){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=t}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}}]),e}(Su),GU.WrapMode=Dc,DU=X((RU=UU).prototype,"sample",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),BU=X(RU.prototype,"speed",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),MU=X(RU.prototype,"wrapMode",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dc.Normal}}),OU=X(RU.prototype,"enableTrsBlending",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),NU=X(RU.prototype,"_duration",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),LU=X(RU.prototype,"_hash",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FU=X(RU.prototype,"_tracks",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zU=X(RU.prototype,"_exoticAnimation",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VU=X(RU.prototype,"_events",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),IU=RU))||IU);i.AnimationClip=KU;var JU=function(){function t(t,e,n){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=t,this._exoticAnimationEvaluator=e,this._rootMotionEvaluation=n}var e=t.prototype;return e.evaluate=function(t){for(var e=this._trackEvalStatues,n=this._exoticAnimationEvaluator,i=e.length,r=0;r<i;++r){var o=e[r],a=o.trackEval,s=o.binding,c=a.evaluate(t,s);s.setValue(c)}n&&n.evaluate(t)},e.evaluateRootMotion=function(t,e){var n=this._rootMotionEvaluation;n&&n.evaluate(t,e)},t}(),QU=function(){function t(){this.position=new oi,this.scale=new oi(1,1,1),this.rotation=new gi,this.eulerAngles=new oi}return t.prototype.getTransform=function(t){Ei.fromRTS(t,this.rotation,this.position,this.scale)},t}(),ZU=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).parent=null,e._dirty=!0,e._transform=new Ei,e}return F(e,t),e.prototype.invalidate=function(){this._dirty=!0},N(e,[{key:"globalTransform",get:function(){var t=this._transform;return this._dirty&&(this._dirty=!1,Ei.fromRTS(t,this.rotation,this.position,this.scale),this.parent&&Ei.multiply(t,this.parent.globalTransform,t)),this._transform}}]),e}(QU),$U=new Ei,tk=function(){function t(t,e,n,i){this._initialTransformCache=new Ei,this._clipEndTransformCache=new Ei,this._startTransformCache=new Ei,this._endTransformCache=new Ei,this._motionTransformCache=new Ei,this._translationMotionCache=new oi,this._rotationMotionCache=new gi,this._scaleMotionCache=new oi,this._rootBone=t,this._duration=e,this._boneTransform=n,this._trackEvalStatuses=i}var e=t.prototype;return e.evaluate=function(t,e){var n=this._calcMotionTransform(t,e,this._motionTransformCache),i=this._translationMotionCache,r=this._rotationMotionCache,o=this._scaleMotionCache,a=this._rootBone;Ei.toRTS(n,r,i,o),oi.add(i,i,a.position),a.setPosition(i),gi.multiply(r,r,a.rotation),a.setRotation(r),oi.multiply(o,o,a.scale),a.setScale(o)},e._calcMotionTransform=function(t,e,n){var i=this._duration,r=i-t,o=this._evaluateAt(t,this._startTransformCache);if(e<r){var a=this._evaluateAt(t+e,this._endTransformCache);ek(n,o,a)}else{Ei.identity(n);var s=function(t,e){ek($U,t,e),Ei.multiply(n,n,$U)},c=e-r,l=Math.floor(c/i),u=c-l*i,h=this._evaluateAt(0,this._initialTransformCache),_=this._evaluateAt(i,this._clipEndTransformCache),f=this._evaluateAt(u,this._endTransformCache);s(o,_),ek($U,h,_);for(var p=0;p<l;++p)Ei.multiply(n,n,$U);s(h,f)}return n},e._evaluateAt=function(t,e){for(var n=this._trackEvalStatuses,i=n.length,r=0;r<i;++r){var o=n[r],a=o.trackEval,s=o.binding,c=a.evaluate(t,s);s.setValue(c)}return this._boneTransform.getTransform(e),e},t}();function ek(t,e,n){Ei.invert(t,e),Ei.multiply(t,n,t)}function nk(t,e){switch(e){default:return;case"position":return{setValue:function(e){oi.copy(t.position,e)}};case"rotation":return{setValue:function(e){gi.copy(t.rotation,e)}};case"scale":return{setValue:function(e){oi.copy(t.scale,e)}};case"eulerAngles":return{setValue:function(e){oi.copy(t.eulerAngles,e)}}}}var ik=function(){function t(t,e,n,i){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=t,this._ratios=e,this._eventGroups=n,this._wrapMode=i}var e=t.prototype;return e.setWrapMode=function(t){this._wrapMode=t},e.ignore=function(t,e){this._ignoreIndex=-1,this._sampled=!1;var n=ok(t,this._ratios);n<0&&(n=~n-1,e<0&&(n+=1),this._ignoreIndex=n)},e.sample=function(t,e,n){var i=this._eventGroups.length,r=ok(t,this._ratios);if(r<0&&(r=~r-1,e<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=n,void(this._lastDirection=e);var o=this._wrapMode,a=rk(n),s=rk(this._lastIterations),c=this._lastFrameIndex,l=this._lastDirection,u=-1!==s&&a!==s;if(c===r&&u&&1===i)this._doFire(0,!1);else if(c!==r||u){e=l;do{if(c!==r){if(-1===e&&0===c&&r>0?((o&Rc.PingPong)===Rc.PingPong?e*=-1:c=i,s++):1===e&&c===i-1&&r<i-1&&((o&Rc.PingPong)===Rc.PingPong?e*=-1:c=-1,s++),c===r)break;if(s>a)break}c+=e,this._doFire(c,!0)}while(c!==r&&c>-1&&c<i)}this._lastFrameIndex=r,this._lastIterations=n,this._lastDirection=e},e._doFire=function(t,e){e?i.director.getAnimationManager().pushDelayEvent(this._checkAndFire,this,[t]):this._checkAndFire(t)},e._checkAndFire=function(t){if(this._targetNode&&this._targetNode.isValid){var e=this._eventGroups;if(!(t<0||t>=e.length||this._ignoreIndex===t))for(var n=e[t],i=this._targetNode.components,r=n.events.length,o=0;o<r;++o)for(var a=n.events[o],s=a.functionName,c=i.length,l=0;l<c;++l){var u=i[l],h=u[s];"function"==typeof h&&h.apply(u,a.parameters)}}},t}();function rk(t){return t-(0|t)==0&&(t-=1),0|t}function ok(t,e){return Fc(e,t)}var ak,sk=function(){function t(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}var e=t.prototype;return e.play=function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(R(3912)):(this._isPlaying=!0,this.onPlay())},e.stop=function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)},e.pause=function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())},e.resume=function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())},e.step=function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()},e.update=function(){},e.onPlay=function(){},e.onPause=function(){},e.onResume=function(){},e.onStop=function(){},e.onError=function(){},N(t,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),t}(),ck=function(){function t(t){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=t}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this._blendStateWriters.length;++t)this._pose.destroyWriter(this._blendStateWriters[t]);this._blendStateWriters.length=0},e.createPoseWriter=function(t,e,n){var i=this._pose.createWriter(t,e,this,n);return this._blendStateWriters.push(i),i},t}();!function(t){t.PLAY="play",t.STOP="stop",t.PAUSE="pause",t.RESUME="resume",t.LASTFRAME="lastframe",t.FINISHED="finished"}(ak||(ak={})),$t(ak);var lk=t("AnimationState",function(t){function e(e,n){var i;return void 0===n&&(n=""),(i=t.call(this)||this).duration=1,i.speed=1,i.time=0,i.frameRate=0,i._targetNode=null,i._curveLoaded=!1,i._clip=void 0,i._useSimpleProcess=!1,i._target=null,i._wrapMode=Dc.Normal,i._repeatCount=1,i._delay=0,i._delayTime=0,i._currentFramePlayed=!1,i._name=void 0,i._lastIterations=NaN,i._lastWrapInfo=null,i._wrappedInfo=new Lc,i._allowLastFrame=!1,i._blendStateWriterHost={weight:0},i._playbackDuration=0,i._invDuration=1,i._poseOutput=null,i._weight=0,i._clipEval=void 0,i._clipEventEval=void 0,i._doNotCreateEval=!1,i._clip=e,i._name=n||e&&e.name,i._playbackRange={min:0,max:e.duration},i._playbackDuration=e.duration,e.duration||v("Clip "+e.name+" has zero duration."),i}F(e,t);var n=e.prototype;return n.initialize=function(t,e){if(!this._curveLoaded){this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=t;var n=this._clip;if(this.duration=n.duration,this._invDuration=1/this.duration,this.speed=n.speed,this.wrapMode=n.wrapMode,this.frameRate=n.sample,this._playbackRange.min=0,this._playbackRange.max=n.duration,this._playbackDuration=n.duration,(this.wrapMode&Rc.Loop)===Rc.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var r,o,a,s=null!==(r=null!=e?e:null===(o=i.director.getAnimationManager())||void 0===o?void 0:o.blendState)&&void 0!==r?r:null;s&&(this._poseOutput=new ck(s)),this._clipEval=n.createEvaluator({target:t,pose:null!==(a=this._poseOutput)&&void 0!==a?a:void 0})}this._clipEventEval=n.createEventEvaluator(this._targetNode)}},n.destroy=function(){this.isMotionless||i.director.getAnimationManager().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0},n.emit=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];i.director.getAnimationManager().pushDelayEvent(this._emit,this,e)},n.on=function(t,e,n){return this._target&&this._target.isValid?this._target.on(t,e,n):null},n.once=function(t,e,n){return this._target&&this._target.isValid?this._target.once(t,e,n):null},n.off=function(t,e,n){this._target&&this._target.isValid&&this._target.off(t,e,n)},n.allowLastFrameEvent=function(t){this._allowLastFrame=t},n._setEventTarget=function(t){this._target=t},n.setTime=function(t){this._currentFramePlayed=!1,this.time=t||0;var e,n=this.getWrappedInfo(t,this._wrappedInfo);null===(e=this._clipEventEval)||void 0===e||e.ignore(n.ratio,n.direction)},n.update=function(t){this._delayTime>0&&(this._delayTime-=t,this._delayTime>0)||(this._currentFramePlayed?this.time+=t*this.speed:this._currentFramePlayed=!0,this._process())},n.sample=function(){var t=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(t.time),this._sampleEvents(t),t},n.onPlay=function(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(ak.PLAY,this)},n.onStop=function(){this.isPaused||this._onPauseOrStop(),this.emit(ak.STOP,this)},n.onResume=function(){this._onReplayOrResume(),this.emit(ak.RESUME,this)},n.onPause=function(){this._onPauseOrStop(),this.emit(ak.PAUSE,this)},n._sampleCurves=function(t){var e=this._poseOutput,n=this._clipEval;e&&(e.weight=this.weight),n&&n.evaluate(t)},n._process=function(){this._useSimpleProcess?this.simpleProcess():this.process()},n.process=function(){var t,e=this.sample();this._allowLastFrame&&(t=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new Lc(e),this.repeatCount>1&&(0|e.iterations)>(0|t.iterations)&&this.emit(ak.LASTFRAME,this),t.set(e)),e.stopped&&(this.stop(),this.emit(ak.FINISHED,this))},n.simpleProcess=function(){var t=this._playbackRange.min,e=this._playbackDuration,n=this.time%e;n<0&&(n+=e);var i=(t+n)*this._invDuration;this._sampleCurves(t+n),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(ak.LASTFRAME,this),this._lastIterations=i)},n._needReverse=function(t){var e=this.wrapMode,n=!1;return(e&Rc.PingPong)===Rc.PingPong&&(t-(0|t)==0&&t>0&&(t-=1),1&t&&(n=!n)),(e&Rc.Reverse)===Rc.Reverse&&(n=!n),n},n.getWrappedInfo=function(t,e){e=e||new Lc;var n=this._getPlaybackStart(),i=this._getPlaybackEnd()-n,r=!1,o=this.repeatCount,a=(t-=n)>0?t/i:-t/i;if(a>=o){a=o,r=!0;var s=o-(0|o);0===s&&(s=1),t=s*i*(t>0?1:-1)}if(t>i){var c=t%i;t=0===c?i:c}else t<0&&0!=(t%=i)&&(t+=i);var l=!1,u=this._wrapMode&Rc.ShouldWrap;u&&(l=this._needReverse(a));var h=l?-1:1;return this.speed<0&&(h*=-1),u&&l&&(t=i-t),e.time=n+t,e.ratio=e.time/this.duration,e.direction=h,e.stopped=r,e.iterations=a,e},n._getPlaybackStart=function(){return this._playbackRange.min},n._getPlaybackEnd=function(){return this._playbackRange.max},n._sampleEvents=function(t){var e;null===(e=this._clipEventEval)||void 0===e||e.sample(t.ratio,t.direction,t.iterations)},n._emit=function(t,e){this._target&&this._target.isValid&&this._target.emit(t,t,e)},n._onReplayOrResume=function(){i.director.getAnimationManager().addAnimation(this)},n._onPauseOrStop=function(){i.director.getAnimationManager().removeAnimation(this)},N(e,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(t){var e;this._wrapMode=t,this.time=0,t&Rc.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(e=this._clipEventEval)||void 0===e||e.setWrapMode(t)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(t){this._repeatCount=t;var e=this._wrapMode&Rc.ShouldWrap,n=(this.wrapMode&Rc.Reverse)===Rc.Reverse;this._useSimpleProcess=t===1/0&&!e&&!n}},{key:"delay",get:function(){return this._delay},set:function(t){this._delayTime=this._delay=t}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(t){t.max,t.min,this._playbackRange.min=Math.max(t.min,0),this._playbackRange.max=Math.min(t.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(t){this._weight=t,this._poseOutput&&(this._poseOutput.weight=t)}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),e}(sk));i.AnimationState=lk;var uk,hk,_k,fk,pk,dk=vk,mk=vk;function vk(){}uk=qc("cc.animation.ClipMotion"),hk=El(KU),uk((pk=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"clip",fk,H(e)),e}F(e,t);var n=e.prototype;return n[tV]=function(t){return this.clip?new Fk(t,this.clip):null},n.clone=function(){var t=new e;return t.clip=this.clip,t},e}(Vl),fk=X((_k=pk).prototype,"clip",[hk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_k));var gk,yk,xk,Sk,Ak,Ck,bk,Tk,Ek,wk,Pk,Ik,Rk,Dk,Bk,Mk,Ok,Nk,Lk,Fk=function(){function t(t,e){this.duration=e.duration,this._state=new lk(e),this._state.initialize(t.node,t.blendBuffer)}var e=t.prototype;return e.getClipStatuses=function(t){var e=this,n=!1;return{next:function(){return n?{done:!0,value:void 0}:(n=!0,{done:!1,value:{__DEBUG_ID__:e.__DEBUG__ID__,clip:e._state.clip,weight:t}})}}},e.sample=function(t,e){if(0!==e){this._state.name;var n=this._state.duration*t;this._state.time=n,this._state.weight=e,this._state.sample(),this._state.weight=0}},N(t,[{key:"progress",get:function(){return this._state.time/this.duration}}]),t}(),zk=qc("cc.animation.AnimationBlendItem")((Sk=function(){function t(){q(this,"motion",xk,this)}var e=t.prototype;return e.clone=function(){var e=new t;return this._assign(e),e},e._assign=function(t){var e,n;return t.motion=null!==(e=null===(n=this.motion)||void 0===n?void 0:n.clone())&&void 0!==e?e:null,t},t}(),xk=X((yk=Sk).prototype,"motion",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gk=yk))||gk,Vk=qc("cc.animation.AnimationBlend")((Tk=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"name",bk,H(e)),e}return F(e,t),e}(Vl),bk=X((Ck=Tk).prototype,"name",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ak=Ck))||Ak,Gk=function(){function t(t,e,n){this._childEvaluators=e.map((function(e){var n,i;return null!==(n=null===(i=e.motion)||void 0===i?void 0:i[tV](t))&&void 0!==n?n:null})),this._weights=new Array(this._childEvaluators.length).fill(0),this._inputs=[].concat(n)}var e=t.prototype;return e.getClipStatuses=function(t){var e,n=this._childEvaluators,i=this._weights,r=n.length,o=0;return{next:function(){for(;;){if(e){var a=e.next();if(!a.done)return a}if(o>=r)return{done:!0,value:void 0};var s=n[o];e=null==s?void 0:s.getClipStatuses(t*i[o]),++o}}}},e.sample=function(t,e){for(var n=0;n<this._childEvaluators.length;++n){var i;null===(i=this._childEvaluators[n])||void 0===i||i.sample(t,e*this._weights[n])}},e.setInput=function(t,e){this._inputs[e]=t,this.doEval()},e.doEval=function(){this.eval(this._weights,this._inputs)},e.eval=function(){},N(t,[{key:"duration",get:function(){for(var t=0,e=0;e<this._childEvaluators.length;++e){var n,i;t+=(null!==(n=null===(i=this._childEvaluators[e])||void 0===i?void 0:i.duration)&&void 0!==n?n:0)*this._weights[e]}return t}}]),t}(),Uk=qc("cc.animation.AnimationBlend1DItem")((Ik=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"threshold",Pk,H(e)),e}F(e,t);var n=e.prototype;return n.clone=function(){var t=new e;return this._assign(t),t},n._assign=function(e){return t.prototype._assign.call(this,e),e.threshold=this.threshold,e},e}(zk),Pk=X((wk=Ik).prototype,"threshold",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ek=wk))||Ek,kk=(qc("cc.animation.AnimationBlend1D")((Ok=Mk=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_items",Dk,H(e)),q(e,"param",Bk,H(e)),e}F(e,t);var n=e.prototype;return n.clone=function(){var t=new e;return t._items=this._items.map((function(t){return t.clone()})),t.param=this.param.clone(),t},n[tV]=function(t){var e=new kk(t,this._items,this._items.map((function(t){return t.threshold})),0),n=_V(t,this.param,Jz.FLOAT,e.setInput,e,0);return e.setInput(n,0),e},N(e,[{key:"items",get:function(){return this._items},set:function(t){this._items=Array.from(t).sort((function(t,e){return t.threshold-e.threshold}))}}]),e}(Vk),Mk.Item=Uk,Dk=X((Rk=Ok).prototype,"_items",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Bk=X(Rk.prototype,"param",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new uV}}),Rk)),function(t){function e(e,n,i,r){var o;return(o=t.call(this,e,n,[r])||this)._thresholds=i,o.doEval(),o}return F(e,t),e.prototype.eval=function(t,e){var n=e[0];!function(t,e,n){if(t.fill(0),0===e.length);else if(n<=e[0])t[0]=1;else if(n>=e[e.length-1])t[t.length-1]=1;else{for(var i=0,r=1;r<e.length;++r)if(e[r]>n){i=r;break}var o=e[i-1],a=e[i],s=a-o;t[i-1]=(a-n)/s,t[i]=(n-o)/s}}(t,this._thresholds,n)},e}(Gk)),Hk=(Nk=new li,Lk={wA:0,wB:0},function(t,e,n){if(t.length,e.length,0!==e.length)if(1!==e.length)if(li.strictEquals(n,li.ZERO)){var i=e.findIndex((function(t){return li.strictEquals(t,li.ZERO)}));i>=0?t[i]=1:t.fill(1/e.length)}else{for(var r=-1,o=-1,a=-1,s=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY,l=n.x,u=n.y,h=0;h<e.length;++h){var _=e[h];if(li.equals(_,li.ZERO))a=h;else{var f=li.normalize(Nk,_),p=li.dot(f,n);f.x*u-f.y*l>0?p>=c&&(c=p,r=h):p>=s&&(s=p,o=h)}}var d=0;if(r<0||o<0)d=1;else{var m=(b=e[r],T=e[o],E=n,w=Lk,(P=li.cross(b,T))?(w.wA=li.cross(E,T)/P,w.wB=li.cross(E,b)/-P):(w.wA=0,w.wB=0),w),v=m.wA,g=m.wB,y=0,x=0,S=v+g;S>1?(y=v/S,x=g/S):S<0?(y=0,x=0,d=1):(y=v,x=g,d=1-S),t[r]=y,t[o]=x}if(d>0)if(a>=0)t[a]=d;else for(var A=d/t.length,C=0;C<t.length;++C)t[C]+=A}else t[0]=1;var b,T,E,w,P});function jk(t,e,n,i){t.fill(0);for(var r=new li(0,0),o=new li(0,0),a=0,s=e.length,c=0;c<s;++c){for(var l=Number.MAX_VALUE,u=!1,h=0;h<s;++h)if(c!==h){i(e[c],e[h],n,r,o);var _=1-li.dot(r,o)/li.lengthSqr(o);if(_<0){u=!0;break}l=Math.min(l,_)}u||(t[c]=l,a+=l)}a>0&&t.forEach((function(e,n){return t[n]=e/a}))}var Wk,qk,Xk,Yk,Kk,Jk,Qk,Zk,$k,tH,eH,nH,iH,rH,oH,aH,sH,cH,lH=function(t,e,n,i,r){li.subtract(i,n,t),li.subtract(r,e,t)},uH=(Wk=new oi(0,0,0),qk=new oi(0,0,0),Xk=new oi(0,0,0),Yk=new oi(0,0,0),Kk=new oi(0,0,0),Jk=new oi(0,0,0),function(t,e,n,i,r){var o=0,a=0,s=2;oi.set(Xk,n.x,n.y,0),li.equals(t,li.ZERO)?(o=li.angle(n,e),a=0,s=1):li.equals(e,li.ZERO)?(a=o=li.angle(n,t),s=1):(o=li.angle(t,e))<=0?a=0:li.equals(n,li.ZERO)?a=o:(oi.set(Yk,t.x,t.y,0),oi.set(Kk,e.x,e.y,0),oi.set(Jk,n.x,n.y,0),oi.cross(Wk,Yk,Kk),oi.projectOnPlane(Xk,Jk,Wk),a=oi.angle(Yk,Xk),o<.99*Math.PI&&oi.dot(oi.cross(qk,Yk,Xk),Wk)<0&&(a=-a));var c=li.len(t),l=li.len(e),u=(l+c)/2;li.set(r,(l-c)/u,o*s),li.set(i,(oi.len(Xk)-c)/u,a*s)});!function(t){t[t.SIMPLE_DIRECTIONAL=0]="SIMPLE_DIRECTIONAL",t[t.FREEFORM_CARTESIAN=1]="FREEFORM_CARTESIAN",t[t.FREEFORM_DIRECTIONAL=2]="FREEFORM_DIRECTIONAL"}(cH||(cH={})),$t(cH);var hH,_H,fH,pH,dH,mH,vH,gH,yH,xH,SH,AH,CH,bH,TH,EH,wH,PH,IH,RH,DH,BH,MH,OH,NH=qc("cc.animation.AnimationBlend2DItem")((tH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"threshold",$k,H(e)),e}F(e,t);var n=e.prototype;return n.clone=function(){var t=new e;return this._assign(t),t},n._assign=function(e){return t.prototype._assign.call(this,e),li.copy(e.threshold,this.threshold),e},e}(zk),$k=X((Zk=tH).prototype,"threshold",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new li}}),Qk=Zk))||Qk,LH=(qc("cc.animation.AnimationBlend2D")((sH=aH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"algorithm",nH,H(e)),q(e,"_items",iH,H(e)),q(e,"paramX",rH,H(e)),q(e,"paramY",oH,H(e)),e}F(e,t);var n=e.prototype;return n.clone=function(){var t=new e;return t._items=this._items.map((function(t){var e;return null!==(e=null==t?void 0:t.clone())&&void 0!==e?e:null})),t.paramX=this.paramX.clone(),t.paramY=this.paramY.clone(),t},n[tV]=function(t){var e=new LH(t,this._items,this._items.map((function(t){return t.threshold})),this.algorithm,[0,0]),n=_V(t,this.paramX,Jz.FLOAT,e.setInput,e,0),i=_V(t,this.paramY,Jz.FLOAT,e.setInput,e,1);return e.setInput(n,0),e.setInput(i,1),e},N(e,[{key:"items",get:function(){return this._items},set:function(t){this._items=Array.from(t)}}]),e}(Vk),aH.Algorithm=cH,aH.Item=NH,nH=X((eH=sH).prototype,"algorithm",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cH.SIMPLE_DIRECTIONAL}}),iH=X(eH.prototype,"_items",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rH=X(eH.prototype,"paramX",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new uV}}),oH=X(eH.prototype,"paramY",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new uV}}),eH)),function(t){function e(e,n,i,r,o){var a;return(a=t.call(this,e,n,o)||this)._thresholds=void 0,a._algorithm=void 0,a._value=new li,a._thresholds=i,a._algorithm=r,a.doEval(),a}return F(e,t),e.prototype.eval=function(t,e){var n=e[0],i=e[1];switch(li.set(this._value,n,i),t.fill(0),this._algorithm){case cH.SIMPLE_DIRECTIONAL:Hk(t,this._thresholds,this._value);break;case cH.FREEFORM_CARTESIAN:!function(t,e,n){jk(t,e,n,lH)}(t,this._thresholds,this._value);break;case cH.FREEFORM_DIRECTIONAL:!function(t,e,n){jk(t,e,n,uH)}(t,this._thresholds,this._value)}},e}(Gk)),FH=qc("cc.animation.AnimationBlendDirectItem")((pH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"weight",fH,H(e)),e}F(e,t);var n=e.prototype;return n.clone=function(){var t=new e;return this._assign(t),t},n._assign=function(e){return t.prototype._assign.call(this,e),e.weight=this.weight,e},e}(zk),fH=X((_H=pH).prototype,"weight",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hH=_H))||hH,zH=(qc("cc.animation.AnimationBlendDirect")((gH=vH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_items",mH,H(e)),e}F(e,t);var n=e.prototype;return n.clone=function(){var t=new e;return t._items=this._items.map((function(t){var e;return null!==(e=null==t?void 0:t.clone())&&void 0!==e?e:null})),t},n[tV]=function(t){return new zH(t,this._items,this._items.map((function(t){return t.weight})))},N(e,[{key:"items",get:function(){return this._items},set:function(t){this._items=Array.from(t)}}]),e}(Vk),vH.Item=FH,mH=X((dH=gH).prototype,"_items",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dH)),function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).doEval(),e}return F(e,t),e.prototype.eval=function(t,e){for(var n=t.length,i=0;i<n;++i)t[i]=e[i]},e}(Gk));!function(t){t[t.EQUAL_TO=0]="EQUAL_TO",t[t.NOT_EQUAL_TO=1]="NOT_EQUAL_TO",t[t.LESS_THAN=2]="LESS_THAN",t[t.LESS_THAN_OR_EQUAL_TO=3]="LESS_THAN_OR_EQUAL_TO",t[t.GREATER_THAN=4]="GREATER_THAN",t[t.GREATER_THAN_OR_EQUAL_TO=5]="GREATER_THAN_OR_EQUAL_TO"}(OH||(OH={})),qc("cc.animation.BinaryCondition")((bH=CH=function(){function t(){q(this,"operator",xH,this),q(this,"lhs",SH,this),q(this,"rhs",AH,this)}var e=t.prototype;return e.clone=function(){var e=new t;return e.operator=this.operator,e.lhs=this.lhs.clone(),e.rhs=this.rhs.clone(),e},e[tV]=function(t){var e=this.operator,n=this.lhs,i=this.rhs,r=new GH(e,0,0),o=fV(t,n,Jz.FLOAT,r.setLhs,r),a=fV(t,i,Jz.FLOAT,r.setRhs,r);return r.reset(o,a),r},t}(),CH.Operator=OH,xH=X((yH=bH).prototype,"operator",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OH.EQUAL_TO}}),SH=X(yH.prototype,"lhs",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new uV}}),AH=X(yH.prototype,"rhs",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new uV}}),yH));var VH,GH=function(){function t(t,e,n){this._operator=t,this._lhs=e,this._rhs=n,this._eval()}var e=t.prototype;return e.reset=function(t,e){this._lhs=t,this._rhs=e,this._eval()},e.setLhs=function(t){this._lhs=t,this._eval()},e.setRhs=function(t){this._rhs=t,this._eval()},e.eval=function(){return this._result},e._eval=function(){var t=this._lhs,e=this._rhs;switch(this._operator){default:case OH.EQUAL_TO:this._result=t===e;break;case OH.NOT_EQUAL_TO:this._result=t!==e;break;case OH.LESS_THAN:this._result=t<e;break;case OH.LESS_THAN_OR_EQUAL_TO:this._result=t<=e;break;case OH.GREATER_THAN:this._result=t>e;break;case OH.GREATER_THAN_OR_EQUAL_TO:this._result=t>=e}},t}();!function(t){t[t.TRUTHY=0]="TRUTHY",t[t.FALSY=1]="FALSY"}(VH||(VH={})),qc("cc.animation.UnaryCondition")((IH=PH=function(){function t(){q(this,"operator",EH,this),q(this,"operand",wH,this)}var e=t.prototype;return e.clone=function(){var e=new t;return e.operator=this.operator,e.operand=this.operand.clone(),e},e[tV]=function(t){var e=this.operator,n=this.operand,i=new jH(e,!1),r=_V(t,n,Jz.BOOLEAN,i.setOperand,i);return i.reset(r),i},t}(),PH.Operator=VH,EH=X((TH=IH).prototype,"operator",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VH.TRUTHY}}),wH=X(TH.prototype,"operand",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hV}}),TH));var UH,kH,HH,jH=function(){function t(t,e){this._operator=t,this._operand=e,this._eval()}var e=t.prototype;return e.reset=function(t){this.setOperand(t)},e.setOperand=function(t){this._operand=t,this._eval()},e.eval=function(){return this._result},e._eval=function(){var t=this._operand;switch(this._operator){default:case VH.TRUTHY:this._result=!!t;break;case VH.FALSY:this._result=!t}},t}(),WH=qc("cc.animation.TriggerCondition")((MH=function(){function t(){q(this,"trigger",BH,this)}var e=t.prototype;return e.clone=function(){var e=new t;return e.trigger=this.trigger,e},e[tV]=function(t){var e=new qH(!1),n=t.getVar(this.trigger);return pV(n,this.trigger)&&(function(t,e,n){if(t!==e)throw new $z(n,"number")}(n.type,Jz.TRIGGER,this.trigger),e.setTrigger(n.bind(e.setTrigger,e))),e},t}(),BH=X((DH=MH).prototype,"trigger",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),RH=DH))||RH,qH=function(){function t(t){this._triggered=!1,this._triggered=t}var e=t.prototype;return e.setTrigger=function(t){this._triggered=t},e.eval=function(){return this._triggered},t}(),XH=function(){function t(){this._nodeBlendStates=new Map}var e=t.prototype;return e.createWriter=function(t,e,n,i){var r=this.ref(t,e);return new YH(t,e,r,n,i)},e.destroyWriter=function(t){var e=t;this.deRef(e.node,e.property)},e.ref=function(t,e){var n=this._nodeBlendStates.get(t);return n||(n=new ZH,this._nodeBlendStates.set(t,n)),n.refProperty(e)},e.deRef=function(t,e){var n=this._nodeBlendStates.get(t);n&&(n.deRefProperty(e),n.empty&&this._nodeBlendStates.delete(t))},e.apply=function(){this._nodeBlendStates.forEach((function(t,e){t.apply(e)}))},t}(),YH=function(){function t(t,e,n,i,r){this._node=t,this._property=e,this._propertyBlendState=n,this._host=i,this._constants=r}var e=t.prototype;return e.getValue=function(){return this._node[this._property]},e.setValue=function(t){var e=this._propertyBlendState,n=this._host.weight;e.blend(t,n)},N(t,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}}]),t}(),KH=function(t){this.blendedWeight=0,this.blendedValue=void 0,this.refCount=0,this.blendedValue=t},JH=function(t){function e(){return t.call(this,new oi)||this}F(e,t);var n=e.prototype;return n.blend=function(t,e){var n=this.blendedValue;1===e?oi.copy(n,t):oi.scaleAndAdd(n,n,t,e),this.blendedWeight+=e},n.reset=function(){this.blendedWeight=0,oi.zero(this.blendedValue)},e}(KH),QH=function(t){function e(){return t.call(this,new gi)||this}F(e,t);var n=e.prototype;return n.blend=function(t,e){if(0!==e){var n=this.blendedValue,i=this.blendedWeight;if(1===e)gi.copy(n,t);else{var r=e/(i+e);gi.slerp(n,n,t,r)}this.blendedWeight+=e}},n.reset=function(){this.blendedWeight=0,gi.identity(this.blendedValue)},e}(KH),ZH=function(){function t(){this._properties={}}var e=t.prototype;return e.refProperty=function(t){var e,n,i,r=this._properties;switch(t){default:case"position":case"scale":case"eulerAngles":i=null!==(e=r[t])&&void 0!==e?e:r[t]=new JH;break;case"rotation":i=null!==(n=r[t])&&void 0!==n?n:r[t]=new QH}return++i.refCount,i},e.deRefProperty=function(t){var e=this._properties,n=e[t];n&&(--n.refCount,n.refCount>0||delete e[t])},e.apply=function(t){var e,n,i,r=this._properties,o=r.position,a=r.scale,s=r.rotation,c=r.eulerAngles,l=!1,u=!1,h=!1,_=!1;o&&o.blendedWeight&&(l=!0,o.blendedWeight<1&&o.blend(t.position,1-o.blendedWeight),e=o.blendedValue),a&&a.blendedWeight&&(u=!0,a.blendedWeight<1&&a.blend(t.scale,1-a.blendedWeight),n=a.blendedValue),c&&c.blendedWeight&&(_=!0,c.blendedWeight<1&&c.blend(t.eulerAngles,1-c.blendedWeight),i=c.blendedValue),s&&s.blendedWeight&&(h=!0,s.blendedWeight<1&&s.blend(t.rotation,1-s.blendedWeight),i=s.blendedValue),(i||e||n)&&t.setRTS(i,e,n),l&&o.reset(),u&&a.reset(),h&&s.reset(),_&&c.reset()},N(t,[{key:"empty",get:function(){var t=this._properties;return!(t.position||t.rotation||t.eulerAngles||t.scale)}}]),t}(),$H=qc("cc.animation.StateMachineComponent")(UH=function(){function t(){}var e=t.prototype;return e.onMotionStateEnter=function(){},e.onMotionStateExit=function(){},e.onMotionStateUpdate=function(){},e.onStateMachineEnter=function(){},e.onStateMachineExit=function(){},t}())||UH,tj=function(){function t(t,e,n){var i=this;this._blendBuffer=new XH,this._currentTransitionCache={duration:0,time:0},this._varInstances={};for(var r,o=W(t.variables);!(r=o()).done;){var a=r.value,s=a[0],c=a[1],l=c.type,u=c.value;this._varInstances[s]=new Sj(l,u)}var h={controller:n,blendBuffer:this._blendBuffer,node:e,getVar:function(t){return i._varInstances[t]},triggerResetFn:function(t){i.setValue(t,!1)}};this._layerEvaluations=Array.from(t.layers).map((function(t){var e;return new ej(t,L({},h,{mask:null!==(e=t.mask)&&void 0!==e?e:void 0}))}))}var e=t.prototype;return e.update=function(t){for(var e,n=W(this._layerEvaluations);!(e=n()).done;)e.value.update(t);this._blendBuffer.apply()},e.getVariables=function(){return Object.entries(this._varInstances)},e.getCurrentStateStatus=function(t){return this._layerEvaluations[t].getCurrentStateStatus()},e.getCurrentClipStatuses=function(t){return this._layerEvaluations[t].getCurrentClipStatuses()},e.getCurrentTransition=function(t){var e=this._layerEvaluations,n=this._currentTransitionCache;return e[t].getCurrentTransition(n)?n:null},e.getNextStateStatus=function(t){return this._layerEvaluations[t].getNextStateStatus()},e.getNextClipStatuses=function(t){return this.getCurrentTransition(t),this._layerEvaluations[t].getNextClipStatuses()},e.getValue=function(t){var e=this._varInstances[t];return e?e.value:void 0},e.setValue=function(t,e){var n=this._varInstances[t];n&&(n.value=e)},t}(),ej=function(){function t(t,e){this._weight=void 0,this._nodes=[],this._topLevelEntry=void 0,this._topLevelExit=void 0,this._currentNode=void 0,this._currentTransitionToNode=null,this._currentTransitionPath=[],this._transitionProgress=0,this._fromWeight=0,this._toWeight=0,this._fromUpdated=!1,this._toUpdated=!1,this.name=t.name,this._controller=e.controller,this._weight=t.weight;var n=this._addStateMachine(t.stateMachine,null,L({},e),t.name),i=n.entry,r=n.exit;this._topLevelEntry=i,this._topLevelExit=r,this._currentNode=i,this._resetTrigger=e.triggerResetFn}var e=t.prototype;return e.update=function(t){this.exited||(this._fromWeight=1,this._toWeight=0,this._eval(t),this._sample())},e.getCurrentStateStatus=function(){var t=this._currentNode;return t.kind===HH.animation?t.getFromPortStatus():null},e.getCurrentClipStatuses=function(){var t=this._currentNode;return t.kind===HH.animation?t.getClipStatuses(this._fromWeight):ij},e.getCurrentTransition=function(t){var e=this._currentTransitionPath;if(0!==e.length){if(e[e.length-1].to.kind!==HH.animation)return!1;var n=e[0],i=n.duration,r=n.normalizedDuration,o=t.duration=r?i*(this._currentNode.kind===HH.animation?this._currentNode.duration:0):i;return t.time=this._transitionProgress*o,!0}return!1},e.getNextStateStatus=function(){return this._currentTransitionToNode,this._currentTransitionToNode.getToPortStatus()},e.getNextClipStatuses=function(){var t,e=this._currentTransitionPath,n=e[e.length-1].to;return n.kind,HH.animation,null!==(t=n.getClipStatuses(this._toWeight))&&void 0!==t?t:ij},e._addStateMachine=function(t,e,n,i){for(var r,o,a,s=this,c=Array.from(t.states()),l=c.map((function(e){return e instanceof rG?new uj(e,n):e===t.entryState?r=new xj(e,HH.entry,e.name):e===t.exitState?a=new xj(e,HH.exit,e.name):e===t.anyState?o=new xj(e,HH.any,e.name):null})),u={components:null,parent:e,entry:r,exit:a,any:o},h=0;h<c.length;++h){var _=l[h];_&&(_.stateMachine=u)}for(var f=c.map((function(t){if(t instanceof hG){var e=s._addStateMachine(t.stateMachine,u,n,i+"/"+t.name);return e.components=new lj(t),e}return null})),p=0;p<c.length;++p){var d=c[p],m=t.getOutgoings(d),v=[],g=void 0;g=d instanceof hG?f[p].exit:l[p];for(var y,x=function(){var t=y.value,e=t.to,i=c.findIndex((function(e){return e===t.to})),r={to:e instanceof hG?f[i].entry:l[i],conditions:t.conditions.map((function(t){return t[tV](n)})),duration:cG(t)?t.duration:0,normalizedDuration:!!cG(t)&&t.relativeDuration,exitConditionEnabled:!!cG(t)&&t.exitConditionEnabled,exitCondition:cG(t)?t.exitCondition:0,triggers:void 0};r.conditions.forEach((function(e,n){var i,o=t.conditions[n];o instanceof WH&&o.trigger&&(null!==(i=r.triggers)&&void 0!==i?i:r.triggers=[]).push(o.trigger)})),v.push(r)},S=W(m);!(y=S()).done;)x();g.outgoingTransitions=v}return u},e._eval=function(t){if(this.exited,mk("[Layer "+this.name+"]: UpdateStart "+t+"s"),this._continueDanglingTransition())return 0;for(var e=t,n=!0,i=0;n||e>0;){if(n=!1,100===i){b(14e3,100);break}if(++i,this._currentTransitionPath.length>0){if(e-=this._updateCurrentTransition(e),this._currentNode.kind===HH.exit)break;0===this._currentTransitionPath.length&&(n=!0)}else{var r=this._currentNode,o=this._matchCurrentNodeTransition(e);if(o){var a=o.transition,s=o.requires;if(dk("[SubStateMachine "+this.name+"]: CurrentNodeUpdate: "+r.name),e-=s,r.kind===HH.animation&&(r.updateFromPort(s),this._fromUpdated=!0),this._switchTo(a))break;n=!0}else dk("[SubStateMachine "+this.name+"]: CurrentNodeUpdate: "+r.name),r.kind===HH.animation&&(r.updateFromPort(e),this._fromUpdated=!0,e=0)}}return dk("[SubStateMachine "+this.name+"]: UpdateEnd"),this._fromUpdated&&this._currentNode.kind===HH.animation&&(this._fromUpdated=!1,this._currentNode.triggerFromPortUpdate(this._controller)),this._currentTransitionToNode&&this._toUpdated&&this._currentNode.kind===HH.animation&&(this._toUpdated=!1,this._currentTransitionToNode.triggerToPortUpdate(this._controller)),e},e._sample=function(){var t=this._currentNode,e=this._currentTransitionToNode,n=this._fromWeight;t.kind===HH.animation&&t.sampleFromPort(n),e&&e.kind===HH.animation&&e.sampleToPort(this._toWeight)},e._matchCurrentNodeTransition=function(t){var e=this._currentNode,n=1/0,i=null,r=this._matchTransition(e,e,t,aj);if(r&&(n=r.requires,i=r.transition),e.kind===HH.animation)for(var o=e.stateMachine;null!==o;o=o.parent){var a=this._matchTransition(o.any,e,t,sj);a&&a.requires<n&&(n=a.requires,i=a.transition)}return i?oj.set(i,n):null},e._matchTransition=function(t,e,n,i){t===e||(t.kind,HH.any);for(var r=t.outgoingTransitions,o=r.length,a=1/0,s=null,c=0;c<o;++c){var l=r[c],u=l.conditions,h=u.length;if(0===h){if(t.kind===HH.entry||t.kind===HH.exit)return i.set(l,0);if(!l.exitConditionEnabled)continue}var _=0;if(e.kind===HH.animation&&l.exitConditionEnabled){var f=e.duration*l.exitCondition;if((_=Math.max(f-e.fromPortTime,0))>n)continue}for(var p=!0,d=0;d<h;++d)if(!u[d].eval()){p=!1;break}if(p){if(0===_)return i.set(l,0);_<a&&(a=_,s=l)}}return s?i.set(s,a):null},e._switchTo=function(t){var e=this._currentNode;mk("[SubStateMachine "+this.name+"]: STARTED "+e.name+" -> "+t.to.name+".");var n=this._currentTransitionPath;this._consumeTransition(t),n.push(t);var i=this._matchTransitionPathUntilMotion();return!i||(this._doTransitionToMotion(i),!1)},e._continueDanglingTransition=function(){var t=this._currentTransitionPath,e=t.length;if(0===e)return!1;if(t[e-1].to.kind!==HH.animation){var n=this._matchTransitionPathUntilMotion();return!n||(this._doTransitionToMotion(n),!1)}return!1},e._matchTransitionPathUntilMotion=function(){for(var t=this._currentTransitionPath,e=t[t.length-1].to;e.kind!==HH.animation;){var n=this._matchTransition(e,e,0,oj);if(!n)break;var i=n.transition;this._consumeTransition(i),t.push(i),e=i.to}return e.kind===HH.animation?e:null},e._consumeTransition=function(t){var e=t.to;e.kind===HH.entry&&this._callEnterMethods(e)},e._resetTriggersAlongThePath=function(){for(var t=this._currentTransitionPath,e=t.length,n=0;n<e;++n){var i=t[n];this._resetTriggersOnTransition(i)}},e._doTransitionToMotion=function(t){this._resetTriggersAlongThePath(),this._transitionProgress=0,this._currentTransitionToNode=t,this._toUpdated=!1,t.resetToPort(),this._callEnterMethods(t)},e._updateCurrentTransition=function(t){var e,n=this._currentTransitionPath,i=this._currentTransitionToNode;n.length;var r=n[0],o=r.duration,a=r.normalizedDuration,s=this._currentNode,c=i,l=0,u=0;if(o<=0)l=0,u=1;else{s.kind,HH.animation;var h=this._transitionProgress,_=a?o*s.duration:o,f=h*_,p=_-f;l=Math.min(p,t),u=this._transitionProgress=(f+l)/_}var d=null!==(e=null==c?void 0:c.name)&&void 0!==e?e:"<Empty>",m=this._weight;mk("[SubStateMachine "+this.name+"]: TransitionUpdate: "+s.name+" -> "+d+"with ratio "+u+" in base weight "+this._weight+"."),this._fromWeight=m*(1-u),this._toWeight=m*u;var v=0!==l,g=1===u;if(s.kind===HH.animation&&v&&(mk("Update "+s.name),s.updateFromPort(l),this._fromUpdated=!0),c&&v&&(mk("Update "+c.name),c.updateToPort(l),this._toUpdated=!0),g){dk("[SubStateMachine "+this.name+"]: Transition finished:  "+s.name+" -> "+d+"."),this._callExitMethods(s);for(var y=this._currentTransitionPath,x=y.length,S=0;S<x;++S){var A=y[S].to;A.kind===HH.exit&&this._callExitMethods(A)}this._fromUpdated=this._toUpdated,this._toUpdated=!1,c.finishTransition(),this._currentNode=c,this._currentTransitionToNode=null,this._currentTransitionPath.length=0,this._fromWeight=1,this._toWeight=0}return l},e._resetTriggersOnTransition=function(t){var e=t.triggers;if(e)for(var n=e.length,i=0;i<n;++i){var r=e[i];this._resetTrigger(r)}},e._resetTrigger=function(t){(0,this._triggerReset)(t)},e._callEnterMethods=function(t){var e,n=this._controller;switch(t.kind){default:break;case HH.animation:t.components.callMotionStateEnterMethods(n,t.getToPortStatus());break;case HH.entry:null===(e=t.stateMachine.components)||void 0===e||e.callStateMachineEnterMethods(n)}},e._callExitMethods=function(t){var e,n=this._controller;switch(t.kind){default:break;case HH.animation:t.components.callMotionStateExitMethods(n,t.getFromPortStatus());break;case HH.exit:null===(e=t.stateMachine.components)||void 0===e||e.callStateMachineExitMethods(n)}},N(t,[{key:"exited",get:function(){return this._currentNode===this._topLevelExit}}]),t}(),nj=Object.freeze({next:function(){return{done:!0,value:void 0}}}),ij=Object.freeze(((kH={})[Symbol.iterator]=function(){return nj},kH)),rj=function(){function t(){this.transition=null,this.requires=0}return t.prototype.set=function(t,e){return this.transition=t,this.requires=e,this},t}(),oj=new rj,aj=new rj,sj=new rj;!function(t){t[t.entry=0]="entry",t[t.exit=1]="exit",t[t.any=2]="any",t[t.animation=3]="animation"}(HH||(HH={}));var cj=function(t){this.name=void 0,this.outgoingTransitions=[],this.name=t.name},lj=function(){function t(t){this._components=t.instantiateComponents()}var e=t.prototype;return e.callMotionStateEnterMethods=function(t,e){this._callMotionStateCallbackIfNonDefault("onMotionStateEnter",t,e)},e.callMotionStateUpdateMethods=function(t,e){this._callMotionStateCallbackIfNonDefault("onMotionStateUpdate",t,e)},e.callMotionStateExitMethods=function(t,e){this._callMotionStateCallbackIfNonDefault("onMotionStateExit",t,e)},e.callStateMachineEnterMethods=function(t){this._callStateMachineCallbackIfNonDefault("onStateMachineEnter",t)},e.callStateMachineExitMethods=function(t){this._callStateMachineCallbackIfNonDefault("onStateMachineExit",t)},e._callMotionStateCallbackIfNonDefault=function(t,e,n){for(var i=this._components,r=i.length,o=0;o<r;++o){var a=i[o];a[t]!==$H.prototype[t]&&a[t](e,n)}},e._callStateMachineCallbackIfNonDefault=function(t,e){for(var n=this._components,i=n.length,r=0;r<i;++r){var o=n[r];o[t]!==$H.prototype[t]&&o[t](e)}},t}(),uj=function(t){function e(e,n){var i,r,o;(o=t.call(this,e)||this).kind=HH.animation,o._source=null,o._speed=1,o._fromPort={progress:0,statusCache:{progress:0}},o._toPort={progress:0,statusCache:{progress:0}};var a=_V(n,e.speed,Jz.FLOAT,o._setSpeed,H(o));o._speed=a;var s=L({},n),c=null!==(i=null===(r=e.motion)||void 0===r?void 0:r[tV](s))&&void 0!==i?i:null;return c&&Object.defineProperty(c,"__DEBUG_ID__",{value:o.name}),o._source=c,o.components=new lj(e),o}F(e,t);var n=e.prototype;return n.updateFromPort=function(t){this._fromPort.progress=hj(this._fromPort.progress,this.duration,t*this._speed)},n.updateToPort=function(t){this._toPort.progress=hj(this._toPort.progress,this.duration,t*this._speed)},n.triggerFromPortUpdate=function(t){this.components.callMotionStateUpdateMethods(t,this.getFromPortStatus())},n.triggerToPortUpdate=function(t){this.components.callMotionStateUpdateMethods(t,this.getToPortStatus())},n.getFromPortStatus=function(){var t=this._fromPort.statusCache;return t.progress=_j(this._fromPort.progress),t},n.getToPortStatus=function(){var t=this._toPort.statusCache;return t.progress=_j(this._toPort.progress),t},n.resetToPort=function(){this._toPort.progress=0},n.finishTransition=function(){this._fromPort.progress=this._toPort.progress},n.sampleFromPort=function(t){var e;null===(e=this._source)||void 0===e||e.sample(this._fromPort.progress,t)},n.sampleToPort=function(t){var e;null===(e=this._source)||void 0===e||e.sample(this._toPort.progress,t)},n.getClipStatuses=function(t){var e,n=this._source;return n?((e={})[Symbol.iterator]=function(){return n.getClipStatuses(t)},e):ij},n._setSpeed=function(t){this._speed=t},N(e,[{key:"duration",get:function(){var t,e;return null!==(t=null===(e=this._source)||void 0===e?void 0:e.duration)&&void 0!==t?t:0}},{key:"fromPortTime",get:function(){return this._fromPort.progress*this.duration}}]),e}(cj);function hj(t,e,n){return 0===e?0:t+n/e}function _j(t){return t-Math.trunc(t)}var fj,pj,dj,mj,vj,gj,yj,xj=function(t){function e(e,n){var i;return(i=t.call(this,e)||this).kind=void 0,i.kind=n,i}return F(e,t),e}(cj),Sj=function(){function t(t,e){this.type=void 0,this._value=void 0,this._refs=[],this.type=t,this._value=e}return t.prototype.bind=function(t,e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return this._refs.push({fn:t,thisArg:e,args:i}),this._value},N(t,[{key:"value",get:function(){return this._value},set:function(t){this._value=t;for(var e,n=W(this._refs);!(e=n()).done;){var i=e.value,r=i.fn,o=i.thisArg,a=i.args;r.call.apply(r,[o,t].concat(a))}}}]),t}(),Aj=(fj=qc("cc.animation.AnimationController"),pj=rl(),dj=Jc(pG),fj(mj=pj((yj=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"graph",gj,H(e)),e._graphEval=null,e}F(e,t);var n=e.prototype;return n.start=function(){this.graph&&(this._graphEval=new tj(this.graph,this.node,this))},n.update=function(t){var e;null===(e=this._graphEval)||void 0===e||e.update(t)},n.getVariables=function(){return this._graphEval.getVariables()},n.setValue=function(t,e){this._graphEval.setValue(t,e)},n.getValue=function(t){return this._graphEval.getValue(t)},n.getCurrentStateStatus=function(t){return this._graphEval.getCurrentStateStatus(t)},n.getCurrentClipStatuses=function(t){return this._graphEval.getCurrentClipStatuses(t)},n.getCurrentTransition=function(t){return this._graphEval.getCurrentTransition(t)},n.getNextStateStatus=function(t){return this._graphEval.getNextStateStatus(t)},n.getNextClipStatuses=function(t){return this._graphEval.getNextClipStatuses(t)},e}(ku),gj=X((vj=yj).prototype,"graph",[dj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mj=vj))||mj)||mj);t("animation",Object.freeze({__proto__:null,UniformProxyFactory:hF,MorphWeightValueProxy:_F,MorphWeightsValueProxy:fF,MorphWeightsAllValueProxy:pF,Track:tz,TrackPath:ZF,RealTrack:rz,VectorTrack:vz,QuatTrack:Sz,ColorTrack:bz,SizeTrack:wz,ObjectTrack:Iz,isPropertyPath:GL,isCustomPath:function(t,e){return t instanceof e},HierarchyPath:lF,ComponentPath:uF,CubicSplineVec2Value:mF,CubicSplineVec3Value:vF,CubicSplineVec4Value:gF,CubicSplineQuatValue:yF,CubicSplineNumberValue:xF,AnimationController:Aj,get VariableType(){return Jz},StateMachineComponent:$H}));var Cj,bj,Tj,Ej=[],wj=new Map;function Pj(t,e){for(var n=0,i=Ei.IDENTITY;t;){if(t.stamp===e||t.stamp+1===e&&!t.node.hasChangedFlags){i=t.world,t.stamp=e;break}t.stamp=e,Ej[n++]=t,t=t.parent}for(;n>0;){t=Ej[--n],Ej[n]=null;var r=t.node;Ei.fromRTS(t.local,r.rotation,r.position,r.scale),i=Ei.multiply(t.world,i,t.local)}return i}function Ij(t){for(var e=wj.get(t.uuid)||null;e;)wj.delete(e.node.uuid),e=e.parent}var Rj=t("AnimationManager",qc((Tj=bj=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._anims=new Y([]),e._crossFades=new Y([]),e._delayEvents=[],e._blendStateBuffer=new XH,e._sockets=[],e}F(e,t);var n=e.prototype;return n.addCrossFade=function(t){-1===this._crossFades.array.indexOf(t)&&this._crossFades.push(t)},n.removeCrossFade=function(t){var e=this._crossFades.array.indexOf(t);e>=0?this._crossFades.fastRemoveAt(e):E(3907)},n.update=function(t){var e=this._delayEvents,n=this._crossFades,r=this._sockets,o=n.array;for(n.i=0;n.i<o.length;++n.i)o[n.i].update(t);var a=this._anims,s=a.array;for(a.i=0;a.i<s.length;++a.i){var c=s[a.i];c.isMotionless||c.update(t)}this._blendStateBuffer.apply();for(var l=i.director.getTotalFrames(),u=0,h=r.length;u<h;u++){var _=r[u],f=_.target,p=_.transform;f.matrix=Pj(p,l)}for(var d=0,m=e.length;d<m;d++){var v=e[d];v.fn.apply(v.thisArg,v.args)}e.length=0},n.destruct=function(){},n.addAnimation=function(t){-1===this._anims.array.indexOf(t)&&this._anims.push(t)},n.removeAnimation=function(t){var e=this._anims.array.indexOf(t);e>=0?this._anims.fastRemoveAt(e):E(3907)},n.pushDelayEvent=function(t,e,n){this._delayEvents.push({fn:t,thisArg:e,args:n})},n.addSockets=function(t,e){for(var n=this,i=function(i){var r=e[i];if(n._sockets.find((function(t){return t.target===r.target})))return"continue";var o=t.getChildByPath(r.path),a=r.target&&o&&function(t,e){for(var n,i=null,r=0;t!==e;){var o=t.uuid;if(wj.has(o)){i=wj.get(o);break}i={node:t,local:new Ei,world:new Ei,stamp:-1,parent:null},wj.set(o,i),Ej[r++]=i,t=t.parent,i=null}for(;r>0;)n=Ej[--r],Ej[r]=null,n.parent=i,i=n;return i}(o,t);a&&n._sockets.push({target:r.target,transform:a})},r=0;r<e.length;++r)i(r)},n.removeSockets=function(t,e){for(var n=0;n<e.length;++n)for(var i=e[n],r=0;r<this._sockets.length;++r){var o=this._sockets[r];if(o.target===i.target){Ij(o.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}},N(e,[{key:"blendState",get:function(){return this._blendStateBuffer}}]),e}(bM),bj.ID="animation",Cj=Tj))||Cj);LM.on(NM.EVENT_INIT,(function(){var t=new Rj;LM.registerSystem(Rj.ID,t,bM.Priority.HIGH)})),i.AnimationManager=Rj;var Dj,Bj,Mj,Oj,Nj,Lj,Fj,zj,Vj,Gj,Uj,kj,Hj,jj,Wj,qj,Xj,Yj=function(t){function e(e){var n;return(n=t.call(this)||this)._managedStates=[],n._fadings=[],n._scheduled=!1,n._scheduler=null!=e?e:i.director.getAnimationManager(),n}F(e,t);var n=e.prototype;return n.update=function(t){if(!this.isMotionless){var e=this._managedStates,n=this._fadings;if(1===e.length&&1===n.length){var i=e[0].state;i&&(i.weight=1)}else this._calculateWeights(t);1===e.length&&1===n.length&&this._unscheduleThis()}},n.crossFade=function(t,e){var n;0===this._managedStates.length&&(e=0),0===e&&this.clear();var i=this._managedStates.find((function(e){return e.state===t}));i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:t,reference:0},t&&t.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:e,easeTime:0,target:i}),this.isMotionless||this._scheduleThis()},n.clear=function(){for(var t=0;t<this._managedStates.length;++t){var e=this._managedStates[t].state;e&&e.stop()}this._managedStates.length=0,this._fadings.length=0},n.onPlay=function(){t.prototype.onPlay.call(this),this._scheduleThis()},n.onPause=function(){t.prototype.onPause.call(this);for(var e=0;e<this._managedStates.length;++e){var n=this._managedStates[e].state;n&&n.pause()}this._unscheduleThis()},n.onResume=function(){t.prototype.onResume.call(this);for(var e=0;e<this._managedStates.length;++e){var n=this._managedStates[e].state;n&&n.resume()}this._scheduleThis()},n.onStop=function(){t.prototype.onStop.call(this),this.clear()},n._calculateWeights=function(t){for(var e=this._managedStates,n=this._fadings,i=0;i<e.length;++i){var r=e[i].state;r&&(r.weight=0)}for(var o=1,a=n.length,s=0;s<n.length;++s){var c=n[s];c.easeTime+=t;var l=0===c.easeDuration?1:kn(c.easeTime/c.easeDuration),u=l*o;if(o*=1-l,c.target.state&&(c.target.state.weight+=u),c.easeTime>=c.easeDuration){a=s+1,c.easeTime=c.easeDuration;break}}if(a!==n.length){for(var h=a;h<n.length;++h){var _=n[h];--_.target.reference,_.target.reference<=0&&(_.target.state&&_.target.state.stop(),Q(this._managedStates,_.target))}n.splice(a)}},n._scheduleThis=function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)},n._unscheduleThis=function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)},e}(sk);function Kj(t,e){return t===e||!!t&&!!e&&t._uuid===e._uuid&&t._uuid}t("Animation",(Dj=qc("cc.Animation"),Bj=cl(),Mj=Yc(99),Oj=rl(),Nj=El([KU]),Lj=fl(),Fj=El(KU),zj=fl(),Vj=fl(),Gj=El([KU]),Dj(Uj=Bj(Uj=Mj(Uj=il(Uj=Oj((Xj=qj=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"playOnLoad",Hj,H(e)),e._crossFade=new Yj,e._nameToState=ft(!0),q(e,"_clips",jj,H(e)),q(e,"_defaultClip",Wj,H(e)),e._hasBeenPlayed=!1,e}F(e,t);var n=e.prototype;return n.onLoad=function(){for(var t in this.clips=this._clips,this._nameToState)this._nameToState[t].initialize(this.node)},n.start=function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)},n.onEnable=function(){this._crossFade.resume()},n.onDisable=function(){this._crossFade.pause()},n.onDestroy=function(){for(var t in this._crossFade.stop(),this._nameToState)this._nameToState[t].destroy();this._nameToState=ft(!0)},n.play=function(t){if(this._hasBeenPlayed=!0,!t){if(!this._defaultClip)return;t=this._defaultClip.name}this.crossFade(t,0)},n.crossFade=function(t,e){void 0===e&&(e=.3),this._hasBeenPlayed=!0;var n=this._nameToState[t];n&&this.doPlayOrCrossFade(n,e)},n.pause=function(){this._crossFade.pause()},n.resume=function(){this._crossFade.resume()},n.stop=function(){this._crossFade.stop()},n.getAnimationState=function(t){return this.getState(t)},n.getState=function(t){var e=this._nameToState[t];return e&&!e.curveLoaded&&e.initialize(this.node),e||null},n.createState=function(t,e){return e=e||t.name,this.removeState(e),this._doCreateState(t,e)},n.removeState=function(t){var e=this._nameToState[t];e&&(e.allowLastFrameEvent(!1),e.stop(),delete this._nameToState[t])},n.addClip=function(t,e){return $(this._clips,t)||this._clips.push(t),this.createState(t,e)},n.removeClip=function(t,e){var n;for(var i in this._nameToState){var r=this._nameToState[i];if(r.clip===t){n=r;break}}if(t===this._defaultClip){if(!e)return void b(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!e)return void b(3903);n.stop()}this._clips=this._clips.filter((function(e){return e!==t})),n&&delete this._nameToState[n.name]},n.on=function(e,n,i,r){var o=t.prototype.on.call(this,e,n,i,r);return e===ak.LASTFRAME&&this._syncAllowLastFrameEvent(),o},n.once=function(e,n,i){var r=t.prototype.once.call(this,e,n,i);return e===ak.LASTFRAME&&this._syncAllowLastFrameEvent(),r},n.off=function(e,n,i){t.prototype.off.call(this,e,n,i),e===ak.LASTFRAME&&this._syncDisallowLastFrameEvent()},n._createState=function(t,e){return new lk(t,e)},n._doCreateState=function(t,e){var n=this._createState(t,e);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(ak.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n},n.doPlayOrCrossFade=function(t,e){this._crossFade.play(),this._crossFade.crossFade(t,e)},n._removeStateOfAutomaticClip=function(t){for(var e in this._nameToState){var n=this._nameToState[e];Kj(t,n.clip)&&(n.stop(),delete this._nameToState[e])}},n._syncAllowLastFrameEvent=function(){if(this.hasEventListener(ak.LASTFRAME))for(var t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!0)},n._syncDisallowLastFrameEvent=function(){if(!this.hasEventListener(ak.LASTFRAME))for(var t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!1)},N(e,[{key:"clips",get:function(){return this._clips},set:function(t){var e=this;this._crossFade&&this._crossFade.clear();for(var n,i=W(this._clips);!(n=i()).done;){var r=n.value;r&&this._removeStateOfAutomaticClip(r)}for(var o,a=W(t);!(o=a()).done;){var s=o.value;s&&this.createState(s)}var c=t.find((function(t){return Kj(t,e._defaultClip)}));this._defaultClip=c||null,this._clips=t}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(t){this._defaultClip=t,t&&(this._clips.findIndex((function(e){return Kj(e,t)}))>=0||(this._clips.push(t),this.createState(t)))}}]),e}(sn(ku)),qj.EventType=ak,X((kj=Xj).prototype,"clips",[Nj,Lj],Object.getOwnPropertyDescriptor(kj.prototype,"clips"),kj.prototype),X(kj.prototype,"defaultClip",[Fj,zj],Object.getOwnPropertyDescriptor(kj.prototype,"defaultClip"),kj.prototype),Hj=X(kj.prototype,"playOnLoad",[Zc,Vj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jj=X(kj.prototype,"_clips",[Gj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Wj=X(kj.prototype,"_defaultClip",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Uj=kj))||Uj)||Uj)||Uj)||Uj)||Uj));var Jj,Qj,Zj,$j,tW=new Ei;i.easing=H_;var eW=t("HierachyModifier",qc("cc.HierachyModifier")(Jj=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(lF))||Jj);i.HierachyModifier=eW;var nW=t("ComponentModifier",qc("cc.ComponentModifier")(Qj=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(uF))||Qj);i.ComponentModifier=nW;var iW=t("CurveValueAdapter",qc("cc.CurveValueAdapter")(Zj=function(){function t(){}return t.prototype.forTarget=function(){return{set:function(){}}},t}())||Zj);i.CurveValueAdapter=iW;var rW=t("UniformCurveValueAdapter",qc("cc.UniformCurveValueAdapter")($j=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(hF))||$j);function oW(t){return"string"==typeof t}function aW(t){return"number"==typeof t}function sW(t,e){return t instanceof e}i.UniformCurveValueAdapter=rW,i.isPropertyModifier=oW,i.isElementModifier=aW,i.isCustomTargetModifier=sW,i.math=Gi,i.geometry=hp;var cW=t("NodePool",function(){function t(t){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=t,this._pool=[]}var e=t.prototype;return e.size=function(){return this._pool.length},e.clear=function(){for(var t=this._pool.length,e=0;e<t;++e)this._pool[e].destroy();this._pool.length=0},e.put=function(t){if(t&&-1===this._pool.indexOf(t)){t.removeFromParent();var e=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;e&&e.unuse&&e.unuse(),this._pool.push(t)}},e.get=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];var i=this._pool.length-1;if(i<0)return null;var r=this._pool[i];this._pool.length=i;var o=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return o&&o.reuse&&o.reuse(arguments),r},t}());i.NodePool=cW,i.renderer=zg;var lW,uW=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuDescriptorSet=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._layout=t.layout;var e=t.layout.gpuDescriptorSetLayout,n=e.bindings,i=e.descriptorIndices,r=e.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var t=this._gpuDescriptorSet.gpuDescriptors,e=0;e<t.length;++e)if(t[e].type&ia){var n=this._buffers[e];n&&(t[e].gpuBuffer=n.gpuBuffer||n.gpuBufferView)}else t[e].type&ra&&(this._textures[e]&&(t[e].gpuTexture=this._textures[e].gpuTexture),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}},N(e,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),e}(Ca);!function(t){t[t.RGBA16F_EXT=34842]="RGBA16F_EXT",t[t.RGB16F_EXT=34843]="RGB16F_EXT",t[t.RGBA32F_EXT=34836]="RGBA32F_EXT",t[t.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",t[t.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",t[t.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",t[t.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",t[t.SRGB_EXT=35904]="SRGB_EXT",t[t.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",t[t.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(lW||(lW={}));var hW=function(){function t(){}return t.setInstance=function(e){t._instance=e},N(t,null,[{key:"instance",get:function(){return t._instance}}]),t}();function _W(t,e){switch(t){case fr.R8:return e.UNSIGNED_BYTE;case fr.R8SN:return e.BYTE;case fr.R8UI:return e.UNSIGNED_BYTE;case fr.R8I:return e.BYTE;case fr.R16F:return lW.HALF_FLOAT_OES;case fr.R16UI:return e.UNSIGNED_SHORT;case fr.R16I:return e.SHORT;case fr.R32F:return e.FLOAT;case fr.R32UI:return e.UNSIGNED_INT;case fr.R32I:return e.INT;case fr.RG8:return e.UNSIGNED_BYTE;case fr.RG8SN:return e.BYTE;case fr.RG8UI:return e.UNSIGNED_BYTE;case fr.RG8I:return e.BYTE;case fr.RG16F:return lW.HALF_FLOAT_OES;case fr.RG16UI:return e.UNSIGNED_SHORT;case fr.RG16I:return e.SHORT;case fr.RG32F:return e.FLOAT;case fr.RG32UI:return e.UNSIGNED_INT;case fr.RG32I:return e.INT;case fr.RGB8:case fr.SRGB8:return e.UNSIGNED_BYTE;case fr.RGB8SN:return e.BYTE;case fr.RGB8UI:return e.UNSIGNED_BYTE;case fr.RGB8I:return e.BYTE;case fr.RGB16F:return lW.HALF_FLOAT_OES;case fr.RGB16UI:return e.UNSIGNED_SHORT;case fr.RGB16I:return e.SHORT;case fr.RGB32F:return e.FLOAT;case fr.RGB32UI:return e.UNSIGNED_INT;case fr.RGB32I:return e.INT;case fr.BGRA8:case fr.RGBA8:case fr.SRGB8_A8:return e.UNSIGNED_BYTE;case fr.RGBA8SN:return e.BYTE;case fr.RGBA8UI:return e.UNSIGNED_BYTE;case fr.RGBA8I:return e.BYTE;case fr.RGBA16F:return lW.HALF_FLOAT_OES;case fr.RGBA16UI:return e.UNSIGNED_SHORT;case fr.RGBA16I:return e.SHORT;case fr.RGBA32F:return e.FLOAT;case fr.RGBA32UI:return e.UNSIGNED_INT;case fr.RGBA32I:return e.INT;case fr.R5G6B5:return e.UNSIGNED_SHORT_5_6_5;case fr.R11G11B10F:return e.FLOAT;case fr.RGB5A1:return e.UNSIGNED_SHORT_5_5_5_1;case fr.RGBA4:return e.UNSIGNED_SHORT_4_4_4_4;case fr.RGB10A2:return e.UNSIGNED_BYTE;case fr.RGB10A2UI:return e.UNSIGNED_INT;case fr.RGB9E5:return e.UNSIGNED_BYTE;case fr.DEPTH:return e.UNSIGNED_INT;case fr.DEPTH_STENCIL:return lW.UNSIGNED_INT_24_8_WEBGL;case fr.BC1:case fr.BC1_SRGB:case fr.BC2:case fr.BC2_SRGB:case fr.BC3:case fr.BC3_SRGB:case fr.BC4:return e.UNSIGNED_BYTE;case fr.BC4_SNORM:return e.BYTE;case fr.BC5:return e.UNSIGNED_BYTE;case fr.BC5_SNORM:return e.BYTE;case fr.BC6H_SF16:case fr.BC6H_UF16:return e.FLOAT;case fr.BC7:case fr.BC7_SRGB:case fr.ETC_RGB8:case fr.ETC2_RGB8:case fr.ETC2_SRGB8:case fr.ETC2_RGB8_A1:case fr.ETC2_SRGB8_A1:case fr.EAC_R11:return e.UNSIGNED_BYTE;case fr.EAC_R11SN:return e.BYTE;case fr.EAC_RG11:return e.UNSIGNED_BYTE;case fr.EAC_RG11SN:return e.BYTE;case fr.PVRTC_RGB2:case fr.PVRTC_RGBA2:case fr.PVRTC_RGB4:case fr.PVRTC_RGBA4:case fr.PVRTC2_2BPP:case fr.PVRTC2_4BPP:return e.UNSIGNED_BYTE;case fr.ASTC_RGBA_4X4:case fr.ASTC_RGBA_5X4:case fr.ASTC_RGBA_5X5:case fr.ASTC_RGBA_6X5:case fr.ASTC_RGBA_6X6:case fr.ASTC_RGBA_8X5:case fr.ASTC_RGBA_8X6:case fr.ASTC_RGBA_8X8:case fr.ASTC_RGBA_10X5:case fr.ASTC_RGBA_10X6:case fr.ASTC_RGBA_10X8:case fr.ASTC_RGBA_10X10:case fr.ASTC_RGBA_12X10:case fr.ASTC_RGBA_12X12:case fr.ASTC_SRGBA_4X4:case fr.ASTC_SRGBA_5X4:case fr.ASTC_SRGBA_5X5:case fr.ASTC_SRGBA_6X5:case fr.ASTC_SRGBA_6X6:case fr.ASTC_SRGBA_8X5:case fr.ASTC_SRGBA_8X6:case fr.ASTC_SRGBA_8X8:case fr.ASTC_SRGBA_10X5:case fr.ASTC_SRGBA_10X6:case fr.ASTC_SRGBA_10X8:case fr.ASTC_SRGBA_10X10:case fr.ASTC_SRGBA_12X10:case fr.ASTC_SRGBA_12X12:default:return e.UNSIGNED_BYTE}}function fW(t,e){switch(t){case dr.BOOL:return e.BOOL;case dr.BOOL2:return e.BOOL_VEC2;case dr.BOOL3:return e.BOOL_VEC3;case dr.BOOL4:return e.BOOL_VEC4;case dr.INT:return e.INT;case dr.INT2:return e.INT_VEC2;case dr.INT3:return e.INT_VEC3;case dr.INT4:return e.INT_VEC4;case dr.UINT:return e.UNSIGNED_INT;case dr.FLOAT:return e.FLOAT;case dr.FLOAT2:return e.FLOAT_VEC2;case dr.FLOAT3:return e.FLOAT_VEC3;case dr.FLOAT4:return e.FLOAT_VEC4;case dr.MAT2:return e.FLOAT_MAT2;case dr.MAT3:return e.FLOAT_MAT3;case dr.MAT4:return e.FLOAT_MAT4;case dr.SAMPLER2D:return e.SAMPLER_2D;case dr.SAMPLER_CUBE:return e.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),dr.UNKNOWN}}function pW(t){switch(t){case dr.BOOL:case dr.BOOL2:case dr.BOOL3:case dr.BOOL4:case dr.INT:case dr.INT2:case dr.INT3:case dr.INT4:case dr.UINT:return Int32Array;case dr.FLOAT:case dr.FLOAT2:case dr.FLOAT3:case dr.FLOAT4:case dr.MAT2:case dr.MAT3:case dr.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function dW(t,e){switch(t){case e.BOOL:return dr.BOOL;case e.BOOL_VEC2:return dr.BOOL2;case e.BOOL_VEC3:return dr.BOOL3;case e.BOOL_VEC4:return dr.BOOL4;case e.INT:return dr.INT;case e.INT_VEC2:return dr.INT2;case e.INT_VEC3:return dr.INT3;case e.INT_VEC4:return dr.INT4;case e.UNSIGNED_INT:return dr.UINT;case e.FLOAT:return dr.FLOAT;case e.FLOAT_VEC2:return dr.FLOAT2;case e.FLOAT_VEC3:return dr.FLOAT3;case e.FLOAT_VEC4:return dr.FLOAT4;case e.FLOAT_MAT2:return dr.MAT2;case e.FLOAT_MAT3:return dr.MAT3;case e.FLOAT_MAT4:return dr.MAT4;case e.SAMPLER_2D:return dr.SAMPLER2D;case e.SAMPLER_CUBE:return dr.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),dr.UNKNOWN}}function mW(t,e){switch(t){case e.BOOL:return 4;case e.BOOL_VEC2:return 8;case e.BOOL_VEC3:return 12;case e.BOOL_VEC4:return 16;case e.INT:return 4;case e.INT_VEC2:return 8;case e.INT_VEC3:return 12;case e.INT_VEC4:return 16;case e.UNSIGNED_INT:case e.FLOAT:return 4;case e.FLOAT_VEC2:return 8;case e.FLOAT_VEC3:return 12;case e.FLOAT_VEC4:case e.FLOAT_MAT2:return 16;case e.FLOAT_MAT3:return 36;case e.FLOAT_MAT4:return 64;case e.SAMPLER_2D:case e.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function vW(t,e){switch(t){case e.FLOAT_MAT2:return 2;case e.FLOAT_MAT3:return 3;case e.FLOAT_MAT4:return 4;default:return 1}}hW._instance=null;var gW,yW=[512,513,514,515,516,517,518,519],xW=[0,7680,7681,7682,7683,5386,34055,34056],SW=[32774,32778,32779,32775,32776],AW=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(t){t[t.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",t[t.END_RENDER_PASS=1]="END_RENDER_PASS",t[t.BIND_STATES=2]="BIND_STATES",t[t.DRAW=3]="DRAW",t[t.UPDATE_BUFFER=4]="UPDATE_BUFFER",t[t.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",t[t.COUNT=6]="COUNT"}(gW||(gW={}));var CW=function(t){this.cmdType=void 0,this.refCount=0,this.cmdType=t},bW=function(t){function e(){var e;return(e=t.call(this,gW.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea=new no,e.clearFlag=Yr.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return F(e,t),e.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},e}(CW),TW=function(t){function e(){var e;return(e=t.call(this,gW.BIND_STATES)||this).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.dynamicStates=new ta,e}return F(e,t),e.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},e}(CW),EW=function(t){function e(){var e;return(e=t.call(this,gW.DRAW)||this).drawInfo=new vo,e}return F(e,t),e.prototype.clear=function(){},e}(CW),wW=function(t){function e(){var e;return(e=t.call(this,gW.UPDATE_BUFFER)||this).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return F(e,t),e.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},e}(CW),PW=function(t){function e(){var e;return(e=t.call(this,gW.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,e.buffers=[],e.regions=[],e}return F(e,t),e.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},e}(CW),IW=function(){function t(){this.cmds=new Xt(1),this.beginRenderPassCmds=new Xt(1),this.bindStatesCmds=new Xt(1),this.drawCmds=new Xt(1),this.updateBufferCmds=new Xt(1),this.copyBufferToTextureCmds=new Xt(1)}return t.prototype.clearCmds=function(t){this.beginRenderPassCmds.length&&(t.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(t.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(t.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(t.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(t.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},t}();function RW(t,e,n,i,r){if(e.usage&mr.UNIFORM)ArrayBuffer.isView(n)?e.vf32.set(n,i/Float32Array.BYTES_PER_ELEMENT):e.vf32.set(new Float32Array(n),i/Float32Array.BYTES_PER_ELEMENT);else if(e.usage&mr.INDIRECT){e.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)e.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=t.gl,l=t.stateCache;switch(e.glTarget){case c.ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),DW.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer);break;case c.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),DW.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===s.byteLength?c.bufferSubData(e.glTarget,i,s):c.bufferSubData(e.glTarget,i,s.slice(0,r))}}var DW={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function BW(t,e,n,i,r,o,a){var s=t.gl,c=t.stateCache,l=0;if(n&&e){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height);var u=r.length;t.extensions.WEBGL_draw_buffers||(u=1);for(var h=0;h<u;++h){var _=e.colorAttachments[h];if(_.format!==fr.UNKNOWN)switch(_.loadOp){case Mr.LOAD:break;case Mr.CLEAR:c.bs.targets[0].blendColorMask!==Dr.ALL&&s.colorMask(!0,!0,!0,!0);var f=r[0];s.clearColor(f.x,f.y,f.z,f.w),l|=s.COLOR_BUFFER_BIT;break;case Mr.DISCARD:}}if(e.depthStencilAttachment&&e.depthStencilAttachment.format!==fr.UNKNOWN){switch(e.depthStencilAttachment.depthLoadOp){case Mr.LOAD:break;case Mr.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case Mr.DISCARD:}if(na[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case Mr.LOAD:break;case Mr.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case Mr.DISCARD:}}if(l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var p=c.bs.targets[0].blendColorMask;if(p!==Dr.ALL){var d=(p&Dr.R)!==Dr.NONE,m=(p&Dr.G)!==Dr.NONE,v=(p&Dr.B)!==Dr.NONE,g=(p&Dr.A)!==Dr.NONE;s.colorMask(d,m,v,g)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function MW(t,e,n,i,r,o){var a,s,c,l=t.gl,u=t.stateCache,h=e&&e.gpuShader,_=!1;if(e&&DW.gpuPipelineState!==e){if(DW.gpuPipelineState=e,DW.glPrimitive=e.glPrimitive,e.gpuShader){var f=e.gpuShader.glProgram;u.glProgram!==f&&(l.useProgram(f),u.glProgram=f,_=!0)}var p=e.rs;if(p){if(u.rs.cullMode!==p.cullMode){switch(p.cullMode){case Ur.NONE:l.disable(l.CULL_FACE);break;case Ur.FRONT:l.enable(l.CULL_FACE),l.cullFace(l.FRONT);break;case Ur.BACK:l.enable(l.CULL_FACE),l.cullFace(l.BACK)}u.rs.cullMode=p.cullMode}var m=p.isFrontFaceCCW;u.rs.isFrontFaceCCW!==m&&(l.frontFace(m?l.CCW:l.CW),u.rs.isFrontFaceCCW=m),u.rs.depthBias===p.depthBias&&u.rs.depthBiasSlop===p.depthBiasSlop||(l.polygonOffset(p.depthBias,p.depthBiasSlop),u.rs.depthBias=p.depthBias,u.rs.depthBiasSlop=p.depthBiasSlop),u.rs.lineWidth!==p.lineWidth&&(l.lineWidth(p.lineWidth),u.rs.lineWidth=p.lineWidth)}var v=e.dss;v&&(u.dss.depthTest!==v.depthTest&&(v.depthTest?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),u.dss.depthTest=v.depthTest),u.dss.depthWrite!==v.depthWrite&&(l.depthMask(v.depthWrite),u.dss.depthWrite=v.depthWrite),u.dss.depthFunc!==v.depthFunc&&(l.depthFunc(yW[v.depthFunc]),u.dss.depthFunc=v.depthFunc),u.dss.stencilTestFront===v.stencilTestFront&&u.dss.stencilTestBack===v.stencilTestBack||(v.stencilTestFront||v.stencilTestBack?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),u.dss.stencilTestFront=v.stencilTestFront,u.dss.stencilTestBack=v.stencilTestBack),u.dss.stencilFuncFront===v.stencilFuncFront&&u.dss.stencilRefFront===v.stencilRefFront&&u.dss.stencilReadMaskFront===v.stencilReadMaskFront||(l.stencilFuncSeparate(l.FRONT,yW[v.stencilFuncFront],v.stencilRefFront,v.stencilReadMaskFront),u.dss.stencilFuncFront=v.stencilFuncFront,u.dss.stencilRefFront=v.stencilRefFront,u.dss.stencilReadMaskFront=v.stencilReadMaskFront),u.dss.stencilFailOpFront===v.stencilFailOpFront&&u.dss.stencilZFailOpFront===v.stencilZFailOpFront&&u.dss.stencilPassOpFront===v.stencilPassOpFront||(l.stencilOpSeparate(l.FRONT,xW[v.stencilFailOpFront],xW[v.stencilZFailOpFront],xW[v.stencilPassOpFront]),u.dss.stencilFailOpFront=v.stencilFailOpFront,u.dss.stencilZFailOpFront=v.stencilZFailOpFront,u.dss.stencilPassOpFront=v.stencilPassOpFront),u.dss.stencilWriteMaskFront!==v.stencilWriteMaskFront&&(l.stencilMaskSeparate(l.FRONT,v.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=v.stencilWriteMaskFront),u.dss.stencilFuncBack===v.stencilFuncBack&&u.dss.stencilRefBack===v.stencilRefBack&&u.dss.stencilReadMaskBack===v.stencilReadMaskBack||(l.stencilFuncSeparate(l.BACK,yW[v.stencilFuncBack],v.stencilRefBack,v.stencilReadMaskBack),u.dss.stencilFuncBack=v.stencilFuncBack,u.dss.stencilRefBack=v.stencilRefBack,u.dss.stencilReadMaskBack=v.stencilReadMaskBack),u.dss.stencilFailOpBack===v.stencilFailOpBack&&u.dss.stencilZFailOpBack===v.stencilZFailOpBack&&u.dss.stencilPassOpBack===v.stencilPassOpBack||(l.stencilOpSeparate(l.BACK,xW[v.stencilFailOpBack],xW[v.stencilZFailOpBack],xW[v.stencilPassOpBack]),u.dss.stencilFailOpBack=v.stencilFailOpBack,u.dss.stencilZFailOpBack=v.stencilZFailOpBack,u.dss.stencilPassOpBack=v.stencilPassOpBack),u.dss.stencilWriteMaskBack!==v.stencilWriteMaskBack&&(l.stencilMaskSeparate(l.BACK,v.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=v.stencilWriteMaskBack));var g=e.bs;if(g){u.bs.isA2C!==g.isA2C&&(g.isA2C?l.enable(l.SAMPLE_ALPHA_TO_COVERAGE):l.disable(l.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=g.isA2C),u.bs.blendColor.x===g.blendColor.x&&u.bs.blendColor.y===g.blendColor.y&&u.bs.blendColor.z===g.blendColor.z&&u.bs.blendColor.w===g.blendColor.w||(l.blendColor(g.blendColor.x,g.blendColor.y,g.blendColor.z,g.blendColor.w),u.bs.blendColor.x=g.blendColor.x,u.bs.blendColor.y=g.blendColor.y,u.bs.blendColor.z=g.blendColor.z,u.bs.blendColor.w=g.blendColor.w);var y=g.targets[0],x=u.bs.targets[0];x.blend!==y.blend&&(y.blend?l.enable(l.BLEND):l.disable(l.BLEND),x.blend=y.blend),x.blendEq===y.blendEq&&x.blendAlphaEq===y.blendAlphaEq||(l.blendEquationSeparate(SW[y.blendEq],SW[y.blendAlphaEq]),x.blendEq=y.blendEq,x.blendAlphaEq=y.blendAlphaEq),x.blendSrc===y.blendSrc&&x.blendDst===y.blendDst&&x.blendSrcAlpha===y.blendSrcAlpha&&x.blendDstAlpha===y.blendDstAlpha||(l.blendFuncSeparate(AW[y.blendSrc],AW[y.blendDst],AW[y.blendSrcAlpha],AW[y.blendDstAlpha]),x.blendSrc=y.blendSrc,x.blendDst=y.blendDst,x.blendSrcAlpha=y.blendSrcAlpha,x.blendDstAlpha=y.blendDstAlpha),x.blendColorMask!==y.blendColorMask&&(l.colorMask((y.blendColorMask&Dr.R)!==Dr.NONE,(y.blendColorMask&Dr.G)!==Dr.NONE,(y.blendColorMask&Dr.B)!==Dr.NONE,(y.blendColorMask&Dr.A)!==Dr.NONE),x.blendColorMask=y.blendColorMask)}}if(e&&e.gpuPipelineLayout&&h){for(var S=h.glBlocks.length,A=e.gpuPipelineLayout.dynamicOffsetIndices,C=0;C<S;C++){var b=h.glBlocks[C],T=i[b.set],E=T&&T.descriptorIndices[b.binding],w=E>=0&&T.gpuDescriptors[E],P=null,I=0;if(w&&w.gpuBuffer){var R=w.gpuBuffer,D=A[b.set],B=D&&D[b.binding];B>=0&&(I=r[B]),"vf32"in R?P=R.vf32:(I+=R.offset,P=R.gpuBuffer.vf32),I>>=2}if(P)for(var M=b.glActiveUniforms.length,O=0;O<M;O++){var N=b.glActiveUniforms[O];switch(N.glType){case l.BOOL:case l.INT:for(var L=0;L<N.array.length;++L){var F=N.offset+I+L;if(P[F]!==N.array[L]){for(var z=L,V=F;z<N.array.length;++z,++V)N.array[z]=P[V];l.uniform1iv(N.glLoc,N.array);break}}break;case l.BOOL_VEC2:case l.INT_VEC2:for(var G=0;G<N.array.length;++G){var U=N.offset+I+G;if(P[U]!==N.array[G]){for(var k=G,H=U;k<N.array.length;++k,++H)N.array[k]=P[H];l.uniform2iv(N.glLoc,N.array);break}}break;case l.BOOL_VEC3:case l.INT_VEC3:for(var j=0;j<N.array.length;++j){var W=N.offset+I+j;if(P[W]!==N.array[j]){for(var q=j,X=W;q<N.array.length;++q,++X)N.array[q]=P[X];l.uniform3iv(N.glLoc,N.array);break}}break;case l.BOOL_VEC4:case l.INT_VEC4:for(var Y=0;Y<N.array.length;++Y){var K=N.offset+I+Y;if(P[K]!==N.array[Y]){for(var J=Y,Q=K;J<N.array.length;++J,++Q)N.array[J]=P[Q];l.uniform4iv(N.glLoc,N.array);break}}break;case l.FLOAT:for(var Z=0;Z<N.array.length;++Z){var $=N.offset+I+Z;if(P[$]!==N.array[Z]){for(var tt=Z,et=$;tt<N.array.length;++tt,++et)N.array[tt]=P[et];l.uniform1fv(N.glLoc,N.array);break}}break;case l.FLOAT_VEC2:for(var nt=0;nt<N.array.length;++nt){var it=N.offset+I+nt;if(P[it]!==N.array[nt]){for(var rt=nt,ot=it;rt<N.array.length;++rt,++ot)N.array[rt]=P[ot];l.uniform2fv(N.glLoc,N.array);break}}break;case l.FLOAT_VEC3:for(var at=0;at<N.array.length;++at){var st=N.offset+I+at;if(P[st]!==N.array[at]){for(var ct=at,lt=st;ct<N.array.length;++ct,++lt)N.array[ct]=P[lt];l.uniform3fv(N.glLoc,N.array);break}}break;case l.FLOAT_VEC4:for(var ut=0;ut<N.array.length;++ut){var ht=N.offset+I+ut;if(P[ht]!==N.array[ut]){for(var _t=ut,ft=ht;_t<N.array.length;++_t,++ft)N.array[_t]=P[ft];l.uniform4fv(N.glLoc,N.array);break}}break;case l.FLOAT_MAT2:for(var pt=0;pt<N.array.length;++pt){var dt=N.offset+I+pt;if(P[dt]!==N.array[pt]){for(var mt=pt,vt=dt;mt<N.array.length;++mt,++vt)N.array[mt]=P[vt];l.uniformMatrix2fv(N.glLoc,!1,N.array);break}}break;case l.FLOAT_MAT3:for(var gt=0;gt<N.array.length;++gt){var yt=N.offset+I+gt;if(P[yt]!==N.array[gt]){for(var xt=gt,St=yt;xt<N.array.length;++xt,++St)N.array[xt]=P[St];l.uniformMatrix3fv(N.glLoc,!1,N.array);break}}break;case l.FLOAT_MAT4:for(var At=0;At<N.array.length;++At){var Ct=N.offset+I+At;if(P[Ct]!==N.array[At]){for(var bt=At,Tt=Ct;bt<N.array.length;++bt,++Tt)N.array[bt]=P[Tt];l.uniformMatrix4fv(N.glLoc,!1,N.array);break}}}}else d("Buffer binding '"+b.name+"' at set "+b.set+" binding "+b.binding+" is not bounded")}for(var Et=h.glSamplerTextures.length,wt=0;wt<Et;wt++)for(var Pt=h.glSamplerTextures[wt],It=i[Pt.set],Rt=It&&It.descriptorIndices[Pt.binding],Dt=Rt>=0&&It.gpuDescriptors[Rt],Bt=Pt.units.length,Mt=0;Mt<Bt;Mt++){var Ot=Pt.units[Mt];if(Dt&&Dt.gpuSampler){if(Dt.gpuTexture&&Dt.gpuTexture.size>0){var Nt=Dt.gpuTexture,Lt=u.glTexUnits[Ot];Lt.glTexture!==Nt.glTexture&&(u.texUnit!==Ot&&(l.activeTexture(l.TEXTURE0+Ot),u.texUnit=Ot),Nt.glTexture?l.bindTexture(Nt.glTarget,Nt.glTexture):l.bindTexture(Nt.glTarget,t.nullTex2D.gpuTexture.glTexture),Lt.glTexture=Nt.glTexture);var Ft=Dt.gpuSampler;Nt.isPowerOf2?(a=Ft.glWrapS,s=Ft.glWrapT):(a=l.CLAMP_TO_EDGE,s=l.CLAMP_TO_EDGE),c=Nt.isPowerOf2?Nt.mipLevel<=1&&(Ft.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Ft.glMinFilter===l.LINEAR_MIPMAP_LINEAR)?l.LINEAR:Ft.glMinFilter:Ft.glMinFilter===l.LINEAR||Ft.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Ft.glMinFilter===l.LINEAR_MIPMAP_LINEAR?l.LINEAR:l.NEAREST,Nt.glWrapS!==a&&(u.texUnit!==Ot&&(l.activeTexture(l.TEXTURE0+Ot),u.texUnit=Ot),l.texParameteri(Nt.glTarget,l.TEXTURE_WRAP_S,a),Nt.glWrapS=a),Nt.glWrapT!==s&&(u.texUnit!==Ot&&(l.activeTexture(l.TEXTURE0+Ot),u.texUnit=Ot),l.texParameteri(Nt.glTarget,l.TEXTURE_WRAP_T,s),Nt.glWrapT=s),Nt.glMinFilter!==c&&(u.texUnit!==Ot&&(l.activeTexture(l.TEXTURE0+Ot),u.texUnit=Ot),l.texParameteri(Nt.glTarget,l.TEXTURE_MIN_FILTER,c),Nt.glMinFilter=c),Nt.glMagFilter!==Ft.glMagFilter&&(u.texUnit!==Ot&&(l.activeTexture(l.TEXTURE0+Ot),u.texUnit=Ot),l.texParameteri(Nt.glTarget,l.TEXTURE_MAG_FILTER,Ft.glMagFilter),Nt.glMagFilter=Ft.glMagFilter)}Dt=It.gpuDescriptors[++Rt]}else d("Sampler binding '"+Pt.name+"' at set "+Pt.set+" binding "+Pt.binding+" index "+Mt+" is not bounded")}}if(n&&h&&(_||DW.gpuInputAssembler!==n)){DW.gpuInputAssembler=n;var zt=t.extensions.ANGLE_instanced_arrays;if(t.extensions.useVAO){var Vt=t.extensions.OES_vertex_array_object,Gt=n.glVAOs.get(h.glProgram);if(!Gt){var Ut;Gt=Vt.createVertexArrayOES(),n.glVAOs.set(h.glProgram,Gt),Vt.bindVertexArrayOES(Gt),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var kt=h.glInputs.length,Ht=0;Ht<kt;Ht++){var jt=h.glInputs[Ht];Ut=null;for(var Wt=n.glAttribs.length,qt=0;qt<Wt;qt++){var Xt=n.glAttribs[qt];if(Xt.name===jt.name){Ut=Xt;break}}if(Ut){u.glArrayBuffer!==Ut.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,Ut.glBuffer),u.glArrayBuffer=Ut.glBuffer);for(var Yt=0;Yt<Ut.componentCount;++Yt){var Kt=jt.glLoc+Yt,Jt=Ut.offset+Ut.size*Yt;l.enableVertexAttribArray(Kt),u.glCurrentAttribLocs[Kt]=!0,l.vertexAttribPointer(Kt,Ut.count,Ut.glType,Ut.isNormalized,Ut.stride,Jt),zt&&zt.vertexAttribDivisorANGLE(Kt,Ut.isInstanced?1:0)}}}var Qt=n.gpuIndexBuffer;Qt&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,Qt.glBuffer),Vt.bindVertexArrayOES(null),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==Gt&&(Vt.bindVertexArrayOES(Gt),u.glVAO=Gt)}else{for(var Zt=0;Zt<t.capabilities.maxVertexAttributes;++Zt)u.glCurrentAttribLocs[Zt]=!1;for(var $t=h.glInputs.length,te=0;te<$t;te++){for(var ee=h.glInputs[te],ne=null,ie=n.glAttribs.length,re=0;re<ie;re++){var oe=n.glAttribs[re];if(oe.name===ee.name){ne=oe;break}}if(ne){u.glArrayBuffer!==ne.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,ne.glBuffer),u.glArrayBuffer=ne.glBuffer);for(var ae=0;ae<ne.componentCount;++ae){var se=ee.glLoc+ae,ce=ne.offset+ne.size*ae;!u.glEnabledAttribLocs[se]&&se>=0&&(l.enableVertexAttribArray(se),u.glEnabledAttribLocs[se]=!0),u.glCurrentAttribLocs[se]=!0,l.vertexAttribPointer(se,ne.count,ne.glType,ne.isNormalized,ne.stride,ce),zt&&zt.vertexAttribDivisorANGLE(se,ne.isInstanced?1:0)}}}var le=n.gpuIndexBuffer;le&&u.glElementArrayBuffer!==le.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,le.glBuffer),u.glElementArrayBuffer=le.glBuffer);for(var ue=0;ue<t.capabilities.maxVertexAttributes;++ue)u.glEnabledAttribLocs[ue]!==u.glCurrentAttribLocs[ue]&&(l.disableVertexAttribArray(ue),u.glEnabledAttribLocs[ue]=!1)}}if(e&&e.dynamicStates.length)for(var he=e.dynamicStates.length,_e=0;_e<he;_e++)switch(e.dynamicStates[_e]){case kr.LINE_WIDTH:u.rs.lineWidth!==o.lineWidth&&(l.lineWidth(o.lineWidth),u.rs.lineWidth=o.lineWidth);break;case kr.DEPTH_BIAS:u.rs.depthBias===o.depthBiasConstant&&u.rs.depthBiasSlop===o.depthBiasSlope||(l.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),u.rs.depthBias=o.depthBiasConstant,u.rs.depthBiasSlop=o.depthBiasSlope);break;case kr.BLEND_CONSTANTS:var fe=o.blendConstant;u.bs.blendColor.x===fe.x&&u.bs.blendColor.y===fe.y&&u.bs.blendColor.z===fe.z&&u.bs.blendColor.w===fe.w||(l.blendColor(fe.x,fe.y,fe.z,fe.w),u.bs.blendColor.copy(fe));break;case kr.STENCIL_WRITE_MASK:var pe=o.stencilStatesFront,de=o.stencilStatesBack;u.dss.stencilWriteMaskFront!==pe.writeMask&&(l.stencilMaskSeparate(l.FRONT,pe.writeMask),u.dss.stencilWriteMaskFront=pe.writeMask),u.dss.stencilWriteMaskBack!==de.writeMask&&(l.stencilMaskSeparate(l.BACK,de.writeMask),u.dss.stencilWriteMaskBack=de.writeMask);break;case kr.STENCIL_COMPARE_MASK:var me=o.stencilStatesFront,ve=o.stencilStatesBack;u.dss.stencilRefFront===me.reference&&u.dss.stencilReadMaskFront===me.compareMask||(l.stencilFuncSeparate(l.FRONT,yW[u.dss.stencilFuncFront],me.reference,me.compareMask),u.dss.stencilRefFront=me.reference,u.dss.stencilReadMaskFront=me.compareMask),u.dss.stencilRefBack===ve.reference&&u.dss.stencilReadMaskBack===ve.compareMask||(l.stencilFuncSeparate(l.BACK,yW[u.dss.stencilFuncBack],ve.reference,ve.compareMask),u.dss.stencilRefBack=ve.reference,u.dss.stencilReadMaskBack=ve.compareMask)}}function OW(t,e){var n=t.gl,i=t.extensions,r=i.ANGLE_instanced_arrays,o=i.WEBGL_multi_draw,a=DW.gpuInputAssembler,s=DW.glPrimitive;if(a){var c=a.gpuIndexBuffer;if(a.gpuIndirectBuffer){var l=a.gpuIndirectBuffer.indirects;if(l.drawByIndex){for(var u=0;u<l.drawCount;u++)l.byteOffsets[u]=l.offsets[u]*c.stride;if(o)l.instancedDraw?o.multiDrawElementsInstancedWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.instances,0,l.drawCount):o.multiDrawElementsWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.drawCount);else for(var h=0;h<l.drawCount;h++)l.instances[h]&&r?r.drawElementsInstancedANGLE(s,l.counts[h],a.glIndexType,l.byteOffsets[h],l.instances[h]):n.drawElements(s,l.counts[h],a.glIndexType,l.byteOffsets[h])}else if(o)l.instancedDraw?o.multiDrawArraysInstancedWEBGL(s,l.offsets,0,l.counts,0,l.instances,0,l.drawCount):o.multiDrawArraysWEBGL(s,l.offsets,0,l.counts,0,l.drawCount);else for(var _=0;_<l.drawCount;_++)l.instances[_]&&r?r.drawArraysInstancedANGLE(s,l.offsets[_],l.counts[_],l.instances[_]):n.drawArrays(s,l.offsets[_],l.counts[_])}else if(e.instanceCount&&r)if(c){if(e.indexCount>0){var f=e.firstIndex*c.stride;r.drawElementsInstancedANGLE(s,e.indexCount,a.glIndexType,f,e.instanceCount)}}else e.vertexCount>0&&r.drawArraysInstancedANGLE(s,e.firstVertex,e.vertexCount,e.instanceCount);else if(c){if(e.indexCount>0){var p=e.firstIndex*c.stride;n.drawElements(s,e.indexCount,a.glIndexType,p)}}else e.vertexCount>0&&n.drawArrays(s,e.firstVertex,e.vertexCount)}}var NW=new Array(gW.COUNT);function LW(t,e){NW.fill(0);for(var n=0;n<e.cmds.length;++n){var i=e.cmds.array[n],r=NW[i]++;switch(i){case gW.BEGIN_RENDER_PASS:var o=e.beginRenderPassCmds.array[r];BW(t,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case gW.BIND_STATES:var a=e.bindStatesCmds.array[r];MW(t,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case gW.DRAW:OW(t,e.drawCmds.array[r].drawInfo);break;case gW.UPDATE_BUFFER:var s=e.updateBufferCmds.array[r];RW(t,s.gpuBuffer,s.buffer,s.offset,s.size);break;case gW.COPY_BUFFER_TO_TEXTURE:var c=e.copyBufferToTextureCmds.array[r];FW(t,c.buffers,c.gpuTexture,c.regions)}}}function FW(t,e,n,i){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=na[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=e[a++];u?n.glInternalFmt===lW.COMPRESSED_RGB_ETC1_WEBGL||t.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var p=0;p<i.length;p++){var d=i[p],m=d.texSubres.baseArrayLayer+d.texSubres.layerCount;for(l=d.texSubres.baseArrayLayer;l<m;++l){s=d.texExtent.width,c=d.texExtent.height;var v=e[a++];u?n.glInternalFmt===lW.COMPRESSED_RGB_ETC1_WEBGL||t.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Ar.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var zW=function(){function t(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var e=t.prototype;return e.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},e.setDrawInfo=function(t,e){this._ensureCapacity(t),this.drawByIndex=e.indexCount>0,this.instancedDraw=!!e.instanceCount,this.drawCount=Math.max(t+1,this.drawCount),this.drawByIndex?(this.counts[t]=e.indexCount,this.offsets[t]=e.firstIndex):(this.counts[t]=e.vertexCount,this.offsets[t]=e.firstVertex),this.instances[t]=Math.max(1,e.instanceCount)},e._ensureCapacity=function(t){if(!(this._capacity>t)){this._capacity=Mn(t);var e=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),e.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=e,this.offsets=n,this.instances=i}},t}(),VW=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuBuffer=null,e._gpuBufferView=null,e._uniformBuffer=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){if("buffer"in t){this._isBufferView=!0;var e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBufferView={gpuBuffer:e.gpuBuffer,offset:t.offset,range:t.range}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,this._usage&mr.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new zW,glTarget:0,glBuffer:null},this._usage&mr.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(t,e){var n=t.gl,i=t.stateCache,r=e.memUsage&yr.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(e.usage&mr.VERTEX){e.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(e.glBuffer=o,e.size>0&&(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),DW.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer),n.bufferData(n.ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null))}else if(e.usage&mr.INDEX){e.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(e.glBuffer=a,e.size>0&&(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),DW.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null))}else e.usage&mr.UNIFORM?(e.glTarget=n.NONE,e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer))):(e.usage&mr.INDIRECT||e.usage&mr.TRANSFER_DST||e.usage&mr.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE)}(hW.instance,this._gpuBuffer),hW.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(function(t,e){var n=t.gl,i=t.stateCache;if(e.glBuffer){switch(e.glTarget){case n.ARRAY_BUFFER:t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),t.stateCache.glVAO=null),DW.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),t.stateCache.glVAO=null),DW.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null}n.deleteBuffer(e.glBuffer),e.glBuffer=null}}(hW.instance,this._gpuBuffer),hW.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},n.resize=function(t){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var e=this._size;e!==t&&(this._size=t,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(t)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=t,t>0&&(function(t,e){var n=t.gl,i=t.stateCache,r=e.memUsage&yr.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;e.usage&mr.VERTEX?(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),DW.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ARRAY_BUFFER,e.buffer,r):n.bufferData(n.ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null):e.usage&mr.INDEX?(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),DW.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):e.usage&mr.UNIFORM?e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer)):(e.usage&mr.INDIRECT||e.usage&mr.TRANSFER_DST||e.usage&mr.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE)}(hW.instance,this._gpuBuffer),hW.instance.memoryStatus.bufferSize-=e,hW.instance.memoryStatus.bufferSize+=t)))}},n.update=function(t,e){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==e?e:this._usage&mr.INDIRECT?0:t.byteLength,RW(hW.instance,this._gpuBuffer,t,0,n))},N(e,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),e}(fa),GW=function(){function t(t,e){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(e),this._freeCmds=new Xt(e);for(var n=0;n<e;++n)this._frees[n]=new t;this._freeIdx=e-1}var e=t.prototype;return e.alloc=function(t){if(this._freeIdx<0){var e=2*this._frees.length,n=this._frees;this._frees=new Array(e);for(var i=e-n.length,r=0;r<i;++r)this._frees[r]=new t;for(var o=i,a=0;o<e;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},e.free=function(t){0==--t.refCount&&this._freeCmds.push(t)},e.freeCmds=function(t){for(var e=0;e<t.length;++e)0==--t.array[e].refCount&&this._freeCmds.push(t.array[e])},e.release=function(){for(var t=0;t<this._freeCmds.length;++t){var e=this._freeCmds.array[t];e.clear(),this._frees[++this._freeIdx]=e}this._freeCmds.clear()},t}(),UW=function(){function t(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new GW(bW,1),this.bindStatesCmdPool=new GW(TW,1),this.drawCmdPool=new GW(EW,1),this.updateBufferCmdPool=new GW(wW,1),this.copyBufferToTextureCmdPool=new GW(PW,1)}var e=t.prototype;return e.clearCmds=function(t){t.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(t.beginRenderPassCmds),t.beginRenderPassCmds.clear()),t.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(t.bindStatesCmds),t.bindStatesCmds.clear()),t.drawCmds.length&&(this.drawCmdPool.freeCmds(t.drawCmds),t.drawCmds.clear()),t.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(t.updateBufferCmds),t.updateBufferCmds.clear()),t.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(t.copyBufferToTextureCmds),t.copyBufferToTextureCmds.clear()),t.cmds.clear()},e.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},t}(),kW=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).cmdPackage=new IW,e._cmdAllocator=new UW,e._isInRenderPass=!1,e._curGPUPipelineState=null,e._curGPUInputAssembler=null,e._curGPUDescriptorSets=[],e._curDynamicOffsets=Array(8).fill(0),e._curDynamicStates=new ta,e._isStateInvalied=!1,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._type=t.type,this._queue=t.queue;for(var e=hW.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<e;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(t,e,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(bW);a.gpuRenderPass=t.gpuRenderPass,a.gpuFramebuffer=e.gpuFramebuffer,a.renderArea=n,a.clearColors.length=i.length;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(gW.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(t){var e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)},n.bindDescriptorSet=function(t,e,n){var i=e.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[t],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(t){var e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0},n.setViewport=function(t){var e=this._curDynamicStates.viewport;e.left===t.left&&e.top===t.top&&e.width===t.width&&e.height===t.height&&e.minDepth===t.minDepth&&e.maxDepth===t.maxDepth||(e.left=t.left,e.top=t.top,e.width=t.width,e.height=t.height,e.minDepth=t.minDepth,e.maxDepth=t.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(t){var e=this._curDynamicStates.scissor;e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height||(e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,this._isStateInvalied=!0)},n.setLineWidth=function(t){this._curDynamicStates.lineWidth!==t&&(this._curDynamicStates.lineWidth=t,this._isStateInvalied=!0)},n.setDepthBias=function(t,e,n){var i=this._curDynamicStates;i.depthBiasConstant===t&&i.depthBiasClamp===e&&i.depthBiasSlope===n||(i.depthBiasConstant=t,i.depthBiasClamp=e,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(t){var e=this._curDynamicStates.blendConstant;e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w||(e.copy(t),this._isStateInvalied=!0)},n.setDepthBound=function(t,e){var n=this._curDynamicStates;n.depthMinBounds===t&&n.depthMaxBounds===e||(n.depthMinBounds=t,n.depthMaxBounds=e,this._isStateInvalied=!0)},n.setStencilWriteMask=function(t,e){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;t&Hr.FRONT&&n.writeMask!==e&&(n.writeMask=e,this._isStateInvalied=!0),t&Hr.BACK&&i.writeMask!==e&&(i.writeMask=e,this._isStateInvalied=!0)},n.setStencilCompareMask=function(t,e,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;t&Hr.FRONT&&(i.compareMask===n&&i.reference===e||(i.reference=e,i.compareMask=n,this._isStateInvalied=!0)),t&Hr.BACK&&(r.compareMask===n&&r.reference===e||(r.reference=e,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(t){if(this._type===Xr.PRIMARY&&this._isInRenderPass||this._type===Xr.SECONDARY){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t,n=this._cmdAllocator.drawCmdPool.alloc(EW);n.drawInfo.copy(e),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(gW.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(t,e,n){if(this._type===Xr.PRIMARY&&!this._isInRenderPass||this._type===Xr.SECONDARY){var i=t.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(wW),a=0;t.usage&mr.INDIRECT||(a=void 0!==n?n:e.byteLength),r=e,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(gW.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(t,e,n){if(this._type===Xr.PRIMARY&&!this._isInRenderPass||this._type===Xr.SECONDARY){var i=e.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(PW);r&&(r.gpuTexture=i,r.regions=n,r.buffers=t,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(gW.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(t,e){for(var n=0;n<e;++n){for(var i=t[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var t=this._cmdAllocator.bindStatesCmdPool.alloc(TW);t&&(t.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(t.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(t.dynamicOffsets,this._curDynamicOffsets),t.gpuInputAssembler=this._curGPUInputAssembler,t.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(t),this.cmdPackage.cmds.push(gW.BIND_STATES),this._isStateInvalied=!1)},e}(pa),HW=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuFramebuffer=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[],this._depthStencilTexture=t.depthStencilTexture||null;for(var e=[],n=0;n<t.colorTextures.length;++n){var i=t.colorTextures[n];i&&e.push(i.gpuTexture)}var r=null;t.depthStencilTexture&&(r=t.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:t.renderPass.gpuRenderPass,gpuColorTextures:e,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(t){o=t},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(t){a=t}},function(t,e){for(var n=0;n<e.gpuColorTextures.length;++n)if(e.gpuColorTextures[n].isSwapchainTexture)return void(e.isOffscreen=!1);var i=t.gl,r=[],o=i.createFramebuffer();if(o){e.glFramebuffer=o,t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.glFramebuffer);for(var a=0;a<e.gpuColorTextures.length;++a){var s=e.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),e.width=Math.min(e.width,s.width),e.height=Math.min(e.height,s.height))}var c=e.gpuDepthStencilTexture;if(c){var l=na[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),e.width=Math.min(e.width,c.width),e.height=Math.min(e.height,c.height)}t.extensions.WEBGL_draw_buffers&&t.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.stateCache.glFramebuffer)}}(hW.instance,this._gpuFramebuffer)},n.destroy=function(){var t,e;this._gpuFramebuffer&&(t=hW.instance,(e=this._gpuFramebuffer).glFramebuffer&&(t.gl.deleteFramebuffer(e.glFramebuffer),t.stateCache.glFramebuffer===e.glFramebuffer&&(t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null),t.stateCache.glFramebuffer=null),e.glFramebuffer=null),this._gpuFramebuffer=null)},N(e,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),e}(va),jW=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuInputAssembler=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){if(0!==t.vertexBuffers.length){if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var e=this._vertexBuffers[0];this._drawInfo.vertexCount=e.size/e.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;for(var n=new Array(t.vertexBuffers.length),i=0;i<t.vertexBuffers.length;++i){var r=t.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(t.indexBuffer&&(o=t.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Error index buffer stride.")}var s=null;t.indirectBuffer&&(s=t.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(t,e){var n=t.gl;e.glAttribs=new Array(e.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<e.attributes.length;++r){var o=e.attributes[r],a=void 0!==o.stream?o.stream:0,s=e.gpuVertexBuffers[a],c=_W(o.format,n),l=na[o.format].size;e.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:na[o.format].count,stride:s.stride,componentCount:vW(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(hW.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var t=hW.instance;this._gpuInputAssembler&&t.extensions.useVAO&&function(t,e){for(var n=e.glVAOs.values(),i=n.next(),r=t.extensions.OES_vertex_array_object,o=t.stateCache.glVAO;!i.done;)r.deleteVertexArrayOES(i.value),o===i.value&&(r.bindVertexArrayOES(null),o=null),i=n.next();t.stateCache.glVAO=o,e.glVAOs.clear()}(t,this._gpuInputAssembler),this._gpuInputAssembler=null},N(e,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),e}(Aa),WW=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuDescriptorSetLayout=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){Array.prototype.push.apply(this._bindings,t.bindings);for(var e=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(e),e+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&oa)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:e}},n.destroy=function(){this._bindings.length=0},N(e,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),e}(ba),qW=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuPipelineLayout=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);for(var e=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),e.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:e,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},N(e,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),e}(Ta),XW=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],YW=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuPipelineState=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;var e=this._bs;if(t.blendState){var n=t.blendState,i=n.targets;i&&i.forEach((function(t,n){e.setTarget(n,t)})),void 0!==n.isA2C&&(e.isA2C=n.isA2C),void 0!==n.isIndepend&&(e.isIndepend=n.isIndepend),void 0!==n.blendColor&&(e.blendColor=n.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:XW[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.gpuPipelineLayout,rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},N(e,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),e}(Da),KW=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.beginRenderPass=function(t,e,n,i,r,o){BW(hW.instance,t.gpuRenderPass,e.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(t){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t;OW(hW.instance,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var n=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(t){var e=hW.instance,n=e.stateCache,i=e.gl;n.viewport.left===t.left&&n.viewport.top===t.top&&n.viewport.width===t.width&&n.viewport.height===t.height||(i.viewport(t.left,t.top,t.width,t.height),n.viewport.left=t.left,n.viewport.top=t.top,n.viewport.width=t.width,n.viewport.height=t.height)},n.setScissor=function(t){var e=hW.instance,n=e.stateCache,i=e.gl;n.scissorRect.x===t.x&&n.scissorRect.y===t.y&&n.scissorRect.width===t.width&&n.scissorRect.height===t.height||(i.scissor(t.x,t.y,t.width,t.height),n.scissorRect.x=t.x,n.scissorRect.y=t.y,n.scissorRect.width=t.width,n.scissorRect.height=t.height)},n.updateBuffer=function(t,e,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=t.gpuBuffer;r&&(i=void 0!==n?n:t.usage&mr.INDIRECT?0:e.byteLength,RW(hW.instance,r,e,0,i))}},n.copyBuffersToTexture=function(t,e,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=e.gpuTexture;i&&FW(hW.instance,t,i,n)}},n.execute=function(t,e){for(var n=0;n<e;++n){var i=t[n];LW(hW.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){MW(hW.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},e}(kW),JW=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).numDrawCalls=0,e.numInstances=0,e.numTris=0,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._type=t.type},n.destroy=function(){},n.submit=function(t){for(var e=t.length,n=0;n<e;n++){var i=t[n];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},e}(Ba),QW=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuRenderPass=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,this._subpasses=t.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},N(e,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),e}(Ma),ZW=[10497,33648,33071,33071],$W=function(t){function e(e,n){var i;(i=t.call(this,e,n)||this)._gpuSampler=null;var r,o,a=i._info.minFilter,s=i._info.magFilter,c=i._info.mipFilter;r=a===Tr.LINEAR||a===Tr.ANISOTROPIC?c===Tr.LINEAR||c===Tr.ANISOTROPIC?9987:c===Tr.POINT?9985:9729:c===Tr.LINEAR||c===Tr.ANISOTROPIC?9986:c===Tr.POINT?9984:9728,o=s===Tr.LINEAR||s===Tr.ANISOTROPIC?9729:9728;var l=ZW[i._info.addressU],u=ZW[i._info.addressV],h=ZW[i._info.addressW];return i._gpuSampler={glMinFilter:r,glMagFilter:o,glWrapS:l,glWrapT:u,glWrapR:h},i}return F(e,t),N(e,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),e}(Oa),tq=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuShader=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks.slice(),samplerTextures:t.samplerTextures.slice(),subpassInputs:t.subpassInputs.slice(),gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var e=0;e<t.stages.length;++e){var n=t.stages[e];this._gpuShader.gpuStages[e]={type:n.stage,source:n.source,glShader:null}}!function(t,e){for(var n=t.gl,i=function(t){var i=e.gpuStages[t],r=0,o="",a=1;switch(i.type){case Br.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Br.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+e.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<e.gpuStages.length;c++){var l=e.gpuStages[t];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<e.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){e.glProgram=a;for(var s=0;s<e.gpuStages.length;s++){var c=e.gpuStages[s];n.attachShader(e.glProgram,c.glShader)}if(n.linkProgram(e.glProgram),t.extensions.destroyShadersImmediately)for(var l=0;l<e.gpuStages.length;l++){var u=e.gpuStages[l];u.glShader&&(n.detachShader(e.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(e.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+e.name+"'."),void console.error(n.getProgramInfoLog(e.glProgram));v("Shader '"+e.name+"' compilation succeeded.");var h=n.getProgramParameter(e.glProgram,n.ACTIVE_ATTRIBUTES);e.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(e.glProgram,_);if(f){var p,d=f.name.indexOf("[");p=-1!==d?f.name.substr(0,d):f.name;var m=n.getAttribLocation(e.glProgram,p),g=dW(f.type,n),y=mW(f.type,n);e.glInputs[_]={binding:m,name:p,type:g,stride:y,count:f.size,size:y*f.size,glType:f.type,glLoc:m}}}if(e.blocks.length>0){e.glBlocks=new Array(e.blocks.length);for(var x=0;x<e.blocks.length;++x){var S=e.blocks[x],A={set:S.set,binding:S.binding,name:S.name,size:0,glUniforms:new Array(S.members.length),glActiveUniforms:[]};e.glBlocks[x]=A;for(var C=0;C<S.members.length;++C){var b=S.members[C],T=fW(b.type,n),E=mW(T,n),w=E*b.count;A.glUniforms[C]={binding:-1,name:b.name,type:b.type,stride:E,count:b.count,size:w,offset:0,glType:T,glLoc:null,array:null}}}}for(var P=0;P<e.subpassInputs.length;++P){var I=e.subpassInputs[P];e.samplerTextures.push(new To(I.set,I.binding,I.name,dr.SAMPLER2D,I.count))}if(e.samplerTextures.length>0){e.glSamplerTextures=new Array(e.samplerTextures.length);for(var R=0;R<e.samplerTextures.length;++R){var D=e.samplerTextures[R];e.glSamplerTextures[R]={set:D.set,binding:D.binding,name:D.name,type:D.type,count:D.count,units:[],glUnits:null,glType:fW(D.type,n),glLoc:null}}}for(var B=n.getProgramParameter(e.glProgram,n.ACTIVE_UNIFORMS),M=0;M<B;++M){var O=n.getActiveUniform(e.glProgram,M);if(O&&O.type!==n.SAMPLER_2D&&O.type!==n.SAMPLER_CUBE){var N=n.getUniformLocation(e.glProgram,O.name);if(t.extensions.isLocationActive(N)){var L,F=O.name.indexOf("[");L=-1!==F?O.name.substr(0,F):O.name;for(var z=0;z<e.glBlocks.length;z++)for(var V=e.glBlocks[z],G=0;G<V.glUniforms.length;G++){var U=V.glUniforms[G];if(U.name===L){U.glLoc=N,U.count=O.size,U.size=U.stride*U.count,U.array=new(pW(U.type))(U.size/4),V.glActiveUniforms.push(U);break}}}}}for(var k=0;k<e.glBlocks.length;k++)for(var H=e.glBlocks[k],j=0;j<H.glUniforms.length;j++){var W=H.glUniforms[j];W.offset=H.size/4,H.size+=W.size}for(var q=[],X=[],Y=t.bindingMappingInfo,K=t.stateCache.texUnitCacheMap,J=0,Q=0;Q<e.blocks.length;++Q)e.blocks[Q].set===Y.flexibleSet&&J++;for(var Z=0,$=0;$<e.samplerTextures.length;++$){var tt=e.samplerTextures[$],et=n.getUniformLocation(e.glProgram,tt.name);if(t.extensions.isLocationActive(et)&&(q.push(e.glSamplerTextures[$]),X.push(et)),void 0===K[tt.name]){var nt=tt.binding+Y.samplerOffsets[tt.set]+Z;tt.set===Y.flexibleSet&&(nt-=J),K[tt.name]=nt%t.capabilities.maxTextureUnits,Z+=tt.count-1}}if(q.length){for(var it=[],rt=0;rt<q.length;++rt){var ot=q[rt],at=K[ot.name];if(void 0!==at){ot.glLoc=X[rt];for(var st=0;st<ot.count;++st){for(;it[at];)at=(at+1)%t.capabilities.maxTextureUnits;ot.units.push(at),it[at]=!0}}}for(var ct=0,lt=0;lt<q.length;++lt){var ut=q[lt];if(!t.extensions.isLocationActive(ut.glLoc)){ut.glLoc=X[lt];for(var ht=0;ht<ut.count;++ht){for(;it[ct];)ct=(ct+1)%t.capabilities.maxTextureUnits;void 0===K[ut.name]&&(K[ut.name]=ct),ut.units.push(ct),it[ct]=!0}}}t.stateCache.glProgram!==e.glProgram&&n.useProgram(e.glProgram);for(var _t=0;_t<q.length;_t++){var ft=q[_t];ft.glUnits=new Int32Array(ft.units),n.uniform1iv(ft.glLoc,ft.glUnits)}t.stateCache.glProgram!==e.glProgram&&n.useProgram(t.stateCache.glProgram)}for(var pt=0;pt<e.glBlocks.length;)e.glBlocks[pt].glActiveUniforms.length?pt++:(e.glBlocks[pt]=e.glBlocks[e.glBlocks.length-1],e.glBlocks.length--);e.glSamplerTextures=q}}(hW.instance,this._gpuShader)},n.destroy=function(){this._gpuShader&&(function(t,e){if(e.glProgram){var n=t.gl;if(!t.extensions.destroyShadersImmediately)for(var i=0;i<e.gpuStages.length;i++){var r=e.gpuStages[i];r.glShader&&(n.detachShader(e.glProgram,r.glShader),n.deleteShader(r.glShader),r.glShader=null)}n.deleteProgram(e.glProgram),t.stateCache.glProgram===e.glProgram&&(t.gl.useProgram(null),t.stateCache.glProgram=null),e.glProgram=null}}(hW.instance,this._gpuShader),this._gpuShader=null)},N(e,[{key:"gpuShader",get:function(){return this._gpuShader}}]),e}(Na),eq=function(){function t(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new lo,this.scissorRect=new no(0,0,0,0),this.rs=new Ea,this.dss=new wa,this.bs=new Ia,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return t.prototype.initialize=function(t,e){for(var n=0;n<t;++n)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=e,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=e,this.glCurrentAttribLocs.fill(!1)},t}(),nq=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuTexture=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t,e){"texture"in t?console.log("WebGL does not support texture view."):(this._type=t.type,this._usage=t.usage,this._format=t.format,this._width=t.width,this._height=t.height,this._depth=t.depth,this._layerCount=t.layerCount,this._levelCount=t.levelCount,this._samples=t.samples,this._flags=t.flags,this._isPowerOf2=aa(this._width)&&aa(this._height),this._size=ca(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:e||!1},function(t,e){var n=t.gl;e.glFormat=e.glInternalFmt=function(t,e){switch(t){case fr.A8:return e.ALPHA;case fr.L8:return e.LUMINANCE;case fr.LA8:return e.LUMINANCE_ALPHA;case fr.RGB8:case fr.RGB16F:case fr.RGB32F:return e.RGB;case fr.BGRA8:case fr.RGBA8:case fr.SRGB8_A8:case fr.RGBA16F:case fr.RGBA32F:return e.RGBA;case fr.R5G6B5:return e.RGB;case fr.RGB5A1:case fr.RGBA4:return e.RGBA;case fr.DEPTH:return e.DEPTH_COMPONENT;case fr.DEPTH_STENCIL:return e.DEPTH_STENCIL;case fr.BC1:return lW.COMPRESSED_RGB_S3TC_DXT1_EXT;case fr.BC1_ALPHA:return lW.COMPRESSED_RGBA_S3TC_DXT1_EXT;case fr.BC1_SRGB:return lW.COMPRESSED_SRGB_S3TC_DXT1_EXT;case fr.BC1_SRGB_ALPHA:return lW.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case fr.BC2:return lW.COMPRESSED_RGBA_S3TC_DXT3_EXT;case fr.BC2_SRGB:return lW.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case fr.BC3:return lW.COMPRESSED_RGBA_S3TC_DXT5_EXT;case fr.BC3_SRGB:return lW.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case fr.ETC_RGB8:return lW.COMPRESSED_RGB_ETC1_WEBGL;case fr.ETC2_RGB8:return lW.COMPRESSED_RGB8_ETC2;case fr.ETC2_SRGB8:return lW.COMPRESSED_SRGB8_ETC2;case fr.ETC2_RGB8_A1:return lW.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case fr.ETC2_SRGB8_A1:return lW.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case fr.ETC2_RGBA8:return lW.COMPRESSED_RGBA8_ETC2_EAC;case fr.ETC2_SRGB8_A8:return lW.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case fr.EAC_R11:return lW.COMPRESSED_R11_EAC;case fr.EAC_R11SN:return lW.COMPRESSED_SIGNED_R11_EAC;case fr.EAC_RG11:return lW.COMPRESSED_RG11_EAC;case fr.EAC_RG11SN:return lW.COMPRESSED_SIGNED_RG11_EAC;case fr.PVRTC_RGB2:return lW.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case fr.PVRTC_RGBA2:return lW.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case fr.PVRTC_RGB4:return lW.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case fr.PVRTC_RGBA4:return lW.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case fr.ASTC_RGBA_4X4:return lW.COMPRESSED_RGBA_ASTC_4x4_KHR;case fr.ASTC_RGBA_5X4:return lW.COMPRESSED_RGBA_ASTC_5x4_KHR;case fr.ASTC_RGBA_5X5:return lW.COMPRESSED_RGBA_ASTC_5x5_KHR;case fr.ASTC_RGBA_6X5:return lW.COMPRESSED_RGBA_ASTC_6x5_KHR;case fr.ASTC_RGBA_6X6:return lW.COMPRESSED_RGBA_ASTC_6x6_KHR;case fr.ASTC_RGBA_8X5:return lW.COMPRESSED_RGBA_ASTC_8x5_KHR;case fr.ASTC_RGBA_8X6:return lW.COMPRESSED_RGBA_ASTC_8x6_KHR;case fr.ASTC_RGBA_8X8:return lW.COMPRESSED_RGBA_ASTC_8x8_KHR;case fr.ASTC_RGBA_10X5:return lW.COMPRESSED_RGBA_ASTC_10x5_KHR;case fr.ASTC_RGBA_10X6:return lW.COMPRESSED_RGBA_ASTC_10x6_KHR;case fr.ASTC_RGBA_10X8:return lW.COMPRESSED_RGBA_ASTC_10x8_KHR;case fr.ASTC_RGBA_10X10:return lW.COMPRESSED_RGBA_ASTC_10x10_KHR;case fr.ASTC_RGBA_12X10:return lW.COMPRESSED_RGBA_ASTC_12x10_KHR;case fr.ASTC_RGBA_12X12:return lW.COMPRESSED_RGBA_ASTC_12x12_KHR;case fr.ASTC_SRGBA_4X4:return lW.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case fr.ASTC_SRGBA_5X4:return lW.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case fr.ASTC_SRGBA_5X5:return lW.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case fr.ASTC_SRGBA_6X5:return lW.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case fr.ASTC_SRGBA_6X6:return lW.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case fr.ASTC_SRGBA_8X5:return lW.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case fr.ASTC_SRGBA_8X6:return lW.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case fr.ASTC_SRGBA_8X8:return lW.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case fr.ASTC_SRGBA_10X5:return lW.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case fr.ASTC_SRGBA_10X6:return lW.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case fr.ASTC_SRGBA_10X8:return lW.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case fr.ASTC_SRGBA_10X10:return lW.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case fr.ASTC_SRGBA_12X10:return lW.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case fr.ASTC_SRGBA_12X12:return lW.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),e.RGBA}}(e.format,n),e.glType=_W(e.format,n);var i=e.width,r=e.height;switch(e.type){case xr.TEX2D:if(e.glTarget=n.TEXTURE_2D,e.isSwapchainTexture)break;var o=Math.max(i,r);if(o>t.capabilities.maxTextureSize&&E(9100,o,t.capabilities.maxTextureSize),!t.extensions.WEBGL_depth_texture&&na[e.format].hasDepth)e.glInternalFmt=function(t,e){switch(t){case fr.R5G6B5:return e.RGB565;case fr.RGB5A1:return e.RGB5_A1;case fr.RGBA4:return e.RGBA4;case fr.RGBA16F:return lW.RGBA16F_EXT;case fr.RGBA32F:return lW.RGBA32F_EXT;case fr.SRGB8_A8:return lW.SRGB8_ALPHA8_EXT;case fr.DEPTH:return e.DEPTH_COMPONENT16;case fr.DEPTH_STENCIL:return e.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),e.RGBA}}(e.format,n),e.glRenderbuffer=n.createRenderbuffer(),e.size>0&&(t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,e.glInternalFmt,i,r));else if(e.glTexture=n.createTexture(),e.size>0){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),na[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=sa(e.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,e.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<e.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1);e.isPowerOf2?(e.glWrapS=n.REPEAT,e.glWrapT=n.REPEAT):(e.glWrapS=n.CLAMP_TO_EDGE,e.glWrapT=n.CLAMP_TO_EDGE),e.glMinFilter=n.LINEAR,e.glMagFilter=n.LINEAR,n.texParameteri(e.glTarget,n.TEXTURE_WRAP_S,e.glWrapS),n.texParameteri(e.glTarget,n.TEXTURE_WRAP_T,e.glWrapT),n.texParameteri(e.glTarget,n.TEXTURE_MIN_FILTER,e.glMinFilter),n.texParameteri(e.glTarget,n.TEXTURE_MAG_FILTER,e.glMagFilter)}break;case xr.CUBE:e.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);if(h>t.capabilities.maxCubeMapTextureSize&&E(9100,h,t.capabilities.maxTextureSize),e.glTexture=n.createTexture(),e.size>0){var _=t.stateCache.glTexUnits[t.stateCache.texUnit];if(_.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),_.glTexture=e.glTexture),na[e.format].isCompressed)for(var f=0;f<6;++f){i=e.width,r=e.height;for(var p=0;p<e.mipLevel;++p){var d=sa(e.format,i,r,1),m=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,p,e.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=e.width,r=e.height;for(var g=0;g<e.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}e.isPowerOf2?(e.glWrapS=n.REPEAT,e.glWrapT=n.REPEAT):(e.glWrapS=n.CLAMP_TO_EDGE,e.glWrapT=n.CLAMP_TO_EDGE),e.glMinFilter=n.LINEAR,e.glMagFilter=n.LINEAR,n.texParameteri(e.glTarget,n.TEXTURE_WRAP_S,e.glWrapS),n.texParameteri(e.glTarget,n.TEXTURE_WRAP_T,e.glWrapT),n.texParameteri(e.glTarget,n.TEXTURE_MIN_FILTER,e.glMinFilter),n.texParameteri(e.glTarget,n.TEXTURE_MAG_FILTER,e.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),e.type=xr.TEX2D,e.glTarget=n.TEXTURE_2D}}(hW.instance,this._gpuTexture),hW.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){this._gpuTexture&&(function(t,e){var n=t.gl;if(e.glTexture){var i=t.stateCache.glTexUnits,r=t.stateCache.texUnit;n.deleteTexture(e.glTexture);for(var o=0;o<i.length;o++)i[o].glTexture===e.glTexture&&(n.activeTexture(n.TEXTURE0+o),r=o,n.bindTexture(e.glTarget,null),i[o].glTexture=null);t.stateCache.texUnit=r,e.glTexture=null}if(e.glRenderbuffer){var a=t.stateCache.glRenderbuffer;n.deleteRenderbuffer(e.glRenderbuffer),a===e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),a=null),e.glRenderbuffer=null}}(hW.instance,this._gpuTexture),hW.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(t,e){var n=this._size;this._width=t,this._height=e,this._size=ca(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=e,this._gpuTexture.size=this._size,function(t,e){if(e.size){var n=t.gl,i=e.width,r=e.height;switch(e.type){case xr.TEX2D:e.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>t.capabilities.maxTextureSize&&E(9100,o,t.capabilities.maxTextureSize),e.glRenderbuffer)t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,e.glInternalFmt,i,r);else if(e.glTexture){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),na[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=sa(e.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,e.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<e.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;case xr.CUBE:e.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);h>t.capabilities.maxCubeMapTextureSize&&E(9100,h,t.capabilities.maxTextureSize);var _=t.stateCache.glTexUnits[t.stateCache.texUnit];if(_.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),_.glTexture=e.glTexture),na[e.format].isCompressed)for(var f=0;f<6;++f){i=e.width,r=e.height;for(var p=0;p<e.mipLevel;++p){var d=sa(e.format,i,r,1),m=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,p,e.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=e.width,r=e.height;for(var g=0;g<e.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),e.type=xr.TEX2D,e.glTarget=n.TEXTURE_2D}}}(hW.instance,this._gpuTexture),hW.instance.memoryStatus.textureSize-=n,hW.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(t){var e=new xo;e.format=t.format,e.usage=na[t.format].hasDepth?Sr.DEPTH_STENCIL_ATTACHMENT:Sr.COLOR_ATTACHMENT,e.width=t.width,e.height=t.height,this.initialize(e,!0)},N(e,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),e}(La),iq="webglcontextlost";function rq(t,e){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=t.getExtension(n[i]+e);if(r)return r}return null}function oq(t){var e={EXT_texture_filter_anisotropic:rq(t,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:rq(t,"EXT_blend_minmax"),EXT_frag_depth:rq(t,"EXT_frag_depth"),EXT_shader_texture_lod:rq(t,"EXT_shader_texture_lod"),EXT_sRGB:rq(t,"EXT_sRGB"),OES_vertex_array_object:rq(t,"OES_vertex_array_object"),EXT_color_buffer_half_float:rq(t,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:rq(t,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:rq(t,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:rq(t,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:rq(t,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:rq(t,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:rq(t,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:rq(t,"WEBGL_debug_shaders"),WEBGL_draw_buffers:rq(t,"WEBGL_draw_buffers"),WEBGL_lose_context:rq(t,"WEBGL_lose_context"),WEBGL_depth_texture:rq(t,"WEBGL_depth_texture"),OES_texture_half_float:rq(t,"OES_texture_half_float"),OES_texture_half_float_linear:rq(t,"OES_texture_half_float_linear"),OES_texture_float:rq(t,"OES_texture_float"),OES_texture_float_linear:rq(t,"OES_texture_float_linear"),OES_standard_derivatives:rq(t,"OES_standard_derivatives"),OES_element_index_uint:rq(t,"OES_element_index_uint"),ANGLE_instanced_arrays:rq(t,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:rq(t,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(t){return!!t},useVAO:!1};return dn.os===hn.IOS&&14===dn.osMainVersion&&dn.isBrowser||(e.WEBGL_compressed_texture_astc=rq(t,"WEBGL_compressed_texture_astc")),dn.os!==hn.ANDROID&&dn.os!==hn.IOS&&(e.WEBGL_multi_draw=rq(t,"WEBGL_multi_draw")),dn.browserType===cn.UC&&(e.ANGLE_instanced_arrays=null),dn.os===hn.IOS&&dn.osMainVersion<=10&&(e.destroyShadersImmediately=!1),e.OES_vertex_array_object&&(e.useVAO=!0),e}var aq=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).stateCache=new eq,e.cmdAllocator=new UW,e.nullTex2D=null,e.nullTexCube=null,e._canvas=null,e._webGLContextLostHandler=null,e._extensions=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._canvas=t.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(iq,this._onWebGLContextLost);var e=hW.instance.gl;this.stateCache.initialize(hW.instance.capabilities.maxTextureUnits,hW.instance.capabilities.maxVertexAttributes),this._extensions=oq(e),function(t){t.activeTexture(t.TEXTURE0),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindFramebuffer(t.FRAMEBUFFER,null),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW),t.disable(t.POLYGON_OFFSET_FILL),t.polygonOffset(0,0),t.enable(t.DEPTH_TEST),t.depthMask(!0),t.depthFunc(t.LESS),t.depthRange(0,1),t.stencilFuncSeparate(t.FRONT,t.ALWAYS,1,65535),t.stencilOpSeparate(t.FRONT,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.FRONT,65535),t.stencilFuncSeparate(t.BACK,t.ALWAYS,1,65535),t.stencilOpSeparate(t.BACK,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.BACK,65535),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.BLEND),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}(e);var n=fr.RGBA8,i=fr.DEPTH_STENCIL,r=e.getParameter(e.DEPTH_BITS),o=e.getParameter(e.STENCIL_BITS);r&&o?i=fr.DEPTH_STENCIL:r&&(i=fr.DEPTH),this._colorTexture=new nq,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:t.width,height:t.height}),this._depthStencilTexture=new nq,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:t.width,height:t.height}),this.nullTex2D=hW.instance.createTexture(new xo(xr.TEX2D,Sr.SAMPLED,fr.RGBA8,2,2,Ar.GEN_MIPMAP)),this.nullTexCube=hW.instance.createTexture(new xo(xr.CUBE,Sr.SAMPLED,fr.RGBA8,2,2,Ar.GEN_MIPMAP,6));var a=new co;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),hW.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,hW.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(iq,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(t,e){this._colorTexture.width===t&&this._colorTexture.height===e||(v("Resizing swapchain: "+t+"x"+e),this._canvas.width=t,this._canvas.height=e,this._colorTexture.resize(t,e),this._depthStencilTexture.resize(t,e))},n._onWebGLContextLost=function(t){b(11e3),p(t)},N(e,[{key:"extensions",get:function(){return this._extensions}}]),e}(ma),sq=t("WebGLDevice",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._swapchain=null,e._context=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){hW.setInstance(this),this._gfxAPI=ur.WEBGL,this._bindingMappingInfo=t.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var e=this._context=function(t){var e=null;try{var n={alpha:ee.ENABLE_TRANSPARENT_CANVAS,antialias:ee.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};e=t.getContext("webgl",n)}catch(t){return null}return e}(da.canvas);if(!e)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Ko(Wr.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Yo(this._queue)),this._caps.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxUniformBufferBindings=16;var n=e.getSupportedExtensions(),i="";if(n)for(var r,o=W(n);!(r=o()).done;)i+=r.value+" ";var a=oq(e);a.WEBGL_debug_renderer_info?(this._renderer=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=e.getParameter(e.RENDERER),this._vendor=e.getParameter(e.VENDOR));var s=e.getParameter(e.VERSION);this._features.fill(!1),a.EXT_sRGB&&(this._features[_r.FORMAT_SRGB]=!0),a.EXT_blend_minmax&&(this._features[_r.BLEND_MINMAX]=!0),a.WEBGL_color_buffer_float&&(this._features[_r.COLOR_FLOAT]=!0),a.EXT_color_buffer_half_float&&(this._features[_r.COLOR_HALF_FLOAT]=!0),a.OES_texture_float&&(this._features[_r.TEXTURE_FLOAT]=!0),a.OES_texture_half_float&&(this._features[_r.TEXTURE_HALF_FLOAT]=!0),a.OES_texture_float_linear&&(this._features[_r.TEXTURE_FLOAT_LINEAR]=!0),a.OES_texture_half_float_linear&&(this._features[_r.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[_r.FORMAT_RGB8]=!0,a.OES_element_index_uint&&(this._features[_r.ELEMENT_INDEX_UINT]=!0),a.ANGLE_instanced_arrays&&(this._features[_r.INSTANCED_ARRAYS]=!0),a.WEBGL_draw_buffers&&(this._features[_r.MULTIPLE_RENDER_TARGETS]=!0);var c="";return a.WEBGL_compressed_texture_etc1&&(this._features[_r.FORMAT_ETC1]=!0,c+="etc1 "),a.WEBGL_compressed_texture_etc&&(this._features[_r.FORMAT_ETC2]=!0,c+="etc2 "),a.WEBGL_compressed_texture_s3tc&&(this._features[_r.FORMAT_DXT]=!0,c+="dxt "),a.WEBGL_compressed_texture_pvrtc&&(this._features[_r.FORMAT_PVRTC]=!0,c+="pvrtc "),a.WEBGL_compressed_texture_astc&&(this._features[_r.FORMAT_ASTC]=!0,c+="astc "),v("WebGL device initialized."),v("RENDERER: "+this._renderer),v("VENDOR: "+this._vendor),v("VERSION: "+s),v("COMPRESSED_FORMAT: "+c),v("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()},n.createCommandBuffer=function(t){var e=new(t.type===Xr.PRIMARY?KW:kW);return e.initialize(t),e},n.createSwapchain=function(t){var e=new aq;return this._swapchain=e,e.initialize(t),e},n.createBuffer=function(t){var e=new VW;return e.initialize(t),e},n.createTexture=function(t){var e=new nq;return e.initialize(t),e},n.createDescriptorSet=function(t){var e=new uW;return e.initialize(t),e},n.createShader=function(t){var e=new tq;return e.initialize(t),e},n.createInputAssembler=function(t){var e=new jW;return e.initialize(t),e},n.createRenderPass=function(t){var e=new QW;return e.initialize(t),e},n.createFramebuffer=function(t){var e=new HW;return e.initialize(t),e},n.createDescriptorSetLayout=function(t){var e=new WW;return e.initialize(t),e},n.createPipelineLayout=function(t){var e=new qW;return e.initialize(t),e},n.createPipelineState=function(t){var e=new YW;return e.initialize(t),e},n.createQueue=function(t){var e=new JW;return e.initialize(t),e},n.getSampler=function(t){var e=Oa.computeHash(t);return this._samplers.has(e)||this._samplers.set(e,new $W(t,e)),this._samplers.get(e)},n.getGlobalBarrier=function(t){var e=Fa.computeHash(t);return this._globalBarriers.has(e)||this._globalBarriers.set(e,new Fa(t,e)),this._globalBarriers.get(e)},n.getTextureBarrier=function(t){var e=za.computeHash(t);return this._textureBarriers.has(e)||this._textureBarriers.set(e,new za(t,e)),this._textureBarriers.get(e)},n.copyBuffersToTexture=function(t,e,n){FW(this,t,e.gpuTexture,n)},n.copyTextureToBuffers=function(t,e,n){!function(t,e,n,i){var r=t.gl,o=t.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(e.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,e.glTarget,e.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,e.glFormat,e.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,t.gpuTexture,e,n)},n.copyTexImagesToTexture=function(t,e,n){!function(t,e,n,i){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,e[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,e[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Ar.GEN_MIPMAP&&n.isPowerOf2&&r.generateMipmap(n.glTarget)}(this,t,e.gpuTexture,n)},N(e,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),e}(da));i.WebGLDevice=sq;var cq,lq=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuDescriptorSet=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._layout=t.layout;var e=t.layout.gpuDescriptorSetLayout,n=e.bindings,i=e.descriptorIndices,r=e.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var t=this._gpuDescriptorSet.gpuDescriptors,e=0;e<t.length;++e)t[e].type&ia?this._buffers[e]&&(t[e].gpuBuffer=this._buffers[e].gpuBuffer):t[e].type&ra&&(this._textures[e]&&(t[e].gpuTexture=this._textures[e].gpuTexture),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}},N(e,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),e}(Ca);!function(t){t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(cq||(cq={}));var uq=function(){function t(){}return t.setInstance=function(e){t._instance=e},N(t,null,[{key:"instance",get:function(){return t._instance}}]),t}();uq._instance=null;var hq=[10497,33648,33071,33071],_q=new Float32Array(4);function fq(t,e){switch(t){case fr.R8:return e.UNSIGNED_BYTE;case fr.R8SN:return e.BYTE;case fr.R8UI:return e.UNSIGNED_BYTE;case fr.R8I:return e.BYTE;case fr.R16F:return e.HALF_FLOAT;case fr.R16UI:return e.UNSIGNED_SHORT;case fr.R16I:return e.SHORT;case fr.R32F:return e.FLOAT;case fr.R32UI:return e.UNSIGNED_INT;case fr.R32I:return e.INT;case fr.RG8:return e.UNSIGNED_BYTE;case fr.RG8SN:return e.BYTE;case fr.RG8UI:return e.UNSIGNED_BYTE;case fr.RG8I:return e.BYTE;case fr.RG16F:return e.HALF_FLOAT;case fr.RG16UI:return e.UNSIGNED_SHORT;case fr.RG16I:return e.SHORT;case fr.RG32F:return e.FLOAT;case fr.RG32UI:return e.UNSIGNED_INT;case fr.RG32I:return e.INT;case fr.RGB8:case fr.SRGB8:return e.UNSIGNED_BYTE;case fr.RGB8SN:return e.BYTE;case fr.RGB8UI:return e.UNSIGNED_BYTE;case fr.RGB8I:return e.BYTE;case fr.RGB16F:return e.HALF_FLOAT;case fr.RGB16UI:return e.UNSIGNED_SHORT;case fr.RGB16I:return e.SHORT;case fr.RGB32F:return e.FLOAT;case fr.RGB32UI:return e.UNSIGNED_INT;case fr.RGB32I:return e.INT;case fr.BGRA8:case fr.RGBA8:case fr.SRGB8_A8:return e.UNSIGNED_BYTE;case fr.RGBA8SN:return e.BYTE;case fr.RGBA8UI:return e.UNSIGNED_BYTE;case fr.RGBA8I:return e.BYTE;case fr.RGBA16F:return e.HALF_FLOAT;case fr.RGBA16UI:return e.UNSIGNED_SHORT;case fr.RGBA16I:return e.SHORT;case fr.RGBA32F:return e.FLOAT;case fr.RGBA32UI:return e.UNSIGNED_INT;case fr.RGBA32I:return e.INT;case fr.R5G6B5:return e.UNSIGNED_SHORT_5_6_5;case fr.R11G11B10F:return e.UNSIGNED_INT_10F_11F_11F_REV;case fr.RGB5A1:return e.UNSIGNED_SHORT_5_5_5_1;case fr.RGBA4:return e.UNSIGNED_SHORT_4_4_4_4;case fr.RGB10A2:case fr.RGB10A2UI:return e.UNSIGNED_INT_2_10_10_10_REV;case fr.RGB9E5:case fr.DEPTH:return e.FLOAT;case fr.DEPTH_STENCIL:return e.UNSIGNED_INT_24_8;case fr.BC1:case fr.BC1_SRGB:case fr.BC2:case fr.BC2_SRGB:case fr.BC3:case fr.BC3_SRGB:case fr.BC4:return e.UNSIGNED_BYTE;case fr.BC4_SNORM:return e.BYTE;case fr.BC5:return e.UNSIGNED_BYTE;case fr.BC5_SNORM:return e.BYTE;case fr.BC6H_SF16:case fr.BC6H_UF16:return e.FLOAT;case fr.BC7:case fr.BC7_SRGB:case fr.ETC_RGB8:case fr.ETC2_RGB8:case fr.ETC2_SRGB8:case fr.ETC2_RGB8_A1:case fr.ETC2_SRGB8_A1:case fr.EAC_R11:return e.UNSIGNED_BYTE;case fr.EAC_R11SN:return e.BYTE;case fr.EAC_RG11:return e.UNSIGNED_BYTE;case fr.EAC_RG11SN:return e.BYTE;case fr.PVRTC_RGB2:case fr.PVRTC_RGBA2:case fr.PVRTC_RGB4:case fr.PVRTC_RGBA4:case fr.PVRTC2_2BPP:case fr.PVRTC2_4BPP:return e.UNSIGNED_BYTE;case fr.ASTC_RGBA_4X4:case fr.ASTC_RGBA_5X4:case fr.ASTC_RGBA_5X5:case fr.ASTC_RGBA_6X5:case fr.ASTC_RGBA_6X6:case fr.ASTC_RGBA_8X5:case fr.ASTC_RGBA_8X6:case fr.ASTC_RGBA_8X8:case fr.ASTC_RGBA_10X5:case fr.ASTC_RGBA_10X6:case fr.ASTC_RGBA_10X8:case fr.ASTC_RGBA_10X10:case fr.ASTC_RGBA_12X10:case fr.ASTC_RGBA_12X12:case fr.ASTC_SRGBA_4X4:case fr.ASTC_SRGBA_5X4:case fr.ASTC_SRGBA_5X5:case fr.ASTC_SRGBA_6X5:case fr.ASTC_SRGBA_6X6:case fr.ASTC_SRGBA_8X5:case fr.ASTC_SRGBA_8X6:case fr.ASTC_SRGBA_8X8:case fr.ASTC_SRGBA_10X5:case fr.ASTC_SRGBA_10X6:case fr.ASTC_SRGBA_10X8:case fr.ASTC_SRGBA_10X10:case fr.ASTC_SRGBA_12X10:case fr.ASTC_SRGBA_12X12:default:return e.UNSIGNED_BYTE}}function pq(t,e){switch(t){case dr.BOOL:return e.BOOL;case dr.BOOL2:return e.BOOL_VEC2;case dr.BOOL3:return e.BOOL_VEC3;case dr.BOOL4:return e.BOOL_VEC4;case dr.INT:return e.INT;case dr.INT2:return e.INT_VEC2;case dr.INT3:return e.INT_VEC3;case dr.INT4:return e.INT_VEC4;case dr.UINT:return e.UNSIGNED_INT;case dr.FLOAT:return e.FLOAT;case dr.FLOAT2:return e.FLOAT_VEC2;case dr.FLOAT3:return e.FLOAT_VEC3;case dr.FLOAT4:return e.FLOAT_VEC4;case dr.MAT2:return e.FLOAT_MAT2;case dr.MAT2X3:return e.FLOAT_MAT2x3;case dr.MAT2X4:return e.FLOAT_MAT2x4;case dr.MAT3X2:return e.FLOAT_MAT3x2;case dr.MAT3:return e.FLOAT_MAT3;case dr.MAT3X4:return e.FLOAT_MAT3x4;case dr.MAT4X2:return e.FLOAT_MAT4x2;case dr.MAT4X3:return e.FLOAT_MAT4x3;case dr.MAT4:return e.FLOAT_MAT4;case dr.SAMPLER2D:return e.SAMPLER_2D;case dr.SAMPLER2D_ARRAY:return e.SAMPLER_2D_ARRAY;case dr.SAMPLER3D:return e.SAMPLER_3D;case dr.SAMPLER_CUBE:return e.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),dr.UNKNOWN}}function dq(t,e){switch(t){case e.BOOL:return dr.BOOL;case e.BOOL_VEC2:return dr.BOOL2;case e.BOOL_VEC3:return dr.BOOL3;case e.BOOL_VEC4:return dr.BOOL4;case e.INT:return dr.INT;case e.INT_VEC2:return dr.INT2;case e.INT_VEC3:return dr.INT3;case e.INT_VEC4:return dr.INT4;case e.UNSIGNED_INT:return dr.UINT;case e.UNSIGNED_INT_VEC2:return dr.UINT2;case e.UNSIGNED_INT_VEC3:return dr.UINT3;case e.UNSIGNED_INT_VEC4:return dr.UINT4;case e.FLOAT:return dr.FLOAT;case e.FLOAT_VEC2:return dr.FLOAT2;case e.FLOAT_VEC3:return dr.FLOAT3;case e.FLOAT_VEC4:return dr.FLOAT4;case e.FLOAT_MAT2:return dr.MAT2;case e.FLOAT_MAT2x3:return dr.MAT2X3;case e.FLOAT_MAT2x4:return dr.MAT2X4;case e.FLOAT_MAT3x2:return dr.MAT3X2;case e.FLOAT_MAT3:return dr.MAT3;case e.FLOAT_MAT3x4:return dr.MAT3X4;case e.FLOAT_MAT4x2:return dr.MAT4X2;case e.FLOAT_MAT4x3:return dr.MAT4X3;case e.FLOAT_MAT4:return dr.MAT4;case e.SAMPLER_2D:return dr.SAMPLER2D;case e.SAMPLER_2D_ARRAY:return dr.SAMPLER2D_ARRAY;case e.SAMPLER_3D:return dr.SAMPLER3D;case e.SAMPLER_CUBE:return dr.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),dr.UNKNOWN}}function mq(t,e){switch(t){case e.BOOL:return 4;case e.BOOL_VEC2:return 8;case e.BOOL_VEC3:return 12;case e.BOOL_VEC4:return 16;case e.INT:return 4;case e.INT_VEC2:return 8;case e.INT_VEC3:return 12;case e.INT_VEC4:return 16;case e.UNSIGNED_INT:return 4;case e.UNSIGNED_INT_VEC2:return 8;case e.UNSIGNED_INT_VEC3:return 12;case e.UNSIGNED_INT_VEC4:return 16;case e.FLOAT:return 4;case e.FLOAT_VEC2:return 8;case e.FLOAT_VEC3:return 12;case e.FLOAT_VEC4:case e.FLOAT_MAT2:return 16;case e.FLOAT_MAT2x3:return 24;case e.FLOAT_MAT2x4:return 32;case e.FLOAT_MAT3x2:return 24;case e.FLOAT_MAT3:return 36;case e.FLOAT_MAT3x4:return 48;case e.FLOAT_MAT4x2:return 32;case e.FLOAT_MAT4x3:return 48;case e.FLOAT_MAT4:return 64;case e.SAMPLER_2D:case e.SAMPLER_2D_ARRAY:case e.SAMPLER_2D_ARRAY_SHADOW:case e.SAMPLER_3D:case e.SAMPLER_CUBE:case e.INT_SAMPLER_2D:case e.INT_SAMPLER_2D_ARRAY:case e.INT_SAMPLER_3D:case e.INT_SAMPLER_CUBE:case e.UNSIGNED_INT_SAMPLER_2D:case e.UNSIGNED_INT_SAMPLER_2D_ARRAY:case e.UNSIGNED_INT_SAMPLER_3D:case e.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function vq(t,e){switch(t){case e.FLOAT_MAT2:case e.FLOAT_MAT2x3:case e.FLOAT_MAT2x4:return 2;case e.FLOAT_MAT3x2:case e.FLOAT_MAT3:case e.FLOAT_MAT3x4:return 3;case e.FLOAT_MAT4x2:case e.FLOAT_MAT4x3:case e.FLOAT_MAT4:return 4;default:return 1}}var gq,yq=[512,513,514,515,516,517,518,519],xq=[0,7680,7681,7682,7683,5386,34055,34056],Sq=[32774,32778,32779,32775,32776],Aq=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(t){t[t.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",t[t.END_RENDER_PASS=1]="END_RENDER_PASS",t[t.BIND_STATES=2]="BIND_STATES",t[t.DRAW=3]="DRAW",t[t.UPDATE_BUFFER=4]="UPDATE_BUFFER",t[t.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",t[t.COUNT=6]="COUNT"}(gq||(gq={}));var Cq=function(t){this.cmdType=void 0,this.refCount=0,this.cmdType=t},bq=function(t){function e(){var e;return(e=t.call(this,gq.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea=new no,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return F(e,t),e.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},e}(Cq),Tq=function(t){function e(){var e;return(e=t.call(this,gq.BIND_STATES)||this).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.dynamicStates=new ta,e}return F(e,t),e.prototype.clear=function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0},e}(Cq),Eq=function(t){function e(){var e;return(e=t.call(this,gq.DRAW)||this).drawInfo=new vo,e}return F(e,t),e.prototype.clear=function(){},e}(Cq),wq=function(t){function e(){var e;return(e=t.call(this,gq.UPDATE_BUFFER)||this).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return F(e,t),e.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},e}(Cq),Pq=function(t){function e(){var e;return(e=t.call(this,gq.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,e.buffers=[],e.regions=[],e}return F(e,t),e.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},e}(Cq),Iq=function(){function t(){this.cmds=new Xt(1),this.beginRenderPassCmds=new Xt(1),this.bindStatesCmds=new Xt(1),this.drawCmds=new Xt(1),this.updateBufferCmds=new Xt(1),this.copyBufferToTextureCmds=new Xt(1)}return t.prototype.clearCmds=function(t){this.beginRenderPassCmds.length&&(t.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(t.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(t.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(t.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(t.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},t}();function Rq(t,e,n,i,r){if(e.usage&mr.INDIRECT){e.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)e.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=t.gl,l=t.stateCache;switch(e.glTarget){case c.ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),Mq.gpuInputAssembler=null,l.glArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,e.glBuffer),l.glArrayBuffer=e.glBuffer),r===s.byteLength?c.bufferSubData(e.glTarget,i,s):c.bufferSubData(e.glTarget,i,s.slice(0,r));break;case c.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),Mq.gpuInputAssembler=null,l.glElementArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,e.glBuffer),l.glElementArrayBuffer=e.glBuffer),r===s.byteLength?c.bufferSubData(e.glTarget,i,s):c.bufferSubData(e.glTarget,i,s.slice(0,r));break;case c.UNIFORM_BUFFER:l.glUniformBuffer!==e.glBuffer&&(c.bindBuffer(c.UNIFORM_BUFFER,e.glBuffer),l.glUniformBuffer=e.glBuffer),r===s.byteLength?c.bufferSubData(e.glTarget,i,s):c.bufferSubData(e.glTarget,i,new Float32Array(s,0,r/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}function Dq(t,e){var n=t.gl;e.glInternalFmt=function(t,e){switch(t){case fr.A8:return e.ALPHA;case fr.L8:return e.LUMINANCE;case fr.LA8:return e.LUMINANCE_ALPHA;case fr.R8:return e.R8;case fr.R8SN:return e.R8_SNORM;case fr.R8UI:return e.R8UI;case fr.R8I:return e.R8I;case fr.RG8:return e.RG8;case fr.RG8SN:return e.RG8_SNORM;case fr.RG8UI:return e.RG8UI;case fr.RG8I:return e.RG8I;case fr.RGB8:return e.RGB8;case fr.RGB8SN:return e.RGB8_SNORM;case fr.RGB8UI:return e.RGB8UI;case fr.RGB8I:return e.RGB8I;case fr.BGRA8:case fr.RGBA8:return e.RGBA8;case fr.RGBA8SN:return e.RGBA8_SNORM;case fr.RGBA8UI:return e.RGBA8UI;case fr.RGBA8I:return e.RGBA8I;case fr.R16I:return e.R16I;case fr.R16UI:return e.R16UI;case fr.R16F:return e.R16F;case fr.RG16I:return e.RG16I;case fr.RG16UI:return e.RG16UI;case fr.RG16F:return e.RG16F;case fr.RGB16I:return e.RGB16I;case fr.RGB16UI:return e.RGB16UI;case fr.RGB16F:return e.RGB16F;case fr.RGBA16I:return e.RGBA16I;case fr.RGBA16UI:return e.RGBA16UI;case fr.RGBA16F:return e.RGBA16F;case fr.R32I:return e.R32I;case fr.R32UI:return e.R32UI;case fr.R32F:return e.R32F;case fr.RG32I:return e.RG32I;case fr.RG32UI:return e.RG32UI;case fr.RG32F:return e.RG32F;case fr.RGB32I:return e.RGB32I;case fr.RGB32UI:return e.RGB32UI;case fr.RGB32F:return e.RGB32F;case fr.RGBA32I:return e.RGBA32I;case fr.RGBA32UI:return e.RGBA32UI;case fr.RGBA32F:return e.RGBA32F;case fr.R5G6B5:return e.RGB565;case fr.RGB5A1:return e.RGB5_A1;case fr.RGBA4:return e.RGBA4;case fr.SRGB8:return e.SRGB8;case fr.SRGB8_A8:return e.SRGB8_ALPHA8;case fr.RGB10A2:return e.RGB10_A2;case fr.RGB10A2UI:return e.RGB10_A2UI;case fr.R11G11B10F:return e.R11F_G11F_B10F;case fr.DEPTH:return e.DEPTH_COMPONENT32F;case fr.DEPTH_STENCIL:return e.DEPTH24_STENCIL8;case fr.BC1:return cq.COMPRESSED_RGB_S3TC_DXT1_EXT;case fr.BC1_ALPHA:return cq.COMPRESSED_RGBA_S3TC_DXT1_EXT;case fr.BC1_SRGB:return cq.COMPRESSED_SRGB_S3TC_DXT1_EXT;case fr.BC1_SRGB_ALPHA:return cq.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case fr.BC2:return cq.COMPRESSED_RGBA_S3TC_DXT3_EXT;case fr.BC2_SRGB:return cq.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case fr.BC3:return cq.COMPRESSED_RGBA_S3TC_DXT5_EXT;case fr.BC3_SRGB:return cq.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case fr.ETC_RGB8:return cq.COMPRESSED_RGB_ETC1_WEBGL;case fr.ETC2_RGB8:return cq.COMPRESSED_RGB8_ETC2;case fr.ETC2_SRGB8:return cq.COMPRESSED_SRGB8_ETC2;case fr.ETC2_RGB8_A1:return cq.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case fr.ETC2_SRGB8_A1:return cq.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case fr.ETC2_RGBA8:return cq.COMPRESSED_RGBA8_ETC2_EAC;case fr.ETC2_SRGB8_A8:return cq.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case fr.EAC_R11:return cq.COMPRESSED_R11_EAC;case fr.EAC_R11SN:return cq.COMPRESSED_SIGNED_R11_EAC;case fr.EAC_RG11:return cq.COMPRESSED_RG11_EAC;case fr.EAC_RG11SN:return cq.COMPRESSED_SIGNED_RG11_EAC;case fr.PVRTC_RGB2:return cq.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case fr.PVRTC_RGBA2:return cq.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case fr.PVRTC_RGB4:return cq.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case fr.PVRTC_RGBA4:return cq.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case fr.ASTC_RGBA_4X4:return cq.COMPRESSED_RGBA_ASTC_4x4_KHR;case fr.ASTC_RGBA_5X4:return cq.COMPRESSED_RGBA_ASTC_5x4_KHR;case fr.ASTC_RGBA_5X5:return cq.COMPRESSED_RGBA_ASTC_5x5_KHR;case fr.ASTC_RGBA_6X5:return cq.COMPRESSED_RGBA_ASTC_6x5_KHR;case fr.ASTC_RGBA_6X6:return cq.COMPRESSED_RGBA_ASTC_6x6_KHR;case fr.ASTC_RGBA_8X5:return cq.COMPRESSED_RGBA_ASTC_8x5_KHR;case fr.ASTC_RGBA_8X6:return cq.COMPRESSED_RGBA_ASTC_8x6_KHR;case fr.ASTC_RGBA_8X8:return cq.COMPRESSED_RGBA_ASTC_8x8_KHR;case fr.ASTC_RGBA_10X5:return cq.COMPRESSED_RGBA_ASTC_10x5_KHR;case fr.ASTC_RGBA_10X6:return cq.COMPRESSED_RGBA_ASTC_10x6_KHR;case fr.ASTC_RGBA_10X8:return cq.COMPRESSED_RGBA_ASTC_10x8_KHR;case fr.ASTC_RGBA_10X10:return cq.COMPRESSED_RGBA_ASTC_10x10_KHR;case fr.ASTC_RGBA_12X10:return cq.COMPRESSED_RGBA_ASTC_12x10_KHR;case fr.ASTC_RGBA_12X12:return cq.COMPRESSED_RGBA_ASTC_12x12_KHR;case fr.ASTC_SRGBA_4X4:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case fr.ASTC_SRGBA_5X4:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case fr.ASTC_SRGBA_5X5:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case fr.ASTC_SRGBA_6X5:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case fr.ASTC_SRGBA_6X6:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case fr.ASTC_SRGBA_8X5:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case fr.ASTC_SRGBA_8X6:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case fr.ASTC_SRGBA_8X8:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case fr.ASTC_SRGBA_10X5:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case fr.ASTC_SRGBA_10X6:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case fr.ASTC_SRGBA_10X8:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case fr.ASTC_SRGBA_10X10:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case fr.ASTC_SRGBA_12X10:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case fr.ASTC_SRGBA_12X12:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),e.RGBA}}(e.format,n),e.glFormat=function(t,e){switch(t){case fr.A8:return e.ALPHA;case fr.L8:return e.LUMINANCE;case fr.LA8:return e.LUMINANCE_ALPHA;case fr.R8:case fr.R8SN:return e.RED;case fr.R8UI:case fr.R8I:return e.RED;case fr.RG8:case fr.RG8SN:case fr.RG8UI:case fr.RG8I:return e.RG;case fr.RGB8:case fr.RGB8SN:case fr.RGB8UI:case fr.RGB8I:return e.RGB;case fr.BGRA8:case fr.RGBA8:case fr.RGBA8SN:case fr.RGBA8UI:case fr.RGBA8I:return e.RGBA;case fr.R16UI:case fr.R16I:case fr.R16F:return e.RED;case fr.RG16UI:case fr.RG16I:case fr.RG16F:return e.RG;case fr.RGB16UI:case fr.RGB16I:case fr.RGB16F:return e.RGB;case fr.RGBA16UI:case fr.RGBA16I:case fr.RGBA16F:return e.RGBA;case fr.R32UI:case fr.R32I:case fr.R32F:return e.RED;case fr.RG32UI:case fr.RG32I:case fr.RG32F:return e.RG;case fr.RGB32UI:case fr.RGB32I:case fr.RGB32F:return e.RGB;case fr.RGBA32UI:case fr.RGBA32I:case fr.RGBA32F:case fr.RGB10A2:return e.RGBA;case fr.R11G11B10F:case fr.R5G6B5:return e.RGB;case fr.RGB5A1:case fr.RGBA4:return e.RGBA;case fr.SRGB8:return e.RGB;case fr.SRGB8_A8:return e.RGBA;case fr.DEPTH:return e.DEPTH_COMPONENT;case fr.DEPTH_STENCIL:return e.DEPTH_STENCIL;case fr.BC1:return cq.COMPRESSED_RGB_S3TC_DXT1_EXT;case fr.BC1_ALPHA:return cq.COMPRESSED_RGBA_S3TC_DXT1_EXT;case fr.BC1_SRGB:return cq.COMPRESSED_SRGB_S3TC_DXT1_EXT;case fr.BC1_SRGB_ALPHA:return cq.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case fr.BC2:return cq.COMPRESSED_RGBA_S3TC_DXT3_EXT;case fr.BC2_SRGB:return cq.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case fr.BC3:return cq.COMPRESSED_RGBA_S3TC_DXT5_EXT;case fr.BC3_SRGB:return cq.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case fr.ETC_RGB8:return cq.COMPRESSED_RGB_ETC1_WEBGL;case fr.ETC2_RGB8:return cq.COMPRESSED_RGB8_ETC2;case fr.ETC2_SRGB8:return cq.COMPRESSED_SRGB8_ETC2;case fr.ETC2_RGB8_A1:return cq.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case fr.ETC2_SRGB8_A1:return cq.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case fr.ETC2_RGBA8:return cq.COMPRESSED_RGBA8_ETC2_EAC;case fr.ETC2_SRGB8_A8:return cq.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case fr.EAC_R11:return cq.COMPRESSED_R11_EAC;case fr.EAC_R11SN:return cq.COMPRESSED_SIGNED_R11_EAC;case fr.EAC_RG11:return cq.COMPRESSED_RG11_EAC;case fr.EAC_RG11SN:return cq.COMPRESSED_SIGNED_RG11_EAC;case fr.PVRTC_RGB2:return cq.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case fr.PVRTC_RGBA2:return cq.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case fr.PVRTC_RGB4:return cq.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case fr.PVRTC_RGBA4:return cq.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case fr.ASTC_RGBA_4X4:return cq.COMPRESSED_RGBA_ASTC_4x4_KHR;case fr.ASTC_RGBA_5X4:return cq.COMPRESSED_RGBA_ASTC_5x4_KHR;case fr.ASTC_RGBA_5X5:return cq.COMPRESSED_RGBA_ASTC_5x5_KHR;case fr.ASTC_RGBA_6X5:return cq.COMPRESSED_RGBA_ASTC_6x5_KHR;case fr.ASTC_RGBA_6X6:return cq.COMPRESSED_RGBA_ASTC_6x6_KHR;case fr.ASTC_RGBA_8X5:return cq.COMPRESSED_RGBA_ASTC_8x5_KHR;case fr.ASTC_RGBA_8X6:return cq.COMPRESSED_RGBA_ASTC_8x6_KHR;case fr.ASTC_RGBA_8X8:return cq.COMPRESSED_RGBA_ASTC_8x8_KHR;case fr.ASTC_RGBA_10X5:return cq.COMPRESSED_RGBA_ASTC_10x5_KHR;case fr.ASTC_RGBA_10X6:return cq.COMPRESSED_RGBA_ASTC_10x6_KHR;case fr.ASTC_RGBA_10X8:return cq.COMPRESSED_RGBA_ASTC_10x8_KHR;case fr.ASTC_RGBA_10X10:return cq.COMPRESSED_RGBA_ASTC_10x10_KHR;case fr.ASTC_RGBA_12X10:return cq.COMPRESSED_RGBA_ASTC_12x10_KHR;case fr.ASTC_RGBA_12X12:return cq.COMPRESSED_RGBA_ASTC_12x12_KHR;case fr.ASTC_SRGBA_4X4:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case fr.ASTC_SRGBA_5X4:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case fr.ASTC_SRGBA_5X5:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case fr.ASTC_SRGBA_6X5:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case fr.ASTC_SRGBA_6X6:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case fr.ASTC_SRGBA_8X5:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case fr.ASTC_SRGBA_8X6:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case fr.ASTC_SRGBA_8X8:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case fr.ASTC_SRGBA_10X5:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case fr.ASTC_SRGBA_10X6:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case fr.ASTC_SRGBA_10X8:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case fr.ASTC_SRGBA_10X10:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case fr.ASTC_SRGBA_12X10:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case fr.ASTC_SRGBA_12X12:return cq.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),e.RGBA}}(e.format,n),e.glType=fq(e.format,n);var i=e.width,r=e.height;switch(e.type){case xr.TEX2D:if(e.glTarget=n.TEXTURE_2D,e.isSwapchainTexture)break;var o=Math.max(i,r);if(o>t.capabilities.maxTextureSize&&E(9100,o,t.capabilities.maxTextureSize),e.samples===Cr.ONE){if(e.glTexture=n.createTexture(),e.size>0){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),na[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=sa(e.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,e.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_2D,e.mipLevel,e.glInternalFmt,i,r)}}else e.glRenderbuffer=n.createRenderbuffer(),e.size>0&&(t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,e.samples,e.glInternalFmt,e.width,e.height));break;case xr.CUBE:e.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);if(u>t.capabilities.maxCubeMapTextureSize&&E(9100,u,t.capabilities.maxTextureSize),e.glTexture=n.createTexture(),e.size>0){var h=t.stateCache.glTexUnits[t.stateCache.texUnit];if(h.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),h.glTexture=e.glTexture),na[e.format].isCompressed)for(var _=0;_<e.mipLevel;++_){for(var f=sa(e.format,i,r,1),p=new Uint8Array(f),d=0;d<6;++d)n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+d,_,e.glInternalFmt,i,r,0,p);i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_CUBE_MAP,e.mipLevel,e.glInternalFmt,i,r)}break;default:console.error("Unsupported TextureType, create texture failed."),e.type=xr.TEX2D,e.glTarget=n.TEXTURE_2D}}function Bq(t,e){var n=t.gl;if(e.glTexture){var i=t.stateCache.glTexUnits,r=t.stateCache.texUnit;n.deleteTexture(e.glTexture);for(var o=0;o<i.length;++o)i[o].glTexture===e.glTexture&&(n.activeTexture(n.TEXTURE0+o),r=o,n.bindTexture(e.glTarget,null),i[o].glTexture=null);t.stateCache.texUnit=r,e.glTexture=null}if(e.glRenderbuffer){var a=t.stateCache.glRenderbuffer;n.deleteRenderbuffer(e.glRenderbuffer),a===e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),a=null),e.glRenderbuffer=null}}var Mq={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function Oq(t,e,n,i,r,o,a){var s=t.gl,c=t.stateCache,l=0;if(n&&e){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height),Mq.invalidateAttachments.length=0;for(var u=0;u<r.length;++u){var h=e.colorAttachments[u];if(h.format!==fr.UNKNOWN)switch(h.loadOp){case Mr.LOAD:break;case Mr.CLEAR:if(c.bs.targets[0].blendColorMask!==Dr.ALL&&s.colorMask(!0,!0,!0,!0),n.isOffscreen)_q[0]=r[u].x,_q[1]=r[u].y,_q[2]=r[u].z,_q[3]=r[u].w,s.clearBufferfv(s.COLOR,u,_q);else{var _=r[0];s.clearColor(_.x,_.y,_.z,_.w),l|=s.COLOR_BUFFER_BIT}break;case Mr.DISCARD:Mq.invalidateAttachments.push(s.COLOR_ATTACHMENT0+u)}}if(e.depthStencilAttachment&&e.depthStencilAttachment.format!==fr.UNKNOWN){switch(e.depthStencilAttachment.depthLoadOp){case Mr.LOAD:break;case Mr.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case Mr.DISCARD:Mq.invalidateAttachments.push(s.DEPTH_ATTACHMENT)}if(na[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case Mr.LOAD:break;case Mr.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case Mr.DISCARD:Mq.invalidateAttachments.push(s.STENCIL_ATTACHMENT)}}if(n.glFramebuffer&&Mq.invalidateAttachments.length&&s.invalidateFramebuffer(s.FRAMEBUFFER,Mq.invalidateAttachments),l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var f=c.bs.targets[0].blendColorMask;if(f!==Dr.ALL){var p=(f&Dr.R)!==Dr.NONE,d=(f&Dr.G)!==Dr.NONE,m=(f&Dr.B)!==Dr.NONE,v=(f&Dr.A)!==Dr.NONE;s.colorMask(p,d,m,v)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function Nq(t,e,n,i,r,o){var a=t.gl,s=t.stateCache,c=e&&e.gpuShader,l=!1;if(e&&Mq.gpuPipelineState!==e){if(Mq.gpuPipelineState=e,Mq.glPrimitive=e.glPrimitive,c){var u=c.glProgram;s.glProgram!==u&&(a.useProgram(u),s.glProgram=u,l=!0)}var h=e.rs;if(h){if(s.rs.cullMode!==h.cullMode){switch(h.cullMode){case Ur.NONE:a.disable(a.CULL_FACE);break;case Ur.FRONT:a.enable(a.CULL_FACE),a.cullFace(a.FRONT);break;case Ur.BACK:a.enable(a.CULL_FACE),a.cullFace(a.BACK)}t.stateCache.rs.cullMode=h.cullMode}var _=h.isFrontFaceCCW;t.stateCache.rs.isFrontFaceCCW!==_&&(a.frontFace(_?a.CCW:a.CW),t.stateCache.rs.isFrontFaceCCW=_),t.stateCache.rs.depthBias===h.depthBias&&t.stateCache.rs.depthBiasSlop===h.depthBiasSlop||(a.polygonOffset(h.depthBias,h.depthBiasSlop),t.stateCache.rs.depthBias=h.depthBias,t.stateCache.rs.depthBiasSlop=h.depthBiasSlop),t.stateCache.rs.lineWidth!==h.lineWidth&&(a.lineWidth(h.lineWidth),t.stateCache.rs.lineWidth=h.lineWidth)}var f=e.dss;f&&(s.dss.depthTest!==f.depthTest&&(f.depthTest?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),s.dss.depthTest=f.depthTest),s.dss.depthWrite!==f.depthWrite&&(a.depthMask(f.depthWrite),s.dss.depthWrite=f.depthWrite),s.dss.depthFunc!==f.depthFunc&&(a.depthFunc(yq[f.depthFunc]),s.dss.depthFunc=f.depthFunc),s.dss.stencilTestFront===f.stencilTestFront&&s.dss.stencilTestBack===f.stencilTestBack||(f.stencilTestFront||f.stencilTestBack?a.enable(a.STENCIL_TEST):a.disable(a.STENCIL_TEST),s.dss.stencilTestFront=f.stencilTestFront,s.dss.stencilTestBack=f.stencilTestBack),s.dss.stencilFuncFront===f.stencilFuncFront&&s.dss.stencilRefFront===f.stencilRefFront&&s.dss.stencilReadMaskFront===f.stencilReadMaskFront||(a.stencilFuncSeparate(a.FRONT,yq[f.stencilFuncFront],f.stencilRefFront,f.stencilReadMaskFront),s.dss.stencilFuncFront=f.stencilFuncFront,s.dss.stencilRefFront=f.stencilRefFront,s.dss.stencilReadMaskFront=f.stencilReadMaskFront),s.dss.stencilFailOpFront===f.stencilFailOpFront&&s.dss.stencilZFailOpFront===f.stencilZFailOpFront&&s.dss.stencilPassOpFront===f.stencilPassOpFront||(a.stencilOpSeparate(a.FRONT,xq[f.stencilFailOpFront],xq[f.stencilZFailOpFront],xq[f.stencilPassOpFront]),s.dss.stencilFailOpFront=f.stencilFailOpFront,s.dss.stencilZFailOpFront=f.stencilZFailOpFront,s.dss.stencilPassOpFront=f.stencilPassOpFront),s.dss.stencilWriteMaskFront!==f.stencilWriteMaskFront&&(a.stencilMaskSeparate(a.FRONT,f.stencilWriteMaskFront),s.dss.stencilWriteMaskFront=f.stencilWriteMaskFront),s.dss.stencilFuncBack===f.stencilFuncBack&&s.dss.stencilRefBack===f.stencilRefBack&&s.dss.stencilReadMaskBack===f.stencilReadMaskBack||(a.stencilFuncSeparate(a.BACK,yq[f.stencilFuncBack],f.stencilRefBack,f.stencilReadMaskBack),s.dss.stencilFuncBack=f.stencilFuncBack,s.dss.stencilRefBack=f.stencilRefBack,s.dss.stencilReadMaskBack=f.stencilReadMaskBack),s.dss.stencilFailOpBack===f.stencilFailOpBack&&s.dss.stencilZFailOpBack===f.stencilZFailOpBack&&s.dss.stencilPassOpBack===f.stencilPassOpBack||(a.stencilOpSeparate(a.BACK,xq[f.stencilFailOpBack],xq[f.stencilZFailOpBack],xq[f.stencilPassOpBack]),s.dss.stencilFailOpBack=f.stencilFailOpBack,s.dss.stencilZFailOpBack=f.stencilZFailOpBack,s.dss.stencilPassOpBack=f.stencilPassOpBack),s.dss.stencilWriteMaskBack!==f.stencilWriteMaskBack&&(a.stencilMaskSeparate(a.BACK,f.stencilWriteMaskBack),s.dss.stencilWriteMaskBack=f.stencilWriteMaskBack));var p=e.bs;if(p){s.bs.isA2C!==p.isA2C&&(p.isA2C?a.enable(a.SAMPLE_ALPHA_TO_COVERAGE):a.disable(a.SAMPLE_ALPHA_TO_COVERAGE),s.bs.isA2C=p.isA2C),s.bs.blendColor.x===p.blendColor.x&&s.bs.blendColor.y===p.blendColor.y&&s.bs.blendColor.z===p.blendColor.z&&s.bs.blendColor.w===p.blendColor.w||(a.blendColor(p.blendColor.x,p.blendColor.y,p.blendColor.z,p.blendColor.w),s.bs.blendColor.x=p.blendColor.x,s.bs.blendColor.y=p.blendColor.y,s.bs.blendColor.z=p.blendColor.z,s.bs.blendColor.w=p.blendColor.w);var m=p.targets[0],v=s.bs.targets[0];v.blend!==m.blend&&(m.blend?a.enable(a.BLEND):a.disable(a.BLEND),v.blend=m.blend),v.blendEq===m.blendEq&&v.blendAlphaEq===m.blendAlphaEq||(a.blendEquationSeparate(Sq[m.blendEq],Sq[m.blendAlphaEq]),v.blendEq=m.blendEq,v.blendAlphaEq=m.blendAlphaEq),v.blendSrc===m.blendSrc&&v.blendDst===m.blendDst&&v.blendSrcAlpha===m.blendSrcAlpha&&v.blendDstAlpha===m.blendDstAlpha||(a.blendFuncSeparate(Aq[m.blendSrc],Aq[m.blendDst],Aq[m.blendSrcAlpha],Aq[m.blendDstAlpha]),v.blendSrc=m.blendSrc,v.blendDst=m.blendDst,v.blendSrcAlpha=m.blendSrcAlpha,v.blendDstAlpha=m.blendDstAlpha),v.blendColorMask!==m.blendColorMask&&(a.colorMask((m.blendColorMask&Dr.R)!==Dr.NONE,(m.blendColorMask&Dr.G)!==Dr.NONE,(m.blendColorMask&Dr.B)!==Dr.NONE,(m.blendColorMask&Dr.A)!==Dr.NONE),v.blendColorMask=m.blendColorMask)}}if(e&&e.gpuPipelineLayout&&c){for(var g=c.glBlocks.length,y=e.gpuPipelineLayout.dynamicOffsetIndices,x=0;x<g;x++){var S=c.glBlocks[x],A=i[S.set],C=A&&A.descriptorIndices[S.binding],b=C>=0&&A.gpuDescriptors[C];if(b&&b.gpuBuffer){var T=y[S.set],E=T&&T[S.binding],w=b.gpuBuffer.glOffset;E>=0&&(w+=r[E]),s.glBindUBOs[S.glBinding]===b.gpuBuffer.glBuffer&&s.glBindUBOOffsets[S.glBinding]===w||(w?a.bindBufferRange(a.UNIFORM_BUFFER,S.glBinding,b.gpuBuffer.glBuffer,w,b.gpuBuffer.size):a.bindBufferBase(a.UNIFORM_BUFFER,S.glBinding,b.gpuBuffer.glBuffer),s.glUniformBuffer=s.glBindUBOs[S.glBinding]=b.gpuBuffer.glBuffer,s.glBindUBOOffsets[S.glBinding]=w)}else d("Buffer binding '"+S.name+"' at set "+S.set+" binding "+S.binding+" is not bounded")}for(var P=c.glSamplerTextures.length,I=0;I<P;I++)for(var R=c.glSamplerTextures[I],D=i[R.set],B=D&&D.descriptorIndices[R.binding],M=B>=0&&D.gpuDescriptors[B],O=0;O<R.units.length;O++){var N=R.units[O],L=s.glTexUnits[N];if(M&&M.gpuTexture&&M.gpuSampler){if(M.gpuTexture&&M.gpuTexture.size>0){var F=M.gpuTexture;L.glTexture!==F.glTexture&&(s.texUnit!==N&&(a.activeTexture(a.TEXTURE0+N),s.texUnit=N),F.glTexture?a.bindTexture(F.glTarget,F.glTexture):a.bindTexture(F.glTarget,t.nullTex2D.gpuTexture.glTexture),L.glTexture=F.glTexture);var z=M.gpuSampler;s.glSamplerUnits[N]!==z.glSampler&&(a.bindSampler(N,z.glSampler),s.glSamplerUnits[N]=z.glSampler)}M=D.gpuDescriptors[++B]}else d("Sampler binding '"+R.name+"' at set "+R.set+" binding "+R.binding+" index "+O+" is not bounded")}}if(n&&c&&(l||Mq.gpuInputAssembler!==n))if(Mq.gpuInputAssembler=n,t.extensions.useVAO){var V=n.glVAOs.get(c.glProgram);if(!V){var G;V=a.createVertexArray(),n.glVAOs.set(c.glProgram,V),a.bindVertexArray(V),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null;for(var U=0;U<c.glInputs.length;U++){var k=c.glInputs[U];G=null;for(var H=0;H<n.glAttribs.length;H++){var j=n.glAttribs[H];if(j.name===k.name){G=j;break}}if(G){s.glArrayBuffer!==G.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,G.glBuffer),s.glArrayBuffer=G.glBuffer);for(var W=0;W<G.componentCount;++W){var q=k.glLoc+W,X=G.offset+G.size*W;a.enableVertexAttribArray(q),s.glCurrentAttribLocs[q]=!0,a.vertexAttribPointer(q,G.count,G.glType,G.isNormalized,G.stride,X),a.vertexAttribDivisor(q,G.isInstanced?1:0)}}}var Y=n.gpuIndexBuffer;Y&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,Y.glBuffer),a.bindVertexArray(null),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null}s.glVAO!==V&&(a.bindVertexArray(V),s.glVAO=V)}else{for(var K=0;K<t.capabilities.maxVertexAttributes;++K)s.glCurrentAttribLocs[K]=!1;for(var J=0;J<c.glInputs.length;J++){for(var Q=c.glInputs[J],Z=null,$=0;$<n.glAttribs.length;$++){var tt=n.glAttribs[$];if(tt.name===Q.name){Z=tt;break}}if(Z){s.glArrayBuffer!==Z.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,Z.glBuffer),s.glArrayBuffer=Z.glBuffer);for(var et=0;et<Z.componentCount;++et){var nt=Q.glLoc+et,it=Z.offset+Z.size*et;!s.glEnabledAttribLocs[nt]&&nt>=0&&(a.enableVertexAttribArray(nt),s.glEnabledAttribLocs[nt]=!0),s.glCurrentAttribLocs[nt]=!0,a.vertexAttribPointer(nt,Z.count,Z.glType,Z.isNormalized,Z.stride,it),a.vertexAttribDivisor(nt,Z.isInstanced?1:0)}}}var rt=n.gpuIndexBuffer;rt&&s.glElementArrayBuffer!==rt.glBuffer&&(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,rt.glBuffer),s.glElementArrayBuffer=rt.glBuffer);for(var ot=0;ot<t.capabilities.maxVertexAttributes;++ot)s.glEnabledAttribLocs[ot]!==s.glCurrentAttribLocs[ot]&&(a.disableVertexAttribArray(ot),s.glEnabledAttribLocs[ot]=!1)}if(e&&e.dynamicStates.length)for(var at=e.dynamicStates.length,st=0;st<at;st++)switch(e.dynamicStates[st]){case kr.LINE_WIDTH:s.rs.lineWidth!==o.lineWidth&&(a.lineWidth(o.lineWidth),s.rs.lineWidth=o.lineWidth);break;case kr.DEPTH_BIAS:s.rs.depthBias===o.depthBiasConstant&&s.rs.depthBiasSlop===o.depthBiasSlope||(a.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),s.rs.depthBias=o.depthBiasConstant,s.rs.depthBiasSlop=o.depthBiasSlope);break;case kr.BLEND_CONSTANTS:var ct=o.blendConstant;s.bs.blendColor.x===ct.x&&s.bs.blendColor.y===ct.y&&s.bs.blendColor.z===ct.z&&s.bs.blendColor.w===ct.w||(a.blendColor(ct.x,ct.y,ct.z,ct.w),s.bs.blendColor.copy(ct));break;case kr.STENCIL_WRITE_MASK:var lt=o.stencilStatesFront,ut=o.stencilStatesBack;s.dss.stencilWriteMaskFront!==lt.writeMask&&(a.stencilMaskSeparate(a.FRONT,lt.writeMask),s.dss.stencilWriteMaskFront=lt.writeMask),s.dss.stencilWriteMaskBack!==ut.writeMask&&(a.stencilMaskSeparate(a.BACK,ut.writeMask),s.dss.stencilWriteMaskBack=ut.writeMask);break;case kr.STENCIL_COMPARE_MASK:var ht=o.stencilStatesFront,_t=o.stencilStatesBack;s.dss.stencilRefFront===ht.reference&&s.dss.stencilReadMaskFront===ht.compareMask||(a.stencilFuncSeparate(a.FRONT,yq[s.dss.stencilFuncFront],ht.reference,ht.compareMask),s.dss.stencilRefFront=ht.reference,s.dss.stencilReadMaskFront=ht.compareMask),s.dss.stencilRefBack===_t.reference&&s.dss.stencilReadMaskBack===_t.compareMask||(a.stencilFuncSeparate(a.BACK,yq[s.dss.stencilFuncBack],_t.reference,_t.compareMask),s.dss.stencilRefBack=_t.reference,s.dss.stencilReadMaskBack=_t.compareMask)}}function Lq(t,e){var n=t.gl,i=Mq.gpuInputAssembler,r=Mq.glPrimitive,o=t.extensions.WEBGL_multi_draw;if(i){var a=i.gpuIndexBuffer;if(i.gpuIndirectBuffer){var s=i.gpuIndirectBuffer.indirects;if(s.drawByIndex){for(var c=0;c<s.drawCount;c++)s.byteOffsets[c]=s.offsets[c]*a.stride;if(o)s.instancedDraw?o.multiDrawElementsInstancedWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.instances,0,s.drawCount):o.multiDrawElementsWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.drawCount);else for(var l=0;l<s.drawCount;l++)s.instances[l]?n.drawElementsInstanced(r,s.counts[l],i.glIndexType,s.byteOffsets[l],s.instances[l]):n.drawElements(r,s.counts[l],i.glIndexType,s.byteOffsets[l])}else if(o)s.instancedDraw?o.multiDrawArraysInstancedWEBGL(r,s.offsets,0,s.counts,0,s.instances,0,s.drawCount):o.multiDrawArraysWEBGL(r,s.offsets,0,s.counts,0,s.drawCount);else for(var u=0;u<s.drawCount;u++)s.instances[u]?n.drawArraysInstanced(r,s.offsets[u],s.counts[u],s.instances[u]):n.drawArrays(r,s.offsets[u],s.counts[u])}else if(e.instanceCount)if(a){if(e.indexCount>0){var h=e.firstIndex*a.stride;n.drawElementsInstanced(r,e.indexCount,i.glIndexType,h,e.instanceCount)}}else e.vertexCount>0&&n.drawArraysInstanced(r,e.firstVertex,e.vertexCount,e.instanceCount);else if(a){if(e.indexCount>0){var _=e.firstIndex*a.stride;n.drawElements(r,e.indexCount,i.glIndexType,_)}}else e.vertexCount>0&&n.drawArrays(r,e.firstVertex,e.vertexCount)}}var Fq=new Array(gq.COUNT);function zq(t,e){Fq.fill(0);for(var n=0;n<e.cmds.length;++n){var i=e.cmds.array[n],r=Fq[i]++;switch(i){case gq.BEGIN_RENDER_PASS:var o=e.beginRenderPassCmds.array[r];Oq(t,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case gq.BIND_STATES:var a=e.bindStatesCmds.array[r];Nq(t,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case gq.DRAW:Lq(t,e.drawCmds.array[r].drawInfo);break;case gq.UPDATE_BUFFER:var s=e.updateBufferCmds.array[r];Rq(t,s.gpuBuffer,s.buffer,s.offset,s.size);break;case gq.COPY_BUFFER_TO_TEXTURE:var c=e.copyBufferToTextureCmds.array[r];Vq(t,c.buffers,c.gpuTexture,c.regions)}}}function Vq(t,e,n,i){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=na[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=e[a++];u?n.glInternalFmt!==cq.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var p=0;p<i.length;p++){var d=i[p],m=d.texSubres.baseArrayLayer+d.texSubres.layerCount;for(l=d.texSubres.baseArrayLayer;l<m;++l){s=d.texExtent.width,c=d.texExtent.height;var v=e[a++];u?n.glInternalFmt!==cq.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,v):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Ar.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var Gq=function(){function t(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var e=t.prototype;return e.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},e.setDrawInfo=function(t,e){this._ensureCapacity(t),this.drawByIndex=e.indexCount>0,this.instancedDraw=!!e.instanceCount,this.drawCount=Math.max(t+1,this.drawCount),this.drawByIndex?(this.counts[t]=e.indexCount,this.offsets[t]=e.firstIndex):(this.counts[t]=e.vertexCount,this.offsets[t]=e.firstVertex),this.instances[t]=Math.max(1,e.instanceCount)},e._ensureCapacity=function(t){if(!(this._capacity>t)){this._capacity=Mn(t);var e=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),e.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=e,this.offsets=n,this.instances=i}},t}(),Uq=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuBuffer=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){if("buffer"in t){this._isBufferView=!0;var e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:e.gpuBuffer.indirects,glTarget:e.gpuBuffer.glTarget,glBuffer:e.gpuBuffer.glBuffer,glOffset:t.offset}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:new Gq,glTarget:0,glBuffer:null,glOffset:0},function(t,e){var n=t.gl,i=t.stateCache,r=e.memUsage&yr.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(e.usage&mr.VERTEX){e.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(e.glBuffer=o,e.size>0&&(t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),Mq.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer),n.bufferData(n.ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null))}else if(e.usage&mr.INDEX){e.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(e.glBuffer=a,e.size>0&&(t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),Mq.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null))}else if(e.usage&mr.UNIFORM){e.glTarget=n.UNIFORM_BUFFER;var s=n.createBuffer();s&&e.size>0&&(e.glBuffer=s,t.stateCache.glUniformBuffer!==e.glBuffer&&(n.bindBuffer(n.UNIFORM_BUFFER,e.glBuffer),t.stateCache.glUniformBuffer=e.glBuffer),n.bufferData(n.UNIFORM_BUFFER,e.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null)}else e.usage&mr.INDIRECT||e.usage&mr.TRANSFER_DST||e.usage&mr.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE}(uq.instance,this._gpuBuffer),uq.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(this._isBufferView||(function(t,e){var n=t.gl,i=t.stateCache;if(e.glBuffer){switch(e.glTarget){case n.ARRAY_BUFFER:t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),t.stateCache.glVAO=null),Mq.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),t.stateCache.glVAO=null),Mq.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null;break;case n.UNIFORM_BUFFER:n.bindBuffer(n.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null}n.deleteBuffer(e.glBuffer),e.glBuffer=null}}(uq.instance,this._gpuBuffer),uq.instance.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)},n.resize=function(t){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var e=this._size;e!==t&&(this._size=t,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=t,t>0&&(function(t,e){var n=t.gl,i=t.stateCache,r=e.memUsage&yr.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;e.usage&mr.VERTEX?(t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),Mq.gpuInputAssembler=null,i.glArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ARRAY_BUFFER,e.buffer,r):n.bufferData(n.ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),i.glArrayBuffer=null):e.usage&mr.INDEX?(t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),Mq.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):e.usage&mr.UNIFORM?(t.stateCache.glUniformBuffer!==e.glBuffer&&n.bindBuffer(n.UNIFORM_BUFFER,e.glBuffer),n.bufferData(n.UNIFORM_BUFFER,e.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null):(e.usage&mr.INDIRECT||e.usage&mr.TRANSFER_DST||e.usage&mr.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE)}(uq.instance,this._gpuBuffer),uq.instance.memoryStatus.bufferSize-=e,uq.instance.memoryStatus.bufferSize+=t)))}},n.update=function(t,e){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==e?e:this._usage&mr.INDIRECT?0:t.byteLength,Rq(uq.instance,this._gpuBuffer,t,0,n))},N(e,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),e}(fa),kq=function(){function t(t,e){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(e),this._freeCmds=new Xt(e);for(var n=0;n<e;++n)this._frees[n]=new t;this._freeIdx=e-1}var e=t.prototype;return e.alloc=function(t){if(this._freeIdx<0){var e=2*this._frees.length,n=this._frees;this._frees=new Array(e);for(var i=e-n.length,r=0;r<i;++r)this._frees[r]=new t;for(var o=i,a=0;o<e;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},e.free=function(t){0==--t.refCount&&this._freeCmds.push(t)},e.freeCmds=function(t){for(var e=0;e<t.length;++e)0==--t.array[e].refCount&&this._freeCmds.push(t.array[e])},e.release=function(){for(var t=0;t<this._freeCmds.length;++t){var e=this._freeCmds.array[t];e.clear(),this._frees[++this._freeIdx]=e}this._freeCmds.clear()},t}(),Hq=function(){function t(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new kq(bq,1),this.bindStatesCmdPool=new kq(Tq,1),this.drawCmdPool=new kq(Eq,1),this.updateBufferCmdPool=new kq(wq,1),this.copyBufferToTextureCmdPool=new kq(Pq,1)}var e=t.prototype;return e.clearCmds=function(t){t.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(t.beginRenderPassCmds),t.beginRenderPassCmds.clear()),t.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(t.bindStatesCmds),t.bindStatesCmds.clear()),t.drawCmds.length&&(this.drawCmdPool.freeCmds(t.drawCmds),t.drawCmds.clear()),t.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(t.updateBufferCmds),t.updateBufferCmds.clear()),t.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(t.copyBufferToTextureCmds),t.copyBufferToTextureCmds.clear()),t.cmds.clear()},e.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},t}(),jq=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).cmdPackage=new Iq,e._cmdAllocator=new Hq,e._isInRenderPass=!1,e._curGPUPipelineState=null,e._curGPUDescriptorSets=[],e._curGPUInputAssembler=null,e._curDynamicOffsets=Array(8).fill(0),e._curDynamicStates=new ta,e._isStateInvalied=!1,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._type=t.type,this._queue=t.queue;for(var e=uq.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<e;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(t,e,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(bq);a.gpuRenderPass=t.gpuRenderPass,a.gpuFramebuffer=e.gpuFramebuffer,a.renderArea=n;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(gq.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(t){var e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)},n.bindDescriptorSet=function(t,e,n){var i=e.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[t],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(t){var e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0},n.setViewport=function(t){var e=this._curDynamicStates.viewport;e.left===t.left&&e.top===t.top&&e.width===t.width&&e.height===t.height&&e.minDepth===t.minDepth&&e.maxDepth===t.maxDepth||(e.left=t.left,e.top=t.top,e.width=t.width,e.height=t.height,e.minDepth=t.minDepth,e.maxDepth=t.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(t){var e=this._curDynamicStates.scissor;e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height||(e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,this._isStateInvalied=!0)},n.setLineWidth=function(t){this._curDynamicStates.lineWidth!==t&&(this._curDynamicStates.lineWidth=t,this._isStateInvalied=!0)},n.setDepthBias=function(t,e,n){var i=this._curDynamicStates;i.depthBiasConstant===t&&i.depthBiasClamp===e&&i.depthBiasSlope===n||(i.depthBiasConstant=t,i.depthBiasClamp=e,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(t){var e=this._curDynamicStates.blendConstant;e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w||(e.copy(t),this._isStateInvalied=!0)},n.setDepthBound=function(t,e){var n=this._curDynamicStates;n.depthMinBounds===t&&n.depthMaxBounds===e||(n.depthMinBounds=t,n.depthMaxBounds=e,this._isStateInvalied=!0)},n.setStencilWriteMask=function(t,e){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;t&Hr.FRONT&&n.writeMask!==e&&(n.writeMask=e,this._isStateInvalied=!0),t&Hr.BACK&&i.writeMask!==e&&(i.writeMask=e,this._isStateInvalied=!0)},n.setStencilCompareMask=function(t,e,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;t&Hr.FRONT&&(i.compareMask===n&&i.reference===e||(i.reference=e,i.compareMask=n,this._isStateInvalied=!0)),t&Hr.BACK&&(r.compareMask===n&&r.reference===e||(r.reference=e,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(t){if(this._type===Xr.PRIMARY&&this._isInRenderPass||this._type===Xr.SECONDARY){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t,n=this._cmdAllocator.drawCmdPool.alloc(Eq);n.drawInfo.copy(e),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(gq.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(t,e,n){if(this._type===Xr.PRIMARY&&!this._isInRenderPass||this._type===Xr.SECONDARY){var i=t.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(wq),a=0;t.usage&mr.INDIRECT||(a=void 0!==n?n:e.byteLength),r=e,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(gq.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(t,e,n){if(this._type===Xr.PRIMARY&&!this._isInRenderPass||this._type===Xr.SECONDARY){var i=e.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(Pq);r.gpuTexture=i,r.regions=n,r.buffers=t,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(gq.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(t,e){for(var n=0;n<e;++n){for(var i=t[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var t=this._cmdAllocator.bindStatesCmdPool.alloc(Tq);t.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(t.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(t.dynamicOffsets,this._curDynamicOffsets),t.gpuInputAssembler=this._curGPUInputAssembler,t.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(t),this.cmdPackage.cmds.push(gq.BIND_STATES),this._isStateInvalied=!1},e}(pa),Wq=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuFramebuffer=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[],this._depthStencilTexture=t.depthStencilTexture||null;for(var e=[],n=0;n<t.colorTextures.length;n++){var i=t.colorTextures[n];i&&e.push(i.gpuTexture)}var r=null;t.depthStencilTexture&&(r=t.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:t.renderPass.gpuRenderPass,gpuColorTextures:e,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(t){o=t},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(t){a=t}},function(t,e){for(var n=0;n<e.gpuColorTextures.length;++n)if(e.gpuColorTextures[n].isSwapchainTexture)return void(e.isOffscreen=!1);var i=t.gl,r=[],o=i.createFramebuffer();if(o){e.glFramebuffer=o,t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.glFramebuffer);for(var a=0;a<e.gpuColorTextures.length;++a){var s=e.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),e.width=Math.min(e.width,s.width),e.height=Math.min(e.height,s.height))}var c=e.gpuDepthStencilTexture;if(c){var l=na[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),e.width=Math.min(e.width,c.width),e.height=Math.min(e.height,c.height)}i.drawBuffers(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.stateCache.glFramebuffer)}}(uq.instance,this._gpuFramebuffer)},n.destroy=function(){var t,e;this._gpuFramebuffer&&(t=uq.instance,(e=this._gpuFramebuffer).glFramebuffer&&(t.gl.deleteFramebuffer(e.glFramebuffer),t.stateCache.glFramebuffer===e.glFramebuffer&&(t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null),t.stateCache.glFramebuffer=null),e.glFramebuffer=null),this._gpuFramebuffer=null)},N(e,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),e}(va),qq=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuInputAssembler=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){if(0!==t.vertexBuffers.length){if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var e=this._vertexBuffers[0];this._drawInfo.vertexCount=e.size/e.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;for(var n=new Array(t.vertexBuffers.length),i=0;i<t.vertexBuffers.length;++i){var r=t.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(t.indexBuffer&&(o=t.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Illegal index buffer stride.")}var s=null;t.indirectBuffer&&(s=t.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(t,e){var n=t.gl;e.glAttribs=new Array(e.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<e.attributes.length;++r){var o=e.attributes[r],a=void 0!==o.stream?o.stream:0,s=e.gpuVertexBuffers[a],c=fq(o.format,n),l=na[o.format].size;e.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:na[o.format].count,stride:s.stride,componentCount:vq(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(uq.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var t=uq.instance;this._gpuInputAssembler&&t.extensions.useVAO&&function(t,e){for(var n=e.glVAOs.values(),i=n.next(),r=t.gl,o=t.stateCache.glVAO;!i.done;)r.deleteVertexArray(i.value),o===i.value&&(r.bindVertexArray(null),o=null),i=n.next();t.stateCache.glVAO=o,e.glVAOs.clear()}(t,this._gpuInputAssembler),this._gpuInputAssembler=null},N(e,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),e}(Aa),Xq=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuDescriptorSetLayout=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){Array.prototype.push.apply(this._bindings,t.bindings);for(var e=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(e),e+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&oa)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:e}},n.destroy=function(){this._bindings.length=0},N(e,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),e}(ba),Yq=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuPipelineLayout=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);for(var e=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),e.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:e,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},N(e,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),e}(Ta),Kq=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],Jq=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuPipelineState=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;var e=this._bs;if(t.blendState){var n=t.blendState,i=n.targets;i&&i.forEach((function(t,n){e.setTarget(n,t)})),void 0!==n.isA2C&&(e.isA2C=n.isA2C),void 0!==n.isIndepend&&(e.isIndepend=n.isIndepend),void 0!==n.blendColor&&(e.blendColor=n.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:Kq[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.gpuPipelineLayout,rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},N(e,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),e}(Da),Qq=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.beginRenderPass=function(t,e,n,i,r,o){Oq(uq.instance,t.gpuRenderPass,e.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(t){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t;Lq(uq.instance,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var n=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(t){var e=uq.instance,n=e.stateCache,i=e.gl;n.viewport.left===t.left&&n.viewport.top===t.top&&n.viewport.width===t.width&&n.viewport.height===t.height||(i.viewport(t.left,t.top,t.width,t.height),n.viewport.left=t.left,n.viewport.top=t.top,n.viewport.width=t.width,n.viewport.height=t.height)},n.setScissor=function(t){var e=uq.instance,n=e.stateCache,i=e.gl;n.scissorRect.x===t.x&&n.scissorRect.y===t.y&&n.scissorRect.width===t.width&&n.scissorRect.height===t.height||(i.scissor(t.x,t.y,t.width,t.height),n.scissorRect.x=t.x,n.scissorRect.y=t.y,n.scissorRect.width=t.width,n.scissorRect.height=t.height)},n.updateBuffer=function(t,e,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=t.gpuBuffer;r&&(i=void 0!==n?n:t.usage&mr.INDIRECT?0:e.byteLength,Rq(uq.instance,r,e,0,i))}},n.copyBuffersToTexture=function(t,e,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=e.gpuTexture;i&&Vq(uq.instance,t,i,n)}},n.execute=function(t,e){for(var n=0;n<e;++n){var i=t[n];zq(uq.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){Nq(uq.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},e}(jq),Zq=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).numDrawCalls=0,e.numInstances=0,e.numTris=0,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._type=t.type},n.destroy=function(){},n.submit=function(t){for(var e=0;e<t.length;e++){var n=t[e];this.numDrawCalls+=n.numDrawCalls,this.numInstances+=n.numInstances,this.numTris+=n.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},e}(Ba),$q=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuRenderPass=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,this._subpasses=t.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},N(e,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),e}(Ma),tX=function(t){function e(e,n){var i,r,o,a,s;return(i=t.call(this,e,n)||this)._gpuSampler=null,i._gpuSampler={glSampler:null,minFilter:i._info.minFilter,magFilter:i._info.magFilter,mipFilter:i._info.mipFilter,addressU:i._info.addressU,addressV:i._info.addressV,addressW:i._info.addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0},r=uq.instance,o=i._gpuSampler,(s=(a=r.gl).createSampler())&&(o.minFilter===Tr.LINEAR||o.minFilter===Tr.ANISOTROPIC?o.mipFilter===Tr.LINEAR||o.mipFilter===Tr.ANISOTROPIC?o.glMinFilter=a.LINEAR_MIPMAP_LINEAR:o.mipFilter===Tr.POINT?o.glMinFilter=a.LINEAR_MIPMAP_NEAREST:o.glMinFilter=a.LINEAR:o.mipFilter===Tr.LINEAR||o.mipFilter===Tr.ANISOTROPIC?o.glMinFilter=a.NEAREST_MIPMAP_LINEAR:o.mipFilter===Tr.POINT?o.glMinFilter=a.NEAREST_MIPMAP_NEAREST:o.glMinFilter=a.NEAREST,o.magFilter===Tr.LINEAR||o.magFilter===Tr.ANISOTROPIC?o.glMagFilter=a.LINEAR:o.glMagFilter=a.NEAREST,o.glWrapS=hq[o.addressU],o.glWrapT=hq[o.addressV],o.glWrapR=hq[o.addressW],o.glSampler=s,a.samplerParameteri(s,a.TEXTURE_MIN_FILTER,o.glMinFilter),a.samplerParameteri(s,a.TEXTURE_MAG_FILTER,o.glMagFilter),a.samplerParameteri(s,a.TEXTURE_WRAP_S,o.glWrapS),a.samplerParameteri(s,a.TEXTURE_WRAP_T,o.glWrapT),a.samplerParameteri(s,a.TEXTURE_WRAP_R,o.glWrapR),a.samplerParameterf(s,a.TEXTURE_MIN_LOD,0),a.samplerParameterf(s,a.TEXTURE_MAX_LOD,1e3)),i}return F(e,t),e.prototype.destroy=function(){this._gpuSampler&&(function(t,e){var n=t.gl;if(e.glSampler){n.deleteSampler(e.glSampler);for(var i=t.stateCache.glSamplerUnits,r=0;r<i.length;++r)i[r]===e.glSampler&&(n.bindSampler(r,null),i[r]=null);e.glSampler=null}}(uq.instance,this._gpuSampler),this._gpuSampler=null)},N(e,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),e}(Oa),eX=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuShader=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks.slice(),samplerTextures:t.samplerTextures.slice(),subpassInputs:t.subpassInputs.slice(),gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var e=0;e<t.stages.length;++e){var n=t.stages[e];this._gpuShader.gpuStages[e]={type:n.stage,source:n.source,glShader:null}}!function(t,e){for(var n=t.gl,i=function(t){var i=e.gpuStages[t],r=0,o="",a=1;switch(i.type){case Br.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Br.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,"#version 300 es\n"+i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+e.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<e.gpuStages.length;c++){var l=e.gpuStages[t];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<e.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){e.glProgram=a;for(var s=0;s<e.gpuStages.length;s++){var c=e.gpuStages[s];n.attachShader(e.glProgram,c.glShader)}n.linkProgram(e.glProgram);for(var l=0;l<e.gpuStages.length;l++){var u=e.gpuStages[l];u.glShader&&(n.detachShader(e.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(e.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+e.name+"'."),void console.error(n.getProgramInfoLog(e.glProgram));v("Shader '"+e.name+"' compilation succeeded.");var h=n.getProgramParameter(e.glProgram,n.ACTIVE_ATTRIBUTES);e.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(e.glProgram,_);if(f){var p,m=f.name.indexOf("[");p=-1!==m?f.name.substr(0,m):f.name;var g=n.getAttribLocation(e.glProgram,p),y=dq(f.type,n),x=mq(f.type,n);e.glInputs[_]={name:p,type:y,stride:x,count:f.size,size:x*f.size,glType:f.type,glLoc:g}}}var S,A,C,b,T=n.getProgramParameter(e.glProgram,n.ACTIVE_UNIFORM_BLOCKS);if(T){e.glBlocks=new Array(T);for(var E=0;E<T;++E){var w=(S=n.getActiveUniformBlockName(e.glProgram,E)).indexOf("[");-1!==w&&(S=S.substr(0,w)),b=null;for(var P=0;P<e.blocks.length;P++)if(e.blocks[P].name===S){b=e.blocks[P];break}if(b){A=E,C=n.getActiveUniformBlockParameter(e.glProgram,A,n.UNIFORM_BLOCK_DATA_SIZE);var I=b.binding+(t.bindingMappingInfo.bufferOffsets[b.set]||0);n.uniformBlockBinding(e.glProgram,A,I),e.glBlocks[E]={set:b.set,binding:b.binding,idx:A,name:S,size:C,glBinding:I}}else d("Block '"+S+"' does not bound")}}for(var R=0;R<e.subpassInputs.length;++R){var D=e.subpassInputs[R];e.samplerTextures.push(new To(D.set,D.binding,D.name,dr.SAMPLER2D,D.count))}if(e.samplerTextures.length>0){e.glSamplerTextures=new Array(e.samplerTextures.length);for(var B=0;B<e.samplerTextures.length;++B){var M=e.samplerTextures[B];e.glSamplerTextures[B]={set:M.set,binding:M.binding,name:M.name,type:M.type,count:M.count,units:[],glUnits:null,glType:pq(M.type,n),glLoc:null}}}for(var O=[],N=[],L=t.stateCache.texUnitCacheMap,F=0,z=0;z<e.blocks.length;++z)e.blocks[z].set===t.bindingMappingInfo.flexibleSet&&F++;for(var V=0,G=0;G<e.samplerTextures.length;++G){var U=e.samplerTextures[G],k=n.getUniformLocation(e.glProgram,U.name);if(k&&-1!==k.id&&(O.push(e.glSamplerTextures[G]),N.push(k)),void 0===L[U.name]){var H=U.binding+t.bindingMappingInfo.samplerOffsets[U.set]+V;U.set===t.bindingMappingInfo.flexibleSet&&(H-=F),L[U.name]=H%t.capabilities.maxTextureUnits,V+=U.count-1}}if(O.length){for(var j=[],W=0;W<O.length;++W){var q=O[W],X=L[q.name];if(void 0!==X){q.glLoc=N[W];for(var Y=0;Y<q.count;++Y){for(;j[X];)X=(X+1)%t.capabilities.maxTextureUnits;q.units.push(X),j[X]=!0}}}for(var K=0,J=0;J<O.length;++J){var Q=O[J];if(!Q.glLoc){for(Q.glLoc=N[J];j[K];)K++;for(var Z=0;Z<Q.count;++Z){for(;j[K];)K=(K+1)%t.capabilities.maxTextureUnits;void 0===L[Q.name]&&(L[Q.name]=K),Q.units.push(K),j[K]=!0}}}t.stateCache.glProgram!==e.glProgram&&n.useProgram(e.glProgram);for(var $=0;$<O.length;$++){var tt=O[$];tt.glUnits=new Int32Array(tt.units),n.uniform1iv(tt.glLoc,tt.glUnits)}t.stateCache.glProgram!==e.glProgram&&n.useProgram(t.stateCache.glProgram)}e.glSamplerTextures=O}}(uq.instance,this._gpuShader)},n.destroy=function(){var t,e;this._gpuShader&&(t=uq.instance,(e=this._gpuShader).glProgram&&(t.gl.deleteProgram(e.glProgram),t.stateCache.glProgram===e.glProgram&&(t.gl.useProgram(null),t.stateCache.glProgram=null),e.glProgram=null),this._gpuShader=null)},N(e,[{key:"gpuShader",get:function(){return this._gpuShader}}]),e}(Na),nX=function(){function t(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new lo,this.scissorRect=new no(0,0,0,0),this.rs=new Ea,this.dss=new wa,this.bs=new Ia,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return t.prototype.initialize=function(t,e,n){for(var i=0;i<t;++i)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=t,this.glSamplerUnits.fill(null),this.glBindUBOs.length=e,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=e,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=n,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=n,this.glCurrentAttribLocs.fill(!1)},t}(),iX=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuTexture=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t,e){"texture"in t?console.log("WebGL2 does not support texture view."):(this._type=t.type,this._usage=t.usage,this._format=t.format,this._width=t.width,this._height=t.height,this._depth=t.depth,this._layerCount=t.layerCount,this._levelCount=t.levelCount,this._samples=t.samples,this._flags=t.flags,this._isPowerOf2=aa(this._width)&&aa(this._height),this._size=ca(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:e||!1},Dq(uq.instance,this._gpuTexture),uq.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){this._gpuTexture&&(Bq(uq.instance,this._gpuTexture),uq.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(t,e){var n=this._size;this._width=t,this._height=e,this._size=ca(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=e,this._gpuTexture.size=this._size,function(t,e){if(e.size){var n=t.gl,i=e.width,r=e.height;switch(e.type){case xr.TEX2D:e.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>t.capabilities.maxTextureSize&&E(9100,o,t.capabilities.maxTextureSize),e.samples===Cr.ONE){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),na[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=sa(e.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,e.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else Bq(t,e),Dq(t,e)}else e.glRenderbuffer&&(t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,e.samples,e.glInternalFmt,e.width,e.height));break;case xr.CUBE:e.type=xr.CUBE,e.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);u>t.capabilities.maxCubeMapTextureSize&&E(9100,u,t.capabilities.maxTextureSize);var h=t.stateCache.glTexUnits[t.stateCache.texUnit];if(h.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),h.glTexture=e.glTexture),na[e.format].isCompressed)for(var _=0;_<6;++_){i=e.width,r=e.height;for(var f=0;f<e.mipLevel;++f){var p=sa(e.format,i,r,1),d=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+_,f,e.glInternalFmt,i,r,0,d),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else Bq(t,e),Dq(t,e);break;default:console.error("Unsupported TextureType, create texture failed."),e.type=xr.TEX2D,e.glTarget=n.TEXTURE_2D}}}(uq.instance,this._gpuTexture),uq.instance.memoryStatus.textureSize-=n,uq.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(t){var e=new xo;e.format=t.format,e.usage=na[t.format].hasDepth?Sr.DEPTH_STENCIL_ATTACHMENT:Sr.COLOR_ATTACHMENT,e.width=t.width,e.height=t.height,this.initialize(e,!0)},N(e,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),e}(La),rX="webglcontextlost";function oX(t,e){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=t.getExtension(n[i]+e);if(r)return r}return null}function aX(t){var e={EXT_texture_filter_anisotropic:oX(t,"EXT_texture_filter_anisotropic"),EXT_color_buffer_half_float:oX(t,"EXT_color_buffer_half_float"),EXT_color_buffer_float:oX(t,"EXT_color_buffer_float"),WEBGL_compressed_texture_etc1:oX(t,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:oX(t,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:oX(t,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_astc:oX(t,"WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_s3tc:oX(t,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:oX(t,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:oX(t,"WEBGL_debug_shaders"),WEBGL_lose_context:oX(t,"WEBGL_lose_context"),WEBGL_debug_renderer_info:oX(t,"WEBGL_debug_renderer_info"),OES_texture_half_float_linear:oX(t,"OES_texture_half_float_linear"),OES_texture_float_linear:oX(t,"OES_texture_float_linear"),WEBGL_multi_draw:null,useVAO:!0};return dn.os!==hn.ANDROID&&dn.os!==hn.IOS&&(e.WEBGL_multi_draw=oX(t,"WEBGL_multi_draw")),e}var sX=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).stateCache=new nX,e.nullTex2D=null,e.nullTexCube=null,e._canvas=null,e._webGL2ContextLostHandler=null,e._extensions=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){this._canvas=t.windowHandle,this._webGL2ContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(rX,this._onWebGLContextLost);var e=uq.instance.gl;this.stateCache.initialize(uq.instance.capabilities.maxTextureUnits,uq.instance.capabilities.maxUniformBufferBindings,uq.instance.capabilities.maxVertexAttributes),this._extensions=aX(e),function(t){t.activeTexture(t.TEXTURE0),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindFramebuffer(t.FRAMEBUFFER,null),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW),t.polygonOffset(0,0),t.enable(t.DEPTH_TEST),t.depthMask(!0),t.depthFunc(t.LESS),t.stencilFuncSeparate(t.FRONT,t.ALWAYS,1,65535),t.stencilOpSeparate(t.FRONT,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.FRONT,65535),t.stencilFuncSeparate(t.BACK,t.ALWAYS,1,65535),t.stencilOpSeparate(t.BACK,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.BACK,65535),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.BLEND),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}(e);var n=fr.RGBA8,i=fr.DEPTH_STENCIL,r=e.getParameter(e.DEPTH_BITS),o=e.getParameter(e.STENCIL_BITS);r&&o?i=fr.DEPTH_STENCIL:r&&(i=fr.DEPTH),this._colorTexture=new iX,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:t.width,height:t.height}),this._depthStencilTexture=new iX,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:t.width,height:t.height}),this.nullTex2D=uq.instance.createTexture(new xo(xr.TEX2D,Sr.SAMPLED,fr.RGBA8,2,2,Ar.NONE)),this.nullTexCube=uq.instance.createTexture(new xo(xr.CUBE,Sr.SAMPLED,fr.RGBA8,2,2,Ar.NONE,6));var a=new co;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),uq.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,uq.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGL2ContextLostHandler&&(this._canvas.removeEventListener(rX,this._webGL2ContextLostHandler),this._webGL2ContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(t,e){this._colorTexture.width===t&&this._colorTexture.height===e||(v("Resizing swapchain: "+t+"x"+e),this._canvas.width=t,this._canvas.height=e,this._colorTexture.resize(t,e),this._depthStencilTexture.resize(t,e))},n._onWebGLContextLost=function(t){b(11e3),p(t)},N(e,[{key:"extensions",get:function(){return this._extensions}}]),e}(ma),cX=t("WebGL2Device",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._swapchain=null,e._context=null,e}F(e,t);var n=e.prototype;return n.initialize=function(t){uq.setInstance(this),this._gfxAPI=ur.WEBGL2,this._bindingMappingInfo=t.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var e=this._context=function(t){var e=null;try{var n={alpha:ee.ENABLE_TRANSPARENT_CANVAS,antialias:ee.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};e=t.getContext("webgl2",n)}catch(t){return null}return e}(da.canvas);if(!e)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Ko(Wr.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Yo(this._queue)),this._caps.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=e.getParameter(e.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.uboOffsetAlignment=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT);var n=e.getSupportedExtensions(),i="";if(n)for(var r,o=W(n);!(r=o()).done;)i+=r.value+" ";var a=aX(e);a.WEBGL_debug_renderer_info?(this._renderer=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=e.getParameter(e.RENDERER),this._vendor=e.getParameter(e.VENDOR));var s=e.getParameter(e.VERSION);this._features.fill(!1),this._features[_r.TEXTURE_FLOAT]=!0,this._features[_r.TEXTURE_HALF_FLOAT]=!0,this._features[_r.FORMAT_R11G11B10F]=!0,this._features[_r.FORMAT_SRGB]=!0,this._features[_r.FORMAT_RGB8]=!0,this._features[_r.ELEMENT_INDEX_UINT]=!0,this._features[_r.INSTANCED_ARRAYS]=!0,this._features[_r.MULTIPLE_RENDER_TARGETS]=!0,this._features[_r.BLEND_MINMAX]=!0,a.EXT_color_buffer_float&&(this._features[_r.COLOR_FLOAT]=!0,this._features[_r.COLOR_HALF_FLOAT]=!0),a.OES_texture_float_linear&&(this._features[_r.TEXTURE_FLOAT_LINEAR]=!0),a.OES_texture_half_float_linear&&(this._features[_r.TEXTURE_HALF_FLOAT_LINEAR]=!0);var c="";return a.WEBGL_compressed_texture_etc1&&(this._features[_r.FORMAT_ETC1]=!0,c+="etc1 "),a.WEBGL_compressed_texture_etc&&(this._features[_r.FORMAT_ETC2]=!0,c+="etc2 "),a.WEBGL_compressed_texture_s3tc&&(this._features[_r.FORMAT_DXT]=!0,c+="dxt "),a.WEBGL_compressed_texture_pvrtc&&(this._features[_r.FORMAT_PVRTC]=!0,c+="pvrtc "),a.WEBGL_compressed_texture_astc&&(this._features[_r.FORMAT_ASTC]=!0,c+="astc "),v("WebGL2 device initialized."),v("RENDERER: "+this._renderer),v("VENDOR: "+this._vendor),v("VERSION: "+s),v("COMPRESSED_FORMAT: "+c),v("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);for(var t=this._samplers.values(),e=t.next();!e.done;)e.value.destroy(),e=t.next();this._swapchain=null},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()},n.createCommandBuffer=function(t){var e=new(t.type===Xr.PRIMARY?Qq:jq);return e.initialize(t),e},n.createSwapchain=function(t){var e=new sX;return this._swapchain=e,e.initialize(t),e},n.createBuffer=function(t){var e=new Uq;return e.initialize(t),e},n.createTexture=function(t){var e=new iX;return e.initialize(t),e},n.createDescriptorSet=function(t){var e=new lq;return e.initialize(t),e},n.createShader=function(t){var e=new eX;return e.initialize(t),e},n.createInputAssembler=function(t){var e=new qq;return e.initialize(t),e},n.createRenderPass=function(t){var e=new $q;return e.initialize(t),e},n.createFramebuffer=function(t){var e=new Wq;return e.initialize(t),e},n.createDescriptorSetLayout=function(t){var e=new Xq;return e.initialize(t),e},n.createPipelineLayout=function(t){var e=new Yq;return e.initialize(t),e},n.createPipelineState=function(t){var e=new Jq;return e.initialize(t),e},n.createQueue=function(t){var e=new Zq;return e.initialize(t),e},n.getSampler=function(t){var e=Oa.computeHash(t);return this._samplers.has(e)||this._samplers.set(e,new tX(t,e)),this._samplers.get(e)},n.getGlobalBarrier=function(t){var e=Fa.computeHash(t);return this._globalBarriers.has(e)||this._globalBarriers.set(e,new Fa(t,e)),this._globalBarriers.get(e)},n.getTextureBarrier=function(t){var e=za.computeHash(t);return this._textureBarriers.has(e)||this._textureBarriers.set(e,new za(t,e)),this._textureBarriers.get(e)},n.copyBuffersToTexture=function(t,e,n){Vq(this,t,e.gpuTexture,n)},n.copyTextureToBuffers=function(t,e,n){!function(t,e,n,i){var r=t.gl,o=t.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(e.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,e.glTarget,e.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,e.glFormat,e.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,t.gpuTexture,e,n)},n.copyTexImagesToTexture=function(t,e,n){!function(t,e,n,i){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,e[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,e[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Ar.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}(this,t,e.gpuTexture,n)},N(e,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),e}(da));i.WebGL2Device=cX;var lX=[new Bo(Zr.ATTR_POSITION,fr.RGB32F)],uX=[new Bo(Zr.ATTR_POSITION,fr.RGB32F),new Bo(Zr.ATTR_COLOR,fr.RGBA32F)],hX=[new Bo(Zr.ATTR_POSITION,fr.RGB32F),new Bo(Zr.ATTR_TEX_COORD,fr.RG32F),new Bo(Zr.ATTR_COLOR,fr.RGBA32F)],_X=[new Bo(Zr.ATTR_POSITION,fr.RGB32F),new Bo(Zr.ATTR_TEX_COORD,fr.RG32F),new Bo(Zr.ATTR_COLOR,fr.RGBA32F),new Bo(Zr.ATTR_COLOR2,fr.RGBA32F)];function fX(t){for(var e=0,n=0;n<t.length;n++){var i=t[n];e+=na[i.format].count}return e}function pX(t){for(var e=0,n=0;n<t.length;n++){var i=t[n];e+=na[i.format].size}return e}i.internal.vfmtPosUvColor=hX,i.internal.vfmtPosUvTwoColor=_X;var dX=new oi,mX=new Ei;function vX(t,e,n,i){var r=n.chunk,o=n.data,a=r.vb,s=n.vertexCount;t.getWorldMatrix(mX);for(var c=0,l=0;l<s;l++){var u=o[l];oi.set(dX,u.x,u.y,0),oi.transformMat4(dX,dX,mX),a[c++]=dX.x,a[c++]=dX.y,a[c++]=dX.z,Li.toArray(a,i,c+2),c+=6}for(var h=r.bufferId,_=r.vertexOffset,f=r.vertexAccessor.getMeshBuffer(r.bufferId),p=r.vertexAccessor.getIndexBuffer(h),d=f.indexOffset,m=0,v=s/4;m<v;m++){var g=_+4*m;p[d++]=g,p[d++]=g+1,p[d++]=g+2,p[d++]=g+1,p[d++]=g+3,p[d++]=g+2}f.indexOffset+=n.indexCount,f.setDirty()}var gX=function(){function t(t,e){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var n=new yX;n.initWithSize(t,e),this._texture=n,this._width=t,this._height=e,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}var e=t.prototype;return e.insertSpriteFrame=function(t){var e=t.rect,n=t.texture,r=this._innerTextureInfos[n.getId()],o=e.x,a=e.y;if(r)o+=r.x,a+=r.y;else{var s=n.width,c=n.height;if(this._x+s+2>this._width&&(this._x=2,this._y=this._nexty),this._y+c+2>this._nexty&&(this._nexty=this._y+c+2),this._nexty>this._height)return null;i.internal.dynamicAtlasManager.textureBleeding&&((s<=8||c<=8)&&(this._texture.drawTextureAt(n.image,this._x-1,this._y-1),this._texture.drawTextureAt(n.image,this._x-1,this._y+1),this._texture.drawTextureAt(n.image,this._x+1,this._y-1),this._texture.drawTextureAt(n.image,this._x+1,this._y+1)),this._texture.drawTextureAt(n.image,this._x-1,this._y),this._texture.drawTextureAt(n.image,this._x+1,this._y),this._texture.drawTextureAt(n.image,this._x,this._y-1),this._texture.drawTextureAt(n.image,this._x,this._y+1)),this._texture.drawTextureAt(n.image,this._x,this._y),this._innerTextureInfos[n.getId()]={x:this._x,y:this._y,texture:n},this._count++,o+=this._x,a+=this._y,this._x+=s+2}var l={x:o,y:a,texture:this._texture};return this._innerSpriteFrames.push(t),l},e.deleteInnerTexture=function(t){t&&this._innerTextureInfos[t.getId()]&&(delete this._innerTextureInfos[t.getId()],this._count--)},e.isEmpty=function(){return this._count<=0},e.reset=function(){this._x=2,this._y=2,this._nexty=2;for(var t=this._innerSpriteFrames,e=0,n=t.length;e<n;e++){var i=t[e];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}},e.destroy=function(){this.reset(),this._texture.destroy()},t}(),yX=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.initWithSize=function(t,e,n){void 0===n&&(n=Xd.RGBA8888),this.reset({width:t,height:e,format:n})},n.drawTextureAt=function(t,e,n){var i=this.getGFXTexture();if(t&&i){var r=this._getGFXDevice();if(r){var o=new co;o.texOffset.x=e,o.texOffset.y=n,o.texExtent.width=t.width,o.texExtent.height=t.height,r.copyTexImagesToTexture([t.data],i,[o])}else console.warn("Unable to get device")}},e}(jm),xX=function(){function t(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}var e=t.prototype;return e.newAtlas=function(){var t=this._atlases[++this._atlasIndex];return t||(t=new gX(this._textureSize,this._textureSize),this._atlases.push(t)),t},e.beforeSceneLoad=function(){this.reset()},e.insertSpriteFrame=function(t){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!t||t._original)return null;if(!t.packable)return null;var e=t.texture.getSamplerInfo();if(e.minFilter!==Kd.LINEAR||e.magFilter!==Kd.LINEAR||e.mipFilter!==Kd.NONE)return null;var n=this._atlases[this._atlasIndex];n||(n=this.newAtlas());var i=n.insertSpriteFrame(t);return i||this._atlasIndex===this._maxAtlasCount?i:(n=this.newAtlas()).insertSpriteFrame(t)},e.reset=function(){for(var t=0,e=this._atlases.length;t<e;t++)this._atlases[t].destroy();this._atlases.length=0,this._atlasIndex=-1},e.deleteAtlasSpriteFrame=function(t){if(t._original){for(var e,n=this._atlases.length-1;n>=0;n--)e=this._atlases[n],kt.array.fastRemove(e._innerSpriteFrames,t);var i=t._original._texture;this.deleteAtlasTexture(i)}},e.deleteAtlasTexture=function(t){if(t)for(var e=this._atlases.length-1;e>=0;e--)this._atlases[e].deleteInnerTexture(t),this._atlases[e].isEmpty()&&(this._atlases[e].destroy(),this._atlases.splice(e,1),this._atlasIndex--)},e.packToDynamicAtlas=function(t,e){if(e&&!e._original&&e.packable){var n=this.insertSpriteFrame(e);n&&e._setDynamicAtlasFrame(n)}},N(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(t?(this.reset(),i.director.on(i.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),i.director.off(i.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=t)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(t){this._maxAtlasCount=t}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(t){this._textureBleeding=t}},{key:"textureSize",get:function(){return this._textureSize},set:function(t){this._textureSize=t}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(t){this._maxFrameSize=t}}]),t}();xX.instance=void 0;var SX,AX,CX,bX=t("dynamicAtlasManager",xX.instance=new xX);i.internal.dynamicAtlasManager=bX;var TX,EX,wX,PX,IX=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],RX=t("SpriteFrame",qc("cc.SpriteFrame")((CX=AX=function(t){function e(){var e;return(e=t.call(this)||this).vertices=null,e.uv=[],e.unbiasUV=[],e.uvSliced=[],e._rect=new Mi,e._offset=new li,e._originalSize=new Di,e._rotated=!1,e._capInsets=[0,0,0,0],e._atlasUuid="",e._texture=void 0,e._isFlipUVY=!1,e._isFlipUVX=!1,e._original=null,e._packable=!0,e}F(e,t),e.createWithImage=function(t){var n=t instanceof ym?t:new ym(t),i=new jm;i.image=n;var r=new e;return r.texture=i,r};var n=e.prototype;return n.textureLoaded=function(){return!!this.texture},n.isRotated=function(){return this._rotated},n.setRotated=function(t){this.rotated=t},n.getRect=function(t){return t?(t.set(this._rect),t):this._rect.clone()},n.setRect=function(t){this.rect=t},n.getOriginalSize=function(t){return t?(t.set(this._originalSize),t):this._originalSize.clone()},n.setOriginalSize=function(t){this.originalSize=t},n.getOffset=function(t){return t?(t.set(this._offset),t):this._offset.clone()},n.setOffset=function(t){this.offset=t},n.getGFXTexture=function(){return this._texture.getGFXTexture()},n.getGFXSampler=function(){return this._texture.getGFXSampler()},n.getHash=function(){return this._texture.getHash()},n.getSamplerInfo=function(){return this._texture.getSamplerInfo()},n.reset=function(t,e){void 0===e&&(e=!1);var n=!1;e&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),t&&(t.texture&&(this._rect.x=this._rect.y=0,this._rect.width=t.texture.width,this._rect.height=t.texture.height,this._refreshTexture(t.texture),this.checkRect(this._texture)),t.originalSize&&this._originalSize.set(t.originalSize),t.rect&&this._rect.set(t.rect),t.offset&&this._offset.set(t.offset),void 0!==t.borderTop&&(this._capInsets[1]=t.borderTop),void 0!==t.borderBottom&&(this._capInsets[3]=t.borderBottom),void 0!==t.borderLeft&&(this._capInsets[0]=t.borderLeft),void 0!==t.borderRight&&(this._capInsets[2]=t.borderRight),void 0!==t.isRotate&&(this._rotated=!!t.isRotate),void 0!==t.isFlipUv&&(this._isFlipUVY=!!t.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()},n.checkRect=function(t){var e=this._rect,n=e.x,i=e.y;return this._rotated?(n+=e.height,i+=e.width):(n+=e.width,i+=e.height),n>t.width?(E(3300,this.name+"/"+t.name,n,t.width),!1):!(i>t.height&&(E(3301,this.name+"/"+t.name,i,t.height),1))},n.destroy=function(){return this._packable&&bX&&bX.deleteAtlasSpriteFrame(this),t.prototype.destroy.call(this)},n._calculateSlicedUV=function(){var t=this._rect,n=this.texture,i=n.width,r=n.height,o=this._capInsets[0],a=this._capInsets[2],s=t.width-o-a,c=this._capInsets[1],l=this._capInsets[3],u=t.height-c-l,h=this.uvSliced;if(h.length=0,this._rotated){IX[0].u=t.x/i,IX[1].u=(t.x+l)/i,IX[2].u=(t.x+l+u)/i,IX[3].u=(t.x+t.height)/i,IX[3].v=t.y/r,IX[2].v=(t.y+o)/r,IX[1].v=(t.y+o+s)/r,IX[0].v=(t.y+t.width)/r;for(var _=0;_<4;++_)for(var f=IX[_],p=0;p<4;++p){var d=IX[3-p];h.push({u:f.u,v:d.v})}}else{IX[0].u=t.x/i,IX[1].u=(t.x+o)/i,IX[2].u=(t.x+o+s)/i,IX[3].u=(t.x+t.width)/i,IX[3].v=t.y/r,IX[2].v=(t.y+c)/r,IX[1].v=(t.y+c+u)/r,IX[0].v=(t.y+t.height)/r;for(var m=0;m<4;++m)for(var v=IX[m],g=0;g<4;++g){var y=IX[g];h.push({u:y.u,v:v.v})}}this.emit(e.EVENT_UV_UPDATED,this)},n._calculateUV=function(){var t=this._rect,e=this.uv,n=this.unbiasUV,i=this.texture,r=i.width,o=i.height;if(this._rotated){var a=0===r?0:t.x/r,s=0===r?1:(t.x+t.height)/r,c=0===o?0:t.y/o,l=0===o?1:(t.y+t.width)/o;this._isFlipUVX&&this._isFlipUVY?(e[0]=s,e[1]=l,e[2]=s,e[3]=c,e[4]=a,e[5]=l,e[6]=a,e[7]=c):this._isFlipUVX?(e[0]=s,e[1]=c,e[2]=s,e[3]=l,e[4]=a,e[5]=c,e[6]=a,e[7]=l):this._isFlipUVY?(e[0]=a,e[1]=l,e[2]=a,e[3]=c,e[4]=s,e[5]=l,e[6]=s,e[7]=c):(e[0]=a,e[1]=c,e[2]=a,e[3]=l,e[4]=s,e[5]=c,e[6]=s,e[7]=l);var u=0===r?0:t.x/r,h=0===r?1:(t.x+t.height)/r,_=0===o?0:t.y/o,f=0===o?1:(t.y+t.width)/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=f,n[2]=h,n[3]=_,n[4]=u,n[5]=f,n[6]=u,n[7]=_):this._isFlipUVX?(n[0]=h,n[1]=_,n[2]=h,n[3]=f,n[4]=u,n[5]=_,n[6]=u,n[7]=f):this._isFlipUVY?(n[0]=u,n[1]=f,n[2]=u,n[3]=_,n[4]=h,n[5]=f,n[6]=h,n[7]=_):(n[0]=u,n[1]=_,n[2]=u,n[3]=f,n[4]=h,n[5]=_,n[6]=h,n[7]=f)}else{var p=0===r?0:t.x/r,d=0===r?1:(t.x+t.width)/r,m=0===o?1:(t.y+t.height)/o,v=0===o?0:t.y/o;this._isFlipUVX&&this._isFlipUVY?(e[0]=d,e[1]=v,e[2]=p,e[3]=v,e[4]=d,e[5]=m,e[6]=p,e[7]=m):this._isFlipUVX?(e[0]=d,e[1]=m,e[2]=p,e[3]=m,e[4]=d,e[5]=v,e[6]=p,e[7]=v):this._isFlipUVY?(e[0]=p,e[1]=v,e[2]=d,e[3]=v,e[4]=p,e[5]=m,e[6]=d,e[7]=m):(e[0]=p,e[1]=m,e[2]=d,e[3]=m,e[4]=p,e[5]=v,e[6]=d,e[7]=v);var g=0===r?0:t.x/r,y=0===r?1:(t.x+t.width)/r,x=0===o?1:(t.y+t.height)/o,S=0===o?0:t.y/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=y,n[1]=S,n[2]=g,n[3]=S,n[4]=y,n[5]=x,n[6]=g,n[7]=x):this._isFlipUVX?(n[0]=y,n[1]=x,n[2]=g,n[3]=x,n[4]=y,n[5]=S,n[6]=g,n[7]=S):this._isFlipUVY?(n[0]=g,n[1]=S,n[2]=y,n[3]=S,n[4]=g,n[5]=x,n[6]=y,n[7]=x):(n[0]=g,n[1]=x,n[2]=y,n[3]=x,n[4]=g,n[5]=S,n[6]=y,n[7]=S)}var A=this.vertices;if(A){A.nu.length=0,A.nv.length=0;for(var C=0;C<A.u.length;C++)A.nu[C]=A.u[C]/r,A.nv[C]=A.v[C]/o}this._calculateSlicedUV()},n._setDynamicAtlasFrame=function(t){t&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=t.texture,this._rect.x=t.x,this._rect.y=t.y,this._calculateUV())},n._resetDynamicAtlasFrame=function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())},n._checkPackable=function(){var t=bX;if(t){var e=this._texture;if(e instanceof jm&&!e.isCompressed){var n=this.width,i=this.height;!e.image||n>t.maxFrameSize||i>t.maxFrameSize?this._packable=!1:e.image&&e.image instanceof HTMLCanvasElement&&(this._packable=!0)}else this._packable=!1}},n._serialize=function(){return null},n._deserialize=function(t){var e=t,n=e.rect;n&&(this._rect=new Mi(n.x,n.y,n.width,n.height));var i=e.offset;e.offset&&(this._offset=new li(i.x,i.y));var r=e.originalSize;e.originalSize&&(this._originalSize=new Di(r.width,r.height)),this._rotated=!!e.rotated,this._name=e.name,this._packable=!!e.packable;var o=e.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),this.vertices=e.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])},n.clone=function(){var t,n,i,r,o,a,s,c,l=new e,u=this.vertices;return l.vertices=u?{x:u.x,y:u.y,triangles:u.triangles,nu:null===(t=u.nu)||void 0===t?void 0:t.slice(0),u:null===(n=u.u)||void 0===n?void 0:n.slice(0),nv:null===(i=u.nv)||void 0===i?void 0:i.slice(0),v:null===(r=u.v)||void 0===r?void 0:r.slice(0)}:null,(o=l.uv).splice.apply(o,[0,l.uv.length].concat(this.uv)),(a=l.unbiasUV).splice.apply(a,[0,l.unbiasUV.length].concat(this.unbiasUV)),(s=l.uvSliced).splice.apply(s,[0,l.uvSliced.length].concat(this.uvSliced)),l._rect.set(this._rect),l._offset.set(this._offset),l._originalSize.set(this._originalSize),l._rotated=this._rotated,(c=l._capInsets).splice.apply(c,[0,l._capInsets.length].concat(this._capInsets)),l._atlasUuid=this._atlasUuid,l._texture=this._texture,l._isFlipUVX=this._isFlipUVX,l._isFlipUVY=this._isFlipUVY,l},n._refreshTexture=function(t){this._texture=t;var e=this._texture,n={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(n.rect=new Mi(0,0,e.width,e.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(n.originalSize=new Di(e.width,e.height),i=!0),i&&(this.reset(n),this.onLoaded()),this._checkPackable()},n.initDefault=function(e){t.prototype.initDefault.call(this,e);var n=new jm;n.initDefault(),this._refreshTexture(n),this._calculateUV()},n.validate=function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height},n._calculateTillingOffset=function(){this._rotated?(this.tillingOffset[0]=this.uv[4]-this.uv[0],this.tillingOffset[1]=this.uv[3]-this.uv[5],this.tillingOffset[2]=this.uv[0],this.tillingOffset[3]=this.uv[5],this.tillingOffset[0]=-this.tillingOffset[0]):(this.tillingOffset[0]=this.uv[2]-this.uv[0],this.tillingOffset[1]=this.uv[1]-this.uv[5],this.tillingOffset[2]=this.uv[4],this.tillingOffset[3]=this.uv[5])},n._calculateSlicedData=function(){var t=this._rect,e=this._capInsets[0],n=this._capInsets[2],i=t.width-e-n,r=this._capInsets[1],o=this._capInsets[3],a=t.height-r-o,s=this.slicedData;s.length=0,s[0]=e/t.width,s[1]=r/t.height,s[2]=(e+i)/t.width,s[3]=(r+a)/t.height},N(e,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(t){this._capInsets[1]!==t&&(this._capInsets[1]=t,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(t){this._capInsets[3]!==t&&(this._capInsets[3]=t,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(t){this._capInsets[0]!==t&&(this._capInsets[0]=t,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(t){this._capInsets[2]!==t&&(this._capInsets[2]=t,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(t){this._rect.equals(t)||(this._rect.set(t),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(t){this._originalSize.equals(t)||(this._originalSize.set(t),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset.set(t)}},{key:"rotated",get:function(){return this._rotated},set:function(t){this._rotated!==t&&(this._rotated=t,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(t){t?this.reset({texture:t},!0):console.warn("Error Texture in "+this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(t){this._atlasUuid=t}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(t){window.Build?this._texture=t:t&&(this._refreshTexture(t),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(t){this._isFlipUVX=t,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(t){this._isFlipUVY=t,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(t){this._packable=t}},{key:"original",get:function(){return this._original}}]),e}(Su),AX.EVENT_UV_UPDATED="uv_updated",SX=CX))||SX);i.SpriteFrame=RX;var DX,BX=t("SpriteAtlas",qc("cc.SpriteAtlas")((PX=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"spriteFrames",wX,H(e)),e}F(e,t);var n=e.prototype;return n.getTexture=function(){var t=Object.keys(this.spriteFrames);if(t.length>0){var e=this.spriteFrames[t[0]];return e&&e.texture}return null},n.getSpriteFrame=function(t){var e=this.spriteFrames[t];return e?(e.name||(e.name=t),e):null},n.getSpriteFrames=function(){for(var t=[],e=this.spriteFrames,n=0,i=Object.keys(e);n<i.length;n++){var r=i[n];t.push(e[r])}return t},n._serialize=function(){},n._deserialize=function(t,e){var n=t;this._name=n.name;var i=n.spriteFrames;this.spriteFrames=ft();for(var r=0;r<i.length;r+=2)e.result.push(this.spriteFrames,i[r],i[r+1],Vt(RX))},e}(Su),wX=X((EX=PX).prototype,"spriteFrames",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ft()}}),TX=EX))||TX);i.SpriteAtlas=BX;var MX,OX,NX,LX,FX=t("Font",qc("cc.Font")(DX=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(Su))||DX);i.Font=FX;var zX,VX,GX,UX,kX,HX,jX,WX,qX,XX=t("TTFFont",qc("cc.TTFFont")((LX=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_fontFamily",NX,H(e)),e}return F(e,t),e.prototype.initDefault=function(e){this._fontFamily="Arial",t.prototype.initDefault.call(this,e)},N(e,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(t){this._fontFamily=t||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:xn(this._native),__isNative__:!0}}}]),e}(FX),NX=X((OX=LX).prototype,"_fontFamily",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(OX.prototype,"_nativeAsset",[Ll,Tl],Object.getOwnPropertyDescriptor(OX.prototype,"_nativeAsset"),OX.prototype),X(OX.prototype,"_nativeDep",[Ll],Object.getOwnPropertyDescriptor(OX.prototype,"_nativeDep"),OX.prototype),MX=OX))||MX);i.TTFFont=XX;var YX,KX=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0},JX=function(){function t(t){this.letterDefinitions={},this.texture=t}var e=t.prototype;return e.addLetterDefinitions=function(t,e){this.letterDefinitions[t]=e},e.cloneLetterDefinition=function(){for(var t={},e=0,n=Object.keys(this.letterDefinitions);e<n.length;e++){var i=n[e],r=new KX;bt(r,this.letterDefinitions[i]),t[i]=r}return t},e.getTexture=function(){return this.texture},e.getLetter=function(t){return this.letterDefinitions[t]},e.getLetterDefinitionForChar=function(t){var e=t.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(e)?this.letterDefinitions[e]:null},e.clear=function(){this.letterDefinitions={}},t}(),QX=t("BitmapFont",(zX=qc("cc.BitmapFont"),VX=El(RX),zX((qX=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"fntDataStr",kX,H(e)),q(e,"spriteFrame",HX,H(e)),q(e,"fontSize",jX,H(e)),q(e,"fntConfig",WX,H(e)),e}return F(e,t),e.prototype.onLoaded=function(){var t=this.spriteFrame;!this.fontDefDictionary&&t&&(this.fontDefDictionary=new JX(t.texture));var e=this.fntConfig;if(e){var n=e.fontDefDictionary;for(var i in n){var r=new KX,o=n[i].rect;r.offsetX=n[i].xOffset,r.offsetY=n[i].yOffset,r.w=o.width,r.h=o.height,r.u=o.x,r.v=o.y,r.textureID=0,r.valid=!0,r.xAdvance=n[i].xAdvance,this.fontDefDictionary.addLetterDefinitions(i,r)}}else p("The fnt config is not exists!")},e}(FX),kX=X((UX=qX).prototype,"fntDataStr",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),HX=X(UX.prototype,"spriteFrame",[VX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jX=X(UX.prototype,"fontSize",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),WX=X(UX.prototype,"fntConfig",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),GX=UX))||GX));i.BitmapFont=QX;var ZX=t("LabelAtlas",qc("cc.LabelAtlas")(YX=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(QX))||YX);i.LabelAtlas=ZX;var $X=t("BASELINE_RATIO",.26),tY=t("MIDDLE_RATIO",($X+1)/2-$X);var eY=new Gt(2);eY.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var nY,iY=new(function(){function t(t){this.count=0,this.limit=0,this.datas={},this.limit=t}var e=t.prototype;return e.moveToHead=function(t){t.next=this.head,t.prev=null,this.head&&(this.head.prev=t),this.head=t,this.tail||(this.tail=t),this.count++,this.datas[t.key]=t},e.put=function(t,e){var n=eY.get();if(n.key=t,n.value=e,this.count>=this.limit){var i=this.tail;delete this.datas[i.key],this.count--,this.tail=i.prev,this.tail.next=null,i.prev=null,i.next=null,eY.put(i)}this.moveToHead(n)},e.remove=function(t){t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,delete this.datas[t.key],this.count--},e.get=function(t){var e=this.datas[t];return e?(this.remove(e),this.moveToHead(e),e.value):null},e.clear=function(){this.count=0,this.datas={},this.head=null,this.tail=null},e.has=function(t){return!!this.datas[t]},e.delete=function(t){var e=this.datas[t];this.remove(e)},t}())(100),rY=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,oY=/^[!,.:;'}\]%\?>、‘“》？。，！]/,aY=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+|\S)$/,sY=/[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+$/,cY=/^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]/;function lY(t){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(t)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(t)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(t)}function uY(t){var e=t.charCodeAt(0);return e>=9&&e<=13||32===e||133===e||160===e||5760===e||e>=8192&&e<=8202||8232===e||8233===e||8239===e||8287===e||12288===e}function hY(t,e,n){var i=(n||t.font)+"🎮"+e,r=iY.get(i);if(null!==r)return r;var o=t.measureText(e),a=o&&o.width||0;return iY.put(i,a),a}function _Y(t,e,n){var i=e,r=n,o=t[e];if(o>="\udc00"&&o<="\udfff"&&i--,void 0!==n)if(n-1!==e){var a=t[n-1];a>="\ud800"&&a<="\udbff"&&r--}else o>="\ud800"&&o<="\udbff"&&r++;return t.substring(i,r)}function fY(t,e,n,i){var r=[];if(0===t.length||n<0)return r.push(""),r;for(var o=t;e>n&&o.length>1;){for(var a=o.length*(n/e)|0,s=_Y(o,a),c=e-i(s),l=s,u=0,h=0;c>n&&h++<10;)a*=n/c,c=e-i(s=_Y(o,a|=0));for(h=0;c<=n&&h++<10;){if(s){var _=rY.exec(s);u=_?_[0].length:1,l=s}c=e-i(s=_Y(o,a+=u))}0==(a-=u)?(a=1,l=_Y(o,1)):1===a&&o[0]>="\ud800"&&o[0]<="\udbff"&&(a=2,l=_Y(o,2));var f=_Y(o,0,a),p=void 0;oY.test(l||s)&&(0==(a-=(p=aY.exec(f))?p[0].length:0)&&(a=1),l=_Y(o,a),f=_Y(o,0,a)),cY.test(l)&&(p=sY.exec(f))&&f!==p[0]&&(l=_Y(o,a-=p[0].length),f=_Y(o,0,a)),(0===r.length||(f=f.trim()).length>0)&&r.push(f),e=i(o=l||s)}return(0===r.length||(o=o.trim()).length>0)&&r.push(o),r}var pY,dY,mY,vY,gY,yY,xY,SY,AY,CY,bY,TY,EY,wY,PY,IY=t("CanvasPool",function(){function t(){this.pool=[]}t.getInstance=function(){return nY||(nY=new t),nY};var e=t.prototype;return e.get=function(){var t=this.pool.pop();if(!t){var e=document.createElement("canvas"),n=e.getContext("2d");t={canvas:e,context:n}}return t},e.put=function(t){this.pool.length>=ee.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(t)},t}()),RY=Li.WHITE.clone(),DY=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},BY="rgba(255, 255, 255, "+(1/255).toFixed(3)+")",MY=function(){function t(t,e){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=t,this.labelInfo=e,this.hash=t.charCodeAt(0)+e.hash}var e=t.prototype;return e.updateRenderData=function(){this._updateProperties(),this._updateTexture()},e.destroy=function(){this.image=null},e._updateProperties=function(){if(this.data=IY.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var t=hY(this.context,this.char,this.labelInfo.fontDesc),e=2*this.labelInfo.margin+2;this.width=parseFloat(t.toFixed(2))+e,this.height=(1+$X)*this.labelInfo.fontSize+e,this.offsetY=-this.labelInfo.fontSize*$X/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new ym),this.image.reset(this.canvas)},e._updateTexture=function(){if(this.context&&this.canvas){var t=this.context,e=this.labelInfo,n=this.canvas.width,i=this.canvas.height;t.textAlign="center",t.textBaseline="alphabetic",t.clearRect(0,0,n,i),t.fillStyle=BY,t.fillRect(0,0,n,i),t.font=e.fontDesc;var r=e.fontSize,o=n/2,a=i/2+r*tY+0*r,s=e.color;if(t.lineJoin="round",t.fillStyle="rgba("+s.r+", "+s.g+", "+s.b+", 1)",e.isOutlined){var c=e.out||RY;t.strokeStyle="rgba("+c.r+", "+c.g+", "+c.b+", "+c.a/255+")",t.lineWidth=2*e.margin,t.strokeText(this.char,o,a)}t.fillText(this.char,o,a)}},t}(),OY=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.initWithSize=function(t,e,n){void 0===n&&(n=Xd.RGBA8888),this.reset({width:t,height:e,format:n})},n.drawTextureAt=function(t,e,n){var i=this.getGFXTexture();if(t&&i){var r=this._getGFXDevice();if(r){var o=new co;o.texOffset.x=e,o.texOffset.y=n,o.texExtent.width=t.width,o.texExtent.height=t.height,r.copyTexImagesToTexture([t.data],i,[o])}else console.warn("Unable to get device")}},e}(jm),NY=function(){function t(t,e){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var n=new OY;n.initWithSize(t,e),this.fontDefDictionary=new JX(n),this._halfBleed=1,this._width=t,this._height=e,LM.on(NM.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}var e=t.prototype;return e.insertLetterTexture=function(t){var e=t.image,n=LM.root.device;if(!e||!this.fontDefDictionary||!n)return null;var i=e.width,r=e.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return b(12100),null;this.fontDefDictionary.texture.drawTextureAt(e,this._x,this._y),this._dirty=!0;var o=new DY;return o.u=this._x+this._halfBleed,o.v=this._y+this._halfBleed,o.texture=this.fontDefDictionary.texture,o.valid=!0,o.w=t.width-2,o.h=t.height-2,o.xAdvance=o.w,o.offsetY=t.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(t.hash,o),o},e.update=function(){this._dirty&&(this._dirty=!1)},e.reset=function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()},e.destroy=function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)},e.getTexture=function(){return this.fontDefDictionary.getTexture()},e.beforeSceneLoad=function(){this.clearAllCache()},e.clearAllCache=function(){this.destroy();var t=new OY;t.initWithSize(this._width,this._height),this.fontDefDictionary.texture=t},e.getLetter=function(t){return this.fontDefDictionary.letterDefinitions[t]},e.getLetterDefinitionForChar=function(t,e){var n=t.charCodeAt(0)+e.hash,i=this.fontDefDictionary.letterDefinitions[n];if(!i){var r=new MY(t,e);r.updateRenderData(),i=this.insertLetterTexture(r),r.destroy()}return i},N(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),t}(),LY={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:Li.WHITE.clone(),isOutlined:!1,out:Li.WHITE.clone(),margin:0},FY=pX(hX)>>2,zY=t("BaseRenderData",function(){function t(t){void 0===t&&(t=hX),this.material=null,this.chunk=null,this.dataHash=0,this.isMeshBuffer=!1,this._vc=0,this._ic=0,this._floatStride=0,this._vertexFormat=hX,this._floatStride=t===hX?FY:pX(t)>>2,this._vertexFormat=t}var e=t.prototype;return e.isValid=function(){return this._ic>0&&this.chunk.vertexAccessor},e.resize=function(t,e){if(t!==this._vc||e!==this._ic||!this.chunk){this._vc=t,this._ic=e;var n=LM.root.batcher2D.switchBufferAccessor(this._vertexFormat);this.chunk&&(n.recycleChunk(this.chunk),this.chunk=null),this.chunk=n.allocateChunk(t,e)}},N(t,[{key:"vertexCount",get:function(){return this._vc}},{key:"indexCount",get:function(){return this._ic}},{key:"stride",get:function(){return this._floatStride<<2}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vertexFormat",get:function(){return this._vertexFormat}}]),t}()),VY=t("RenderData",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).vertDirty=!0,e._data=[],e._indices=[],e._pivotX=0,e._pivotY=0,e._width=0,e._height=0,e.frame=void 0,e.layer=0,e.blendHash=-1,e.textureHash=0,e.nodeDirty=!0,e.passDirty=!0,e.textureDirty=!0,e.hashDirty=!0,e}F(e,t),e.add=function(t){void 0===t&&(t=hX);var e=HY.add();return e._floatStride=t===hX?FY:pX(t)>>2,e._vertexFormat=t,e},e.remove=function(t){var e=HY.data.indexOf(t);-1!==e&&(HY.data[e].clear(),HY.removeAt(e))};var n=e.prototype;return n.resize=function(e,n){t.prototype.resize.call(this,e,n),this.updateHash()},n.updateNode=function(t){this.layer=t.node.layer,this.nodeDirty=!1,this.hashDirty=!0},n.updatePass=function(t){this.material=t.getRenderMaterial(0),this.blendHash=t.blendHash,this.passDirty=!1,this.hashDirty=!0},n.updateTexture=function(t){this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0},n.updateHash=function(){var t=""+(this.chunk?this.chunk.bufferId:-1)+this.layer+" "+this.blendHash+" "+this.textureHash;this.dataHash=xa(t,666),this.hashDirty=!1},n.updateRenderData=function(t,e){if(this.passDirty&&(this.material=t.getRenderMaterial(0),this.blendHash=t.blendHash,this.passDirty=!1,this.hashDirty=!0),this.nodeDirty){var n=t.node.scene?t._getRenderScene():null;this.layer=t.node.layer,null!==n&&(this.nodeDirty=!1),this.hashDirty=!0}this.textureDirty&&(this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0),this.hashDirty&&this.updateHash()},n.updateSizeNPivot=function(t,e,n,i){t===this._width&&e===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=t,this._height=e,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)},n.clear=function(){this.resize(0,0),this._data.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.vertDirty=!0,this.material=null,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.layer=0,this.blendHash=-1,this.frame=null,this.textureHash=0,this.dataHash=0,this._vertexFormat=hX},N(e,[{key:"dataLength",get:function(){return this._data.length},set:function(t){var e=this._data;if(e.length!==t){var n=e.length,i=0;for(i=t;i<n;i++)kY.free(e[i]);for(i=n;i<t;i++)e[i]=kY.alloc();e.length=t}}},{key:"data",get:function(){return this._data}}]),e}(zY)),GY=t("MeshRenderData",function(t){function e(e){var n;return void 0===e&&(e=hX),(n=t.call(this,e)||this).isMeshBuffer=!0,n.vData=void 0,n.iData=void 0,n.vertexStart=0,n.vertexRange=0,n.indexStart=0,n.indexRange=0,n.lastFilledIndex=0,n.lastFilledVertex=0,n._byteLength=0,n._vertexBuffers=[],n._indexBuffer=null,n._iaPool=null,n._iaInfo=null,n.vData=new Float32Array(256*n.stride),n.iData=new Uint16Array(1536),n}F(e,t),e.add=function(t){void 0===t&&(t=hX);var e=jY.add();return e._floatStride=t===hX?FY:pX(t)>>2,e._vertexFormat=t,e},e.remove=function(t){var e=jY.data.indexOf(t);-1!==e&&(jY.data[e].clear(),jY.removeAt(e))};var n=e.prototype;return n.request=function(t,e){var n=this._byteLength+t*this.stride;return!!this.reserve(t,e)&&(this._vc+=t,this._ic+=e,this._byteLength=n,!0)},n.reserve=function(t,e){var n=this._byteLength+t*this.stride,i=this.indexCount+e;if(t+this.vertexCount>65535)return!1;var r=this.vData.byteLength,o=this.iData.length,a=this.vData.length,s=this.iData.length;if(n>r||i>o){for(;r<n||o<i;)r=4*(a*=2),o=s*=2;this._reallocBuffer(a,s)}return!0},n.resize=function(t,e){var n=t*this.stride;t>=0&&e>=0&&n<=this.vData.byteLength&&this.iData.length,this._vc=t,this._ic=e,this._byteLength=n,this.updateRange(0,t,0,e)},n.updateRange=function(t,e,n,i){e>=0&&i>=0&&e<=this._vc&&this._ic,this.vertexStart=t,this.indexStart=n,this.vertexRange=e,this.indexRange=i},n.requestIA=function(t){this._initIAInfo(t);var e=this._iaPool.add();return e.firstIndex=this.indexStart,e.indexCount=this.indexRange,e},n.uploadBuffers=function(){if(0!==this._byteLength&&this._vertexBuffers[0]&&this._indexBuffer){var t=this._ic,e=new Float32Array(this.vData.buffer,0,this._byteLength>>2),n=new Uint16Array(this.iData.buffer,0,t),i=this._vertexBuffers[0];this._byteLength>i.size&&i.resize(this._byteLength),i.update(e);var r=t<<1;r>this._indexBuffer.size&&this._indexBuffer.resize(r),this._indexBuffer.update(n)}},n.freeIAPool=function(){this._iaPool&&this._iaPool.reset()},n.reset=function(){this._vc=0,this._ic=0,this._byteLength=0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.material=null,this.freeIAPool()},n.clear=function(){this.reset(),this._iaPool&&this._iaPool.destroy(),this._vertexBuffers[0]&&(this._vertexBuffers[0].destroy(),this._vertexBuffers=[]),this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)},n._initIAInfo=function(t){var e=this;if(!this._iaInfo){var n=this.stride,i=this._vertexBuffers;i.length||i.push(t.createBuffer(new po(mr.VERTEX|mr.TRANSFER_DST,yr.DEVICE,n,n)));var r=Uint16Array.BYTES_PER_ELEMENT;this._indexBuffer||(this._indexBuffer=t.createBuffer(new po(mr.INDEX|mr.TRANSFER_DST,yr.DEVICE,r,r))),this._iaInfo=new Oo(this._vertexFormat,i,this._indexBuffer),this._iaPool=new qt((function(){return t.createInputAssembler(e._iaInfo)}),1,(function(t){t.destroy()}))}},n._reallocBuffer=function(t,e){var n=this.vData;this.vData=new Float32Array(t),n&&this.vData.set(n,0);var i=this.iData;this.iData=new Uint16Array(e),i&&this.iData.set(i,0)},N(e,[{key:"formatByte",get:function(){return this.stride},set:function(){}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vDataOffset",get:function(){return this._byteLength>>>2}}]),e}(zY)),UY=t("QuadRenderData",function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n._fillQuadBuffer=function(){for(var t=this.iData.length/6,e=this.iData,n=0,i=0;n<t;n++){var r=4*n;e[i++]=r,e[i++]=r+1,e[i++]=r+2,e[i++]=r+1,e[i++]=r+3,e[i++]=r+2}},n._reallocBuffer=function(e,n){t.prototype._reallocBuffer.call(this,e,n),this._fillQuadBuffer()},e}(GY)),kY=new Wt((function(){return{x:0,y:0,z:0,u:0,v:0,color:Li.WHITE.clone()}}),128),HY=new qt((function(){return new VY}),32),jY=new qt((function(){return new GY}),32),WY=new li,qY=new li,XY=new oi,YY=new Ei,KY=new Ei,JY=new Ei,QY=new Ei(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),ZY=new Mi,$Y=t("UITransform",(pY=qc("cc.UITransform"),dY=cl(),mY=Yc(110),vY=rl(),gY=yl(),yY=fl(),xY=yl(),SY=fl(),pY(AY=dY(AY=mY(AY=vY(AY=Kc(AY=il((wY=EY=function(t){function e(){var e;return(e=t.call(this)||this)._priority=0,q(e,"_contentSize",bY,H(e)),q(e,"_anchorPoint",TY,H(e)),e}F(e,t);var n=e.prototype;return n.__preload=function(){this.node._uiProps.uiTransformComp=this},n.onLoad=function(){this.node.parent&&e.insertChangeMap(this.node.parent)},n.onEnable=function(){this.node.on(RC.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()},n.onDisable=function(){this.node.off(RC.PARENT_CHANGED,this._parentChanged,this)},n.onDestroy=function(){this.node._uiProps.uiTransformComp=null},n.setContentSize=function(t,e){var n=this._contentSize;if(void 0===e){if((t=t).width===n.width&&t.height===n.height)return;n.width=t.width,n.height=t.height}else{if(t===n.width&&e===n.height)return;n.width=t,n.height=e}this.node.emit(RC.SIZE_CHANGED),this._markRenderDataDirty()},n.setAnchorPoint=function(t,e){var n=this._anchorPoint;if(void 0===e){if((t=t).x===n.x&&t.y===n.y)return;n.x=t.x,n.y=t.y}else{if(t===n.x&&e===n.y)return;n.x=t,n.y=e}this.node.emit(RC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()},n.isHit=function(t){for(var e,n=this._contentSize.width,i=this._contentSize.height,r=WY,o=qY,a=null===(e=this.node)||void 0===e?void 0:e.eventProcessor,s=this._getRenderScene().cameras,c=0;c<s.length;c++){var l=s[c];if(l.visibility&this.node.layer){l.node.getWorldRT(YY);var u=YY.m12,h=YY.m13,_=kB.center;if(YY.m12=_.x-(YY.m00*u+YY.m04*h),YY.m13=_.y-(YY.m01*u+YY.m05*h),Ei.invert(YY,YY),li.transformMat4(r,t,YY),this.node.getWorldMatrix(JY),Ei.invert(YY,JY),!Ei.strictEquals(YY,QY)){li.transformMat4(o,r,YY),o.x+=this._anchorPoint.x*n,o.y+=this._anchorPoint.y*i;var f=!1;if(o.x>=0&&o.y>=0&&o.x<=n&&o.y<=i&&(f=!0,a&&a.maskList))for(var p=a.maskList,d=this.node,m=p?p.length:0,v=0,g=0;d&&g<m;++v,d=d.parent){var y=p[g];if(v===y.index){if(d!==y.comp.node){p.length=g;break}var x=y.comp;if(x&&x._enabled&&!x.isHit(r)){f=!1;break}g++}else if(v>y.index){p.length=g;break}}if(f)return!0}}}return!1},n.convertToNodeSpaceAR=function(t,e){return this.node.getWorldMatrix(JY),Ei.invert(YY,JY),e||(e=new oi),oi.transformMat4(e,t,YY)},n.convertToWorldSpaceAR=function(t,e){return this.node.getWorldMatrix(JY),e||(e=new oi),oi.transformMat4(e,t,JY)},n.getBoundingBox=function(){Ei.fromRTS(KY,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var t=this._contentSize.width,e=this._contentSize.height,n=new Mi(-this._anchorPoint.x*t,-this._anchorPoint.y*e,t,e);return n.transformMat4(KY),n},n.getBoundingBoxToWorld=function(){return this.node.parent?(this.node.parent.getWorldMatrix(JY),this.getBoundingBoxTo(JY)):this.getBoundingBox()},n.getBoundingBoxTo=function(t){Ei.fromRTS(KY,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var n=this._contentSize.width,i=this._contentSize.height,r=new Mi(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(Ei.multiply(JY,t,KY),r.transformMat4(JY),!this.node.children)return r;for(var o,a=W(this.node.children);!(o=a()).done;){var s=o.value;if(s&&s.active){var c=s.getComponent(e);if(c){var l=c.getBoundingBoxTo(t);l&&Mi.union(r,r,l)}}}return r},n.getComputeAABB=function(t){var e=this._contentSize.width,n=this._contentSize.height;ZY.set(-this._anchorPoint.x*e,-this._anchorPoint.y*n,e,n),ZY.transformMat4(this.node.worldMatrix);var i=ZY.x+.5*ZY.width,r=ZY.y+.5*ZY.height,o=this.node.worldPosition.z,a=ZY.width/2,s=ZY.height/2;return null!=t?(Cc.set(t,i,r,o,a,s,.001),t):new Cc(i,r,o,a,s,.001)},n._parentChanged=function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&e.insertChangeMap(this.node.parent)},n._markRenderDataDirty=function(){var t=this.node._uiProps.uiComp;t&&(t.markForUpdateRenderData(),t.renderData&&(t.renderData.vertDirty=!0))},n.checkAndUpdateRect=function(t,e){if(this._rectDirty){this._rectWithScale.x=e.x*this.width,this._rectWithScale.y=e.y*this.height,this._rectWithScale.z=e.z;var n=(.5-this.anchorPoint.x)*this.width*e.x,i=(.5-this.anchorPoint.y)*this.height*e.y;oi.transformQuat(this._anchorCache,XY.set(n,i,0),t)}},n.setRectDirty=function(t){t&Nd.RS&&(this._rectDirty=!0)},e.insertChangeMap=function(t){var n=t.uuid;e.priorityChangeNodeMap.has(n)||e.priorityChangeNodeMap.set(n,t)},e._sortChildrenSibling=function(t){var e=t.children;e&&e.sort((function(t,e){var n=t._uiProps.uiTransformComp,i=e._uiProps.uiTransformComp,r=(n?n._priority:0)-(i?i._priority:0);return 0===r?t.getSiblingIndex()-e.getSiblingIndex():r}))},e._sortSiblings=function(){e.priorityChangeNodeMap.forEach((function(t){e._sortChildrenSibling(t),t._updateSiblingIndex(),t.emit("childrenSiblingOrderChanged")})),e.priorityChangeNodeMap.clear()},e._cleanChangeMap=function(){e.priorityChangeNodeMap.clear()},N(e,[{key:"contentSize",get:function(){return this._contentSize},set:function(t){this._contentSize.equals(t)||(this._contentSize.set(t),this.node.emit(RC.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(t){this._contentSize.width!==t&&(this._contentSize.width=t,this.node.emit(RC.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(t){this.contentSize.height!==t&&(this._contentSize.height=t,this.node.emit(RC.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(t){this._anchorPoint.equals(t)||(this._anchorPoint.set(t),this.node.emit(RC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(t){this._anchorPoint.x!==t&&(this._anchorPoint.x=t,this.node.emit(RC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(t){this._anchorPoint.y!==t&&(this._anchorPoint.y=t,this.node.emit(RC.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority!==t&&(this.node.getComponent("cc.RenderRoot2D")?b(6706):(this._priority=t,this.node.parent&&e.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var t=LM.root.batcher2D.getFirstRenderCamera(this.node);return t?t.visibility:0}},{key:"cameraPriority",get:function(){var t=LM.root.batcher2D.getFirstRenderCamera(this.node);return t?t.priority:0}}]),e}(ku),EY.EventType=RC,EY.priorityChangeNodeMap=new Map,X((CY=wY).prototype,"contentSize",[gY,yY],Object.getOwnPropertyDescriptor(CY.prototype,"contentSize"),CY.prototype),X(CY.prototype,"anchorPoint",[xY,SY],Object.getOwnPropertyDescriptor(CY.prototype,"anchorPoint"),CY.prototype),bY=X(CY.prototype,"_contentSize",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Di(100,100)}}),TY=X(CY.prototype,"_anchorPoint",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new li(.5,.5)}}),AY=CY))||AY)||AY)||AY)||AY)||AY)||AY));LM.on(NM.EVENT_AFTER_UPDATE,$Y._sortSiblings),LM.on(NM.EVENT_BEFORE_SCENE_LAUNCH,$Y._cleanChangeMap),function(t){t[t.DISABLED=0]="DISABLED",t[t.CLEAR=1]="CLEAR",t[t.ENTER_LEVEL=2]="ENTER_LEVEL",t[t.ENABLED=3]="ENABLED",t[t.EXIT_LEVEL=4]="EXIT_LEVEL",t[t.CLEAR_INVERTED=5]="CLEAR_INVERTED",t[t.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(PY||(PY={}));var tK,eK,nK,iK,rK,oK,aK,sK,cK,lK,uK,hK,_K,fK,pK,dK,mK,vK,gK,yK,xK=t("StencilManager",function(){function t(){this.stage=PY.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:wr.ALWAYS,stencilMask:65535,writeMask:65535,failOp:Pr.KEEP,zFailOp:Pr.KEEP,passOp:Pr.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}var e=t.prototype;return e.pushMask=function(t){this._maskStack.push(t)},e.clear=function(t){t.stencilStage=t.inverted?PY.CLEAR_INVERTED:PY.CLEAR},e.enterLevel=function(t){t.graphics.stencilStage=t.inverted?PY.ENTER_LEVEL_INVERTED:PY.ENTER_LEVEL},e.enableMask=function(){this.stage=PY.ENABLED},e.exitMask=function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=PY.DISABLED:this.stage=PY.ENABLED)},e.getWriteMask=function(){return 1<<this._maskStack.length-1},e.getExitWriteMask=function(){return 1<<this._maskStack.length},e.getStencilRef=function(){for(var t=0,e=0;e<this._maskStack.length;++e)t+=1<<e;return t},e.reset=function(){this._maskStack.length=0,this.stage=PY.DISABLED},e.destroy=function(){this.stencilStateMap.forEach((function(t){t.destroy()})),this.stencilStateMap.clear()},e.getStencilStage=function(t,e){var n=0,i=!1,r=!1,o=wr.LESS,a=this.stencilStateMap;if(e&&e.passes[0]){var s=e.passes[0].depthStencilState,c=0,l=0;s.depthTest&&(c=1),s.depthWrite&&(l=1),n=c|l<<1|s.depthFunc<<2|t<<6|this._maskStack.length<<9,i=s.depthTest,r=s.depthWrite,o=s.depthFunc,a=this.stencilStateMapWithDepth}else n=t<<16|this._maskStack.length;if(a&&a.has(n))return a.get(n);this.setStateFromStage(t);var u=new wa(i,r,o,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return a.set(n,u),u},e.getStencilHash=function(t){return t<<8|this._maskStack.length},e.setStateFromStage=function(t){var e=this._stencilPattern;t===PY.DISABLED?(e.stencilTest=!1,e.func=wr.ALWAYS,e.failOp=Pr.KEEP,e.stencilMask=e.writeMask=65535,e.ref=1):(e.stencilTest=!0,t===PY.ENABLED?(e.func=wr.EQUAL,e.failOp=Pr.KEEP,e.stencilMask=e.ref=this.getStencilRef(),e.writeMask=this.getWriteMask()):t===PY.CLEAR?(e.func=wr.NEVER,e.failOp=Pr.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===PY.CLEAR_INVERTED||t===PY.ENTER_LEVEL?(e.func=wr.NEVER,e.failOp=Pr.REPLACE,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===PY.ENTER_LEVEL_INVERTED&&(e.func=wr.NEVER,e.failOp=Pr.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()))},N(t,[{key:"pattern",get:function(){return this._stencilPattern}}]),t}());xK.sharedManager=null,xK.sharedManager=new xK,$t(Ir),function(t){t[t.ADD_COLOR=0]="ADD_COLOR",t[t.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",t[t.GRAYSCALE=2]="GRAYSCALE",t[t.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",t[t.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(yK||(yK=t("InstanceMaterialType",{})));var SK,AK,CK,bK,TK,EK,wK,PK,IK,RK,DK,BK,MK,OK,NK,LK,FK,zK,VK,GK,UK,kK,HK,jK,WK,qK,XK,YK,KK,JK,QK,ZK,$K,tJ,eJ,nJ,iJ,rJ,oJ,aJ,sJ,cJ,lJ,uJ,hJ,_J,fJ,pJ,dJ,mJ,vJ,gJ,yJ,xJ,SJ,AJ,CJ,bJ,TJ,EJ,wJ,PJ,IJ,RJ,DJ,BJ,MJ,OJ,NJ,LJ,FJ=t("Renderable2D",(tK=qc("cc.Renderable2D"),eK=Xc($Y),nK=ul(),iK=El(hg),rK=El(hg),oK=yl(),aK=fl(),sK=_l(),cK=yl(),lK=fl(),tK(uK=eK(uK=Kc(uK=il((gK=vK=function(t){function e(){var e;return q(e=t.call(this)||this,"_materials",_K,H(e)),q(e,"_customMaterial",fK,H(e)),e.stencilStage=PY.DISABLED,q(e,"_srcBlendFactor",pK,H(e)),q(e,"_dstBlendFactor",dK,H(e)),q(e,"_color",mK,H(e)),e._assembler=null,e._postAssembler=null,e._renderData=null,e._renderDataFlag=!0,e._renderFlag=!0,e._delegateSrc=null,e._instanceMaterialType=-1,e._blendState=new Ia,e._blendHash=0,e._lastParent=null,e}F(e,t);var n=e.prototype;return n.updateBlendHash=function(){var t=this._blendState.targets[0].blendDst<<4;this._blendHash=t|this._blendState.targets[0].blendSrc},n.__preload=function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()},n.onEnable=function(){this.node.on(RC.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(RC.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()},n.onRestore=function(){this.updateMaterial(),this.markForUpdateRenderData()},n.onDisable=function(){this.node.off(RC.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(RC.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1},n.onDestroy=function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var t=0;t<this._materialInstances.length;t++){var e=this._materialInstances[t];e&&e.destroy()}this._renderData=null,this._blendState&&this._blendState.destroy()},n.markForUpdateRenderData=function(t){if(void 0===t&&(t=!0),this._renderFlag=this._canRender(),t&&this._renderFlag){var e=this._renderData;e&&(e.vertDirty=!0),this._renderDataFlag=t}else t||(this._renderDataFlag=t)},n.requestRenderData=function(){var t=VY.add();return this._renderData=t,t},n.destroyRenderData=function(){this._renderData&&(VY.remove(this._renderData),this._renderData=null)},n.updateAssembler=function(t){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1),this._renderFlag&&this._render(t)},n.postUpdateAssembler=function(t){this._postAssembler&&this._renderFlag&&this._postRender(t)},n._render=function(){},n._postRender=function(){},n._canRender=function(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this._color.a>0},n._postCanRender=function(){},n.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),this._renderData&&(this._renderData.material=this._customMaterial,this.markForUpdateRenderData(),this._renderData.passDirty=!0),void(this._blendHash=-1);var t=this._updateBuiltinMaterial();this.setMaterial(t,0),this._renderData&&(this._renderData.material=t,this.markForUpdateRenderData()),this._updateBlendFunc()},n._updateColor=function(){this.node._uiProps.colorDirty=!0,this._assembler&&(this._assembler.updateColor(this),this._renderFlag=this._canRender())},n._updateBlendFunc=function(){var t=this._blendState.targets[0];t||(t=new Pa,this._blendState.setTarget(0,t)),t.blendDst===this._dstBlendFactor&&t.blendSrc===this._srcBlendFactor||(t.blend=!0,t.blendDstAlpha=Ir.ONE_MINUS_SRC_ALPHA,t.blendDst=this._dstBlendFactor,t.blendSrc=this._srcBlendFactor,this.renderData&&(this.renderData.passDirty=!0)),this.updateBlendHash()},n.getBlendState=function(){return this._blendState},n._nodeStateChange=function(){this._renderData&&this.markForUpdateRenderData();for(var t=0;t<this.node.children.length;++t){var n=this.node.children[t].getComponent(e);n&&n.markForUpdateRenderData()}},n._onMaterialModified=function(e,n){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),t.prototype._onMaterialModified.call(this,e,n)},n._updateBuiltinMaterial=function(){var t;switch(this._instanceMaterialType){case yK.ADD_COLOR:t=Cv.get("ui-base-material");break;case yK.GRAYSCALE:t=Cv.get("ui-sprite-gray-material");break;case yK.USE_ALPHA_SEPARATED:t=Cv.get("ui-sprite-alpha-sep-material");break;case yK.USE_ALPHA_SEPARATED_AND_GRAY:t=Cv.get("ui-sprite-gray-alpha-sep-material");break;default:t=Cv.get("ui-sprite-material")}return t},n.setNodeDirty=function(){this.renderData&&(this.renderData.nodeDirty=!0)},n.setTextureDirty=function(){this.renderData&&(this.renderData.textureDirty=!0)},N(e,[{key:"sharedMaterials",get:function(){return this._materials},set:function(t){for(var e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(var n=t.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(t.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(t){this._customMaterial=t,this.updateMaterial()}},{key:"srcBlendFactor",get:function(){return this._customMaterial&&b(12001),this._srcBlendFactor},set:function(t){this._customMaterial?b(12001):this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._customMaterial&&b(12001),this._dstBlendFactor},set:function(t){this._customMaterial?b(12001):this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(t){this._color.equals(t)||(this._color.set(t),this._updateColor())}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(t){this._delegateSrc=t}},{key:"blendHash",get:function(){return this._blendHash}}]),e}(VL),vK.BlendState=Ir,vK.Assembler=null,vK.PostAssembler=null,_K=X((hK=gK).prototype,"_materials",[Ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),X(hK.prototype,"sharedMaterials",[Ll,nK],Object.getOwnPropertyDescriptor(hK.prototype,"sharedMaterials"),hK.prototype),fK=X(hK.prototype,"_customMaterial",[iK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(hK.prototype,"customMaterial",[rK,oK,aK,sK],Object.getOwnPropertyDescriptor(hK.prototype,"customMaterial"),hK.prototype),X(hK.prototype,"color",[cK,lK],Object.getOwnPropertyDescriptor(hK.prototype,"color"),hK.prototype),pK=X(hK.prototype,"_srcBlendFactor",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ir.SRC_ALPHA}}),dK=X(hK.prototype,"_dstBlendFactor",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ir.ONE_MINUS_SRC_ALPHA}}),mK=X(hK.prototype,"_color",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Li.WHITE.clone()}}),uK=hK))||uK)||uK)||uK)||uK));i.internal.Renderable2D=FJ,function(t){t[t.LEFT=0]="LEFT",t[t.CENTER=1]="CENTER",t[t.RIGHT=2]="RIGHT"}(MJ||(MJ=t("HorizontalTextAlignment",{}))),$t(MJ),function(t){t[t.TOP=0]="TOP",t[t.CENTER=1]="CENTER",t[t.BOTTOM=2]="BOTTOM"}(OJ||(OJ=t("VerticalTextAlignment",{}))),$t(OJ),function(t){t[t.NONE=0]="NONE",t[t.CLAMP=1]="CLAMP",t[t.SHRINK=2]="SHRINK",t[t.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(NJ||(NJ=t("Overflow",{}))),$t(NJ),function(t){t[t.NONE=0]="NONE",t[t.BITMAP=1]="BITMAP",t[t.CHAR=2]="CHAR"}(LJ||(LJ=t("CacheMode",{}))),$t(LJ);var zJ,VJ,GJ,UJ=t("Label",(SK=qc("cc.Label"),AK=cl(),CK=Yc(110),bK=rl(),TK=yl(),EK=fl(),wK=El(MJ),PK=yl(),IK=fl(),RK=El(OJ),DK=yl(),BK=fl(),MK=yl(),OK=fl(),NK=yl(),LK=ul(),FK=fl(),zK=yl(),VK=fl(),GK=ul(),UK=yl(),kK=fl(),HK=El(NJ),jK=yl(),WK=fl(),qK=yl(),XK=fl(),YK=El(FX),KK=yl(),JK=ul(),QK=fl(),ZK=yl(),$K=fl(),tJ=El(LJ),eJ=yl(),nJ=fl(),iJ=yl(),rJ=fl(),oJ=yl(),aJ=fl(),sJ=yl(),cJ=fl(),lJ=ul(),uJ=yl(),hJ=fl(),SK(_J=AK(_J=CK(_J=bK((BJ=DJ=function(t){function e(){var e;return q(e=t.call(this)||this,"_string",pJ,H(e)),q(e,"_horizontalAlign",dJ,H(e)),q(e,"_verticalAlign",mJ,H(e)),q(e,"_actualFontSize",vJ,H(e)),q(e,"_fontSize",gJ,H(e)),q(e,"_fontFamily",yJ,H(e)),q(e,"_lineHeight",xJ,H(e)),q(e,"_overflow",SJ,H(e)),q(e,"_enableWrapText",AJ,H(e)),q(e,"_font",CJ,H(e)),q(e,"_isSystemFontUsed",bJ,H(e)),q(e,"_spacingX",TJ,H(e)),q(e,"_isItalic",EJ,H(e)),q(e,"_isBold",wJ,H(e)),q(e,"_isUnderline",PJ,H(e)),q(e,"_underlineHeight",IJ,H(e)),q(e,"_cacheMode",RJ,H(e)),e._N$file=null,e._texture=null,e._ttfSpriteFrame=null,e._userDefinedFont=null,e._assemblerData=null,e._fontAtlas=null,e._letterTexture=null,e._ttfSpriteFrame=null,e}F(e,t);var n=e.prototype;return n.onEnable=function(){t.prototype.onEnable.call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()},n.onDestroy=function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){this._ttfSpriteFrame._resetDynamicAtlasFrame();var e=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),e){var n=e;n.image&&n.image.destroy(),e.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,t.prototype.onDestroy.call(this)},n.updateRenderData=function(t){void 0===t&&(t=!1),this.markForUpdateRenderData(),t&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))},n._render=function(t){t.commitComp(this,this.renderData,this._texture,this._assembler,null)},n._updateColor=function(){t.prototype._updateColor.call(this),this.updateRenderData(!1)},n._canRender=function(){if(!t.prototype._canRender.call(this)||!this._string)return!1;var e=this._font;if(e&&e instanceof QX){var n=e.spriteFrame;if(!n||!n.texture)return!1}return!0},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},n._applyFontTexture=function(){this.markForUpdateRenderData();var t=this._font;if(t instanceof QX){var e=t.spriteFrame;e&&e.texture&&(this._texture=e,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===LJ.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new RX,this._assemblerData=this._assembler.getAssemblerData();var n=new ym(this._assemblerData.canvas),i=new jm;i.image=n,this._ttfSpriteFrame.texture=i}this.cacheMode!==LJ.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}},n.changeMaterialForDefine=function(){if(this._texture){var t=!1;if(this.cacheMode!==LJ.CHAR){var e=this._texture.texture;if(e instanceof Sm){var n=e.getPixelFormat();t=n===Xd.RGBA_ETC1||n===Xd.RGB_A_PVRTC_4BPPV1||n===Xd.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=t?yK.USE_ALPHA_SEPARATED:yK.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},N(e,[{key:"string",get:function(){return this._string},set:function(t){t=null==t?"":t.toString(),this._string!==t&&(this._string=t,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(t){this._horizontalAlign!==t&&(this._horizontalAlign=t,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(t){this._verticalAlign!==t&&(this._verticalAlign=t,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(t){this._actualFontSize=t}},{key:"fontSize",get:function(){return this._fontSize},set:function(t){this._fontSize!==t&&(this._fontSize=t,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(t){this._fontFamily!==t&&(this._fontFamily=t,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(t){this._lineHeight!==t&&(this._lineHeight=t,this.updateRenderData())}},{key:"spacingX",get:function(){return this._spacingX},set:function(t){this._spacingX!==t&&(this._spacingX=t,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(t){this._overflow!==t&&(this._overflow=t,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(t){this._enableWrapText!==t&&(this._enableWrapText=t,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(t){this._font!==t&&(this._isSystemFontUsed=!t,this._font=t,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(t){this._isSystemFontUsed!==t&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!t,t&&(this.font=null),this._flushAssembler(),this.updateRenderData())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(t){this._cacheMode!==t&&(this._cacheMode!==LJ.BITMAP||this._font instanceof QX||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===LJ.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=t,this.updateRenderData(!0))}},{key:"isBold",get:function(){return this._isBold},set:function(t){this._isBold!==t&&(this._isBold=t,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(t){this._isItalic!==t&&(this._isItalic=t,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(t){this._isUnderline!==t&&(this._isUnderline=t,this.updateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(t){this._underlineHeight!==t&&(this._underlineHeight=t,this.updateRenderData())}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(t){this._fontAtlas=t}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof QX?this._font.fontSize:-1}}]),e}(FJ),DJ.HorizontalAlign=MJ,DJ.VerticalAlign=OJ,DJ.Overflow=NJ,DJ.CacheMode=LJ,DJ._canvasPool=IY.getInstance(),X((fJ=BJ).prototype,"string",[TK,EK,xl],Object.getOwnPropertyDescriptor(fJ.prototype,"string"),fJ.prototype),X(fJ.prototype,"horizontalAlign",[wK,PK,IK],Object.getOwnPropertyDescriptor(fJ.prototype,"horizontalAlign"),fJ.prototype),X(fJ.prototype,"verticalAlign",[RK,DK,BK],Object.getOwnPropertyDescriptor(fJ.prototype,"verticalAlign"),fJ.prototype),X(fJ.prototype,"fontSize",[MK,OK],Object.getOwnPropertyDescriptor(fJ.prototype,"fontSize"),fJ.prototype),X(fJ.prototype,"fontFamily",[NK,LK,FK],Object.getOwnPropertyDescriptor(fJ.prototype,"fontFamily"),fJ.prototype),X(fJ.prototype,"lineHeight",[zK,VK],Object.getOwnPropertyDescriptor(fJ.prototype,"lineHeight"),fJ.prototype),X(fJ.prototype,"spacingX",[GK,UK,kK],Object.getOwnPropertyDescriptor(fJ.prototype,"spacingX"),fJ.prototype),X(fJ.prototype,"overflow",[HK,jK,WK],Object.getOwnPropertyDescriptor(fJ.prototype,"overflow"),fJ.prototype),X(fJ.prototype,"enableWrapText",[qK,XK],Object.getOwnPropertyDescriptor(fJ.prototype,"enableWrapText"),fJ.prototype),X(fJ.prototype,"font",[YK,KK,JK,QK],Object.getOwnPropertyDescriptor(fJ.prototype,"font"),fJ.prototype),X(fJ.prototype,"useSystemFont",[ZK,$K],Object.getOwnPropertyDescriptor(fJ.prototype,"useSystemFont"),fJ.prototype),X(fJ.prototype,"cacheMode",[tJ,eJ,nJ],Object.getOwnPropertyDescriptor(fJ.prototype,"cacheMode"),fJ.prototype),X(fJ.prototype,"isBold",[iJ,rJ],Object.getOwnPropertyDescriptor(fJ.prototype,"isBold"),fJ.prototype),X(fJ.prototype,"isItalic",[oJ,aJ],Object.getOwnPropertyDescriptor(fJ.prototype,"isItalic"),fJ.prototype),X(fJ.prototype,"isUnderline",[sJ,cJ],Object.getOwnPropertyDescriptor(fJ.prototype,"isUnderline"),fJ.prototype),X(fJ.prototype,"underlineHeight",[lJ,ll,uJ,hJ],Object.getOwnPropertyDescriptor(fJ.prototype,"underlineHeight"),fJ.prototype),pJ=X(fJ.prototype,"_string",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),dJ=X(fJ.prototype,"_horizontalAlign",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return MJ.CENTER}}),mJ=X(fJ.prototype,"_verticalAlign",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OJ.CENTER}}),vJ=X(fJ.prototype,"_actualFontSize",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gJ=X(fJ.prototype,"_fontSize",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),yJ=X(fJ.prototype,"_fontFamily",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),xJ=X(fJ.prototype,"_lineHeight",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),SJ=X(fJ.prototype,"_overflow",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NJ.NONE}}),AJ=X(fJ.prototype,"_enableWrapText",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),CJ=X(fJ.prototype,"_font",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bJ=X(fJ.prototype,"_isSystemFontUsed",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),TJ=X(fJ.prototype,"_spacingX",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),EJ=X(fJ.prototype,"_isItalic",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wJ=X(fJ.prototype,"_isBold",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),PJ=X(fJ.prototype,"_isUnderline",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),IJ=X(fJ.prototype,"_underlineHeight",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),RJ=X(fJ.prototype,"_cacheMode",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return LJ.NONE}}),_J=fJ))||_J)||_J)||_J)||_J));!function(t){t[t.BUTT=0]="BUTT",t[t.ROUND=1]="ROUND",t[t.SQUARE=2]="SQUARE"}(zJ||(zJ={})),$t(zJ),function(t){t[t.BEVEL=0]="BEVEL",t[t.ROUND=1]="ROUND",t[t.MITER=2]="MITER"}(VJ||(VJ={})),$t(VJ),function(t){t[t.PT_CORNER=1]="PT_CORNER",t[t.PT_LEFT=2]="PT_LEFT",t[t.PT_BEVEL=4]="PT_BEVEL",t[t.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(GJ||(GJ={})),$t(GJ);var kJ=Math.PI,HJ=Math.min,jJ=Math.max,WJ=Math.cos,qJ=Math.sin,XJ=Math.abs,YJ=Math.sign,KJ=.5522847493;function JJ(t,e,n,i,r){t.moveTo(e-i,n),t.bezierCurveTo(e-i,n+r*KJ,e-i*KJ,n+r,e,n+r),t.bezierCurveTo(e+i*KJ,n+r,e+i,n+r*KJ,e+i,n),t.bezierCurveTo(e+i,n-r*KJ,e+i*KJ,n-r,e,n-r),t.bezierCurveTo(e-i*KJ,n-r,e-i,n-r*KJ,e-i,n),t.close()}function QJ(t,e,n,i,r,o,a,s,c,l,u){var h,_,f,p,d,m,v,g,y,x,S,A,C,b,T,E;l>10||(d=.5*(o+s),m=.5*(a+c),v=.5*((h=.5*(e+i))+(f=.5*(i+o))),g=.5*((_=.5*(n+r))+(p=.5*(r+a))),((T=XJ((i-s)*(b=c-n)-(r-c)*(C=s-e)))+(E=XJ((o-s)*b-(a-c)*C)))*(T+E)<t.tessTol*(C*C+b*b)?t.addPoint(s,c,0===u?u|GJ.PT_BEVEL:u):(QJ(t,e,n,h,_,v,g,S=.5*(v+(y=.5*(f+d))),A=.5*(g+(x=.5*(p+m))),l+1,0),QJ(t,S,A,y,x,d,m,s,c,l+1,u)))}var ZJ,$J,tQ,eQ,nQ,iQ,rQ,oQ,aQ,sQ,cQ,lQ,uQ,hQ,_Q,fQ,pQ,dQ,mQ,vQ,gQ,yQ,xQ,SQ,AQ,CQ,bQ,TQ,EQ,wQ,PQ,IQ,RQ,DQ,BQ,MQ,OQ,NQ,LQ,FQ,zQ,VQ,GQ,UQ,kQ,HQ,jQ,WQ,qQ,XQ=function(t){function e(e,n){var i;return(i=t.call(this,e,n)||this).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return F(e,t),e.prototype.reset=function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0},e}(li),YQ=function(){function t(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return t.prototype.reset=function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]},t}(),KQ=function(){function t(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=Li.WHITE.clone(),this.lineCap=zJ.BUTT,this.strokeColor=Li.BLACK.clone(),this.lineJoin=VJ.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}var e=t.prototype;return e.moveTo=function(t,e){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(t,e,GJ.PT_CORNER),this._commandX=t,this._commandY=e},e.lineTo=function(t,e){this.addPoint(t,e,GJ.PT_CORNER),this._commandX=t,this._commandY=e},e.bezierCurveTo=function(t,e,n,i,r,o){var a=this._curPath,s=a.points[a.points.length-1];s&&(s.x!==t||s.y!==e||n!==r||i!==o?(QJ(this,s.x,s.y,t,e,n,i,r,o,0,GJ.PT_CORNER),this._commandX=r,this._commandY=o):this.lineTo(r,o))},e.quadraticCurveTo=function(t,e,n,i){var r=this._commandX,o=this._commandY;this.bezierCurveTo(r+2/3*(t-r),o+2/3*(e-o),n+2/3*(t-n),i+2/3*(e-i),n,i)},e.arc=function(t,e,n,i,r,o){!function(t,e,n,i,r,o,a){var s,c,l=0,u=0,h=0,_=0,f=0,p=0,d=0,m=0,v=0,g=0,y=0,x=0,S=0,A=0;if(u=o-r,a=a||!1)if(XJ(u)>=2*kJ)u=2*kJ;else for(;u<0;)u+=2*kJ;else if(XJ(u)>=2*kJ)u=2*-kJ;else for(;u>0;)u-=2*kJ;for(c=0|jJ(1,HJ(XJ(u)/(.5*kJ)+.5,5)),h=XJ(4/3*(1-WJ(s=u/c/2))/qJ(s)),a||(h=-h),A=0;A<=c;A++)p=e+(_=WJ(l=r+u*(A/c)))*i,d=n+(f=qJ(l))*i,m=-f*i*h,v=_*i*h,0===A?t.moveTo(p,d):t.bezierCurveTo(g+x,y+S,p-m,d-v,p,d),g=p,y=d,x=m,S=v}(this,t,e,n,i,r,o)},e.ellipse=function(t,e,n,i){JJ(this,t,e,n,i),this._curPath.complex=!1},e.circle=function(t,e,n){JJ(this,t,e,n,n),this._curPath.complex=!1},e.rect=function(t,e,n,i){this.moveTo(t,e),this.lineTo(t+n,e),this.lineTo(t+n,e+i),this.lineTo(t,e+i),this.close(),this._curPath.complex=!1},e.roundRect=function(t,e,n,i,r){!function(t,e,n,i,r,o){if(o<.1)t.rect(e,n,i,r);else{var a=HJ(o,.5*XJ(i))*YJ(i),s=HJ(o,.5*XJ(r))*YJ(r);t.moveTo(e,n+s),t.lineTo(e,n+r-s),t.bezierCurveTo(e,n+r-s*(1-KJ),e+a*(1-KJ),n+r,e+a,n+r),t.lineTo(e+i-a,n+r),t.bezierCurveTo(e+i-a*(1-KJ),n+r,e+i,n+r-s*(1-KJ),e+i,n+r-s),t.lineTo(e+i,n+s),t.bezierCurveTo(e+i,n+s*(1-KJ),e+i-a*(1-KJ),n,e+i-a,n),t.lineTo(e+a,n),t.bezierCurveTo(e+a*(1-KJ),n,e,n+s*(1-KJ),e,n+s),t.close()}}(this,t,e,n,i,r),this._curPath.complex=!1},e.clear=function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var t=this._renderDataList,e=0,n=t.length;e<n;e++){var i=t[e];i&&GY.remove(i)}this._renderDataList.length=0},e.close=function(){this._curPath.closed=!0},e.requestRenderData=function(){var t=GY.add();return this._renderDataList.push(t),t},e.getRenderDataList=function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList},e.addPoint=function(t,e,n){var i=this._curPath;if(i){var r=this._points,o=i.points,a=r[this.pointsOffset++];a?(a.x=t,a.y=e):(a=new XQ(t,e),r.push(a)),a.flags=n,o.push(a)}},e._addPath=function(){var t=this.pathLength,e=this.paths[t];return e?e.reset():(e=new YQ,this.paths.push(e)),this.pathLength++,this._curPath=e,e},t}(),JQ=uX.concat([new Bo("a_dist",fr.R32F)]),QQ=fX(JQ),ZQ=pX(JQ),$Q=t("Graphics",(ZJ=qc("cc.Graphics"),$J=cl(),tQ=Yc(110),eQ=rl(),nQ=fl(),iQ=El(VJ),rQ=fl(),oQ=El(zJ),aQ=fl(),sQ=fl(),cQ=fl(),lQ=fl(),uQ=ul(),ZJ(hQ=$J(hQ=tQ(hQ=eQ((xQ=yQ=function(t){function e(){var e;return(e=t.call(this)||this).impl=null,e.model=null,q(e,"_lineWidth",fQ,H(e)),q(e,"_strokeColor",pQ,H(e)),q(e,"_lineJoin",dQ,H(e)),q(e,"_lineCap",mQ,H(e)),q(e,"_fillColor",vQ,H(e)),q(e,"_miterLimit",gQ,H(e)),e._isDrawing=!1,e._isNeedUploadData=!0,e._graphicsUseSubMeshes=[],e._instanceMaterialType=yK.ADD_COLOR,e.impl=new KQ,e}F(e,t);var n=e.prototype;return n.onRestore=function(){this.impl||this._flushAssembler()},n.onLoad=function(){this.model=LM.root.createModel(qv),this.model.node=this.model.transform=this.node,this._flushAssembler()},n.onEnable=function(){t.prototype.onEnable.call(this),this._updateMtlForGraphics()},n.onDisable=function(){t.prototype.onDisable.call(this)},n.onDestroy=function(){t.prototype.onDestroy.call(this),this._sceneGetter=null,this.model&&(LM.root.destroyModel(this.model),this.model=null);var e=this._graphicsUseSubMeshes.length;if(e>0){for(var n=0;n<e;++n)this._graphicsUseSubMeshes[n].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null)},n.moveTo=function(t,e){this.impl&&this.impl.moveTo(t,e)},n.lineTo=function(t,e){this.impl&&this.impl.lineTo(t,e)},n.bezierCurveTo=function(t,e,n,i,r,o){this.impl&&this.impl.bezierCurveTo(t,e,n,i,r,o)},n.quadraticCurveTo=function(t,e,n,i){this.impl&&this.impl.quadraticCurveTo(t,e,n,i)},n.arc=function(t,e,n,i,r,o){this.impl&&this.impl.arc(t,e,n,i,r,o)},n.ellipse=function(t,e,n,i){this.impl&&this.impl.ellipse(t,e,n,i)},n.circle=function(t,e,n){this.impl&&this.impl.circle(t,e,n)},n.rect=function(t,e,n,i){this.impl&&this.impl.rect(t,e,n,i)},n.roundRect=function(t,e,n,i,r){this.impl&&this.impl.roundRect(t,e,n,i,r)},n.fillRect=function(t,e,n,i){this.rect(t,e,n,i),this.fill()},n.clear=function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var t=0;t<this.model.subModels.length;t++)this.model.subModels[t].inputAssembler.indexCount=0;this.markForUpdateRenderData()}},n.close=function(){this.impl&&this.impl.close()},n.stroke=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)},n.fill=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)},n._updateMtlForGraphics=function(){var t;this._customMaterial?t=this.getMaterialInstance(0):(t=Cv.get("ui-graphics-material"),this.setMaterial(t,0),(t=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))},n.activeSubModel=function(t){if(this.model){if(this.model.subModels.length<=t){var e=i.director.root.device,n=e.createBuffer(new po(mr.VERTEX|mr.TRANSFER_DST,yr.DEVICE,65535*ZQ,ZQ)),r=e.createBuffer(new po(mr.INDEX|mr.TRANSFER_DST,yr.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),o=new PE([n],JQ,zr.TRIANGLE_LIST,r);o.subMeshIdx=0,this.model.initSubModel(t,o,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(o)}}else b(4500,this.node.name)},n._uploadData=function(){var t=this.impl;if(t){var e=t&&t.getRenderDataList();if(!(e.length<=0)&&this.model){for(var n=this.model.subModels,i=0;i<e.length;i++){var r=e[i],o=n[i].inputAssembler;if(r.lastFilledVertex!==r.vertexStart){var a=new Float32Array(r.vData.buffer,0,r.vertexStart*QQ);o.vertexBuffers[0].update(a),o.vertexCount=r.vertexStart;var s=new Uint16Array(r.iData.buffer,0,r.indexStart);o.indexBuffer.update(s),o.indexCount=r.indexStart,r.lastFilledVertex=r.vertexStart,r.lastFilledIndex=r.indexStart}}this._isNeedUploadData=!1}}},n._render=function(t){if(this._isNeedUploadData){if(this.impl){var e=this.impl.getRenderDataList(),n=this.model.subModels.length;if(e.length>n)for(var i=n;i<e.length;i++)this.activeSubModel(i)}this._uploadData()}t.commitModel(this,this.model,this.getMaterialInstance(0))},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this._assembler=t)},n._canRender=function(){return!!t.prototype._canRender.call(this)&&!!this.model&&this._isDrawing},N(e,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(t){this._lineWidth=t,this.impl&&(this.impl.lineWidth=t)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(t){this._lineJoin=t,this.impl&&(this.impl.lineJoin=t)}},{key:"lineCap",get:function(){return this._lineCap},set:function(t){this._lineCap=t,this.impl&&(this.impl.lineCap=t)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(t){this.impl&&(this._strokeColor.set(t),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(t){this.impl&&(this._fillColor.set(t),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(t){this._miterLimit=t}},{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&this._color.set(t)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(){}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(){}}]),e}(FJ),yQ.LineJoin=VJ,yQ.LineCap=zJ,X((_Q=xQ).prototype,"lineWidth",[ll,nQ],Object.getOwnPropertyDescriptor(_Q.prototype,"lineWidth"),_Q.prototype),X(_Q.prototype,"lineJoin",[iQ,rQ],Object.getOwnPropertyDescriptor(_Q.prototype,"lineJoin"),_Q.prototype),X(_Q.prototype,"lineCap",[oQ,aQ],Object.getOwnPropertyDescriptor(_Q.prototype,"lineCap"),_Q.prototype),X(_Q.prototype,"strokeColor",[sQ],Object.getOwnPropertyDescriptor(_Q.prototype,"strokeColor"),_Q.prototype),X(_Q.prototype,"fillColor",[cQ],Object.getOwnPropertyDescriptor(_Q.prototype,"fillColor"),_Q.prototype),X(_Q.prototype,"miterLimit",[lQ],Object.getOwnPropertyDescriptor(_Q.prototype,"miterLimit"),_Q.prototype),X(_Q.prototype,"color",[Ll,uQ],Object.getOwnPropertyDescriptor(_Q.prototype,"color"),_Q.prototype),fQ=X(_Q.prototype,"_lineWidth",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),pQ=X(_Q.prototype,"_strokeColor",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Li.BLACK.clone()}}),dQ=X(_Q.prototype,"_lineJoin",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VJ.MITER}}),mQ=X(_Q.prototype,"_lineCap",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zJ.BUTT}}),vQ=X(_Q.prototype,"_fillColor",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Li.WHITE.clone()}}),gQ=X(_Q.prototype,"_miterLimit",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),hQ=_Q))||hQ)||hQ)||hQ)||hQ)),tZ=new Ei,eZ=new li,nZ=new Ei,iZ=[];!function(t){t[t.RECT=0]="RECT",t[t.ELLIPSE=1]="ELLIPSE",t[t.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",t[t.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(qQ||(qQ={})),$t(qQ);var rZ=t("Mask",(SQ=qc("cc.Mask"),AQ=cl(),CQ=Yc(110),bQ=rl(),TQ=El(qQ),EQ=yl(),wQ=fl(),PQ=yl(),IQ=fl(),RQ=ul(),DQ=El(RX),BQ=ul(),MQ=ul(),OQ=pl(),NQ=ul(),LQ=ul(),SQ(FQ=AQ(FQ=CQ(FQ=bQ((WQ=jQ=function(t){function e(){var e;return(e=t.call(this)||this)._clearStencilMtl=null,e._clearModel=null,q(e,"_type",VQ,H(e)),q(e,"_inverted",GQ,H(e)),q(e,"_segments",UQ,H(e)),q(e,"_spriteFrame",kQ,H(e)),q(e,"_alphaThreshold",HQ,H(e)),e._graphics=null,e._clearModelMesh=null,e._instanceMaterialType=yK.ADD_COLOR,e}F(e,t);var n=e.prototype;return n.onLoad=function(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()},n.onEnable=function(){t.prototype.onEnable.call(this),this._updateGraphics(),this._enableGraphics()},n.onRestore=function(){this._createGraphics(),t.prototype.updateMaterial.call(this),this._updateGraphics(),this._renderFlag=this._canRender()},n.onDisable=function(){t.prototype.onDisable.call(this),this._disableGraphics()},n.onDestroy=function(){t.prototype.onDestroy.call(this),this._clearModel&&this._clearModelMesh&&(LM.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics()},n.isHit=function(t){var e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=n.width,r=n.height,o=eZ;this.node.getWorldMatrix(tZ),Ei.invert(nZ,tZ),li.transformMat4(o,t,nZ);var a=e.anchorPoint;o.x+=a.x*i,o.y+=a.y*r;var s=!1;if(this.type===qQ.RECT||this.type===qQ.GRAPHICS_STENCIL||this.type===qQ.IMAGE_STENCIL)s=o.x>=0&&o.y>=0&&o.x<=i&&o.y<=r;else if(this.type===qQ.ELLIPSE){var c=i/2,l=r/2,u=o.x-.5*i,h=o.y-.5*r;s=u*u/(c*c)+h*h/(l*l)<1}return this._inverted&&(s=!s),s},n._render=function(t){t.commitComp(this,this.renderData,null,this._assembler,null)},n._postRender=function(t){this._postAssembler&&t.commitComp(this,null,null,this._postAssembler,null)},n._nodeStateChange=function(e){t.prototype._nodeStateChange.call(this,e),this._updateGraphics()},n._canRender=function(){return!!t.prototype._canRender.call(this)&&null!==this._graphics&&(this._type!==qQ.IMAGE_STENCIL||null!==this._spriteFrame)},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this),n=e.PostAssembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._postAssembler!==n&&(this._postAssembler=n),this._useRenderData()},n._createGraphics=function(){if(!this._graphics){var t=this._graphics=new $Q;t._objFlags|=Je.Flags.IsOnLoadCalled,t.node=this.node,t.node.getWorldMatrix(),t.lineWidth=0;var e=Li.WHITE.clone();e.a=0,t.fillColor=e}this._updateMaterial()},n._updateGraphics=function(){if(this._graphics&&(this._type===qQ.RECT||this._type===qQ.ELLIPSE)){var t=this.node._uiProps.uiTransformComp,e=this._graphics;e.clear();var n=t.contentSize,i=n.width,r=n.height,o=t.anchorPoint,a=-i*o.x,s=-r*o.y;if(this._type===qQ.RECT)e.rect(a,s,i,r);else if(this._type===qQ.ELLIPSE){for(var c=function(t,e,n){iZ.length=0;for(var i=2*Math.PI/n,r=0;r<n;++r)iZ.push(new oi(e.x*Math.cos(i*r)+t.x,e.y*Math.sin(i*r)+t.y,0));return iZ}(new oi(a+i/2,s+r/2,0),new oi(i/2,r/2,0),this._segments),l=0;l<c.length;++l){var u=c[l];0===l?e.moveTo(u.x,u.y):e.lineTo(u.x,u.y)}e.close()}e.fill()}},n._createClearModel=function(){if(!this._clearModel){var t=Cv.get("default-clear-stencil");this._clearStencilMtl=new yg({parent:t,owner:this,subModelIdx:0}),this._clearModel=LM.root.createModel(qv),this._clearModel.node=this._clearModel.transform=this.node;var e=pX(lX),n=i.director.root.device,r=n.createBuffer(new po(mr.VERTEX|mr.TRANSFER_DST,yr.DEVICE,4*e,e)),o=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);r.update(o);var a=n.createBuffer(new po(mr.INDEX|mr.TRANSFER_DST,yr.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),s=new Uint16Array([0,1,2,2,1,3]);a.update(s),this._clearModelMesh=new PE([r],lX,zr.TRIANGLE_LIST,a),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}},n._updateMaterial=function(){if(this._graphics){var t,e=this._graphics;e.stencilStage=PY.DISABLED,this._type===qQ.IMAGE_STENCIL?(t=Cv.get("ui-alpha-test-material"),e.setMaterial(t,0),(t=e.getMaterialInstance(0)).setProperty("alphaThreshold",this._alphaThreshold)):(t=Cv.get("ui-graphics-material"),e.setMaterial(t,0),e.getMaterialInstance(0))}},n._enableGraphics=function(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())},n._disableGraphics=function(){this._graphics&&this._graphics.onDisable()},n._removeGraphics=function(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)},n._useRenderData=function(){this._type!==qQ.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},N(e,[{key:"type",get:function(){return this._type},set:function(t){this._type!==t&&(this._type=t,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==qQ.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}},{key:"inverted",get:function(){return this._inverted},set:function(t){this._inverted=t,this.stencilStage=PY.DISABLED,this._graphics&&(this._graphics.stencilStage=PY.DISABLED)}},{key:"segments",get:function(){return this._segments},set:function(t){this._segments!==t&&(this._segments=Un(t,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){if(this._spriteFrame!==t){var e=this._spriteFrame;this._spriteFrame=t,this._type===qQ.IMAGE_STENCIL&&!e&&t&&this.markForUpdateRenderData()}}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(t){this._alphaThreshold!==t&&(this._alphaThreshold=t,this.type===qQ.IMAGE_STENCIL&&this._graphics&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"graphics",get:function(){return this._graphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(t){this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(t){this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&(this._color.set(t),this.markForUpdateRenderData())}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(){}}]),e}(FJ),jQ.Type=qQ,X((zQ=WQ).prototype,"type",[TQ,EQ,wQ],Object.getOwnPropertyDescriptor(zQ.prototype,"type"),zQ.prototype),X(zQ.prototype,"inverted",[PQ,IQ],Object.getOwnPropertyDescriptor(zQ.prototype,"inverted"),zQ.prototype),X(zQ.prototype,"segments",[RQ],Object.getOwnPropertyDescriptor(zQ.prototype,"segments"),zQ.prototype),X(zQ.prototype,"spriteFrame",[DQ,BQ],Object.getOwnPropertyDescriptor(zQ.prototype,"spriteFrame"),zQ.prototype),X(zQ.prototype,"alphaThreshold",[MQ,OQ,gl],Object.getOwnPropertyDescriptor(zQ.prototype,"alphaThreshold"),zQ.prototype),X(zQ.prototype,"color",[Ll,NQ],Object.getOwnPropertyDescriptor(zQ.prototype,"color"),zQ.prototype),X(zQ.prototype,"customMaterial",[Ll,LQ],Object.getOwnPropertyDescriptor(zQ.prototype,"customMaterial"),zQ.prototype),VQ=X(zQ.prototype,"_type",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qQ.RECT}}),GQ=X(zQ.prototype,"_inverted",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UQ=X(zQ.prototype,"_segments",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),kQ=X(zQ.prototype,"_spriteFrame",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),HQ=X(zQ.prototype,"_alphaThreshold",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),FQ=zQ))||FQ)||FQ)||FQ)||FQ));dR._maskComp=rZ,i.Mask=rZ;var oZ,aZ,sZ,cZ,lZ,uZ,hZ,_Z,fZ,pZ,dZ,mZ,vZ,gZ,yZ,xZ,SZ,AZ,CZ,bZ,TZ,EZ,wZ,PZ,IZ,RZ,DZ,BZ,MZ,OZ,NZ,LZ,FZ,zZ,VZ,GZ,UZ,kZ,HZ,jZ,WZ,qZ,XZ,YZ,KZ,JZ,QZ,ZZ,$Z,t$,e$,n$,i$,r$,o$,a$,s$,c$,l$,u$,h$=/^(click)(\s)*=|(param)(\s)*=/,_$=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,f$=t("HtmlTextParser",function(){function t(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}var e=t.prototype;return e.parse=function(t){this._resultObjectArray.length=0,this._stack.length=0;for(var e=0,n=t.length;e<n;){var i=t.indexOf(">",e),r=-1;if(i>=0&&(r=t.lastIndexOf("<",i))<e-1&&(r=t.indexOf("<",i+1),i=t.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(t.substring(e)),e=n;else{var o=t.substring(e,r),a=t.substring(r+1,i);""===a&&(o=t.substring(e,i+1)),this._processResult(o),-1===i?i=r:"/"===t.charAt(r+1)?this._stack.pop():this._addToStack(a),e=i+1}}return this._resultObjectArray},e._attributeToObject=function(t){t=t.trim();var e={},n=/^(color|size)(\s)*=/.exec(t),i="",r=0,o="";if(n){if(i=n[0],""===(t=t.substring(i.length).trim()))return e;switch(r=t.indexOf(" "),i[0]){case"c":e.color=r>-1?t.substring(0,r).trim():t;break;case"s":e.size=parseInt(t)}return r>-1&&(o=t.substring(r+1).trim(),e.event=this._processEventHandler(o)),e}if((n=/^(br(\s)*\/)/.exec(t))&&n[0].length>0&&(i=n[0].trim()).startsWith("br")&&"/"===i[i.length-1])return e.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),e;var a="";if((n=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(t))&&n[0].length>0&&(i=n[0].trim()).startsWith("img")&&"/"===i[i.length-1]){var s;n=_$.exec(t);for(var c=!1;n;){if(i=(t=t.substring(t.indexOf(n[0]))).substr(0,n[0].length),s=(r=(a=t.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),t=a.substring(r).trim(),s.endsWith("/")&&(s=s.slice(0,-1)),"src"===i){switch(s.charCodeAt(0)){case 34:case 39:c=!0,s=s.slice(1,-1)}e.isImage=!0,e.src=s}else if("height"===i)e.imageHeight=parseInt(s);else if("width"===i)e.imageWidth=parseInt(s);else if("align"===i){switch(s.charCodeAt(0)){case 34:case 39:s=s.slice(1,-1)}e.imageAlign=s.toLowerCase()}else"offset"===i?e.imageOffset=s:"click"===i&&(e.event=this._processEventHandler(i+"="+s));e.event&&"param"===i&&(e.event[i]=s.replace(/^"|"$/g,"")),n=_$.exec(t)}return c&&e.isImage&&this._resultObjectArray.push({text:"",style:e}),{}}if(n=/^(outline(\s)*[^>]*)/.exec(t)){var l={color:"#ffffff",width:1};if(t=n[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(n=h.exec(t);n;)i=(t=t.substring(t.indexOf(n[0]))).substr(0,n[0].length),u=(r=(a=t.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),t=a.substring(r).trim(),"click"===i?e.event=this._processEventHandler(i+"="+u):"color"===i?l.color=u:"width"===i&&(l.width=parseInt(u)),e.event&&"param"===i&&(e.event[i]=u.replace(/^"|"$/g,"")),n=h.exec(t)}e.outline=l}if((n=/^(on|u|b|i)(\s)*/.exec(t))&&n[0].length>0){switch(i=n[0],t=t.substring(i.length).trim(),i[0]){case"u":e.underline=!0;break;case"i":e.italic=!0;break;case"b":e.bold=!0}if(""===t)return e;e.event=this._processEventHandler(t)}return e},e._processEventHandler=function(t){for(var e={},n=0,i=!1,r=h$.exec(t);r;){var o=r[0],a="";if(i=!1,'"'===(t=t.substring(o.length).trim()).charAt(0))(n=t.indexOf('"',1))>-1&&(a=t.substring(1,n).trim(),i=!0),n++;else if("'"===t.charAt(0))(n=t.indexOf("'",1))>-1&&(a=t.substring(1,n).trim(),i=!0),n++;else{var s=/(\S)+/.exec(t);n=(a=s?s[0]:"").length}i&&(e[o=o.substring(0,o.length-1).trim()]=a),t=t.substring(n).trim(),r=h$.exec(t)}return e},e._addToStack=function(t){var e=this._attributeToObject(t);if(0===this._stack.length)this._stack.push(e);else{if(e.isNewLine||e.isImage)return;var n=this._stack[this._stack.length-1];for(var i in n)e[i]||(e[i]=n[i]);this._stack.push(e)}},e._processResult=function(t){0!==t.length&&(t=this._escapeSpecialSymbol(t),this._stack.length>0?this._resultObjectArray.push({text:t,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:t}))},e._escapeSpecialSymbol=function(t){for(var e,n=W(this._specialSymbolArray);!(e=n()).done;){var i=e.value,r=i[0],o=i[1];t=t.replace(r,o)}return t},t}()),p$=t("LabelOutline",(oZ=qc("cc.LabelOutline"),aZ=cl(),sZ=Yc(110),cZ=rl(),lZ=Xc(UJ),uZ=fl(),hZ=fl(),oZ(_Z=aZ(_Z=sZ(_Z=cZ(_Z=lZ(_Z=il((mZ=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_color",pZ,H(e)),q(e,"_width",dZ,H(e)),e}F(e,t);var n=e.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var t=this.node.getComponent(UJ);t&&t.updateRenderData(!0)},N(e,[{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(t){this._width!==t&&(this._width=t,this._updateRenderData())}}]),e}(ku),pZ=X((fZ=mZ).prototype,"_color",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Li(0,0,0,255)}}),dZ=X(fZ.prototype,"_width",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),X(fZ.prototype,"color",[uZ],Object.getOwnPropertyDescriptor(fZ.prototype,"color"),fZ.prototype),X(fZ.prototype,"width",[hZ],Object.getOwnPropertyDescriptor(fZ.prototype,"width"),fZ.prototype),_Z=fZ))||_Z)||_Z)||_Z)||_Z)||_Z)||_Z));!function(t){t[t.SIMPLE=0]="SIMPLE",t[t.SLICED=1]="SLICED",t[t.TILED=2]="TILED",t[t.FILLED=3]="FILLED"}(s$||(s$={})),$t(s$),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.RADIAL=2]="RADIAL"}(c$||(c$={})),$t(c$),function(t){t[t.CUSTOM=0]="CUSTOM",t[t.TRIMMED=1]="TRIMMED",t[t.RAW=2]="RAW"}(l$||(l$={})),$t(l$),function(t){t.SPRITE_FRAME_CHANGED="spriteframe-changed"}(u$||(u$={}));var d$,m$,v$,g$,y$,x$,S$,A$,C$,b$,T$,E$,w$,P$,I$=t("Sprite",(vZ=qc("cc.Sprite"),gZ=cl(),yZ=Yc(110),xZ=rl(),SZ=El(hg),AZ=yl(),CZ=_l(),bZ=El(BX),TZ=yl(),EZ=fl(),wZ=El(RX),PZ=yl(),IZ=fl(),RZ=El(s$),DZ=yl(),BZ=fl(),MZ=El(c$),OZ=fl(),NZ=fl(),LZ=pl(),FZ=fl(),zZ=pl(),VZ=fl(),GZ=ul(),UZ=yl(),kZ=fl(),HZ=fl(),jZ=El(l$),WZ=yl(),qZ=fl(),vZ(XZ=gZ(XZ=yZ(XZ=xZ((a$=o$=function(t){function e(){var e;return q(e=t.call(this)||this,"_spriteFrame",KZ,H(e)),q(e,"_type",JZ,H(e)),q(e,"_fillType",QZ,H(e)),q(e,"_sizeMode",ZZ,H(e)),q(e,"_fillCenter",$Z,H(e)),q(e,"_fillStart",t$,H(e)),q(e,"_fillRange",e$,H(e)),q(e,"_isTrimmedMode",n$,H(e)),q(e,"_useGrayscale",i$,H(e)),q(e,"_atlas",r$,H(e)),e}F(e,t);var n=e.prototype;return n.__preload=function(){this.changeMaterialForDefine(),t.prototype.__preload.call(this)},n.onEnable=function(){t.prototype.onEnable.call(this),this._activateMaterial();var e=this._spriteFrame;e&&(this._updateUVs(),this._type===s$.SLICED&&e.on(RX.EVENT_UV_UPDATED,this._updateUVs,this))},n.onDisable=function(){this._spriteFrame&&this._type===s$.SLICED&&this._spriteFrame.off(RX.EVENT_UV_UPDATED,this._updateUVs,this)},n.onDestroy=function(){this.destroyRenderData(),t.prototype.onDestroy.call(this)},n.changeSpriteFrameFromAtlas=function(t){if(this._atlas){var e=this._atlas.getSpriteFrame(t);this.spriteFrame=e}else console.warn("SpriteAtlas is null.")},n.changeMaterialForDefine=function(){var t,e=this._instanceMaterialType;this._spriteFrame&&(t=this._spriteFrame.texture);var n=!1;if(t instanceof Sm){var i=t.getPixelFormat();n=i===Xd.RGBA_ETC1||i===Xd.RGB_A_PVRTC_4BPPV1||i===Xd.RGB_A_PVRTC_2BPPV1}n&&this.grayscale?this._instanceMaterialType=yK.USE_ALPHA_SEPARATED_AND_GRAY:n?this._instanceMaterialType=yK.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=yK.GRAYSCALE:this._instanceMaterialType=yK.ADD_COLOR_AND_TEXTURE,e!==this._instanceMaterialType&&this.updateMaterial()},n._updateBuiltinMaterial=function(){var e=t.prototype._updateBuiltinMaterial.call(this);if(this.spriteFrame&&this.spriteFrame.texture instanceof KS){var n=L({SAMPLE_FROM_RT:!0},e.passes[0].defines),i=new hg;i.initialize({effectAsset:e.effectAsset,defines:n}),e=i}return e},n._render=function(t){t.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)},n._canRender=function(){if(!t.prototype._canRender.call(this))return!1;var e=this._spriteFrame;return!(!e||!e.texture)},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateUVs(this),this._updateColor()),this._spriteFrame&&(this._type===s$.SLICED?this._spriteFrame.on(RX.EVENT_UV_UPDATED,this._updateUVs,this):this._spriteFrame.off(RX.EVENT_UV_UPDATED,this._updateUVs,this))},n._applySpriteSize=function(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(l$.RAW===this._sizeMode){var t=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(t)}else if(l$.TRIMMED===this._sizeMode){var e=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(e.width,e.height)}this._activateMaterial()}},n._resized=function(){},n._activateMaterial=function(){var t=this._spriteFrame,e=this.getRenderMaterial(0);t&&e&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=e)},n._updateUVs=function(){this._assembler&&this._assembler.updateUVs(this)},n._applySpriteFrame=function(t){var e=this._spriteFrame;t&&this._type===s$.SLICED&&t.off(RX.EVENT_UV_UPDATED,this._updateUVs,this),this._updateUVs();var n=!1;e&&(t&&t.texture===e.texture||(n=!0),n&&(this._renderData&&(this._renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize(),this._type===s$.SLICED&&e.on(RX.EVENT_UV_UPDATED,this._updateUVs,this))},n._calculateSlicedData=function(t){var e=this.node._uiProps.uiTransformComp.contentSize,n=e.width,i=e.height,r=this.spriteFrame.insetLeft,o=n-r-this.spriteFrame.insetRight,a=this.spriteFrame.insetTop,s=i-a-this.spriteFrame.insetBottom;return t.length=0,t[0]=r/n,t[1]=a/i,t[2]=(r+o)/n,t[3]=(a+s)/i,t},n.calculateTiledData=function(t){var e=this.node._uiProps.uiTransformComp.contentSize,n=this.spriteFrame.rect;t.x=e.width/n.width,t.y=e.height/n.height},n._updateUVWithTrim=function(){this.tillingOffsetWithTrim.length=0;var t=this.spriteFrame,e=t.originalSize,n=t.rect,i=t.texture,r=i.width,o=i.height,a=0,s=0;t.original&&(a=n.x-t.original._x,s=n.y-t.original._y);var c=0===r?0:a/r,l=0===r?1:(a+e.width)/r,u=0===o?1:(s+e.height)/o,h=0===o?0:s/o;t.rotated&&(c=0===r?0:a/r,l=0===r?1:(a+e.height)/r,h=0===o?0:s/o,u=0===o?1:(s+e.width)/o),this.tillingOffsetWithTrim[0]=l-c,this.tillingOffsetWithTrim[1]=u-h,this.tillingOffsetWithTrim[2]=c,this.tillingOffsetWithTrim[3]=h,t.rotated&&(this.tillingOffsetWithTrim[0]=-this.tillingOffsetWithTrim[0])},N(e,[{key:"customMaterial",get:function(){return this._customMaterial},set:function(t){this._customMaterial=t,this.updateMaterial()}},{key:"spriteAtlas",get:function(){return this._atlas},set:function(t){this._atlas!==t&&(this._atlas=t)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){if(this._spriteFrame!==t){var e=this._spriteFrame;this._spriteFrame=t,this.markForUpdateRenderData(!1),this._applySpriteFrame(e)}}},{key:"type",get:function(){return this._type},set:function(t){this._type!==t&&(this._type=t,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(t){this._fillType!==t&&(t===c$.RADIAL||this._fillType===c$.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=t,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(t){this._fillCenter.x=t.x,this._fillCenter.y=t.y,this._type===s$.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(t){this._fillStart=Un(t,0,1),this._type===s$.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"fillRange",get:function(){return this._fillRange},set:function(t){this._fillRange=Un(t,-1,1),this._type===s$.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(t){this._isTrimmedMode!==t&&(this._isTrimmedMode=t,this._type===s$.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(t){this._useGrayscale!==t&&(this._useGrayscale=t,this._instanceMaterialType=!0===t?yK.GRAYSCALE:yK.ADD_COLOR_AND_TEXTURE,this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(t){this._sizeMode!==t&&(this._sizeMode=t,t!==l$.CUSTOM&&this._applySpriteSize())}}]),e}(FJ),o$.FillType=c$,o$.Type=s$,o$.SizeMode=l$,o$.EventType=u$,X((YZ=a$).prototype,"customMaterial",[SZ,AZ,CZ,Ll],Object.getOwnPropertyDescriptor(YZ.prototype,"customMaterial"),YZ.prototype),X(YZ.prototype,"spriteAtlas",[bZ,TZ,EZ],Object.getOwnPropertyDescriptor(YZ.prototype,"spriteAtlas"),YZ.prototype),X(YZ.prototype,"spriteFrame",[wZ,PZ,IZ],Object.getOwnPropertyDescriptor(YZ.prototype,"spriteFrame"),YZ.prototype),X(YZ.prototype,"type",[RZ,DZ,BZ],Object.getOwnPropertyDescriptor(YZ.prototype,"type"),YZ.prototype),X(YZ.prototype,"fillType",[MZ,OZ],Object.getOwnPropertyDescriptor(YZ.prototype,"fillType"),YZ.prototype),X(YZ.prototype,"fillCenter",[NZ],Object.getOwnPropertyDescriptor(YZ.prototype,"fillCenter"),YZ.prototype),X(YZ.prototype,"fillStart",[LZ,FZ],Object.getOwnPropertyDescriptor(YZ.prototype,"fillStart"),YZ.prototype),X(YZ.prototype,"fillRange",[zZ,VZ],Object.getOwnPropertyDescriptor(YZ.prototype,"fillRange"),YZ.prototype),X(YZ.prototype,"trim",[GZ,UZ,kZ],Object.getOwnPropertyDescriptor(YZ.prototype,"trim"),YZ.prototype),X(YZ.prototype,"grayscale",[ll,HZ],Object.getOwnPropertyDescriptor(YZ.prototype,"grayscale"),YZ.prototype),X(YZ.prototype,"sizeMode",[jZ,WZ,qZ],Object.getOwnPropertyDescriptor(YZ.prototype,"sizeMode"),YZ.prototype),KZ=X(YZ.prototype,"_spriteFrame",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JZ=X(YZ.prototype,"_type",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return s$.SIMPLE}}),QZ=X(YZ.prototype,"_fillType",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return c$.HORIZONTAL}}),ZZ=X(YZ.prototype,"_sizeMode",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return l$.TRIMMED}}),$Z=X(YZ.prototype,"_fillCenter",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new li(0,0)}}),t$=X(YZ.prototype,"_fillStart",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),e$=X(YZ.prototype,"_fillRange",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),n$=X(YZ.prototype,"_isTrimmedMode",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),i$=X(YZ.prototype,"_useGrayscale",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),r$=X(YZ.prototype,"_atlas",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),XZ=YZ))||XZ)||XZ)||XZ)||XZ)),R$=t("RenderRoot2D",qc("cc.RenderRoot2D")(d$=Yc(100)(d$=rl()(d$=Xc($Y)(d$=Kc(d$=il(d$=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.onEnable=function(){i.director.root.batcher2D.addScreen(this)},n.onDisable=function(){i.director.root.batcher2D.removeScreen(this)},n.onDestroy=function(){i.director.root.batcher2D.removeScreen(this)},e}(ku))||d$)||d$)||d$)||d$)||d$)||d$),D$=new oi,B$=Jt({OVERLAY:0,INTERSPERSE:1}),M$=t("Canvas",(m$=qc("cc.Canvas"),v$=cl(),g$=Yc(100),y$=rl(),x$=El(IL),S$=fl(),A$=fl(),C$=El(IL),m$(b$=v$(b$=g$(b$=y$(b$=il(b$=Kc((X((T$=function(t){function e(){var e;return q(e=t.call(this)||this,"_cameraComponent",E$,H(e)),q(e,"_alignCanvasWithScreen",w$,H(e)),e._thisOnCameraResized=void 0,e._fitDesignResolution=void 0,e._pos=new oi,e._renderMode=B$.OVERLAY,e._thisOnCameraResized=e._onResizeCamera.bind(H(e)),e}F(e,t);var n=e.prototype;return n.__preload=function(){var t=this.getComponent("cc.Widget");t&&t.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(IL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(RC.TRANSFORM_CHANGED,this._thisOnCameraResized)},n.onEnable=function(){t.prototype.onEnable.call(this),this._cameraComponent&&this._cameraComponent.node.on(IL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDisable=function(){t.prototype.onDisable.call(this),this._cameraComponent&&this._cameraComponent.node.off(IL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDestroy=function(){t.prototype.onDestroy.call(this),this.node.off(RC.TRANSFORM_CHANGED,this._thisOnCameraResized)},n._onResizeCamera=function(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=kB.height/2;else{var t=Qu.windowSize;this._cameraComponent.orthoHeight=t.height/CM.getScaleY()/2}this.node.getWorldPosition(D$),this._cameraComponent.node.setWorldPosition(D$.x,D$.y,1e3)}},n._getViewPriority=function(){if(this._cameraComponent){var t,e=null===(t=this.cameraComponent)||void 0===t?void 0:t.priority;return this._renderMode===B$.OVERLAY?e|1<<30:e&~(1<<30)}return 0},N(e,[{key:"renderMode",get:function(){return this._renderMode},set:function(t){this._renderMode=t,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(t){this._cameraComponent!==t&&(this._cameraComponent=t,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(t){this._alignCanvasWithScreen=t,this._onResizeCamera()}}]),e}(R$)).prototype,"cameraComponent",[x$,S$],Object.getOwnPropertyDescriptor(T$.prototype,"cameraComponent"),T$.prototype),X(T$.prototype,"alignCanvasWithScreen",[A$],Object.getOwnPropertyDescriptor(T$.prototype,"alignCanvasWithScreen"),T$.prototype),E$=X(T$.prototype,"_cameraComponent",[C$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),w$=X(T$.prototype,"_alignCanvasWithScreen",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),b$=T$))||b$)||b$)||b$)||b$)||b$)||b$));i.Canvas=M$,t("UIComponent",qc("cc.UIComponent")(P$=Xc($Y)(P$=Yc(110)(P$=Kc(P$=il(P$=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._lastParent=null,e.stencilStage=PY.DISABLED,e}F(e,t);var n=e.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onEnable=function(){},n.onDisable=function(){},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},e}(ku))||P$)||P$)||P$)||P$)||P$);var O$,N$,L$,F$,z$,V$,G$,U$,k$,H$,j$,W$,q$,X$,Y$,K$,J$,Q$,Z$,$$,t0,e0,n0,i0,r0,o0,a0,s0,c0,l0,u0,h0,_0,f0,p0,d0=new f$,m0="RICHTEXT_CHILD",v0="RICHTEXT_Image_CHILD",g0=new Gt((function(t){if(!i.isValid(t.node))return!1;var e=t.node.getComponent(p$);return e&&(e.width=0),!0}),20),y0=new Gt((function(t){return i.isValid(t.node)}),10);function x0(t){return{node:new BT(t),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:t}}function S0(t,e){var n;t===m0?n=g0._get():t===v0&&(n=y0._get());var i=(n=n||x0(t)).node;return i||(i=new BT(t)),i.hideFlags|=Je.Flags.DontSave|Je.Flags.HideInHierarchy,t===v0?(n.comp=i.getComponent(I$)||i.addComponent(I$),n.comp.spriteFrame=e,n.comp.type=I$.Type.SLICED,n.comp.sizeMode=I$.SizeMode.CUSTOM):(n.comp=i.getComponent(UJ)||i.addComponent(UJ),n.comp.string=e,n.comp.horizontalAlign=MJ.LEFT,n.comp.verticalAlign=OJ.TOP),i.setPosition(0,0,0),i._uiProps.uiTransformComp.setAnchorPoint(.5,.5),n.node=i,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}t("RichText",(O$=qc("cc.RichText"),N$=cl(),L$=Yc(110),F$=rl(),z$=fl(),V$=El(MJ),G$=fl(),U$=fl(),k$=fl(),H$=El(FX),j$=fl(),W$=fl(),q$=El(LJ),X$=fl(),Y$=fl(),K$=fl(),J$=El(BX),Q$=fl(),Z$=fl(),O$($$=N$($$=L$($$=F$($$=il((p0=f0=function(t){function e(){var e;return q(e=t.call(this)||this,"_lineHeight",e0,H(e)),q(e,"_string",n0,H(e)),q(e,"_horizontalAlign",i0,H(e)),q(e,"_fontSize",r0,H(e)),q(e,"_maxWidth",o0,H(e)),q(e,"_fontFamily",a0,H(e)),q(e,"_font",s0,H(e)),q(e,"_isSystemFontUsed",c0,H(e)),q(e,"_userDefinedFont",l0,H(e)),q(e,"_cacheMode",u0,H(e)),q(e,"_imageAtlas",h0,H(e)),q(e,"_handleTouchEvent",_0,H(e)),e._textArray=[],e._segments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._updateRichTextStatus=void 0,e._updateRichTextStatus=e._updateRichText,e}F(e,t);var n=e.prototype;return n.onLoad=function(){this.node.on(RC.LAYER_CHANGED,this._applyLayer,this)},n.onEnable=function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)},n.onDisable=function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)},n.start=function(){this._onTTFLoaded(),this.node.on(RC.ANCHOR_CHANGED,this._updateRichTextPosition,this)},n.onRestore=function(){},n.onDestroy=function(){for(var t,e=W(this._segments);!(t=e()).done;){var n=t.value;n.node.removeFromParent(),n.type===m0?g0.put(n):n.type===v0&&y0.put(n)}this.node.off(RC.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(RC.LAYER_CHANGED,this._applyLayer,this)},n._addEventListeners=function(){this.node.on(RC.TOUCH_END,this._onTouchEnded,this)},n._removeEventListeners=function(){this.node.off(RC.TOUCH_END,this._onTouchEnded,this)},n._updateLabelSegmentTextAttributes=function(){var t=this;this._segments.forEach((function(e){t._applyTextAttribute(e)}))},n._createFontLabel=function(t){return S0(m0,t)},n._createImage=function(t){return S0(v0,t)},n._onTTFLoaded=function(){this._font,this._layoutDirty=!0,this._updateRichText()},n._measureText=function(t,e){var n=this,i=function(e){var i;return 0===n._labelSegmentsCache.length?(i=n._createFontLabel(e),n._labelSegmentsCache.push(i)):(i=n._labelSegmentsCache[0]).node.getComponent(UJ).string=e,i.styleIndex=t,n._applyTextAttribute(i),i.node._uiProps.uiTransformComp.contentSize.width};return e?i(e):i},n._onTouchEnded=function(t){for(var e,n=this,i=this.node.getComponents(ku),r=function(){var r=e.value,o=r.clickHandler,a=r.clickParam;o&&n._containsTouchLocation(r,t.touch.getUILocation())&&(i.forEach((function(e){var n=e[o];e.enabledInHierarchy&&n&&n.call(e,t,a)})),t.propagationStopped=!0)},o=W(this._segments);!(e=o()).done;)r()},n._containsTouchLocation=function(t,e){var n=t.node.getComponent($Y);return!!n&&n.getBoundingBoxToWorld().contains(e)},n._resetState=function(){for(var t=this.node.children,e=t.length-1;e>=0;e--){var n=t[e];if(n.name===m0||n.name===v0){n.parent===this.node?n.parent=null:t.splice(e,1);var i=x0(n.name);i.node=n,n.name===m0?(i.comp=n.getComponent(UJ),g0.put(i)):(i.comp=n.getComponent(I$),y0.put(i))}}t.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0},n._activateChildren=function(t){for(var e=this.node.children.length-1;e>=0;e--){var n=this.node.children[e];n.name!==m0&&n.name!==v0||(n.active=t)}},n._addLabelSegment=function(t,e){var n;if(0===this._labelSegmentsCache.length)n=this._createFontLabel(t);else{var i=(n=this._labelSegmentsCache.pop()).node.getComponent(UJ);i&&(i.string=t)}return n.styleIndex=e,n.lineCount=this._lineCount,n.node._uiProps.uiTransformComp.setAnchorPoint(0,0),n.node.layer=this.node.layer,this.node.addChild(n.node),this._applyTextAttribute(n),this._segments.push(n),n},n._updateRichTextWithMaxWidth=function(t,e,n){var i=e;if(this._lineOffsetX>0&&i+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var o=this._getFirstWordLen(t,r,t.length),a=t.substr(r,o),s=this._measureText(n,a);if(!(this._lineOffsetX+s<=this._maxWidth)){if(r>0){var c=t.substr(0,r);this._addLabelSegment(c,n),t=t.substr(r,t.length),i=this._measureText(n,t)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=o}if(i>this._maxWidth)for(var l=fY(t,i,this._maxWidth,this._measureText(n)),u=0;u<l.length;++u){var h=l[u],_=this._addLabelSegment(h,n).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=_.width,l.length>1&&u<l.length-1&&this._updateLineInfo()}else this._lineOffsetX+=i,this._addLabelSegment(t,n)},n._isLastComponentCR=function(t){return t.length-1===t.lastIndexOf("\n")},n._updateLineInfo=function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++},n._needsUpdateTextLayout=function(t){if(this._layoutDirty||!this._textArray||!t)return!0;if(this._textArray.length!==t.length)return!0;for(var e=0;e<this._textArray.length;e++){var n=this._textArray[e],i=t[e];if(n.text!==i.text)return!0;var r=n.style,o=i.style;if(r){if(o){if(!!o.outline!=!!r.outline)return!0;if(r.size!==o.size||r.italic!==o.italic||r.isImage!==o.isImage)return!0;if(r.src!==o.src||r.imageAlign!==o.imageAlign||r.imageHeight!==o.imageHeight||r.imageWidth!==o.imageWidth||r.imageOffset!==o.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(o&&(o.size||o.italic||o.isImage||o.outline))return!0}return!1},n._addRichTextImageElement=function(t){if(t.style){var e=t.style,n=e.src,i=this._imageAtlas&&n&&this._imageAtlas.getSpriteFrame(n);if(i){var r=this._createImage(i);switch(r.comp,e.imageAlign){case"top":r.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}e.imageOffset&&(r.imageOffset=e.imageOffset),r.node.layer=this.node.layer,this.node.addChild(r.node),this._segments.push(r);var o=i.rect.clone(),a=1,s=o.width,c=o.height,l=e.imageWidth||0,u=e.imageHeight||0;u>0?(s*=a=u/c,c*=a):(s*=a=this._lineHeight/c,c*=a),l>0&&(s=l),this._maxWidth>0?(this._lineOffsetX+s>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=s):(this._lineOffsetX+=s,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.node._uiProps.uiTransformComp.setContentSize(s,c),r.lineCount=this._lineCount,r.clickHandler="",r.clickParam="";var h=e.event;h&&(r.clickHandler=h.click,r.clickParam=h.param)}else b(4400)}},n._updateRichText=function(){if(this.enabledInHierarchy){var t=d0.parse(this._string);if(!this._needsUpdateTextLayout(t))return this._textArray=t.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=t.slice(),this._resetState();for(var e,n=!1,i=0;i<this._textArray.length;++i){var r=this._textArray[i],o=r.text;if(void 0!==o){if(""===o){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var a=o.split("\n"),s=0;s<a.length;++s){var c=a[s];if(""!==c)if(n=!1,this._maxWidth>0){var l=this._measureText(i,c);this._updateRichTextWithMaxWidth(c,l,i),a.length>1&&s<a.length-1&&this._updateLineInfo()}else e=this._addLabelSegment(c,i),this._lineOffsetX+=e.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),a.length>1&&s<a.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(o)&&s===a.length-1)continue;this._updateLineInfo(),n=!0}}}}n||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+$X)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}},n._getFirstWordLen=function(t,e,n){var i=t.charAt(e);if(lY(i)||uY(i))return 1;for(var r=1,o=e+1;o<n&&!uY(i=t.charAt(o))&&!lY(i);++o)r++;return r},n._updateRichTextPosition=function(){for(var t=0,e=1,n=this._lineCount,i=this.node._uiProps.uiTransformComp,r=i.anchorX,o=i.anchorY,a=0;a<this._segments.length;++a){var s=this._segments[a],c=s.lineCount;c>e&&(t=0,e=c);var l=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case MJ.LEFT:break;case MJ.CENTER:l-=this._linesWidth[c-1]/2;break;case MJ.RIGHT:l-=this._linesWidth[c-1]}var u=s.node.position;if(s.node.setPosition(t+l,this._lineHeight*(n-c)-this._labelHeight*o,u.z),c===e&&(t+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(I$)){var h=s.node.position.clone(),_=this._lineHeight,f=this._lineHeight*(1+$X);switch(s.node._uiProps.uiTransformComp.anchorY){case 1:h.y+=_+(f-_)/2;break;case.5:h.y+=f/2;break;default:h.y+=(f-_)/2}if(s.imageOffset){var p=s.imageOffset.split(",");if(1===p.length&&p[0]){var d=parseFloat(p[0]);Number.isInteger(d)&&(h.y+=d)}else if(2===p.length){var m=parseFloat(p[0]),v=parseFloat(p[1]);Number.isInteger(m)&&(h.x+=m),Number.isInteger(v)&&(h.y+=v)}}s.node.position=h}var g=s.node.getComponent(p$);if(g){var y=s.node.position.clone();y.y-=g.width,s.node.position=y}}},n._convertLiteralColorValue=function(t){var e=t.toUpperCase();return Li[e]?Li[e]:(new Li).fromHEX(t)},n._applyTextAttribute=function(t){var e=t.node.getComponent(UJ);if(e){this._resetLabelState(e);var n,i=t.styleIndex;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(e.color=this._convertLiteralColorValue(n.color||"white"),e.isBold=!!n.bold,e.isItalic=!!n.italic,e.isUnderline=!!n.underline,n.outline){var r=t.node.getComponent(p$);r||(r=t.node.addComponent(p$)),r.color=this._convertLiteralColorValue(n.outline.color),r.width=n.outline.width}e.fontSize=n.size||this._fontSize,t.clickHandler="",t.clickParam="";var o=n.event;o&&(t.clickHandler=o.click||"",t.clickParam=o.param||"")}e.cacheMode=this._cacheMode,this._font instanceof FX&&!this._isSystemFontUsed?e.font=this._font:e.fontFamily=this._fontFamily,e.useSystemFont=this._isSystemFontUsed,e.lineHeight=this._lineHeight,e.updateRenderData(!0);var a=e._assembler;a&&a.updateRenderData(e)}},n._applyLayer=function(){for(var t,e=W(this._segments);!(t=e()).done;)t.value.node.layer=this.node.layer},n._resetLabelState=function(t){t.fontSize=this._fontSize,t.color=Li.WHITE,t.isBold=!1,t.isItalic=!1,t.isUnderline=!1},N(e,[{key:"string",get:function(){return this._string},set:function(t){this._string!==t&&(this._string=t,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(t){this.horizontalAlign!==t&&(this._horizontalAlign=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(t){this._fontSize!==t&&(this._fontSize=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(t){this._fontFamily!==t&&(this._fontFamily=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(t){this._font!==t&&(this._font=t,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(t){this._isSystemFontUsed!==t&&(this._isSystemFontUsed=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(t){this._cacheMode!==t&&(this._cacheMode=t,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(t){this._maxWidth!==t&&(this._maxWidth=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(t){this._lineHeight!==t&&(this._lineHeight=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(t){this._imageAtlas!==t&&(this._imageAtlas=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(t){this._handleTouchEvent!==t&&(this._handleTouchEvent=t,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),e}(ku),f0.HorizontalAlign=MJ,f0.VerticalAlign=OJ,X((t0=p0).prototype,"string",[xl,z$],Object.getOwnPropertyDescriptor(t0.prototype,"string"),t0.prototype),X(t0.prototype,"horizontalAlign",[V$,G$],Object.getOwnPropertyDescriptor(t0.prototype,"horizontalAlign"),t0.prototype),X(t0.prototype,"fontSize",[U$],Object.getOwnPropertyDescriptor(t0.prototype,"fontSize"),t0.prototype),X(t0.prototype,"fontFamily",[k$],Object.getOwnPropertyDescriptor(t0.prototype,"fontFamily"),t0.prototype),X(t0.prototype,"font",[H$,j$],Object.getOwnPropertyDescriptor(t0.prototype,"font"),t0.prototype),X(t0.prototype,"useSystemFont",[W$],Object.getOwnPropertyDescriptor(t0.prototype,"useSystemFont"),t0.prototype),X(t0.prototype,"cacheMode",[q$,X$],Object.getOwnPropertyDescriptor(t0.prototype,"cacheMode"),t0.prototype),X(t0.prototype,"maxWidth",[Y$],Object.getOwnPropertyDescriptor(t0.prototype,"maxWidth"),t0.prototype),X(t0.prototype,"lineHeight",[K$],Object.getOwnPropertyDescriptor(t0.prototype,"lineHeight"),t0.prototype),X(t0.prototype,"imageAtlas",[J$,Q$],Object.getOwnPropertyDescriptor(t0.prototype,"imageAtlas"),t0.prototype),X(t0.prototype,"handleTouchEvent",[Z$],Object.getOwnPropertyDescriptor(t0.prototype,"handleTouchEvent"),t0.prototype),e0=X(t0.prototype,"_lineHeight",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),n0=X(t0.prototype,"_string",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),i0=X(t0.prototype,"_horizontalAlign",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return MJ.LEFT}}),r0=X(t0.prototype,"_fontSize",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),o0=X(t0.prototype,"_maxWidth",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),a0=X(t0.prototype,"_fontFamily",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),s0=X(t0.prototype,"_font",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c0=X(t0.prototype,"_isSystemFontUsed",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),l0=X(t0.prototype,"_userDefinedFont",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),u0=X(t0.prototype,"_cacheMode",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return LJ.NONE}}),h0=X(t0.prototype,"_imageAtlas",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_0=X(t0.prototype,"_handleTouchEvent",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$$=t0))||$$)||$$)||$$)||$$)||$$)),t("UIMeshRenderer",qc("cc.UIMeshRenderer")(A0=cl()(A0=Yc(110)(A0=rl()(A0=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._models=null,e._modelComponent=null,e.stencilStage=PY.DISABLED,e}F(e,t);var n=e.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onLoad=function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn("node '"+(this.node&&this.node.name)+"' doesn't have any renderable component")},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)},n.updateAssembler=function(t){if(this._models){this._modelComponent._detachFromScene();for(var e,n=W(this._models);!(e=n()).done;){var i=e.value;t.commitModel.call(t,this,i,this._modelComponent.material)}return!0}return!1},n.postUpdateAssembler=function(){},n.update=function(){this._fitUIRenderQueue()},n._fitUIRenderQueue=function(){if(this._modelComponent)for(var t=this._modelComponent.sharedMaterials.length,e=0;e<t;e++){var n=this._modelComponent.getMaterialInstance(e);if(null!=n)for(var i=n.passes,r=i.length,o=0;o<r;o++)i[o]._priority=dp.MAX-11,n.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},o)}},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},N(e,[{key:"modelComponent",get:function(){return this._modelComponent}}]),e}(ku))||A0)||A0)||A0)||A0);var A0,C0,b0,T0,E0,w0,P0,I0,R0,D0,B0,M0,O0,N0,L0,F0,z0,V0,G0,U0,k0,H0,j0,W0,q0,X0,Y0,K0,J0,Q0,Z0=fp.Enum.NONE|fp.Enum.UI_3D,$0=function(){function t(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=Z0,this._inputAssembler=null,this._descriptorSet=null}var e=t.prototype;return e.destroy=function(){this._passes=[]},e.clear=function(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=Z0,this.renderScene=null},e.fillPasses=function(t,e,n,r,o,a){if(t){var s=t.passes;if(!s)return;var c=0;this._shaders.length=s.length;for(var l=0;l<s.length;l++){this._passes[l]||(this._passes[l]=new Rv(i.director.root));var u=s[l],h=this._passes[l];u.update(),e||(e=u.depthStencilState,n=0),r||(r=u.blendState,o=0),-1===o&&(o=0),c=n<<16|o,h._initPassFromTarget(u,e,r,c),this._shaders[l]=h.getShaderVariant(a)}}},N(t,[{key:"native",get:function(){return this._nativeObj}},{key:"inputAssembler",get:function(){return this._inputAssembler},set:function(t){this._inputAssembler=t}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(t){this._descriptorSet=t}},{key:"visFlags",get:function(){return this._visFlags},set:function(t){this._visFlags=t}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}}]),t}(),t1=(t("UIStaticBatch",(C0=qc("cc.UIStaticBatch"),b0=cl(),T0=rl(),E0=Yc(110),w0=ul(),C0(P0=b0(P0=T0(P0=E0((X((I0=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._init=!1,e._bufferAccessor=null,e._dirty=!0,e._uiDrawBatchList=[],e}F(e,t);var n=e.prototype;return n.onLoad=function(){},n.onDestroy=function(){},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markAsDirty=function(){},n._requireDrawBatch=function(){var t=new $0;return t.isStatic=!0,this._uiDrawBatchList.push(t),t},n._clearData=function(){if(this._bufferAccessor){this._bufferAccessor.reset();for(var t=this._getBatcher(),e=0;e<this._uiDrawBatchList.length;e++)this._uiDrawBatchList[e].destroy(t)}this._uiDrawBatchList.length=0,this._init=!1},n._getBatcher=function(){return LM.root&&LM.root.batcher2D?LM.root.batcher2D:(b(9301),null)},N(e,[{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&this._color.set(t)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),e}(FJ)).prototype,"color",[Ll,w0],Object.getOwnPropertyDescriptor(I0.prototype,"color"),I0.prototype),P0=I0))||P0)||P0)||P0)||P0)),t("LabelShadow",(R0=qc("cc.LabelShadow"),D0=cl(),B0=Yc(110),M0=rl(),O0=Xc(UJ),N0=fl(),L0=fl(),F0=fl(),R0(z0=D0(z0=B0(z0=M0(z0=O0(z0=il((H0=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_color",G0,H(e)),q(e,"_offset",U0,H(e)),q(e,"_blur",k0,H(e)),e}F(e,t);var n=e.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var t=this.node.getComponent(UJ);t&&t.updateRenderData(!0)},N(e,[{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset=t,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(t){this._blur=t,this._updateRenderData()}}]),e}(ku),G0=X((V0=H0).prototype,"_color",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Li(0,0,0,255)}}),U0=X(V0.prototype,"_offset",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new li(2,2)}}),k0=X(V0.prototype,"_blur",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),X(V0.prototype,"color",[N0],Object.getOwnPropertyDescriptor(V0.prototype,"color"),V0.prototype),X(V0.prototype,"offset",[L0],Object.getOwnPropertyDescriptor(V0.prototype,"offset"),V0.prototype),X(V0.prototype,"blur",[F0],Object.getOwnPropertyDescriptor(V0.prototype,"blur"),V0.prototype),z0=V0))||z0)||z0)||z0)||z0)||z0)||z0))),e1=(t("UIOpacity",(j0=qc("cc.UIOpacity"),W0=cl(),q0=Yc(110),X0=rl(),Y0=fl(),j0(K0=W0(K0=q0(K0=X0(K0=il((X((J0=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_opacity",Q0,H(e)),e}F(e,t);var n=e.prototype;return n.onEnable=function(){this.node._uiProps.localOpacity=this._opacity/255},n.onDisable=function(){this.node._uiProps.localOpacity=1},N(e,[{key:"opacity",get:function(){return this._opacity},set:function(t){this._opacity!==t&&(t=fe(t,0,255),this._opacity=t,this.node._uiProps.localOpacity=t/255)}}]),e}(ku)).prototype,"opacity",[ll,Y0],Object.getOwnPropertyDescriptor(J0.prototype,"opacity"),J0.prototype),Q0=X(J0.prototype,"_opacity",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),K0=J0))||K0)||K0)||K0)||K0)||K0)),function(t,e,n){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=e,this.y=n});function n1(t,e,n,i,r){var o=0,a=null;if(r===function(t,e,n,i){for(var r=0,o=e,a=n-i;o<n;o+=i)r+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return r}(t,e,n,i)>0)for(o=e;o<n;o+=i)a=x1(o,t[o],t[o+1],a);else for(o=n-i;o>=e;o-=i)a=x1(o,t[o],t[o+1],a);return a&&m1(a,a.next)&&(S1(a),a=a.next),a}function i1(t,e){if(void 0===e&&(e=null),!t)return t;e||(e=t);var n=t,i=!1;do{if(i=!1,n.steiner||!m1(n,n.next)&&0!==d1(n.prev,n,n.next))n=n.next;else{if(S1(n),(n=e=n.prev)===n.next)return null;i=!0}}while(i||n!==e);return e}function r1(t,e,n,i,r,o,a){if(void 0===a&&(a=0),t){!a&&o&&function(t,e,n,i){var r=t;do{null===r.z&&(r.z=h1(r.x,r.y,e,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e=0,n=null,i=null,r=null,o=null,a=0,s=0,c=0,l=1;do{for(n=t,t=null,o=null,a=0;n;){for(a++,i=n,s=0,e=0;e<l&&(s++,i=i.nextZ);e++);for(c=l;s>0||c>0&&i;)0===s?(r=i,i=i.nextZ,c--):0!==c&&i?n.z<=i.z?(r=n,n=n.nextZ,s--):(r=i,i=i.nextZ,c--):(r=n,n=n.nextZ,s--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;n=i}o.nextZ=null,l*=2}while(a>1)}(r)}(t,i,r,o);for(var s=t,c=null,l=null;t.prev!==t.next;)if(c=t.prev,l=t.next,o?a1(t,i,r,o):o1(t))e.push(c.i/n),e.push(t.i/n),e.push(l.i/n),S1(t),t=l.next,s=l.next;else if((t=l)===s){a?1===a?r1(t=s1(t,e,n),e,n,i,r,o,2):2===a&&c1(t,e,n,i,r,o):r1(i1(t),e,n,i,r,o,1);break}}}function o1(t){var e=t.prev,n=t,i=t.next;if(d1(e,n,i)>=0)return!1;for(var r=t.next.next;r!==t.prev;){if(f1(e.x,e.y,n.x,n.y,i.x,i.y,r.x,r.y)&&d1(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function a1(t,e,n,i){var r=t.prev,o=t,a=t.next;if(d1(r,o,a)>=0)return!1;for(var s=r.x<o.x?r.x<a.x?r.x:a.x:o.x<a.x?o.x:a.x,c=r.y<o.y?r.y<a.y?r.y:a.y:o.y<a.y?o.y:a.y,l=r.x>o.x?r.x>a.x?r.x:a.x:o.x>a.x?o.x:a.x,u=r.y>o.y?r.y>a.y?r.y:a.y:o.y>a.y?o.y:a.y,h=h1(s,c,e,n,i),_=h1(l,u,e,n,i),f=t.nextZ;f&&f.z<=_;){if(f!==t.prev&&f!==t.next&&f1(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&d1(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(f=t.prevZ;f&&f.z>=h;){if(f!==t.prev&&f!==t.next&&f1(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&d1(f.prev,f,f.next)>=0)return!1;f=f.prevZ}return!0}function s1(t,e,n){var i=t;do{var r=i.prev,o=i.next.next;!m1(r,o)&&v1(r,i,i.next,o)&&g1(r,o)&&g1(o,r)&&(e.push(r.i/n),e.push(i.i/n),e.push(o.i/n),S1(i),S1(i.next),i=t=o),i=i.next}while(i!==t);return i}function c1(t,e,n,i,r,o){var a=t;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&p1(a,s)){var c=y1(a,s);return a=i1(a,a.next),c=i1(c,c.next),r1(a,e,n,i,r,o),void r1(c,e,n,i,r,o)}s=s.next}a=a.next}while(a!==t)}function l1(t,e){return t.x-e.x}function u1(t,e){if(e=function(t,e){var n=e,i=t.x,r=t.y,o=-1/0,a=null;do{if(r<=n.y&&r>=n.next.y){var s=n.x+(r-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>o){if(o=s,s===i){if(r===n.y)return n;if(r===n.next.y)return n.next}a=n.x<n.next.x?n:n.next}}n=n.next}while(n!==e);if(!a)return null;if(i===o)return a.prev;var c,l=a,u=a.x,h=a.y,_=1/0;for(n=a.next;n!==l;)i>=n.x&&n.x>=u&&f1(r<h?i:o,r,u,h,r<h?o:i,r,n.x,n.y)&&((c=Math.abs(r-n.y)/(i-n.x))<_||c===_&&n.x>a.x)&&g1(n,t)&&(a=n,_=c),n=n.next;return a}(t,e)){var n=y1(e,t);i1(n,n.next)}}function h1(t,e,n,i,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function _1(t){var e=t,n=t;do{e.x<n.x&&(n=e),e=e.next}while(e!==t);return n}function f1(t,e,n,i,r,o,a,s){return(r-a)*(e-s)-(t-a)*(o-s)>=0&&(t-a)*(i-s)-(n-a)*(e-s)>=0&&(n-a)*(o-s)-(r-a)*(i-s)>=0}function p1(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&v1(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&g1(t,e)&&g1(e,t)&&function(t,e){var n=t,i=!1,r=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)}function d1(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function m1(t,e){return t.x===e.x&&t.y===e.y}function v1(t,e,n,i){return!!(m1(t,e)&&m1(n,i)||m1(t,i)&&m1(n,e))||d1(t,e,n)>0!=d1(t,e,i)>0&&d1(n,i,t)>0!=d1(n,i,e)>0}function g1(t,e){return d1(t.prev,t,t.next)<0?d1(t,e,t.next)>=0&&d1(t,t.prev,e)>=0:d1(t,e,t.prev)<0||d1(t,t.next,e)<0}function y1(t,e){var n=new e1(t.i,t.x,t.y),i=new e1(e.i,e.x,e.y),r=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function x1(t,e,n,i){var r=new e1(t,e,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function S1(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function A1(t,e,n){n=n||3;var i=e?e.length:0,r=i?e[0]*n:t.length,o=n1(t,0,r,n,!0),a=[];if(!o)return a;var s=0,c=0,l=0,u=0,h=0,_=0,f=0;if(i&&(o=function(t,e,n,i){var r,o=[],a=0,s=null;for(a=0,r=e.length;a<r;a++)(s=n1(t,e[a]*i,a<r-1?e[a+1]*i:t.length,i,!1))&&(s===s.next&&(s.steiner=!0),o.push(_1(s)));if(o.sort(l1),!n)return n;for(a=0;a<o.length;a++)u1(o[a],n),n=i1(n,n.next);return n}(t,e,o,n)),t.length>80*n){s=l=t[0],c=u=t[1];for(var p=n;p<r;p+=n)(h=t[p])<s&&(s=h),(_=t[p+1])<c&&(c=_),h>l&&(l=h),_>u&&(u=_);f=Math.max(l-s,u-c)}return r1(o,a,n,s,c,f),a}for(var C1=Math.PI,b1=Math.min,T1=Math.max,E1=Math.ceil,w1=Math.acos,P1=Math.cos,I1=Math.sin,R1=Math.atan2,D1=null,B1=null,M1=new Li,O1=[],N1=0;N1<4;N1++)O1.push(new oi);function L1(t,e,n){return t<e?e:t>n?n:t}var F1={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(t,e){if(!B1)return null;var n=B1.getRenderDataList(),i=n[B1.dataOffset];if(!i)return null;var r=i,o=r?r.vertexStart+e:0;return(o>65535||3*o>131070)&&(++B1.dataOffset,B1.dataOffset<n.length?i=n[B1.dataOffset]:(i=B1.requestRenderData(),n[B1.dataOffset]=i),r=i),r&&r.vertexCount<o&&r.request(e,3*e),i},stroke:function(t){Li.copy(M1,t.strokeColor),t.impl&&(this._flattenPaths(t.impl),this._expandStroke(t),t.impl.updatePathOffset=!0,this.end(t))},fill:function(t){Li.copy(M1,t.fillColor),this._expandFill(t),t.impl&&(t.impl.updatePathOffset=!0),this.end(t)},end:function(t){t.markForUpdateRenderData()},_expandStroke:function(t){var e,n,i,r,o=.5*t.lineWidth,a=t.lineCap,s=t.lineJoin,c=t.miterLimit;if(B1=t.impl){var l=(e=o,n=C1,i=B1.tessTol,r=2*w1(e/(e+i)),T1(2,E1(n/r)));this._calculateJoins(B1,o,s,c);for(var u=B1.paths,h=0,_=B1.pathOffset,f=B1.pathLength;_<f;_++){var p=u[_],d=p.points.length;s===VJ.ROUND?h+=2*(d+p.bevel*(l+2)+1):h+=2*(d+5*p.bevel+1),p.closed||(a===zJ.ROUND?h+=2*(2*l+2):h+=12)}var m=D1=this.getRenderData(t,h);if(m){for(var v=m.vData,g=m.iData,y=B1.pathOffset,x=B1.pathLength;y<x;y++){var S=u[y],A=S.points,C=A.length,b=m.vertexStart,T=void 0,E=void 0,w=0,P=0,I=S.closed;if(I?(T=A[C-1],E=A[0],w=0,P=C):(T=A[0],E=A[1],w=1,P=C-1),E=E||T,!I){var R=new XQ(E.x,E.y);R.subtract(T),R.normalize();var D=R.x,B=R.y;a===zJ.BUTT?this._buttCapStart(T,D,B,o,0):a===zJ.SQUARE?this._buttCapStart(T,D,B,o,o):a===zJ.ROUND&&this._roundCapStart(T,D,B,o,l)}for(var M=w;M<P;++M)s===VJ.ROUND?this._roundJoin(T,E,o,o,l):0!=(E.flags&(GJ.PT_BEVEL|GJ.PT_INNERBEVEL))?this._bevelJoin(T,E,o,o):(this._vSet(E.x+E.dmx*o,E.y+E.dmy*o,1),this._vSet(E.x-E.dmx*o,E.y-E.dmy*o,-1)),T=E,E=A[M+1];if(I){var O=8*b;this._vSet(v[O],v[O+1],1),this._vSet(v[O+8],v[O+8+1],-1)}else{var N=new XQ(E.x,E.y);N.subtract(T),N.normalize();var L=N.x,F=N.y;a===zJ.BUTT?this._buttCapEnd(E,L,F,o,0):a===zJ.SQUARE?this._buttCapEnd(E,L,F,o,o):a===zJ.ROUND&&this._roundCapEnd(E,L,F,o,l)}for(var z=m.indexStart,V=b+2,G=m.vertexStart;V<G;V++)g[z++]=V-2,g[z++]=V-1,g[z++]=V;m.indexStart=z}D1=null,B1=null}}},_expandFill:function(t){if(B1=t.impl){for(var e=B1.paths,n=0,i=B1.pathOffset,r=B1.pathLength;i<r;i++)n+=e[i].points.length;var o=D1=this.getRenderData(t,n);if(o){for(var a=o,s=a.vData,c=a.iData,l=B1.pathOffset,u=B1.pathLength;l<u;l++){var h=e[l],_=h.points,f=_.length;if(0!==f){for(var p=o.vertexStart,d=0;d<f;++d)this._vSet(_[d].x,_[d].y);var m=o.indexStart;if(h.complex){for(var v=[],g=p,y=o.vertexStart;g<y;g++){var x=8*g;v.push(s[x++]),v.push(s[x++]),v.push(s[x++])}var S=A1(v,null,3);if(!S||0===S.length)continue;for(var A=0,C=S.length;A<C;A++)c[m++]=S[A]+p}else for(var b=p,T=p+2,E=a.vertexStart;T<E;T++)c[m++]=b,c[m++]=T-1,c[m++]=T;a.indexStart=m}}D1=null,B1=null}}},_calculateJoins:function(t,e,n,i){var r=0;e>0&&(r=1/e);for(var o=t.paths,a=t.pathOffset,s=t.pathLength;a<s;a++){var c=o[a],l=c.points,u=l.length,h=l[u-1],_=l[0];c.bevel=0;for(var f=0;f<u;f++){var p,d,m=h.dy,v=-h.dx,g=_.dy,y=-_.dx;if(_.dmx=.5*(m+g),_.dmy=.5*(v+y),(p=_.dmx*_.dmx+_.dmy*_.dmy)>1e-6){var x=1/p;x>600&&(x=600),_.dmx*=x,_.dmy*=x}_.dx*h.dy-h.dx*_.dy>0&&(_.flags|=GJ.PT_LEFT),p*(d=T1(11,b1(h.len,_.len)*r))*d<1&&(_.flags|=GJ.PT_INNERBEVEL),_.flags&GJ.PT_CORNER&&(p*i*i<1||n===VJ.BEVEL||n===VJ.ROUND)&&(_.flags|=GJ.PT_BEVEL),0!=(_.flags&(GJ.PT_BEVEL|GJ.PT_INNERBEVEL))&&c.bevel++,h=_,_=l[f+1]}}},_flattenPaths:function(t){for(var e=t.paths,n=t.pathOffset,i=t.pathLength;n<i;n++){var r=e[n],o=r.points,a=o[o.length-1],s=o[0];o.length>2&&a.equals(s)&&(r.closed=!0,o.pop(),a=o[o.length-1]);for(var c=0,l=o.length;c<l;c++){var u=new XQ(s.x,s.y);u.subtract(a),a.len=u.length(),(u.x||u.y)&&u.normalize(),a.dx=u.x,a.dy=u.y,a=s,s=o[c+1]}}},_chooseBevel:function(t,e,n,i){var r=n.x,o=n.y,a=0,s=0,c=0,l=0;return 0!==t?(a=r+e.dy*i,s=o-e.dx*i,c=r+n.dy*i,l=o-n.dx*i):(a=c=r+n.dmx*i,s=l=o+n.dmy*i),[a,s,c,l]},_buttCapStart:function(t,e,n,i,r){var o=t.x-e*r,a=t.y-n*r,s=n,c=-e;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_buttCapEnd:function(t,e,n,i,r){var o=t.x+e*r,a=t.y+n*r,s=n,c=-e;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapStart:function(t,e,n,i,r){for(var o=t.x,a=t.y,s=n,c=-e,l=0;l<r;l++){var u=l/(r-1)*C1,h=P1(u)*i,_=I1(u)*i;this._vSet(o-s*h-e*_,a-c*h-n*_,1),this._vSet(o,a,0)}this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapEnd:function(t,e,n,i,r){var o=t.x,a=t.y,s=n,c=-e;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1);for(var l=0;l<r;l++){var u=l/(r-1)*C1,h=P1(u)*i,_=I1(u)*i;this._vSet(o,a,0),this._vSet(o-s*h+e*_,a-c*h+n*_,1)}},_roundJoin:function(t,e,n,i,r){var o=t.dy,a=-t.dx,s=e.dy,c=-e.dx,l=e.x,u=e.y;if(0!=(e.flags&GJ.PT_LEFT)){var h=this._chooseBevel(e.flags&GJ.PT_INNERBEVEL,t,e,n),_=h[0],f=h[1],p=h[2],d=h[3],m=R1(-a,-o),v=R1(-c,-s);v>m&&(v-=2*C1),this._vSet(_,f,1),this._vSet(l-o*i,e.y-a*i,-1);for(var g=L1(E1((m-v)/C1)*r,2,r),y=0;y<g;y++){var x=m+y/(g-1)*(v-m),S=l+P1(x)*i,A=u+I1(x)*i;this._vSet(l,u,0),this._vSet(S,A,-1)}this._vSet(p,d,1),this._vSet(l-s*i,u-c*i,-1)}else{var C=this._chooseBevel(e.flags&GJ.PT_INNERBEVEL,t,e,-i),b=C[0],T=C[1],E=C[2],w=C[3],P=R1(a,o),I=R1(c,s);I<P&&(I+=2*C1),this._vSet(l+o*i,u+a*i,1),this._vSet(b,T,-1);for(var R=L1(E1((I-P)/C1)*r,2,r),D=0;D<R;D++){var B=P+D/(R-1)*(I-P),M=l+P1(B)*n,O=u+I1(B)*n;this._vSet(M,O,1),this._vSet(l,u,0)}this._vSet(l+s*i,u+c*i,1),this._vSet(E,w,-1)}},_bevelJoin:function(t,e,n,i){var r=0,o=0,a=0,s=0,c=0,l=0,u=0,h=0,_=t.dy,f=-t.dx,p=e.dy,d=-e.dx;if(e.flags&GJ.PT_LEFT){var m=this._chooseBevel(e.flags&GJ.PT_INNERBEVEL,t,e,n);c=m[0],l=m[1],u=m[2],h=m[3],this._vSet(c,l,1),this._vSet(e.x-_*i,e.y-f*i,-1),this._vSet(u,h,1),this._vSet(e.x-p*i,e.y-d*i,-1)}else{var v=this._chooseBevel(e.flags&GJ.PT_INNERBEVEL,t,e,-i);r=v[0],o=v[1],a=v[2],s=v[3],this._vSet(e.x+_*n,e.y+f*n,1),this._vSet(r,o,-1),this._vSet(e.x+p*n,e.y+d*n,1),this._vSet(a,s,-1)}},_vSet:function(t,e,n){if(void 0===n&&(n=0),D1){var i=D1,r=8*i.vertexStart,o=i.vData;o[r++]=t,o[r++]=e,o[r++]=0,Li.toArray(o,M1,r),r+=4,o[r++]=n,i.vertexStart++}}},z1=t("graphicsAssembler",{getAssembler:function(){return F1}});$Q.Assembler=z1;var V1=function(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},G1=new Mi,U1=null,k1=null,H1=[],j1=[],W1=[],q1=[],X1=new Di,Y1=new Di,K1=new li,J1=null,Q1=0,Z1=0,$1=0,t2=0,e2=0,n2=1,i2=null,r2="",o2=0,a2=0,s2=0,c2=0,l2=0,u2=0,h2=0,_2=!1,f2=0,p2=0,d2=0,m2={updateRenderData:function(t){t.renderData&&U1!==t&&(t.renderData.vertDirty&&(k1=(U1=t).node._uiProps.uiTransformComp,this._updateFontFamily(t),this._updateProperties(t),this._updateLabelInfo(t),this._updateContent(),U1.actualFontSize=o2,k1.setContentSize(Y1),this.updateUVs(t),U1.renderData.vertDirty=!1,U1.markForUpdateRenderData(!1),U1=null,this._resetProperties()),t.spriteFrame&&t.renderData.updateRenderData(t,t.spriteFrame))},updateUVs:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.vertexCount,r=e.data,o=3,a=0;a<i;a++){var s=r[a];n[o]=s.u,n[o+1]=s.v,o+=9}},_updateFontScale:function(){n2=o2/a2},_updateFontFamily:function(t){var e=t.font;i2=e.spriteFrame,J1=e.fntConfig,LY.fontAtlas=e.fontDefDictionary,bX.packToDynamicAtlas(t,i2)},_updateLabelInfo:function(){LY.hash="",LY.margin=0},_updateProperties:function(t){r2=t.string.toString(),o2=t.fontSize,a2=J1?J1.fontSize:t.fontSize,s2=t.horizontalAlign,c2=t.verticalAlign,l2=t.spacingX,h2=t.overflow,u2=t._lineHeight;var e=k1.contentSize;Y1.width=e.width,Y1.height=e.height,h2===NJ.NONE?(_2=!1,Y1.width+=2*LY.margin,Y1.height+=2*LY.margin):h2===NJ.RESIZE_HEIGHT?(_2=!0,Y1.height+=2*LY.margin):_2=t.enableWrapText,LY.lineHeight=u2,LY.fontSize=o2,this._setupBMFontOverflowMetrics()},_resetProperties:function(){J1=null,i2=null,LY.hash="",LY.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var t=r2,e=t.length,n=J1.kerningDict,i=H1,r=-1,o=0;o<e;++o){var a=t.charCodeAt(o),s=n[r<<16|65535&a]||0;i[o]=o<e-1?s:0,r=a}},_multilineTextWrap:function(t){for(var e=r2.length,n=0,i=0,r=0,o=0,a=0,s=0,c=0,l=null,u=0;u<e;){var h=r2.charAt(u);if("\n"!==h){for(var _=t(r2,u,e),f=s,p=c,d=a,m=i,v=!1,g=0;g<_;++g){var y=u+g;if("\r"!==(h=r2.charAt(y)))if(l=LY.fontAtlas.getLetterDefinitionForChar(h,LY)){var x=m+l.offsetX*n2-LY.margin;if(_2&&d2>0&&i>0&&x+l.w*n2>d2&&!uY(h)){W1.push(a),a=0,n++,i=0,r-=u2*this._getFontScale()+0,v=!0;break}K1.x=x,K1.y=r-l.offsetY*n2,this._recordLetterInfo(K1,h,y,n),y+1<H1.length&&y<e-1&&(m+=H1[y+1]),m+=l.xAdvance*n2+l2,d=K1.x+l.w*n2,f<K1.y&&(f=K1.y),p>K1.y-l.h*n2&&(p=K1.y-l.h*n2)}else this._recordPlaceholderInfo(y,h),console.log("Can't find letter definition in texture atlas "+J1.atlasName+" for letter:"+h);else this._recordPlaceholderInfo(y,h)}v||(i=m,s<f&&(s=f),c>p&&(c=p),o<(a=d)&&(o=a),u+=_)}else W1.push(a),a=0,n++,i=0,r-=u2*this._getFontScale()+0,this._recordPlaceholderInfo(u,h),u++}return W1.push(a),Z1=(Q1=n+1)*u2*this._getFontScale(),Q1>1&&(Z1+=0*(Q1-1)),Y1.width=f2,Y1.height=p2,f2<=0&&(Y1.width=parseFloat(o.toFixed(2))+2*LY.margin),p2<=0&&(Y1.height=parseFloat(Z1.toFixed(2))+2*LY.margin),t2=Y1.height,e2=0,s>0&&(t2=Y1.height+s),c<-Z1&&(e2=Z1+c),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return h2===NJ.SHRINK?n2:1},_getFirstWordLen:function(t,e,n){var i=t.charAt(e);if(lY(i)||"\n"===i||uY(i))return 1;var r=1,o=LY.fontAtlas.getLetterDefinitionForChar(i,LY);if(!o)return r;for(var a=o.xAdvance*n2+l2,s=e+1;s<n&&(i=t.charAt(s),o=LY.fontAtlas.getLetterDefinitionForChar(i,LY));++s){if(a+o.offsetX*n2+o.w*n2>d2&&!uY(i)&&d2>0)return r;if(a+=o.xAdvance*n2+l2,"\n"===i||uY(i)||lY(i))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(t,e){if(t>=j1.length){var n=new V1;j1.push(n)}j1[t].char=e,j1[t].hash=""+e.charCodeAt(0)+LY.hash,j1[t].valid=!1},_recordLetterInfo:function(t,e,n,i){if(n>=j1.length){var r=new V1;j1.push(r)}var o=""+e.charCodeAt(0)+LY.hash;j1[n].line=i,j1[n].char=e,j1[n].hash=o,j1[n].valid=LY.fontAtlas.getLetter(o).valid,j1[n].x=t.x,j1[n].y=t.y},_alignText:function(){Z1=0,W1.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),h2===NJ.SHRINK&&o2>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||h2===NJ.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(t){var e=!0;t||(t=.1,e=!1),o2=t,e&&this._updateContent()},_shrinkLabelToContentSize:function(t){for(var e=0,n=0|o2,i=0;e<n;){var r=i=e+n+1>>1;if(r<=0)break;n2=r/a2,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),t()?n=i-1:e=i}e>=0&&this._scaleFontSizeDown(e)},_isVerticalClamp:function(){return Z1>Y1.height},_isHorizontalClamp:function(){for(var t=!1,e=0,n=r2.length;e<n;++e){var i=j1[e];if(i.valid){var r=LY.fontAtlas.getLetterDefinitionForChar(i.char,LY);if(!r)continue;var o=i.x+r.w*n2,a=i.line;if(f2>0)if(_2){if(W1[a]>Y1.width&&(o>Y1.width||o<0)){t=!0;break}}else if(o>Y1.width){t=!0;break}}}return t},_isHorizontalClamped:function(t,e){var n=W1[e],i=t>Y1.width||t<0;return _2?n>Y1.width&&i:i},_updateQuads:function(){if(!U1)return!1;var t=i2?i2.texture:LY.fontAtlas.getTexture(),e=U1.renderData;e.dataLength=0,e.resize(0,0);for(var n=k1.anchorPoint,i=Y1,r=n.x*i.width,o=n.y*i.height,a=!0,s=0,c=r2.length;s<c;++s){var l=j1[s];if(l.valid){var u=LY.fontAtlas.getLetter(l.hash);if(u){G1.height=u.h,G1.width=u.w,G1.x=u.u,G1.y=u.v;var h=l.y+$1;if(p2>0){if(h>t2){var _=h-t2;G1.y+=_,G1.height-=_,h-=_}h-u.h*n2<e2&&h2===NJ.CLAMP&&(G1.height=h<e2?0:(h-e2)/n2)}var f=l.line,p=l.x+u.w/2*n2+q1[f];if(f2>0&&this._isHorizontalClamped(p,f))if(h2===NJ.CLAMP)G1.width=0;else if(h2===NJ.SHRINK){if(Y1.width>u.w){a=!1;break}G1.width=0}if(G1.height>0&&G1.width>0){var d=this._determineRect(),m=l.x+q1[l.line];this.appendQuad(U1,t,G1,d,m-r,h-o,n2)}}else console.warn("Can't find letter in this bitmap-font")}}return a},appendQuad:function(){},_determineRect:function(){var t=i2.isRotated(),e=i2.getOriginalSize(),n=i2.getRect(),i=i2.getOffset(),r=i.x+(e.width-n.width)/2,o=i.y-(e.height-n.height)/2;if(t){var a=G1.x;G1.x=n.x+n.height-G1.y-G1.height-o,G1.y=a+n.y-r,G1.y<0&&(G1.height+=o)}else G1.x+=n.x-r,G1.y+=n.y+o;return t},_computeAlignmentOffset:function(){switch(q1.length=0,s2){case MJ.LEFT:for(var t=0;t<Q1;++t)q1.push(0);break;case MJ.CENTER:for(var e=0,n=W1.length;e<n;e++)q1.push((Y1.width-W1[e])/2);break;case MJ.RIGHT:for(var i=0,r=W1.length;i<r;i++)q1.push(Y1.width-W1[i])}if($1=Y1.height,c2!==OJ.TOP){var o=Y1.height-Z1+u2*this._getFontScale()-a2*n2;c2===OJ.BOTTOM?$1-=o:$1-=o/2}},_setupBMFontOverflowMetrics:function(){var t=Y1.width,e=Y1.height;h2===NJ.RESIZE_HEIGHT&&(e=0),h2===NJ.NONE&&(t=0,e=0),f2=t,p2=e,X1.width=t,X1.height=e,d2=t}},v2=new Li(255,255,255,255),g2={createData:function(t){return t.requestRenderData()},fillBuffers:function(t){var e=t.node;v2.set(t.color),v2.a=255*e._uiProps.opacity,vX(e,0,t.renderData,v2)},appendQuad:function(t,e,n,i,r,o,a){var s=t.renderData;if(s){var c=s.dataLength;s.dataLength+=4,s.resize(s.dataLength,s.dataLength/2*3);var l=s.data,u=e.width,h=e.height,_=n.width,f=n.height,p=0,d=0,m=0,v=0;i?(p=n.x/u,v=(n.x+f)/u,d=(n.y+_)/h,m=n.y/h,l[c].u=p,l[c].v=m,l[c+1].u=p,l[c+1].v=d,l[c+2].u=v,l[c+2].v=m,l[c+3].u=v,l[c+3].v=d):(p=n.x/u,v=(n.x+_)/u,d=(n.y+f)/h,m=n.y/h,l[c].u=p,l[c].v=d,l[c+1].u=v,l[c+1].v=d,l[c+2].u=p,l[c+2].v=m,l[c+3].u=v,l[c+3].v=m),l[c].x=r,l[c].y=o-f*a,l[c+1].x=r+_*a,l[c+1].y=o-f*a,l[c+2].x=r,l[c+2].y=o,l[c+3].x=r+_*a,l[c+3].y=o}},updateColor:function(){}};Ct(g2,m2);var y2=null,x2=bt(m2,{getAssemblerData:function(){return y2||(y2=new NY(1024,1024)),y2.getTexture()},_updateFontFamily:function(t){LY.fontAtlas=y2,LY.fontFamily=this._getFontFamily(t);var e=t.getComponent(p$);e&&e.enabled?(LY.isOutlined=!0,LY.margin=e.width,LY.out=e.color.clone(),LY.out.a=e.color.a*t.color.a/255):(LY.isOutlined=!1,LY.margin=0)},_getFontFamily:function(t){var e="Arial";return t.useSystemFont?e=t.fontFamily||"Arial":t.font&&(e=t.font._nativeAsset||"Arial"),e},_updateLabelInfo:function(t){LY.fontDesc=this._getFontDesc(),LY.color=t.color,LY.hash=function(t){var e=t.color.toHEX(),n="";return t.isOutlined&&t.margin>0&&(n=n+t.margin+t.out.toHEX()),""+t.fontSize+t.fontFamily+e+n}(LY)},_getFontDesc:function(){return LY.fontSize.toString()+"px "+LY.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),S2=new Li(255,255,255,255),A2={createData:function(t){return t.requestRenderData()},fillBuffers:function(t){if(t.renderData){var e=t.node;S2.a=255*e._uiProps.opacity,vX(e,0,t.renderData,S2)}},updateColor:function(){},appendQuad:g2.appendQuad};Ct(A2,x2);var C2=UJ.Overflow,b2=(1/255).toFixed(3),T2=null,E2=null,w2=null,P2="",I2="",R2=0,D2=0,B2=[],M2=new Di,O2=0,N2=0,L2=0,F2=new Li,z2="",V2=C2.NONE,G2=!1,U2=null,k2=Li.BLACK.clone(),H2=null,j2=Li.BLACK.clone(),W2=new Mi,q2=Di.ZERO.clone(),X2=Di.ZERO.clone(),Y2=li.ZERO.clone(),K2=li.ZERO.clone(),J2=0,Q2=0,Z2=!1,$2=!1,t4=!1,e4=["left","center","right"],n4={getAssemblerData:function(){return UJ._canvasPool.get()},resetAssemblerData:function(t){t&&UJ._canvasPool.put(t)},updateRenderData:function(t){if(t.renderData){if(t.renderData.vertDirty){var e=t.node._uiProps.uiTransformComp;this._updateFontFamily(t),this._updateProperties(t,e),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(t),this._calDynamicAtlas(t),t.actualFontSize=R2,e.setContentSize(M2),this.updateVertexData(t),this.updateUVs(t),t.markForUpdateRenderData(!1),T2=null,E2=null,w2=null}t.spriteFrame&&t.renderData.updateRenderData(t,t.spriteFrame)}},updateVertexData:function(){},updateUVs:function(){},_updateFontFamily:function(t){z2=t.useSystemFont?t.fontFamily||"Arial":t.font&&t.font._nativeAsset||"Arial"},_updateProperties:function(t,e){var n=t.assemblerData;n&&(T2=n.context,E2=n.canvas,w2=t.spriteFrame,I2=t.string.toString(),R2=t.fontSize,D2=R2,V2=t.overflow,X2.width=M2.width=e.width,X2.height=M2.height=e.height,Q2=t.underlineHeight,O2=t.lineHeight,N2=t.horizontalAlign,L2=t.verticalAlign,F2=t.color,t.node._uiProps.opacity,Z2=t.isBold,$2=t.isItalic,t4=t.isUnderline,G2=V2!==C2.NONE&&(V2===C2.RESIZE_HEIGHT||t.enableWrapText),(U2=(U2=p$&&t.getComponent(p$))&&U2.enabled&&U2.width>0?U2:null)&&k2.set(U2.color),(H2=(H2=t1&&t.getComponent(t1))&&H2.enabled?H2:null)&&j2.set(H2.color),this._updatePaddingRect())},_updatePaddingRect:function(){var t=0,e=0,n=0,i=0,r=0;if(q2.width=q2.height=0,U2&&(t=e=n=i=r=U2.width,q2.width=q2.height=2*r),H2){var o=H2.blur+r,a=H2.offset.x,s=H2.offset.y;n=Math.max(n,-a+o),i=Math.max(i,a+o),t=Math.max(t,s+o),e=Math.max(e,-s+o)}if($2){var c=D2*Math.tan(.20943951);i+=c,q2.width+=c}W2.x=n,W2.y=t,W2.width=n+i,W2.height=t+e},_calculateFillTextStartPosition:function(){var t=0;N2===MJ.RIGHT?t=M2.width-W2.width:N2===MJ.CENTER&&(t=(M2.width-W2.width)/2);var e=this._getLineHeight()*(B2.length-1),n=R2*(1-$X/2);if(L2!==OJ.TOP){var i=e+W2.height+R2-M2.height;L2===OJ.BOTTOM?n-=i+=$X/2*R2:n-=i/2}n+=0*R2,Y2.set(t+W2.x,n+W2.y)},_updateTexture:function(t){if(T2&&E2){T2.clearRect(0,0,E2.width,E2.height),T2.font=P2,this._calculateFillTextStartPosition();var e=this._getLineHeight();T2.lineJoin="round",U2?(T2.fillStyle="rgba("+k2.r+", "+k2.g+", "+k2.b+", "+b2+")",T2.fillRect(0,0,E2.width,E2.height)):t._srcBlendFactor===Ir.SRC_ALPHA&&(T2.fillStyle="rgba("+F2.r+", "+F2.g+", "+F2.b+", "+b2+")",T2.fillRect(0,0,E2.width,E2.height)),T2.fillStyle="rgb("+F2.r+", "+F2.g+", "+F2.b+")";var n=Y2.x,i=0;this._drawTextEffect(Y2,e);for(var r=0;r<B2.length;++r)i=Y2.y+r*e,U2&&T2.strokeText(B2[r],n,i),T2.fillText(B2[r],n,i);H2&&(T2.shadowColor="transparent"),this._uploadTexture(t)}},_uploadTexture:function(t){if(t.cacheMode===UJ.CacheMode.BITMAP){var e=t.ttfSpriteFrame;bX.deleteAtlasSpriteFrame(e),e._resetDynamicAtlasFrame()}var n;w2&&E2&&(n=w2 instanceof RX?w2.texture:w2,0!==E2.width&&0!==E2.height&&(n.reset({width:E2.width,height:E2.height,mipmapLevel:1}),n.uploadData(E2),w2 instanceof RX&&(w2.rect=new Mi(0,0,E2.width,E2.height),w2._calculateUV()),t.renderData&&(t.renderData.textureDirty=!0),i.director.root&&i.director.root.batcher2D&&i.director.root.batcher2D._releaseDescriptorSetCache(n.getHash())))},_calDynamicAtlas:function(t){if(t.cacheMode===UJ.CacheMode.BITMAP){var e=t.ttfSpriteFrame;bX.packToDynamicAtlas(t,e)}},_setupOutline:function(){T2.strokeStyle="rgba("+k2.r+", "+k2.g+", "+k2.b+", "+k2.a/255+")",T2.lineWidth=2*U2.width},_setupShadow:function(){T2.shadowColor="rgba("+j2.r+", "+j2.g+", "+j2.b+", "+j2.a/255+")",T2.shadowBlur=H2.blur,T2.shadowOffsetX=H2.offset.x,T2.shadowOffsetY=-H2.offset.y},_drawTextEffect:function(t,e){if(H2||U2||t4){var n=B2.length>1&&H2,i=this._measureText(T2,P2),r=0,o=0;H2&&this._setupShadow(),U2&&this._setupOutline();for(var a=0;a<B2.length;++a)r=t.x,o=t.y+a*e,n&&(U2&&T2.strokeText(B2[a],r,o),T2.fillText(B2[a],r,o)),t4&&(J2=i(B2[a]),N2===MJ.RIGHT?K2.x=t.x-J2:N2===MJ.CENTER?K2.x=t.x-J2/2:K2.x=t.x,K2.y=o+D2/8,T2.fillRect(K2.x,K2.y,J2,Q2));n&&(T2.shadowColor="transparent")}},_updateLabelDimensions:function(){M2.width=Math.min(M2.width,2048),M2.height=Math.min(M2.height,2048);var t=!1;E2.width!==M2.width&&(E2.width=M2.width,t=!0),E2.height!==M2.height&&(E2.height=M2.height,t=!0),t&&(T2.font=P2),T2.textAlign=e4[N2],T2.textBaseline="alphabetic"},_getFontDesc:function(){var t=R2.toString()+"px ";return t+=z2,Z2&&(t="bold "+t),$2&&(t="italic "+t),t},_getLineHeight:function(){return 0|(0===O2?R2:O2*R2/D2)},_calculateParagraphLength:function(t,e){for(var n,i=[],r=W(t);!(n=r()).done;){var o=hY(e,n.value,P2);i.push(o)}return i},_measureText:function(t,e){return function(n){return hY(t,n,e)}},_calculateShrinkFont:function(t){if(T2){var e=this._calculateParagraphLength(t,T2),n=0,i=0,r=0;if(G2){var o=X2.width,a=X2.height;if(o<0||a<0)return;i=a+1;for(var s=0,c=0|R2+1,l=0;s<c;){if((l=s+c+1>>1)<=0){A(4003);break}R2=l,P2=this._getFontDesc(),T2.font=P2;var u=this._getLineHeight();for(i=0,n=0;n<t.length;++n){var h=hY(T2,t[n],P2);i+=fY(t[n],h,o,this._measureText(T2,P2)).length*u}i>a?c=l-1:s=l}0===s?A(4003):(R2=s,P2=this._getFontDesc(),T2.font=P2)}else{for(i=t.length*this._getLineHeight(),n=0;n<t.length;++n)r<e[n]&&(r=e[n]);var _=(M2.width-W2.width)/r,f=M2.height/i;R2=D2*Math.min(1,_,f)|0,P2=this._getFontDesc(),T2.font=P2}}},_calculateWrapText:function(t){if(G2&&T2){B2=[];for(var e=X2.width,n=0;n<t.length;++n){var i=hY(T2,t[n],P2),r=fY(t[n],i,e,this._measureText(T2,P2));B2=B2.concat(r)}}},_calculateLabelFont:function(){if(T2){var t=I2.split("\n");switch(B2=t,P2=this._getFontDesc(),T2.font=P2,V2){case C2.NONE:for(var e=0,n=0,i=0;i<t.length;++i){var r=hY(T2,t[i],P2);e=e>r?e:r}n=(B2.length+$X)*this._getLineHeight();var o=parseFloat(e.toFixed(2)),a=parseFloat(n.toFixed(2));M2.width=o+W2.width,M2.height=a+W2.height,X2.width=o+q2.width,X2.height=a+q2.height;break;case C2.SHRINK:this._calculateShrinkFont(t),this._calculateWrapText(t);break;case C2.CLAMP:this._calculateWrapText(t);break;case C2.RESIZE_HEIGHT:this._calculateWrapText(t);var s=(B2.length+$X)*this._getLineHeight();M2.height=s+W2.height,X2.height=s+q2.height}}}},i4=Li.WHITE.clone(),r4={createData:function(t){var e=t.requestRenderData();e.dataLength=2,e.resize(4,6);var n=e.chunk.vb;n[3]=n[21]=n[22]=n[31]=0,n[4]=n[12]=n[13]=n[30]=1;for(var i=5,r=0;r<4;r++)Li.toArray(n,i4,i),i+=9;return e},fillBuffers:function(t){var e=t.renderData.chunk,n=t.renderData.data,i=t.node,r=e.vb,o=n[0],a=n[1];i.updateWorldTransform();var s=i._pos,c=i._rot,l=i._scale,u=o.x*l.x,h=a.x*l.x,_=o.y*l.y,f=a.y*l.y,p=c.x,d=c.y,m=c.z,v=c.w,g=p*d,y=m*v,x=p*p-d*d,S=v*v-m*m,A=S+x,C=2*(g-y),b=S-x,T=2*(g+y),E=s.x,w=s.y;r[0]=A*u+C*_+E,r[1]=b*_+T*u+w,r[9]=A*h+C*_+E,r[10]=b*_+T*h+w,r[18]=A*u+C*f+E,r[19]=b*f+T*u+w,r[27]=A*h+C*f+E,r[28]=b*f+T*h+w;var P=e.bufferId,I=e.vertexOffset,R=e.vertexAccessor.getMeshBuffer(e.bufferId),D=e.vertexAccessor.getIndexBuffer(P),B=R.indexOffset;D[B++]=I,D[B++]=I+1,D[B++]=I+2,D[B++]=I+2,D[B++]=I+1,D[B++]=I+3,R.indexOffset+=6},updateVertexData:function(t){var e=t.renderData;if(e){var n=t.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=e.data;s[0].x=-o,s[0].y=-a,s[1].x=i-o,s[1].y=r-a}},updateUVs:function(t){var e=t.renderData;if(e&&t.ttfSpriteFrame){var n=e.chunk.vb,i=t.ttfSpriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7]}},updateColor:function(){}};Ct(r4,n4);var o4=t("labelAssembler",{getAssembler:function(t){var e=r4;return t.font instanceof QX?e=g2:t.cacheMode===UJ.CacheMode.CHAR&&(e=A2),e}});UJ.Assembler=o4;var a4=I$.FillType,s4=new Ei,c4=new oi,l4={updateRenderData:function(t){var e=t.spriteFrame;bX.packToDynamicAtlas(t,e);var n=t.renderData;if(n&&e){if(n.updateRenderData(t,e),!n.vertDirty)return;var i=t.fillStart,r=t.fillRange;r<0&&(i+=r,r=-r),r=(r=(r=i+r)>1?1:r)<0?0:r;var o=(i=(i=i>1?1:i)<0?0:i)+(r=(r-=i)<0?0:r);o=o>1?1:o,this.updateUVs(t,i,o),this.updateVertexData(t,i,o)}},updateUVs:function(t,e,n){var i=t.spriteFrame,r=t.renderData.chunk.vb,o=i.width,a=i.height,s=i.rect,c=0,l=0,u=0,h=0,_=0,f=0,p=0,d=0,m=0,v=0;switch(i.isRotated()?(c=s.x/o,l=(s.y+s.width)/a,u=_=c,p=m=(s.x+s.height)/o,f=v=l,h=d=s.y/a):(c=s.x/o,l=(s.y+s.height)/a,u=p=c,_=m=(s.x+s.width)/o,h=f=l,d=v=s.y/a),t.fillType){case a4.HORIZONTAL:r[3]=u+(_-u)*e,r[4]=h+(f-h)*e,r[12]=u+(_-u)*n,r[13]=h+(f-h)*n,r[21]=p+(m-p)*e,r[22]=d+(v-d)*e,r[30]=p+(m-p)*n,r[31]=d+(v-d)*n;break;case a4.VERTICAL:r[3]=u+(p-u)*e,r[4]=h+(d-h)*e,r[12]=_+(m-_)*e,r[13]=f+(v-f)*e,r[21]=u+(p-u)*n,r[22]=h+(d-h)*n,r[30]=_+(m-_)*n,r[31]=f+(v-f)*n;break;default:E(2626)}},updateVertexData:function(t,e,n){var i=t.renderData.data,r=t.node._uiProps.uiTransformComp,o=r.width,a=r.height,s=r.anchorX*o,c=r.anchorY*a,l=-s,u=-c,h=o-s,_=a-c,f=0;switch(t.fillType){case a4.HORIZONTAL:f=l+(h-l)*n,l+=(h-l)*e,h=f;break;case a4.VERTICAL:f=u+(_-u)*n,u+=(_-u)*e,_=f;break;default:E(2626)}i[0].x=l,i[0].y=u,i[1].x=h,i[1].y=u,i[2].x=l,i[2].y=_,i[3].x=h,i[3].y=_},createData:function(t){var e=t.requestRenderData();e.dataLength=4,e.resize(4,6);for(var n,i=W(e.data);!(n=i()).done;)n.value.z=0;return e},updateWorldVertexData:function(t,e){t.node.getWorldMatrix(s4);for(var n=t.renderData.floatStride,i=t.renderData.data,r=e.vb,o=0,a=0;a<4;a++){var s=i[a];oi.transformMat4(c4,s,s4),r[o=a*n]=c4.x,r[o+1]=c4.y,r[o+2]=c4.z}},fillBuffers:function(t){var e=t.renderData,n=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVertexData(t,n),e.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6},updateColor:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=5,o=t.color,a=o.r/255,s=o.g/255,c=o.b/255,l=t.node._uiProps.opacity,u=0;u<4;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},u4=2*Math.PI,h4=1e-6,_4=new Ei,f4=new oi,p4=[new li,new li,new li,new li],d4=new Array(4),m4=new Array(8),v4=[new li,new li,new li,new li],g4=[new li,new li,new li,new li],y4=new li,x4=[new li,new li,new li,new li];function S4(t,e,n,i,r,o,a){var s=Math.sin(o);s=Math.abs(s)>h4?s:0;var c=Math.cos(o),l=0,u=0;if(0!==(c=Math.abs(c)>h4?c:0)){if(l=s/c,(t-r.x)*c>0){var h=r.y+l*(t-r.x);a[0].x=t,a[0].y=h}if((e-r.x)*c>0){var _=r.y+l*(e-r.x);a[2].x=e,a[2].y=_}}if(0!==s){if(u=c/s,(i-r.y)*s>0){var f=r.x+u*(i-r.y);a[3].x=f,a[3].y=i}if((n-r.y)*s>0){var p=r.x+u*(n-r.y);a[1].x=p,a[1].y=n}}}function A4(t,e){var n=e.x-t.x,i=e.y-t.y;if(0===n&&0===i)return 0;if(0===n)return i>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(i/n);return n<0&&(r+=Math.PI),r}function C4(t,e,n,i,r){var o=d4,a=o[0],s=o[1],c=o[2],l=o[3];t[e].x=n.x,t[e].y=n.y,t[e+1].x=i.x,t[e+1].y=i.y,t[e+2].x=r.x,t[e+2].y=r.y,b4((n.x-a)/(c-a),(n.y-s)/(l-s),t,e),b4((i.x-a)/(c-a),(i.y-s)/(l-s),t,e+1),b4((r.x-a)/(c-a),(r.y-s)/(l-s),t,e+2)}function b4(t,e,n,i){var r=m4,o=r[0]+(r[2]-r[0])*t,a=r[4]+(r[6]-r[4])*t,s=r[1]+(r[3]-r[1])*t,c=r[5]+(r[7]-r[5])*t,l=n[i];l.u=o+(a-o)*e,l.v=s+(c-s)*e}for(var T4={useModel:!1,createData:function(t){return t.requestRenderData()},updateRenderData:function(t){var e=t.spriteFrame;bX.packToDynamicAtlas(t,e),this.updateUVs(t);var n=t.renderData;if(n&&e){if(!n.vertDirty)return;var i=n.data,r=t.fillStart,o=t.fillRange;for(o<0&&(r+=o,o=-o);r>=1;)r-=1;for(;r<0;)r+=1;var a=(r*=u4)+(o*=u4);!function(t){var e=t.node._uiProps.uiTransformComp,n=e.width,i=e.height,r=e.anchorX*n,o=e.anchorY*i,a=-r,s=-o,c=n-r,l=i-o,u=d4;u[0]=a,u[1]=s,u[2]=c,u[3]=l;var h=t.fillCenter,_=y4.x=Math.min(Math.max(0,h.x),1)*(c-a)+a,f=y4.y=Math.min(Math.max(0,h.y),1)*(l-s)+s;p4[0].x=p4[3].x=a,p4[1].x=p4[2].x=c,p4[0].y=p4[1].y=s,p4[2].y=p4[3].y=l;for(var p,d=W(x4);!(p=d()).done;){var m=p.value;li.set(m,0,0)}_!==u[0]&&li.set(x4[0],3,0),_!==u[2]&&li.set(x4[2],1,2),f!==u[1]&&li.set(x4[1],0,1),f!==u[3]&&li.set(x4[3],2,3)}(t),function(t){var e=t.width,n=t.height,i=t.getRect(),r=0,o=0,a=0,s=0,c=m4;t.isRotated()?(r=i.x/e,o=(i.x+i.height)/e,a=i.y/n,s=(i.y+i.width)/n,c[0]=c[2]=r,c[4]=c[6]=o,c[3]=c[7]=s,c[1]=c[5]=a):(r=i.x/e,o=(i.x+i.width)/e,a=i.y/n,s=(i.y+i.height)/n,c[0]=c[4]=r,c[2]=c[6]=o,c[1]=c[3]=s,c[5]=c[7]=a)}(e),S4(d4[0],d4[2],d4[1],d4[3],y4,r,v4),S4(d4[0],d4[2],d4[1],d4[3],y4,r+o,g4);for(var s=0,c=0;c<4;++c){var l=x4[c];if(l)if(o>=u4)n.dataLength=s+3,C4(i,s,y4,p4[l.x],p4[l.y]),s+=3;else{var u=A4(y4,p4[l.x]),h=A4(y4,p4[l.y]);h<u&&(h+=u4),u-=u4,h-=u4;for(var _=0;_<3;++_)u>=a||(u>=r?(n.dataLength=s+3,C4(i,s,y4,p4[l.x],h>=a?g4[c]:p4[l.y]),s+=3):h>r&&(h<=a?(n.dataLength=s+3,C4(i,s,y4,v4[c],p4[l.y]),s+=3):(n.dataLength=s+3,C4(i,s,y4,v4[c],g4[c]),s+=3))),u+=u4,h+=u4}}n.resize(s,s),n.updateRenderData(t,e)}},fillBuffers:function(t){var e=t.node,n=t.renderData,i=n.chunk;(e.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(t,i),n.vertDirty=!1),this.updataColorLate(t);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l++)s[c+l]=o+l;a.indexOffset+=n.indexCount,a.setDirty()},updateWorldVertexAndUVData:function(t,e){t.node.getWorldMatrix(_4);for(var n=t.renderData,i=n.floatStride,r=t.renderData.data,o=e.vb,a=n.vertexCount,s=0,c=0;c<a;c++){var l=r[c];oi.set(f4,l.x,l.y,0),oi.transformMat4(f4,f4,_4),o[s+0]=f4.x,o[s+1]=f4.y,o[s+2]=f4.z,o[s+3]=l.u,o[s+4]=l.v,s+=i}},updateUVs:function(t){t.renderData.vertDirty=!0,t.markForUpdateRenderData()},updataColorLate:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=e.vertexCount,o=5,a=t.color,s=a.r/255,c=a.g/255,l=a.b/255,u=t.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},E4=[],w4=0;w4<4;w4++)E4.push(new oi);for(var P4={createData:function(t){var e=t.requestRenderData();return e.dataLength=2,e.resize(4,6),e},updateRenderData:function(t){var e=t.spriteFrame;bX.packToDynamicAtlas(t,e),this.updateUVs(t);var n=t.renderData;n&&e&&(n.vertDirty&&this.updateVertexData(t),n.updateRenderData(t,e))},updateWorldVerts:function(t,e){var n=t.renderData,i=e.vb,r=n.data,o=t.node,a=r[0],s=r[1],c=o.worldMatrix,l=c.m00,u=c.m01,h=c.m04,_=c.m05,f=1===l&&0===u&&0===h&&1===_,p=c.m12,d=c.m13,m=a.x,v=s.x,g=a.y,y=s.y;if(f){var x=m+p,S=v+p,A=g+d,C=y+d;i[0]=x,i[1]=A,i[9]=S,i[10]=A,i[18]=x,i[19]=C,i[27]=S,i[28]=C}else{var b=l*m,T=l*v,E=u*m,w=u*v,P=h*g+p,I=h*y+p,R=_*g+d,D=_*y+d;i[0]=b+P,i[1]=E+R,i[9]=T+P,i[10]=w+R,i[18]=b+I,i[19]=E+D,i[27]=T+I,i[28]=w+D}},fillBuffers:function(t){if(null!==t){var e=t.renderData,n=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVerts(t,n),e.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6}},updateVertexData:function(t){var e=t.renderData;if(e){var n=t.node._uiProps.uiTransformComp,i=e.data,r=n.width,o=n.height,a=n.anchorX*r,s=n.anchorY*o,c=0,l=0,u=0,h=0;if(t.trim)c=-a,l=-s,u=r-a,h=o-s;else{var _=t.spriteFrame,f=_.getOriginalSize(),p=_.getRect(),d=f.width,m=f.height,v=p.width,g=p.height,y=_.getOffset(),x=r/d,S=o/m,A=y.x+(d-v)/2,C=y.x-(d-v)/2;c=A*x-a,l=(y.y+(m-g)/2)*S-s,u=r+C*x-a,h=o+(y.y-(m-g)/2)*S-s}i[0].x=c,i[0].y=l,i[1].x=u,i[1].y=h,e.vertDirty=!0}},updateUVs:function(t){if(t.spriteFrame){var e=t.renderData.chunk.vb,n=t.spriteFrame.uv;e[3]=n[0],e[4]=n[1],e[12]=n[2],e[13]=n[3],e[21]=n[4],e[22]=n[5],e[30]=n[6],e[31]=n[7]}},updateColor:function(t){for(var e=t.renderData,n=e.chunk.vb,i=5,r=t.color,o=r.r/255,a=r.g/255,s=r.b/255,c=r.a/255,l=0;l<4;l++,i+=e.floatStride)n[i]=o,n[i+1]=a,n[i+2]=s,n[i+3]=c}},I4=new oi,R4=new Ei,D4={createData:function(t){var e=t.requestRenderData();return e.dataLength=4,e.resize(16,54),e},updateRenderData:function(t){var e=t.spriteFrame;bX.packToDynamicAtlas(t,e),this.updateUVs(t);var n=t.renderData;n&&e&&(n.vertDirty&&this.updateVertexData(t),n.updateRenderData(t,e))},updateVertexData:function(t){var e=t.renderData.data,n=t.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=t.spriteFrame,c=s.insetLeft,l=s.insetRight,u=s.insetTop,h=s.insetBottom,_=i-c-l,f=r-u-h,p=i/(c+l),d=r/(u+h);p=Number.isNaN(p)||p>1?1:p,d=Number.isNaN(d)||d>1?1:d,_=_<0?0:_,f=f<0?0:f,e[0].x=-o,e[0].y=-a,e[1].x=c*p-o,e[1].y=h*d-a,e[2].x=e[1].x+_,e[2].y=e[1].y+f,e[3].x=i-o,e[3].y=r-a},fillBuffers:function(t){var e=t.renderData,n=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVertexData(t,n),e.vertDirty=!1);for(var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset,c=0;c<3;++c)for(var l=0;l<3;++l){var u=r+4*c+l;a[s++]=u,a[s++]=u+1,a[s++]=u+4,a[s++]=u+1,a[s++]=u+5,a[s++]=u+4}o.indexOffset=s},updateWorldVertexData:function(t,e){t.node.getWorldMatrix(R4);for(var n=t.renderData,i=n.floatStride,r=n.data,o=e.vb,a=0,s=0;s<4;++s)for(var c=r[s],l=0;l<4;++l){var u=r[l];oi.set(I4,u.x,c.y,0),oi.transformMat4(I4,I4,R4),a=(4*s+l)*i,o[a++]=I4.x,o[a++]=I4.y,o[a++]=I4.z}},updateUVs:function(t){if(t.spriteFrame)for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=t.spriteFrame.uvSliced,o=3,a=0;a<16;a++)n[o]=r[a].u,n[o+1]=r[a].v,o+=i},updateColor:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=5,o=t.color,a=o.r/255,s=o.g/255,c=o.b/255,l=t.node._uiProps.opacity,u=0;u<16;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},B4=[],M4=0;M4<4;M4++)B4.push(new oi);var O4=new Ei,N4={createData:function(t){return t.requestRenderData()},updateRenderData:function(t){var e=t.renderData,n=t.spriteFrame;if(n&&e&&(e.updateRenderData(t,n),e.vertDirty)){var i=t.node._uiProps.uiTransformComp,r=Math.abs(i.width),o=Math.abs(i.height),a=n.getRect(),s=n.insetLeft,c=n.insetRight,l=a.width-s-c,u=n.insetTop,h=n.insetBottom,_=a.height-u-h,f=r-s-c,p=o-u-h;f=f>0?f:0,p=p>0?p:0;var d=0===l?f:f/l,m=0===_?p:p/_,v=Math.ceil(m+2),g=Math.ceil(d+2);e.dataLength=Math.max(8,v+1,g+1),this.updateVerts(t,f,p,v,g),e.resize(v*g*4,v*g*6)}},updateUVs:function(t){t.renderData.vertDirty=!0,t.markForUpdateRenderData()},fillBuffers:function(t){var e=t.node,n=t.renderData,i=n.chunk;(e.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(t,i),n.vertDirty=!1),this.updataColorLate(t);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l+=6)s[c++]=o,s[c++]=o+1,s[c++]=o+2,s[c++]=o+1,s[c++]=o+3,s[c++]=o+2,o+=4,a.indexOffset+=6;a.setDirty()},updateWorldVertexAndUVData:function(t,e){var n=t.node;n.getWorldMatrix(O4);var i=t.renderData,r=i.floatStride,o=i.data,a=e.vb,s=n._uiProps.uiTransformComp,c=Math.abs(s.width),l=Math.abs(s.height),u=t.spriteFrame,h=u.rotated,_=u.uv,f=u.uvSliced,p=u.rect,d=u.insetLeft,m=u.insetRight,v=p.width-d-m,g=u.insetTop,y=u.insetBottom,x=p.height-g-y,S=c-d-m,A=l-g-y;S=S>0?S:0,A=A>0?A:0;for(var C=0===v?S:S/v,b=0===x?A:A/x,T=Math.ceil(b+2),E=Math.ceil(C+2),w=0,P=0,I=0,R=0,D=0,B=0,M=T;B<M;++B){R=o[B].y,D=o[B+1].y;for(var O=0,N=E;O<N;++O){P=o[O].x,I=o[O+1].x,oi.set(B4[0],P,R,0),oi.set(B4[1],I,R,0),oi.set(B4[2],P,D,0),oi.set(B4[3],I,D,0);for(var L=0;L<4;L++){var F=B4[L];oi.transformMat4(F,F,O4);var z=L*r;a[w+z]=F.x,a[w+z+1]=F.y,a[w+z+2]=F.z}w+=4*r}}w=0;for(var V=r,G=2*r,U=3*r,k=4*r,H=0,j=0,W=[],q=[],X=0,Y=T;X<Y;++X){j=A>x?A>=X*x?1:b%1:b;for(var K=0,J=E;K<J;++K){H=S>v?S>=K*v?1:C%1:C;var Q=w+3,Z=Q+1;h?(0===X?(W[0]=f[0].u,W[1]=f[0].u,W[2]=f[4].u+(f[8].u-f[4].u)*j):X<T-1?(W[0]=f[4].u,W[1]=f[4].u,W[2]=f[4].u+(f[8].u-f[4].u)*j):X===T-1&&(W[0]=f[8].u,W[1]=f[8].u,W[2]=f[12].u),0===K?(q[0]=f[0].v,q[1]=f[1].v+(f[2].v-f[1].v)*H,q[2]=f[0].v):K<E-1?(q[0]=f[1].v,q[1]=f[1].v+(f[2].v-f[1].v)*H,q[2]=f[1].v):K===E-1&&(q[0]=f[2].v,q[1]=f[3].v,q[2]=f[2].v),W[3]=W[2],q[3]=q[1]):(0===K?(W[0]=f[0].u,W[1]=f[1].u+(f[2].u-f[1].u)*H,W[2]=_[0]):K<E-1?(W[0]=f[1].u,W[1]=f[1].u+(f[2].u-f[1].u)*H,W[2]=f[1].u):K===E-1&&(W[0]=f[2].u,W[1]=f[3].u,W[2]=f[2].u),0===X?(q[0]=f[0].v,q[1]=f[0].v,q[2]=f[4].v+(f[8].v-f[4].v)*j):X<T-1?(q[0]=f[4].v,q[1]=f[4].v,q[2]=f[4].v+(f[8].v-f[4].v)*j):X===T-1&&(q[0]=f[8].v,q[1]=f[8].v,q[2]=f[12].v),W[3]=W[1],q[3]=q[2]),a[Q]=W[0],a[Z]=q[0],a[Q+V]=W[1],a[Z+V]=q[1],a[Q+G]=W[2],a[Z+G]=q[2],a[Q+U]=W[3],a[Z+U]=q[3],w+=k}}},updateVerts:function(t,e,n,i,r){var o,a,s=t.node._uiProps.uiTransformComp,c=t.renderData.data,l=t.spriteFrame,u=l.rect,h=Math.abs(s.width),_=Math.abs(s.height),f=s.anchorX*h,p=s.anchorY*_,d=l.insetLeft,m=l.insetRight,v=u.width-d-m,g=l.insetTop,y=l.insetBottom,x=u.height-g-y,S=s.width/(d+m)>1?1:s.width/(d+m),A=s.height/(g+y)>1?1:s.height/(g+y);o=v>0?Math.floor(1e3*e)/1e3%v==0?v:e%v:e,a=x>0?Math.floor(1e3*n)/1e3%x==0?x:n%x:n;for(var C=0;C<=r;C++)0===C?c[C].x=-f:C>0&&C<r?c[C].x=1===C?d*S+Math.min(v,e)-f:v>0?C===r-1?d+o+v*(C-2)-f:d+Math.min(v,e)+v*(C-2)-f:d+e-f:C===r&&(c[C].x=Math.min(d+e+m,h)-f);for(var b=0;b<=i;b++)0===b?c[b].y=-p:b>0&&b<i?c[b].y=1===b?y*A+Math.min(x,n)-p:x>0?b===i-1?y+a+(b-2)*x-p:y+Math.min(x,n)+(b-2)*x-p:y+n-p:b===i&&(c[b].y=Math.min(y+n+g,_)-p)},updataColorLate:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=e.vertexCount,o=5,a=t.color,s=a.r/255,c=a.g/255,l=a.b/255,u=t.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},L4=I$.Type,F4=I$.FillType,z4=t("spriteAssembler",{getAssembler:function(t){var e=P4,n=t;switch(n.type){case L4.SLICED:e=D4;break;case L4.TILED:e=N4;break;case L4.FILLED:e=n.fillType===F4.RADIAL?T4:l4}return e}});I$.Assembler=z4;var V4=xK.sharedManager,G4={createData:function(t){var e=t.requestRenderData();return e.dataLength=2,e.resize(4,6),e},updateRenderData:function(t){t.type===qQ.IMAGE_STENCIL&&(P4.updateRenderData(t),P4.updateColor(t))},fillBuffers:function(t,e){(t.type!==qQ.IMAGE_STENCIL||t.spriteFrame)&&(V4.pushMask(t),e.finishMergeBatches(),function(t,e){V4.clear(t),e.commitModel(t,t._clearModel,t._clearStencilMtl)}(t,e),function(t,e){if(V4.enterLevel(t),t.type===qQ.IMAGE_STENCIL){P4.fillBuffers(t,e);var n=t.graphics.getMaterialInstance(0);e.forceMergeBatches(n,t.spriteFrame,t.graphics)}else t.graphics.updateAssembler(e)}(t,e),V4.enableMask())}},U4={fillBuffers:function(){V4.exitMask()}},k4={getAssembler:function(){return G4}},H4={getAssembler:function(){return U4}};rZ.Assembler=k4,rZ.PostAssembler=H4;var j4=t("MeshBuffer",function(){function t(){this.byteOffset=0,this.vertexOffset=0,this.indexOffset=0,this.vData=null,this.iData=null,this._dirty=!1,this._vertexFormatBytes=0,this._floatsPerVertex=0,this._initVDataCount=0,this._initIDataCount=0,this._attributes=null,this._iaPool=[],this._iaInfo=null,this._nextFreeIAHandle=0}var e=t.prototype;return e.initialize=function(e,n){this._initVDataCount=1024*ee.BATCHER2D_MEM_INCREMENT/Float32Array.BYTES_PER_ELEMENT,this._initVDataCount,R(9005),this._initIDataCount=this._initVDataCount*t.IB_SCALE,this._attributes=n,this._floatsPerVertex=fX(n),this.vData&&this.iData||(this.vData=new Float32Array(this._initVDataCount),this.iData=new Uint16Array(this._initIDataCount)),this._iaPool.push(this.createNewIA(e))},e.reset=function(){this._nextFreeIAHandle=0,this._dirty=!1},e.destroy=function(){this.reset(),this._attributes=null,this._iaInfo=null,this.vData=null,this.iData=null;for(var t=0;t<this._iaPool.length;++t){var e=this._iaPool[t];e.vertexBuffers[0]&&e.vertexBuffers[0].destroy(),e.indexBuffer&&e.indexBuffer.destroy(),e.ia.destroy()}this._iaPool.length=0},e.setDirty=function(){this._dirty=!0},e.request=function(){return b(9002),!1},e.requireFreeIA=function(t){return this._iaPool.length<=this._nextFreeIAHandle&&this._iaPool.push(this.createNewIA(t)),this._iaPool[this._nextFreeIAHandle++].ia},e.recycleIA=function(t){for(var e=this._iaPool,n=0;n<this._nextFreeIAHandle;++n)if(t===e[n].ia){var i=e[n];return e[n]=e[--this._nextFreeIAHandle],void(e[this._nextFreeIAHandle]=i)}},e.checkCapacity=function(t,e){var n=this.vertexOffset+t,i=this.indexOffset+e;return!(n>this._initVDataCount||i>this._initIDataCount)},e.uploadBuffers=function(){if(0!==this.byteOffset&&this._dirty){for(var t=Zu.__isWebIOS14OrIPadOS14Env?this._nextFreeIAHandle:1,e=this.byteOffset,n=this.indexOffset,i=0;i<t;++i){var r=this._iaPool[i],o=new Float32Array(this.vData.buffer,0,e>>2),a=new Uint16Array(this.iData.buffer,0,n),s=r.vertexBuffers[0];e>s.size&&s.resize(e),s.update(o),2*n>r.indexBuffer.size&&r.indexBuffer.resize(2*n),r.indexBuffer.update(a)}this._dirty=!1}},e.createNewIA=function(t){var e,n,i;if(Zu.__isWebIOS14OrIPadOS14Env||!this._iaPool[0]){var r=this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT,o=Uint16Array.BYTES_PER_ELEMENT,a=t.createBuffer(new po(mr.VERTEX|mr.TRANSFER_DST,yr.HOST|yr.DEVICE,r,r));i=t.createBuffer(new po(mr.INDEX|mr.TRANSFER_DST,yr.HOST|yr.DEVICE,o,o)),n=[a],this._iaInfo=new Oo(this._attributes,n,i),e=t.createInputAssembler(this._iaInfo)}else e=t.createInputAssembler(this._iaInfo),n=this._iaInfo.vertexBuffers,i=this._iaInfo.indexBuffer;return{ia:e,vertexBuffers:n,indexBuffer:i}},N(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}}]),t}());j4.IB_SCALE=4;var W4=[uM.EventType.MOUSE_DOWN,uM.EventType.MOUSE_MOVE,uM.EventType.MOUSE_UP,uM.EventType.MOUSE_WHEEL],q4=[uM.EventType.TOUCH_START,uM.EventType.TOUCH_MOVE,uM.EventType.TOUCH_END,uM.EventType.TOUCH_CANCEL],X4=(new(function(){function t(){this.priority=tM.UI,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],hM._registerEventDispatcher(this),dR.callbacksInvoker.on(IE.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),dR.callbacksInvoker.on(IE.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this),dR.callbacksInvoker.on(IE.MARK_LIST_DIRTY,this._markListDirty,this)}var e=t.prototype;return e.dispatchEvent=function(t){var e=t.type;return q4.includes(e)?this.dispatchEventTouch(t):!W4.includes(e)||this.dispatchEventMouse(t)},e.addPointerEventProcessor=function(t){0===this._inDispatchCount?(this._pointerEventProcessorList.push(t),this._isListDirty=!0):(kt.array.remove(this._processorListToRemove,t),this._processorListToAdd.push(t))},e.removePointerEventProcessor=function(t){0===this._inDispatchCount?(kt.array.remove(this._pointerEventProcessorList,t),this._isListDirty=!0):(kt.array.remove(this._processorListToAdd,t),this._processorListToRemove.push(t))},e.dispatchEventMouse=function(t){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var e=this._pointerEventProcessorList,n=e.length,i=!0,r=0;r<n;++r){var o=e[r];if(o.isEnabled&&o.shouldHandleEventMouse&&o._handleEventMouse(t)){if(i=!1,!t.preventSwallow)break;t.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),i},e.dispatchEventTouch=function(t){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var e=this._pointerEventProcessorList,n=e.length,i=t.touch,r=!0,o=0;o<n;++o){var a=e[o];if(a.isEnabled&&a.shouldHandleEventTouch)if(t.type===wE.TOUCH_START){if(a._handleEventTouch(t)){if(a.claimedTouchIdList.push(i.getID()),r=!1,!t.preventSwallow)break;t.preventSwallow=!1}}else if(a.claimedTouchIdList.length>0){var s=a.claimedTouchIdList.indexOf(i.getID());if(-1!==s){if(a._handleEventTouch(t),t.type!==wE.TOUCH_END&&t.type!==wE.TOUCH_CANCEL||kt.array.removeAt(a.claimedTouchIdList,s),r=!1,!t.preventSwallow)break;t.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),r},e._updatePointerEventProcessorList=function(){for(var t=this._processorListToAdd,e=t.length,n=0;n<e;++n)this.addPointerEventProcessor(t[n]);t.length=0;for(var i=this._processorListToRemove,r=i.length,o=0;o<r;++o)this.removePointerEventProcessor(i[o]);i.length=0},e._sortPointerEventProcessorList=function(){if(this._isListDirty){for(var t=this._pointerEventProcessorList,e=t.length,n=0;n<e;++n){var i=t[n],r=i.node._uiProps.uiTransformComp;i.cachedCameraPriority=r.cameraPriority}t.sort(this._sortByPriority),this._isListDirty=!1}},e._sortByPriority=function(t,e){var n=t.node,i=e.node;if(!(e&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(t&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return 1;if(t.cachedCameraPriority!==e.cachedCameraPriority)return e.cachedCameraPriority-t.cachedCameraPriority;for(var r=n,o=i,a=!1;(null===(s=r.parent)||void 0===s?void 0:s._id)!==(null===(c=o.parent)||void 0===c?void 0:c._id);){var s,c,l,u,h,_;r=null===(null===(l=r)||void 0===l||null===(u=l.parent)||void 0===u?void 0:u.parent)?(a=!0)&&i:r&&r.parent,o=null===(null===(h=o)||void 0===h||null===(_=h.parent)||void 0===_?void 0:_.parent)?(a=!0)&&n:o&&o.parent}if(r._id===o._id){if(r._id===i._id)return-1;if(r._id===n._id)return 1}var f=r?r.getSiblingIndex():0,p=o?o.getSiblingIndex():0;return a?f-p:p-f},e._markListDirty=function(){this._isListDirty=!0},t}()),function(){function t(t,e){this._device=null,this._attributes=null,this._vertexFormatBytes=void 0,this._floatsPerVertex=void 0,this._buffers=[],this._device=t,this._attributes=e,this._floatsPerVertex=fX(e),this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT}var e=t.prototype;return e.initialize=function(){},e.reset=function(){},e.request=function(){},e.appendBuffers=function(){},e.uploadBuffers=function(){},e.destroy=function(){this._attributes.length=0},N(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}},{key:"floatsPerVertex",get:function(){return this._floatsPerVertex}}]),t}()),Y4=new Wt((function(){return{offset:0,length:0}}),32),K4=function(t,e,n,i){this.vertexAccessor=t,this.bufferId=e,this.vertexOffset=n,this.vb=i},J4=function(t){function e(e,n){var i;return(i=t.call(this,e,n)||this)._freeLists=[],i._allocateBuffer(),i}F(e,t);var n=e.prototype;return n.destroy=function(){for(var e=0;e<this._buffers.length;++e){this._buffers[e].destroy();for(var n=this._freeLists[e],i=0;i<n.length;++i)Y4.free(n[i])}this._buffers.length=0,this._freeLists.length=0,t.prototype.destroy.call(this)},n.reset=function(){for(var t=0;t<this._buffers.length;++t){var e=this._buffers[t];e.indexOffset=0,e.reset()}},n.getVertexBuffer=function(t){return this._buffers[t].vData},n.getIndexBuffer=function(t){return this._buffers[t].iData},n.getMeshBuffer=function(t){return this._buffers[t]},n.uploadBuffers=function(){for(var t=0;t<this._buffers.length;++t){var e=this._freeLists[t][0],n=this._buffers[t];(!e||e.length<n.vData.byteLength)&&n.uploadBuffers()}},n.appendIndices=function(){},n.allocateChunk=function(t,e){for(var n,i=t*this.vertexFormatBytes,r=null,o=0,a=-1,s=null,c=0;c<this._buffers.length;++c){r=this._buffers[c],n=this._freeLists[c];for(var l=0;l<n.length;++l)if(n[l].length>=i){s=n[l],o=c,a=l;break}if(s)break}if(s||(o=this._allocateBuffer(),(r=this._buffers[o])&&r.checkCapacity(t,e)&&(a=0,s=this._freeLists[o][a])),s){var u=s.offset/this.vertexFormatBytes,h=new Float32Array(r.vData.buffer,s.offset,i>>2).fill(0);return this._allocateChunkFromEntry(o,a,s,i),new K4(this,o,u,h,e)}return b(9004,i),null},n.recycleChunk=function(t){var e=this._freeLists[t.bufferId],n=this._buffers[t.bufferId],i=t.vertexOffset*this.vertexFormatBytes,r=t.vb.byteLength;if(0!==r){for(var o=!1,a=0,s=null,c=e[a];c&&c.offset<i;)s=c,c=e[++a];if(s&&0==i-(s.offset+s.length)&&(s.length+=r,i=s.offset,r=s.length,c&&c.offset-(i+r)==0&&(s.length+=c.length,e.splice(a,1),Y4.free(c),c=null),o=!0),!o&&c){if(0==c.offset-(i+r))c.offset=i,c.length+=r;else{var l=Y4.alloc();l.offset=i,l.length=r,e.splice(a,0,l)}o=!0}if(o)i+r===n.byteOffset&&(n.byteOffset=i);else{var u=Y4.alloc();u.offset=i,u.length=r,e.push(u)}}},n._allocateChunkFromEntry=function(t,e,n,i){var r=n.length-i,o=n.offset+i,a=this._buffers[t];a.byteOffset<o&&(a.byteOffset=o),I(r>=0,9004,t,n.offset,n.length),0===r?(this._freeLists[t].splice(e,1),Y4.free(n)):(n.offset+=i,n.length=r)},n._allocateBuffer=function(){I(this._buffers.length===this._freeLists.length,9003);var t=new j4;t.initialize(this._device,this._attributes),this._buffers.push(t);var e=Y4.alloc();e.offset=0,e.length=t.vData.byteLength;var n=[e];return this._freeLists.push(n),this._buffers.length-1},e}(X4),Q4=new Wo(null),Z4=new Ei,$4=function(){function t(t){var e=this;this.device=void 0,this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._meshBufferUseCount=new Map,this._drawBatchPool=void 0,this._batches=void 0,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new hg,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new e3,this._meshDataArray=[],this._root=t,this.device=t.device,this._batches=new Xt(64),this._drawBatchPool=new Wt((function(){return new $0}),128,(function(t){return t.destroy(e)}))}var e=t.prototype;return e.initialize=function(){return!0},e.destroy=function(){for(var t=0;t<this._batches.length;t++)this._batches.array[t]&&this._batches.array[t].destroy(this);this._batches.destroy(),this._bufferAccessors.forEach((function(t){t.destroy()})),this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),xK.sharedManager.destroy()},e.addScreen=function(t){this._screens.push(t),this._screens.sort(this._screenSort)},e.removeScreen=function(t){var e=this._screens.indexOf(t);-1!==e&&this._screens.splice(e,1)},e.sortScreens=function(){this._screens.sort(this._screenSort)},e.getFirstRenderCamera=function(t){if(t.scene&&t.scene.renderScene)for(var e=t.scene.renderScene.cameras,n=0;n<e.length;n++){var i=e[n];if(i.visibility&t.layer)return i}return null},e.update=function(){for(var t=this._screens,e=0,n=0;n<t.length;++n){var i=t[n],r=i._getRenderScene();if(i.enabledInHierarchy&&r){this._opacityDirty=0,this._pOpacity=1,this.walk(i.node),this.autoMergeBatches(this._currComponent);var o=0;if(this._batches.length>e)for(;e<this._batches.length;++e){var a=this._batches.array[e];if(a.model)for(var s=a.model.subModels,c=0;c<s.length;c++)s[c].priority=o++;else a.descriptorSet=this._descriptorSetCache.getDescriptorSet(a);r.addBatch(a)}}}},e.uploadBuffers=function(){this._batches.length>0&&(this._meshDataArray.forEach((function(t){t.uploadBuffers()})),this._bufferAccessors.forEach((function(t){t.uploadBuffers(),t.reset()})),this._descriptorSetCache.update())},e.reset=function(){for(var t=0;t<this._batches.length;++t){var e=this._batches.array[t];e.isStatic||(e.clear(),this._drawBatchPool.free(e))}this._bufferAccessors.forEach((function(t){t.reset()})),this._meshDataArray.forEach((function(t){t.freeIAPool()})),this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._meshBufferUseCount.clear(),this._batches.clear(),xK.sharedManager.reset()},e.switchBufferAccessor=function(t){void 0===t&&(t=hX);var e=t===hX?36:pX(t);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==e){var n=this._bufferAccessors.get(e);n||(n=new J4(this.device,t),this._bufferAccessors.set(e,n)),this._staticVBBuffer=n,this._currBID=-1}return this._staticVBBuffer},e.updateBuffer=function(t,e){var n=this.switchBufferAccessor(t);this._currBID!==e&&(this._currBID=e,this._indexStart=n.getMeshBuffer(e).indexOffset)},e.commitComp=function(t,e,n,i,r){var o,a=0,s=-1;if(e&&e.chunk){if(!e.isValid())return;a=e.dataHash,o=e.material,s=e.chunk.bufferId}t.stencilStage=xK.sharedManager.stage;var c=t.stencilStage;this._currHash===a&&0!==a&&this._currMaterial===o&&this._currDepthStencilStateStage===c||(this.autoMergeBatches(this._currComponent),e&&!e.isMeshBuffer&&this.updateBuffer(e.vertexFormat,s),this._currRenderData=e,this._currHash=e?e.dataHash:0,this._currComponent=t,this._currTransform=r,this._currMaterial=t.getRenderMaterial(0),this._currDepthStencilStateStage=c,this._currLayer=t.node.layer,n?(this._currTexture=n.getGFXTexture(),this._currSampler=n.getGFXSampler(),this._currTextureHash=n.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),i.fillBuffers(t,this)},e.commitModel=function(t,e,n){var r;this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(this._currComponent);var o=0;n&&(t.stencilStage!==PY.ENABLED&&t.stencilStage!==PY.DISABLED||(t.stencilStage=xK.sharedManager.stage),r=xK.sharedManager.getStencilStage(t.stencilStage,n),o=xK.sharedManager.getStencilHash(t.stencilStage));var a=i.director.getTotalFrames();e&&(e.updateTransform(a),e.updateUBOs(a));for(var s=0;s<e.subModels.length;s++){var c=this._drawBatchPool.alloc(),l=e.subModels[s];c.visFlags=t.node.layer,c.model=e,c.texture=null,c.sampler=null,c.useLocalData=null,r||(r=null),c.fillPasses(n,r,o,null,0,l.patches,this),c.inputAssembler=l.inputAssembler,c.model.visFlags=c.visFlags,c.descriptorSet=l.descriptorSet,this._batches.push(c)}this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currComponent=null,this._currTransform=null,this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currLayer=0},e.setupStaticBatch=function(t,e){this.finishMergeBatches(),this._staticVBBuffer=e,this.currStaticRoot=t},e.endStaticBatch=function(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()},e.commitStaticBatch=function(t){this._batches.concat(t.drawBatchList),this.finishMergeBatches()},e.autoMergeBatches=function(t){var e=this._currMaterial;if(e){var n,i=this._currRenderData,r=this._staticVBBuffer;if(i&&i.isMeshBuffer)n=i.requestIA(this.device),-1===this._meshDataArray.indexOf(i)&&this._meshDataArray.push(i);else if(r){var o=this._currBID,a=r.getMeshBuffer(o);if(!a)return;var s=a.indexOffset-this._indexStart;if(s<=0)return;this._indexStart,a.indexOffset,a.setDirty(),(n=a.requireFreeIA(this.device)).firstIndex=this._indexStart,n.indexCount=s,this._indexStart=a.indexOffset}if(this._currBID=-1,n){var c,l,u=0,h=0;t&&(c=-1===t.blendHash?null:t.getBlendState(),h=t.blendHash,l=null!==t.customMaterial?xK.sharedManager.getStencilStage(t.stencilStage,e):xK.sharedManager.getStencilStage(t.stencilStage),u=xK.sharedManager.getStencilHash(t.stencilStage));var _=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();_.visFlags=this._currLayer,_.texture=this._currTexture,_.sampler=this._currSampler,_.inputAssembler=n,_.useLocalData=this._currTransform,_.textureHash=this._currTextureHash,_.samplerHash=this._currSamplerHash,_.fillPasses(e,l,u,c,h,null,this),this._batches.push(_)}}},e.forceMergeBatches=function(t,e,n){this._currMaterial=t,e?(this._currTexture=e.getGFXTexture(),this._currSampler=e.getGFXSampler(),this._currTextureHash=e.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=n.node.layer,this.autoMergeBatches(n)},e.finishMergeBatches=function(){this.autoMergeBatches(),this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},e.flushMaterial=function(t){this._currMaterial=t},e.walk=function(t,e){if(void 0===e&&(e=0),t.activeInHierarchy){var n=t.children,i=t._uiProps,r=i.uiComp,o=this._pOpacity,a=o,s=r&&r.color?r.color.a/255:1;if(this._pOpacity=a*=s*i.localOpacity,i._opacity=a,i.colorDirty&&this._opacityDirty++,r&&r.enabledInHierarchy&&r.updateAssembler(this),this._opacityDirty&&r&&r.renderData&&r.renderData.vertexCount>0&&function(t,e){t.vertexFormat;for(var n=t.chunk.vb,i=t.floatStride,r=i-1;r<n.length;r+=i)n[r]=e}(r.renderData,a),n.length>0&&!t._static)for(var c=0;c<n.length;++c){var l=n[c];this.walk(l,e)}i.colorDirty&&(this._opacityDirty--,i.colorDirty=!1),this._pOpacity=o,r&&r.enabledInHierarchy&&r.postUpdateAssembler(this),e+=1}},e._screenSort=function(t,e){return t.node.getSiblingIndex()-e.node.getSiblingIndex()},e._releaseDescriptorSetCache=function(t){this._descriptorSetCache.releaseDescriptorSetCache(t)},N(t,[{key:"currBufferAccessor",get:function(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(t){this._currStaticRoot=t}},{key:"currIsStatic",set:function(t){this._currIsStatic=t}}]),t}(),t3=function(){function t(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var t=i.director.root.device;this._localData=new Float32Array(jp.COUNT),this._localBuffer=t.createBuffer(new po(mr.UNIFORM|mr.TRANSFER_DST,yr.HOST|yr.DEVICE,jp.SIZE,jp.SIZE))}var e=t.prototype;return e.initialize=function(t){var e=i.director.root.device;this._transform=t.useLocalData,this._textureHash=t.textureHash,this._samplerHash=t.samplerHash,Q4.layout=t.passes[0].localSetLayout,this._descriptorSet=e.createDescriptorSet(Q4),this._descriptorSet.bindBuffer(jp.BINDING,this._localBuffer);var n=Ap.SAMPLER_SPRITE;this._descriptorSet.bindTexture(n,t.texture),this._descriptorSet.bindSampler(n,t.sampler),this._descriptorSet.update(),this._transformUpdate=!0},e.updateTransform=function(t){t!==this._transform&&(this._transform=t,this._transformUpdate=!0,this.uploadLocalData())},e.equals=function(t,e,n){return this._transform===t&&this._textureHash===e&&this._samplerHash===n},e.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},e.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},e.isValid=function(){return this._transform&&this._transform.isValid},e.uploadLocalData=function(){var t=this._transform;if((t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){var e=t.worldMatrix;Ei.toArray(this._localData,e,jp.MAT_WORLD_OFFSET),Ei.inverseTranspose(Z4,e);var n=Ei.determinant(Z4),i=1/Math.sqrt(n);Ei.multiplyScalar(Z4,Z4,i),Ei.toArray(this._localData,Z4,jp.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}},N(t,[{key:"descriptorSet",get:function(){return this._descriptorSet}}]),t}(),e3=function(){function t(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new Wt((function(){return new t3}),16,(function(t){return t.destroy()}))}var e=t.prototype;return e.getDescriptorSet=function(t){var e,n=i.director.root;if(t.useLocalData){for(var r=this._localDescriptorSetCache,o=0,a=r.length;o<a;o++){var s=r[o];if(s.equals(t.useLocalData,t.textureHash,t.samplerHash))return s.descriptorSet}var c=this._localCachePool.alloc();return c.initialize(t),this._localDescriptorSetCache.push(c),c.descriptorSet}if(e=t.textureHash^t.samplerHash,this._descriptorSetCache.has(e))return this._descriptorSetCache.get(e);Q4.layout=t.passes[0].localSetLayout;var l=n.device.createDescriptorSet(Q4),u=Ap.SAMPLER_SPRITE;return l.bindTexture(u,t.texture),l.bindSampler(u,t.sampler),l.update(),this._descriptorSetCache.set(e,l),this._dsCacheHashByTexture.set(t.textureHash,e),l},e.update=function(){var t=this._localDescriptorSetCache,e=[];t.forEach((function(n){if(n.isValid())n.uploadLocalData();else{n.reset();var i=t.indexOf(n);e.push(i)}}));for(var n=e.length-1;n>=0;n--)t.splice(e[n],1)},e.reset=function(){var t=this;this._localDescriptorSetCache.forEach((function(e){t._localCachePool.free(e)})),this._localDescriptorSetCache.length=0},e.releaseDescriptorSetCache=function(t){var e=this._dsCacheHashByTexture.get(t);e&&this._descriptorSetCache.has(e)&&(this._descriptorSetCache.get(e).destroy(),this._descriptorSetCache.delete(e),this._dsCacheHashByTexture.delete(t))},e.destroy=function(){this._descriptorSetCache.forEach((function(t){t.destroy()})),this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()},t}();i.internal.Batcher2D=$4;var n3,i3,r3,o3,a3,s3,c3,l3,u3,h3,_3,f3,p3,d3,m3,v3,g3,y3,x3,S3,A3,C3,b3,T3,E3,w3,P3,I3,R3,D3,B3,M3,O3,N3,L3,F3,z3,V3,G3,U3,k3,H3,j3,W3,q3,X3,Y3,K3,J3,Q3,Z3,$3=null,t5=-1,e5="BES bswy:->@123丁ぁᄁ",n5=Object.create(null),i5=[],r5=3e3;function o5(){for(var t=!0,e=Date.now(),n=i5.length-1;n>=0;n--){var i=i5[n],r=i.fontFamilyName;if(e-i.startTime>r5)b(4933,r),i.onComplete(null,r),i5.splice(n,1);else{var o=i.refWidth,a="40px "+r;$3.font=a,o!==hY($3,e5,a)?(i5.splice(n,1),i.onComplete(null,r)):t=!1}}t&&(clearInterval(t5),t5=-1)}function a5(t,e,n){var i=function(t){var e=t.lastIndexOf(".ttf");if(-1===e)return t;var n,i=t.lastIndexOf("/");return-1!==(n=-1===i?t.substring(0,e)+"_LABEL":t.substring(i+1,e)+"_LABEL").indexOf(" ")&&(n='"'+n+'"'),n}(t);if(n5[i])n(null,i);else{if(!$3){var r=document.createElement("canvas");r.width=100,r.height=100,$3=r.getContext("2d")}var o=hY($3,e5,"40px "+i),a=document.createElement("style");a.type="text/css";var s="";Number.isNaN(i)?s+="@font-face { font-family:"+i+"; src:":s+='@font-face { font-family:"'+i+'"; src:',s+='url("'+t+'");',a.textContent=s+"}",document.body.appendChild(a);var c,l,u,h,_,f,p=document.createElement("div"),d=p.style;if(d.fontFamily=i,p.innerHTML=".",d.position="absolute",d.left="-100px",d.top="-100px",document.body.appendChild(p),function(){if(void 0===n3)if("FontFace"in window){var t=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),e=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);n3=t?parseInt(t[1],10)>42:!e}else n3=!1;return n3}())c=Date.now(),l=i,u=n,h=new Promise((function(t,e){!function n(){Date.now()-c>=r5?e():document.fonts.load("40px "+l).then((function(e){e.length>=1?t():setTimeout(n,100)}),(function(){e()}))}()})),_=null,f=new Promise((function(t,e){_=setTimeout(e,r5)})),Promise.race([f,h]).then((function(){_&&(clearTimeout(_),_=null),u(null,l)}),(function(){b(4933,l),u(null,l)}));else{var m={fontFamilyName:i,refWidth:o,onComplete:n,startTime:Date.now()};i5.push(m),-1===t5&&(t5=setInterval(o5,100))}n5[i]=a}}function s5(t,e,n,i){var r=new XX;r._nativeUrl=t,r._nativeAsset=e,i(null,r)}dO.register({".font":a5,".eot":a5,".ttf":a5,".woff":a5,".svg":a5,".ttc":a5}),AO.register({".font":s5,".eot":s5,".ttf":s5,".woff":s5,".svg":s5,".ttc":s5}),i.UI={MeshBuffer:j4,spriteAssembler:z4,graphicsAssembler:z1,labelAssembler:o4,RenderData:VY,MeshRenderData:GY,QuadRenderData:UY};var c5,l5,u5,h5=new Li;!function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.SPRITE=2]="SPRITE",t[t.SCALE=3]="SCALE"}(c5||(c5={})),$t(c5),function(t){t.NORMAL="normal",t.HOVER="hover",t.PRESSED="pressed",t.DISABLED="disabled"}(l5||(l5={})),function(t){t.CLICK="click"}(u5||(u5={}));var _5,f5,p5,d5=t("Button",(i3=qc("cc.Button"),r3=cl(),o3=Yc(110),a3=rl(),s3=Xc($Y),c3=El(BT),l3=yl(),u3=fl(),h3=yl(),_3=fl(),f3=El(c5),p3=yl(),d3=fl(),m3=fl(),v3=fl(),g3=fl(),y3=fl(),x3=dl(),S3=ml(),A3=fl(),C3=fl(),b3=El(RX),T3=fl(),E3=El(RX),w3=fl(),P3=El(RX),I3=fl(),R3=El(RX),D3=fl(),B3=El([hL]),M3=yl(),O3=fl(),i3(N3=r3(N3=o3(N3=a3(N3=s3(N3=il((Z3=Q3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"clickEvents",F3,H(e)),q(e,"_interactable",z3,H(e)),q(e,"_transition",V3,H(e)),q(e,"_normalColor",G3,H(e)),q(e,"_hoverColor",U3,H(e)),q(e,"_pressedColor",k3,H(e)),q(e,"_disabledColor",H3,H(e)),q(e,"_normalSprite",j3,H(e)),q(e,"_hoverSprite",W3,H(e)),q(e,"_pressedSprite",q3,H(e)),q(e,"_disabledSprite",X3,H(e)),q(e,"_duration",Y3,H(e)),q(e,"_zoomScale",K3,H(e)),q(e,"_target",J3,H(e)),e._pressed=!1,e._hovered=!1,e._fromColor=new Li,e._toColor=new Li,e._time=0,e._transitionFinished=!0,e._fromScale=new oi,e._toScale=new oi,e._originalScale=null,e._sprite=null,e._targetScale=new oi,e}F(e,t);var n=e.prototype;return n.__preload=function(){this.target||(this.target=this.node);var t=this.node.getComponent(I$);t&&(this._normalSprite=t.spriteFrame),this._applyTarget(),this._resetState()},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._resetState(),this._unregisterNodeEvent()},n.onDestroy=function(){this.target.isValid&&this._unregisterTargetEvent(this.target)},n.update=function(t){var e=this.target;if(!this._transitionFinished&&e&&(this._transition===c5.COLOR||this._transition===c5.SCALE)){this._time+=t;var n=1;if(this._duration>0&&(n=this._time/this._duration),n>=1&&(n=1),this._transition===c5.COLOR){var i=e._uiProps.uiComp;Li.lerp(h5,this._fromColor,this._toColor,n),i&&(i.color=h5)}else this.transition===c5.SCALE&&(e.getScale(this._targetScale),this._targetScale.x=Hn(this._fromScale.x,this._toScale.x,n),this._targetScale.y=Hn(this._fromScale.y,this._toScale.y,n),e.setScale(this._targetScale));1===n&&(this._transitionFinished=!0)}},n._resizeNodeToTargetNode=function(){this.target&&this.target._uiProps.uiTransformComp},n._resetState=function(){this._pressed=!1,this._hovered=!1;var t=this.target;if(t){var e=this._transition;if(e===c5.COLOR&&this._interactable){var n=t.getComponent(FJ);n&&(n.color=this._normalColor)}else e===c5.SCALE&&this._originalScale&&t.setScale(this._originalScale);this._transitionFinished=!0}},n._registerNodeEvent=function(){this.node.on(RC.TOUCH_START,this._onTouchBegan,this),this.node.on(RC.TOUCH_MOVE,this._onTouchMove,this),this.node.on(RC.TOUCH_END,this._onTouchEnded,this),this.node.on(RC.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(RC.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(RC.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._registerTargetEvent=function(t){t.on(RC.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)},n._unregisterNodeEvent=function(){this.node.off(RC.TOUCH_START,this._onTouchBegan,this),this.node.off(RC.TOUCH_MOVE,this._onTouchMove,this),this.node.off(RC.TOUCH_END,this._onTouchEnded,this),this.node.off(RC.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(RC.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(RC.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._unregisterTargetEvent=function(t){t.off(RC.TRANSFORM_CHANGED)},n._getTargetSprite=function(t){var e=null;return t&&(e=t.getComponent(I$)),e},n._applyTarget=function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new oi),oi.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))},n._onTargetSpriteFrameChanged=function(t){this._transition===c5.SPRITE&&this._setCurrentStateSpriteFrame(t.spriteFrame)},n._setCurrentStateSpriteFrame=function(t){if(t)switch(this._getButtonState()){case l5.NORMAL:this._normalSprite=t;break;case l5.HOVER:this._hoverSprite=t;break;case l5.PRESSED:this._pressedSprite=t;break;case l5.DISABLED:this._disabledSprite=t}},n._onTargetColorChanged=function(t){this._transition===c5.COLOR&&this._setCurrentStateColor(t)},n._setCurrentStateColor=function(t){switch(this._getButtonState()){case l5.NORMAL:this._normalColor=t;break;case l5.HOVER:this._hoverColor=t;break;case l5.PRESSED:this._pressedColor=t;break;case l5.DISABLED:this._disabledColor=t}},n._onTargetTransformChanged=function(t){t&Nd.SCALE&&this._originalScale&&this._transition===c5.SCALE&&this._transitionFinished&&oi.copy(this._originalScale,this.target.getScale())},n._onTouchBegan=function(t){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),t&&(t.propagationStopped=!0))},n._onTouchMove=function(t){if(this._interactable&&this.enabledInHierarchy&&this._pressed&&t){var e=t.touch;if(e){var n,i=this.node._uiProps.uiTransformComp.isHit(e.getUILocation());this._transition===c5.SCALE&&this.target&&this._originalScale?i?(oi.copy(this._fromScale,this._originalScale),oi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale)):(n=i?l5.PRESSED:l5.NORMAL,this._applyTransition(n)),t&&(t.propagationStopped=!0)}}},n._onTouchEnded=function(t){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(hL.emitEvents(this.clickEvents,t),this.node.emit(u5.CLICK,this)),this._pressed=!1,this._updateState(),t&&(t.propagationStopped=!0))},n._onTouchCancel=function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())},n._onMouseMoveIn=function(){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==c5.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))},n._onMouseMoveOut=function(){this._hovered&&(this._hovered=!1,this._updateState())},n._updateState=function(){var t=this._getButtonState();this._applyTransition(t)},n._getButtonState=function(){var t=l5.NORMAL;return this._interactable?this._pressed?t=l5.PRESSED:this._hovered&&(t=l5.HOVER):t=l5.DISABLED,t.toString()},n._updateColorTransition=function(t){var e,n=this[t+"Color"],i=null===(e=this.target)||void 0===e?void 0:e.getComponent(FJ);i&&(t===l5.DISABLED?i.color=n:(this._fromColor=i.color.clone(),this._toColor=n,this._time=0,this._transitionFinished=!1))},n._updateSpriteTransition=function(t){var e=this[t+"Sprite"];this._sprite&&e&&(this._sprite.spriteFrame=e)},n._updateScaleTransition=function(t){this._interactable&&(t===l5.PRESSED?this._zoomUp():this._zoomBack())},n._zoomUp=function(){this._originalScale&&(oi.copy(this._fromScale,this._originalScale),oi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)},n._zoomBack=function(){this.target&&this._originalScale&&(oi.copy(this._fromScale,this.target.getScale()),oi.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)},n._applyTransition=function(t){var e=this._transition;e===c5.COLOR?this._updateColorTransition(t):e===c5.SPRITE?this._updateSpriteTransition(t):e===c5.SCALE&&this._updateScaleTransition(t)},N(e,[{key:"target",get:function(){return this._target||this.node},set:function(t){this._target!==t&&(this._target&&this._unregisterTargetEvent(this._target),this._target=t,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(t){this._interactable=t,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(t){t&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(t){this._transition!==t&&(this._transition===c5.COLOR?this._updateColorTransition(l5.NORMAL):this._transition===c5.SPRITE&&this._updateSpriteTransition(l5.NORMAL),this._transition=t,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(t){this._normalColor!==t&&(this._normalColor.set(t),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(t){this._pressedColor!==t&&this._pressedColor.set(t)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(t){this._hoverColor!==t&&this._hoverColor.set(t)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(t){this._disabledColor!==t&&(this._disabledColor.set(t),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(t){this._duration!==t&&(this._duration=t)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(t){this._zoomScale!==t&&(this._zoomScale=t)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(t){if(this._normalSprite!==t){this._normalSprite=t;var e=this.node.getComponent(I$);e&&(e.spriteFrame=t),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(t){this._pressedSprite!==t&&(this._pressedSprite=t,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(t){this._hoverSprite!==t&&(this._hoverSprite=t,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(t){this._disabledSprite!==t&&(this._disabledSprite=t,this._updateState())}}]),e}(ku),Q3.Transition=c5,Q3.EventType=u5,X((L3=Z3).prototype,"target",[c3,l3,u3],Object.getOwnPropertyDescriptor(L3.prototype,"target"),L3.prototype),X(L3.prototype,"interactable",[h3,_3],Object.getOwnPropertyDescriptor(L3.prototype,"interactable"),L3.prototype),X(L3.prototype,"transition",[f3,p3,d3],Object.getOwnPropertyDescriptor(L3.prototype,"transition"),L3.prototype),X(L3.prototype,"normalColor",[m3],Object.getOwnPropertyDescriptor(L3.prototype,"normalColor"),L3.prototype),X(L3.prototype,"pressedColor",[v3],Object.getOwnPropertyDescriptor(L3.prototype,"pressedColor"),L3.prototype),X(L3.prototype,"hoverColor",[g3],Object.getOwnPropertyDescriptor(L3.prototype,"hoverColor"),L3.prototype),X(L3.prototype,"disabledColor",[y3],Object.getOwnPropertyDescriptor(L3.prototype,"disabledColor"),L3.prototype),X(L3.prototype,"duration",[x3,S3,A3],Object.getOwnPropertyDescriptor(L3.prototype,"duration"),L3.prototype),X(L3.prototype,"zoomScale",[C3],Object.getOwnPropertyDescriptor(L3.prototype,"zoomScale"),L3.prototype),X(L3.prototype,"normalSprite",[b3,T3],Object.getOwnPropertyDescriptor(L3.prototype,"normalSprite"),L3.prototype),X(L3.prototype,"pressedSprite",[E3,w3],Object.getOwnPropertyDescriptor(L3.prototype,"pressedSprite"),L3.prototype),X(L3.prototype,"hoverSprite",[P3,I3],Object.getOwnPropertyDescriptor(L3.prototype,"hoverSprite"),L3.prototype),X(L3.prototype,"disabledSprite",[R3,D3],Object.getOwnPropertyDescriptor(L3.prototype,"disabledSprite"),L3.prototype),F3=X(L3.prototype,"clickEvents",[B3,Zc,M3,O3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),z3=X(L3.prototype,"_interactable",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),V3=X(L3.prototype,"_transition",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return c5.NONE}}),G3=X(L3.prototype,"_normalColor",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Li.WHITE.clone()}}),U3=X(L3.prototype,"_hoverColor",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Li(211,211,211,255)}}),k3=X(L3.prototype,"_pressedColor",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Li.WHITE.clone()}}),H3=X(L3.prototype,"_disabledColor",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Li(124,124,124,255)}}),j3=X(L3.prototype,"_normalSprite",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),W3=X(L3.prototype,"_hoverSprite",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),q3=X(L3.prototype,"_pressedSprite",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X3=X(L3.prototype,"_disabledSprite",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y3=X(L3.prototype,"_duration",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),K3=X(L3.prototype,"_zoomScale",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),J3=X(L3.prototype,"_target",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),N3=L3))||N3)||N3)||N3)||N3)||N3)||N3)),m5=function(){function t(){}return t.add=function(t){var e=this._tabIndexList;-1===e.indexOf(t)&&e.push(t)},t.remove=function(t){var e=this._tabIndexList,n=e.indexOf(t);-1!==n&&e.splice(n,1)},t.resort=function(){this._tabIndexList.sort((function(t,e){return t._delegate.tabIndex-e._delegate.tabIndex}))},t.next=function(t){var e=this._tabIndexList,n=e.indexOf(t);if(t.setFocus(!1),-1!==n){var i=e[n+1];i&&i._delegate.tabIndex>=0&&i.setFocus(!0)}},t}();m5._tabIndexList=[],function(t){t[t.DEFAULT=0]="DEFAULT",t[t.DONE=1]="DONE",t[t.SEND=2]="SEND",t[t.SEARCH=3]="SEARCH",t[t.GO=4]="GO",t[t.NEXT=5]="NEXT"}(_5||(_5={})),Jt(_5),function(t){t[t.ANY=0]="ANY",t[t.EMAIL_ADDR=1]="EMAIL_ADDR",t[t.NUMERIC=2]="NUMERIC",t[t.PHONE_NUMBER=3]="PHONE_NUMBER",t[t.URL=4]="URL",t[t.DECIMAL=5]="DECIMAL",t[t.SINGLE_LINE=6]="SINGLE_LINE"}(f5||(f5={})),Jt(f5),function(t){t[t.PASSWORD=0]="PASSWORD",t[t.SENSITIVE=1]="SENSITIVE",t[t.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",t[t.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",t[t.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",t[t.DEFAULT=5]="DEFAULT"}(p5||(p5={})),Jt(p5);var v5,g5,y5,x5,S5,A5,C5,b5,T5,E5,w5,P5,I5,R5,D5,B5,M5,O5,N5,L5,F5,z5,V5,G5,U5,k5,H5,j5,W5,q5,X5,Y5,K5,J5,Q5,Z5,$5,t8,e8,n8,i8,r8,o8,a8,s8,c8,l8,u8,h8,_8,f8,p8,d8,m8,v8,g8,y8,x8,S8,A8,C8,b8=function(){function t(){this._editing=!1,this._delegate=null}var e=t.prototype;return e.init=function(){},e.onEnable=function(){},e.update=function(){},e.onDisable=function(){this._editing&&this.endEditing()},e.clear=function(){this._delegate=null},e.setTabIndex=function(){},e.setSize=function(){},e.setFocus=function(t){t?this.beginEditing():this.endEditing()},e.isFocused=function(){return this._editing},e.beginEditing=function(){},e.endEditing=function(){},t}(),T8=new Ei,E8=new Ei,w8=new oi,P8=null,I8=0,R8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._delegate=null,e._inputMode=-1,e._inputFlag=-1,e._returnType=-1,e.__eventListeners={},e.__autoResize=!1,e.__orientationChanged=void 0,e._edTxt=null,e._isTextArea=!1,e._textLabelFont=null,e._textLabelFontSize=null,e._textLabelFontColor=null,e._textLabelAlign=null,e._placeholderLabelFont=null,e._placeholderLabelFontSize=null,e._placeholderLabelFontColor=null,e._placeholderLabelAlign=null,e._placeholderLineHeight=null,e._placeholderStyleSheet=null,e._domId="EditBoxId_"+ ++I8,e}F(e,t);var n=e.prototype;return n.init=function(t){t&&(this._delegate=t,t.inputMode===f5.ANY?this._createTextArea():this._createInput(),m5.add(this),this.setTabIndex(t.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer())},n.clear=function(){this._removeEventListeners(),this._removeDomFromGameContainer(),m5.remove(this),P8===this&&(P8=null),this._delegate=null},n.update=function(){this._updateMatrix()},n.setTabIndex=function(t){this._edTxt.tabIndex=t,m5.resort()},n.setSize=function(t,e){var n=this._edTxt;n&&(n.style.width=t+"px",n.style.height=e+"px")},n.beginEditing=function(){P8&&P8!==this&&P8.setFocus(!1),this._editing=!0,P8=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()},n.endEditing=function(){this._edTxt.blur()},n._createInput=function(){this._isTextArea=!1,this._edTxt=document.createElement("input")},n._createTextArea=function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")},n._addDomToGameContainer=function(){i.GAME_VIEW&&this._edTxt?(i.gameView.container.appendChild(this._edTxt),i.gameView.head.appendChild(this._placeholderStyleSheet)):mM.container&&this._edTxt&&(mM.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))},n._removeDomFromGameContainer=function(){(i.GAME_VIEW?le(i.gameView.container,this._edTxt):le(mM.container,this._edTxt))&&this._edTxt&&(i.GAME_VIEW?i.gameView.container.removeChild(this._edTxt):mM.container.removeChild(this._edTxt)),(i.GAME_VIEW?le(i.gameView.head,this._placeholderStyleSheet):le(document.head,this._placeholderStyleSheet))&&(i.GAME_VIEW?i.gameView.head.removeChild(this._placeholderStyleSheet):document.head.removeChild(this._placeholderStyleSheet)),this._edTxt=null,this._placeholderStyleSheet=null},n._showDom=function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),Zu.isMobile&&this._showDomOnMobile()},n._hideDom=function(){var t=this._edTxt;t&&this._delegate&&(t.style.display="none",this._delegate._showLabels()),Zu.isMobile&&this._hideDomOnMobile()},n._showDomOnMobile=function(){Zu.os!==hn.ANDROID&&Zu.os!==hn.OHOS||(Ku.handleResizeEvent=!1,this._adjustWindowScroll())},n._hideDomOnMobile=function(){Zu.os!==hn.ANDROID&&Zu.os!==hn.OHOS||(Ku.handleResizeEvent=!0),this._scrollBackWindow()},n._adjustWindowScroll=function(){var t=this;setTimeout((function(){window.scrollY<40&&t._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)},n._scrollBackWindow=function(){setTimeout((function(){Zu.browserType!==cn.WECHAT||Zu.os!==hn.IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)},n._updateMatrix=function(){if(this._edTxt){var t=this._delegate.node,e=CM.getScaleX(),n=CM.getScaleY(),r=1,o=1;i.GAME_VIEW&&(r=i.gameView.canvas.width/i.game.canvas.width,o=i.gameView.canvas.height/i.game.canvas.height),e*=r,n*=o;var a=CM.getViewportRect(),s=Ku.devicePixelRatio;t.getWorldMatrix(T8);var c=t._uiProps.uiTransformComp;if(c&&oi.set(w8,-c.anchorX*c.width,-c.anchorY*c.height,w8.z),Ei.transform(T8,T8,w8),t._uiProps.uiTransformComp){var l=LM.root.batcher2D.getFirstRenderCamera(t);if(l){l.node.getWorldRT(E8);var u=E8.m12,h=E8.m13,_=kB.center;E8.m12=_.x-(E8.m00*u+E8.m04*h),E8.m13=_.y-(E8.m01*u+E8.m05*h),Ei.multiply(E8,E8,T8),e/=s,n/=s;var f=i.GAME_VIEW?i.gameView.container:mM.container,p=E8.m00*e,d=T8.m01,m=T8.m04,v=E8.m05*n,g=parseInt(f&&f.style.paddingLeft||"0");g+=a.x*r/s;var y=parseInt(f&&f.style.paddingBottom||"0");y+=a.y/s;var x="matrix("+p+","+-d+","+-m+","+v+","+(E8.m12*e+g)+","+-(E8.m13*n+y)+")";this._edTxt.style.transform=x,this._edTxt.style["-webkit-transform"]=x,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},n._updateInputType=function(){var t=this._delegate,e=t.inputMode,n=t.inputFlag,i=t.returnType,r=this._edTxt;if(this._inputMode!==e||this._inputFlag!==n||this._returnType!==i){if(this._inputMode=e,this._inputFlag=n,this._returnType=i,this._isTextArea){var o="none";return n===p5.INITIAL_CAPS_ALL_CHARACTERS?o="uppercase":n===p5.INITIAL_CAPS_WORD&&(o="capitalize"),void(r.style.textTransform=o)}if(r=r,n===p5.PASSWORD)return r.type="password",void(r.style.textTransform="none");var a=r.type;e===f5.EMAIL_ADDR?a="email":e===f5.NUMERIC||e===f5.DECIMAL?a="number":e===f5.PHONE_NUMBER?(a="number",r.pattern="[0-9]*",r.addEventListener("wheel",(function(){return!1}))):e===f5.URL?a="url":(a="text",i===_5.SEARCH&&(a="search")),r.type=a;var s="none";n===p5.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":n===p5.INITIAL_CAPS_WORD&&(s="capitalize"),r.style.textTransform=s}},n._updateMaxLength=function(){var t=this._delegate.maxLength;t<0&&(t=65535),this._edTxt.maxLength=t},n._initStyleSheet=function(){if(this._edTxt){var t=this._edTxt;t.style.color="#000000",t.style.border="0px",t.style.background="transparent",t.style.width="100%",t.style.height="100%",t.style.outline="medium",t.style.padding="0",t.style.textTransform="none",t.style.display="none",t.style.position="absolute",t.style.bottom="0px",t.style.left="2px",t.className="cocosEditBox",t.style.fontFamily="Arial",t.id=this._domId,this._isTextArea?(t.style.resize="none",t.style.overflowY="scroll"):((t=t).type="text",t.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}},n._updateStyleSheet=function(){var t=this._delegate,e=this._edTxt;e&&t&&(e.value=t.string,e.placeholder=t.placeholder,this._updateTextLabel(t.textLabel),this._updatePlaceholderLabel(t.placeholderLabel))},n._updateTextLabel=function(t){if(t){var e=t.font;e=!e||e instanceof QX?t.fontFamily:e._fontFamily;var n=t.fontSize*t.node.scale.y;if((this._textLabelFont!==e||this._textLabelFontSize!==n||this._textLabelFontColor!==t.fontColor||this._textLabelAlign!==t.horizontalAlign)&&(this._textLabelFont=e,this._textLabelFontSize=n,this._textLabelFontColor=t.fontColor,this._textLabelAlign=t.horizontalAlign,this._edTxt)){var i=this._edTxt;switch(i.style.fontSize=n+"px",i.style.color=t.color.toCSS(),i.style.fontFamily=e,t.horizontalAlign){case UJ.HorizontalAlign.LEFT:i.style.textAlign="left";break;case UJ.HorizontalAlign.CENTER:i.style.textAlign="center";break;case UJ.HorizontalAlign.RIGHT:i.style.textAlign="right"}}}},n._updatePlaceholderLabel=function(t){if(t){var e=t.font;e=!e||e instanceof QX?t.fontFamily:t.font._fontFamily;var n=t.fontSize*t.node.scale.y;if(this._placeholderLabelFont!==e||this._placeholderLabelFontSize!==n||this._placeholderLabelFontColor!==t.fontColor||this._placeholderLabelAlign!==t.horizontalAlign||this._placeholderLineHeight!==t.fontSize){this._placeholderLabelFont=e,this._placeholderLabelFontSize=n,this._placeholderLabelFontColor=t.fontColor,this._placeholderLabelAlign=t.horizontalAlign,this._placeholderLineHeight=t.fontSize;var i=this._placeholderStyleSheet,r=t.color.toCSS(),o=t.fontSize,a="";switch(t.horizontalAlign){case UJ.HorizontalAlign.LEFT:a="left";break;case UJ.HorizontalAlign.CENTER:a="center";break;case UJ.HorizontalAlign.RIGHT:a="right"}i.innerHTML="#"+this._domId+"::-webkit-input-placeholder{text-transform: initial;-family: "+e+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-moz-placeholder{text-transform: initial;-family: "+e+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-ms-input-placeholder{text-transform: initial;-family: "+e+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}",Zu.browserType===cn.EDGE&&(i.innerHTML+="#"+this._domId+"::-ms-clear{display: none;}")}}},n._registerEventListeners=function(){var t=this;if(this._edTxt){var e=this._edTxt,n=!1,i=this.__eventListeners;i.compositionStart=function(){n=!0},i.compositionEnd=function(){n=!1,t._delegate._editBoxTextChanged(e.value)},i.onInput=function(){if(!n){var i=t._delegate,r=i.maxLength;r>=0&&(e.value=e.value.slice(0,r)),i._editBoxTextChanged(e.value)}},i.onClick=function(){t._editing&&Zu.isMobile&&t._adjustWindowScroll()},i.onKeydown=function(n){n.keyCode===KB.ENTER?(n.propagationStopped=!0,t._delegate._editBoxEditingReturn(),t._isTextArea||e.blur()):n.keyCode===KB.TAB&&(n.propagationStopped=!0,n.preventDefault(),m5.next(t))},i.onBlur=function(){Zu.isMobile&&n&&i.compositionEnd(),t._editing=!1,P8=null,t._hideDom(),t._delegate._editBoxEditingDidEnded()},e.addEventListener("compositionstart",i.compositionStart),e.addEventListener("compositionend",i.compositionEnd),e.addEventListener("input",i.onInput),e.addEventListener("keydown",i.onKeydown),e.addEventListener("blur",i.onBlur),e.addEventListener("touchstart",i.onClick)}},n._removeEventListeners=function(){if(this._edTxt){var t=this._edTxt,e=this.__eventListeners;t.removeEventListener("compositionstart",e.compositionStart),t.removeEventListener("compositionend",e.compositionEnd),t.removeEventListener("input",e.onInput),t.removeEventListener("keydown",e.onKeydown),t.removeEventListener("blur",e.onBlur),t.removeEventListener("touchstart",e.onClick),e.compositionStart=null,e.compositionEnd=null,e.onInput=null,e.onKeydown=null,e.onBlur=null,e.onClick=null}},e}(b8);!function(t){t.EDITING_DID_BEGAN="editing-did-began",t.EDITING_DID_ENDED="editing-did-ended",t.TEXT_CHANGED="text-changed",t.EDITING_RETURN="editing-return"}(C8||(C8={}));var D8,B8,M8,O8,N8,L8,F8,z8,V8,G8,U8,k8,H8,j8,W8,q8,X8,Y8,K8,J8,Q8,Z8,$8,t6,e6,n6,i6,r6,o6,a6,s6,c6,l6,u6,h6,_6,f6,p6,d6,m6,v6,g6,y6,x6,S6,A6,C6,b6,T6,E6,w6,P6,I6,R6,D6,B6,M6,O6,N6,L6,F6=t("EditBox",(v5=qc("cc.EditBox"),g5=cl(),y5=Yc(110),x5=rl(),S5=Xc($Y),A5=yl(),C5=fl(),b5=yl(),T5=fl(),E5=El(UJ),w5=yl(),P5=fl(),I5=El(UJ),R5=yl(),D5=fl(),B5=El(RX),M5=yl(),O5=fl(),N5=El(p5),L5=yl(),F5=fl(),z5=El(f5),V5=yl(),G5=fl(),U5=El(_5),k5=yl(),H5=fl(),j5=yl(),W5=fl(),q5=yl(),X5=fl(),Y5=El([hL]),K5=yl(),J5=fl(),Q5=El([hL]),Z5=yl(),$5=fl(),t8=El([hL]),e8=yl(),n8=fl(),i8=El([hL]),r8=yl(),o8=fl(),v5(a8=g5(a8=y5(a8=x5(a8=S5(a8=il((A8=S8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"editingDidBegan",c8,H(e)),q(e,"textChanged",l8,H(e)),q(e,"editingDidEnded",u8,H(e)),q(e,"editingReturn",h8,H(e)),e._impl=null,e._background=null,q(e,"_textLabel",_8,H(e)),q(e,"_placeholderLabel",f8,H(e)),q(e,"_returnType",p8,H(e)),q(e,"_string",d8,H(e)),q(e,"_tabIndex",m8,H(e)),q(e,"_backgroundImage",v8,H(e)),q(e,"_inputFlag",g8,H(e)),q(e,"_inputMode",y8,H(e)),q(e,"_maxLength",x8,H(e)),e._isLabelVisible=!1,e}F(e,t);var n=e.prototype;return n.__preload=function(){this._init()},n.onEnable=function(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()},n.update=function(){this._impl&&this._impl.update()},n.onDisable=function(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()},n.onDestroy=function(){this._impl&&this._impl.clear()},n.setFocus=function(){this._impl&&this._impl.setFocus(!0)},n.focus=function(){this._impl&&this._impl.setFocus(!0)},n.blur=function(){this._impl&&this._impl.setFocus(!1)},n.isFocused=function(){return!!this._impl&&this._impl.isFocused()},n._editBoxEditingDidBegan=function(){hL.emitEvents(this.editingDidBegan,this),this.node.emit(C8.EDITING_DID_BEGAN,this)},n._editBoxEditingDidEnded=function(){hL.emitEvents(this.editingDidEnded,this),this.node.emit(C8.EDITING_DID_ENDED,this)},n._editBoxTextChanged=function(t){t=this._updateLabelStringStyle(t,!0),this.string=t,hL.emitEvents(this.textChanged,t,this),this.node.emit(C8.TEXT_CHANGED,this)},n._editBoxEditingReturn=function(){hL.emitEvents(this.editingReturn,this),this.node.emit(C8.EDITING_RETURN,this)},n._showLabels=function(){this._isLabelVisible=!0,this._updateLabels()},n._hideLabels=function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)},n._onTouchBegan=function(t){t.propagationStopped=!0},n._onTouchCancel=function(t){t.propagationStopped=!0},n._onTouchEnded=function(t){this._impl&&this._impl.beginEditing(),t.propagationStopped=!0},n._init=function(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(RC.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new e._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()},n._ensureBackgroundSprite=function(){if(!this._background){var t=this.node.getComponent(I$);t||(t=this.node.addComponent(I$)),t!==this._background&&(t.type=I$.Type.SLICED,t.spriteFrame=this._backgroundImage,this._background=t,this._registerBackgroundEvent())}},n._updateTextLabel=function(){var t=this._textLabel;if(!t){var e=this.node.getChildByName("TEXT_LABEL");e||((e=new BT("TEXT_LABEL")).layer=this.node.layer),(t=e.getComponent(UJ))||(t=e.addComponent(UJ)),e.parent=this.node,this._textLabel=t}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=UJ.Overflow.CLAMP,this._inputMode===f5.ANY?(t.verticalAlign=OJ.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this._updateLabelStringStyle(this._string)},n._updatePlaceholderLabel=function(){var t=this._placeholderLabel;if(!t){var e=this.node.getChildByName("PLACEHOLDER_LABEL");e||((e=new BT("PLACEHOLDER_LABEL")).layer=this.node.layer),(t=e.getComponent(UJ))||(t=e.addComponent(UJ)),e.parent=this.node,this._placeholderLabel=t}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=UJ.Overflow.CLAMP,this._inputMode===f5.ANY?(t.verticalAlign=OJ.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this.placeholder},n._syncSize=function(){var t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(this._background){var n=this._background.node._uiProps.uiTransformComp;n.anchorPoint=t.anchorPoint,n.setContentSize(e)}this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)},n._updateLabels=function(){if(this._isLabelVisible){var t=this._string;this._textLabel&&(this._textLabel.node.active=""!==t),this._placeholderLabel&&(this._placeholderLabel.node.active=""===t)}},n._updateString=function(t){var e=this._textLabel;if(e){var n=t;n&&(n=this._updateLabelStringStyle(n)),e.string=n,this._updateLabels()}},n._updateLabelStringStyle=function(t,e){void 0===e&&(e=!1);var n,i=this._inputFlag;if(e||i!==p5.PASSWORD)i===p5.INITIAL_CAPS_ALL_CHARACTERS?t=t.toUpperCase():i===p5.INITIAL_CAPS_WORD?t=t.replace(/(?:^|\s)\S/g,(function(t){return t.toUpperCase()})):i===p5.INITIAL_CAPS_SENTENCE&&(t=(n=t).charAt(0).toUpperCase()+n.slice(1));else{for(var r="",o=t.length,a=0;a<o;++a)r+="●";t=r}return t},n._registerEvent=function(){this.node.on(RC.TOUCH_START,this._onTouchBegan,this),this.node.on(RC.TOUCH_END,this._onTouchEnded,this)},n._unregisterEvent=function(){this.node.off(RC.TOUCH_START,this._onTouchBegan,this),this.node.off(RC.TOUCH_END,this._onTouchEnded,this)},n._onBackgroundSpriteFrameChanged=function(){this._background&&(this.backgroundImage=this._background.spriteFrame)},n._registerBackgroundEvent=function(){var t=this._background&&this._background.node;null==t||t.on(I$.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._unregisterBackgroundEvent=function(){var t=this._background&&this._background.node;null==t||t.off(I$.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._updateLabelPosition=function(t){var e=this.node._uiProps.uiTransformComp,n=-e.anchorX*e.width,i=-e.anchorY*e.height,r=this._placeholderLabel,o=this._textLabel;o&&(o.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),o.node.setPosition(n+2,i+t.height,o.node.position.z),this._inputMode===f5.ANY&&(o.verticalAlign=OJ.TOP),o.enableWrapText=this._inputMode===f5.ANY),r&&(r.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),r.lineHeight=t.height,r.node.setPosition(n+2,i+t.height,r.node.position.z),this._inputMode===f5.ANY&&(r.verticalAlign=OJ.TOP),r.enableWrapText=this._inputMode===f5.ANY)},n._resizeChildNodes=function(){var t=this.node._uiProps.uiTransformComp,e=this._textLabel&&this._textLabel.node;e&&(e.setPosition(-t.width/2,t.height/2,e.position.z),e._uiProps.uiTransformComp.setContentSize(t.contentSize));var n=this._placeholderLabel&&this._placeholderLabel.node;n&&(n.setPosition(-t.width/2,t.height/2,n.position.z),n._uiProps.uiTransformComp.setContentSize(t.contentSize));var i=this._background&&this._background.node;i&&i._uiProps.uiTransformComp.setContentSize(t.contentSize)},N(e,[{key:"string",get:function(){return this._string},set:function(t){this._maxLength>=0&&t.length>=this._maxLength&&(t=t.slice(0,this._maxLength)),this._string=t,this._updateString(t)}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(t){this._placeholderLabel&&(this._placeholderLabel.string=t)}},{key:"textLabel",get:function(){return this._textLabel},set:function(t){this._textLabel!==t&&(this._textLabel=t,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(t){this._placeholderLabel!==t&&(this._placeholderLabel=t,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(t){this._backgroundImage!==t&&(this._backgroundImage=t,this._ensureBackgroundSprite(),this._background.spriteFrame=t)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(t){this._inputFlag=t,this._updateString(this._string)}},{key:"inputMode",get:function(){return this._inputMode},set:function(t){this._inputMode!==t&&(this._inputMode=t,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(t){this._returnType=t}},{key:"maxLength",get:function(){return this._maxLength},set:function(t){this._maxLength=t}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(t){this._tabIndex!==t&&(this._tabIndex=t,this._impl&&this._impl.setTabIndex(t))}}]),e}(ku),S8._EditBoxImpl=b8,S8.KeyboardReturnType=_5,S8.InputFlag=p5,S8.InputMode=f5,S8.EventType=C8,X((s8=A8).prototype,"string",[A5,C5],Object.getOwnPropertyDescriptor(s8.prototype,"string"),s8.prototype),X(s8.prototype,"placeholder",[b5,T5],Object.getOwnPropertyDescriptor(s8.prototype,"placeholder"),s8.prototype),X(s8.prototype,"textLabel",[E5,w5,P5],Object.getOwnPropertyDescriptor(s8.prototype,"textLabel"),s8.prototype),X(s8.prototype,"placeholderLabel",[I5,R5,D5],Object.getOwnPropertyDescriptor(s8.prototype,"placeholderLabel"),s8.prototype),X(s8.prototype,"backgroundImage",[B5,M5,O5],Object.getOwnPropertyDescriptor(s8.prototype,"backgroundImage"),s8.prototype),X(s8.prototype,"inputFlag",[N5,L5,F5],Object.getOwnPropertyDescriptor(s8.prototype,"inputFlag"),s8.prototype),X(s8.prototype,"inputMode",[z5,V5,G5],Object.getOwnPropertyDescriptor(s8.prototype,"inputMode"),s8.prototype),X(s8.prototype,"returnType",[U5,k5,H5],Object.getOwnPropertyDescriptor(s8.prototype,"returnType"),s8.prototype),X(s8.prototype,"maxLength",[j5,W5],Object.getOwnPropertyDescriptor(s8.prototype,"maxLength"),s8.prototype),X(s8.prototype,"tabIndex",[q5,X5],Object.getOwnPropertyDescriptor(s8.prototype,"tabIndex"),s8.prototype),c8=X(s8.prototype,"editingDidBegan",[Y5,Zc,K5,J5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),l8=X(s8.prototype,"textChanged",[Q5,Zc,Z5,$5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),u8=X(s8.prototype,"editingDidEnded",[t8,Zc,e8,n8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),h8=X(s8.prototype,"editingReturn",[i8,Zc,r8,o8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_8=X(s8.prototype,"_textLabel",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f8=X(s8.prototype,"_placeholderLabel",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),p8=X(s8.prototype,"_returnType",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _5.DEFAULT}}),d8=X(s8.prototype,"_string",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),m8=X(s8.prototype,"_tabIndex",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v8=X(s8.prototype,"_backgroundImage",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),g8=X(s8.prototype,"_inputFlag",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return p5.DEFAULT}}),y8=X(s8.prototype,"_inputMode",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return f5.ANY}}),x8=X(s8.prototype,"_maxLength",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),a8=s8))||a8)||a8)||a8)||a8)||a8)||a8));"object"==typeof window&&"object"==typeof document&&(F6._EditBoxImpl=R8),i.internal.EditBox=F6,function(t){t[t.NONE=0]="NONE",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.GRID=3]="GRID"}(D6||(D6={})),$t(D6),function(t){t[t.NONE=0]="NONE",t[t.CONTAINER=1]="CONTAINER",t[t.CHILDREN=2]="CHILDREN"}(B6||(B6={})),$t(B6),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(M6||(M6={})),$t(M6),function(t){t[t.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",t[t.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(O6||(O6={})),$t(O6),function(t){t[t.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",t[t.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(N6||(N6={})),$t(N6),function(t){t[t.NONE=0]="NONE",t[t.FIXED_ROW=1]="FIXED_ROW",t[t.FIXED_COL=2]="FIXED_COL"}(L6||(L6={})),$t(L6);var z6,V6,G6,U6,k6,H6,j6,W6,q6,X6,Y6,K6,J6,Q6,Z6,$6,t7,e7,n7,i7,r7,o7,a7,s7=new oi,c7=t("Layout",(D8=qc("cc.Layout"),B8=cl(),M8=Yc(110),O8=rl(),N8=Xc($Y),L8=ul(),F8=fl(),z8=ul(),V8=fl(),G8=El(D6),U8=fl(),k8=El(B6),H8=ul(),j8=fl(),W8=ul(),q8=fl(),X8=El(M6),Y8=fl(),K8=fl(),J8=fl(),Q8=fl(),Z8=fl(),$8=fl(),t6=fl(),e6=El(O6),n6=fl(),i6=El(N6),r6=fl(),o6=El(L6),a6=ul(),s6=fl(),c6=ul(),l6=fl(),u6=fl(),D8(h6=B8(h6=M8(h6=O8(h6=N8(h6=il((R6=I6=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_resizeMode",f6,H(e)),q(e,"_layoutType",p6,H(e)),q(e,"_cellSize",d6,H(e)),q(e,"_startAxis",m6,H(e)),q(e,"_paddingLeft",v6,H(e)),q(e,"_paddingRight",g6,H(e)),q(e,"_paddingTop",y6,H(e)),q(e,"_paddingBottom",x6,H(e)),q(e,"_spacingX",S6,H(e)),q(e,"_spacingY",A6,H(e)),q(e,"_verticalDirection",C6,H(e)),q(e,"_horizontalDirection",b6,H(e)),q(e,"_constraint",T6,H(e)),q(e,"_constraintNum",E6,H(e)),q(e,"_affectedByScale",w6,H(e)),q(e,"_isAlign",P6,H(e)),e._layoutSize=new Di(300,200),e._layoutDirty=!0,e._childrenDirty=!1,e._usefulLayoutObj=[],e._init=!1,e}F(e,t);var n=e.prototype;return n.updateLayout=function(t){void 0===t&&(t=!1),(this._layoutDirty||t)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)},n.onEnable=function(){this._addEventListeners();var t=this.node._uiProps.uiTransformComp;t.contentSize.equals(Di.ZERO)&&t.setContentSize(this._layoutSize),this._childrenChanged()},n.onDisable=function(){this._usefulLayoutObj.length=0,this._removeEventListeners()},n._checkUsefulObj=function(){this._usefulLayoutObj.length=0;for(var t=this.node.children,e=0;e<t.length;++e){var n=t[e],i=n._uiProps.uiTransformComp;n.activeInHierarchy&&i&&this._usefulLayoutObj.push(i)}},n._addEventListeners=function(){LM.on(NM.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(RC.SIZE_CHANGED,this._resized,this),this.node.on(RC.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(RC.CHILD_ADDED,this._childAdded,this),this.node.on(RC.CHILD_REMOVED,this._childRemoved,this),this.node.on(RC.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()},n._removeEventListeners=function(){LM.off(NM.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(RC.SIZE_CHANGED,this._resized,this),this.node.off(RC.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(RC.CHILD_ADDED,this._childAdded,this),this.node.off(RC.CHILD_REMOVED,this._childRemoved,this),this.node.off(RC.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()},n._addChildrenEventListeners=function(){for(var t=this.node.children,e=0;e<t.length;++e){var n=t[e];n.on(RC.SIZE_CHANGED,this._doLayoutDirty,this),n.on(RC.TRANSFORM_CHANGED,this._transformDirty,this),n.on(RC.ANCHOR_CHANGED,this._doLayoutDirty,this),n.on(RC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._removeChildrenEventListeners=function(){for(var t=this.node.children,e=0;e<t.length;++e){var n=t[e];n.off(RC.SIZE_CHANGED,this._doLayoutDirty,this),n.off(RC.TRANSFORM_CHANGED,this._transformDirty,this),n.off(RC.ANCHOR_CHANGED,this._doLayoutDirty,this),n.off(RC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._childAdded=function(t){t.on(RC.SIZE_CHANGED,this._doLayoutDirty,this),t.on(RC.TRANSFORM_CHANGED,this._transformDirty,this),t.on(RC.ANCHOR_CHANGED,this._doLayoutDirty,this),t.on(RC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._childRemoved=function(t){t.off(RC.SIZE_CHANGED,this._doLayoutDirty,this),t.off(RC.TRANSFORM_CHANGED,this._transformDirty,this),t.off(RC.ANCHOR_CHANGED,this._doLayoutDirty,this),t.off(RC.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._resized=function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()},n._doLayoutHorizontally=function(t,e,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingLeft;this._horizontalDirection===N6.RIGHT_TO_LEFT&&(a=-1,s=this._paddingRight);var c=(this._horizontalDirection-r.x)*t+a*s,l=c-a*this._spacingX,u=0,h=0,_=0,f=0,p=!1,d=this._usefulLayoutObj.length,m=this._cellSize.width,v=this._getPaddingH();this._layoutType!==D6.GRID&&this._resizeMode===B6.CHILDREN&&(m=(t-v-(d-1)*this._spacingX)/d);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,A=S.scale,C=this._getUsedScaleValue(A.x),b=this._getUsedScaleValue(A.y);this._resizeMode===B6.CHILDREN&&(x.width=m/C,this._layoutType===D6.GRID&&(x.height=this._cellSize.height/b));var T=Math.abs(this._horizontalDirection-x.anchorX),E=x.width*C,w=x.height*b;w>_&&(f=Math.max(_,f),h=_||w,_=w),l+=a*(T*E+this._spacingX);var P=a*(1-T)*E;if(e){if(o>0)(p=y/o>0&&y%o==0)&&(h=_>w?_:h);else if(E>t-v)l>c+a*T*E&&(p=!0);else{var I=(1-this._horizontalDirection-r.x)*t,R=l+P+a*(a>0?this._paddingRight:this._paddingLeft);p=Math.abs(R)>Math.abs(I)}p&&(l=c+a*T*E,w!==_&&(h=_),u+=h+this._spacingY,h=_=w)}var D=n(S,x,u);i&&S.setPosition(l,D),l+=P}return h=Math.max(h,_),Math.max(f,u+h)+this._getPaddingV()},n._doLayoutVertically=function(t,e,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingBottom;this._verticalDirection===O6.TOP_TO_BOTTOM&&(a=-1,s=this._paddingTop);var c=(this._verticalDirection-r.y)*t+a*s,l=c-a*this._spacingY,u=0,h=0,_=0,f=0,p=!1,d=this._usefulLayoutObj.length,m=this._cellSize.height,v=this._getPaddingV();this._layoutType!==D6.GRID&&this._resizeMode===B6.CHILDREN&&(m=(t-v-(d-1)*this._spacingY)/d);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,A=S.scale,C=this._getUsedScaleValue(A.x),b=this._getUsedScaleValue(A.y);this._resizeMode===B6.CHILDREN&&(x.height=m/b,this._layoutType===D6.GRID&&(x.width=this._cellSize.width/C));var T=Math.abs(this._verticalDirection-x.anchorY),E=x.width*C,w=x.height*b;E>u&&(h=Math.max(u,h),_=u||E,u=E),l+=a*(T*w+this._spacingY);var P=a*(1-T)*w;if(e){if(o>0)(p=y/o>0&&y%o==0)&&(_=u>w?u:_);else if(w>t-v)l>c+a*T*w&&(p=!0);else{var I=(1-this._verticalDirection-r.y)*t,R=l+P+a*(a>0?this._paddingTop:this._paddingBottom);p=Math.abs(R)>Math.abs(I)}p&&(l=c+a*T*w,E!==u&&(_=u),f+=_+this._spacingX,_=u=E)}var D=n(S,x,f);i&&(S.getPosition(s7),S.setPosition(D,l,s7.z)),l+=P}return _=Math.max(_,u),Math.max(h,f+_)+this._getPaddingH()},n._doLayoutGridAxisHorizontal=function(t,e){var n=this,i=e.width,r=1,o=-t.y*e.height,a=this._paddingBottom;this._verticalDirection===O6.TOP_TO_BOTTOM&&(r=-1,o=(1-t.y)*e.height,a=this._paddingTop);var s=function(t,e,i){return o+r*(i+(1-e.anchorY)*e.height*n._getUsedScaleValue(t.scale.y)+a)},c=0;this._resizeMode===B6.CONTAINER&&(c=this._doLayoutHorizontally(i,!0,s,!1),o=-t.y*c,this._verticalDirection===O6.TOP_TO_BOTTOM&&(r=-1,o=(1-t.y)*c)),this._doLayoutHorizontally(i,!0,s,!0),this._resizeMode===B6.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,c)},n._doLayoutGridAxisVertical=function(t,e){var n=this,i=e.height,r=1,o=-t.x*e.width,a=this._paddingLeft;this._horizontalDirection===N6.RIGHT_TO_LEFT&&(r=-1,o=(1-t.x)*e.width,a=this._paddingRight);var s=function(t,e,i){return o+r*(i+(1-e.anchorX)*e.width*n._getUsedScaleValue(t.scale.x)+a)},c=0;this._resizeMode===B6.CONTAINER&&(c=this._doLayoutVertically(i,!0,s,!1),o=-t.x*c,this._horizontalDirection===N6.RIGHT_TO_LEFT&&(r=-1,o=(1-t.x)*c)),this._doLayoutVertically(i,!0,s,!0),this._resizeMode===B6.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(c,i)},n._doLayoutGrid=function(){var t=this.node._uiProps.uiTransformComp,e=t.anchorPoint,n=t.contentSize;this.startAxis===M6.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,n):this.startAxis===M6.VERTICAL&&this._doLayoutGridAxisVertical(e,n)},n._getHorizontalBaseWidth=function(){var t=this._usefulLayoutObj,e=0,n=t.length;if(this._resizeMode===B6.CONTAINER){for(var i=0;i<t.length;++i){var r=t[i],o=r.node.scale;e+=r.width*this._getUsedScaleValue(o.x)}e+=(n-1)*this._spacingX+this._getPaddingH()}else e=this.node._uiProps.uiTransformComp.width;return e},n._getVerticalBaseHeight=function(){var t=this._usefulLayoutObj,e=0,n=t.length;if(this._resizeMode===B6.CONTAINER){for(var i=0;i<t.length;++i){var r=t[i],o=r.node.scale;e+=r.height*this._getUsedScaleValue(o.y)}e+=(n-1)*this._spacingY+this._getPaddingV()}else e=this.node._uiProps.uiTransformComp.height;return e},n._doLayout=function(){var t=this;if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===D6.HORIZONTAL){var e=this._getHorizontalBaseWidth();this._doLayoutHorizontally(e,!1,(function(e){return(t._isAlign?oi.ZERO:e.position).y}),!0),this.node._uiProps.uiTransformComp.width=e}else if(this._layoutType===D6.VERTICAL){var n=this._getVerticalBaseHeight();this._doLayoutVertically(n,!1,(function(e){return(t._isAlign?oi.ZERO:e.position).x}),!0),this.node._uiProps.uiTransformComp.height=n}else this._layoutType===D6.GRID&&this._doLayoutGrid()},n._getUsedScaleValue=function(t){return this._affectedByScale?Math.abs(t):1},n._transformDirty=function(t){t&Nd.SCALE&&t&Nd.POSITION&&this._affectedByScale&&this._doLayoutDirty()},n._doLayoutDirty=function(){this._layoutDirty=!0},n._childrenChanged=function(){this._childrenDirty=!0,this._doLayoutDirty()},n._getPaddingH=function(){return this._paddingLeft+this._paddingRight},n._getPaddingV=function(){return this._paddingTop+this._paddingBottom},n._getFixedBreakingNum=function(){if(this._layoutType!==D6.GRID||this._constraint===L6.NONE||this._constraintNum<=0)return 0;var t=this._constraint===L6.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===M6.VERTICAL&&(t=this._constraint===L6.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),t},N(e,[{key:"alignHorizontal",get:function(){return this._isAlign},set:function(t){this._layoutType===D6.HORIZONTAL&&(this._isAlign=t,this._doLayoutDirty())}},{key:"alignVertical",get:function(){return this._isAlign},set:function(t){this._layoutType===D6.VERTICAL&&(this._isAlign=t,this._doLayoutDirty())}},{key:"type",get:function(){return this._layoutType},set:function(t){this._layoutType=t,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(t){this._layoutType!==D6.NONE&&(this._resizeMode=t,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(t){this._cellSize!==t&&(this._cellSize.set(t),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(t){this._startAxis!==t&&(this._startAxis=t,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(t){this._paddingLeft!==t&&(this._paddingLeft=t,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(t){this._paddingRight!==t&&(this._paddingRight=t,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(t){this._paddingTop!==t&&(this._paddingTop=t,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(t){this._paddingBottom!==t&&(this._paddingBottom=t,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(t){this._spacingX!==t&&(this._spacingX=t,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(t){this._spacingY!==t&&(this._spacingY=t,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(t){this._verticalDirection!==t&&(this._verticalDirection=t,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(t){this._horizontalDirection!==t&&(this._horizontalDirection=t,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(t){this.paddingLeft===t&&this._paddingRight===t&&this._paddingTop===t&&this._paddingBottom===t||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=t,this._doLayoutDirty())}},{key:"constraint",get:function(){return this._constraint},set:function(t){this._layoutType!==D6.NONE&&this._constraint!==t&&(this._constraint=t,this._doLayoutDirty())}},{key:"constraintNum",get:function(){return this._constraintNum},set:function(t){this._constraint!==L6.NONE&&this._constraintNum!==t&&(t<=0&&p("Limit values to be greater than 0"),this._constraintNum=t,this._doLayoutDirty())}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(t){this._affectedByScale=t,this._doLayoutDirty()}}]),e}(ku),I6.Type=D6,I6.VerticalDirection=O6,I6.HorizontalDirection=N6,I6.ResizeMode=B6,I6.AxisDirection=M6,I6.Constraint=L6,X((_6=R6).prototype,"alignHorizontal",[L8,F8],Object.getOwnPropertyDescriptor(_6.prototype,"alignHorizontal"),_6.prototype),X(_6.prototype,"alignVertical",[z8,V8],Object.getOwnPropertyDescriptor(_6.prototype,"alignVertical"),_6.prototype),X(_6.prototype,"type",[G8,U8],Object.getOwnPropertyDescriptor(_6.prototype,"type"),_6.prototype),X(_6.prototype,"resizeMode",[k8,H8,j8],Object.getOwnPropertyDescriptor(_6.prototype,"resizeMode"),_6.prototype),X(_6.prototype,"cellSize",[W8,q8],Object.getOwnPropertyDescriptor(_6.prototype,"cellSize"),_6.prototype),X(_6.prototype,"startAxis",[X8,Y8],Object.getOwnPropertyDescriptor(_6.prototype,"startAxis"),_6.prototype),X(_6.prototype,"paddingLeft",[K8],Object.getOwnPropertyDescriptor(_6.prototype,"paddingLeft"),_6.prototype),X(_6.prototype,"paddingRight",[J8],Object.getOwnPropertyDescriptor(_6.prototype,"paddingRight"),_6.prototype),X(_6.prototype,"paddingTop",[Q8],Object.getOwnPropertyDescriptor(_6.prototype,"paddingTop"),_6.prototype),X(_6.prototype,"paddingBottom",[Z8],Object.getOwnPropertyDescriptor(_6.prototype,"paddingBottom"),_6.prototype),X(_6.prototype,"spacingX",[$8],Object.getOwnPropertyDescriptor(_6.prototype,"spacingX"),_6.prototype),X(_6.prototype,"spacingY",[t6],Object.getOwnPropertyDescriptor(_6.prototype,"spacingY"),_6.prototype),X(_6.prototype,"verticalDirection",[e6,n6],Object.getOwnPropertyDescriptor(_6.prototype,"verticalDirection"),_6.prototype),X(_6.prototype,"horizontalDirection",[i6,r6],Object.getOwnPropertyDescriptor(_6.prototype,"horizontalDirection"),_6.prototype),X(_6.prototype,"constraint",[o6,a6,s6],Object.getOwnPropertyDescriptor(_6.prototype,"constraint"),_6.prototype),X(_6.prototype,"constraintNum",[c6,l6],Object.getOwnPropertyDescriptor(_6.prototype,"constraintNum"),_6.prototype),X(_6.prototype,"affectedByScale",[u6],Object.getOwnPropertyDescriptor(_6.prototype,"affectedByScale"),_6.prototype),f6=X(_6.prototype,"_resizeMode",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return B6.NONE}}),p6=X(_6.prototype,"_layoutType",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return D6.NONE}}),d6=X(_6.prototype,"_cellSize",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Di(40,40)}}),m6=X(_6.prototype,"_startAxis",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return M6.HORIZONTAL}}),v6=X(_6.prototype,"_paddingLeft",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),g6=X(_6.prototype,"_paddingRight",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),y6=X(_6.prototype,"_paddingTop",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),x6=X(_6.prototype,"_paddingBottom",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),S6=X(_6.prototype,"_spacingX",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),A6=X(_6.prototype,"_spacingY",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),C6=X(_6.prototype,"_verticalDirection",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return O6.TOP_TO_BOTTOM}}),b6=X(_6.prototype,"_horizontalDirection",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return N6.LEFT_TO_RIGHT}}),T6=X(_6.prototype,"_constraint",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return L6.NONE}}),E6=X(_6.prototype,"_constraintNum",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),w6=X(_6.prototype,"_affectedByScale",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),P6=X(_6.prototype,"_isAlign",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),h6=_6))||h6)||h6)||h6)||h6)||h6)||h6));!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.FILLED=2]="FILLED"}(a7||(a7={})),Jt(a7),t("ProgressBar",(z6=qc("cc.ProgressBar"),V6=cl(),G6=Yc(110),U6=rl(),k6=Xc($Y),H6=El(I$),j6=fl(),W6=El(a7),q6=fl(),X6=fl(),Y6=pl(),K6=fl(),J6=fl(),z6(Q6=V6(Q6=G6(Q6=U6(Q6=k6((o7=r7=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_barSprite",$6,H(e)),q(e,"_mode",t7,H(e)),q(e,"_totalLength",e7,H(e)),q(e,"_progress",n7,H(e)),q(e,"_reverse",i7,H(e)),e}F(e,t);var n=e.prototype;return n._initBarSprite=function(){if(this._barSprite){var t=this._barSprite.node;if(!t)return;var e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint,r=t._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===I$.FillType.RADIAL&&(this._mode=a7.FILLED),this._mode===a7.HORIZONTAL?this.totalLength=r.width:this._mode===a7.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,t.parent===this.node){var o=-n.width*i.x;t.setPosition(o,0,0)}}},n._updateBarStatus=function(){if(this._barSprite){var t=this._barSprite.node;if(!t)return;var e=t._uiProps.uiTransformComp,n=e.anchorPoint,i=e.contentSize,r=t.getPosition(),o=new li(0,.5),a=kn(this._progress),s=this._totalLength*a,c=i,l=0,u=0;switch(this._mode){case a7.HORIZONTAL:this._reverse&&(o=new li(1,.5)),c=new Di(s,i.height),l=this._totalLength,u=i.height;break;case a7.VERTICAL:o=this._reverse?new li(.5,1):new li(.5,0),c=new Di(i.width,s),l=i.width,u=this._totalLength}if(this._mode===a7.FILLED)this._barSprite.type!==I$.Type.FILLED?p("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==I$.Type.FILLED){var h=o.x-n.x,_=o.y-n.y,f=new oi(l*h,u*_,0);t.setPosition(r.x+f.x,r.y+f.y,r.z),e.setAnchorPoint(o),e.setContentSize(c)}else p("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}},N(e,[{key:"barSprite",get:function(){return this._barSprite},set:function(t){this._barSprite!==t&&(this._barSprite=t,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(t){if(this._mode!==t&&(this._mode=t,this._barSprite)){var e=this._barSprite.node;if(!e)return;var n=e._uiProps.uiTransformComp.contentSize;this._mode===a7.HORIZONTAL?this.totalLength=n.width:this._mode===a7.VERTICAL?this.totalLength=n.height:this._mode===a7.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(t){this._mode===a7.FILLED&&(t=kn(t)),this._totalLength=t,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(t){this._progress!==t&&(this._progress=t,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(t){this._reverse!==t&&(this._reverse=t,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),e}(ku),r7.Mode=a7,X((Z6=o7).prototype,"barSprite",[H6,j6],Object.getOwnPropertyDescriptor(Z6.prototype,"barSprite"),Z6.prototype),X(Z6.prototype,"mode",[W6,q6],Object.getOwnPropertyDescriptor(Z6.prototype,"mode"),Z6.prototype),X(Z6.prototype,"totalLength",[X6],Object.getOwnPropertyDescriptor(Z6.prototype,"totalLength"),Z6.prototype),X(Z6.prototype,"progress",[Y6,gl,K6],Object.getOwnPropertyDescriptor(Z6.prototype,"progress"),Z6.prototype),X(Z6.prototype,"reverse",[J6],Object.getOwnPropertyDescriptor(Z6.prototype,"reverse"),Z6.prototype),$6=X(Z6.prototype,"_barSprite",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),t7=X(Z6.prototype,"_mode",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return a7.HORIZONTAL}}),e7=X(Z6.prototype,"_totalLength",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),n7=X(Z6.prototype,"_progress",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),i7=X(Z6.prototype,"_reverse",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Q6=Z6))||Q6)||Q6)||Q6)||Q6)||Q6));var l7,u7,h7,_7,f7,p7,d7,m7,v7,g7,y7,x7,S7,A7,C7,b7,T7,E7,w7,P7,I7,R7,D7,B7,M7,O7=new oi,N7=new oi,L7=new oi,F7=new li,z7=new Li,V7=new li;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(M7||(M7={})),$t(M7);var G7,U7,k7,H7,j7,W7,q7,X7,Y7,K7,J7,Q7,Z7,$7,t9,e9,n9,i9,r9,o9,a9,s9,c9,l9,u9,h9,_9,f9,p9,d9,m9,v9,g9,y9,x9,S9,A9,C9,b9,T9,E9,w9,P9,I9,R9,D9,B9,M9,O9,N9=t("ScrollBar",(l7=qc("cc.ScrollBar"),u7=cl(),h7=Yc(110),_7=rl(),f7=Xc($Y),p7=El(I$),d7=yl(),m7=fl(),v7=El(M7),g7=yl(),y7=fl(),x7=yl(),S7=fl(),A7=yl(),C7=fl(),l7(b7=u7(b7=h7(b7=_7(b7=f7((B7=D7=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_scrollView",E7,H(e)),q(e,"_handle",w7,H(e)),q(e,"_direction",P7,H(e)),q(e,"_enableAutoHide",I7,H(e)),q(e,"_autoHideTime",R7,H(e)),e._touching=!1,e._opacity=255,e._autoHideRemainingTime=0,e}F(e,t);var n=e.prototype;return n.hide=function(){this._autoHideRemainingTime=0,this._setOpacity(0)},n.show=function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)},n.onScroll=function(t){if(this._scrollView){var e=this._scrollView.content;if(e){var n=e._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(!this._conditionalDisableScrollBar(n,i)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var o=0,a=0,s=0,c=0,l=0,u=V7;u.set(0,0),this._direction===M7.HORIZONTAL?(o=n.width,a=i.width,l=r.width,s=t.x,this._convertToScrollViewSpace(u,e),c=-u.x):this._direction===M7.VERTICAL&&(o=n.height,a=i.height,l=r.height,s=t.y,this._convertToScrollViewSpace(u,e),c=-u.y);var h=this._calculateLength(o,a,l,s),_=V7;this._calculatePosition(_,o,a,l,c,s,h),this._updateLength(h),this._updateHandlerPosition(_)}}}},n.setScrollView=function(t){this._scrollView=t},n.onTouchBegan=function(){this._enableAutoHide&&(this._touching=!0)},n.onTouchEnded=function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var t=this._scrollView.content;if(t){var e=t._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(e,n))return}}this._autoHideRemainingTime=this._autoHideTime}},n.onEnable=function(){var t=this.node.getComponent(I$);t&&(this._opacity=t.color.a)},n.start=function(){this._enableAutoHide&&this._setOpacity(0)},n.update=function(t){this._processAutoHide(t)},n._convertToScrollViewSpace=function(t,e){var n=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,i=e._uiProps.uiTransformComp;if(n&&i){O7.set(-i.anchorX*i.width,-i.anchorY*i.height,0),i.convertToWorldSpaceAR(O7,N7);var r=n.convertToNodeSpaceAR(N7);r.x+=n.anchorX*n.width,r.y+=n.anchorY*n.height,t.set(r.x,r.y)}else t.set(li.ZERO)},n._setOpacity=function(t){if(this._handle){var e=this.node.getComponent(I$);e&&(z7.set(e.color),z7.a=t,e.color=z7),(e=this._handle.getComponent(I$))&&(z7.set(e.color),z7.a=t,e.color=z7)}},n._updateHandlerPosition=function(t){if(this._handle){var e=L7;this._fixupHandlerPosition(e),this._handle.node.setPosition(t.x+e.x,t.y+e.y,e.z)}},n._fixupHandlerPosition=function(t){var e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint,r=this.handle.node._uiProps.uiTransformComp.contentSize,o=this.handle.node.parent;oi.set(O7,-n.width*i.x,-n.height*i.y,0);var a=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(O7,N7),s=t;s.set(0,0,0),o._uiProps.uiTransformComp.convertToNodeSpaceAR(a,s),this.direction===M7.HORIZONTAL?s.set(s.x,s.y+(n.height-r.height)/2,s.z):this.direction===M7.VERTICAL&&s.set(s.x+(n.width-r.width)/2,s.y,s.z),this.handle.node.setPosition(s)},n._conditionalDisableScrollBar=function(t,e){return t.width<=e.width&&this._direction===M7.HORIZONTAL||t.height<=e.height&&this._direction===M7.VERTICAL},n._calculateLength=function(t,e,n,i){var r=t;return i&&(r+=20*(i>0?i:-i)),n*(e/r)},n._calculatePosition=function(t,e,n,i,r,o,a){var s=e-n;o&&(s+=Math.abs(o));var c=0;s&&(c=kn(c=r/s));var l=(i-a)*c;this._direction===M7.VERTICAL?t.set(0,l):t.set(l,0)},n._updateLength=function(t){if(this._handle){var e=this._handle.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint;i.x===F7.x&&i.y===F7.y||e.setAnchorPoint(F7),this._direction===M7.HORIZONTAL?e.setContentSize(t,n.height):e.setContentSize(n.width,t)}},n._processAutoHide=function(t){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=t,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var e=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(e)}},N(e,[{key:"handle",get:function(){return this._handle},set:function(t){this._handle!==t&&(this._handle=t,this.onScroll(li.ZERO))}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t,this.onScroll(li.ZERO))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(t){this._enableAutoHide!==t&&(this._enableAutoHide=t,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(t){this._autoHideTime!==t&&(this._autoHideTime=t)}}]),e}(ku),D7.Direction=M7,X((T7=B7).prototype,"handle",[p7,d7,m7],Object.getOwnPropertyDescriptor(T7.prototype,"handle"),T7.prototype),X(T7.prototype,"direction",[v7,g7,y7],Object.getOwnPropertyDescriptor(T7.prototype,"direction"),T7.prototype),X(T7.prototype,"enableAutoHide",[x7,S7],Object.getOwnPropertyDescriptor(T7.prototype,"enableAutoHide"),T7.prototype),X(T7.prototype,"autoHideTime",[A7,C7],Object.getOwnPropertyDescriptor(T7.prototype,"autoHideTime"),T7.prototype),E7=X(T7.prototype,"_scrollView",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),w7=X(T7.prototype,"_handle",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),P7=X(T7.prototype,"_direction",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return M7.HORIZONTAL}}),I7=X(T7.prototype,"_enableAutoHide",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),R7=X(T7.prototype,"_autoHideTime",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),b7=T7))||b7)||b7)||b7)||b7)||b7)),L9=t("ViewGroup",qc("cc.ViewGroup")(G7=Yc(110)(G7=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e}(ku))||G7)||G7);i.ViewGroup=L9;var F9,z9=1e-4,V9=new oi,G9=new oi,U9=new li,k9=new li,H9=function(){return(new Date).getMilliseconds()},j9={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(t){t.SCROLL_TO_TOP="scroll-to-top",t.SCROLL_TO_BOTTOM="scroll-to-bottom",t.SCROLL_TO_LEFT="scroll-to-left",t.SCROLL_TO_RIGHT="scroll-to-right",t.SCROLL_BEGAN="scroll-began",t.SCROLL_ENDED="scroll-ended",t.BOUNCE_TOP="bounce-top",t.BOUNCE_BOTTOM="bounce-bottom",t.BOUNCE_LEFT="bounce-left",t.BOUNCE_RIGHT="bounce-right",t.SCROLLING="scrolling",t.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",t.TOUCH_UP="touch-up"}(F9||(F9={}));var W9,q9,X9,Y9,K9,J9,Q9,Z9,$9,ttt,ett,ntt,itt,rtt,ott,att,stt,ctt,ltt,utt,htt,_tt,ftt,ptt,dtt,mtt,vtt,gtt,ytt,xtt,Stt,Att,Ctt,btt,Ttt,Ett,wtt,Ptt,Itt,Rtt,Dtt,Btt,Mtt=t("ScrollView",(U7=qc("cc.ScrollView"),k7=cl(),H7=Yc(110),j7=rl(),W7=Xc($Y),q7=pl(),X7=yl(),Y7=fl(),K7=pl(),J7=yl(),Q7=fl(),Z7=yl(),$7=fl(),t9=yl(),e9=fl(),n9=El(BT),i9=yl(),r9=fl(),o9=yl(),a9=fl(),s9=El(N9),c9=yl(),l9=fl(),u9=yl(),h9=fl(),_9=El(N9),f9=yl(),p9=fl(),d9=yl(),m9=fl(),v9=El([hL]),g9=yl(),y9=fl(),U7(x9=k7(x9=H7(x9=j7(x9=W7((O9=M9=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"bounceDuration",A9,H(e)),q(e,"brake",C9,H(e)),q(e,"elastic",b9,H(e)),q(e,"inertia",T9,H(e)),q(e,"horizontal",E9,H(e)),q(e,"vertical",w9,H(e)),q(e,"cancelInnerEvents",P9,H(e)),q(e,"scrollEvents",I9,H(e)),e._autoScrolling=!1,e._scrolling=!1,q(e,"_content",R9,H(e)),q(e,"_horizontalScrollBar",D9,H(e)),q(e,"_verticalScrollBar",B9,H(e)),e._topBoundary=0,e._bottomBoundary=0,e._leftBoundary=0,e._rightBoundary=0,e._touchMoveDisplacements=[],e._touchMoveTimeDeltas=[],e._touchMovePreviousTimestamp=0,e._touchMoved=!1,e._autoScrollAttenuate=!1,e._autoScrollStartPosition=new oi,e._autoScrollTargetDelta=new oi,e._autoScrollTotalTime=0,e._autoScrollAccumulatedTime=0,e._autoScrollCurrentlyOutOfBoundary=!1,e._autoScrollBraking=!1,e._autoScrollBrakingStartPosition=new oi,e._outOfBoundaryAmount=new oi,e._outOfBoundaryAmountDirty=!0,e._stopMouseWheel=!1,e._mouseWheelEventElapsedTime=0,e._isScrollEndedWithThresholdEventFired=!1,e._scrollEventEmitMask=0,e._isBouncing=!1,e._contentPos=new oi,e._deltaPos=new oi,e}F(e,t);var n=e.prototype;return n.scrollToBottom=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new li(0,0),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n,!0)},n.scrollToTop=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new li(0,1),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToLeft=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new li(0,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToRight=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new li(1,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToTopLeft=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new li(0,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToTopRight=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new li(1,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToBottomLeft=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new li(0,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToBottomRight=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new li(1,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToOffset=function(t,e,n){void 0===n&&(n=!0);var i=this.getMaxScrollOffset(),r=new li(0,0);0===i.x?r.x=0:r.x=t.x/i.x,0===i.y?r.y=1:r.y=(i.y-t.y)/i.y,this.scrollTo(r,e,n)},n.getScrollOffset=function(){var t=this._getContentTopBoundary()-this._topBoundary,e=this._getContentLeftBoundary()-this._leftBoundary;return new li(e,t)},n.getMaxScrollOffset=function(){if(!this._content||!this.view)return li.ZERO;var t=this._content._uiProps.uiTransformComp.contentSize,e=t.width-this.view.width,n=t.height-this.view.height;return new li(e=e>=0?e:0,n=n>=0?n:0)},n.scrollToPercentHorizontal=function(t,e,n){var i=this._calculateMovePercentDelta({anchor:new li(t,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==n):this._moveContent(i)},n.scrollTo=function(t,e,n){var i=this._calculateMovePercentDelta({anchor:new li(t),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,n):this._moveContent(i)},n.scrollToPercentVertical=function(t,e,n){var i=this._calculateMovePercentDelta({anchor:new li(0,t),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,n):this._moveContent(i)},n.stopAutoScroll=function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime},n.setContentPosition=function(t){this._setContentPosition(t)},n._setContentPosition=function(t){if(this._content){var e=this._getContentPosition();Math.abs(t.x-e.x)<z9&&Math.abs(t.y-e.y)<z9||(this._content.setPosition(t),this._outOfBoundaryAmountDirty=!0)}},n.getContentPosition=function(){return this._getContentPosition()},n._getContentPosition=function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):oi.ZERO.clone()},n.isScrolling=function(){return this._scrolling},n.isAutoScrolling=function(){return this._autoScrolling},n.getScrollEndedEventTiming=function(){return z9},n.start=function(){this._calculateBoundary(),this._content&&LM.once(NM.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)},n.onEnable=function(){this._registerEvent(),this._content&&(this._content.on(RC.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(RC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(RC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(RC.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()},n.update=function(t){this._autoScrolling&&this._processAutoScrolling(t)},n.onDisable=function(){this._unregisterEvent(),this._content&&(this._content.off(RC.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(RC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(RC.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(RC.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()},n._registerEvent=function(){this.node.on(RC.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(RC.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(RC.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(RC.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(RC.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._unregisterEvent=function(){this.node.off(RC.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(RC.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(RC.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(RC.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(RC.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._onMouseWheel=function(t,e){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(t,e)){var n=new oi,i=t.getScrollY();this.vertical?n.set(0,-.1*i,0):this.horizontal&&n.set(-.1*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(n),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(t)}},n._onTouchBegan=function(t,e){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(t,e)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(t)))},n._onTouchMoved=function(t,e){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(t,e)){var n=t.touch;if(this._handleMoveLogic(n),this.cancelInnerEvents){var i=n.getUILocation(U9);if(i.subtract(n.getUIStartLocation(k9)),i.length()>7&&!this._touchMoved&&t.target!==this.node){var r=new YB(t.getTouches(),t.bubbles,EE.TOUCH_CANCEL);r.touch=t.touch,r.simulate=!0,t.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(t)}}},n._onTouchEnded=function(t,e){if(this.enabledInHierarchy&&this._content&&t&&!this._hasNestedViewGroup(t,e)){this._dispatchEvent(F9.TOUCH_UP);var n=t.touch;this._handleReleaseLogic(n),this._touchMoved?t.propagationStopped=!0:this._stopPropagationIfTargetIsMe(t)}},n._onTouchCancelled=function(t,e){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(t,e)){if(t&&!t.simulate){var n=t.touch;this._handleReleaseLogic(n)}this._stopPropagationIfTargetIsMe(t)}},n._calculateBoundary=function(){if(this._content&&this.view){var t=this._content.getComponent(c7);t&&t.enabledInHierarchy&&t.updateLayout();var e=this.view,n=e.width*e.anchorX,i=e.height*e.anchorY;this._leftBoundary=-n,this._bottomBoundary=-i,this._rightBoundary=this._leftBoundary+e.width,this._topBoundary=this._bottomBoundary+e.height,this._moveContentToTopLeft(e.contentSize)}},n._hasNestedViewGroup=function(t,e){if(!t||t.eventPhase!==HB.CAPTURING_PHASE)return!1;if(e)for(var n,i=W(e);!(n=i()).done;){var r=n.value;if(this.node===r)return!(!t.target||!t.target.getComponent(L9));if(r.getComponent(L9))return!0}return!1},n._startInertiaScroll=function(t){var e=new oi(t);e.multiplyScalar(.7),this._startAttenuatingAutoScroll(e,t)},n._calculateAttenuatedFactor=function(t){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*t+t*t*8e-9))},n._startAttenuatingAutoScroll=function(t,e){var n=t.clone();if(n.normalize(),this._content&&this.view){var i=this._content._uiProps.uiTransformComp.contentSize,r=this.view.contentSize,o=i.width-r.width,a=i.height-r.height,s=this._calculateAttenuatedFactor(o),c=this._calculateAttenuatedFactor(a);n.x=n.x*o*(1-this.brake)*s,n.y=n.y*a*c*(1-this.brake),n.z=0}var l=t.length(),u=n.length()/l;if(n.add(t),this.brake>0&&u>7){u=Math.sqrt(u);var h=t.clone();h.multiplyScalar(u),n.set(h),n.add(t)}var _=this._calculateAutoScrollTimeByInitialSpeed(e.length());this.brake>0&&u>3&&(_*=u=3),0===this.brake&&u>1&&(_*=u),this._startAutoScroll(n,_,!0)},n._calculateAutoScrollTimeByInitialSpeed=function(t){return Math.sqrt(Math.sqrt(t/5))},n._startAutoScroll=function(t,e,n){void 0===n&&(n=!1);var i=this._flattenVectorByDirection(t);this._autoScrolling=!0,this._autoScrollTargetDelta=i,this._autoScrollAttenuate=n,oi.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=e,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(oi.ZERO,z9)||(this._autoScrollCurrentlyOutOfBoundary=!0)},n._calculateTouchMoveVelocity=function(){var t=new oi,e=0;if((e=this._touchMoveTimeDeltas.reduce((function(t,e){return t+e}),e))<=0||e>=.5)t.set(oi.ZERO);else{var n=new oi;n=this._touchMoveDisplacements.reduce((function(t,e){return t.add(e),t}),n),t.set(n.x*(1-this.brake)/e,n.y*(1-this.brake)/e,n.z)}return t},n._flattenVectorByDirection=function(t){var e=t;return e.x=this.horizontal?e.x:0,e.y=this.vertical?e.y:0,e},n._moveContent=function(t,e){var n=this._flattenVectorByDirection(t);V9.set(this._getContentPosition()),V9.add(n),V9.set(Math.round(1e4*V9.x)*z9,Math.round(1e4*V9.y)*z9,V9.z),this._setContentPosition(V9);var i=this._getHowMuchOutOfBoundary();U9.set(i.x,i.y),this._updateScrollBar(U9),this.elastic&&e&&this._startBounceBackIfNeeded()},n._getContentLeftBoundary=function(){if(!this._content)return-1;var t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.x-e.anchorX*e.width},n._getContentRightBoundary=function(){if(!this._content)return-1;var t=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+t.width},n._getContentTopBoundary=function(){if(!this._content)return-1;var t=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+t.height},n._getContentBottomBoundary=function(){if(!this._content)return-1;var t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.y-e.anchorY*e.height},n._getHowMuchOutOfBoundary=function(t){if((t=t||new oi).equals(oi.ZERO,z9)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var e=new oi,n=this._getContentLeftBoundary(),i=this._getContentRightBoundary();n+t.x>this._leftBoundary?e.x=this._leftBoundary-(n+t.x):i+t.x<this._rightBoundary&&(e.x=this._rightBoundary-(i+t.x));var r=this._getContentTopBoundary(),o=this._getContentBottomBoundary();return r+t.y<this._topBoundary?e.y=this._topBoundary-(r+t.y):o+t.y>this._bottomBoundary&&(e.y=this._bottomBoundary-(o+t.y)),t.equals(oi.ZERO,z9)&&(this._outOfBoundaryAmount=e,this._outOfBoundaryAmountDirty=!1),this._clampDelta(e),e},n._updateScrollBar=function(t){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(t),this.verticalScrollBar&&this.verticalScrollBar.onScroll(t)},n._onScrollBarTouchBegan=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()},n._onScrollBarTouchEnded=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()},n._dispatchEvent=function(t){if(t===F9.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(t===F9.SCROLL_TO_TOP||t===F9.SCROLL_TO_BOTTOM||t===F9.SCROLL_TO_LEFT||t===F9.SCROLL_TO_RIGHT){var e=1<<j9[t];if(this._scrollEventEmitMask&e)return;this._scrollEventEmitMask|=e}hL.emitEvents(this.scrollEvents,this,j9[t]),this.node.emit(t,this)},n._adjustContentOutOfBoundary=function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var t=this._getHowMuchOutOfBoundary();V9.set(this._getContentPosition()),V9.add(t),this._content.setPosition(V9),this._updateScrollBar(li.ZERO)}},n._hideScrollBar=function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()},n._updateScrollBarState=function(){if(this._content&&this.view){var t=this.view,e=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(e.height<t.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(e.width<t.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}},n._stopPropagationIfTargetIsMe=function(t){t.eventPhase===HB.AT_TARGET&&t.target===this.node&&(t.propagationStopped=!0)},n._processDeltaMove=function(t){this._scrollChildren(t),this._gatherTouchMove(t)},n._handleMoveLogic=function(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._processDeltaMove(this._deltaPos)},n._handleReleaseLogic=function(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(F9.SCROLL_ENDED))},n._getLocalAxisAlignDelta=function(t,e){var n=this.node._uiProps.uiTransformComp,i=new oi;n&&(e.getUILocation(U9),e.getUIPreviousLocation(k9),V9.set(U9.x,U9.y,0),G9.set(k9.x,k9.y,0),n.convertToNodeSpaceAR(V9,V9),n.convertToNodeSpaceAR(G9,G9),oi.subtract(i,V9,G9)),t.set(i)},n._scrollChildren=function(t){this._clampDelta(t);var e,n=t;this.elastic&&(e=this._getHowMuchOutOfBoundary(),n.x*=0===e.x?1:.5,n.y*=0===e.y?1:.5),this.elastic||(e=this._getHowMuchOutOfBoundary(n),n.add(e));var i="",r="";if(this._content){var o=this._content._uiProps.uiTransformComp,a=o.anchorX,s=o.anchorY,c=o.width,l=o.height,u=this._content.position||oi.ZERO;this.vertical&&(n.y>0?u.y-s*l+n.y>=this._bottomBoundary&&(i=F9.SCROLL_TO_BOTTOM):n.y<0&&u.y-s*l+l+n.y<=this._topBoundary&&(i=F9.SCROLL_TO_TOP)),this.horizontal&&(n.x<0?u.x-a*c+c+n.x<=this._rightBoundary&&(r=F9.SCROLL_TO_RIGHT):n.x>0&&u.x-a*c+n.x>=this._leftBoundary&&(r=F9.SCROLL_TO_LEFT))}this._moveContent(n,!1),(this.horizontal&&0!==n.x||this.vertical&&0!==n.y)&&(this._scrolling||(this._scrolling=!0,this._dispatchEvent(F9.SCROLL_BEGAN)),this._dispatchEvent(F9.SCROLLING)),""!==i&&this._dispatchEvent(i),""!==r&&this._dispatchEvent(r)},n._handlePressLogic=function(){this._autoScrolling&&this._dispatchEvent(F9.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=H9(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()},n._clampDelta=function(t){if(this._content&&this.view){var e=this.view.contentSize,n=this._content._uiProps.uiTransformComp;n.width<e.width&&(t.x=0),n.height<e.height&&(t.y=0)}},n._gatherTouchMove=function(t){var e=t.clone();for(this._clampDelta(e);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(e);var n=H9();this._touchMoveTimeDeltas.push((n-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=n},n._startBounceBackIfNeeded=function(){if(!this.elastic)return!1;var t=this._getHowMuchOutOfBoundary();if(this._clampDelta(t),t.equals(oi.ZERO,z9))return!1;var e=Math.max(this.bounceDuration,0);return this._startAutoScroll(t,e,!0),this._isBouncing||(t.y>0&&this._dispatchEvent(F9.BOUNCE_TOP),t.y<0&&this._dispatchEvent(F9.BOUNCE_BOTTOM),t.x>0&&this._dispatchEvent(F9.BOUNCE_RIGHT),t.x<0&&this._dispatchEvent(F9.BOUNCE_LEFT),this._isBouncing=!0),!0},n._processInertiaScroll=function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var t=this._calculateTouchMoveVelocity();!t.equals(V9,z9)&&this.brake<1&&this._startInertiaScroll(t)}this._onScrollBarTouchEnded()},n._isOutOfBoundary=function(){return!this._getHowMuchOutOfBoundary().equals(oi.ZERO,z9)},n._isNecessaryAutoScrollBrake=function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this._getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1},n._processAutoScrolling=function(t){var e=this._isNecessaryAutoScrollBrake(),n=e?.05:1;this._autoScrollAccumulatedTime+=t*(1/n);var i,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(i=r,r=(i-=1)*i*i*i*i+1);var o=this._autoScrollTargetDelta.clone();o.multiplyScalar(r);var a=this._autoScrollStartPosition.clone();a.add(o);var s=Math.abs(r-1)<=z9;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(F9.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var c=a.clone();c.subtract(this._autoScrollBrakingStartPosition),e&&c.multiplyScalar(n),a.set(this._autoScrollBrakingStartPosition),a.add(c)}else{var l=a.clone();l.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(l);u.equals(oi.ZERO,z9)||(a.add(u),s=!0)}s&&(this._autoScrolling=!1);var h=a.clone();h.subtract(this._getContentPosition()),this._clampDelta(h),this._moveContent(h,s),this._dispatchEvent(F9.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(F9.SCROLL_ENDED))},n._checkMouseWheel=function(t){if(!this._getHowMuchOutOfBoundary().equals(oi.ZERO,z9))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(F9.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=t,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(F9.SCROLL_ENDED),this._stopMouseWheel=!1)},n._calculateMovePercentDelta=function(t){var e=t.anchor,n=t.applyToHorizontal,i=t.applyToVertical;this._calculateBoundary(),e.clampf(li.ZERO,li.ONE);var r=this._getContentBottomBoundary()-this._bottomBoundary;r=-r;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var a=new oi;if(this._content&&this.view){var s=0,c=this._content._uiProps.uiTransformComp.contentSize,l=this.view.contentSize;n&&(s=c.width-l.width,a.x=o-s*e.x),i&&(s=c.height-l.height,a.y=r-s*e.y)}return a},n._moveContentToTopLeft=function(t){var e=this._getContentBottomBoundary()-this._bottomBoundary;e=-e;var n=new oi,i=0,r=this._getContentLeftBoundary()-this._leftBoundary;if(r=-r,this._content){var o=this._content._uiProps.uiTransformComp.contentSize;o.height<t.height&&(i=o.height-t.height,n.y=e-i),o.width<t.width&&(i=o.width-t.width,n.x=r)}this._updateScrollBarState(),this._moveContent(n),this._adjustContentOutOfBoundary()},n._scaleChanged=function(t){t===Nd.SCALE&&this._calculateBoundary()},N(e,[{key:"content",get:function(){return this._content},set:function(t){if(this._content!==t){var e=t&&t.parent&&t.parent._uiProps.uiTransformComp;!t||t&&e?(this._content=t,this._calculateBoundary()):A(4302)}}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(t){this._horizontalScrollBar!==t&&(this._horizontalScrollBar=t,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(li.ZERO)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(t){this._verticalScrollBar!==t&&(this._verticalScrollBar=t,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(li.ZERO)))}},{key:"view",get:function(){var t=this._content&&this._content.parent;return t?t._uiProps.uiTransformComp:null}}]),e}(L9),M9.EventType=F9,A9=X((S9=O9).prototype,"bounceDuration",[Zc,q7,X7,Y7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),C9=X(S9.prototype,"brake",[Zc,K7,J7,Q7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),b9=X(S9.prototype,"elastic",[Zc,Z7,$7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),T9=X(S9.prototype,"inertia",[Zc,t9,e9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X(S9.prototype,"content",[n9,i9,r9],Object.getOwnPropertyDescriptor(S9.prototype,"content"),S9.prototype),E9=X(S9.prototype,"horizontal",[Zc,o9,a9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X(S9.prototype,"horizontalScrollBar",[s9,c9,l9],Object.getOwnPropertyDescriptor(S9.prototype,"horizontalScrollBar"),S9.prototype),w9=X(S9.prototype,"vertical",[Zc,u9,h9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X(S9.prototype,"verticalScrollBar",[_9,f9,p9],Object.getOwnPropertyDescriptor(S9.prototype,"verticalScrollBar"),S9.prototype),P9=X(S9.prototype,"cancelInnerEvents",[Zc,d9,m9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),I9=X(S9.prototype,"scrollEvents",[v9,Zc,g9,y9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),R9=X(S9.prototype,"_content",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D9=X(S9.prototype,"_horizontalScrollBar",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),B9=X(S9.prototype,"_verticalScrollBar",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x9=S9))||x9)||x9)||x9)||x9)||x9)),Ott=new oi;function Ntt(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return Object.assign.apply(Object,[{}].concat(e))}!function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(_tt||(_tt={})),$t(_tt),t("Slider",(W9=qc("cc.Slider"),q9=cl(),X9=Yc(110),Y9=rl(),K9=Xc($Y),J9=El(I$),Q9=fl(),Z9=El(_tt),$9=fl(),ttt=pl(),ett=fl(),ntt=El([hL]),itt=fl(),W9(rtt=q9(rtt=X9(rtt=Y9(rtt=K9((htt=utt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"slideEvents",att,H(e)),q(e,"_handle",stt,H(e)),q(e,"_direction",ctt,H(e)),q(e,"_progress",ltt,H(e)),e._offset=new oi,e._dragging=!1,e._touchHandle=!1,e._handleLocalPos=new oi,e._touchPos=new oi,e}F(e,t);var n=e.prototype;return n.__preload=function(){this._updateHandlePosition()},n.onEnable=function(){this._updateHandlePosition(),this.node.on(RC.TOUCH_START,this._onTouchBegan,this),this.node.on(RC.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(RC.TOUCH_END,this._onTouchEnded,this),this.node.on(RC.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(RC.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(RC.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(RC.TOUCH_END,this._onTouchEnded,this))},n.onDisable=function(){this.node.off(RC.TOUCH_START,this._onTouchBegan,this),this.node.off(RC.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(RC.TOUCH_END,this._onTouchEnded,this),this.node.off(RC.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(RC.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(RC.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(RC.TOUCH_END,this._onTouchEnded,this))},n._onHandleDragStart=function(t){if(t&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var e=t.touch.getUILocation();oi.set(this._touchPos,e.x,e.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),t.propagationStopped=!0}},n._onTouchBegan=function(t){this._handle&&t&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(t.touch),t.propagationStopped=!0)},n._onTouchMoved=function(t){this._dragging&&t&&(this._handleSliderLogic(t.touch),t.propagationStopped=!0)},n._onTouchEnded=function(t){this._dragging=!1,this._touchHandle=!1,this._offset=new oi,t&&(t.propagationStopped=!0)},n._onTouchCancelled=function(t){this._dragging=!1,t&&(t.propagationStopped=!0)},n._handleSliderLogic=function(t){this._updateProgress(t),this._emitSlideEvent()},n._emitSlideEvent=function(){hL.emitEvents(this.slideEvents,this),this.node.emit("slide",this)},n._updateProgress=function(t){if(this._handle&&t){var e=t.getUILocation();oi.set(this._touchPos,e.x,e.y,0);var n=this.node._uiProps.uiTransformComp,i=n.convertToNodeSpaceAR(this._touchPos,Ott);this.direction===_tt.Horizontal?this.progress=kn(.5+(i.x-this._offset.x)/n.width):this.progress=kn(.5+(i.y-this._offset.y)/n.height)}},n._updateHandlePosition=function(){if(this._handle){this._handleLocalPos.set(this._handle.node.getPosition());var t=this.node._uiProps.uiTransformComp;this._direction===_tt.Horizontal?this._handleLocalPos.x=-t.width*t.anchorX+this.progress*t.width:this._handleLocalPos.y=-t.height*t.anchorY+this.progress*t.height,this._handle.node.setPosition(this._handleLocalPos)}},n._changeLayout=function(){var t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(t.setContentSize(e.height,e.width),this._handle){var n=this._handle.node.position;this._direction===_tt.Horizontal?this._handle.node.setPosition(n.x,0,n.z):this._handle.node.setPosition(0,n.y,n.z),this._updateHandlePosition()}},N(e,[{key:"handle",get:function(){return this._handle},set:function(t){this._handle!==t&&(this._handle=t)}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(t){this._progress!==t&&(this._progress=t,this._updateHandlePosition())}}]),e}(ku),utt.Direction=_tt,X((ott=htt).prototype,"handle",[J9,Q9],Object.getOwnPropertyDescriptor(ott.prototype,"handle"),ott.prototype),X(ott.prototype,"direction",[Z9,$9],Object.getOwnPropertyDescriptor(ott.prototype,"direction"),ott.prototype),X(ott.prototype,"progress",[gl,ttt,ett],Object.getOwnPropertyDescriptor(ott.prototype,"progress"),ott.prototype),att=X(ott.prototype,"slideEvents",[ntt,Zc,itt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),stt=X(ott.prototype,"_handle",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ctt=X(ott.prototype,"_direction",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _tt.Horizontal}}),ltt=X(ott.prototype,"_progress",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),rtt=ott))||rtt)||rtt)||rtt)||rtt)||rtt)),function(t){t.TOGGLE="toggle"}(Btt||(Btt={})),t("Toggle",(ftt=qc("cc.Toggle"),ptt=cl(),dtt=Yc(110),mtt=rl(),vtt=Xc($Y),gtt=yl(),ytt=fl(),xtt=El(I$),Stt=yl(),Att=fl(),Ctt=El([hL]),btt=fl(),ftt(Ttt=ptt(Ttt=dtt(Ttt=mtt(Ttt=vtt((Dtt=Rtt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"checkEvents",wtt,H(e)),q(e,"_isChecked",Ptt,H(e)),q(e,"_checkMark",Itt,H(e)),e}F(e,t);var n=e.prototype;return n._internalToggle=function(){this.isChecked=!this.isChecked},n._set=function(t,e){if(void 0===e&&(e=!0),this._isChecked!=t){this._isChecked=t;var n=this._toggleContainer;n&&n.enabled&&this.enabled&&(t||!n.anyTogglesChecked()&&!n.allowSwitchOff)&&(this._isChecked=!0,n.notifyToggleCheck(this,e)),this.playEffect(),e&&this._emitToggleEvents()}},n.playEffect=function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)},n.setIsCheckedWithoutNotify=function(t){this._set(t,!1)},n.onEnable=function(){t.prototype.onEnable.call(this),this.playEffect(),this.node.on(e.EventType.CLICK,this._internalToggle,this)},n.onDisable=function(){t.prototype.onDisable.call(this),this.node.off(e.EventType.CLICK,this._internalToggle,this)},n.OnDestroy=function(){var t=this._toggleContainer;t&&t.ensureValidState()},n._emitToggleEvents=function(){this.node.emit(e.EventType.TOGGLE,this),this.checkEvents&&hL.emitEvents(this.checkEvents,this)},N(e,[{key:"isChecked",get:function(){return this._isChecked},set:function(t){this._set(t)}},{key:"checkMark",get:function(){return this._checkMark},set:function(t){this._checkMark!==t&&(this._checkMark=t)}},{key:"_resizeToTarget",set:function(t){t&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var t=this.node.parent;return i.Node.isNode(t)?t.getComponent("cc.ToggleContainer"):null}}]),e}(d5),Rtt.EventType=Ntt(Btt,u5),X((Ett=Dtt).prototype,"isChecked",[gtt,ytt],Object.getOwnPropertyDescriptor(Ett.prototype,"isChecked"),Ett.prototype),X(Ett.prototype,"checkMark",[xtt,Stt,Att],Object.getOwnPropertyDescriptor(Ett.prototype,"checkMark"),Ett.prototype),wtt=X(Ett.prototype,"checkEvents",[Ctt,Zc,btt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ptt=X(Ett.prototype,"_isChecked",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Itt=X(Ett.prototype,"_checkMark",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ttt=Ett))||Ttt)||Ttt)||Ttt)||Ttt)||Ttt)),t("ToggleContainer",(Ltt=qc("cc.ToggleContainer"),Ftt=cl(),ztt=Yc(110),Vtt=rl(),Gtt=fl(),Utt=El([hL]),ktt=fl(),Ltt(Htt=Ftt(Htt=ztt(Htt=Vtt(Htt=il((Xtt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_allowSwitchOff",Wtt,H(e)),q(e,"checkEvents",qtt,H(e)),e}F(e,t);var n=e.prototype;return n.onEnable=function(){this.ensureValidState(),this.node.on(RC.CHILD_ADDED,this.ensureValidState,this),this.node.on(RC.CHILD_REMOVED,this.ensureValidState,this)},n.onDisable=function(){this.node.off(RC.CHILD_ADDED,this.ensureValidState,this),this.node.off(RC.CHILD_REMOVED,this.ensureValidState,this)},n.activeToggles=function(){return this.toggleItems.filter((function(t){return t.isChecked}))},n.anyTogglesChecked=function(){return!!this.toggleItems.find((function(t){return t.isChecked}))},n.notifyToggleCheck=function(t,e){if(void 0===e&&(e=!0),this.enabledInHierarchy){for(var n=0;n<this.toggleItems.length;n++){var r=this.toggleItems[n];r!==t&&(e?r.isChecked=!1:r.setIsCheckedWithoutNotify(!1))}this.checkEvents&&i.Component.EventHandler.emitEvents(this.checkEvents,t)}},n.ensureValidState=function(){var t=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==t.length){var e=t[0];e.isChecked=!0,this.notifyToggleCheck(e)}var n=this.activeToggles();if(n.length>1)for(var i=n[0],r=0;r<n.length;++r){var o=n[r];o!==i&&(o.isChecked=!1)}},N(e,[{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(t){this._allowSwitchOff=t}},{key:"toggleItems",get:function(){return this.node.children.map((function(t){var e=t.getComponent("cc.Toggle");return e&&e.enabled?e:null})).filter(Boolean)}}]),e}(ku),Wtt=X((jtt=Xtt).prototype,"_allowSwitchOff",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(jtt.prototype,"allowSwitchOff",[Gtt],Object.getOwnPropertyDescriptor(jtt.prototype,"allowSwitchOff"),jtt.prototype),qtt=X(jtt.prototype,"checkEvents",[Utt,Zc,ktt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Htt=jtt))||Htt)||Htt)||Htt)||Htt)||Htt));var Ltt,Ftt,ztt,Vtt,Gtt,Utt,ktt,Htt,jtt,Wtt,qtt,Xtt,Ytt,Ktt,Jtt,Qtt,Ztt,$tt,tet,eet,net,iet,ret,oet,aet,set,cet,uet,het,_et,fet,pet,det,met,vet,get,yet,xet,Aet,Cet,bet,Tet,Eet,wet,Pet,Iet,Ret,Det,Bet,Met,Oet,Net,Let,Fet,zet,Vet,Get,Uet,ket,Het=new li;function jet(t){return t instanceof OR?kB:t._uiProps.uiTransformComp?t._uiProps.uiTransformComp.contentSize:Di.ZERO}function Wet(t,e,n,i){t.parent?Het.set(t.parent.getScale().x,t.parent.getScale().y):Het.set(0,0);for(var r=Het.x,o=Het.y,a=0,s=0,c=t.parent;;){if(!c)return n.x=n.y=0,void(i.x=i.y=1);var l=c.getPosition();if(a+=l.x,s+=l.y,(c=c.parent)===e)break;c?Het.set(c.getScale().x,c.getScale().y):Het.set(0,0);var u=Het.x,h=Het.y;a*=u,s*=h,r*=u,o*=h}i.x=0!==r?1/r:1,i.y=0!==o?1/o:1,n.x=-a,n.y=-s}!function(t){t[t.ONCE=0]="ONCE",t[t.ALWAYS=1]="ALWAYS",t[t.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(Uet||(Uet={})),$t(Uet),function(t){t[t.TOP=1]="TOP",t[t.MID=2]="MID",t[t.BOT=4]="BOT",t[t.LEFT=8]="LEFT",t[t.CENTER=16]="CENTER",t[t.RIGHT=32]="RIGHT",t[t.HORIZONTAL=56]="HORIZONTAL",t[t.VERTICAL=7]="VERTICAL"}(ket||(ket={}));var qet,Xet,Yet,Ket,Jet,Qet,Zet,$et,tnt,ent,nnt,int,rnt,ont,ant,snt,cnt,lnt,unt,hnt=ket.TOP|ket.BOT,_nt=ket.LEFT|ket.RIGHT,fnt=t("Widget",(Ytt=qc("cc.Widget"),Ktt=cl(),Jtt=Yc(110),Qtt=rl(),Ztt=Xc($Y),$tt=El(BT),tet=fl(),eet=fl(),net=fl(),iet=fl(),ret=fl(),oet=fl(),aet=fl(),set=ul(),cet=ul(),uet=fl(),het=fl(),_et=fl(),fet=fl(),pet=fl(),det=fl(),met=El(Uet),vet=fl(),Ytt(get=Ktt(get=Jtt(get=Qtt(get=Ztt(get=il((Get=Vet=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._lastPos=new oi,e._lastSize=new Di,e._dirty=!0,e._hadAlignOnce=!1,q(e,"_alignFlags",xet,H(e)),q(e,"_target",Aet,H(e)),q(e,"_left",Cet,H(e)),q(e,"_right",bet,H(e)),q(e,"_top",Tet,H(e)),q(e,"_bottom",Eet,H(e)),q(e,"_horizontalCenter",wet,H(e)),q(e,"_verticalCenter",Pet,H(e)),q(e,"_isAbsLeft",Iet,H(e)),q(e,"_isAbsRight",Ret,H(e)),q(e,"_isAbsTop",Det,H(e)),q(e,"_isAbsBottom",Bet,H(e)),q(e,"_isAbsHorizontalCenter",Met,H(e)),q(e,"_isAbsVerticalCenter",Oet,H(e)),q(e,"_originalWidth",Net,H(e)),q(e,"_originalHeight",Let,H(e)),q(e,"_alignMode",Fet,H(e)),q(e,"_lockFlags",zet,H(e)),e}F(e,t);var n=e.prototype;return n.updateAlignment=function(){i._widgetManager.updateAlignment(this.node)},n._validateTargetInDEV=function(){},n.setDirty=function(){this._recursiveDirty()},n.onEnable=function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),i._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()},n.onDisable=function(){i._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()},n.onDestroy=function(){this._removeParentEvent()},n._adjustWidgetToAllowMovingInEditor=function(){},n._adjustWidgetToAllowResizingInEditor=function(){},n._adjustWidgetToAnchorChanged=function(){this.setDirty()},n._adjustTargetToParentChanged=function(t){t&&this._unregisterOldParentEvents(t),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()},n._registerEvent=function(){this.node.on(RC.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(RC.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(RC.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(RC.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._unregisterEvent=function(){this.node.off(RC.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(RC.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(RC.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)},n._removeParentEvent=function(){this.node.off(RC.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._autoChangedValue=function(t,e){if((this._alignFlags&t)>0){var n=this.node.parent&&this.node.parent._uiProps,i=n&&n.uiTransformComp,r=i?i.contentSize:kB;this.isAlignLeft&&t===ket.LEFT?this._left=e?this._left*r.width:this._left/r.width:this.isAlignRight&&t===ket.RIGHT?this._right=e?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&t===ket.CENTER?this._horizontalCenter=e?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&t===ket.TOP?this._top=e?this._top*r.height:this._top/r.height:this.isAlignBottom&&t===ket.BOT?this._bottom=e?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&t===ket.MID&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}},n._registerTargetEvents=function(){var t=this._target||this.node.parent;t&&t.getComponent($Y)&&(t.on(RC.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.on(RC.SIZE_CHANGED,this._setDirtyByMode,this),t.on(RC.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterTargetEvents=function(){var t=this._target||this.node.parent;t&&(t.off(RC.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(RC.SIZE_CHANGED,this._setDirtyByMode,this),t.off(RC.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterOldParentEvents=function(t){var e=this._target||t;e&&(e.off(RC.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(RC.SIZE_CHANGED,this._setDirtyByMode,this))},n._setDirtyByMode=function(){this.alignMode===Uet.ALWAYS&&this._recursiveDirty()},n._setAlign=function(t,e){if(e!==(this._alignFlags&t)>0){var n=(t&_nt)>0,i=this.node._uiProps.uiTransformComp;e?(this._alignFlags|=t,n?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=i.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=i.height))):(n?this.isStretchWidth&&(i.width=this._originalWidth):this.isStretchHeight&&(i.height=this._originalHeight),this._alignFlags&=~t)}},n._recursiveDirty=function(){this._dirty||(this._dirty=!0)},N(e,[{key:"target",get:function(){return this._target},set:function(t){this._target!==t&&(this._unregisterTargetEvents(),this._target=t,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&ket.TOP)>0},set:function(t){this._setAlign(ket.TOP,t),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&ket.BOT)>0},set:function(t){this._setAlign(ket.BOT,t),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&ket.LEFT)>0},set:function(t){this._setAlign(ket.LEFT,t),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&ket.RIGHT)>0},set:function(t){this._setAlign(ket.RIGHT,t),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&ket.MID)>0},set:function(t){t?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=ket.MID):this._alignFlags&=~ket.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&ket.CENTER)>0},set:function(t){t?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=ket.CENTER):this._alignFlags&=~ket.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&_nt)===_nt}},{key:"isStretchHeight",get:function(){return(this._alignFlags&hnt)===hnt}},{key:"top",get:function(){return this._top},set:function(t){this._top=t,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(t){this._top=this._isAbsTop?t:t/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(t){this._bottom=t,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(t){this._bottom=this._isAbsBottom?t:t/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(t){this._left=t,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(t){this._left=this._isAbsLeft?t:t/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(t){this._right=t,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(t){this._right=this._isAbsRight?t:t/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(t){this._horizontalCenter=t,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(t){this._horizontalCenter=this._isAbsHorizontalCenter?t:t/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(t){this._verticalCenter=t,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(t){this._verticalCenter=this._isAbsVerticalCenter?t:t/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(t){this._isAbsTop!==t&&(this._isAbsTop=t,this._autoChangedValue(ket.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(t){this._isAbsBottom!==t&&(this._isAbsBottom=t,this._autoChangedValue(ket.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(t){this._isAbsLeft!==t&&(this._isAbsLeft=t,this._autoChangedValue(ket.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(t){this._isAbsRight!==t&&(this._isAbsRight=t,this._autoChangedValue(ket.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(t){this._isAbsHorizontalCenter!==t&&(this._isAbsHorizontalCenter=t,this._autoChangedValue(ket.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(t){this._isAbsVerticalCenter!==t&&(this._isAbsVerticalCenter=t,this._autoChangedValue(ket.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(t){this._alignMode=t,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(t){this._alignFlags!==t&&(this._alignFlags=t,this._recursiveDirty())}}]),e}(ku),Vet.AlignMode=Uet,X((yet=Get).prototype,"target",[$tt,tet],Object.getOwnPropertyDescriptor(yet.prototype,"target"),yet.prototype),X(yet.prototype,"isAlignTop",[eet],Object.getOwnPropertyDescriptor(yet.prototype,"isAlignTop"),yet.prototype),X(yet.prototype,"isAlignBottom",[net],Object.getOwnPropertyDescriptor(yet.prototype,"isAlignBottom"),yet.prototype),X(yet.prototype,"isAlignLeft",[iet],Object.getOwnPropertyDescriptor(yet.prototype,"isAlignLeft"),yet.prototype),X(yet.prototype,"isAlignRight",[ret],Object.getOwnPropertyDescriptor(yet.prototype,"isAlignRight"),yet.prototype),X(yet.prototype,"isAlignVerticalCenter",[oet],Object.getOwnPropertyDescriptor(yet.prototype,"isAlignVerticalCenter"),yet.prototype),X(yet.prototype,"isAlignHorizontalCenter",[aet],Object.getOwnPropertyDescriptor(yet.prototype,"isAlignHorizontalCenter"),yet.prototype),X(yet.prototype,"isStretchWidth",[set],Object.getOwnPropertyDescriptor(yet.prototype,"isStretchWidth"),yet.prototype),X(yet.prototype,"isStretchHeight",[cet],Object.getOwnPropertyDescriptor(yet.prototype,"isStretchHeight"),yet.prototype),X(yet.prototype,"top",[uet],Object.getOwnPropertyDescriptor(yet.prototype,"top"),yet.prototype),X(yet.prototype,"editorTop",[ll],Object.getOwnPropertyDescriptor(yet.prototype,"editorTop"),yet.prototype),X(yet.prototype,"bottom",[het],Object.getOwnPropertyDescriptor(yet.prototype,"bottom"),yet.prototype),X(yet.prototype,"editorBottom",[ll],Object.getOwnPropertyDescriptor(yet.prototype,"editorBottom"),yet.prototype),X(yet.prototype,"left",[_et],Object.getOwnPropertyDescriptor(yet.prototype,"left"),yet.prototype),X(yet.prototype,"editorLeft",[ll],Object.getOwnPropertyDescriptor(yet.prototype,"editorLeft"),yet.prototype),X(yet.prototype,"right",[fet],Object.getOwnPropertyDescriptor(yet.prototype,"right"),yet.prototype),X(yet.prototype,"editorRight",[ll],Object.getOwnPropertyDescriptor(yet.prototype,"editorRight"),yet.prototype),X(yet.prototype,"horizontalCenter",[pet],Object.getOwnPropertyDescriptor(yet.prototype,"horizontalCenter"),yet.prototype),X(yet.prototype,"editorHorizontalCenter",[ll],Object.getOwnPropertyDescriptor(yet.prototype,"editorHorizontalCenter"),yet.prototype),X(yet.prototype,"verticalCenter",[det],Object.getOwnPropertyDescriptor(yet.prototype,"verticalCenter"),yet.prototype),X(yet.prototype,"editorVerticalCenter",[ll],Object.getOwnPropertyDescriptor(yet.prototype,"editorVerticalCenter"),yet.prototype),X(yet.prototype,"isAbsoluteTop",[ll],Object.getOwnPropertyDescriptor(yet.prototype,"isAbsoluteTop"),yet.prototype),X(yet.prototype,"isAbsoluteBottom",[ll],Object.getOwnPropertyDescriptor(yet.prototype,"isAbsoluteBottom"),yet.prototype),X(yet.prototype,"isAbsoluteLeft",[ll],Object.getOwnPropertyDescriptor(yet.prototype,"isAbsoluteLeft"),yet.prototype),X(yet.prototype,"isAbsoluteRight",[ll],Object.getOwnPropertyDescriptor(yet.prototype,"isAbsoluteRight"),yet.prototype),X(yet.prototype,"isAbsoluteHorizontalCenter",[ll],Object.getOwnPropertyDescriptor(yet.prototype,"isAbsoluteHorizontalCenter"),yet.prototype),X(yet.prototype,"isAbsoluteVerticalCenter",[ll],Object.getOwnPropertyDescriptor(yet.prototype,"isAbsoluteVerticalCenter"),yet.prototype),X(yet.prototype,"alignMode",[met,vet],Object.getOwnPropertyDescriptor(yet.prototype,"alignMode"),yet.prototype),X(yet.prototype,"alignFlags",[ll],Object.getOwnPropertyDescriptor(yet.prototype,"alignFlags"),yet.prototype),xet=X(yet.prototype,"_alignFlags",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Aet=X(yet.prototype,"_target",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Cet=X(yet.prototype,"_left",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bet=X(yet.prototype,"_right",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Tet=X(yet.prototype,"_top",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Eet=X(yet.prototype,"_bottom",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wet=X(yet.prototype,"_horizontalCenter",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Pet=X(yet.prototype,"_verticalCenter",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Iet=X(yet.prototype,"_isAbsLeft",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ret=X(yet.prototype,"_isAbsRight",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Det=X(yet.prototype,"_isAbsTop",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Bet=X(yet.prototype,"_isAbsBottom",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Met=X(yet.prototype,"_isAbsHorizontalCenter",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Oet=X(yet.prototype,"_isAbsVerticalCenter",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Net=X(yet.prototype,"_originalWidth",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Let=X(yet.prototype,"_originalHeight",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fet=X(yet.prototype,"_alignMode",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Uet.ON_WINDOW_RESIZE}}),zet=X(yet.prototype,"_lockFlags",[Zc,tl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),get=yet))||get)||get)||get)||get)||get)||get));i.internal.computeInverseTransForTarget=Wet,i.internal.getReadonlyNodeSize=jet;var pnt,dnt=new Li;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(pnt||(pnt={})),$t(pnt);var mnt,vnt,gnt,ynt,xnt,Snt,Ant,Cnt,bnt,Tnt,Ent,wnt,Pnt,Int,Rnt,Dnt,Bnt,Mnt,Ont,Nnt,Lnt,Fnt,znt,Vnt,Gnt,Unt,knt,Hnt,jnt,Wnt,qnt,Xnt,Ynt,Knt,Jnt,Qnt,Znt,$nt,tit,eit,nit,iit,rit,oit,ait,sit,cit=t("PageViewIndicator",(qet=qc("cc.PageViewIndicator"),Xet=cl(),Yet=Yc(110),Ket=rl(),Jet=El(RX),Qet=fl(),Zet=El(pnt),$et=fl(),tnt=El(Di),ent=fl(),nnt=fl(),qet(int=Xet(int=Yet(int=Ket((unt=lnt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"spacing",ont,H(e)),q(e,"_spriteFrame",ant,H(e)),q(e,"_direction",snt,H(e)),q(e,"_cellSize",cnt,H(e)),e._layout=null,e._pageView=null,e._indicators=[],e}F(e,t);var n=e.prototype;return n.onLoad=function(){this._updateLayout()},n.setPageView=function(t){this._pageView=t,this._refresh()},n._updateLayout=function(){this._layout=this.getComponent(c7),this._layout||(this._layout=this.addComponent(c7));var t=this._layout;this.direction===pnt.HORIZONTAL?(t.type=c7.Type.HORIZONTAL,t.spacingX=this.spacing):this.direction===pnt.VERTICAL&&(t.type=c7.Type.VERTICAL,t.spacingY=this.spacing),t.resizeMode=c7.ResizeMode.CONTAINER},n._createIndicator=function(){var t=new BT;t.layer=this.node.layer;var e=t.addComponent(I$);return e.spriteFrame=this.spriteFrame,e.sizeMode=I$.SizeMode.CUSTOM,t.parent=this.node,t._uiProps.uiTransformComp.setContentSize(this._cellSize),t},n._changedState=function(){var t=this._indicators;if(0!==t.length&&this._pageView){var e=this._pageView.curPageIdx;if(!(e>=t.length)){for(var n=0;n<t.length;++n){var i=t[n];if(i._uiProps.uiComp){var r=i._uiProps.uiComp;dnt.set(r.color),dnt.a=127.5,r.color=dnt}}if(t[e]._uiProps.uiComp){var o=t[e]._uiProps.uiComp;dnt.set(o.color),dnt.a=255,o.color=dnt}}}},n._refresh=function(){if(this._pageView){var t=this._indicators,e=this._pageView.getPages();if(e.length!==t.length){var n=0;if(e.length>t.length)for(n=0;n<e.length;++n)t[n]||(t[n]=this._createIndicator());else for(n=t.length-e.length;n>0;--n){var i=t[n-1];this.node.removeChild(i),t.splice(n-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}},N(e,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){this._spriteFrame!==t&&(this._spriteFrame=t)}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t)}},{key:"cellSize",get:function(){return this._cellSize},set:function(t){this._cellSize!==t&&(this._cellSize=t)}}]),e}(ku),lnt.Direction=pnt,X((rnt=unt).prototype,"spriteFrame",[Jet,Qet],Object.getOwnPropertyDescriptor(rnt.prototype,"spriteFrame"),rnt.prototype),X(rnt.prototype,"direction",[Zet,$et],Object.getOwnPropertyDescriptor(rnt.prototype,"direction"),rnt.prototype),X(rnt.prototype,"cellSize",[tnt,ent],Object.getOwnPropertyDescriptor(rnt.prototype,"cellSize"),rnt.prototype),ont=X(rnt.prototype,"spacing",[Zc,nnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ant=X(rnt.prototype,"_spriteFrame",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),snt=X(rnt.prototype,"_direction",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pnt.HORIZONTAL}}),cnt=X(rnt.prototype,"_cellSize",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Di(20,20)}}),int=rnt))||int)||int)||int)||int)),lit=new li;!function(t){t[t.Unified=0]="Unified",t[t.Free=1]="Free"}(oit||(oit={})),$t(oit),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(ait||(ait={})),$t(ait),function(t){t.PAGE_TURNING="page-turning"}(sit||(sit={})),t("PageView",(mnt=qc("cc.PageView"),vnt=cl(),gnt=Yc(110),ynt=rl(),xnt=El(oit),Snt=fl(),Ant=El(ait),Cnt=fl(),bnt=pl(),Tnt=fl(),Ent=pl(),wnt=fl(),Pnt=El(cit),Int=fl(),Rnt=fl(),Dnt=El(N9),Bnt=ul(),Mnt=El(N9),Ont=ul(),Nnt=ul(),Lnt=ul(),Fnt=ul(),znt=El([hL]),Vnt=ul(),Gnt=fl(),Unt=El([hL]),knt=fl(),mnt(Hnt=vnt(Hnt=gnt(Hnt=ynt((rit=iit=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"autoPageTurningThreshold",Wnt,H(e)),q(e,"horizontal",qnt,H(e)),q(e,"vertical",Xnt,H(e)),q(e,"cancelInnerEvents",Ynt,H(e)),q(e,"scrollEvents",Knt,H(e)),q(e,"pageTurningSpeed",Jnt,H(e)),q(e,"pageEvents",Qnt,H(e)),q(e,"_sizeMode",Znt,H(e)),q(e,"_direction",$nt,H(e)),q(e,"_scrollThreshold",tit,H(e)),q(e,"_pageTurningEventTiming",eit,H(e)),q(e,"_indicator",nit,H(e)),e._curPageIdx=0,e._lastPageIdx=0,e._pages=[],e._initContentPos=new oi,e._scrollCenterOffsetX=[],e._scrollCenterOffsetY=[],e._touchBeganPosition=new li,e._touchEndPosition=new li,e}F(e,t);var n=e.prototype;return n.onEnable=function(){t.prototype.onEnable.call(this),this.node.on(RC.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(e.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onDisable=function(){t.prototype.onDisable.call(this),this.node.off(RC.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(e.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onLoad=function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)},n.getCurrentPageIndex=function(){return this._curPageIdx},n.setCurrentPageIndex=function(t){this.scrollToPage(t,1)},n.getPages=function(){return this._pages},n.addPage=function(t){t&&-1===this._pages.indexOf(t)&&this.content&&(t._uiProps.uiTransformComp?(this.content.addChild(t),this._pages.push(t),this._updatePageView()):A(4301))},n.insertPage=function(t,e){if(!(e<0)&&t&&-1===this._pages.indexOf(t)&&this.content)if(e>=this._pages.length)this.addPage(t);else{if(!t._uiProps.uiTransformComp)return void A(4301);this._pages.splice(e,0,t),this.content.insertChild(t,e),this._updatePageView()}},n.removePage=function(t){if(t&&this.content){var e=this._pages.indexOf(t);-1!==e?this.removePageAtIndex(e):b(4300,t.name)}},n.removePageAtIndex=function(t){var e=this._pages;if(!(t<0||t>=e.length)){var n=e[t];n&&this.content&&(this.content.removeChild(n),e.splice(t,1),this._updatePageView())}},n.removeAllPages=function(){if(this.content){for(var t=this._pages,e=0,n=t.length;e<n;e++)this.content.removeChild(t[e]);this._pages.length=0,this._updatePageView()}},n.scrollToPage=function(t,e){void 0===e&&(e=.3),t<0||t>=this._pages.length||(this._curPageIdx=t,this.scrollToOffset(this._moveOffsetValue(t),e,!0),this.indicator&&this.indicator._changedState())},n.getScrollEndedEventTiming=function(){return this.pageTurningEventTiming},n._updatePageView=function(){if(this.content){var t=this.content.getComponent(c7);t&&t.enabled&&t.updateLayout();var e=this._pages.length;this._curPageIdx>=e&&(this._curPageIdx=0===e?0:e-1,this._lastPageIdx=this._curPageIdx);for(var n=this._initContentPos,i=0;i<e;++i){var r=this._pages[i].position;this.direction===ait.Horizontal?this._scrollCenterOffsetX[i]=Math.abs(n.x+r.x):this._scrollCenterOffsetY[i]=Math.abs(n.y+r.y)}this.indicator&&this.indicator._refresh()}},n._updateAllPagesSize=function(){var t=this.view;if(this.content&&t&&this._sizeMode===oit.Unified)for(var e=this._pages,n=t.contentSize,i=0,r=e.length;i<r;i++)e[i]._uiProps.uiTransformComp.setContentSize(n)},n._handleReleaseLogic=function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(e.EventType.SCROLL_ENDED))},n._onTouchBegan=function(e,n){e.touch.getUILocation(lit),li.set(this._touchBeganPosition,lit.x,lit.y),t.prototype._onTouchBegan.call(this,e,n)},n._onTouchMoved=function(e,n){t.prototype._onTouchMoved.call(this,e,n)},n._onTouchEnded=function(e,n){e.touch.getUILocation(lit),li.set(this._touchEndPosition,lit.x,lit.y),t.prototype._onTouchEnded.call(this,e,n)},n._onTouchCancelled=function(e,n){e.touch.getUILocation(lit),li.set(this._touchEndPosition,lit.x,lit.y),t.prototype._onTouchCancelled.call(this,e,n)},n._onMouseWheel=function(){},n._syncScrollDirection=function(){this.horizontal=this.direction===ait.Horizontal,this.vertical=this.direction===ait.Vertical},n._syncSizeMode=function(){var t=this.view;if(this.content&&t){var e=this.content.getComponent(c7);if(e){if(this._sizeMode===oit.Free&&this._pages.length>0){var n=this._pages[0]._uiProps.uiTransformComp,i=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===ait.Horizontal?(e.paddingLeft=(t.width-n.width)/2,e.paddingRight=(t.width-i.width)/2):this.direction===ait.Vertical&&(e.paddingTop=(t.height-n.height)/2,e.paddingBottom=(t.height-i.height)/2)}e.updateLayout()}}},n._initPages=function(){if(this.content){this._initContentPos=this.content.position;for(var t=this.content.children,e=0;e<t.length;++e){var n=t[e];this._pages.indexOf(n)>=0||this._pages.push(n)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}},n._dispatchPageTurningEvent=function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,hL.emitEvents(this.pageEvents,this,sit.PAGE_TURNING),this.node.emit(sit.PAGE_TURNING,this))},n._isQuicklyScrollable=function(t){if(this.direction===ait.Horizontal){if(Math.abs(t.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===ait.Vertical&&Math.abs(t.y)>this.autoPageTurningThreshold)return!0;return!1},n._moveOffsetValue=function(t){var e=new li;if(this._sizeMode===oit.Free)this.direction===ait.Horizontal?e.x=this._scrollCenterOffsetX[t]:this.direction===ait.Vertical&&(e.y=this._scrollCenterOffsetY[t]);else{var n=this.view;if(!n)return e;this.direction===ait.Horizontal?e.x=t*n.width:this.direction===ait.Vertical&&(e.y=t*n.height)}return e},n._getDragDirection=function(t){return this._direction===ait.Horizontal?0===t.x?0:t.x>0?1:-1:0===t.y?0:t.y<0?1:-1},n._isScrollable=function(t,e,n){if(this._sizeMode===oit.Free){var i=0,r=0;if(this.direction===ait.Horizontal)return i=this._scrollCenterOffsetX[e],r=this._scrollCenterOffsetX[n],Math.abs(t.x)>=Math.abs(i-r)*this.scrollThreshold;if(this.direction===ait.Vertical)return i=this._scrollCenterOffsetY[e],r=this._scrollCenterOffsetY[n],Math.abs(t.y)>=Math.abs(i-r)*this.scrollThreshold}else{var o=this.view;if(!o)return!1;if(this.direction===ait.Horizontal)return Math.abs(t.x)>=o.width*this.scrollThreshold;if(this.direction===ait.Vertical)return Math.abs(t.y)>=o.height*this.scrollThreshold}return!1},n._autoScrollToPage=function(){if(this._startBounceBackIfNeeded()){var t=this._getHowMuchOutOfBoundary();this._clampDelta(t),(t.x>0||t.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(t.x<0||t.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var e=new li;li.subtract(e,this._touchBeganPosition,this._touchEndPosition);var n=this._curPageIdx,i=n+this._getDragDirection(e),r=this.pageTurningSpeed*Math.abs(n-i);if(i<this._pages.length){if(this._isScrollable(e,n,i))return void this.scrollToPage(i,r);var o=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(o))return void this.scrollToPage(i,r)}this.scrollToPage(n,r)}},N(e,[{key:"sizeMode",get:function(){return this._sizeMode},set:function(t){this._sizeMode!==t&&(this._sizeMode=t,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(t){this._scrollThreshold!==t&&(this._scrollThreshold=t)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(t){this._pageTurningEventTiming!==t&&(this._pageTurningEventTiming=t)}},{key:"indicator",get:function(){return this._indicator},set:function(t){this._indicator!==t&&(this._indicator=t,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return t.prototype.verticalScrollBar},set:function(t){this.verticalScrollBar=t}},{key:"horizontalScrollBar",get:function(){return t.prototype.horizontalScrollBar},set:function(t){this.horizontalScrollBar=t}}]),e}(Mtt),iit.SizeMode=oit,iit.Direction=ait,iit.EventType=Ntt(sit,F9),X((jnt=rit).prototype,"sizeMode",[xnt,Snt],Object.getOwnPropertyDescriptor(jnt.prototype,"sizeMode"),jnt.prototype),X(jnt.prototype,"direction",[Ant,Cnt],Object.getOwnPropertyDescriptor(jnt.prototype,"direction"),jnt.prototype),X(jnt.prototype,"scrollThreshold",[gl,bnt,Tnt],Object.getOwnPropertyDescriptor(jnt.prototype,"scrollThreshold"),jnt.prototype),X(jnt.prototype,"pageTurningEventTiming",[gl,Ent,wnt],Object.getOwnPropertyDescriptor(jnt.prototype,"pageTurningEventTiming"),jnt.prototype),X(jnt.prototype,"indicator",[Pnt,Int],Object.getOwnPropertyDescriptor(jnt.prototype,"indicator"),jnt.prototype),Wnt=X(jnt.prototype,"autoPageTurningThreshold",[Zc,Rnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),X(jnt.prototype,"verticalScrollBar",[Dnt,Ll,Bnt],Object.getOwnPropertyDescriptor(jnt.prototype,"verticalScrollBar"),jnt.prototype),X(jnt.prototype,"horizontalScrollBar",[Mnt,Ll,Ont],Object.getOwnPropertyDescriptor(jnt.prototype,"horizontalScrollBar"),jnt.prototype),qnt=X(jnt.prototype,"horizontal",[Ll,Zc,Nnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Xnt=X(jnt.prototype,"vertical",[Ll,Zc,Lnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ynt=X(jnt.prototype,"cancelInnerEvents",[Ll,Zc,Fnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Knt=X(jnt.prototype,"scrollEvents",[znt,Zc,Ll,Vnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jnt=X(jnt.prototype,"pageTurningSpeed",[Zc,ll,Gnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),Qnt=X(jnt.prototype,"pageEvents",[Unt,Zc,knt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Znt=X(jnt.prototype,"_sizeMode",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oit.Unified}}),$nt=X(jnt.prototype,"_direction",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ait.Horizontal}}),tit=X(jnt.prototype,"_scrollThreshold",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),eit=X(jnt.prototype,"_pageTurningEventTiming",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),nit=X(jnt.prototype,"_indicator",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hnt=jnt))||Hnt)||Hnt)||Hnt)||Hnt));var uit=new oi,hit=new li,_it=new li,fit=new li(1,1),pit=new li,dit=new li;function mit(t,e){if(!e._hadAlignOnce){e.alignMode===Uet.ONCE&&(e._hadAlignOnce=!0);var n,i=e.target,r=_it,o=fit;i?Wet(t,n=i,r,o):n=t.parent;var a=jet(n),s=n instanceof OR||!n.getComponent($Y),c=s?hit:n.getComponent($Y).anchorPoint,l=s;t.getPosition(uit);var u=t._uiProps.uiTransformComp,h=uit.x,_=uit.y,f=u.anchorPoint,p=t.getScale();if(e.alignFlags&ket.HORIZONTAL){var d=0,m=0,v=a.width;l?(d=kB.left.x,m=kB.right.x):m=(d=-c.x*v)+v,d+=e.isAbsoluteLeft?e.left:e.left*v,m-=e.isAbsoluteRight?e.right:e.right*v,i&&(d+=r.x,d*=o.x,m+=r.x,m*=o.x);var g=0,y=f.x,x=p.x;if(x<0&&(y=1-y,x=-x),e.isStretchWidth)g=m-d,0!==x&&(u.width=g/x),h=d+y*g;else if(g=u.width*x,e.isAlignHorizontalCenter){var S=e.isAbsoluteHorizontalCenter?e.horizontalCenter:e.horizontalCenter*v,A=(.5-c.x)*a.width;i&&(S*=o.x,A+=r.x,A*=o.x),h=A+(y-.5)*g+S}else h=e.isAlignLeft?d+y*g:m+(y-1)*g;e._lastSize.width=g}if(e.alignFlags&ket.VERTICAL){var C=0,b=0,T=a.height;l?(b=kB.bottom.y,C=kB.top.y):C=(b=-c.y*T)+T,b+=e.isAbsoluteBottom?e.bottom:e.bottom*T,C-=e.isAbsoluteTop?e.top:e.top*T,i&&(b+=r.y,b*=o.y,C+=r.y,C*=o.y);var E=0,w=f.y,P=p.y;if(P<0&&(w=1-w,P=-P),e.isStretchHeight)E=C-b,0!==P&&(u.height=E/P),_=b+w*E;else if(E=u.height*P,e.isAlignVerticalCenter){var I=e.isAbsoluteVerticalCenter?e.verticalCenter:e.verticalCenter*T,R=(.5-c.y)*a.height;i&&(I*=o.y,R+=r.y,R*=o.y),_=R+(w-.5)*E+I}else _=e.isAlignBottom?b+w*E:C+(w-1)*E;e._lastSize.height=E}t.setPosition(h,_,uit.z),oi.set(e._lastPos,h,_,uit.z)}}function vit(t){var e=t.getComponent(fnt);if(e&&e.enabled){if(!i.isValid(t,!0))return;xit.push(e)}for(var n,r=W(t.children);!(n=r()).done;){var o=n.value;o.active&&vit(o)}}function git(){var t=LM.getScene();if(t){Sit.isAligning=!0,Sit._nodesOrderDirty&&(xit.length=0,vit(t),Sit._nodesOrderDirty=!1);var e=null,n=Sit._activeWidgetsIterator;for(n.i=0;n.i<xit.length;++n.i)(e=xit[n.i])._dirty&&(mit(e.node,e),e._dirty=!1);Sit.isAligning=!1}}var yit,xit=[],Sit=t("widgetManager",i._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new Ut.MutableForwardIterator(xit),animationState:null,init:function(){LM.on(NM.EVENT_AFTER_SCENE_LAUNCH,git),LM.on(NM.EVENT_AFTER_UPDATE,git),yM.instance.on("design-resolution-changed",this.onResized,this);var t=this.onResized.bind(this);yM.instance.on("canvas-resize",t),Ku.on("orientation-change",t)},add:function(){this._nodesOrderDirty=!0},remove:function(t){this._activeWidgetsIterator.remove(t)},onResized:function(){var t=LM.getScene();t&&this.refreshWidgetOnResized(t)},refreshWidgetOnResized:function(t){var e=BT.isNode(t)&&t.getComponent(fnt);e&&e.enabled&&(e.alignMode===Uet.ON_WINDOW_RESIZE||e.alignMode===Uet.ALWAYS)&&e.setDirty();for(var n,i=W(t.children);!(n=i()).done;){var r=n.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(t,e){function n(t,e){return Math.abs(t-e)>1e-10?e:t}var i=t.node,r=i.parent;if(r){var o=pit;o.set(0,0);var a=dit;if(a.set(1,1),t.target&&Wet(i,r=t.target,o,a),!e)return;var s=r._uiProps&&r._uiProps.uiTransformComp,c=s?s.anchorPoint:hit,l=i._uiProps.uiTransformComp,u=jet(r),h=l.anchorPoint,_=i.getPosition(),f=ket,p=i.getScale(),d=0;if(e&f.LEFT){var m=-c.x*u.width;m+=o.x,m*=a.x,d=_.x-h.x*l.width*p.x-m,t.isAbsoluteLeft||(d/=u.width),d/=a.x,t.left=n(t.left,d)}if(e&f.RIGHT){var v=(1-c.x)*u.width;v+=o.x,d=(v*=a.x)-(_.x+(1-h.x)*l.width*p.x),t.isAbsoluteRight||(d/=u.width),d/=a.x,t.right=n(t.right,d)}if(e&f.TOP){var g=(1-c.y)*u.height;g+=o.y,d=(g*=a.y)-(_.y+(1-h.y)*l.height*p.y),t.isAbsoluteTop||(d/=u.height),d/=a.y,t.top=n(t.top,d)}if(e&f.BOT){var y=-c.y*u.height;y+=o.y,y*=a.y,d=_.y-h.y*l.height*p.y-y,t.isAbsoluteBottom||(d/=u.height),d/=a.y,t.bottom=n(t.bottom,d)}}},updateAlignment:function t(e){var n=e.parent;n&&BT.isNode(n)&&t(n);var i=e.getComponent(fnt);i&&n&&mit(e,i)},AlignMode:Uet,AlignFlags:ket});LM.on(NM.EVENT_INIT,(function(){Sit.init()})),t("SafeArea",qc("cc.SafeArea")(yit=cl()(yit=Yc(110)(yit=il(yit=rl()(yit=Xc(fnt)(yit=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.onEnable=function(){this.updateArea(),Ku.on("window-resize",this.updateArea,this),Ku.on("orientation-change",this.updateArea,this)},n.onDisable=function(){Ku.off("window-resize",this.updateArea,this),Ku.off("orientation-change",this.updateArea,this)},n.updateArea=function(){var t=this.node.getComponent(fnt),e=this.node.getComponent($Y);if(t&&e){t.updateAlignment();var n=this.node.position.clone(),i=e.anchorPoint.clone();t.isAlignTop=t.isAlignBottom=t.isAlignLeft=t.isAlignRight=!0;var r=CM.getVisibleSize(),o=r.width,a=r.height,s=Zu.getSafeAreaRect();t.top=a-s.y-s.height,t.bottom=s.y,t.left=s.x,t.right=o-s.x-s.width,t.updateAlignment();var c=this.node.position.clone(),l=i.x-(c.x-n.x)/e.width,u=i.y-(c.y-n.y)/e.height;e.setAnchorPoint(l,u),Sit.add(t)}},e}(ku))||yit)||yit)||yit)||yit)||yit)||yit),t("UICoordinateTracker",(Ait=qc("cc.UICoordinateTracker"),Cit=cl(),bit=rl(),Tit=Yc(110),Eit=El(BT),wit=fl(),Pit=El(IL),Iit=fl(),Rit=fl(),Dit=fl(),Bit=El([hL]),Mit=fl(),Ait(Oit=Cit(Oit=bit(Oit=Tit((X((Nit=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"syncEvents",Lit,H(e)),q(e,"_target",Fit,H(e)),q(e,"_camera",zit,H(e)),q(e,"_useScale",Vit,H(e)),q(e,"_distance",Git,H(e)),e._transformPos=new oi,e._viewPos=new oi,e._canMove=!0,e._lastWPos=new oi,e._lastCameraPos=new oi,e}F(e,t);var n=e.prototype;return n.onEnable=function(){this._checkCanMove()},n.update=function(){var t=this.node.worldPosition,e=this._camera;if(this._canMove&&e&&e.camera&&(!this._lastWPos.equals(t)||!this._lastCameraPos.equals(e.node.worldPosition))&&(this._lastWPos.set(t),this._lastCameraPos.set(e.node.worldPosition),e.camera.update(),e.convertToUINode(t,this._target,this._transformPos),this._useScale&&oi.transformMat4(this._viewPos,this.node.worldPosition,e.camera.matView),this.syncEvents.length>0)){var n=this._distance/Math.abs(this._viewPos.z);hL.emitEvents(this.syncEvents,this._transformPos,n)}},n._checkCanMove=function(){this._canMove=!(!this._camera||!this._target)},N(e,[{key:"target",get:function(){return this._target},set:function(t){this._target!==t&&(this._target=t,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(t){this._camera!==t&&(this._camera=t,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(t){this._useScale!==t&&(this._useScale=t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance!==t&&(this._distance=t)}}]),e}(ku)).prototype,"target",[Eit,wit],Object.getOwnPropertyDescriptor(Nit.prototype,"target"),Nit.prototype),X(Nit.prototype,"camera",[Pit,Iit],Object.getOwnPropertyDescriptor(Nit.prototype,"camera"),Nit.prototype),X(Nit.prototype,"useScale",[Rit],Object.getOwnPropertyDescriptor(Nit.prototype,"useScale"),Nit.prototype),X(Nit.prototype,"distance",[Dit],Object.getOwnPropertyDescriptor(Nit.prototype,"distance"),Nit.prototype),Lit=X(Nit.prototype,"syncEvents",[Bit,Zc,Mit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fit=X(Nit.prototype,"_target",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zit=X(Nit.prototype,"_camera",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vit=X(Nit.prototype,"_useScale",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Git=X(Nit.prototype,"_distance",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Oit=Nit))||Oit)||Oit)||Oit)||Oit));var Ait,Cit,bit,Tit,Eit,wit,Pit,Iit,Rit,Dit,Bit,Mit,Oit,Nit,Lit,Fit,zit,Vit,Git,Uit,kit=[RC.TOUCH_START,RC.TOUCH_END,RC.TOUCH_MOVE,RC.MOUSE_DOWN,RC.MOUSE_MOVE,RC.MOUSE_UP,RC.MOUSE_ENTER,RC.MOUSE_LEAVE,RC.MOUSE_WHEEL];function Hit(t){t.propagationStopped=!0}t("BlockInputEvents",qc("cc.BlockInputEvents")(Uit=cl()(Uit=rl()(Uit=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.onEnable=function(){for(var t=0;t<kit.length;t++)this.node.on(kit[t],Hit,this)},n.onDisable=function(){for(var t=0;t<kit.length;t++)this.node.off(kit[t],Hit,this)},e}(ku))||Uit)||Uit)||Uit);var jit,Wit,qit,Xit,Yit,Kit,Jit,Qit,Zit,$it,trt,ert,nrt,irt={},rrt=t("SubContextView",(jit=qc("cc.SubContextView"),Wit=cl(),qit=Yc(110),Xit=Xc($Y),Yit=rl(),Kit=fl(),Jit=fl(),jit(Qit=Wit(Qit=qit(Qit=Xit(Qit=Yit((X((Zit=function(t){function e(){var e;return q(e=t.call(this)||this,"_fps",$it,H(e)),e._sprite=void 0,e._imageAsset=void 0,e._texture=void 0,e._updatedTime=0,e._updateInterval=0,e._openDataContext=void 0,e._content=void 0,q(e,"_designResolutionSize",trt,H(e)),e._content=new BT("content"),e._content.hideFlags|=Je.Flags.DontSave|Je.Flags.HideInHierarchy,e._sprite=null,e._imageAsset=new ym,e._openDataContext=null,e._updatedTime=performance.now(),e._texture=new jm,e}F(e,t);var n=e.prototype;return n.onLoad=function(){irt.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=irt.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._unregisterNodeEvent()},n._initSharedCanvas=function(){if(this._openDataContext){var t=this._openDataContext.canvas;t.width=this._designResolutionSize.width,t.height=this._designResolutionSize.height}},n._initContentNode=function(){if(this._openDataContext){var t=this._openDataContext.canvas,e=this._imageAsset;if(e.reset(t),this._texture.image=e,this._texture.create(t.width,t.height),this._sprite=this._content.getComponent(I$),this._sprite||(this._sprite=this._content.addComponent(I$)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{var n=new RX;n.texture=this._texture,this._sprite.spriteFrame=n}this._content.parent=this.node}},n._updateSubContextView=function(){if(this._openDataContext){var t=this.node.getComponent($Y),e=this._content.getComponent($Y),n=t.width/e.width,i=t.height/e.height,r=n>i?i:n;e.width*=r,e.height*=r;var o=CM.getViewportRect(),a=e.getBoundingBoxToWorld(),s=CM.getVisibleSize(),c=Ku.devicePixelRatio,l=(o.width*(a.x/s.width)+o.x)/c,u=(o.height*(a.y/s.height)+o.y)/c,h=o.width*(a.width/s.width)/c,_=o.height*(a.height/s.height)/c;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:u,width:h,height:_})}},n._updateSubContextTexture=function(){var t=this._imageAsset;if(t&&this._openDataContext&&!(t.width<=0||t.height<=0)){var e=this._openDataContext.canvas;t.reset(e),(e.width>t.width||e.height>t.height)&&this._texture.create(e.width,e.height),this._texture.uploadData(e)}},n._registerNodeEvent=function(){this.node.on(RC.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(RC.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(RC.LAYER_CHANGED,this._updateContentLayer,this)},n._unregisterNodeEvent=function(){this.node.off(RC.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(RC.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(RC.LAYER_CHANGED,this._updateContentLayer,this)},n._updateContentLayer=function(){this._content.layer=this.node.layer},n.update=function(t){void 0===t?this._updateSubContextTexture():performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())},n.onDestroy=function(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null},N(e,[{key:"designResolutionSize",get:function(){return this._designResolutionSize},set:function(){}},{key:"fps",get:function(){return this._fps},set:function(t){this._fps!==t&&(this._fps=t,this._updateInterval=1e3/t)}}]),e}(ku)).prototype,"designResolutionSize",[Kit],Object.getOwnPropertyDescriptor(Zit.prototype,"designResolutionSize"),Zit.prototype),X(Zit.prototype,"fps",[Jit],Object.getOwnPropertyDescriptor(Zit.prototype,"fps"),Zit.prototype),$it=X(Zit.prototype,"_fps",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),trt=X(Zit.prototype,"_designResolutionSize",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Di(640,960)}}),Qit=Zit))||Qit)||Qit)||Qit)||Qit)||Qit));i.SubContextView=rrt,"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var ort,art=function(t,e){return function(t,e){!function(t){function e(t){if(!t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];throw U(Error,n)}}function n(t,e){return void 0!==t?t:e}var i=1e37,r=1e-5,o=r*r,a=3.14159265359,s=2,c=8,l=.1,u=2,h=.008,_=2/180*a,f=2*h,p=8,d=32,m=1,v=.2,g=8/180*a,y=2,x=y*y,S=.5*a,A=S*S,C=.2,b=.75,T=-1,E=2147483647,w=.75,P=1,I=.25,R=.5,D=2,B=D*D,M=256,O=2.5,L=.5,z=.01,V=2/180*a;function G(){return null}function k(){}function H(){}var j=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.major=0,this.minor=0,this.revision=0,this.major=t,this.minor=e,this.revision=n}return t.prototype.toString=function(){return this.major+"."+this.minor+"."+this.revision},t}(),q=new j(2,3,2),X="master",Y="fbf51801d80fc389d43dc46524520e89043b6faf";function K(t){return parseInt(t,10)}function J(t){return Math.abs(parseInt(t,10))}function Q(t,e){for(var n=new Array(t),i=0;i<t;++i)n[i]=e(i);return n}function Z(t){for(var e=new Array(t),n=0;n<t;++n)e[n]=null;return e}function $(t,e){void 0===e&&(e=0);for(var n=new Array(t),i=0;i<t;++i)n[i]=e;return n}var tt=a/180,et=180/a,nt=2*a,it=Math.abs;function rt(t,e){return t<e?t:e}function ot(t,e){return t>e?t:e}function at(t,e,n){return t<e?e:t>n?n:t}function st(t,e){var n=t[0];t[0]=e[0],e[0]=n}var ct=isFinite;function lt(t){return t*t}function ut(t){return 1/Math.sqrt(t)}var ht=Math.sqrt,_t=Math.pow;function ft(t){return t*tt}function pt(t){return t*et}var dt=Math.cos,mt=Math.sin,vt=Math.acos,gt=Math.asin,yt=Math.atan2;function xt(t){return t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,1+((t|=t>>8&16777215)|t>>16&65535)}function St(t){return t>0&&0==(t&t-1)}function At(){return 2*Math.random()-1}function Ct(t,e){return(e-t)*Math.random()+t}var bt=function(){function t(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(e[0]instanceof Float32Array){if(2!==e[0].length)throw new Error;this.data=e[0]}else{var i="number"==typeof e[0]?e[0]:0,r="number"==typeof e[1]?e[1]:0;this.data=new Float32Array([i,r])}}var e=t.prototype;return e.Clone=function(){return new t(this.x,this.y)},e.SetZero=function(){return this.x=0,this.y=0,this},e.Set=function(t,e){return this.x=t,this.y=e,this},e.Copy=function(t){return this.x=t.x,this.y=t.y,this},e.SelfAdd=function(t){return this.x+=t.x,this.y+=t.y,this},e.SelfAddXY=function(t,e){return this.x+=t,this.y+=e,this},e.SelfSub=function(t){return this.x-=t.x,this.y-=t.y,this},e.SelfSubXY=function(t,e){return this.x-=t,this.y-=e,this},e.SelfMul=function(t){return this.x*=t,this.y*=t,this},e.SelfMulAdd=function(t,e){return this.x+=t*e.x,this.y+=t*e.y,this},e.SelfMulSub=function(t,e){return this.x-=t*e.x,this.y-=t*e.y,this},e.Dot=function(t){return this.x*t.x+this.y*t.y},e.Cross=function(t){return this.x*t.y-this.y*t.x},e.Length=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},e.LengthSquared=function(){var t=this.x,e=this.y;return t*t+e*e},e.Normalize=function(){var t=this.Length();if(t>=r){var e=1/t;this.x*=e,this.y*=e}return t},e.SelfNormalize=function(){var t=this.Length();if(t>=r){var e=1/t;this.x*=e,this.y*=e}return this},e.SelfRotate=function(t){var e=Math.cos(t),n=Math.sin(t),i=this.x;return this.x=e*i-n*this.y,this.y=n*i+e*this.y,this},e.SelfRotateCosSin=function(t,e){var n=this.x;return this.x=t*n-e*this.y,this.y=e*n+t*this.y,this},e.IsValid=function(){return isFinite(this.x)&&isFinite(this.y)},e.SelfCrossVS=function(t){var e=this.x;return this.x=t*this.y,this.y=-t*e,this},e.SelfCrossSV=function(t){var e=this.x;return this.x=-t*this.y,this.y=t*e,this},e.SelfMinV=function(t){return this.x=rt(this.x,t.x),this.y=rt(this.y,t.y),this},e.SelfMaxV=function(t){return this.x=ot(this.x,t.x),this.y=ot(this.y,t.y),this},e.SelfAbs=function(){return this.x=it(this.x),this.y=it(this.y),this},e.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this},e.SelfSkew=function(){var t=this.x;return this.x=-this.y,this.y=t,this},t.MakeArray=function(e){return Q(e,(function(){return new t}))},t.AbsV=function(t,e){return e.x=it(t.x),e.y=it(t.y),e},t.MinV=function(t,e,n){return n.x=rt(t.x,e.x),n.y=rt(t.y,e.y),n},t.MaxV=function(t,e,n){return n.x=ot(t.x,e.x),n.y=ot(t.y,e.y),n},t.ClampV=function(t,e,n,i){return i.x=at(t.x,e.x,n.x),i.y=at(t.y,e.y,n.y),i},t.RotateV=function(t,e,n){var i=t.x,r=t.y,o=Math.cos(e),a=Math.sin(e);return n.x=o*i-a*r,n.y=a*i+o*r,n},t.DotVV=function(t,e){return t.x*e.x+t.y*e.y},t.CrossVV=function(t,e){return t.x*e.y-t.y*e.x},t.CrossVS=function(t,e,n){var i=t.x;return n.x=e*t.y,n.y=-e*i,n},t.CrossVOne=function(t,e){var n=t.x;return e.x=t.y,e.y=-n,e},t.CrossSV=function(t,e,n){var i=e.x;return n.x=-t*e.y,n.y=t*i,n},t.CrossOneV=function(t,e){var n=t.x;return e.x=-t.y,e.y=n,e},t.AddVV=function(t,e,n){return n.x=t.x+e.x,n.y=t.y+e.y,n},t.SubVV=function(t,e,n){return n.x=t.x-e.x,n.y=t.y-e.y,n},t.MulSV=function(t,e,n){return n.x=e.x*t,n.y=e.y*t,n},t.MulVS=function(t,e,n){return n.x=t.x*e,n.y=t.y*e,n},t.AddVMulSV=function(t,e,n,i){return i.x=t.x+e*n.x,i.y=t.y+e*n.y,i},t.SubVMulSV=function(t,e,n,i){return i.x=t.x-e*n.x,i.y=t.y-e*n.y,i},t.AddVCrossSV=function(t,e,n,i){var r=n.x;return i.x=t.x-e*n.y,i.y=t.y+e*r,i},t.MidVV=function(t,e,n){return n.x=.5*(t.x+e.x),n.y=.5*(t.y+e.y),n},t.ExtVV=function(t,e,n){return n.x=.5*(e.x-t.x),n.y=.5*(e.y-t.y),n},t.IsEqualToV=function(t,e){return t.x===e.x&&t.y===e.y},t.DistanceVV=function(t,e){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)},t.DistanceSquaredVV=function(t,e){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i},t.NegV=function(t,e){return e.x=-t.x,e.y=-t.y,e},N(t,[{key:"x",get:function(){return this.data[0]},set:function(t){this.data[0]=t}},{key:"y",get:function(){return this.data[1]},set:function(t){this.data[1]=t}}]),t}();bt.ZERO=new bt(0,0),bt.UNITX=new bt(1,0),bt.UNITY=new bt(0,1),bt.s_t0=new bt,bt.s_t1=new bt,bt.s_t2=new bt,bt.s_t3=new bt;var Tt=new bt(0,0),Et=function(){function t(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(e[0]instanceof Float32Array){if(3!==e[0].length)throw new Error;this.data=e[0]}else{var i="number"==typeof e[0]?e[0]:0,r="number"==typeof e[1]?e[1]:0,o="number"==typeof e[2]?e[2]:0;this.data=new Float32Array([i,r,o])}}var e=t.prototype;return e.Clone=function(){return new t(this.x,this.y,this.z)},e.SetZero=function(){return this.x=0,this.y=0,this.z=0,this},e.SetXYZ=function(t,e,n){return this.x=t,this.y=e,this.z=n,this},e.Copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},e.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},e.SelfAdd=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},e.SelfAddXYZ=function(t,e,n){return this.x+=t,this.y+=e,this.z+=n,this},e.SelfSub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},e.SelfSubXYZ=function(t,e,n){return this.x-=t,this.y-=e,this.z-=n,this},e.SelfMul=function(t){return this.x*=t,this.y*=t,this.z*=t,this},t.DotV3V3=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},t.CrossV3V3=function(t,e,n){var i=t.x,r=t.y,o=t.z,a=e.x,s=e.y,c=e.z;return n.x=r*c-o*s,n.y=o*a-i*c,n.z=i*s-r*a,n},N(t,[{key:"x",get:function(){return this.data[0]},set:function(t){this.data[0]=t}},{key:"y",get:function(){return this.data[1]},set:function(t){this.data[1]=t}},{key:"z",get:function(){return this.data[2]},set:function(t){this.data[2]=t}}]),t}();Et.ZERO=new Et(0,0,0),Et.s_t0=new Et;var wt=function(){function t(){this.data=new Float32Array([1,0,0,1]),this.ex=new bt(this.data.subarray(0,2)),this.ey=new bt(this.data.subarray(2,4))}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},t.FromVV=function(e,n){return(new t).SetVV(e,n)},t.FromSSSS=function(e,n,i,r){return(new t).SetSSSS(e,n,i,r)},t.FromAngle=function(e){return(new t).SetAngle(e)},e.SetSSSS=function(t,e,n,i){return this.ex.Set(t,n),this.ey.Set(e,i),this},e.SetVV=function(t,e){return this.ex.Copy(t),this.ey.Copy(e),this},e.SetAngle=function(t){var e=Math.cos(t),n=Math.sin(t);return this.ex.Set(e,n),this.ey.Set(-n,e),this},e.Copy=function(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this},e.SetIdentity=function(){return this.ex.Set(1,0),this.ey.Set(0,1),this},e.SetZero=function(){return this.ex.SetZero(),this.ey.SetZero(),this},e.GetAngle=function(){return Math.atan2(this.ex.y,this.ex.x)},e.GetInverse=function(t){var e=this.ex.x,n=this.ey.x,i=this.ex.y,r=this.ey.y,o=e*r-n*i;return 0!==o&&(o=1/o),t.ex.x=o*r,t.ey.x=-o*n,t.ex.y=-o*i,t.ey.y=o*e,t},e.Solve=function(t,e,n){var i=this.ex.x,r=this.ey.x,o=this.ex.y,a=this.ey.y,s=i*a-r*o;return 0!==s&&(s=1/s),n.x=s*(a*t-r*e),n.y=s*(i*e-o*t),n},e.SelfAbs=function(){return this.ex.SelfAbs(),this.ey.SelfAbs(),this},e.SelfInv=function(){return this.GetInverse(this),this},e.SelfAddM=function(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this},e.SelfSubM=function(t){return this.ex.SelfSub(t.ex),this.ey.SelfSub(t.ey),this},t.AbsM=function(t,e){var n=t.ex,i=t.ey;return e.ex.x=it(n.x),e.ex.y=it(n.y),e.ey.x=it(i.x),e.ey.y=it(i.y),e},t.MulMV=function(t,e,n){var i=t.ex,r=t.ey,o=e.x,a=e.y;return n.x=i.x*o+r.x*a,n.y=i.y*o+r.y*a,n},t.MulTMV=function(t,e,n){var i=t.ex,r=t.ey,o=e.x,a=e.y;return n.x=i.x*o+i.y*a,n.y=r.x*o+r.y*a,n},t.AddMM=function(t,e,n){var i=t.ex,r=t.ey,o=e.ex,a=e.ey;return n.ex.x=i.x+o.x,n.ex.y=i.y+o.y,n.ey.x=r.x+a.x,n.ey.y=r.y+a.y,n},t.MulMM=function(t,e,n){var i=t.ex.x,r=t.ex.y,o=t.ey.x,a=t.ey.y,s=e.ex.x,c=e.ex.y,l=e.ey.x,u=e.ey.y;return n.ex.x=i*s+o*c,n.ex.y=r*s+a*c,n.ey.x=i*l+o*u,n.ey.y=r*l+a*u,n},t.MulTMM=function(t,e,n){var i=t.ex.x,r=t.ex.y,o=t.ey.x,a=t.ey.y,s=e.ex.x,c=e.ex.y,l=e.ey.x,u=e.ey.y;return n.ex.x=i*s+r*c,n.ex.y=o*s+a*c,n.ey.x=i*l+r*u,n.ey.y=o*l+a*u,n},t}();wt.IDENTITY=new wt;var Pt=function(){function t(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),this.ex=new Et(this.data.subarray(0,3)),this.ey=new Et(this.data.subarray(3,6)),this.ez=new Et(this.data.subarray(6,9))}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.SetVVV=function(t,e,n){return this.ex.Copy(t),this.ey.Copy(e),this.ez.Copy(n),this},e.Copy=function(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this.ez.Copy(t.ez),this},e.SetIdentity=function(){return this.ex.SetXYZ(1,0,0),this.ey.SetXYZ(0,1,0),this.ez.SetXYZ(0,0,1),this},e.SetZero=function(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this},e.SelfAddM=function(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this.ez.SelfAdd(t.ez),this},e.Solve33=function(t,e,n,i){var r=this.ex.x,o=this.ex.y,a=this.ex.z,s=this.ey.x,c=this.ey.y,l=this.ey.z,u=this.ez.x,h=this.ez.y,_=this.ez.z,f=r*(c*_-l*h)+o*(l*u-s*_)+a*(s*h-c*u);return 0!==f&&(f=1/f),i.x=f*(t*(c*_-l*h)+e*(l*u-s*_)+n*(s*h-c*u)),i.y=f*(r*(e*_-n*h)+o*(n*u-t*_)+a*(t*h-e*u)),i.z=f*(r*(c*n-l*e)+o*(l*t-s*n)+a*(s*e-c*t)),i},e.Solve22=function(t,e,n){var i=this.ex.x,r=this.ey.x,o=this.ex.y,a=this.ey.y,s=i*a-r*o;return 0!==s&&(s=1/s),n.x=s*(a*t-r*e),n.y=s*(i*e-o*t),n},e.GetInverse22=function(t){var e=this.ex.x,n=this.ey.x,i=this.ex.y,r=this.ey.y,o=e*r-n*i;0!==o&&(o=1/o),t.ex.x=o*r,t.ey.x=-o*n,t.ex.z=0,t.ex.y=-o*i,t.ey.y=o*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0},e.GetSymInverse33=function(t){var e=Et.DotV3V3(this.ex,Et.CrossV3V3(this.ey,this.ez,Et.s_t0));0!==e&&(e=1/e);var n=this.ex.x,i=this.ey.x,r=this.ez.x,o=this.ey.y,a=this.ez.y,s=this.ez.z;t.ex.x=e*(o*s-a*a),t.ex.y=e*(r*a-i*s),t.ex.z=e*(i*a-r*o),t.ey.x=t.ex.y,t.ey.y=e*(n*s-r*r),t.ey.z=e*(r*i-n*a),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(n*o-i*i)},t.MulM33V3=function(t,e,n){var i=e.x,r=e.y,o=e.z;return n.x=t.ex.x*i+t.ey.x*r+t.ez.x*o,n.y=t.ex.y*i+t.ey.y*r+t.ez.y*o,n.z=t.ex.z*i+t.ey.z*r+t.ez.z*o,n},t.MulM33XYZ=function(t,e,n,i,r){return r.x=t.ex.x*e+t.ey.x*n+t.ez.x*i,r.y=t.ex.y*e+t.ey.y*n+t.ez.y*i,r.z=t.ex.z*e+t.ey.z*n+t.ez.z*i,r},t.MulM33V2=function(t,e,n){var i=e.x,r=e.y;return n.x=t.ex.x*i+t.ey.x*r,n.y=t.ex.y*i+t.ey.y*r,n},t.MulM33XY=function(t,e,n,i){return i.x=t.ex.x*e+t.ey.x*n,i.y=t.ex.y*e+t.ey.y*n,i},t}();Pt.IDENTITY=new Pt;var It=function(){function t(t){void 0===t&&(t=0),this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.s=t.s,this.c=t.c,this},e.SetAngle=function(t){return this.s=Math.sin(t),this.c=Math.cos(t),this},e.SetIdentity=function(){return this.s=0,this.c=1,this},e.GetAngle=function(){return Math.atan2(this.s,this.c)},e.GetXAxis=function(t){return t.x=this.c,t.y=this.s,t},e.GetYAxis=function(t){return t.x=-this.s,t.y=this.c,t},t.MulRR=function(t,e,n){var i=t.c,r=t.s,o=e.c,a=e.s;return n.s=r*o+i*a,n.c=i*o-r*a,n},t.MulTRR=function(t,e,n){var i=t.c,r=t.s,o=e.c,a=e.s;return n.s=i*a-r*o,n.c=i*o+r*a,n},t.MulRV=function(t,e,n){var i=t.c,r=t.s,o=e.x,a=e.y;return n.x=i*o-r*a,n.y=r*o+i*a,n},t.MulTRV=function(t,e,n){var i=t.c,r=t.s,o=e.x,a=e.y;return n.x=i*o+r*a,n.y=-r*o+i*a,n},t}();It.IDENTITY=new It;var Rt=function(){function t(){this.p=new bt,this.q=new It}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.p.Copy(t.p),this.q.Copy(t.q),this},e.SetIdentity=function(){return this.p.SetZero(),this.q.SetIdentity(),this},e.SetPositionRotation=function(t,e){return this.p.Copy(t),this.q.Copy(e),this},e.SetPositionAngle=function(t,e){return this.p.Copy(t),this.q.SetAngle(e),this},e.SetPosition=function(t){return this.p.Copy(t),this},e.SetPositionXY=function(t,e){return this.p.Set(t,e),this},e.SetRotation=function(t){return this.q.Copy(t),this},e.SetRotationAngle=function(t){return this.q.SetAngle(t),this},e.GetPosition=function(){return this.p},e.GetRotation=function(){return this.q},e.GetRotationAngle=function(){return this.q.GetAngle()},e.GetAngle=function(){return this.q.GetAngle()},t.MulXV=function(t,e,n){var i=t.q.c,r=t.q.s,o=e.x,a=e.y;return n.x=i*o-r*a+t.p.x,n.y=r*o+i*a+t.p.y,n},t.MulTXV=function(t,e,n){var i=t.q.c,r=t.q.s,o=e.x-t.p.x,a=e.y-t.p.y;return n.x=i*o+r*a,n.y=-r*o+i*a,n},t.MulXX=function(t,e,n){return It.MulRR(t.q,e.q,n.q),bt.AddVV(It.MulRV(t.q,e.p,n.p),t.p,n.p),n},t.MulTXX=function(t,e,n){return It.MulTRR(t.q,e.q,n.q),It.MulTRV(t.q,bt.SubVV(e.p,t.p,n.p),n.p),n},t}();Rt.IDENTITY=new Rt;var Dt,Bt=function(){function t(){this.localCenter=new bt,this.c0=new bt,this.c=new bt,this.a0=0,this.a=0,this.alpha0=0}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.localCenter.Copy(t.localCenter),this.c0.Copy(t.c0),this.c.Copy(t.c),this.a0=t.a0,this.a=t.a,this.alpha0=t.alpha0,this},e.GetTransform=function(t,e){var n=1-e;t.p.x=n*this.c0.x+e*this.c.x,t.p.y=n*this.c0.y+e*this.c.y;var i=n*this.a0+e*this.a;return t.q.SetAngle(i),t.p.SelfSub(It.MulRV(t.q,this.localCenter,bt.s_t0)),t},e.Advance=function(t){var e=(t-this.alpha0)/(1-this.alpha0),n=1-e;this.c0.x=n*this.c0.x+e*this.c.x,this.c0.y=n*this.c0.y+e*this.c.y,this.a0=n*this.a0+e*this.a,this.alpha0=t},e.Normalize=function(){var t=nt*Math.floor(this.a0/nt);this.a0-=t,this.a-=t},t}(),Mt=function(){function t(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(e[0]instanceof Float32Array){if(4!==e[0].length)throw new Error;this.data=e[0]}else{var i="number"==typeof e[0]?e[0]:.5,r="number"==typeof e[1]?e[1]:.5,o="number"==typeof e[2]?e[2]:.5,a="number"==typeof e[3]?e[3]:1;this.data=new Float32Array([i,r,o,a])}}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},e.IsEqual=function(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a},e.IsZero=function(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a},e.Set=function(t,e,n,i){void 0===i&&(i=this.a),this.SetRGBA(t,e,n,i)},e.SetByteRGB=function(t,e,n){return this.r=t/255,this.g=e/255,this.b=n/255,this},e.SetByteRGBA=function(t,e,n,i){return this.r=t/255,this.g=e/255,this.b=n/255,this.a=i/255,this},e.SetRGB=function(t,e,n){return this.r=t,this.g=e,this.b=n,this},e.SetRGBA=function(t,e,n,i){return this.r=t,this.g=e,this.b=n,this.a=i,this},e.SelfAdd=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},e.Add=function(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e},e.SelfSub=function(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this},e.Sub=function(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e},e.SelfMul=function(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this},e.Mul=function(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,e},e.Mix=function(e,n){t.MixColors(this,e,n)},t.MixColors=function(t,e,n){var i=n*(e.r-t.r),r=n*(e.g-t.g),o=n*(e.b-t.b),a=n*(e.a-t.a);t.r+=i,t.g+=r,t.b+=o,t.a+=a,e.r-=i,e.g-=r,e.b-=o,e.a-=a},e.MakeStyleString=function(e){return void 0===e&&(e=this.a),t.MakeStyleString(this.r,this.g,this.b,e)},t.MakeStyleString=function(t,e,n,i){return void 0===i&&(i=1),t*=255,e*=255,n*=255,i<1?"rgba("+t+","+e+","+n+","+i+")":"rgb("+t+","+e+","+n+")"},N(t,[{key:"r",get:function(){return this.data[0]},set:function(t){this.data[0]=t}},{key:"g",get:function(){return this.data[1]},set:function(t){this.data[1]=t}},{key:"b",get:function(){return this.data[2]},set:function(t){this.data[2]=t}},{key:"a",get:function(){return this.data[3]},set:function(t){this.data[3]=t}}]),t}();Mt.ZERO=new Mt(0,0,0,0),Mt.RED=new Mt(1,0,0),Mt.GREEN=new Mt(0,1,0),Mt.BLUE=new Mt(0,0,1),(Dt=t.b2DrawFlags||(t.b2DrawFlags={}))[Dt.e_none=0]="e_none",Dt[Dt.e_shapeBit=1]="e_shapeBit",Dt[Dt.e_jointBit=2]="e_jointBit",Dt[Dt.e_aabbBit=4]="e_aabbBit",Dt[Dt.e_pairBit=8]="e_pairBit",Dt[Dt.e_centerOfMassBit=16]="e_centerOfMassBit",Dt[Dt.e_particleBit=32]="e_particleBit",Dt[Dt.e_controllerBit=64]="e_controllerBit",Dt[Dt.e_all=63]="e_all";var Ot=function(){function t(){this.m_drawFlags=0}var e=t.prototype;return e.SetFlags=function(t){this.m_drawFlags=t},e.GetFlags=function(){return this.m_drawFlags},e.AppendFlags=function(t){this.m_drawFlags|=t},e.ClearFlags=function(t){this.m_drawFlags&=~t},t}(),Nt=function(){function t(){this.m_start=Date.now()}var e=t.prototype;return e.Reset=function(){return this.m_start=Date.now(),this},e.GetMilliseconds=function(){return Date.now()-this.m_start},t}(),Lt=function(){function t(){this.m_count=0,this.m_min_count=0,this.m_max_count=0}var e=t.prototype;return e.GetCount=function(){return this.m_count},e.GetMinCount=function(){return this.m_min_count},e.GetMaxCount=function(){return this.m_max_count},e.ResetCount=function(){var t=this.m_count;return this.m_count=0,t},e.ResetMinCount=function(){this.m_min_count=0},e.ResetMaxCount=function(){this.m_max_count=0},e.Increment=function(){this.m_count++,this.m_max_count<this.m_count&&(this.m_max_count=this.m_count)},e.Decrement=function(){this.m_count--,this.m_min_count>this.m_count&&(this.m_min_count=this.m_count)},t}(),Ft=function(){function t(t){this.m_stack=[],this.m_count=0,this.m_stack=Q(t,(function(){return null})),this.m_count=0}var e=t.prototype;return e.Reset=function(){return this.m_count=0,this},e.Push=function(t){this.m_stack[this.m_count]=t,this.m_count++},e.Pop=function(){this.m_count--;var t=this.m_stack[this.m_count];if(this.m_stack[this.m_count]=null,null===t)throw new Error;return t},e.GetCount=function(){return this.m_count},t}(),zt=function(){},Vt=function(){},Gt=function(){function t(){this.m_buffer=bt.MakeArray(2),this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0}var e=t.prototype;return e.Copy=function(t){return t.m_vertices===t.m_buffer?(this.m_vertices=this.m_buffer,this.m_buffer[0].Copy(t.m_buffer[0]),this.m_buffer[1].Copy(t.m_buffer[1])):this.m_vertices=t.m_vertices,this.m_count=t.m_count,this.m_radius=t.m_radius,this},e.Reset=function(){return this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0,this},e.SetShape=function(t,e){t.SetupDistanceProxy(this,e)},e.SetVerticesRadius=function(t,e,n){this.m_vertices=t,this.m_count=e,this.m_radius=n},e.GetSupport=function(t){for(var e=0,n=bt.DotVV(this.m_vertices[0],t),i=1;i<this.m_count;++i){var r=bt.DotVV(this.m_vertices[i],t);r>n&&(e=i,n=r)}return e},e.GetSupportVertex=function(t){for(var e=0,n=bt.DotVV(this.m_vertices[0],t),i=1;i<this.m_count;++i){var r=bt.DotVV(this.m_vertices[i],t);r>n&&(e=i,n=r)}return this.m_vertices[e]},e.GetVertexCount=function(){return this.m_count},e.GetVertex=function(t){return this.m_vertices[t]},t}(),Ut=function(){function t(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}return t.prototype.Reset=function(){return this.metric=0,this.count=0,this},t}(),kt=function(){function t(){this.proxyA=new Gt,this.proxyB=new Gt,this.transformA=new Rt,this.transformB=new Rt,this.useRadii=!1}return t.prototype.Reset=function(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this},t}(),Ht=function(){function t(){this.pointA=new bt,this.pointB=new bt,this.distance=0,this.iterations=0}return t.prototype.Reset=function(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this},t}(),jt=function(){this.proxyA=new Gt,this.proxyB=new Gt,this.transformA=new Rt,this.transformB=new Rt,this.translationB=new bt},Wt=function(){this.point=new bt,this.normal=new bt,this.lambda=0,this.iterations=0};function qt(){t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0}t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0;var Xt=function(){function t(){this.wA=new bt,this.wB=new bt,this.w=new bt,this.a=0,this.indexA=0,this.indexB=0}return t.prototype.Copy=function(t){return this.wA.Copy(t.wA),this.wB.Copy(t.wB),this.w.Copy(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB,this},t}(),Yt=function(){function t(){this.m_v1=new Xt,this.m_v2=new Xt,this.m_v3=new Xt,this.m_vertices=[],this.m_count=0,this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3}var e=t.prototype;return e.ReadCache=function(t,e,n,i,o){this.m_count=t.count;for(var a=this.m_vertices,s=0;s<this.m_count;++s){var c=a[s];c.indexA=t.indexA[s],c.indexB=t.indexB[s];var l=e.GetVertex(c.indexA),u=i.GetVertex(c.indexB);Rt.MulXV(n,l,c.wA),Rt.MulXV(o,u,c.wB),bt.SubVV(c.wB,c.wA,c.w),c.a=0}if(this.m_count>1){var h=t.metric,_=this.GetMetric();(_<.5*h||2*h<_||_<r)&&(this.m_count=0)}if(0===this.m_count){var f=a[0];f.indexA=0,f.indexB=0;var p=e.GetVertex(0),d=i.GetVertex(0);Rt.MulXV(n,p,f.wA),Rt.MulXV(o,d,f.wB),bt.SubVV(f.wB,f.wA,f.w),f.a=1,this.m_count=1}},e.WriteCache=function(t){t.metric=this.GetMetric(),t.count=this.m_count;for(var e=this.m_vertices,n=0;n<this.m_count;++n)t.indexA[n]=e[n].indexA,t.indexB[n]=e[n].indexB},e.GetSearchDirection=function(t){switch(this.m_count){case 1:return bt.NegV(this.m_v1.w,t);case 2:var e=bt.SubVV(this.m_v2.w,this.m_v1.w,t);return bt.CrossVV(e,bt.NegV(this.m_v1.w,bt.s_t0))>0?bt.CrossOneV(e,t):bt.CrossVOne(e,t);default:return t.SetZero()}},e.GetClosestPoint=function(t){switch(this.m_count){case 0:return t.SetZero();case 1:return t.Copy(this.m_v1.w);case 2:return t.Set(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);case 3:default:return t.SetZero()}},e.GetWitnessPoints=function(t,e){switch(this.m_count){case 0:break;case 1:t.Copy(this.m_v1.wA),e.Copy(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}},e.GetMetric=function(){switch(this.m_count){case 0:case 1:return 0;case 2:return bt.DistanceVV(this.m_v1.w,this.m_v2.w);case 3:return bt.CrossVV(bt.SubVV(this.m_v2.w,this.m_v1.w,bt.s_t0),bt.SubVV(this.m_v3.w,this.m_v1.w,bt.s_t1));default:return 0}},e.Solve2=function(){var e=this.m_v1.w,n=this.m_v2.w,i=bt.SubVV(n,e,t.s_e12),r=-bt.DotVV(e,i);if(r<=0)return this.m_v1.a=1,void(this.m_count=1);var o=bt.DotVV(n,i);if(o<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);var a=1/(o+r);this.m_v1.a=o*a,this.m_v2.a=r*a,this.m_count=2},e.Solve3=function(){var e=this.m_v1.w,n=this.m_v2.w,i=this.m_v3.w,r=bt.SubVV(n,e,t.s_e12),o=bt.DotVV(e,r),a=bt.DotVV(n,r),s=-o,c=bt.SubVV(i,e,t.s_e13),l=bt.DotVV(e,c),u=bt.DotVV(i,c),h=-l,_=bt.SubVV(i,n,t.s_e23),f=bt.DotVV(n,_),p=bt.DotVV(i,_),d=-f,m=bt.CrossVV(r,c),v=m*bt.CrossVV(n,i),g=m*bt.CrossVV(i,e),y=m*bt.CrossVV(e,n);if(s<=0&&h<=0)return this.m_v1.a=1,void(this.m_count=1);if(a>0&&s>0&&y<=0){var x=1/(a+s);return this.m_v1.a=a*x,this.m_v2.a=s*x,void(this.m_count=2)}if(u>0&&h>0&&g<=0){var S=1/(u+h);return this.m_v1.a=u*S,this.m_v3.a=h*S,this.m_count=2,void this.m_v2.Copy(this.m_v3)}if(a<=0&&d<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);if(u<=0&&p<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v3);if(p>0&&d>0&&v<=0){var A=1/(p+d);return this.m_v2.a=p*A,this.m_v3.a=d*A,this.m_count=2,void this.m_v1.Copy(this.m_v3)}var C=1/(v+g+y);this.m_v1.a=v*C,this.m_v2.a=g*C,this.m_v3.a=y*C,this.m_count=3},t}();Yt.s_e12=new bt,Yt.s_e13=new bt,Yt.s_e23=new bt;var Kt=new Yt,Jt=[0,0,0],Qt=[0,0,0],Zt=new bt,$t=new bt,te=new bt,ee=new bt,ne=new bt;function ie(e,n,i){++t.b2_gjkCalls;var a=i.proxyA,s=i.proxyB,c=i.transformA,l=i.transformB,u=Kt;u.ReadCache(n,a,c,s,l);for(var h=u.m_vertices,_=20,f=Jt,p=Qt,d=0,m=0;m<_;){d=u.m_count;for(var v=0;v<d;++v)f[v]=h[v].indexA,p[v]=h[v].indexB;switch(u.m_count){case 1:break;case 2:u.Solve2();break;case 3:u.Solve3()}if(3===u.m_count)break;var g=u.GetSearchDirection($t);if(g.LengthSquared()<o)break;var y=h[u.m_count];y.indexA=a.GetSupport(It.MulTRV(c.q,bt.NegV(g,bt.s_t0),ee)),Rt.MulXV(c,a.GetVertex(y.indexA),y.wA),y.indexB=s.GetSupport(It.MulTRV(l.q,g,ne)),Rt.MulXV(l,s.GetVertex(y.indexB),y.wB),bt.SubVV(y.wB,y.wA,y.w),++m,++t.b2_gjkIters;for(var x=!1,S=0;S<d;++S)if(y.indexA===f[S]&&y.indexB===p[S]){x=!0;break}if(x)break;++u.m_count}if(t.b2_gjkMaxIters=ot(t.b2_gjkMaxIters,m),u.GetWitnessPoints(e.pointA,e.pointB),e.distance=bt.DistanceVV(e.pointA,e.pointB),e.iterations=m,u.WriteCache(n),i.useRadii){var A=a.m_radius,C=s.m_radius;if(e.distance>A+C&&e.distance>r){e.distance-=A+C;var b=bt.SubVV(e.pointB,e.pointA,te);b.Normalize(),e.pointA.SelfMulAdd(A,b),e.pointB.SelfMulSub(C,b)}else{var T=bt.MidVV(e.pointA,e.pointB,Zt);e.pointA.Copy(T),e.pointB.Copy(T),e.distance=0}}}var re,oe=new bt,ae=new Yt,se=new bt,ce=new bt,le=new bt,ue=new bt,he=new bt,_e=new bt;function fe(t,e){t.iterations=0,t.lambda=1,t.normal.SetZero(),t.point.SetZero();var n=e.proxyA,i=e.proxyB,r=ot(n.m_radius,f)+ot(i.m_radius,f),o=e.transformA,a=e.transformB,s=e.translationB,c=oe.Set(0,0),l=0,u=ae;u.m_count=0;for(var _=u.m_vertices,p=n.GetSupport(It.MulTRV(o.q,bt.NegV(s,bt.s_t1),bt.s_t0)),d=Rt.MulXV(o,n.GetVertex(p),se),m=i.GetSupport(It.MulTRV(a.q,s,bt.s_t0)),v=Rt.MulXV(a,i.GetVertex(m),ce),g=bt.SubVV(d,v,le),y=ot(f,r-f),x=.5*h,S=20,A=0;A<S&&it(g.Length()-y)>x;){t.iterations+=1,p=n.GetSupport(It.MulTRV(o.q,bt.NegV(g,bt.s_t1),bt.s_t0)),d=Rt.MulXV(o,n.GetVertex(p),se),m=i.GetSupport(It.MulTRV(a.q,g,bt.s_t0)),v=Rt.MulXV(a,i.GetVertex(m),ce);var C=bt.SubVV(d,v,ue);g.Normalize();var b=bt.DotVV(g,C),T=bt.DotVV(g,s);if(b-y>l*T){if(T<=0)return!1;if((l=(b-y)/T)>1)return!1;c.Copy(g).SelfNeg(),u.m_count=0}var E=_[u.m_count];switch(E.indexA=m,E.wA.Copy(v).SelfMulAdd(l,s),E.indexB=p,E.wB.Copy(d),E.w.Copy(E.wB).SelfSub(E.wA),E.a=1,u.m_count+=1,u.m_count){case 1:break;case 2:u.Solve2();break;case 3:u.Solve3()}if(3===u.m_count)return!1;u.GetClosestPoint(g),++A}var w=he,P=_e;return u.GetWitnessPoints(w,P),g.LengthSquared()>0&&(c.Copy(g).SelfNeg(),c.Normalize()),t.normal.Copy(c),t.lambda=l,t.iterations=A,!0}(re=t.b2ContactFeatureType||(t.b2ContactFeatureType={}))[re.e_vertex=0]="e_vertex",re[re.e_face=1]="e_face";var pe,de=function(){function t(){this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}return N(t,[{key:"key",get:function(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key},set:function(t){this._key=t,this._key_invalid=!1,this._indexA=255&this._key,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255}},{key:"indexA",get:function(){return this._indexA},set:function(t){this._indexA=t,this._key_invalid=!0}},{key:"indexB",get:function(){return this._indexB},set:function(t){this._indexB=t,this._key_invalid=!0}},{key:"typeA",get:function(){return this._typeA},set:function(t){this._typeA=t,this._key_invalid=!0}},{key:"typeB",get:function(){return this._typeB},set:function(t){this._typeB=t,this._key_invalid=!0}}]),t}(),me=function(){function t(){this.cf=new de}var e=t.prototype;return e.Copy=function(t){return this.key=t.key,this},e.Clone=function(){return(new t).Copy(this)},N(t,[{key:"key",get:function(){return this.cf.key},set:function(t){this.cf.key=t}}]),t}(),ve=function(){function t(){this.localPoint=new bt,this.normalImpulse=0,this.tangentImpulse=0,this.id=new me}t.MakeArray=function(e){return Q(e,(function(){return new t}))};var e=t.prototype;return e.Reset=function(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0},e.Copy=function(t){return this.localPoint.Copy(t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.Copy(t.id),this},t}();(pe=t.b2ManifoldType||(t.b2ManifoldType={}))[pe.e_unknown=-1]="e_unknown",pe[pe.e_circles=0]="e_circles",pe[pe.e_faceA=1]="e_faceA",pe[pe.e_faceB=2]="e_faceB";var ge,ye=function(){function e(){this.points=ve.MakeArray(s),this.localNormal=new bt,this.localPoint=new bt,this.type=t.b2ManifoldType.e_unknown,this.pointCount=0}var n=e.prototype;return n.Reset=function(){for(var e=0;e<s;++e)this.points[e].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=t.b2ManifoldType.e_unknown,this.pointCount=0},n.Copy=function(t){this.pointCount=t.pointCount;for(var e=0;e<s;++e)this.points[e].Copy(t.points[e]);return this.localNormal.Copy(t.localNormal),this.localPoint.Copy(t.localPoint),this.type=t.type,this},n.Clone=function(){return(new e).Copy(this)},e}(),xe=function(){function e(){this.normal=new bt,this.points=bt.MakeArray(s),this.separations=$(s)}return e.prototype.Initialize=function(n,i,r,a,s){if(0!==n.pointCount)switch(n.type){case t.b2ManifoldType.e_circles:this.normal.Set(1,0);var c=Rt.MulXV(i,n.localPoint,e.Initialize_s_pointA),l=Rt.MulXV(a,n.points[0].localPoint,e.Initialize_s_pointB);bt.DistanceSquaredVV(c,l)>o&&bt.SubVV(l,c,this.normal).SelfNormalize();var u=bt.AddVMulSV(c,r,this.normal,e.Initialize_s_cA),h=bt.SubVMulSV(l,s,this.normal,e.Initialize_s_cB);bt.MidVV(u,h,this.points[0]),this.separations[0]=bt.DotVV(bt.SubVV(h,u,bt.s_t0),this.normal);break;case t.b2ManifoldType.e_faceA:It.MulRV(i.q,n.localNormal,this.normal);for(var _=Rt.MulXV(i,n.localPoint,e.Initialize_s_planePoint),f=0;f<n.pointCount;++f){var p=Rt.MulXV(a,n.points[f].localPoint,e.Initialize_s_clipPoint),d=r-bt.DotVV(bt.SubVV(p,_,bt.s_t0),this.normal),m=bt.AddVMulSV(p,d,this.normal,e.Initialize_s_cA),v=bt.SubVMulSV(p,s,this.normal,e.Initialize_s_cB);bt.MidVV(m,v,this.points[f]),this.separations[f]=bt.DotVV(bt.SubVV(v,m,bt.s_t0),this.normal)}break;case t.b2ManifoldType.e_faceB:It.MulRV(a.q,n.localNormal,this.normal);for(var g=Rt.MulXV(a,n.localPoint,e.Initialize_s_planePoint),y=0;y<n.pointCount;++y){var x=Rt.MulXV(i,n.points[y].localPoint,e.Initialize_s_clipPoint),S=s-bt.DotVV(bt.SubVV(x,g,bt.s_t0),this.normal),A=bt.AddVMulSV(x,S,this.normal,e.Initialize_s_cB),C=bt.SubVMulSV(x,r,this.normal,e.Initialize_s_cA);bt.MidVV(C,A,this.points[y]),this.separations[y]=bt.DotVV(bt.SubVV(C,A,bt.s_t0),this.normal)}this.normal.SelfNeg()}},e}();function Se(e,n,i,r){var o;for(o=0;o<i.pointCount;++o){var a=i.points[o].id.key;e[o]=t.b2PointState.b2_removeState;for(var c=0,l=r.pointCount;c<l;++c)if(r.points[c].id.key===a){e[o]=t.b2PointState.b2_persistState;break}}for(;o<s;++o)e[o]=t.b2PointState.b2_nullState;for(o=0;o<r.pointCount;++o){var u=r.points[o].id.key;n[o]=t.b2PointState.b2_addState;for(var h=0,_=i.pointCount;h<_;++h)if(i.points[h].id.key===u){n[o]=t.b2PointState.b2_persistState;break}}for(;o<s;++o)n[o]=t.b2PointState.b2_nullState}xe.Initialize_s_pointA=new bt,xe.Initialize_s_pointB=new bt,xe.Initialize_s_cA=new bt,xe.Initialize_s_cB=new bt,xe.Initialize_s_planePoint=new bt,xe.Initialize_s_clipPoint=new bt,(ge=t.b2PointState||(t.b2PointState={}))[ge.b2_nullState=0]="b2_nullState",ge[ge.b2_addState=1]="b2_addState",ge[ge.b2_persistState=2]="b2_persistState",ge[ge.b2_removeState=3]="b2_removeState";var Ae=function(){function t(){this.v=new bt,this.id=new me}return t.MakeArray=function(e){return Q(e,(function(){return new t}))},t.prototype.Copy=function(t){return this.v.Copy(t.v),this.id.Copy(t.id),this},t}(),Ce=function(){function t(){this.p1=new bt,this.p2=new bt,this.maxFraction=1}return t.prototype.Copy=function(t){return this.p1.Copy(t.p1),this.p2.Copy(t.p2),this.maxFraction=t.maxFraction,this},t}(),be=function(){function t(){this.normal=new bt,this.fraction=0}return t.prototype.Copy=function(t){return this.normal.Copy(t.normal),this.fraction=t.fraction,this},t}(),Te=function(){function t(){this.lowerBound=new bt,this.upperBound=new bt,this.m_cache_center=new bt,this.m_cache_extent=new bt}var e=t.prototype;return e.Copy=function(t){return this.lowerBound.Copy(t.lowerBound),this.upperBound.Copy(t.upperBound),this},e.IsValid=function(){return!(!this.lowerBound.IsValid()||!this.upperBound.IsValid()||this.upperBound.x<this.lowerBound.x||this.upperBound.y<this.lowerBound.y)},e.GetCenter=function(){return bt.MidVV(this.lowerBound,this.upperBound,this.m_cache_center)},e.GetExtents=function(){return bt.ExtVV(this.lowerBound,this.upperBound,this.m_cache_extent)},e.GetPerimeter=function(){return 2*(this.upperBound.x-this.lowerBound.x+(this.upperBound.y-this.lowerBound.y))},e.Combine1=function(t){return this.lowerBound.x=rt(this.lowerBound.x,t.lowerBound.x),this.lowerBound.y=rt(this.lowerBound.y,t.lowerBound.y),this.upperBound.x=ot(this.upperBound.x,t.upperBound.x),this.upperBound.y=ot(this.upperBound.y,t.upperBound.y),this},e.Combine2=function(t,e){return this.lowerBound.x=rt(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=rt(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=ot(t.upperBound.x,e.upperBound.x),this.upperBound.y=ot(t.upperBound.y,e.upperBound.y),this},t.Combine=function(t,e,n){return n.Combine2(t,e),n},e.Contains=function(t){return!(this.lowerBound.x<=t.lowerBound.x||this.lowerBound.y<=t.lowerBound.y||t.upperBound.x<=this.upperBound.x||t.upperBound.y<=this.upperBound.y)},e.RayCast=function(t,e){var n=-i,o=i,a=e.p1.x,s=e.p1.y,c=e.p2.x-e.p1.x,l=e.p2.y-e.p1.y,u=it(c),h=it(l),_=t.normal;if(u<r){if(a<this.lowerBound.x||this.upperBound.x<a)return!1}else{var f=1/c,p=(this.lowerBound.x-a)*f,d=(this.upperBound.x-a)*f,m=-1;if(p>d){var v=p;p=d,d=v,m=1}if(p>n&&(_.x=m,_.y=0,n=p),n>(o=rt(o,d)))return!1}if(h<r){if(s<this.lowerBound.y||this.upperBound.y<s)return!1}else{var g=1/l,y=(this.lowerBound.y-s)*g,x=(this.upperBound.y-s)*g,S=-1;if(y>x){var A=y;y=x,x=A,S=1}if(y>n&&(_.x=0,_.y=S,n=y),n>(o=rt(o,x)))return!1}return!(n<0||e.maxFraction<n||(t.fraction=n,0))},e.TestContain=function(t){return!(t.x<this.lowerBound.x||this.upperBound.x<t.x||t.y<this.lowerBound.y||this.upperBound.y<t.y)},e.TestOverlap=function(t){return!(this.upperBound.x<t.lowerBound.x||this.upperBound.y<t.lowerBound.y||t.upperBound.x<this.lowerBound.x||t.upperBound.y<this.lowerBound.y)},t}();function Ee(t,e){return!(t.upperBound.x<e.lowerBound.x||t.upperBound.y<e.lowerBound.y||e.upperBound.x<t.lowerBound.x||e.upperBound.y<t.lowerBound.y)}function we(e,n,i,r,o){var a=0,s=n[0],c=n[1],l=bt.DotVV(i,s.v)-r,u=bt.DotVV(i,c.v)-r;if(l<=0&&e[a++].Copy(s),u<=0&&e[a++].Copy(c),l*u<0){var h=l/(l-u),_=e[a].v;_.x=s.v.x+h*(c.v.x-s.v.x),_.y=s.v.y+h*(c.v.y-s.v.y);var f=e[a].id;f.cf.indexA=o,f.cf.indexB=s.id.cf.indexB,f.cf.typeA=t.b2ContactFeatureType.e_vertex,f.cf.typeB=t.b2ContactFeatureType.e_face,++a}return a}var Pe=new kt,Ie=new Ut,Re=new Ht;function De(t,e,n,i,o,a){var s=Pe.Reset();s.proxyA.SetShape(t,e),s.proxyB.SetShape(n,i),s.transformA.Copy(o),s.transformB.Copy(a),s.useRadii=!0;var c=Ie.Reset();c.count=0;var l=Re.Reset();return ie(l,c,s),l.distance<10*r}function Be(t){if(null===t)throw new Error;return t}var Me=function(){function t(t){void 0===t&&(t=0),this.m_id=0,this.aabb=new Te,this._userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.m_id=t}var e=t.prototype;return e.Reset=function(){this._userData=null},e.IsLeaf=function(){return null===this.child1},N(t,[{key:"userData",get:function(){if(null===this._userData)throw new Error;return this._userData},set:function(t){if(null!==this._userData)throw new Error;this._userData=t}}]),t}(),Oe=function(){function t(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0,this.m_stack=new Ft(256)}var e=t.prototype;return e.Query=function(t,e){var n=this.m_stack.Reset();for(n.Push(this.m_root);n.GetCount()>0;){var i=n.Pop();if(null!==i&&i.aabb.TestOverlap(t))if(i.IsLeaf()){if(!e(i))return}else n.Push(i.child1),n.Push(i.child2)}},e.QueryPoint=function(t,e){var n=this.m_stack.Reset();for(n.Push(this.m_root);n.GetCount()>0;){var i=n.Pop();if(null!==i&&i.aabb.TestContain(t))if(i.IsLeaf()){if(!e(i))return}else n.Push(i.child1),n.Push(i.child2)}},e.RayCast=function(e,n){var i=e.p1,r=e.p2,o=bt.SubVV(r,i,t.s_r);o.Normalize();var a=bt.CrossOneV(o,t.s_v),s=bt.AbsV(a,t.s_abs_v),c=e.maxFraction,l=t.s_segmentAABB,u=i.x+c*(r.x-i.x),h=i.y+c*(r.y-i.y);l.lowerBound.x=rt(i.x,u),l.lowerBound.y=rt(i.y,h),l.upperBound.x=ot(i.x,u),l.upperBound.y=ot(i.y,h);var _=this.m_stack.Reset();for(_.Push(this.m_root);_.GetCount()>0;){var f=_.Pop();if(null!==f&&Ee(f.aabb,l)){var p=f.aabb.GetCenter(),d=f.aabb.GetExtents();if(!(it(bt.DotVV(a,bt.SubVV(i,p,bt.s_t0)))-bt.DotVV(s,d)>0))if(f.IsLeaf()){var m=t.s_subInput;m.p1.Copy(e.p1),m.p2.Copy(e.p2),m.maxFraction=c;var v=n(m,f);if(0===v)return;v>0&&(c=v,u=i.x+c*(r.x-i.x),h=i.y+c*(r.y-i.y),l.lowerBound.x=rt(i.x,u),l.lowerBound.y=rt(i.y,h),l.upperBound.x=ot(i.x,u),l.upperBound.y=ot(i.y,h))}else _.Push(f.child1),_.Push(f.child2)}}},e.AllocateNode=function(){if(null!==this.m_freeList){var e=this.m_freeList;return this.m_freeList=e.parent,e.parent=null,e.child1=null,e.child2=null,e.height=0,e}return new Me(t.s_node_id++)},e.FreeNode=function(t){t.parent=this.m_freeList,t.child1=null,t.child2=null,t.height=-1,t.Reset(),this.m_freeList=t},e.CreateProxy=function(t,e){var n=this.AllocateNode(),i=l,r=l;return n.aabb.lowerBound.x=t.lowerBound.x-i,n.aabb.lowerBound.y=t.lowerBound.y-r,n.aabb.upperBound.x=t.upperBound.x+i,n.aabb.upperBound.y=t.upperBound.y+r,n.userData=e,n.height=0,this.InsertLeaf(n),n},e.DestroyProxy=function(t){this.RemoveLeaf(t),this.FreeNode(t)},e.MoveProxy=function(t,e,n){if(t.aabb.Contains(e))return!1;this.RemoveLeaf(t);var i=l,r=l;t.aabb.lowerBound.x=e.lowerBound.x-i,t.aabb.lowerBound.y=e.lowerBound.y-r,t.aabb.upperBound.x=e.upperBound.x+i,t.aabb.upperBound.y=e.upperBound.y+r;var o=u*n.x,a=u*n.y;return o<0?t.aabb.lowerBound.x+=o:t.aabb.upperBound.x+=o,a<0?t.aabb.lowerBound.y+=a:t.aabb.upperBound.y+=a,this.InsertLeaf(t),!0},e.InsertLeaf=function(e){if(++this.m_insertionCount,null===this.m_root)return this.m_root=e,void(this.m_root.parent=null);for(var n=e.aabb,i=this.m_root;!i.IsLeaf();){var r=Be(i.child1),o=Be(i.child2),a=i.aabb.GetPerimeter(),s=t.s_combinedAABB;s.Combine2(i.aabb,n);var c=s.GetPerimeter(),l=2*c,u=2*(c-a),h=void 0,_=t.s_aabb,f=void 0;r.IsLeaf()?(_.Combine2(n,r.aabb),h=_.GetPerimeter()+u):(_.Combine2(n,r.aabb),f=r.aabb.GetPerimeter(),h=_.GetPerimeter()-f+u);var p=void 0;if(o.IsLeaf()?(_.Combine2(n,o.aabb),p=_.GetPerimeter()+u):(_.Combine2(n,o.aabb),f=o.aabb.GetPerimeter(),p=_.GetPerimeter()-f+u),l<h&&l<p)break;i=h<p?r:o}var d=i.parent,m=this.AllocateNode();m.parent=d,m.aabb.Combine2(n,i.aabb),m.height=i.height+1,null!==d?(d.child1===i?d.child1=m:d.child2=m,m.child1=i,m.child2=e,i.parent=m,e.parent=m):(m.child1=i,m.child2=e,i.parent=m,e.parent=m,this.m_root=m);for(var v=e.parent;null!==v;){var g=Be((v=this.Balance(v)).child1),y=Be(v.child2);v.height=1+ot(g.height,y.height),v.aabb.Combine2(g.aabb,y.aabb),v=v.parent}},e.RemoveLeaf=function(t){if(t!==this.m_root){var e=Be(t.parent),n=e&&e.parent,i=Be(e.child1===t?e.child2:e.child1);if(null!==n){n.child1===e?n.child1=i:n.child2=i,i.parent=n,this.FreeNode(e);for(var r=n;null!==r;){var o=Be((r=this.Balance(r)).child1),a=Be(r.child2);r.aabb.Combine2(o.aabb,a.aabb),r.height=1+ot(o.height,a.height),r=r.parent}}else this.m_root=i,i.parent=null,this.FreeNode(e)}else this.m_root=null},e.Balance=function(t){if(t.IsLeaf()||t.height<2)return t;var e=Be(t.child1),n=Be(t.child2),i=n.height-e.height;if(i>1){var r=Be(n.child1),o=Be(n.child2);return n.child1=t,n.parent=t.parent,t.parent=n,null!==n.parent?n.parent.child1===t?n.parent.child1=n:n.parent.child2=n:this.m_root=n,r.height>o.height?(n.child2=r,t.child2=o,o.parent=t,t.aabb.Combine2(e.aabb,o.aabb),n.aabb.Combine2(t.aabb,r.aabb),t.height=1+ot(e.height,o.height),n.height=1+ot(t.height,r.height)):(n.child2=o,t.child2=r,r.parent=t,t.aabb.Combine2(e.aabb,r.aabb),n.aabb.Combine2(t.aabb,o.aabb),t.height=1+ot(e.height,r.height),n.height=1+ot(t.height,o.height)),n}if(i<-1){var a=Be(e.child1),s=Be(e.child2);return e.child1=t,e.parent=t.parent,t.parent=e,null!==e.parent?e.parent.child1===t?e.parent.child1=e:e.parent.child2=e:this.m_root=e,a.height>s.height?(e.child2=a,t.child1=s,s.parent=t,t.aabb.Combine2(n.aabb,s.aabb),e.aabb.Combine2(t.aabb,a.aabb),t.height=1+ot(n.height,s.height),e.height=1+ot(t.height,a.height)):(e.child2=s,t.child1=a,a.parent=t,t.aabb.Combine2(n.aabb,a.aabb),e.aabb.Combine2(t.aabb,s.aabb),t.height=1+ot(n.height,a.height),e.height=1+ot(t.height,s.height)),e}return t},e.GetHeight=function(){return null===this.m_root?0:this.m_root.height},t.GetAreaNode=function(e){if(null===e)return 0;if(e.IsLeaf())return 0;var n=e.aabb.GetPerimeter();return(n+=t.GetAreaNode(e.child1))+t.GetAreaNode(e.child2)},e.GetAreaRatio=function(){if(null===this.m_root)return 0;var e=this.m_root.aabb.GetPerimeter();return t.GetAreaNode(this.m_root)/e},t.ComputeHeightNode=function(e){return null===e||e.IsLeaf()?0:1+ot(t.ComputeHeightNode(e.child1),t.ComputeHeightNode(e.child2))},e.ComputeHeight=function(){return t.ComputeHeightNode(this.m_root)},e.ValidateStructure=function(t){if(null!==t&&(this.m_root,!t.IsLeaf())){var e=Be(t.child1),n=Be(t.child2);this.ValidateStructure(e),this.ValidateStructure(n)}},e.ValidateMetrics=function(e){if(null!==e&&!e.IsLeaf()){var n=Be(e.child1),i=Be(e.child2);t.s_aabb.Combine2(n.aabb,i.aabb),this.ValidateMetrics(n),this.ValidateMetrics(i)}},e.Validate=function(){},t.GetMaxBalanceNode=function(t,e){if(null===t)return e;if(t.height<=1)return e;var n=Be(t.child1),i=Be(t.child2);return ot(e,it(i.height-n.height))},e.GetMaxBalance=function(){return t.GetMaxBalanceNode(this.m_root,0)},e.RebuildBottomUp=function(){this.Validate()},t.ShiftOriginNode=function(e,n){if(null!==e&&!(e.height<=1)){var i=e.child1,r=e.child2;t.ShiftOriginNode(i,n),t.ShiftOriginNode(r,n),e.aabb.lowerBound.SelfSub(n),e.aabb.upperBound.SelfSub(n)}},e.ShiftOrigin=function(e){t.ShiftOriginNode(this.m_root,e)},t}();function Ne(t,e,n){var i=t[e];t[e]=t[n],t[n]=i}function Le(t,e){return t<e}function Fe(t,e,n,i){void 0===e&&(e=0),void 0===n&&(n=t.length-e),void 0===i&&(i=Le);for(var r=e,o=[],a=0;;){for(;r+1<n;n++){var s=t[r+Math.floor(Math.random()*(n-r))];o[a++]=n;for(var c=r-1;;){for(;i(t[++c],s););for(;i(s,t[--n]););if(c>=n)break;Ne(t,c,n)}}if(0===a)break;r=n,n=o[--a]}return t}Oe.s_r=new bt,Oe.s_v=new bt,Oe.s_abs_v=new bt,Oe.s_segmentAABB=new Te,Oe.s_subInput=new Ce,Oe.s_combinedAABB=new Te,Oe.s_aabb=new Te,Oe.s_node_id=0;var ze=function(t,e){this.proxyA=t,this.proxyB=e},Ve=function(){function t(){this.m_tree=new Oe,this.m_proxyCount=0,this.m_moveCount=0,this.m_moveBuffer=[],this.m_pairCount=0,this.m_pairBuffer=[]}var e=t.prototype;return e.CreateProxy=function(t,e){var n=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(n),n},e.DestroyProxy=function(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)},e.MoveProxy=function(t,e,n){this.m_tree.MoveProxy(t,e,n)&&this.BufferMove(t)},e.TouchProxy=function(t){this.BufferMove(t)},e.GetProxyCount=function(){return this.m_proxyCount},e.UpdatePairs=function(t){var e=this;this.m_pairCount=0;for(var n=function(t){var n=e.m_moveBuffer[t];if(null===n)return"continue";var i=n.aabb;e.m_tree.Query(i,(function(t){if(t.m_id===n.m_id)return!0;var i,r;if(t.m_id<n.m_id?(i=t,r=n):(i=n,r=t),e.m_pairCount===e.m_pairBuffer.length)e.m_pairBuffer[e.m_pairCount]=new ze(i,r);else{var o=e.m_pairBuffer[e.m_pairCount];o.proxyA=i,o.proxyB=r}return++e.m_pairCount,!0}))},i=0;i<this.m_moveCount;++i)n(i);this.m_moveCount=0,Fe(this.m_pairBuffer,0,this.m_pairCount,Ge);for(var r=0;r<this.m_pairCount;){var o=this.m_pairBuffer[r];for(t(o.proxyA.userData,o.proxyB.userData),++r;r<this.m_pairCount;){var a=this.m_pairBuffer[r];if(a.proxyA.m_id!==o.proxyA.m_id||a.proxyB.m_id!==o.proxyB.m_id)break;++r}}},e.Query=function(t,e){this.m_tree.Query(t,e)},e.QueryPoint=function(t,e){this.m_tree.QueryPoint(t,e)},e.RayCast=function(t,e){this.m_tree.RayCast(t,e)},e.GetTreeHeight=function(){return this.m_tree.GetHeight()},e.GetTreeBalance=function(){return this.m_tree.GetMaxBalance()},e.GetTreeQuality=function(){return this.m_tree.GetAreaRatio()},e.ShiftOrigin=function(t){this.m_tree.ShiftOrigin(t)},e.BufferMove=function(t){this.m_moveBuffer[this.m_moveCount]=t,++this.m_moveCount},e.UnBufferMove=function(t){var e=this.m_moveBuffer.indexOf(t);this.m_moveBuffer[e]=null},t}();function Ge(t,e){return t.proxyA.m_id<e.proxyA.m_id||t.proxyA.m_id===e.proxyA.m_id&&t.proxyB.m_id<e.proxyB.m_id}function Ue(){t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0}t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0;var ke,He=new Rt,je=new Rt,We=new bt,qe=new bt,Xe=new bt,Ye=new bt,Ke=new bt,Je=function(){this.proxyA=new Gt,this.proxyB=new Gt,this.sweepA=new Bt,this.sweepB=new Bt,this.tMax=0};(ke=t.b2TOIOutputState||(t.b2TOIOutputState={}))[ke.e_unknown=0]="e_unknown",ke[ke.e_failed=1]="e_failed",ke[ke.e_overlapped=2]="e_overlapped",ke[ke.e_touching=3]="e_touching",ke[ke.e_separated=4]="e_separated";var Qe,Ze=function(){this.state=t.b2TOIOutputState.e_unknown,this.t=0};(Qe=t.b2SeparationFunctionType||(t.b2SeparationFunctionType={}))[Qe.e_unknown=-1]="e_unknown",Qe[Qe.e_points=0]="e_points",Qe[Qe.e_faceA=1]="e_faceA",Qe[Qe.e_faceB=2]="e_faceB";var $e=function(){function e(){this.m_sweepA=new Bt,this.m_sweepB=new Bt,this.m_type=t.b2SeparationFunctionType.e_unknown,this.m_localPoint=new bt,this.m_axis=new bt}var n=e.prototype;return n.Initialize=function(e,n,i,r,o,a){this.m_proxyA=n,this.m_proxyB=r;var s=e.count;this.m_sweepA.Copy(i),this.m_sweepB.Copy(o);var c=He,l=je;if(this.m_sweepA.GetTransform(c,a),this.m_sweepB.GetTransform(l,a),1===s){this.m_type=t.b2SeparationFunctionType.e_points;var u=this.m_proxyA.GetVertex(e.indexA[0]),h=this.m_proxyB.GetVertex(e.indexB[0]),_=Rt.MulXV(c,u,We),f=Rt.MulXV(l,h,qe);bt.SubVV(f,_,this.m_axis);var p=this.m_axis.Normalize();return this.m_localPoint.SetZero(),p}if(e.indexA[0]===e.indexA[1]){this.m_type=t.b2SeparationFunctionType.e_faceB;var d=this.m_proxyB.GetVertex(e.indexB[0]),m=this.m_proxyB.GetVertex(e.indexB[1]);bt.CrossVOne(bt.SubVV(m,d,bt.s_t0),this.m_axis).SelfNormalize();var v=It.MulRV(l.q,this.m_axis,Xe);bt.MidVV(d,m,this.m_localPoint);var g=Rt.MulXV(l,this.m_localPoint,qe),y=this.m_proxyA.GetVertex(e.indexA[0]),x=Rt.MulXV(c,y,We),S=bt.DotVV(bt.SubVV(x,g,bt.s_t0),v);return S<0&&(this.m_axis.SelfNeg(),S=-S),S}this.m_type=t.b2SeparationFunctionType.e_faceA;var A=this.m_proxyA.GetVertex(e.indexA[0]),C=this.m_proxyA.GetVertex(e.indexA[1]);bt.CrossVOne(bt.SubVV(C,A,bt.s_t0),this.m_axis).SelfNormalize();var b=It.MulRV(c.q,this.m_axis,Xe);bt.MidVV(A,C,this.m_localPoint);var T=Rt.MulXV(c,this.m_localPoint,We),E=this.m_proxyB.GetVertex(e.indexB[0]),w=Rt.MulXV(l,E,qe),P=bt.DotVV(bt.SubVV(w,T,bt.s_t0),b);return P<0&&(this.m_axis.SelfNeg(),P=-P),P},n.FindMinSeparation=function(e,n,i){var r=He,o=je;switch(this.m_sweepA.GetTransform(r,i),this.m_sweepB.GetTransform(o,i),this.m_type){case t.b2SeparationFunctionType.e_points:var a=It.MulTRV(r.q,this.m_axis,Ye),s=It.MulTRV(o.q,bt.NegV(this.m_axis,bt.s_t0),Ke);e[0]=this.m_proxyA.GetSupport(a),n[0]=this.m_proxyB.GetSupport(s);var c=this.m_proxyA.GetVertex(e[0]),l=this.m_proxyB.GetVertex(n[0]),u=Rt.MulXV(r,c,We),h=Rt.MulXV(o,l,qe);return bt.DotVV(bt.SubVV(h,u,bt.s_t0),this.m_axis);case t.b2SeparationFunctionType.e_faceA:var _=It.MulRV(r.q,this.m_axis,Xe),f=Rt.MulXV(r,this.m_localPoint,We),p=It.MulTRV(o.q,bt.NegV(_,bt.s_t0),Ke);e[0]=-1,n[0]=this.m_proxyB.GetSupport(p);var d=this.m_proxyB.GetVertex(n[0]),m=Rt.MulXV(o,d,qe);return bt.DotVV(bt.SubVV(m,f,bt.s_t0),_);case t.b2SeparationFunctionType.e_faceB:var v=It.MulRV(o.q,this.m_axis,Xe),g=Rt.MulXV(o,this.m_localPoint,qe),y=It.MulTRV(r.q,bt.NegV(v,bt.s_t0),Ye);n[0]=-1,e[0]=this.m_proxyA.GetSupport(y);var x=this.m_proxyA.GetVertex(e[0]),S=Rt.MulXV(r,x,We);return bt.DotVV(bt.SubVV(S,g,bt.s_t0),v);default:return e[0]=-1,n[0]=-1,0}},n.Evaluate=function(e,n,i){var r=He,o=je;switch(this.m_sweepA.GetTransform(r,i),this.m_sweepB.GetTransform(o,i),this.m_type){case t.b2SeparationFunctionType.e_points:var a=this.m_proxyA.GetVertex(e),s=this.m_proxyB.GetVertex(n),c=Rt.MulXV(r,a,We),l=Rt.MulXV(o,s,qe);return bt.DotVV(bt.SubVV(l,c,bt.s_t0),this.m_axis);case t.b2SeparationFunctionType.e_faceA:var u=It.MulRV(r.q,this.m_axis,Xe),h=Rt.MulXV(r,this.m_localPoint,We),_=this.m_proxyB.GetVertex(n),f=Rt.MulXV(o,_,qe);return bt.DotVV(bt.SubVV(f,h,bt.s_t0),u);case t.b2SeparationFunctionType.e_faceB:var p=It.MulRV(o.q,this.m_axis,Xe),d=Rt.MulXV(o,this.m_localPoint,qe),m=this.m_proxyA.GetVertex(e),v=Rt.MulXV(r,m,We);return bt.DotVV(bt.SubVV(v,d,bt.s_t0),p);default:return 0}},e}(),tn=new Nt,en=new Ut,nn=new kt,rn=new Ht,on=new $e,an=[0],sn=[0],cn=new Bt,ln=new Bt;function un(e,n){var i=tn.Reset();++t.b2_toiCalls,e.state=t.b2TOIOutputState.e_unknown,e.t=n.tMax;var r=n.proxyA,o=n.proxyB,a=ot(c,ot(r.m_count,o.m_count)),s=cn.Copy(n.sweepA),l=ln.Copy(n.sweepB);s.Normalize(),l.Normalize();var u=n.tMax,_=r.m_radius+o.m_radius,f=ot(h,_-3*h),p=.25*h,d=0,m=20,v=0,g=en;g.count=0;var y=nn;for(y.proxyA.Copy(n.proxyA),y.proxyB.Copy(n.proxyB),y.useRadii=!1;;){var x=He,S=je;s.GetTransform(x,d),l.GetTransform(S,d),y.transformA.Copy(x),y.transformB.Copy(S);var A=rn;if(ie(A,g,y),A.distance<=0){e.state=t.b2TOIOutputState.e_overlapped,e.t=0;break}if(A.distance<f+p){e.state=t.b2TOIOutputState.e_touching,e.t=d;break}var C=on;C.Initialize(g,r,s,o,l,d);for(var b=!1,T=u,E=0;;){var w=an,P=sn,I=C.FindMinSeparation(w,P,T);if(I>f+p){e.state=t.b2TOIOutputState.e_separated,e.t=u,b=!0;break}if(I>f-p){d=T;break}var R=C.Evaluate(w[0],P[0],d);if(R<f-p){e.state=t.b2TOIOutputState.e_failed,e.t=d,b=!0;break}if(R<=f+p){e.state=t.b2TOIOutputState.e_touching,e.t=d,b=!0;break}for(var D=0,B=d,M=T;;){var O=0;O=1&D?B+(f-R)*(M-B)/(I-R):.5*(B+M),++D,++t.b2_toiRootIters;var N=C.Evaluate(w[0],P[0],O);if(it(N-f)<p){T=O;break}if(N>f?(B=O,R=N):(M=O,I=N),50===D)break}if(t.b2_toiMaxRootIters=ot(t.b2_toiMaxRootIters,D),++E===a)break}if(++v,++t.b2_toiIters,b)break;if(v===m){e.state=t.b2TOIOutputState.e_failed,e.t=d;break}}t.b2_toiMaxIters=ot(t.b2_toiMaxIters,v);var L=i.GetMilliseconds();t.b2_toiMaxTime=ot(t.b2_toiMaxTime,L),t.b2_toiTime+=L}var hn=new bt,_n=new bt;function fn(e,n,i,r,o){e.pointCount=0;var a=Rt.MulXV(i,n.m_p,hn),s=Rt.MulXV(o,r.m_p,_n),c=bt.DistanceSquaredVV(a,s),l=n.m_radius+r.m_radius;c>l*l||(e.type=t.b2ManifoldType.e_circles,e.localPoint.Copy(n.m_p),e.localNormal.SetZero(),e.pointCount=1,e.points[0].localPoint.Copy(r.m_p),e.points[0].id.key=0)}var pn=new bt,dn=new bt,mn=new bt;function vn(e,n,o,a,s){e.pointCount=0;for(var c=Rt.MulXV(s,a.m_p,pn),l=Rt.MulTXV(o,c,dn),u=0,h=-i,_=n.m_radius+a.m_radius,f=n.m_count,p=n.m_vertices,d=n.m_normals,m=0;m<f;++m){var v=bt.DotVV(d[m],bt.SubVV(l,p[m],bt.s_t0));if(v>_)return;v>h&&(h=v,u=m)}var g=u,y=(g+1)%f,x=p[g],S=p[y];if(h<r)return e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(d[u]),bt.MidVV(x,S,e.localPoint),e.points[0].localPoint.Copy(a.m_p),void(e.points[0].id.key=0);var A=bt.DotVV(bt.SubVV(l,x,bt.s_t0),bt.SubVV(S,x,bt.s_t1)),C=bt.DotVV(bt.SubVV(l,S,bt.s_t0),bt.SubVV(x,S,bt.s_t1));if(A<=0){if(bt.DistanceSquaredVV(l,x)>_*_)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,bt.SubVV(l,x,e.localNormal).SelfNormalize(),e.localPoint.Copy(x),e.points[0].localPoint.Copy(a.m_p),e.points[0].id.key=0}else if(C<=0){if(bt.DistanceSquaredVV(l,S)>_*_)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,bt.SubVV(l,S,e.localNormal).SelfNormalize(),e.localPoint.Copy(S),e.points[0].localPoint.Copy(a.m_p),e.points[0].id.key=0}else{var b=bt.MidVV(x,S,mn);if(bt.DotVV(bt.SubVV(l,b,bt.s_t1),d[g])>_)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(d[g]).SelfNormalize(),e.localPoint.Copy(b),e.points[0].localPoint.Copy(a.m_p),e.points[0].id.key=0}}var gn=new bt,yn=new bt,xn=new bt,Sn=new bt;function An(t,e,n,r,o){for(var a=t.m_vertices,s=t.m_normals,c=r.m_count,l=r.m_vertices,u=It.MulRV(e.q,s[n],gn),h=It.MulTRV(o.q,u,yn),_=0,f=i,p=0;p<c;++p){var d=bt.DotVV(l[p],h);d<f&&(f=d,_=p)}var m=Rt.MulXV(e,a[n],xn),v=Rt.MulXV(o,l[_],Sn);return bt.DotVV(bt.SubVV(v,m,bt.s_t0),u)}var Cn=new bt,bn=new bt;function Tn(t,e,n,r,o){for(var a=e.m_count,s=e.m_normals,c=bt.SubVV(Rt.MulXV(o,r.m_centroid,bt.s_t0),Rt.MulXV(n,e.m_centroid,bt.s_t1),Cn),l=It.MulTRV(n.q,c,bn),u=0,h=-i,_=0;_<a;++_){var f=bt.DotVV(s[_],l);f>h&&(h=f,u=_)}var p=An(e,n,u,r,o),d=(u+a-1)%a,m=An(e,n,d,r,o),v=(u+1)%a,g=An(e,n,v,r,o),y=0,x=0,S=0;if(m>p&&m>g)S=-1,y=d,x=m;else{if(!(g>p))return t[0]=u,p;S=1,y=v,x=g}for(;(p=An(e,n,u=-1===S?(y+a-1)%a:(y+1)%a,r,o))>x;)y=u,x=p;return t[0]=y,x}var En=new bt;function wn(e,n,r,o,a,s){for(var c=n.m_normals,l=a.m_count,u=a.m_vertices,h=a.m_normals,_=It.MulTRV(s.q,It.MulRV(r.q,c[o],bt.s_t0),En),f=0,p=i,d=0;d<l;++d){var m=bt.DotVV(_,h[d]);m<p&&(p=m,f=d)}var v=f,g=(v+1)%l,y=e[0];Rt.MulXV(s,u[v],y.v);var x=y.id.cf;x.indexA=o,x.indexB=v,x.typeA=t.b2ContactFeatureType.e_face,x.typeB=t.b2ContactFeatureType.e_vertex;var S=e[1];Rt.MulXV(s,u[g],S.v);var A=S.id.cf;A.indexA=o,A.indexB=g,A.typeA=t.b2ContactFeatureType.e_face,A.typeB=t.b2ContactFeatureType.e_vertex}var Pn=Ae.MakeArray(2),In=Ae.MakeArray(2),Rn=Ae.MakeArray(2),Dn=[0],Bn=[0],Mn=new bt,On=new bt,Nn=new bt,Ln=new bt,Fn=new bt,zn=new bt,Vn=new bt,Gn=new bt;function Un(e,n,i,r,o){e.pointCount=0;var a=n.m_radius+r.m_radius,c=Dn;c[0]=0;var l=Tn(c,n,i,r,o);if(!(l>a)){var u=Bn;u[0]=0;var h=Tn(u,r,o,n,i);if(!(h>a)){var _,f,p,d,m=0,v=0;h>.98*l+.001?(_=r,f=n,p=o,d=i,m=u[0],e.type=t.b2ManifoldType.e_faceB,v=1):(_=n,f=r,p=i,d=o,m=c[0],e.type=t.b2ManifoldType.e_faceA,v=0);var g=Pn;wn(g,_,p,m,f,d);var y=_.m_count,x=_.m_vertices,S=m,A=(m+1)%y,C=x[S],b=x[A],T=bt.SubVV(b,C,Mn);T.Normalize();var E=bt.CrossVOne(T,On),w=bt.MidVV(C,b,Nn),P=It.MulRV(p.q,T,Fn),I=bt.CrossVOne(P,Ln),R=Rt.MulXV(p,C,Vn),D=Rt.MulXV(p,b,Gn),B=bt.DotVV(I,R),M=-bt.DotVV(P,R)+a,O=bt.DotVV(P,D)+a,N=In,L=Rn;if(!(we(N,g,bt.NegV(P,zn),M,S)<2||we(L,N,P,O,A)<2)){e.localNormal.Copy(E),e.localPoint.Copy(w);for(var F=0,z=0;z<s;++z){var V=L[z];if(bt.DotVV(I,V.v)-B<=a){var G=e.points[F];if(Rt.MulTXV(d,V.v,G.localPoint),G.id.Copy(V.id),v){var U=G.id.cf;G.id.cf.indexA=U.indexB,G.id.cf.indexB=U.indexA,G.id.cf.typeA=U.typeB,G.id.cf.typeB=U.typeA}++F}}e.pointCount=F}}}}var kn,Hn=new bt,jn=new bt,Wn=new bt,qn=new bt,Xn=new bt,Yn=new bt,Kn=new bt,Jn=new me;function Qn(e,n,i,r,o){e.pointCount=0;var a=Rt.MulTXV(i,Rt.MulXV(o,r.m_p,bt.s_t0),Hn),s=n.m_vertex1,c=n.m_vertex2,l=bt.SubVV(c,s,jn),u=bt.DotVV(l,bt.SubVV(c,a,bt.s_t0)),h=bt.DotVV(l,bt.SubVV(a,s,bt.s_t0)),_=n.m_radius+r.m_radius,f=Jn;if(f.cf.indexB=0,f.cf.typeB=t.b2ContactFeatureType.e_vertex,h<=0){var p=s,d=bt.SubVV(a,p,Wn);if(bt.DotVV(d,d)>_*_)return;if(n.m_hasVertex0){var m=n.m_vertex0,v=s,g=bt.SubVV(v,m,qn);if(bt.DotVV(g,bt.SubVV(v,a,bt.s_t0))>0)return}return f.cf.indexA=0,f.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(p),e.points[0].id.Copy(f),void e.points[0].localPoint.Copy(r.m_p)}if(u<=0){var y=c,x=bt.SubVV(a,y,Wn);if(bt.DotVV(x,x)>_*_)return;if(n.m_hasVertex3){var S=n.m_vertex3,A=c,C=bt.SubVV(S,A,Xn);if(bt.DotVV(C,bt.SubVV(a,A,bt.s_t0))>0)return}return f.cf.indexA=1,f.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(y),e.points[0].id.Copy(f),void e.points[0].localPoint.Copy(r.m_p)}var b=bt.DotVV(l,l),T=Yn;T.x=1/b*(u*s.x+h*c.x),T.y=1/b*(u*s.y+h*c.y);var E=bt.SubVV(a,T,Wn);if(!(bt.DotVV(E,E)>_*_)){var w=Kn.Set(-l.y,l.x);bt.DotVV(w,bt.SubVV(a,s,bt.s_t0))<0&&w.Set(-w.x,-w.y),w.Normalize(),f.cf.indexA=0,f.cf.typeA=t.b2ContactFeatureType.e_face,e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(w),e.localPoint.Copy(s),e.points[0].id.Copy(f),e.points[0].localPoint.Copy(r.m_p)}}!function(t){t[t.e_unknown=0]="e_unknown",t[t.e_edgeA=1]="e_edgeA",t[t.e_edgeB=2]="e_edgeB"}(kn||(kn={}));var Zn,$n=function(){this.type=kn.e_unknown,this.index=0,this.separation=0},ti=function(){this.vertices=[],this.normals=[],this.count=0},ei=function(){this.i1=0,this.i2=0,this.v1=new bt,this.v2=new bt,this.normal=new bt,this.sideNormal1=new bt,this.sideOffset1=0,this.sideNormal2=new bt,this.sideOffset2=0};!function(t){t[t.e_isolated=0]="e_isolated",t[t.e_concave=1]="e_concave",t[t.e_convex=2]="e_convex"}(Zn||(Zn={}));var ni=function(){function e(){this.m_polygonB=new ti,this.m_xf=new Rt,this.m_centroidB=new bt,this.m_v0=new bt,this.m_v1=new bt,this.m_v2=new bt,this.m_v3=new bt,this.m_normal0=new bt,this.m_normal1=new bt,this.m_normal2=new bt,this.m_normal=new bt,this.m_type1=Zn.e_isolated,this.m_type2=Zn.e_isolated,this.m_lowerLimit=new bt,this.m_upperLimit=new bt,this.m_radius=0,this.m_front=!1}var n=e.prototype;return n.Collide=function(n,i,r,o,a){Rt.MulTXX(r,a,this.m_xf),Rt.MulXV(this.m_xf,o.m_centroid,this.m_centroidB),this.m_v0.Copy(i.m_vertex0),this.m_v1.Copy(i.m_vertex1),this.m_v2.Copy(i.m_vertex2),this.m_v3.Copy(i.m_vertex3);var c=i.m_hasVertex0,l=i.m_hasVertex3,u=bt.SubVV(this.m_v2,this.m_v1,e.s_edge1);u.Normalize(),this.m_normal1.Set(u.y,-u.x);var h=bt.DotVV(this.m_normal1,bt.SubVV(this.m_centroidB,this.m_v1,bt.s_t0)),_=0,f=0,p=!1,d=!1;if(c){var m=bt.SubVV(this.m_v1,this.m_v0,e.s_edge0);m.Normalize(),this.m_normal0.Set(m.y,-m.x),p=bt.CrossVV(m,u)>=0,_=bt.DotVV(this.m_normal0,bt.SubVV(this.m_centroidB,this.m_v0,bt.s_t0))}if(l){var v=bt.SubVV(this.m_v3,this.m_v2,e.s_edge2);v.Normalize(),this.m_normal2.Set(v.y,-v.x),d=bt.CrossVV(u,v)>0,f=bt.DotVV(this.m_normal2,bt.SubVV(this.m_centroidB,this.m_v2,bt.s_t0))}c&&l?p&&d?(this.m_front=_>=0||h>=0||f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):p?(this.m_front=_>=0||h>=0&&f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):d?(this.m_front=f>=0||_>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):(this.m_front=_>=0&&h>=0&&f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):c?p?(this.m_front=_>=0||h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):(this.m_front=_>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):l?d?(this.m_front=h>=0||f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0&&f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1))),this.m_polygonB.count=o.m_count;for(var g=0;g<o.m_count;++g)this.m_polygonB.vertices.length<=g&&this.m_polygonB.vertices.push(new bt),this.m_polygonB.normals.length<=g&&this.m_polygonB.normals.push(new bt),Rt.MulXV(this.m_xf,o.m_vertices[g],this.m_polygonB.vertices[g]),It.MulRV(this.m_xf.q,o.m_normals[g],this.m_polygonB.normals[g]);this.m_radius=o.m_radius+i.m_radius,n.pointCount=0;var y=this.ComputeEdgeSeparation(e.s_edgeAxis);if(y.type!==kn.e_unknown&&!(y.separation>this.m_radius)){var x=this.ComputePolygonSeparation(e.s_polygonAxis);if(!(x.type!==kn.e_unknown&&x.separation>this.m_radius)){var S,A=.98,C=.001;S=x.type===kn.e_unknown?y:x.separation>A*y.separation+C?x:y;var b=e.s_ie,T=e.s_rf;if(S.type===kn.e_edgeA){n.type=t.b2ManifoldType.e_faceA;for(var E=0,w=bt.DotVV(this.m_normal,this.m_polygonB.normals[0]),P=1;P<this.m_polygonB.count;++P){var I=bt.DotVV(this.m_normal,this.m_polygonB.normals[P]);I<w&&(w=I,E=P)}var R=E,D=(R+1)%this.m_polygonB.count,B=b[0];B.v.Copy(this.m_polygonB.vertices[R]),B.id.cf.indexA=0,B.id.cf.indexB=R,B.id.cf.typeA=t.b2ContactFeatureType.e_face,B.id.cf.typeB=t.b2ContactFeatureType.e_vertex;var M=b[1];M.v.Copy(this.m_polygonB.vertices[D]),M.id.cf.indexA=0,M.id.cf.indexB=D,M.id.cf.typeA=t.b2ContactFeatureType.e_face,M.id.cf.typeB=t.b2ContactFeatureType.e_vertex,this.m_front?(T.i1=0,T.i2=1,T.v1.Copy(this.m_v1),T.v2.Copy(this.m_v2),T.normal.Copy(this.m_normal1)):(T.i1=1,T.i2=0,T.v1.Copy(this.m_v2),T.v2.Copy(this.m_v1),T.normal.Copy(this.m_normal1).SelfNeg())}else{n.type=t.b2ManifoldType.e_faceB;var O=b[0];O.v.Copy(this.m_v1),O.id.cf.indexA=0,O.id.cf.indexB=S.index,O.id.cf.typeA=t.b2ContactFeatureType.e_vertex,O.id.cf.typeB=t.b2ContactFeatureType.e_face;var N=b[1];N.v.Copy(this.m_v2),N.id.cf.indexA=0,N.id.cf.indexB=S.index,N.id.cf.typeA=t.b2ContactFeatureType.e_vertex,N.id.cf.typeB=t.b2ContactFeatureType.e_face,T.i1=S.index,T.i2=(T.i1+1)%this.m_polygonB.count,T.v1.Copy(this.m_polygonB.vertices[T.i1]),T.v2.Copy(this.m_polygonB.vertices[T.i2]),T.normal.Copy(this.m_polygonB.normals[T.i1])}T.sideNormal1.Set(T.normal.y,-T.normal.x),T.sideNormal2.Copy(T.sideNormal1).SelfNeg(),T.sideOffset1=bt.DotVV(T.sideNormal1,T.v1),T.sideOffset2=bt.DotVV(T.sideNormal2,T.v2);var L=e.s_clipPoints1,F=e.s_clipPoints2;if(!(we(L,b,T.sideNormal1,T.sideOffset1,T.i1)<s||we(F,L,T.sideNormal2,T.sideOffset2,T.i2)<s)){S.type===kn.e_edgeA?(n.localNormal.Copy(T.normal),n.localPoint.Copy(T.v1)):(n.localNormal.Copy(o.m_normals[T.i1]),n.localPoint.Copy(o.m_vertices[T.i1]));for(var z=0,V=0;V<s;++V)if(bt.DotVV(T.normal,bt.SubVV(F[V].v,T.v1,bt.s_t0))<=this.m_radius){var G=n.points[z];S.type===kn.e_edgeA?(Rt.MulTXV(this.m_xf,F[V].v,G.localPoint),G.id.Copy(F[V].id)):(G.localPoint.Copy(F[V].v),G.id.cf.typeA=F[V].id.cf.typeB,G.id.cf.typeB=F[V].id.cf.typeA,G.id.cf.indexA=F[V].id.cf.indexB,G.id.cf.indexB=F[V].id.cf.indexA),++z}n.pointCount=z}}}},n.ComputeEdgeSeparation=function(t){var e=t;e.type=kn.e_edgeA,e.index=this.m_front?0:1,e.separation=i;for(var n=0;n<this.m_polygonB.count;++n){var r=bt.DotVV(this.m_normal,bt.SubVV(this.m_polygonB.vertices[n],this.m_v1,bt.s_t0));r<e.separation&&(e.separation=r)}return e},n.ComputePolygonSeparation=function(t){var n=t;n.type=kn.e_unknown,n.index=-1,n.separation=-i;for(var r=e.s_perp.Set(-this.m_normal.y,this.m_normal.x),o=0;o<this.m_polygonB.count;++o){var a=bt.NegV(this.m_polygonB.normals[o],e.s_n),s=rt(bt.DotVV(a,bt.SubVV(this.m_polygonB.vertices[o],this.m_v1,bt.s_t0)),bt.DotVV(a,bt.SubVV(this.m_polygonB.vertices[o],this.m_v2,bt.s_t0)));if(s>this.m_radius)return n.type=kn.e_edgeB,n.index=o,n.separation=s,n;if(bt.DotVV(a,r)>=0){if(bt.DotVV(bt.SubVV(a,this.m_upperLimit,bt.s_t0),this.m_normal)<-_)continue}else if(bt.DotVV(bt.SubVV(a,this.m_lowerLimit,bt.s_t0),this.m_normal)<-_)continue;s>n.separation&&(n.type=kn.e_edgeB,n.index=o,n.separation=s)}return n},e}();ni.s_edge1=new bt,ni.s_edge0=new bt,ni.s_edge2=new bt,ni.s_ie=Ae.MakeArray(2),ni.s_rf=new ei,ni.s_clipPoints1=Ae.MakeArray(2),ni.s_clipPoints2=Ae.MakeArray(2),ni.s_edgeAxis=new $n,ni.s_polygonAxis=new $n,ni.s_n=new bt,ni.s_perp=new bt;var ii=new ni;function ri(t,e,n,i,r){ii.Collide(t,e,n,i,r)}var oi,ai=function(){this.mass=0,this.center=new bt(0,0),this.I=0};(oi=t.b2ShapeType||(t.b2ShapeType={}))[oi.e_unknown=-1]="e_unknown",oi[oi.e_circleShape=0]="e_circleShape",oi[oi.e_edgeShape=1]="e_edgeShape",oi[oi.e_polygonShape=2]="e_polygonShape",oi[oi.e_chainShape=3]="e_chainShape",oi[oi.e_shapeTypeCount=4]="e_shapeTypeCount";var si=function(){function e(e,n){this.m_type=t.b2ShapeType.e_unknown,this.m_radius=0,this.m_type=e,this.m_radius=n}var n=e.prototype;return n.Copy=function(t){return this.m_radius=t.m_radius,this},n.GetType=function(){return this.m_type},e}(),ci=function(e){function n(n){var i;return void 0===n&&(n=0),(i=e.call(this,t.b2ShapeType.e_circleShape,n)||this).m_p=new bt,i}F(n,e);var i=n.prototype;return i.Set=function(t,e){return void 0===e&&(e=this.m_radius),this.m_p.Copy(t),this.m_radius=e,this},i.Clone=function(){return(new n).Copy(this)},i.Copy=function(t){return e.prototype.Copy.call(this,t),this.m_p.Copy(t.m_p),this},i.GetChildCount=function(){return 1},i.TestPoint=function(t,e){var i=Rt.MulXV(t,this.m_p,n.TestPoint_s_center),r=bt.SubVV(e,i,n.TestPoint_s_d);return bt.DotVV(r,r)<=lt(this.m_radius)},i.ComputeDistance=function(t,e,i){var r=Rt.MulXV(t,this.m_p,n.ComputeDistance_s_center);return bt.SubVV(e,r,i),i.Normalize()-this.m_radius},i.RayCast=function(t,e,i){var o=Rt.MulXV(i,this.m_p,n.RayCast_s_position),a=bt.SubVV(e.p1,o,n.RayCast_s_s),s=bt.DotVV(a,a)-lt(this.m_radius),c=bt.SubVV(e.p2,e.p1,n.RayCast_s_r),l=bt.DotVV(a,c),u=bt.DotVV(c,c),h=l*l-u*s;if(h<0||u<r)return!1;var _=-(l+ht(h));return 0<=_&&_<=e.maxFraction*u&&(_/=u,t.fraction=_,bt.AddVMulSV(a,_,c,t.normal).SelfNormalize(),!0)},i.ComputeAABB=function(t,e){var i=Rt.MulXV(e,this.m_p,n.ComputeAABB_s_p);t.lowerBound.Set(i.x-this.m_radius,i.y-this.m_radius),t.upperBound.Set(i.x+this.m_radius,i.y+this.m_radius)},i.ComputeMass=function(t,e){var n=lt(this.m_radius);t.mass=e*a*n,t.center.Copy(this.m_p),t.I=t.mass*(.5*n+bt.DotVV(this.m_p,this.m_p))},i.SetupDistanceProxy=function(t){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_p),t.m_count=1,t.m_radius=this.m_radius},i.ComputeSubmergedArea=function(t,e,n,i){var o=Rt.MulXV(n,this.m_p,new bt),s=-(bt.DotVV(t,o)-e);if(s<-this.m_radius+r)return 0;if(s>this.m_radius)return i.Copy(o),a*this.m_radius*this.m_radius;var c=this.m_radius*this.m_radius,l=s*s,u=c*(gt(s/this.m_radius)+a/2)+s*ht(c-l),h=-2/3*_t(c-l,1.5)/u;return i.x=o.x+t.x*h,i.y=o.y+t.y*h,u},i.Dump=function(t){t("    const shape: b2CircleShape = new b2CircleShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_p.Set(%.15f, %.15f);\n",this.m_p.x,this.m_p.y)},n}(si);ci.TestPoint_s_center=new bt,ci.TestPoint_s_d=new bt,ci.ComputeDistance_s_center=new bt,ci.RayCast_s_position=new bt,ci.RayCast_s_s=new bt,ci.RayCast_s_r=new bt,ci.ComputeAABB_s_p=new bt;var li=function(e){function n(){var n;return(n=e.call(this,t.b2ShapeType.e_polygonShape,f)||this).m_centroid=new bt(0,0),n.m_vertices=[],n.m_normals=[],n.m_count=0,n}F(n,e);var o=n.prototype;return o.Clone=function(){return(new n).Copy(this)},o.Copy=function(t){e.prototype.Copy.call(this,t),this.m_centroid.Copy(t.m_centroid),this.m_count=t.m_count,this.m_vertices=bt.MakeArray(this.m_count),this.m_normals=bt.MakeArray(this.m_count);for(var n=0;n<this.m_count;++n)this.m_vertices[n].Copy(t.m_vertices[n]),this.m_normals[n].Copy(t.m_normals[n]);return this},o.GetChildCount=function(){return 1},o.Set=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if("number"==typeof e[0][0]){var i=e[0];if(i.length%2!=0)throw new Error;return this._Set((function(t){return{x:i[2*t],y:i[2*t+1]}}),i.length/2)}var r=e[0],o=e[1]||r.length;return this._Set((function(t){return r[t]}),o)},o._Set=function(t,e){if(e<3)return this.SetAsBox(1,1);for(var i=e,r=[],o=0;o<i;++o){for(var a=t(o),s=!0,c=0;c<r.length;++c)if(bt.DistanceSquaredVV(a,r[c])<.25*h*h){s=!1;break}s&&r.push(a)}if((i=r.length)<3)return this.SetAsBox(1,1);for(var l=0,u=r[0].x,_=1;_<i;++_){var f=r[_].x;(f>u||f===u&&r[_].y<r[l].y)&&(l=_,u=f)}for(var p=[],d=0,m=l;;){p[d]=m;for(var v=0,g=1;g<i;++g)if(v!==m){var y=bt.SubVV(r[v],r[p[d]],n.Set_s_r),x=bt.SubVV(r[g],r[p[d]],n.Set_s_v),S=bt.CrossVV(y,x);S<0&&(v=g),0===S&&x.LengthSquared()>y.LengthSquared()&&(v=g)}else v=g;if(++d,m=v,v===l)break}this.m_count=d,this.m_vertices=bt.MakeArray(this.m_count),this.m_normals=bt.MakeArray(this.m_count);for(var A=0;A<d;++A)this.m_vertices[A].Copy(r[p[A]]);for(var C=0;C<d;++C){var b=this.m_vertices[C],T=this.m_vertices[(C+1)%d],E=bt.SubVV(T,b,bt.s_t0);bt.CrossVOne(E,this.m_normals[C]).SelfNormalize()}return n.ComputeCentroid(this.m_vertices,d,this.m_centroid),this},o.SetAsBox=function(t,e,n,i){if(void 0===i&&(i=0),this.m_count=4,this.m_vertices=bt.MakeArray(this.m_count),this.m_normals=bt.MakeArray(this.m_count),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero(),n){this.m_centroid.Copy(n);var r=new Rt;r.SetPosition(n),r.SetRotationAngle(i);for(var o=0;o<this.m_count;++o)Rt.MulXV(r,this.m_vertices[o],this.m_vertices[o]),It.MulRV(r.q,this.m_normals[o],this.m_normals[o])}return this},o.TestPoint=function(t,e){for(var i=Rt.MulTXV(t,e,n.TestPoint_s_pLocal),r=0;r<this.m_count;++r)if(bt.DotVV(this.m_normals[r],bt.SubVV(i,this.m_vertices[r],bt.s_t0))>0)return!1;return!0},o.ComputeDistance=function(t,e,r){for(var o=Rt.MulTXV(t,e,n.ComputeDistance_s_pLocal),a=-i,s=n.ComputeDistance_s_normalForMaxDistance.Copy(o),c=0;c<this.m_count;++c){var l=bt.DotVV(this.m_normals[c],bt.SubVV(o,this.m_vertices[c],bt.s_t0));l>a&&(a=l,s.Copy(this.m_normals[c]))}if(a>0){for(var u=n.ComputeDistance_s_minDistance.Copy(s),h=a*a,_=0;_<this.m_count;++_){var f=bt.SubVV(o,this.m_vertices[_],n.ComputeDistance_s_distance),p=f.LengthSquared();h>p&&(u.Copy(f),h=p)}return It.MulRV(t.q,u,r),r.Normalize(),Math.sqrt(h)}return It.MulRV(t.q,s,r),a},o.RayCast=function(t,e,i){for(var r=Rt.MulTXV(i,e.p1,n.RayCast_s_p1),o=Rt.MulTXV(i,e.p2,n.RayCast_s_p2),a=bt.SubVV(o,r,n.RayCast_s_d),s=0,c=e.maxFraction,l=-1,u=0;u<this.m_count;++u){var h=bt.DotVV(this.m_normals[u],bt.SubVV(this.m_vertices[u],r,bt.s_t0)),_=bt.DotVV(this.m_normals[u],a);if(0===_){if(h<0)return!1}else _<0&&h<s*_?(s=h/_,l=u):_>0&&h<c*_&&(c=h/_);if(c<s)return!1}return l>=0&&(t.fraction=s,It.MulRV(i.q,this.m_normals[l],t.normal),!0)},o.ComputeAABB=function(t,e){for(var i=Rt.MulXV(e,this.m_vertices[0],t.lowerBound),r=t.upperBound.Copy(i),o=0;o<this.m_count;++o){var a=Rt.MulXV(e,this.m_vertices[o],n.ComputeAABB_s_v);bt.MinV(a,i,i),bt.MaxV(a,r,r)}var s=this.m_radius;i.SelfSubXY(s,s),r.SelfAddXY(s,s)},o.ComputeMass=function(t,e){for(var i=n.ComputeMass_s_center.SetZero(),r=0,o=0,a=n.ComputeMass_s_s.SetZero(),s=0;s<this.m_count;++s)a.SelfAdd(this.m_vertices[s]);a.SelfMul(1/this.m_count);for(var c=1/3,l=0;l<this.m_count;++l){var u=bt.SubVV(this.m_vertices[l],a,n.ComputeMass_s_e1),h=bt.SubVV(this.m_vertices[(l+1)%this.m_count],a,n.ComputeMass_s_e2),_=bt.CrossVV(u,h),f=.5*_;r+=f,i.SelfAdd(bt.MulSV(f*c,bt.AddVV(u,h,bt.s_t0),bt.s_t1));var p=u.x,d=u.y,m=h.x,v=h.y;o+=.25*c*_*(p*p+m*p+m*m+d*d+v*d+v*v)}t.mass=e*r,i.SelfMul(1/r),bt.AddVV(i,a,t.center),t.I=e*o,t.I+=t.mass*(bt.DotVV(t.center,t.center)-bt.DotVV(i,i))},o.Validate=function(){for(var t=0;t<this.m_count;++t)for(var e=t,i=(t+1)%this.m_count,r=this.m_vertices[e],o=bt.SubVV(this.m_vertices[i],r,n.Validate_s_e),a=0;a<this.m_count;++a)if(a!==e&&a!==i){var s=bt.SubVV(this.m_vertices[a],r,n.Validate_s_v);if(bt.CrossVV(o,s)<0)return!1}return!0},o.SetupDistanceProxy=function(t){t.m_vertices=this.m_vertices,t.m_count=this.m_count,t.m_radius=this.m_radius},o.ComputeSubmergedArea=function(t,e,i,o){for(var a=It.MulTRV(i.q,t,n.ComputeSubmergedArea_s_normalL),s=e-bt.DotVV(t,i.p),c=[],l=0,u=-1,h=-1,_=!1,f=0;f<this.m_count;++f){c[f]=bt.DotVV(a,this.m_vertices[f])-s;var p=c[f]<-r;f>0&&(p?_||(u=f-1,l++):_&&(h=f-1,l++)),_=p}switch(l){case 0:if(_){var d=n.ComputeSubmergedArea_s_md;return this.ComputeMass(d,1),Rt.MulXV(i,d.center,o),d.mass}return 0;case 1:-1===u?u=this.m_count-1:h=this.m_count-1}for(var m,v=(u+1)%this.m_count,g=(h+1)%this.m_count,y=(0-c[u])/(c[v]-c[u]),x=(0-c[h])/(c[g]-c[h]),S=n.ComputeSubmergedArea_s_intoVec.Set(this.m_vertices[u].x*(1-y)+this.m_vertices[v].x*y,this.m_vertices[u].y*(1-y)+this.m_vertices[v].y*y),A=n.ComputeSubmergedArea_s_outoVec.Set(this.m_vertices[h].x*(1-x)+this.m_vertices[g].x*x,this.m_vertices[h].y*(1-x)+this.m_vertices[g].y*x),C=0,b=n.ComputeSubmergedArea_s_center.SetZero(),T=this.m_vertices[v],E=v;E!==g;){m=(E=(E+1)%this.m_count)===g?A:this.m_vertices[E];var w=.5*((T.x-S.x)*(m.y-S.y)-(T.y-S.y)*(m.x-S.x));C+=w,b.x+=w*(S.x+T.x+m.x)/3,b.y+=w*(S.y+T.y+m.y)/3,T=m}return b.SelfMul(1/C),Rt.MulXV(i,b,o),C},o.Dump=function(t){t("    const shape: b2PolygonShape = new b2PolygonShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(var e=0;e<this.m_count;++e)t("    vs[%d] = new b2Vec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.Set(vs, %d);\n",this.m_count)},n.ComputeCentroid=function(t,e,i){var r=i;r.SetZero();for(var o=0,a=n.ComputeCentroid_s_pRef.SetZero(),s=1/3,c=0;c<e;++c){var l=a,u=t[c],h=t[(c+1)%e],_=bt.SubVV(u,l,n.ComputeCentroid_s_e1),f=bt.SubVV(h,l,n.ComputeCentroid_s_e2),p=.5*bt.CrossVV(_,f);o+=p,r.x+=p*s*(l.x+u.x+h.x),r.y+=p*s*(l.y+u.y+h.y)}return r.SelfMul(1/o),r},n}(si);li.Set_s_r=new bt,li.Set_s_v=new bt,li.TestPoint_s_pLocal=new bt,li.ComputeDistance_s_pLocal=new bt,li.ComputeDistance_s_normalForMaxDistance=new bt,li.ComputeDistance_s_minDistance=new bt,li.ComputeDistance_s_distance=new bt,li.RayCast_s_p1=new bt,li.RayCast_s_p2=new bt,li.RayCast_s_d=new bt,li.ComputeAABB_s_v=new bt,li.ComputeMass_s_center=new bt,li.ComputeMass_s_s=new bt,li.ComputeMass_s_e1=new bt,li.ComputeMass_s_e2=new bt,li.Validate_s_e=new bt,li.Validate_s_v=new bt,li.ComputeSubmergedArea_s_normalL=new bt,li.ComputeSubmergedArea_s_md=new ai,li.ComputeSubmergedArea_s_intoVec=new bt,li.ComputeSubmergedArea_s_outoVec=new bt,li.ComputeSubmergedArea_s_center=new bt,li.ComputeCentroid_s_pRef=new bt,li.ComputeCentroid_s_e1=new bt,li.ComputeCentroid_s_e2=new bt;var ui=function(e){function n(){var n;return(n=e.call(this,t.b2ShapeType.e_edgeShape,f)||this).m_vertex1=new bt,n.m_vertex2=new bt,n.m_vertex0=new bt,n.m_vertex3=new bt,n.m_hasVertex0=!1,n.m_hasVertex3=!1,n}F(n,e);var i=n.prototype;return i.Set=function(t,e){return this.m_vertex1.Copy(t),this.m_vertex2.Copy(e),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this},i.Clone=function(){return(new n).Copy(this)},i.Copy=function(t){return e.prototype.Copy.call(this,t),this.m_vertex1.Copy(t.m_vertex1),this.m_vertex2.Copy(t.m_vertex2),this.m_vertex0.Copy(t.m_vertex0),this.m_vertex3.Copy(t.m_vertex3),this.m_hasVertex0=t.m_hasVertex0,this.m_hasVertex3=t.m_hasVertex3,this},i.GetChildCount=function(){return 1},i.TestPoint=function(){return!1},i.ComputeDistance=function(t,e,i){var r=Rt.MulXV(t,this.m_vertex1,n.ComputeDistance_s_v1),o=Rt.MulXV(t,this.m_vertex2,n.ComputeDistance_s_v2),a=bt.SubVV(e,r,n.ComputeDistance_s_d),s=bt.SubVV(o,r,n.ComputeDistance_s_s),c=bt.DotVV(a,s);if(c>0){var l=bt.DotVV(s,s);c>l?bt.SubVV(e,o,a):a.SelfMulSub(c/l,s)}return i.Copy(a),i.Normalize()},i.RayCast=function(t,e,i){var r=Rt.MulTXV(i,e.p1,n.RayCast_s_p1),o=Rt.MulTXV(i,e.p2,n.RayCast_s_p2),a=bt.SubVV(o,r,n.RayCast_s_d),s=this.m_vertex1,c=this.m_vertex2,l=bt.SubVV(c,s,n.RayCast_s_e),u=t.normal.Set(l.y,-l.x).SelfNormalize(),h=bt.DotVV(u,bt.SubVV(s,r,bt.s_t0)),_=bt.DotVV(u,a);if(0===_)return!1;var f=h/_;if(f<0||e.maxFraction<f)return!1;var p=bt.AddVMulSV(r,f,a,n.RayCast_s_q),d=bt.SubVV(c,s,n.RayCast_s_r),m=bt.DotVV(d,d);if(0===m)return!1;var v=bt.DotVV(bt.SubVV(p,s,bt.s_t0),d)/m;return!(v<0||1<v||(t.fraction=f,It.MulRV(i.q,t.normal,t.normal),h>0&&t.normal.SelfNeg(),0))},i.ComputeAABB=function(t,e){var i=Rt.MulXV(e,this.m_vertex1,n.ComputeAABB_s_v1),r=Rt.MulXV(e,this.m_vertex2,n.ComputeAABB_s_v2);bt.MinV(i,r,t.lowerBound),bt.MaxV(i,r,t.upperBound);var o=this.m_radius;t.lowerBound.SelfSubXY(o,o),t.upperBound.SelfAddXY(o,o)},i.ComputeMass=function(t){t.mass=0,bt.MidVV(this.m_vertex1,this.m_vertex2,t.center),t.I=0},i.SetupDistanceProxy=function(t){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertex1),t.m_vertices[1].Copy(this.m_vertex2),t.m_count=2,t.m_radius=this.m_radius},i.ComputeSubmergedArea=function(t,e,n,i){return i.SetZero(),0},i.Dump=function(t){t("    const shape: b2EdgeShape = new b2EdgeShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_vertex0.Set(%.15f, %.15f);\n",this.m_vertex0.x,this.m_vertex0.y),t("    shape.m_vertex1.Set(%.15f, %.15f);\n",this.m_vertex1.x,this.m_vertex1.y),t("    shape.m_vertex2.Set(%.15f, %.15f);\n",this.m_vertex2.x,this.m_vertex2.y),t("    shape.m_vertex3.Set(%.15f, %.15f);\n",this.m_vertex3.x,this.m_vertex3.y),t("    shape.m_hasVertex0 = %s;\n",this.m_hasVertex0),t("    shape.m_hasVertex3 = %s;\n",this.m_hasVertex3)},n}(si);ui.ComputeDistance_s_v1=new bt,ui.ComputeDistance_s_v2=new bt,ui.ComputeDistance_s_d=new bt,ui.ComputeDistance_s_s=new bt,ui.RayCast_s_p1=new bt,ui.RayCast_s_p2=new bt,ui.RayCast_s_d=new bt,ui.RayCast_s_e=new bt,ui.RayCast_s_q=new bt,ui.RayCast_s_r=new bt,ui.ComputeAABB_s_v1=new bt,ui.ComputeAABB_s_v2=new bt;var hi=function(e){function n(){var n;return(n=e.call(this,t.b2ShapeType.e_chainShape,f)||this).m_vertices=[],n.m_count=0,n.m_prevVertex=new bt,n.m_nextVertex=new bt,n.m_hasPrevVertex=!1,n.m_hasNextVertex=!1,n}F(n,e);var i=n.prototype;return i.CreateLoop=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if("number"==typeof e[0][0]){var i=e[0];if(i.length%2!=0)throw new Error;return this._CreateLoop((function(t){return{x:i[2*t],y:i[2*t+1]}}),i.length/2)}var r=e[0],o=e[1]||r.length;return this._CreateLoop((function(t){return r[t]}),o)},i._CreateLoop=function(t,e){if(e<3)return this;this.m_count=e+1,this.m_vertices=bt.MakeArray(this.m_count);for(var n=0;n<e;++n)this.m_vertices[n].Copy(t(n));return this.m_vertices[e].Copy(this.m_vertices[0]),this.m_prevVertex.Copy(this.m_vertices[this.m_count-2]),this.m_nextVertex.Copy(this.m_vertices[1]),this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this},i.CreateChain=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if("number"==typeof e[0][0]){var i=e[0];if(i.length%2!=0)throw new Error;return this._CreateChain((function(t){return{x:i[2*t],y:i[2*t+1]}}),i.length/2)}var r=e[0],o=e[1]||r.length;return this._CreateChain((function(t){return r[t]}),o)},i._CreateChain=function(t,e){this.m_count=e,this.m_vertices=bt.MakeArray(e);for(var n=0;n<e;++n)this.m_vertices[n].Copy(t(n));return this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this.m_prevVertex.SetZero(),this.m_nextVertex.SetZero(),this},i.SetPrevVertex=function(t){return this.m_prevVertex.Copy(t),this.m_hasPrevVertex=!0,this},i.SetNextVertex=function(t){return this.m_nextVertex.Copy(t),this.m_hasNextVertex=!0,this},i.Clone=function(){return(new n).Copy(this)},i.Copy=function(t){return e.prototype.Copy.call(this,t),this._CreateChain((function(e){return t.m_vertices[e]}),t.m_count),this.m_prevVertex.Copy(t.m_prevVertex),this.m_nextVertex.Copy(t.m_nextVertex),this.m_hasPrevVertex=t.m_hasPrevVertex,this.m_hasNextVertex=t.m_hasNextVertex,this},i.GetChildCount=function(){return this.m_count-1},i.GetChildEdge=function(t,e){t.m_radius=this.m_radius,t.m_vertex1.Copy(this.m_vertices[e]),t.m_vertex2.Copy(this.m_vertices[e+1]),e>0?(t.m_vertex0.Copy(this.m_vertices[e-1]),t.m_hasVertex0=!0):(t.m_vertex0.Copy(this.m_prevVertex),t.m_hasVertex0=this.m_hasPrevVertex),e<this.m_count-2?(t.m_vertex3.Copy(this.m_vertices[e+2]),t.m_hasVertex3=!0):(t.m_vertex3.Copy(this.m_nextVertex),t.m_hasVertex3=this.m_hasNextVertex)},i.TestPoint=function(){return!1},i.ComputeDistance=function(t,e,i,r){var o=n.ComputeDistance_s_edgeShape;return this.GetChildEdge(o,r),o.ComputeDistance(t,e,i,0)},i.RayCast=function(t,e,i,r){var o=n.RayCast_s_edgeShape;return o.m_vertex1.Copy(this.m_vertices[r]),o.m_vertex2.Copy(this.m_vertices[(r+1)%this.m_count]),o.RayCast(t,e,i,0)},i.ComputeAABB=function(t,e,i){var r=this.m_vertices[i],o=this.m_vertices[(i+1)%this.m_count],a=Rt.MulXV(e,r,n.ComputeAABB_s_v1),s=Rt.MulXV(e,o,n.ComputeAABB_s_v2);bt.MinV(a,s,t.lowerBound),bt.MaxV(a,s,t.upperBound)},i.ComputeMass=function(t){t.mass=0,t.center.SetZero(),t.I=0},i.SetupDistanceProxy=function(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertices[e]),e+1<this.m_count?t.m_vertices[1].Copy(this.m_vertices[e+1]):t.m_vertices[1].Copy(this.m_vertices[0]),t.m_count=2,t.m_radius=this.m_radius},i.ComputeSubmergedArea=function(t,e,n,i){return i.SetZero(),0},i.Dump=function(t){t("    const shape: b2ChainShape = new b2ChainShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(var e=0;e<this.m_count;++e)t("    vs[%d] = new bVec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.CreateChain(vs, %d);\n",this.m_count),t("    shape.m_prevVertex.Set(%.15f, %.15f);\n",this.m_prevVertex.x,this.m_prevVertex.y),t("    shape.m_nextVertex.Set(%.15f, %.15f);\n",this.m_nextVertex.x,this.m_nextVertex.y),t("    shape.m_hasPrevVertex = %s;\n",this.m_hasPrevVertex?"true":"false"),t("    shape.m_hasNextVertex = %s;\n",this.m_hasNextVertex?"true":"false")},n}(si);hi.ComputeDistance_s_edgeShape=new ui,hi.RayCast_s_edgeShape=new ui,hi.ComputeAABB_s_v1=new bt,hi.ComputeAABB_s_v2=new bt;var _i=function(){function t(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.categoryBits=t.categoryBits,this.maskBits=t.maskBits,this.groupIndex=t.groupIndex||0,this},t}();_i.DEFAULT=new _i;var fi=function(){this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.isSensor=!1,this.filter=new _i},pi=function(){function t(t,e){this.aabb=new Te,this.childIndex=0,this.fixture=t,this.childIndex=e,this.fixture.m_shape.ComputeAABB(this.aabb,this.fixture.m_body.GetTransform(),e),this.treeNode=this.fixture.m_body.m_world.m_contactManager.m_broadPhase.CreateProxy(this.aabb,this)}var e=t.prototype;return e.Reset=function(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.DestroyProxy(this.treeNode)},e.Touch=function(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.TouchProxy(this.treeNode)},e.Synchronize=function(e,n,i){if(e===n)this.fixture.m_shape.ComputeAABB(this.aabb,e,this.childIndex),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,i);else{var r=t.Synchronize_s_aabb1,o=t.Synchronize_s_aabb2;this.fixture.m_shape.ComputeAABB(r,e,this.childIndex),this.fixture.m_shape.ComputeAABB(o,n,this.childIndex),this.aabb.Combine2(r,o),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,i)}},t}();pi.Synchronize_s_aabb1=new Te,pi.Synchronize_s_aabb2=new Te;var di,mi=function(){function t(t,e){this.m_density=0,this.m_next=null,this.m_friction=0,this.m_restitution=0,this.m_proxies=[],this.m_filter=new _i,this.m_isSensor=!1,this.m_userData=null,this.m_body=t,this.m_shape=e.shape.Clone(),this.m_userData=n(e.userData,null),this.m_friction=n(e.friction,.2),this.m_restitution=n(e.restitution,0),this.m_filter.Copy(n(e.filter,_i.DEFAULT)),this.m_isSensor=n(e.isSensor,!1),this.m_density=n(e.density,0)}var e=t.prototype;return e.Reset=function(){},e.GetType=function(){return this.m_shape.GetType()},e.GetShape=function(){return this.m_shape},e.SetSensor=function(t){t!==this.m_isSensor&&(this.m_body.SetAwake(!0),this.m_isSensor=t)},e.IsSensor=function(){return this.m_isSensor},e.SetFilterData=function(t){this.m_filter.Copy(t),this.Refilter()},e.GetFilterData=function(){return this.m_filter},e.Refilter=function(){for(var t=this.m_body.GetContactList();t;){var e=t.contact,n=e.GetFixtureA(),i=e.GetFixtureB();n!==this&&i!==this||e.FlagForFiltering(),t=t.next}this.TouchProxies()},e.GetBody=function(){return this.m_body},e.GetNext=function(){return this.m_next},e.GetUserData=function(){return this.m_userData},e.SetUserData=function(t){this.m_userData=t},e.TestPoint=function(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)},e.ComputeDistance=function(t,e,n){return this.m_shape.ComputeDistance(this.m_body.GetTransform(),t,e,n)},e.RayCast=function(t,e,n){return this.m_shape.RayCast(t,e,this.m_body.GetTransform(),n)},e.GetMassData=function(t){return void 0===t&&(t=new ai),this.m_shape.ComputeMass(t,this.m_density),t},e.SetDensity=function(t){this.m_density=t},e.GetDensity=function(){return this.m_density},e.GetFriction=function(){return this.m_friction},e.SetFriction=function(t){this.m_friction=t},e.GetRestitution=function(){return this.m_restitution},e.SetRestitution=function(t){this.m_restitution=t},e.GetAABB=function(t){return this.m_proxies[t].aabb},e.Dump=function(t,e){t("    const fd: b2FixtureDef = new b2FixtureDef();\n"),t("    fd.friction = %.15f;\n",this.m_friction),t("    fd.restitution = %.15f;\n",this.m_restitution),t("    fd.density = %.15f;\n",this.m_density),t("    fd.isSensor = %s;\n",this.m_isSensor?"true":"false"),t("    fd.filter.categoryBits = %d;\n",this.m_filter.categoryBits),t("    fd.filter.maskBits = %d;\n",this.m_filter.maskBits),t("    fd.filter.groupIndex = %d;\n",this.m_filter.groupIndex),this.m_shape.Dump(t),t("\n"),t("    fd.shape = shape;\n"),t("\n"),t("    bodies[%d].CreateFixture(fd);\n",e)},e.CreateProxies=function(){if(0!==this.m_proxies.length)throw new Error;for(var t=0;t<this.m_shape.GetChildCount();++t)this.m_proxies[t]=new pi(this,t)},e.DestroyProxies=function(){for(var t,e=W(this.m_proxies);!(t=e()).done;)t.value.Reset();this.m_proxies.length=0},e.TouchProxies=function(){for(var t,e=W(this.m_proxies);!(t=e()).done;)t.value.Touch()},e.SynchronizeProxies=function(t,e,n){for(var i,r=W(this.m_proxies);!(i=r()).done;)i.value.Synchronize(t,e,n)},N(t,[{key:"m_proxyCount",get:function(){return this.m_proxies.length}}]),t}();(di=t.b2BodyType||(t.b2BodyType={}))[di.b2_unknown=-1]="b2_unknown",di[di.b2_staticBody=0]="b2_staticBody",di[di.b2_kinematicBody=1]="b2_kinematicBody",di[di.b2_dynamicBody=2]="b2_dynamicBody";var vi,gi,yi=function(){this.type=t.b2BodyType.b2_staticBody,this.position=new bt(0,0),this.angle=0,this.linearVelocity=new bt(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.active=!0,this.userData=null,this.gravityScale=1},xi=function(){function e(e,i){this.m_type=t.b2BodyType.b2_staticBody,this.m_islandFlag=!1,this.m_awakeFlag=!1,this.m_autoSleepFlag=!1,this.m_bulletFlag=!1,this.m_fixedRotationFlag=!1,this.m_activeFlag=!1,this.m_toiFlag=!1,this.m_islandIndex=0,this.m_xf=new Rt,this.m_xf0=new Rt,this.m_sweep=new Bt,this.m_linearVelocity=new bt,this.m_angularVelocity=0,this.m_force=new bt,this.m_torque=0,this.m_prev=null,this.m_next=null,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_jointList=null,this.m_contactList=null,this.m_mass=1,this.m_invMass=1,this.m_I=0,this.m_invI=0,this.m_linearDamping=0,this.m_angularDamping=0,this.m_gravityScale=1,this.m_sleepTime=0,this.m_userData=null,this.m_controllerList=null,this.m_controllerCount=0,this.m_bulletFlag=n(e.bullet,!1),this.m_fixedRotationFlag=n(e.fixedRotation,!1),this.m_autoSleepFlag=n(e.allowSleep,!0),this.m_awakeFlag=n(e.awake,!0),this.m_activeFlag=n(e.active,!0),this.m_world=i,this.m_xf.p.Copy(n(e.position,bt.ZERO)),this.m_xf.q.SetAngle(n(e.angle,0)),this.m_xf0.Copy(this.m_xf),this.m_sweep.localCenter.SetZero(),this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=this.m_sweep.a=this.m_xf.q.GetAngle(),this.m_sweep.alpha0=0,this.m_linearVelocity.Copy(n(e.linearVelocity,bt.ZERO)),this.m_angularVelocity=n(e.angularVelocity,0),this.m_linearDamping=n(e.linearDamping,0),this.m_angularDamping=n(e.angularDamping,0),this.m_gravityScale=n(e.gravityScale,1),this.m_force.SetZero(),this.m_torque=0,this.m_sleepTime=0,this.m_type=n(e.type,t.b2BodyType.b2_staticBody),e.type===t.b2BodyType.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_userData=e.userData,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_controllerList=null,this.m_controllerCount=0}var i=e.prototype;return i.CreateFixture=function(t,e){return void 0===e&&(e=0),t instanceof si?this.CreateFixtureShapeDensity(t,e):this.CreateFixtureDef(t)},i.CreateFixtureDef=function(t){if(this.m_world.IsLocked())throw new Error;var e=new mi(this,t);return this.m_activeFlag&&e.CreateProxies(),e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_density>0&&this.ResetMassData(),this.m_world.m_newFixture=!0,e},i.CreateFixtureShapeDensity=function(t,n){void 0===n&&(n=0);var i=e.CreateFixtureShapeDensity_s_def;return i.shape=t,i.density=n,this.CreateFixtureDef(i)},i.DestroyFixture=function(t){if(this.m_world.IsLocked())throw new Error;for(var e=this.m_fixtureList,n=null;null!==e;){if(e===t){n?n.m_next=t.m_next:this.m_fixtureList=t.m_next;break}n=e,e=e.m_next}for(var i=this.m_contactList;i;){var r=i.contact;i=i.next;var o=r.GetFixtureA(),a=r.GetFixtureB();t!==o&&t!==a||this.m_world.m_contactManager.Destroy(r)}this.m_activeFlag&&t.DestroyProxies(),t.m_next=null,t.Reset(),--this.m_fixtureCount,this.ResetMassData()},i.SetTransformVec=function(t,e){this.SetTransformXY(t.x,t.y,e)},i.SetTransformXY=function(t,e,n){if(this.m_world.IsLocked())throw new Error;this.m_xf.q.SetAngle(n),this.m_xf.p.Set(t,e),this.m_xf0.Copy(this.m_xf),Rt.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.a=n,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_sweep.a0=n;for(var i=this.m_fixtureList;i;i=i.m_next)i.SynchronizeProxies(this.m_xf,this.m_xf,bt.ZERO);this.m_world.m_contactManager.FindNewContacts()},i.SetTransform=function(t){this.SetTransformVec(t.p,t.GetAngle())},i.GetTransform=function(){return this.m_xf},i.GetPosition=function(){return this.m_xf.p},i.SetPosition=function(t){this.SetTransformVec(t,this.GetAngle())},i.SetPositionXY=function(t,e){this.SetTransformXY(t,e,this.GetAngle())},i.GetAngle=function(){return this.m_sweep.a},i.SetAngle=function(t){this.SetTransformVec(this.GetPosition(),t)},i.GetWorldCenter=function(){return this.m_sweep.c},i.GetLocalCenter=function(){return this.m_sweep.localCenter},i.SetLinearVelocity=function(e){this.m_type!==t.b2BodyType.b2_staticBody&&(bt.DotVV(e,e)>0&&this.SetAwake(!0),this.m_linearVelocity.Copy(e))},i.GetLinearVelocity=function(){return this.m_linearVelocity},i.SetAngularVelocity=function(e){this.m_type!==t.b2BodyType.b2_staticBody&&(e*e>0&&this.SetAwake(!0),this.m_angularVelocity=e)},i.GetAngularVelocity=function(){return this.m_angularVelocity},i.GetDefinition=function(t){return t.type=this.GetType(),t.allowSleep=this.m_autoSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.gravityScale=this.m_gravityScale,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=this.m_fixedRotationFlag,t.bullet=this.m_bulletFlag,t.awake=this.m_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.Copy(this.GetLinearVelocity()),t.position.Copy(this.GetPosition()),t.userData=this.GetUserData(),t},i.ApplyForce=function(e,n,i){void 0===i&&(i=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y,this.m_torque+=(n.x-this.m_sweep.c.x)*e.y-(n.y-this.m_sweep.c.y)*e.x))},i.ApplyForceToCenter=function(e,n){void 0===n&&(n=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y))},i.ApplyTorque=function(e,n){void 0===n&&(n=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_torque+=e))},i.ApplyLinearImpulse=function(e,n,i){void 0===i&&(i=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y,this.m_angularVelocity+=this.m_invI*((n.x-this.m_sweep.c.x)*e.y-(n.y-this.m_sweep.c.y)*e.x)))},i.ApplyLinearImpulseToCenter=function(e,n){void 0===n&&(n=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y))},i.ApplyAngularImpulse=function(e,n){void 0===n&&(n=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*e))},i.GetMass=function(){return this.m_mass},i.GetInertia=function(){return this.m_I+this.m_mass*bt.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter)},i.GetMassData=function(t){return t.mass=this.m_mass,t.I=this.m_I+this.m_mass*bt.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter),t.center.Copy(this.m_sweep.localCenter),t},i.SetMassData=function(n){if(this.m_world.IsLocked())throw new Error;if(this.m_type===t.b2BodyType.b2_dynamicBody){this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=n.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,n.I>0&&!this.m_fixedRotationFlag&&(this.m_I=n.I-this.m_mass*bt.DotVV(n.center,n.center),this.m_invI=1/this.m_I);var i=e.SetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(n.center),Rt.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),bt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,bt.SubVV(this.m_sweep.c,i,bt.s_t0),this.m_linearVelocity)}},i.ResetMassData=function(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type===t.b2BodyType.b2_staticBody||this.m_type===t.b2BodyType.b2_kinematicBody)return this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),void(this.m_sweep.a0=this.m_sweep.a);for(var n=e.ResetMassData_s_localCenter.SetZero(),i=this.m_fixtureList;i;i=i.m_next)if(0!==i.m_density){var r=i.GetMassData(e.ResetMassData_s_massData);this.m_mass+=r.mass,n.x+=r.center.x*r.mass,n.y+=r.center.y*r.mass,this.m_I+=r.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,n.x*=this.m_invMass,n.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&!this.m_fixedRotationFlag?(this.m_I-=this.m_mass*bt.DotVV(n,n),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);var o=e.ResetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(n),Rt.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),bt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,bt.SubVV(this.m_sweep.c,o,bt.s_t0),this.m_linearVelocity)},i.GetWorldPoint=function(t,e){return Rt.MulXV(this.m_xf,t,e)},i.GetWorldVector=function(t,e){return It.MulRV(this.m_xf.q,t,e)},i.GetLocalPoint=function(t,e){return Rt.MulTXV(this.m_xf,t,e)},i.GetLocalVector=function(t,e){return It.MulTRV(this.m_xf.q,t,e)},i.GetLinearVelocityFromWorldPoint=function(t,e){return bt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,bt.SubVV(t,this.m_sweep.c,bt.s_t0),e)},i.GetLinearVelocityFromLocalPoint=function(t,e){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(t,e),e)},i.GetLinearDamping=function(){return this.m_linearDamping},i.SetLinearDamping=function(t){this.m_linearDamping=t},i.GetAngularDamping=function(){return this.m_angularDamping},i.SetAngularDamping=function(t){this.m_angularDamping=t},i.GetGravityScale=function(){return this.m_gravityScale},i.SetGravityScale=function(t){this.m_gravityScale=t},i.SetType=function(e){if(this.m_world.IsLocked())throw new Error;if(this.m_type!==e){this.m_type=e,this.ResetMassData(),this.m_type===t.b2BodyType.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_sweep.a0=this.m_sweep.a,this.m_sweep.c0.Copy(this.m_sweep.c),this.SynchronizeFixtures()),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;for(var n=this.m_contactList;n;){var i=n;n=n.next,this.m_world.m_contactManager.Destroy(i.contact)}this.m_contactList=null;for(var r=this.m_fixtureList;r;r=r.m_next)r.TouchProxies()}},i.GetType=function(){return this.m_type},i.SetBullet=function(t){this.m_bulletFlag=t},i.IsBullet=function(){return this.m_bulletFlag},i.SetSleepingAllowed=function(t){this.m_autoSleepFlag=t,t||this.SetAwake(!0)},i.IsSleepingAllowed=function(){return this.m_autoSleepFlag},i.SetAwake=function(t){t?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)},i.IsAwake=function(){return this.m_awakeFlag},i.SetActive=function(t){if(this.m_world.IsLocked())throw new Error;if(t!==this.IsActive())if(this.m_activeFlag=t,t)for(var e=this.m_fixtureList;e;e=e.m_next)e.CreateProxies();else{for(var n=this.m_fixtureList;n;n=n.m_next)n.DestroyProxies();for(var i=this.m_contactList;i;){var r=i;i=i.next,this.m_world.m_contactManager.Destroy(r.contact)}this.m_contactList=null}},i.IsActive=function(){return this.m_activeFlag},i.SetFixedRotation=function(t){this.m_fixedRotationFlag!==t&&(this.m_fixedRotationFlag=t,this.m_angularVelocity=0,this.ResetMassData())},i.IsFixedRotation=function(){return this.m_fixedRotationFlag},i.GetFixtureList=function(){return this.m_fixtureList},i.GetJointList=function(){return this.m_jointList},i.GetContactList=function(){return this.m_contactList},i.GetNext=function(){return this.m_next},i.GetUserData=function(){return this.m_userData},i.SetUserData=function(t){this.m_userData=t},i.GetWorld=function(){return this.m_world},i.Dump=function(e){var n=this.m_islandIndex;e("{\n"),e("  const bd: b2BodyDef = new b2BodyDef();\n");var i="";switch(this.m_type){case t.b2BodyType.b2_staticBody:i="b2BodyType.b2_staticBody";break;case t.b2BodyType.b2_kinematicBody:i="b2BodyType.b2_kinematicBody";break;case t.b2BodyType.b2_dynamicBody:i="b2BodyType.b2_dynamicBody"}e("  bd.type = %s;\n",i),e("  bd.position.Set(%.15f, %.15f);\n",this.m_xf.p.x,this.m_xf.p.y),e("  bd.angle = %.15f;\n",this.m_sweep.a),e("  bd.linearVelocity.Set(%.15f, %.15f);\n",this.m_linearVelocity.x,this.m_linearVelocity.y),e("  bd.angularVelocity = %.15f;\n",this.m_angularVelocity),e("  bd.linearDamping = %.15f;\n",this.m_linearDamping),e("  bd.angularDamping = %.15f;\n",this.m_angularDamping),e("  bd.allowSleep = %s;\n",this.m_autoSleepFlag?"true":"false"),e("  bd.awake = %s;\n",this.m_awakeFlag?"true":"false"),e("  bd.fixedRotation = %s;\n",this.m_fixedRotationFlag?"true":"false"),e("  bd.bullet = %s;\n",this.m_bulletFlag?"true":"false"),e("  bd.active = %s;\n",this.m_activeFlag?"true":"false"),e("  bd.gravityScale = %.15f;\n",this.m_gravityScale),e("\n"),e("  bodies[%d] = this.m_world.CreateBody(bd);\n",this.m_islandIndex),e("\n");for(var r=this.m_fixtureList;r;r=r.m_next)e("  {\n"),r.Dump(e,n),e("  }\n");e("}\n")},i.SynchronizeFixtures=function(){var t=e.SynchronizeFixtures_s_xf1;t.q.SetAngle(this.m_sweep.a0),It.MulRV(t.q,this.m_sweep.localCenter,t.p),bt.SubVV(this.m_sweep.c0,t.p,t.p);for(var n=bt.SubVV(this.m_sweep.c,this.m_sweep.c0,e.SynchronizeFixtures_s_displacement),i=this.m_fixtureList;i;i=i.m_next)i.SynchronizeProxies(t,this.m_xf,n)},i.SynchronizeTransform=function(){this.m_xf.q.SetAngle(this.m_sweep.a),It.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),bt.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)},i.ShouldCollide=function(e){return(this.m_type!==t.b2BodyType.b2_staticBody||e.m_type!==t.b2BodyType.b2_staticBody)&&this.ShouldCollideConnected(e)},i.ShouldCollideConnected=function(t){for(var e=this.m_jointList;e;e=e.next)if(e.other===t&&!e.joint.m_collideConnected)return!1;return!0},i.Advance=function(t){this.m_sweep.Advance(t),this.m_sweep.c.Copy(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_xf.q.SetAngle(this.m_sweep.a),It.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),bt.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)},i.GetControllerList=function(){return this.m_controllerList},i.GetControllerCount=function(){return this.m_controllerCount},e}();xi.CreateFixtureShapeDensity_s_def=new fi,xi.SetMassData_s_oldCenter=new bt,xi.ResetMassData_s_localCenter=new bt,xi.ResetMassData_s_oldCenter=new bt,xi.ResetMassData_s_massData=new ai,xi.SynchronizeFixtures_s_xf1=new Rt,xi.SynchronizeFixtures_s_displacement=new bt,(gi=t.b2JointType||(t.b2JointType={}))[gi.e_unknownJoint=0]="e_unknownJoint",gi[gi.e_revoluteJoint=1]="e_revoluteJoint",gi[gi.e_prismaticJoint=2]="e_prismaticJoint",gi[gi.e_distanceJoint=3]="e_distanceJoint",gi[gi.e_pulleyJoint=4]="e_pulleyJoint",gi[gi.e_mouseJoint=5]="e_mouseJoint",gi[gi.e_gearJoint=6]="e_gearJoint",gi[gi.e_wheelJoint=7]="e_wheelJoint",gi[gi.e_weldJoint=8]="e_weldJoint",gi[gi.e_frictionJoint=9]="e_frictionJoint",gi[gi.e_ropeJoint=10]="e_ropeJoint",gi[gi.e_motorJoint=11]="e_motorJoint",gi[gi.e_areaJoint=12]="e_areaJoint",(vi=t.b2LimitState||(t.b2LimitState={}))[vi.e_inactiveLimit=0]="e_inactiveLimit",vi[vi.e_atLowerLimit=1]="e_atLowerLimit",vi[vi.e_atUpperLimit=2]="e_atUpperLimit",vi[vi.e_equalLimits=3]="e_equalLimits";var Si=function(){function t(){this.linear=new bt,this.angularA=0,this.angularB=0}var e=t.prototype;return e.SetZero=function(){return this.linear.SetZero(),this.angularA=0,this.angularB=0,this},e.Set=function(t,e,n){return this.linear.Copy(t),this.angularA=e,this.angularB=n,this},t}(),Ai=function(){function t(t){this._other=null,this.prev=null,this.next=null,this.joint=t}return t.prototype.Reset=function(){this._other=null,this.prev=null,this.next=null},N(t,[{key:"other",get:function(){if(null===this._other)throw new Error;return this._other},set:function(t){if(null!==this._other)throw new Error;this._other=t}}]),t}(),Ci=function(e){this.type=t.b2JointType.e_unknownJoint,this.userData=null,this.collideConnected=!1,this.type=e},bi=function(){function e(e){this.m_type=t.b2JointType.e_unknownJoint,this.m_prev=null,this.m_next=null,this.m_edgeA=new Ai(this),this.m_edgeB=new Ai(this),this.m_index=0,this.m_islandFlag=!1,this.m_collideConnected=!1,this.m_userData=null,this.m_type=e.type,this.m_edgeA.other=e.bodyB,this.m_edgeB.other=e.bodyA,this.m_bodyA=e.bodyA,this.m_bodyB=e.bodyB,this.m_collideConnected=n(e.collideConnected,!1),this.m_userData=n(e.userData,null)}var i=e.prototype;return i.GetType=function(){return this.m_type},i.GetBodyA=function(){return this.m_bodyA},i.GetBodyB=function(){return this.m_bodyB},i.GetNext=function(){return this.m_next},i.GetUserData=function(){return this.m_userData},i.SetUserData=function(t){this.m_userData=t},i.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()},i.GetCollideConnected=function(){return this.m_collideConnected},i.Dump=function(t){t("// Dump is not supported for this joint type.\n")},i.ShiftOrigin=function(){},e}(),Ti=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_distanceJoint)||this).localAnchorA=new bt,n.localAnchorB=new bt,n.length=1,n.frequencyHz=0,n.dampingRatio=0,n}return F(n,e),n.prototype.Initialize=function(t,e,n,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.length=bt.DistanceVV(n,i),this.frequencyHz=0,this.dampingRatio=0},n}(Ci),Ei=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_frequencyHz=0,i.m_dampingRatio=0,i.m_bias=0,i.m_localAnchorA=new bt,i.m_localAnchorB=new bt,i.m_gamma=0,i.m_impulse=0,i.m_length=0,i.m_indexA=0,i.m_indexB=0,i.m_u=new bt,i.m_rA=new bt,i.m_rB=new bt,i.m_localCenterA=new bt,i.m_localCenterB=new bt,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_mass=0,i.m_qA=new It,i.m_qB=new It,i.m_lalcA=new bt,i.m_lalcB=new bt,i.m_frequencyHz=n(e.frequencyHz,0),i.m_dampingRatio=n(e.dampingRatio,0),i.m_localAnchorA.Copy(e.localAnchorA),i.m_localAnchorB.Copy(e.localAnchorB),i.m_length=e.length,i}F(e,t);var i=e.prototype;return i.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.GetReactionForce=function(t,e){return e.x=t*this.m_impulse*this.m_u.x,e.y=t*this.m_impulse*this.m_u.y,e},i.GetReactionTorque=function(){return 0},i.GetLocalAnchorA=function(){return this.m_localAnchorA},i.GetLocalAnchorB=function(){return this.m_localAnchorB},i.SetLength=function(t){this.m_length=t},i.Length=function(){return this.m_length},i.SetFrequency=function(t){this.m_frequencyHz=t},i.GetFrequency=function(){return this.m_frequencyHz},i.SetDampingRatio=function(t){this.m_dampingRatio=t},i.GetDampingRatio=function(){return this.m_dampingRatio},i.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2DistanceJointDef = new b2DistanceJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.length = %.15f;\n",this.m_length),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,s=t.positions[this.m_indexB].c,c=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v,u=t.velocities[this.m_indexB].w,_=this.m_qA.SetAngle(i),f=this.m_qB.SetAngle(c);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(_,this.m_lalcA,this.m_rA),bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(f,this.m_lalcB,this.m_rB),this.m_u.x=s.x+this.m_rB.x-n.x-this.m_rA.x,this.m_u.y=s.y+this.m_rB.y-n.y-this.m_rA.y;var p=this.m_u.Length();p>h?this.m_u.SelfMul(1/p):this.m_u.SetZero();var d=bt.CrossVV(this.m_rA,this.m_u),m=bt.CrossVV(this.m_rB,this.m_u),v=this.m_invMassA+this.m_invIA*d*d+this.m_invMassB+this.m_invIB*m*m;if(this.m_mass=0!==v?1/v:0,this.m_frequencyHz>0){var g=p-this.m_length,y=2*a*this.m_frequencyHz,x=2*this.m_mass*this.m_dampingRatio*y,S=this.m_mass*y*y,A=t.step.dt;this.m_gamma=A*(x+A*S),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=g*A*S*this.m_gamma,v+=this.m_gamma,this.m_mass=0!==v?1/v:0}else this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;var C=bt.MulSV(this.m_impulse,this.m_u,e.InitVelocityConstraints_s_P);r.SelfMulSub(this.m_invMassA,C),o-=this.m_invIA*bt.CrossVV(this.m_rA,C),l.SelfMulAdd(this.m_invMassB,C),u+=this.m_invIB*bt.CrossVV(this.m_rB,C)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=u},i.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=bt.AddVCrossSV(n,i,this.m_rA,e.SolveVelocityConstraints_s_vpA),s=bt.AddVCrossSV(r,o,this.m_rB,e.SolveVelocityConstraints_s_vpB),c=bt.DotVV(this.m_u,bt.SubVV(s,a,bt.s_t0)),l=-this.m_mass*(c+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=l;var u=bt.MulSV(l,this.m_u,e.SolveVelocityConstraints_s_P);n.SelfMulSub(this.m_invMassA,u),i-=this.m_invIA*bt.CrossVV(this.m_rA,u),r.SelfMulAdd(this.m_invMassB,u),o+=this.m_invIB*bt.CrossVV(this.m_rB,u),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(t){if(this.m_frequencyHz>0)return!0;var n=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),s=this.m_qB.SetAngle(o),c=It.MulRV(a,this.m_lalcA,this.m_rA),l=It.MulRV(s,this.m_lalcB,this.m_rB),u=this.m_u;u.x=r.x+l.x-n.x-c.x,u.y=r.y+l.y-n.y-c.y;var _=this.m_u.Normalize()-this.m_length;_=at(_,-v,v);var f=-this.m_mass*_,p=bt.MulSV(f,u,e.SolvePositionConstraints_s_P);return n.SelfMulSub(this.m_invMassA,p),i-=this.m_invIA*bt.CrossVV(c,p),r.SelfMulAdd(this.m_invMassB,p),o+=this.m_invIB*bt.CrossVV(l,p),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,it(_)<h},e}(bi);Ei.InitVelocityConstraints_s_P=new bt,Ei.SolveVelocityConstraints_s_vpA=new bt,Ei.SolveVelocityConstraints_s_vpB=new bt,Ei.SolveVelocityConstraints_s_P=new bt,Ei.SolvePositionConstraints_s_P=new bt;var wi=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_areaJoint)||this).bodies=[],n.frequencyHz=0,n.dampingRatio=0,n}return F(n,e),n.prototype.AddBody=function(t){this.bodies.push(t),1===this.bodies.length?this.bodyA=t:2===this.bodies.length&&(this.bodyB=t)},n}(Ci),Pi=function(t){function e(e){var i;(i=t.call(this,e)||this).m_frequencyHz=0,i.m_dampingRatio=0,i.m_impulse=0,i.m_targetArea=0,i.m_delta=new bt,i.m_bodies=e.bodies,i.m_frequencyHz=n(e.frequencyHz,0),i.m_dampingRatio=n(e.dampingRatio,0),i.m_targetLengths=$(e.bodies.length),i.m_normals=bt.MakeArray(e.bodies.length),i.m_joints=[],i.m_deltas=bt.MakeArray(e.bodies.length);var r=new Ti;r.frequencyHz=i.m_frequencyHz,r.dampingRatio=i.m_dampingRatio,i.m_targetArea=0;for(var o=0;o<i.m_bodies.length;++o){var a=i.m_bodies[o],s=i.m_bodies[(o+1)%i.m_bodies.length],c=a.GetWorldCenter(),l=s.GetWorldCenter();i.m_targetLengths[o]=bt.DistanceVV(c,l),i.m_targetArea+=bt.CrossVV(c,l),r.Initialize(a,s,c,l),i.m_joints[o]=a.GetWorld().CreateJoint(r)}return i.m_targetArea*=.5,i}F(e,t);var i=e.prototype;return i.GetAnchorA=function(t){return t},i.GetAnchorB=function(t){return t},i.GetReactionForce=function(t,e){return e},i.GetReactionTorque=function(){return 0},i.SetFrequency=function(t){this.m_frequencyHz=t;for(var e=0;e<this.m_joints.length;++e)this.m_joints[e].SetFrequency(t)},i.GetFrequency=function(){return this.m_frequencyHz},i.SetDampingRatio=function(t){this.m_dampingRatio=t;for(var e=0;e<this.m_joints.length;++e)this.m_joints[e].SetDampingRatio(t)},i.GetDampingRatio=function(){return this.m_dampingRatio},i.Dump=function(t){t("Area joint dumping is not supported.\n")},i.InitVelocityConstraints=function(t){for(var e=0;e<this.m_bodies.length;++e){var n=this.m_bodies[(e+this.m_bodies.length-1)%this.m_bodies.length],i=this.m_bodies[(e+1)%this.m_bodies.length],r=t.positions[n.m_islandIndex].c,o=t.positions[i.m_islandIndex].c,a=this.m_deltas[e];bt.SubVV(o,r,a)}if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;for(var s=0;s<this.m_bodies.length;++s){var c=this.m_bodies[s],l=t.velocities[c.m_islandIndex].v,u=this.m_deltas[s];l.x+=c.m_invMass*u.y*.5*this.m_impulse,l.y+=c.m_invMass*-u.x*.5*this.m_impulse}}else this.m_impulse=0},i.SolveVelocityConstraints=function(t){for(var e=0,n=0,i=0;i<this.m_bodies.length;++i){var r=this.m_bodies[i],o=t.velocities[r.m_islandIndex].v,a=this.m_deltas[i];e+=a.LengthSquared()/r.GetMass(),n+=bt.CrossVV(o,a)}var s=-2*n/e;this.m_impulse+=s;for(var c=0;c<this.m_bodies.length;++c){var l=this.m_bodies[c],u=t.velocities[l.m_islandIndex].v,h=this.m_deltas[c];u.x+=l.m_invMass*h.y*.5*s,u.y+=l.m_invMass*-h.x*.5*s}},i.SolvePositionConstraints=function(t){for(var e=0,n=0,i=0;i<this.m_bodies.length;++i){var o=this.m_bodies[i],a=this.m_bodies[(i+1)%this.m_bodies.length],s=t.positions[o.m_islandIndex].c,c=t.positions[a.m_islandIndex].c,l=bt.SubVV(c,s,this.m_delta),u=l.Length();u<r&&(u=1),this.m_normals[i].x=l.y/u,this.m_normals[i].y=-l.x/u,e+=u,n+=bt.CrossVV(s,c)}n*=.5;for(var _=.5*(this.m_targetArea-n)/e,f=!0,p=0;p<this.m_bodies.length;++p){var d=this.m_bodies[p],m=t.positions[d.m_islandIndex].c,g=(p+1)%this.m_bodies.length,y=bt.AddVV(this.m_normals[p],this.m_normals[g],this.m_delta);y.SelfMul(_);var x=y.LengthSquared();x>lt(v)&&y.SelfMul(v/ht(x)),x>lt(h)&&(f=!1),m.x+=y.x,m.y+=y.y}return f},e}(bi),Ii=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_frictionJoint)||this).localAnchorA=new bt,n.localAnchorB=new bt,n.maxForce=0,n.maxTorque=0,n}return F(n,e),n.prototype.Initialize=function(t,e,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB)},n}(Ci),Ri=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_localAnchorA=new bt,i.m_localAnchorB=new bt,i.m_linearImpulse=new bt,i.m_angularImpulse=0,i.m_maxForce=0,i.m_maxTorque=0,i.m_indexA=0,i.m_indexB=0,i.m_rA=new bt,i.m_rB=new bt,i.m_localCenterA=new bt,i.m_localCenterB=new bt,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_linearMass=new wt,i.m_angularMass=0,i.m_qA=new It,i.m_qB=new It,i.m_lalcA=new bt,i.m_lalcB=new bt,i.m_K=new wt,i.m_localAnchorA.Copy(e.localAnchorA),i.m_localAnchorB.Copy(e.localAnchorB),i.m_linearImpulse.SetZero(),i.m_maxForce=n(e.maxForce,0),i.m_maxTorque=n(e.maxTorque,0),i.m_linearMass.SetZero(),i}F(e,t);var i=e.prototype;return i.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.positions[this.m_indexB].a,o=t.velocities[this.m_indexB].v,a=t.velocities[this.m_indexB].w,s=this.m_qA.SetAngle(e),c=this.m_qB.SetAngle(r);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var l=It.MulRV(s,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var u=It.MulRV(c,this.m_lalcB,this.m_rB),h=this.m_invMassA,_=this.m_invMassB,f=this.m_invIA,p=this.m_invIB,d=this.m_K;if(d.ex.x=h+_+f*l.y*l.y+p*u.y*u.y,d.ex.y=-f*l.x*l.y-p*u.x*u.y,d.ey.x=d.ex.y,d.ey.y=h+_+f*l.x*l.x+p*u.x*u.x,d.GetInverse(this.m_linearMass),this.m_angularMass=f+p,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;var m=this.m_linearImpulse;n.SelfMulSub(h,m),i-=f*(bt.CrossVV(this.m_rA,m)+this.m_angularImpulse),o.SelfMulAdd(_,m),a+=p*(bt.CrossVV(this.m_rB,m)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=a},i.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=this.m_invMassA,s=this.m_invMassB,c=this.m_invIA,l=this.m_invIB,u=t.step.dt,h=o-i,_=-this.m_angularMass*h,f=this.m_angularImpulse,p=u*this.m_maxTorque;this.m_angularImpulse=at(this.m_angularImpulse+_,-p,p),i-=c*(_=this.m_angularImpulse-f),o+=l*_;var d=bt.SubVV(bt.AddVCrossSV(r,o,this.m_rB,bt.s_t0),bt.AddVCrossSV(n,i,this.m_rA,bt.s_t1),e.SolveVelocityConstraints_s_Cdot_v2),m=wt.MulMV(this.m_linearMass,d,e.SolveVelocityConstraints_s_impulseV).SelfNeg(),v=e.SolveVelocityConstraints_s_oldImpulseV.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(m);var g=u*this.m_maxForce;this.m_linearImpulse.LengthSquared()>g*g&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(g)),bt.SubVV(this.m_linearImpulse,v,m),n.SelfMulSub(a,m),i-=c*bt.CrossVV(this.m_rA,m),r.SelfMulAdd(s,m),o+=l*bt.CrossVV(this.m_rB,m),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(){return!0},i.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.GetReactionForce=function(t,e){return e.x=t*this.m_linearImpulse.x,e.y=t*this.m_linearImpulse.y,e},i.GetReactionTorque=function(t){return t*this.m_angularImpulse},i.GetLocalAnchorA=function(){return this.m_localAnchorA},i.GetLocalAnchorB=function(){return this.m_localAnchorB},i.SetMaxForce=function(t){this.m_maxForce=t},i.GetMaxForce=function(){return this.m_maxForce},i.SetMaxTorque=function(t){this.m_maxTorque=t},i.GetMaxTorque=function(){return this.m_maxTorque},i.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2FrictionJointDef = new b2FrictionJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},e}(bi);Ri.SolveVelocityConstraints_s_Cdot_v2=new bt,Ri.SolveVelocityConstraints_s_impulseV=new bt,Ri.SolveVelocityConstraints_s_oldImpulseV=new bt;var Di=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_gearJoint)||this).ratio=1,n}return F(n,e),n}(Ci),Bi=function(e){function i(i){var r,o,a;(r=e.call(this,i)||this).m_typeA=t.b2JointType.e_unknownJoint,r.m_typeB=t.b2JointType.e_unknownJoint,r.m_localAnchorA=new bt,r.m_localAnchorB=new bt,r.m_localAnchorC=new bt,r.m_localAnchorD=new bt,r.m_localAxisC=new bt,r.m_localAxisD=new bt,r.m_referenceAngleA=0,r.m_referenceAngleB=0,r.m_constant=0,r.m_ratio=0,r.m_impulse=0,r.m_indexA=0,r.m_indexB=0,r.m_indexC=0,r.m_indexD=0,r.m_lcA=new bt,r.m_lcB=new bt,r.m_lcC=new bt,r.m_lcD=new bt,r.m_mA=0,r.m_mB=0,r.m_mC=0,r.m_mD=0,r.m_iA=0,r.m_iB=0,r.m_iC=0,r.m_iD=0,r.m_JvAC=new bt,r.m_JvBD=new bt,r.m_JwA=0,r.m_JwB=0,r.m_JwC=0,r.m_JwD=0,r.m_mass=0,r.m_qA=new It,r.m_qB=new It,r.m_qC=new It,r.m_qD=new It,r.m_lalcA=new bt,r.m_lalcB=new bt,r.m_lalcC=new bt,r.m_lalcD=new bt,r.m_joint1=i.joint1,r.m_joint2=i.joint2,r.m_typeA=r.m_joint1.GetType(),r.m_typeB=r.m_joint2.GetType(),r.m_bodyC=r.m_joint1.GetBodyA(),r.m_bodyA=r.m_joint1.GetBodyB();var s=r.m_bodyA.m_xf,c=r.m_bodyA.m_sweep.a,l=r.m_bodyC.m_xf,u=r.m_bodyC.m_sweep.a;if(r.m_typeA===t.b2JointType.e_revoluteJoint){var h=i.joint1;r.m_localAnchorC.Copy(h.m_localAnchorA),r.m_localAnchorA.Copy(h.m_localAnchorB),r.m_referenceAngleA=h.m_referenceAngle,r.m_localAxisC.SetZero(),o=c-u-r.m_referenceAngleA}else{var _=i.joint1;r.m_localAnchorC.Copy(_.m_localAnchorA),r.m_localAnchorA.Copy(_.m_localAnchorB),r.m_referenceAngleA=_.m_referenceAngle,r.m_localAxisC.Copy(_.m_localXAxisA);var f=r.m_localAnchorC,p=It.MulTRV(l.q,bt.AddVV(It.MulRV(s.q,r.m_localAnchorA,bt.s_t0),bt.SubVV(s.p,l.p,bt.s_t1),bt.s_t0),bt.s_t0);o=bt.DotVV(bt.SubVV(p,f,bt.s_t0),r.m_localAxisC)}r.m_bodyD=r.m_joint2.GetBodyA(),r.m_bodyB=r.m_joint2.GetBodyB();var d=r.m_bodyB.m_xf,m=r.m_bodyB.m_sweep.a,v=r.m_bodyD.m_xf,g=r.m_bodyD.m_sweep.a;if(r.m_typeB===t.b2JointType.e_revoluteJoint){var y=i.joint2;r.m_localAnchorD.Copy(y.m_localAnchorA),r.m_localAnchorB.Copy(y.m_localAnchorB),r.m_referenceAngleB=y.m_referenceAngle,r.m_localAxisD.SetZero(),a=m-g-r.m_referenceAngleB}else{var x=i.joint2;r.m_localAnchorD.Copy(x.m_localAnchorA),r.m_localAnchorB.Copy(x.m_localAnchorB),r.m_referenceAngleB=x.m_referenceAngle,r.m_localAxisD.Copy(x.m_localXAxisA);var S=r.m_localAnchorD,A=It.MulTRV(v.q,bt.AddVV(It.MulRV(d.q,r.m_localAnchorB,bt.s_t0),bt.SubVV(d.p,v.p,bt.s_t1),bt.s_t0),bt.s_t0);a=bt.DotVV(bt.SubVV(A,S,bt.s_t0),r.m_localAxisD)}return r.m_ratio=n(i.ratio,1),r.m_constant=o+r.m_ratio*a,r.m_impulse=0,r}F(i,e);var r=i.prototype;return r.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_indexC=this.m_bodyC.m_islandIndex,this.m_indexD=this.m_bodyD.m_islandIndex,this.m_lcA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_lcB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_lcC.Copy(this.m_bodyC.m_sweep.localCenter),this.m_lcD.Copy(this.m_bodyD.m_sweep.localCenter),this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;var n=e.positions[this.m_indexA].a,r=e.velocities[this.m_indexA].v,o=e.velocities[this.m_indexA].w,a=e.positions[this.m_indexB].a,s=e.velocities[this.m_indexB].v,c=e.velocities[this.m_indexB].w,l=e.positions[this.m_indexC].a,u=e.velocities[this.m_indexC].v,h=e.velocities[this.m_indexC].w,_=e.positions[this.m_indexD].a,f=e.velocities[this.m_indexD].v,p=e.velocities[this.m_indexD].w,d=this.m_qA.SetAngle(n),m=this.m_qB.SetAngle(a),v=this.m_qC.SetAngle(l),g=this.m_qD.SetAngle(_);if(this.m_mass=0,this.m_typeA===t.b2JointType.e_revoluteJoint)this.m_JvAC.SetZero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{var y=It.MulRV(v,this.m_localAxisC,i.InitVelocityConstraints_s_u);bt.SubVV(this.m_localAnchorC,this.m_lcC,this.m_lalcC);var x=It.MulRV(v,this.m_lalcC,i.InitVelocityConstraints_s_rC);bt.SubVV(this.m_localAnchorA,this.m_lcA,this.m_lalcA);var S=It.MulRV(d,this.m_lalcA,i.InitVelocityConstraints_s_rA);this.m_JvAC.Copy(y),this.m_JwC=bt.CrossVV(x,y),this.m_JwA=bt.CrossVV(S,y),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_typeB===t.b2JointType.e_revoluteJoint)this.m_JvBD.SetZero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{var A=It.MulRV(g,this.m_localAxisD,i.InitVelocityConstraints_s_u);bt.SubVV(this.m_localAnchorD,this.m_lcD,this.m_lalcD);var C=It.MulRV(g,this.m_lalcD,i.InitVelocityConstraints_s_rD);bt.SubVV(this.m_localAnchorB,this.m_lcB,this.m_lalcB);var b=It.MulRV(m,this.m_lalcB,i.InitVelocityConstraints_s_rB);bt.MulSV(this.m_ratio,A,this.m_JvBD),this.m_JwD=this.m_ratio*bt.CrossVV(C,A),this.m_JwB=this.m_ratio*bt.CrossVV(b,A),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,e.step.warmStarting?(r.SelfMulAdd(this.m_mA*this.m_impulse,this.m_JvAC),o+=this.m_iA*this.m_impulse*this.m_JwA,s.SelfMulAdd(this.m_mB*this.m_impulse,this.m_JvBD),c+=this.m_iB*this.m_impulse*this.m_JwB,u.SelfMulSub(this.m_mC*this.m_impulse,this.m_JvAC),h-=this.m_iC*this.m_impulse*this.m_JwC,f.SelfMulSub(this.m_mD*this.m_impulse,this.m_JvBD),p-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,e.velocities[this.m_indexA].w=o,e.velocities[this.m_indexB].w=c,e.velocities[this.m_indexC].w=h,e.velocities[this.m_indexD].w=p},r.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,i=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,o=t.velocities[this.m_indexC].v,a=t.velocities[this.m_indexC].w,s=t.velocities[this.m_indexD].v,c=t.velocities[this.m_indexD].w,l=bt.DotVV(this.m_JvAC,bt.SubVV(e,o,bt.s_t0))+bt.DotVV(this.m_JvBD,bt.SubVV(i,s,bt.s_t0));l+=this.m_JwA*n-this.m_JwC*a+(this.m_JwB*r-this.m_JwD*c);var u=-this.m_mass*l;this.m_impulse+=u,e.SelfMulAdd(this.m_mA*u,this.m_JvAC),n+=this.m_iA*u*this.m_JwA,i.SelfMulAdd(this.m_mB*u,this.m_JvBD),r+=this.m_iB*u*this.m_JwB,o.SelfMulSub(this.m_mC*u,this.m_JvAC),a-=this.m_iC*u*this.m_JwC,s.SelfMulSub(this.m_mD*u,this.m_JvBD),c-=this.m_iD*u*this.m_JwD,t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=r,t.velocities[this.m_indexC].w=a,t.velocities[this.m_indexD].w=c},r.SolvePositionConstraints=function(e){var n,r,o,a,s,c,l=e.positions[this.m_indexA].c,u=e.positions[this.m_indexA].a,_=e.positions[this.m_indexB].c,f=e.positions[this.m_indexB].a,p=e.positions[this.m_indexC].c,d=e.positions[this.m_indexC].a,m=e.positions[this.m_indexD].c,v=e.positions[this.m_indexD].a,g=this.m_qA.SetAngle(u),y=this.m_qB.SetAngle(f),x=this.m_qC.SetAngle(d),S=this.m_qD.SetAngle(v),A=0,C=this.m_JvAC,b=this.m_JvBD,T=0;if(this.m_typeA===t.b2JointType.e_revoluteJoint)C.SetZero(),o=1,s=1,T+=this.m_iA+this.m_iC,n=u-d-this.m_referenceAngleA;else{var E=It.MulRV(x,this.m_localAxisC,i.SolvePositionConstraints_s_u),w=It.MulRV(x,this.m_lalcC,i.SolvePositionConstraints_s_rC),P=It.MulRV(g,this.m_lalcA,i.SolvePositionConstraints_s_rA);C.Copy(E),s=bt.CrossVV(w,E),o=bt.CrossVV(P,E),T+=this.m_mC+this.m_mA+this.m_iC*s*s+this.m_iA*o*o;var I=this.m_lalcC,R=It.MulTRV(x,bt.AddVV(P,bt.SubVV(l,p,bt.s_t0),bt.s_t0),bt.s_t0);n=bt.DotVV(bt.SubVV(R,I,bt.s_t0),this.m_localAxisC)}if(this.m_typeB===t.b2JointType.e_revoluteJoint)b.SetZero(),a=this.m_ratio,c=this.m_ratio,T+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),r=f-v-this.m_referenceAngleB;else{var D=It.MulRV(S,this.m_localAxisD,i.SolvePositionConstraints_s_u),B=It.MulRV(S,this.m_lalcD,i.SolvePositionConstraints_s_rD),M=It.MulRV(y,this.m_lalcB,i.SolvePositionConstraints_s_rB);bt.MulSV(this.m_ratio,D,b),c=this.m_ratio*bt.CrossVV(B,D),a=this.m_ratio*bt.CrossVV(M,D),T+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*c*c+this.m_iB*a*a;var O=this.m_lalcD,N=It.MulTRV(S,bt.AddVV(M,bt.SubVV(_,m,bt.s_t0),bt.s_t0),bt.s_t0);r=bt.DotVV(bt.SubVV(N,O,bt.s_t0),this.m_localAxisD)}var L=n+this.m_ratio*r-this.m_constant,F=0;return T>0&&(F=-L/T),l.SelfMulAdd(this.m_mA*F,C),u+=this.m_iA*F*o,_.SelfMulAdd(this.m_mB*F,b),f+=this.m_iB*F*a,p.SelfMulSub(this.m_mC*F,C),d-=this.m_iC*F*s,m.SelfMulSub(this.m_mD*F,b),v-=this.m_iD*F*c,e.positions[this.m_indexA].a=u,e.positions[this.m_indexB].a=f,e.positions[this.m_indexC].a=d,e.positions[this.m_indexD].a=v,A<h},r.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},r.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},r.GetReactionForce=function(t,e){return bt.MulSV(t*this.m_impulse,this.m_JvAC,e)},r.GetReactionTorque=function(t){return t*this.m_impulse*this.m_JwA},r.GetJoint1=function(){return this.m_joint1},r.GetJoint2=function(){return this.m_joint2},r.GetRatio=function(){return this.m_ratio},r.SetRatio=function(t){this.m_ratio=t},r.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex,i=this.m_joint1.m_index,r=this.m_joint2.m_index;t("  const jd: b2GearJointDef = new b2GearJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.joint1 = joints[%d];\n",i),t("  jd.joint2 = joints[%d];\n",r),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(bi);Bi.InitVelocityConstraints_s_u=new bt,Bi.InitVelocityConstraints_s_rA=new bt,Bi.InitVelocityConstraints_s_rB=new bt,Bi.InitVelocityConstraints_s_rC=new bt,Bi.InitVelocityConstraints_s_rD=new bt,Bi.SolvePositionConstraints_s_u=new bt,Bi.SolvePositionConstraints_s_rA=new bt,Bi.SolvePositionConstraints_s_rB=new bt,Bi.SolvePositionConstraints_s_rC=new bt,Bi.SolvePositionConstraints_s_rD=new bt;var Mi=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_motorJoint)||this).linearOffset=new bt(0,0),n.angularOffset=0,n.maxForce=1,n.maxTorque=1,n.correctionFactor=.3,n}return F(n,e),n.prototype.Initialize=function(t,e){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(this.bodyB.GetPosition(),this.linearOffset);var n=this.bodyA.GetAngle(),i=this.bodyB.GetAngle();this.angularOffset=i-n},n}(Ci),Oi=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_linearOffset=new bt,i.m_angularOffset=0,i.m_linearImpulse=new bt,i.m_angularImpulse=0,i.m_maxForce=0,i.m_maxTorque=0,i.m_correctionFactor=.3,i.m_indexA=0,i.m_indexB=0,i.m_rA=new bt,i.m_rB=new bt,i.m_localCenterA=new bt,i.m_localCenterB=new bt,i.m_linearError=new bt,i.m_angularError=0,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_linearMass=new wt,i.m_angularMass=0,i.m_qA=new It,i.m_qB=new It,i.m_K=new wt,i.m_linearOffset.Copy(n(e.linearOffset,bt.ZERO)),i.m_linearImpulse.SetZero(),i.m_maxForce=n(e.maxForce,0),i.m_maxTorque=n(e.maxTorque,0),i.m_correctionFactor=n(e.correctionFactor,.3),i}F(e,t);var i=e.prototype;return i.GetAnchorA=function(t){var e=this.m_bodyA.GetPosition();return t.x=e.x,t.y=e.y,t},i.GetAnchorB=function(t){var e=this.m_bodyB.GetPosition();return t.x=e.x,t.y=e.y,t},i.GetReactionForce=function(t,e){return bt.MulSV(t,this.m_linearImpulse,e)},i.GetReactionTorque=function(t){return t*this.m_angularImpulse},i.SetLinearOffset=function(t){bt.IsEqualToV(t,this.m_linearOffset)||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_linearOffset.Copy(t))},i.GetLinearOffset=function(){return this.m_linearOffset},i.SetAngularOffset=function(t){t!==this.m_angularOffset&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_angularOffset=t)},i.GetAngularOffset=function(){return this.m_angularOffset},i.SetMaxForce=function(t){this.m_maxForce=t},i.GetMaxForce=function(){return this.m_maxForce},i.SetMaxTorque=function(t){this.m_maxTorque=t},i.GetMaxTorque=function(){return this.m_maxTorque},i.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v,r=t.velocities[this.m_indexA].w,o=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,s=t.velocities[this.m_indexB].v,c=t.velocities[this.m_indexB].w,l=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(a),h=It.MulRV(l,bt.SubVV(this.m_linearOffset,this.m_localCenterA,bt.s_t0),this.m_rA),_=It.MulRV(u,bt.NegV(this.m_localCenterB,bt.s_t0),this.m_rB),f=this.m_invMassA,p=this.m_invMassB,d=this.m_invIA,m=this.m_invIB,v=this.m_K;if(v.ex.x=f+p+d*h.y*h.y+m*_.y*_.y,v.ex.y=-d*h.x*h.y-m*_.x*_.y,v.ey.x=v.ex.y,v.ey.y=f+p+d*h.x*h.x+m*_.x*_.x,v.GetInverse(this.m_linearMass),this.m_angularMass=d+m,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),bt.SubVV(bt.AddVV(o,_,bt.s_t0),bt.AddVV(e,h,bt.s_t1),this.m_linearError),this.m_angularError=a-n-this.m_angularOffset,t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;var g=this.m_linearImpulse;i.SelfMulSub(f,g),r-=d*(bt.CrossVV(h,g)+this.m_angularImpulse),s.SelfMulAdd(p,g),c+=m*(bt.CrossVV(_,g)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=c},i.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=this.m_invMassA,s=this.m_invMassB,c=this.m_invIA,l=this.m_invIB,u=t.step.dt,h=t.step.inv_dt,_=o-i+h*this.m_correctionFactor*this.m_angularError,f=-this.m_angularMass*_,p=this.m_angularImpulse,d=u*this.m_maxTorque;this.m_angularImpulse=at(this.m_angularImpulse+f,-d,d),i-=c*(f=this.m_angularImpulse-p),o+=l*f;var m=this.m_rA,v=this.m_rB,g=bt.AddVV(bt.SubVV(bt.AddVV(r,bt.CrossSV(o,v,bt.s_t0),bt.s_t0),bt.AddVV(n,bt.CrossSV(i,m,bt.s_t1),bt.s_t1),bt.s_t2),bt.MulSV(h*this.m_correctionFactor,this.m_linearError,bt.s_t3),e.SolveVelocityConstraints_s_Cdot_v2),y=wt.MulMV(this.m_linearMass,g,e.SolveVelocityConstraints_s_impulse_v2).SelfNeg(),x=e.SolveVelocityConstraints_s_oldImpulse_v2.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(y);var S=u*this.m_maxForce;this.m_linearImpulse.LengthSquared()>S*S&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(S)),bt.SubVV(this.m_linearImpulse,x,y),n.SelfMulSub(a,y),i-=c*bt.CrossVV(m,y),r.SelfMulAdd(s,y),o+=l*bt.CrossVV(v,y),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(){return!0},i.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2MotorJointDef = new b2MotorJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.linearOffset.Set(%.15f, %.15f);\n",this.m_linearOffset.x,this.m_linearOffset.y),t("  jd.angularOffset = %.15f;\n",this.m_angularOffset),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  jd.correctionFactor = %.15f;\n",this.m_correctionFactor),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},e}(bi);Oi.SolveVelocityConstraints_s_Cdot_v2=new bt,Oi.SolveVelocityConstraints_s_impulse_v2=new bt,Oi.SolveVelocityConstraints_s_oldImpulse_v2=new bt;var Ni=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_mouseJoint)||this).target=new bt,n.maxForce=0,n.frequencyHz=5,n.dampingRatio=.7,n}return F(n,e),n}(Ci),Li=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_localAnchorB=new bt,i.m_targetA=new bt,i.m_frequencyHz=0,i.m_dampingRatio=0,i.m_beta=0,i.m_impulse=new bt,i.m_maxForce=0,i.m_gamma=0,i.m_indexA=0,i.m_indexB=0,i.m_rB=new bt,i.m_localCenterB=new bt,i.m_invMassB=0,i.m_invIB=0,i.m_mass=new wt,i.m_C=new bt,i.m_qB=new It,i.m_lalcB=new bt,i.m_K=new wt,i.m_targetA.Copy(n(e.target,bt.ZERO)),Rt.MulTXV(i.m_bodyB.GetTransform(),i.m_targetA,i.m_localAnchorB),i.m_maxForce=n(e.maxForce,0),i.m_impulse.SetZero(),i.m_frequencyHz=n(e.frequencyHz,0),i.m_dampingRatio=n(e.dampingRatio,0),i.m_beta=0,i.m_gamma=0,i}F(e,t);var i=e.prototype;return i.SetTarget=function(t){this.m_bodyB.IsAwake()||this.m_bodyB.SetAwake(!0),this.m_targetA.Copy(t)},i.GetTarget=function(){return this.m_targetA},i.SetMaxForce=function(t){this.m_maxForce=t},i.GetMaxForce=function(){return this.m_maxForce},i.SetFrequency=function(t){this.m_frequencyHz=t},i.GetFrequency=function(){return this.m_frequencyHz},i.SetDampingRatio=function(t){this.m_dampingRatio=t},i.GetDampingRatio=function(){return this.m_dampingRatio},i.InitVelocityConstraints=function(t){this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexB].c,n=t.positions[this.m_indexB].a,i=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,o=this.m_qB.SetAngle(n),s=this.m_bodyB.GetMass(),c=2*a*this.m_frequencyHz,l=2*s*this.m_dampingRatio*c,u=s*c*c,h=t.step.dt;this.m_gamma=h*(l+h*u),0!==this.m_gamma&&(this.m_gamma=1/this.m_gamma),this.m_beta=h*u*this.m_gamma,bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(o,this.m_lalcB,this.m_rB);var _=this.m_K;_.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,_.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,_.ey.x=_.ex.y,_.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,_.GetInverse(this.m_mass),this.m_C.x=e.x+this.m_rB.x-this.m_targetA.x,this.m_C.y=e.y+this.m_rB.y-this.m_targetA.y,this.m_C.SelfMul(this.m_beta),r*=.98,t.step.warmStarting?(this.m_impulse.SelfMul(t.step.dtRatio),i.x+=this.m_invMassB*this.m_impulse.x,i.y+=this.m_invMassB*this.m_impulse.y,r+=this.m_invIB*bt.CrossVV(this.m_rB,this.m_impulse)):this.m_impulse.SetZero(),t.velocities[this.m_indexB].w=r},i.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexB].v,i=t.velocities[this.m_indexB].w,r=bt.AddVCrossSV(n,i,this.m_rB,e.SolveVelocityConstraints_s_Cdot),o=wt.MulMV(this.m_mass,bt.AddVV(r,bt.AddVV(this.m_C,bt.MulSV(this.m_gamma,this.m_impulse,bt.s_t0),bt.s_t0),bt.s_t0).SelfNeg(),e.SolveVelocityConstraints_s_impulse),a=e.SolveVelocityConstraints_s_oldImpulse.Copy(this.m_impulse);this.m_impulse.SelfAdd(o);var s=t.step.dt*this.m_maxForce;this.m_impulse.LengthSquared()>s*s&&this.m_impulse.SelfMul(s/this.m_impulse.Length()),bt.SubVV(this.m_impulse,a,o),n.SelfMulAdd(this.m_invMassB,o),i+=this.m_invIB*bt.CrossVV(this.m_rB,o),t.velocities[this.m_indexB].w=i},i.SolvePositionConstraints=function(){return!0},i.GetAnchorA=function(t){return t.x=this.m_targetA.x,t.y=this.m_targetA.y,t},i.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.GetReactionForce=function(t,e){return bt.MulSV(t,this.m_impulse,e)},i.GetReactionTorque=function(){return 0},i.Dump=function(t){t("Mouse joint dumping is not supported.\n")},i.ShiftOrigin=function(t){this.m_targetA.SelfSub(t)},e}(bi);Li.SolveVelocityConstraints_s_Cdot=new bt,Li.SolveVelocityConstraints_s_impulse=new bt,Li.SolveVelocityConstraints_s_oldImpulse=new bt;var Fi=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_prismaticJoint)||this).localAnchorA=new bt,n.localAnchorB=new bt,n.localAxisA=new bt(1,0),n.referenceAngle=0,n.enableLimit=!1,n.lowerTranslation=0,n.upperTranslation=0,n.enableMotor=!1,n.maxMotorForce=0,n.motorSpeed=0,n}return F(n,e),n.prototype.Initialize=function(t,e,n,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.bodyA.GetLocalVector(i,this.localAxisA),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},n}(Ci),zi=function(e){function i(i){var r;return(r=e.call(this,i)||this).m_localAnchorA=new bt,r.m_localAnchorB=new bt,r.m_localXAxisA=new bt,r.m_localYAxisA=new bt,r.m_referenceAngle=0,r.m_impulse=new Et(0,0,0),r.m_motorImpulse=0,r.m_lowerTranslation=0,r.m_upperTranslation=0,r.m_maxMotorForce=0,r.m_motorSpeed=0,r.m_enableLimit=!1,r.m_enableMotor=!1,r.m_limitState=t.b2LimitState.e_inactiveLimit,r.m_indexA=0,r.m_indexB=0,r.m_localCenterA=new bt,r.m_localCenterB=new bt,r.m_invMassA=0,r.m_invMassB=0,r.m_invIA=0,r.m_invIB=0,r.m_axis=new bt(0,0),r.m_perp=new bt(0,0),r.m_s1=0,r.m_s2=0,r.m_a1=0,r.m_a2=0,r.m_K=new Pt,r.m_K3=new Pt,r.m_K2=new wt,r.m_motorMass=0,r.m_qA=new It,r.m_qB=new It,r.m_lalcA=new bt,r.m_lalcB=new bt,r.m_rA=new bt,r.m_rB=new bt,r.m_localAnchorA.Copy(n(i.localAnchorA,bt.ZERO)),r.m_localAnchorB.Copy(n(i.localAnchorB,bt.ZERO)),r.m_localXAxisA.Copy(n(i.localAxisA,new bt(1,0))).SelfNormalize(),bt.CrossOneV(r.m_localXAxisA,r.m_localYAxisA),r.m_referenceAngle=n(i.referenceAngle,0),r.m_lowerTranslation=n(i.lowerTranslation,0),r.m_upperTranslation=n(i.upperTranslation,0),r.m_maxMotorForce=n(i.maxMotorForce,0),r.m_motorSpeed=n(i.motorSpeed,0),r.m_enableLimit=n(i.enableLimit,!1),r.m_enableMotor=n(i.enableMotor,!1),r}F(i,e);var r=i.prototype;return r.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=e.positions[this.m_indexA].c,r=e.positions[this.m_indexA].a,o=e.velocities[this.m_indexA].v,a=e.velocities[this.m_indexA].w,s=e.positions[this.m_indexB].c,c=e.positions[this.m_indexB].a,l=e.velocities[this.m_indexB].v,u=e.velocities[this.m_indexB].w,_=this.m_qA.SetAngle(r),f=this.m_qB.SetAngle(c);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var p=It.MulRV(_,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var d=It.MulRV(f,this.m_lalcB,this.m_rB),m=bt.AddVV(bt.SubVV(s,n,bt.s_t0),bt.SubVV(d,p,bt.s_t1),i.InitVelocityConstraints_s_d),v=this.m_invMassA,g=this.m_invMassB,y=this.m_invIA,x=this.m_invIB;if(It.MulRV(_,this.m_localXAxisA,this.m_axis),this.m_a1=bt.CrossVV(bt.AddVV(m,p,bt.s_t0),this.m_axis),this.m_a2=bt.CrossVV(d,this.m_axis),this.m_motorMass=v+g+y*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),It.MulRV(_,this.m_localYAxisA,this.m_perp),this.m_s1=bt.CrossVV(bt.AddVV(m,p,bt.s_t0),this.m_perp),this.m_s2=bt.CrossVV(d,this.m_perp),this.m_K.ex.x=v+g+y*this.m_s1*this.m_s1+x*this.m_s2*this.m_s2,this.m_K.ex.y=y*this.m_s1+x*this.m_s2,this.m_K.ex.z=y*this.m_s1*this.m_a1+x*this.m_s2*this.m_a2,this.m_K.ey.x=this.m_K.ex.y,this.m_K.ey.y=y+x,0===this.m_K.ey.y&&(this.m_K.ey.y=1),this.m_K.ey.z=y*this.m_a1+x*this.m_a2,this.m_K.ez.x=this.m_K.ex.z,this.m_K.ez.y=this.m_K.ey.z,this.m_K.ez.z=v+g+y*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_enableLimit){var S=bt.DotVV(this.m_axis,m);it(this.m_upperTranslation-this.m_lowerTranslation)<2*h?this.m_limitState=t.b2LimitState.e_equalLimits:S<=this.m_lowerTranslation?this.m_limitState!==t.b2LimitState.e_atLowerLimit&&(this.m_limitState=t.b2LimitState.e_atLowerLimit,this.m_impulse.z=0):S>=this.m_upperTranslation?this.m_limitState!==t.b2LimitState.e_atUpperLimit&&(this.m_limitState=t.b2LimitState.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0;if(this.m_enableMotor||(this.m_motorImpulse=0),e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio),this.m_motorImpulse*=e.step.dtRatio;var A=bt.AddVV(bt.MulSV(this.m_impulse.x,this.m_perp,bt.s_t0),bt.MulSV(this.m_motorImpulse+this.m_impulse.z,this.m_axis,bt.s_t1),i.InitVelocityConstraints_s_P),C=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,b=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;o.SelfMulSub(v,A),a-=y*C,l.SelfMulAdd(g,A),u+=x*b}else this.m_impulse.SetZero(),this.m_motorImpulse=0;e.velocities[this.m_indexA].w=a,e.velocities[this.m_indexB].w=u},r.SolveVelocityConstraints=function(e){var n=e.velocities[this.m_indexA].v,r=e.velocities[this.m_indexA].w,o=e.velocities[this.m_indexB].v,a=e.velocities[this.m_indexB].w,s=this.m_invMassA,c=this.m_invMassB,l=this.m_invIA,u=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!==t.b2LimitState.e_equalLimits){var h=bt.DotVV(this.m_axis,bt.SubVV(o,n,bt.s_t0))+this.m_a2*a-this.m_a1*r,_=this.m_motorMass*(this.m_motorSpeed-h),f=this.m_motorImpulse,p=e.step.dt*this.m_maxMotorForce;this.m_motorImpulse=at(this.m_motorImpulse+_,-p,p),_=this.m_motorImpulse-f;var d=bt.MulSV(_,this.m_axis,i.SolveVelocityConstraints_s_P),m=_*this.m_a1,v=_*this.m_a2;n.SelfMulSub(s,d),r-=l*m,o.SelfMulAdd(c,d),a+=u*v}var g=bt.DotVV(this.m_perp,bt.SubVV(o,n,bt.s_t0))+this.m_s2*a-this.m_s1*r,y=a-r;if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit){var x=bt.DotVV(this.m_axis,bt.SubVV(o,n,bt.s_t0))+this.m_a2*a-this.m_a1*r,S=i.SolveVelocityConstraints_s_f1.Copy(this.m_impulse),A=this.m_K.Solve33(-g,-y,-x,i.SolveVelocityConstraints_s_df3);this.m_impulse.SelfAdd(A),this.m_limitState===t.b2LimitState.e_atLowerLimit?this.m_impulse.z=ot(this.m_impulse.z,0):this.m_limitState===t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=rt(this.m_impulse.z,0));var C=-g-(this.m_impulse.z-S.z)*this.m_K.ez.x,b=-y-(this.m_impulse.z-S.z)*this.m_K.ez.y,T=this.m_K.Solve22(C,b,i.SolveVelocityConstraints_s_f2r);T.x+=S.x,T.y+=S.y,this.m_impulse.x=T.x,this.m_impulse.y=T.y,A.x=this.m_impulse.x-S.x,A.y=this.m_impulse.y-S.y,A.z=this.m_impulse.z-S.z;var E=bt.AddVV(bt.MulSV(A.x,this.m_perp,bt.s_t0),bt.MulSV(A.z,this.m_axis,bt.s_t1),i.SolveVelocityConstraints_s_P),w=A.x*this.m_s1+A.y+A.z*this.m_a1,P=A.x*this.m_s2+A.y+A.z*this.m_a2;n.SelfMulSub(s,E),r-=l*w,o.SelfMulAdd(c,E),a+=u*P}else{var I=this.m_K.Solve22(-g,-y,i.SolveVelocityConstraints_s_df2);this.m_impulse.x+=I.x,this.m_impulse.y+=I.y;var R=bt.MulSV(I.x,this.m_perp,i.SolveVelocityConstraints_s_P),D=I.x*this.m_s1+I.y,B=I.x*this.m_s2+I.y;n.SelfMulSub(s,R),r-=l*D,o.SelfMulAdd(c,R),a+=u*B}e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=a},r.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(n),s=this.m_qB.SetAngle(o),c=this.m_invMassA,l=this.m_invMassB,u=this.m_invIA,f=this.m_invIB,p=It.MulRV(a,this.m_lalcA,this.m_rA),d=It.MulRV(s,this.m_lalcB,this.m_rB),m=bt.SubVV(bt.AddVV(r,d,bt.s_t0),bt.AddVV(e,p,bt.s_t1),i.SolvePositionConstraints_s_d),g=It.MulRV(a,this.m_localXAxisA,this.m_axis),y=bt.CrossVV(bt.AddVV(m,p,bt.s_t0),g),x=bt.CrossVV(d,g),S=It.MulRV(a,this.m_localYAxisA,this.m_perp),A=bt.CrossVV(bt.AddVV(m,p,bt.s_t0),S),C=bt.CrossVV(d,S),b=i.SolvePositionConstraints_s_impulse,T=bt.DotVV(S,m),E=o-n-this.m_referenceAngle,w=it(T),P=it(E),I=!1,R=0;if(this.m_enableLimit){var D=bt.DotVV(g,m);it(this.m_upperTranslation-this.m_lowerTranslation)<2*h?(R=at(D,-v,v),w=ot(w,it(D)),I=!0):D<=this.m_lowerTranslation?(R=at(D-this.m_lowerTranslation+h,-v,0),w=ot(w,this.m_lowerTranslation-D),I=!0):D>=this.m_upperTranslation&&(R=at(D-this.m_upperTranslation-h,0,v),w=ot(w,D-this.m_upperTranslation),I=!0)}if(I){var B=c+l+u*A*A+f*C*C,M=u*A+f*C,O=u*A*y+f*C*x,N=u+f;0===N&&(N=1);var L=u*y+f*x,F=c+l+u*y*y+f*x*x,z=this.m_K3;z.ex.SetXYZ(B,M,O),z.ey.SetXYZ(M,N,L),z.ez.SetXYZ(O,L,F),b=z.Solve33(-T,-E,-R,b)}else{var V=c+l+u*A*A+f*C*C,G=u*A+f*C,U=u+f;0===U&&(U=1);var k=this.m_K2;k.ex.Set(V,G),k.ey.Set(G,U);var H=k.Solve(-T,-E,i.SolvePositionConstraints_s_impulse1);b.x=H.x,b.y=H.y,b.z=0}var j=bt.AddVV(bt.MulSV(b.x,S,bt.s_t0),bt.MulSV(b.z,g,bt.s_t1),i.SolvePositionConstraints_s_P),W=b.x*A+b.y+b.z*y,q=b.x*C+b.y+b.z*x;return e.SelfMulSub(c,j),n-=u*W,r.SelfMulAdd(l,j),o+=f*q,t.positions[this.m_indexA].a=n,t.positions[this.m_indexB].a=o,w<=h&&P<=_},r.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},r.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},r.GetReactionForce=function(t,e){return e.x=t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),e.y=t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y),e},r.GetReactionTorque=function(t){return t*this.m_impulse.y},r.GetLocalAnchorA=function(){return this.m_localAnchorA},r.GetLocalAnchorB=function(){return this.m_localAnchorB},r.GetLocalAxisA=function(){return this.m_localXAxisA},r.GetReferenceAngle=function(){return this.m_referenceAngle},r.GetJointTranslation=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,i.GetJointTranslation_s_pA),e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,i.GetJointTranslation_s_pB),n=bt.SubVV(e,t,i.GetJointTranslation_s_d),r=this.m_bodyA.GetWorldVector(this.m_localXAxisA,i.GetJointTranslation_s_axis);return bt.DotVV(n,r)},r.GetJointSpeed=function(){var t=this.m_bodyA,e=this.m_bodyB;bt.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);var n=It.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);var i=It.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),r=bt.AddVV(t.m_sweep.c,n,bt.s_t0),o=bt.AddVV(e.m_sweep.c,i,bt.s_t1),a=bt.SubVV(o,r,bt.s_t2),s=t.GetWorldVector(this.m_localXAxisA,this.m_axis),c=t.m_linearVelocity,l=e.m_linearVelocity,u=t.m_angularVelocity,h=e.m_angularVelocity;return bt.DotVV(a,bt.CrossSV(u,s,bt.s_t0))+bt.DotVV(s,bt.SubVV(bt.AddVCrossSV(l,h,i,bt.s_t0),bt.AddVCrossSV(c,u,n,bt.s_t1),bt.s_t0))},r.IsLimitEnabled=function(){return this.m_enableLimit},r.EnableLimit=function(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)},r.GetLowerLimit=function(){return this.m_lowerTranslation},r.GetUpperLimit=function(){return this.m_upperTranslation},r.SetLimits=function(t,e){t===this.m_lowerTranslation&&e===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_impulse.z=0)},r.IsMotorEnabled=function(){return this.m_enableMotor},r.EnableMotor=function(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},r.SetMotorSpeed=function(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},r.GetMotorSpeed=function(){return this.m_motorSpeed},r.SetMaxMotorForce=function(t){t!==this.m_maxMotorForce&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t)},r.GetMaxMotorForce=function(){return this.m_maxMotorForce},r.GetMotorForce=function(t){return t*this.m_motorImpulse},r.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2PrismaticJointDef = new b2PrismaticJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerTranslation = %.15f;\n",this.m_lowerTranslation),t("  jd.upperTranslation = %.15f;\n",this.m_upperTranslation),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorForce = %.15f;\n",this.m_maxMotorForce),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(bi);zi.InitVelocityConstraints_s_d=new bt,zi.InitVelocityConstraints_s_P=new bt,zi.SolveVelocityConstraints_s_P=new bt,zi.SolveVelocityConstraints_s_f2r=new bt,zi.SolveVelocityConstraints_s_f1=new Et,zi.SolveVelocityConstraints_s_df3=new Et,zi.SolveVelocityConstraints_s_df2=new bt,zi.SolvePositionConstraints_s_d=new bt,zi.SolvePositionConstraints_s_impulse=new Et,zi.SolvePositionConstraints_s_impulse1=new bt,zi.SolvePositionConstraints_s_P=new bt,zi.GetJointTranslation_s_pA=new bt,zi.GetJointTranslation_s_pB=new bt,zi.GetJointTranslation_s_d=new bt,zi.GetJointTranslation_s_axis=new bt;var Vi=2,Gi=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_pulleyJoint)||this).groundAnchorA=new bt(-1,1),n.groundAnchorB=new bt(1,1),n.localAnchorA=new bt(-1,0),n.localAnchorB=new bt(1,0),n.lengthA=0,n.lengthB=0,n.ratio=1,n.collideConnected=!0,n}return F(n,e),n.prototype.Initialize=function(t,e,n,i,r,o,a){this.bodyA=t,this.bodyB=e,this.groundAnchorA.Copy(n),this.groundAnchorB.Copy(i),this.bodyA.GetLocalPoint(r,this.localAnchorA),this.bodyB.GetLocalPoint(o,this.localAnchorB),this.lengthA=bt.DistanceVV(r,n),this.lengthB=bt.DistanceVV(o,i),this.ratio=a},n}(Ci),Ui=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_groundAnchorA=new bt,i.m_groundAnchorB=new bt,i.m_lengthA=0,i.m_lengthB=0,i.m_localAnchorA=new bt,i.m_localAnchorB=new bt,i.m_constant=0,i.m_ratio=0,i.m_impulse=0,i.m_indexA=0,i.m_indexB=0,i.m_uA=new bt,i.m_uB=new bt,i.m_rA=new bt,i.m_rB=new bt,i.m_localCenterA=new bt,i.m_localCenterB=new bt,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_mass=0,i.m_qA=new It,i.m_qB=new It,i.m_lalcA=new bt,i.m_lalcB=new bt,i.m_groundAnchorA.Copy(n(e.groundAnchorA,new bt(-1,1))),i.m_groundAnchorB.Copy(n(e.groundAnchorB,new bt(1,0))),i.m_localAnchorA.Copy(n(e.localAnchorA,new bt(-1,0))),i.m_localAnchorB.Copy(n(e.localAnchorB,new bt(1,0))),i.m_lengthA=n(e.lengthA,0),i.m_lengthB=n(e.lengthB,0),i.m_ratio=n(e.ratio,1),i.m_constant=n(e.lengthA,0)+i.m_ratio*n(e.lengthB,0),i.m_impulse=0,i}F(e,t);var i=e.prototype;return i.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,a=t.positions[this.m_indexB].c,s=t.positions[this.m_indexB].a,c=t.velocities[this.m_indexB].v,l=t.velocities[this.m_indexB].w,u=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(s);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(u,this.m_lalcA,this.m_rA),bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(_,this.m_lalcB,this.m_rB),this.m_uA.Copy(n).SelfAdd(this.m_rA).SelfSub(this.m_groundAnchorA),this.m_uB.Copy(a).SelfAdd(this.m_rB).SelfSub(this.m_groundAnchorB);var f=this.m_uA.Length(),p=this.m_uB.Length();f>10*h?this.m_uA.SelfMul(1/f):this.m_uA.SetZero(),p>10*h?this.m_uB.SelfMul(1/p):this.m_uB.SetZero();var d=bt.CrossVV(this.m_rA,this.m_uA),m=bt.CrossVV(this.m_rB,this.m_uB),v=this.m_invMassA+this.m_invIA*d*d,g=this.m_invMassB+this.m_invIB*m*m;if(this.m_mass=v+this.m_ratio*this.m_ratio*g,this.m_mass>0&&(this.m_mass=1/this.m_mass),t.step.warmStarting){this.m_impulse*=t.step.dtRatio;var y=bt.MulSV(-this.m_impulse,this.m_uA,e.InitVelocityConstraints_s_PA),x=bt.MulSV(-this.m_ratio*this.m_impulse,this.m_uB,e.InitVelocityConstraints_s_PB);r.SelfMulAdd(this.m_invMassA,y),o+=this.m_invIA*bt.CrossVV(this.m_rA,y),c.SelfMulAdd(this.m_invMassB,x),l+=this.m_invIB*bt.CrossVV(this.m_rB,x)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=l},i.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=bt.AddVCrossSV(n,i,this.m_rA,e.SolveVelocityConstraints_s_vpA),s=bt.AddVCrossSV(r,o,this.m_rB,e.SolveVelocityConstraints_s_vpB),c=-bt.DotVV(this.m_uA,a)-this.m_ratio*bt.DotVV(this.m_uB,s),l=-this.m_mass*c;this.m_impulse+=l;var u=bt.MulSV(-l,this.m_uA,e.SolveVelocityConstraints_s_PA),h=bt.MulSV(-this.m_ratio*l,this.m_uB,e.SolveVelocityConstraints_s_PB);n.SelfMulAdd(this.m_invMassA,u),i+=this.m_invIA*bt.CrossVV(this.m_rA,u),r.SelfMulAdd(this.m_invMassB,h),o+=this.m_invIB*bt.CrossVV(this.m_rB,h),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(t){var n=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),s=this.m_qB.SetAngle(o);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var c=It.MulRV(a,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var l=It.MulRV(s,this.m_lalcB,this.m_rB),u=this.m_uA.Copy(n).SelfAdd(c).SelfSub(this.m_groundAnchorA),_=this.m_uB.Copy(r).SelfAdd(l).SelfSub(this.m_groundAnchorB),f=u.Length(),p=_.Length();f>10*h?u.SelfMul(1/f):u.SetZero(),p>10*h?_.SelfMul(1/p):_.SetZero();var d=bt.CrossVV(c,u),m=bt.CrossVV(l,_),v=this.m_invMassA+this.m_invIA*d*d,g=this.m_invMassB+this.m_invIB*m*m,y=v+this.m_ratio*this.m_ratio*g;y>0&&(y=1/y);var x=this.m_constant-f-this.m_ratio*p,S=it(x),A=-y*x,C=bt.MulSV(-A,u,e.SolvePositionConstraints_s_PA),b=bt.MulSV(-this.m_ratio*A,_,e.SolvePositionConstraints_s_PB);return n.SelfMulAdd(this.m_invMassA,C),i+=this.m_invIA*bt.CrossVV(c,C),r.SelfMulAdd(this.m_invMassB,b),o+=this.m_invIB*bt.CrossVV(l,b),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,S<h},i.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.GetReactionForce=function(t,e){return e.x=t*this.m_impulse*this.m_uB.x,e.y=t*this.m_impulse*this.m_uB.y,e},i.GetReactionTorque=function(){return 0},i.GetGroundAnchorA=function(){return this.m_groundAnchorA},i.GetGroundAnchorB=function(){return this.m_groundAnchorB},i.GetLengthA=function(){return this.m_lengthA},i.GetLengthB=function(){return this.m_lengthB},i.GetRatio=function(){return this.m_ratio},i.GetCurrentLengthA=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e.GetCurrentLengthA_s_p),n=this.m_groundAnchorA;return bt.DistanceVV(t,n)},i.GetCurrentLengthB=function(){var t=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e.GetCurrentLengthB_s_p),n=this.m_groundAnchorB;return bt.DistanceVV(t,n)},i.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2PulleyJointDef = new b2PulleyJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.groundAnchorA.Set(%.15f, %.15f);\n",this.m_groundAnchorA.x,this.m_groundAnchorA.y),t("  jd.groundAnchorB.Set(%.15f, %.15f);\n",this.m_groundAnchorB.x,this.m_groundAnchorB.y),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.lengthA = %.15f;\n",this.m_lengthA),t("  jd.lengthB = %.15f;\n",this.m_lengthB),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i.ShiftOrigin=function(t){this.m_groundAnchorA.SelfSub(t),this.m_groundAnchorB.SelfSub(t)},e}(bi);Ui.InitVelocityConstraints_s_PA=new bt,Ui.InitVelocityConstraints_s_PB=new bt,Ui.SolveVelocityConstraints_s_vpA=new bt,Ui.SolveVelocityConstraints_s_vpB=new bt,Ui.SolveVelocityConstraints_s_PA=new bt,Ui.SolveVelocityConstraints_s_PB=new bt,Ui.SolvePositionConstraints_s_PA=new bt,Ui.SolvePositionConstraints_s_PB=new bt,Ui.GetCurrentLengthA_s_p=new bt,Ui.GetCurrentLengthB_s_p=new bt;var ki=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_revoluteJoint)||this).localAnchorA=new bt(0,0),n.localAnchorB=new bt(0,0),n.referenceAngle=0,n.enableLimit=!1,n.lowerAngle=0,n.upperAngle=0,n.enableMotor=!1,n.motorSpeed=0,n.maxMotorTorque=0,n}return F(n,e),n.prototype.Initialize=function(t,e,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},n}(Ci),Hi=function(e){function i(i){var r;return(r=e.call(this,i)||this).m_localAnchorA=new bt,r.m_localAnchorB=new bt,r.m_impulse=new Et,r.m_motorImpulse=0,r.m_enableMotor=!1,r.m_maxMotorTorque=0,r.m_motorSpeed=0,r.m_enableLimit=!1,r.m_referenceAngle=0,r.m_lowerAngle=0,r.m_upperAngle=0,r.m_indexA=0,r.m_indexB=0,r.m_rA=new bt,r.m_rB=new bt,r.m_localCenterA=new bt,r.m_localCenterB=new bt,r.m_invMassA=0,r.m_invMassB=0,r.m_invIA=0,r.m_invIB=0,r.m_mass=new Pt,r.m_motorMass=0,r.m_limitState=t.b2LimitState.e_inactiveLimit,r.m_qA=new It,r.m_qB=new It,r.m_lalcA=new bt,r.m_lalcB=new bt,r.m_K=new wt,r.m_localAnchorA.Copy(n(i.localAnchorA,bt.ZERO)),r.m_localAnchorB.Copy(n(i.localAnchorB,bt.ZERO)),r.m_referenceAngle=n(i.referenceAngle,0),r.m_impulse.SetZero(),r.m_motorImpulse=0,r.m_lowerAngle=n(i.lowerAngle,0),r.m_upperAngle=n(i.upperAngle,0),r.m_maxMotorTorque=n(i.maxMotorTorque,0),r.m_motorSpeed=n(i.motorSpeed,0),r.m_enableLimit=n(i.enableLimit,!1),r.m_enableMotor=n(i.enableMotor,!1),r.m_limitState=t.b2LimitState.e_inactiveLimit,r}F(i,e);var r=i.prototype;return r.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=e.positions[this.m_indexA].a,r=e.velocities[this.m_indexA].v,o=e.velocities[this.m_indexA].w,a=e.positions[this.m_indexB].a,s=e.velocities[this.m_indexB].v,c=e.velocities[this.m_indexB].w,l=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(a);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(l,this.m_lalcA,this.m_rA),bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(u,this.m_lalcB,this.m_rB);var h=this.m_invMassA,f=this.m_invMassB,p=this.m_invIA,d=this.m_invIB,m=p+d===0;if(this.m_mass.ex.x=h+f+this.m_rA.y*this.m_rA.y*p+this.m_rB.y*this.m_rB.y*d,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*p-this.m_rB.y*this.m_rB.x*d,this.m_mass.ez.x=-this.m_rA.y*p-this.m_rB.y*d,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=h+f+this.m_rA.x*this.m_rA.x*p+this.m_rB.x*this.m_rB.x*d,this.m_mass.ez.y=this.m_rA.x*p+this.m_rB.x*d,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=p+d,this.m_motorMass=p+d,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),this.m_enableMotor&&!m||(this.m_motorImpulse=0),this.m_enableLimit&&!m){var v=a-n-this.m_referenceAngle;it(this.m_upperAngle-this.m_lowerAngle)<2*_?this.m_limitState=t.b2LimitState.e_equalLimits:v<=this.m_lowerAngle?(this.m_limitState!==t.b2LimitState.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=t.b2LimitState.e_atLowerLimit):v>=this.m_upperAngle?(this.m_limitState!==t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=t.b2LimitState.e_atUpperLimit):(this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=t.b2LimitState.e_inactiveLimit;if(e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio),this.m_motorImpulse*=e.step.dtRatio;var g=i.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);r.SelfMulSub(h,g),o-=p*(bt.CrossVV(this.m_rA,g)+this.m_motorImpulse+this.m_impulse.z),s.SelfMulAdd(f,g),c+=d*(bt.CrossVV(this.m_rB,g)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0;e.velocities[this.m_indexA].w=o,e.velocities[this.m_indexB].w=c},r.SolveVelocityConstraints=function(e){var n=e.velocities[this.m_indexA].v,r=e.velocities[this.m_indexA].w,o=e.velocities[this.m_indexB].v,a=e.velocities[this.m_indexB].w,s=this.m_invMassA,c=this.m_invMassB,l=this.m_invIA,u=this.m_invIB,h=l+u===0;if(this.m_enableMotor&&this.m_limitState!==t.b2LimitState.e_equalLimits&&!h){var _=a-r-this.m_motorSpeed,f=-this.m_motorMass*_,p=this.m_motorImpulse,d=e.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=at(this.m_motorImpulse+f,-d,d),r-=l*(f=this.m_motorImpulse-p),a+=u*f}if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit&&!h){var m=bt.SubVV(bt.AddVCrossSV(o,a,this.m_rB,bt.s_t0),bt.AddVCrossSV(n,r,this.m_rA,bt.s_t1),i.SolveVelocityConstraints_s_Cdot1),v=a-r,g=this.m_mass.Solve33(m.x,m.y,v,i.SolveVelocityConstraints_s_impulse_v3).SelfNeg();if(this.m_limitState===t.b2LimitState.e_equalLimits)this.m_impulse.SelfAdd(g);else if(this.m_limitState===t.b2LimitState.e_atLowerLimit)if(this.m_impulse.z+g.z<0){var y=-m.x+this.m_impulse.z*this.m_mass.ez.x,x=-m.y+this.m_impulse.z*this.m_mass.ez.y,S=this.m_mass.Solve22(y,x,i.SolveVelocityConstraints_s_reduced_v2);g.x=S.x,g.y=S.y,g.z=-this.m_impulse.z,this.m_impulse.x+=S.x,this.m_impulse.y+=S.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(g);else if(this.m_limitState===t.b2LimitState.e_atUpperLimit)if(this.m_impulse.z+g.z>0){var A=-m.x+this.m_impulse.z*this.m_mass.ez.x,C=-m.y+this.m_impulse.z*this.m_mass.ez.y,b=this.m_mass.Solve22(A,C,i.SolveVelocityConstraints_s_reduced_v2);g.x=b.x,g.y=b.y,g.z=-this.m_impulse.z,this.m_impulse.x+=b.x,this.m_impulse.y+=b.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(g);var T=i.SolveVelocityConstraints_s_P.Set(g.x,g.y);n.SelfMulSub(s,T),r-=l*(bt.CrossVV(this.m_rA,T)+g.z),o.SelfMulAdd(c,T),a+=u*(bt.CrossVV(this.m_rB,T)+g.z)}else{var E=bt.SubVV(bt.AddVCrossSV(o,a,this.m_rB,bt.s_t0),bt.AddVCrossSV(n,r,this.m_rA,bt.s_t1),i.SolveVelocityConstraints_s_Cdot_v2),w=this.m_mass.Solve22(-E.x,-E.y,i.SolveVelocityConstraints_s_impulse_v2);this.m_impulse.x+=w.x,this.m_impulse.y+=w.y,n.SelfMulSub(s,w),r-=l*bt.CrossVV(this.m_rA,w),o.SelfMulAdd(c,w),a+=u*bt.CrossVV(this.m_rB,w)}e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=a},r.SolvePositionConstraints=function(e){var n=e.positions[this.m_indexA].c,r=e.positions[this.m_indexA].a,o=e.positions[this.m_indexB].c,a=e.positions[this.m_indexB].a,s=this.m_qA.SetAngle(r),c=this.m_qB.SetAngle(a),l=0,u=0,f=this.m_invIA+this.m_invIB===0;if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit&&!f){var p=a-r-this.m_referenceAngle,d=0;if(this.m_limitState===t.b2LimitState.e_equalLimits){var m=at(p-this.m_lowerAngle,-g,g);d=-this.m_motorMass*m,l=it(m)}else if(this.m_limitState===t.b2LimitState.e_atLowerLimit){var v=p-this.m_lowerAngle;l=-v,v=at(v+_,-g,0),d=-this.m_motorMass*v}else if(this.m_limitState===t.b2LimitState.e_atUpperLimit){var y=p-this.m_upperAngle;l=y,y=at(y-_,0,g),d=-this.m_motorMass*y}r-=this.m_invIA*d,a+=this.m_invIB*d}s.SetAngle(r),c.SetAngle(a),bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var x=It.MulRV(s,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var S=It.MulRV(c,this.m_lalcB,this.m_rB),A=bt.SubVV(bt.AddVV(o,S,bt.s_t0),bt.AddVV(n,x,bt.s_t1),i.SolvePositionConstraints_s_C_v2);u=A.Length();var C=this.m_invMassA,b=this.m_invMassB,T=this.m_invIA,E=this.m_invIB,w=this.m_K;w.ex.x=C+b+T*x.y*x.y+E*S.y*S.y,w.ex.y=-T*x.x*x.y-E*S.x*S.y,w.ey.x=w.ex.y,w.ey.y=C+b+T*x.x*x.x+E*S.x*S.x;var P=w.Solve(A.x,A.y,i.SolvePositionConstraints_s_impulse).SelfNeg();return n.SelfMulSub(C,P),r-=T*bt.CrossVV(x,P),o.SelfMulAdd(b,P),a+=E*bt.CrossVV(S,P),e.positions[this.m_indexA].a=r,e.positions[this.m_indexB].a=a,u<=h&&l<=_},r.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},r.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},r.GetReactionForce=function(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e},r.GetReactionTorque=function(t){return t*this.m_impulse.z},r.GetLocalAnchorA=function(){return this.m_localAnchorA},r.GetLocalAnchorB=function(){return this.m_localAnchorB},r.GetReferenceAngle=function(){return this.m_referenceAngle},r.GetJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle},r.GetJointSpeed=function(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity},r.IsMotorEnabled=function(){return this.m_enableMotor},r.EnableMotor=function(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},r.GetMotorTorque=function(t){return t*this.m_motorImpulse},r.GetMotorSpeed=function(){return this.m_motorSpeed},r.SetMaxMotorTorque=function(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)},r.GetMaxMotorTorque=function(){return this.m_maxMotorTorque},r.IsLimitEnabled=function(){return this.m_enableLimit},r.EnableLimit=function(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)},r.GetLowerLimit=function(){return this.m_lowerAngle},r.GetUpperLimit=function(){return this.m_upperAngle},r.SetLimits=function(t,e){t===this.m_lowerAngle&&e===this.m_upperAngle||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=t,this.m_upperAngle=e)},r.SetMotorSpeed=function(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},r.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2RevoluteJointDef = new b2RevoluteJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerAngle = %.15f;\n",this.m_lowerAngle),t("  jd.upperAngle = %.15f;\n",this.m_upperAngle),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(bi);Hi.InitVelocityConstraints_s_P=new bt,Hi.SolveVelocityConstraints_s_P=new bt,Hi.SolveVelocityConstraints_s_Cdot_v2=new bt,Hi.SolveVelocityConstraints_s_Cdot1=new bt,Hi.SolveVelocityConstraints_s_impulse_v3=new Et,Hi.SolveVelocityConstraints_s_reduced_v2=new bt,Hi.SolveVelocityConstraints_s_impulse_v2=new bt,Hi.SolvePositionConstraints_s_C_v2=new bt,Hi.SolvePositionConstraints_s_impulse=new bt;var ji=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_ropeJoint)||this).localAnchorA=new bt(-1,0),n.localAnchorB=new bt(1,0),n.maxLength=0,n}return F(n,e),n}(Ci),Wi=function(e){function i(i){var r;return(r=e.call(this,i)||this).m_localAnchorA=new bt,r.m_localAnchorB=new bt,r.m_maxLength=0,r.m_length=0,r.m_impulse=0,r.m_indexA=0,r.m_indexB=0,r.m_u=new bt,r.m_rA=new bt,r.m_rB=new bt,r.m_localCenterA=new bt,r.m_localCenterB=new bt,r.m_invMassA=0,r.m_invMassB=0,r.m_invIA=0,r.m_invIB=0,r.m_mass=0,r.m_state=t.b2LimitState.e_inactiveLimit,r.m_qA=new It,r.m_qB=new It,r.m_lalcA=new bt,r.m_lalcB=new bt,r.m_localAnchorA.Copy(n(i.localAnchorA,new bt(-1,0))),r.m_localAnchorB.Copy(n(i.localAnchorB,new bt(1,0))),r.m_maxLength=n(i.maxLength,0),r}F(i,e);var r=i.prototype;return r.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=e.positions[this.m_indexA].c,r=e.positions[this.m_indexA].a,o=e.velocities[this.m_indexA].v,a=e.velocities[this.m_indexA].w,s=e.positions[this.m_indexB].c,c=e.positions[this.m_indexB].a,l=e.velocities[this.m_indexB].v,u=e.velocities[this.m_indexB].w,_=this.m_qA.SetAngle(r),f=this.m_qB.SetAngle(c);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(_,this.m_lalcA,this.m_rA),bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(f,this.m_lalcB,this.m_rB),this.m_u.Copy(s).SelfAdd(this.m_rB).SelfSub(n).SelfSub(this.m_rA),this.m_length=this.m_u.Length();var p=this.m_length-this.m_maxLength;if(this.m_state=p>0?t.b2LimitState.e_atUpperLimit:t.b2LimitState.e_inactiveLimit,!(this.m_length>h))return this.m_u.SetZero(),this.m_mass=0,void(this.m_impulse=0);this.m_u.SelfMul(1/this.m_length);var d=bt.CrossVV(this.m_rA,this.m_u),m=bt.CrossVV(this.m_rB,this.m_u),v=this.m_invMassA+this.m_invIA*d*d+this.m_invMassB+this.m_invIB*m*m;if(this.m_mass=0!==v?1/v:0,e.step.warmStarting){this.m_impulse*=e.step.dtRatio;var g=bt.MulSV(this.m_impulse,this.m_u,i.InitVelocityConstraints_s_P);o.SelfMulSub(this.m_invMassA,g),a-=this.m_invIA*bt.CrossVV(this.m_rA,g),l.SelfMulAdd(this.m_invMassB,g),u+=this.m_invIB*bt.CrossVV(this.m_rB,g)}else this.m_impulse=0;e.velocities[this.m_indexA].w=a,e.velocities[this.m_indexB].w=u},r.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=bt.AddVCrossSV(e,n,this.m_rA,i.SolveVelocityConstraints_s_vpA),s=bt.AddVCrossSV(r,o,this.m_rB,i.SolveVelocityConstraints_s_vpB),c=this.m_length-this.m_maxLength,l=bt.DotVV(this.m_u,bt.SubVV(s,a,bt.s_t0));c<0&&(l+=t.step.inv_dt*c);var u=-this.m_mass*l,h=this.m_impulse;this.m_impulse=rt(0,this.m_impulse+u),u=this.m_impulse-h;var _=bt.MulSV(u,this.m_u,i.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,_),n-=this.m_invIA*bt.CrossVV(this.m_rA,_),r.SelfMulAdd(this.m_invMassB,_),o+=this.m_invIB*bt.CrossVV(this.m_rB,_),t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=o},r.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(n),s=this.m_qB.SetAngle(o);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var c=It.MulRV(a,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var l=It.MulRV(s,this.m_lalcB,this.m_rB),u=this.m_u.Copy(r).SelfAdd(l).SelfSub(e).SelfSub(c),_=u.Normalize(),f=_-this.m_maxLength;f=at(f,0,v);var p=-this.m_mass*f,d=bt.MulSV(p,u,i.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,d),n-=this.m_invIA*bt.CrossVV(c,d),r.SelfMulAdd(this.m_invMassB,d),o+=this.m_invIB*bt.CrossVV(l,d),t.positions[this.m_indexA].a=n,t.positions[this.m_indexB].a=o,_-this.m_maxLength<h},r.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},r.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},r.GetReactionForce=function(t,e){return bt.MulSV(t*this.m_impulse,this.m_u,e)},r.GetReactionTorque=function(){return 0},r.GetLocalAnchorA=function(){return this.m_localAnchorA},r.GetLocalAnchorB=function(){return this.m_localAnchorB},r.SetMaxLength=function(t){this.m_maxLength=t},r.GetMaxLength=function(){return this.m_maxLength},r.GetLimitState=function(){return this.m_state},r.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2RopeJointDef = new b2RopeJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxLength = %.15f;\n",this.m_maxLength),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(bi);Wi.InitVelocityConstraints_s_P=new bt,Wi.SolveVelocityConstraints_s_vpA=new bt,Wi.SolveVelocityConstraints_s_vpB=new bt,Wi.SolveVelocityConstraints_s_P=new bt,Wi.SolvePositionConstraints_s_P=new bt;var qi=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_weldJoint)||this).localAnchorA=new bt,n.localAnchorB=new bt,n.referenceAngle=0,n.frequencyHz=0,n.dampingRatio=0,n}return F(n,e),n.prototype.Initialize=function(t,e,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},n}(Ci),Xi=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_frequencyHz=0,i.m_dampingRatio=0,i.m_bias=0,i.m_localAnchorA=new bt,i.m_localAnchorB=new bt,i.m_referenceAngle=0,i.m_gamma=0,i.m_impulse=new Et(0,0,0),i.m_indexA=0,i.m_indexB=0,i.m_rA=new bt,i.m_rB=new bt,i.m_localCenterA=new bt,i.m_localCenterB=new bt,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_mass=new Pt,i.m_qA=new It,i.m_qB=new It,i.m_lalcA=new bt,i.m_lalcB=new bt,i.m_K=new Pt,i.m_frequencyHz=n(e.frequencyHz,0),i.m_dampingRatio=n(e.dampingRatio,0),i.m_localAnchorA.Copy(n(e.localAnchorA,bt.ZERO)),i.m_localAnchorB.Copy(n(e.localAnchorB,bt.ZERO)),i.m_referenceAngle=n(e.referenceAngle,0),i.m_impulse.SetZero(),i}F(e,t);var i=e.prototype;return i.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v,r=t.velocities[this.m_indexA].w,o=t.positions[this.m_indexB].a,s=t.velocities[this.m_indexB].v,c=t.velocities[this.m_indexB].w,l=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(o);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(l,this.m_lalcA,this.m_rA),bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(u,this.m_lalcB,this.m_rB);var h=this.m_invMassA,_=this.m_invMassB,f=this.m_invIA,p=this.m_invIB,d=this.m_K;if(d.ex.x=h+_+this.m_rA.y*this.m_rA.y*f+this.m_rB.y*this.m_rB.y*p,d.ey.x=-this.m_rA.y*this.m_rA.x*f-this.m_rB.y*this.m_rB.x*p,d.ez.x=-this.m_rA.y*f-this.m_rB.y*p,d.ex.y=d.ey.x,d.ey.y=h+_+this.m_rA.x*this.m_rA.x*f+this.m_rB.x*this.m_rB.x*p,d.ez.y=this.m_rA.x*f+this.m_rB.x*p,d.ex.z=d.ez.x,d.ey.z=d.ez.y,d.ez.z=f+p,this.m_frequencyHz>0){d.GetInverse22(this.m_mass);var m=f+p,v=m>0?1/m:0,g=o-n-this.m_referenceAngle,y=2*a*this.m_frequencyHz,x=2*v*this.m_dampingRatio*y,S=v*y*y,A=t.step.dt;this.m_gamma=A*(x+A*S),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=g*A*S*this.m_gamma,m+=this.m_gamma,this.m_mass.ez.z=0!==m?1/m:0}else d.GetSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio);var C=e.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(h,C),r-=f*(bt.CrossVV(this.m_rA,C)+this.m_impulse.z),s.SelfMulAdd(_,C),c+=p*(bt.CrossVV(this.m_rB,C)+this.m_impulse.z)}else this.m_impulse.SetZero();t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=c},i.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=this.m_invMassA,s=this.m_invMassB,c=this.m_invIA,l=this.m_invIB;if(this.m_frequencyHz>0){var u=o-i,h=-this.m_mass.ez.z*(u+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=h,i-=c*h,o+=l*h;var _=bt.SubVV(bt.AddVCrossSV(r,o,this.m_rB,bt.s_t0),bt.AddVCrossSV(n,i,this.m_rA,bt.s_t1),e.SolveVelocityConstraints_s_Cdot1),f=Pt.MulM33XY(this.m_mass,_.x,_.y,e.SolveVelocityConstraints_s_impulse1).SelfNeg();this.m_impulse.x+=f.x,this.m_impulse.y+=f.y;var p=f;n.SelfMulSub(a,p),i-=c*bt.CrossVV(this.m_rA,p),r.SelfMulAdd(s,p),o+=l*bt.CrossVV(this.m_rB,p)}else{var d=bt.SubVV(bt.AddVCrossSV(r,o,this.m_rB,bt.s_t0),bt.AddVCrossSV(n,i,this.m_rA,bt.s_t1),e.SolveVelocityConstraints_s_Cdot1),m=o-i,v=Pt.MulM33XYZ(this.m_mass,d.x,d.y,m,e.SolveVelocityConstraints_s_impulse).SelfNeg();this.m_impulse.SelfAdd(v);var g=e.SolveVelocityConstraints_s_P.Set(v.x,v.y);n.SelfMulSub(a,g),i-=c*(bt.CrossVV(this.m_rA,g)+v.z),r.SelfMulAdd(s,g),o+=l*(bt.CrossVV(this.m_rB,g)+v.z)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(t){var n=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),s=this.m_qB.SetAngle(o),c=this.m_invMassA,l=this.m_invMassB,u=this.m_invIA,f=this.m_invIB;bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var p=It.MulRV(a,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var d,m,v=It.MulRV(s,this.m_lalcB,this.m_rB),g=this.m_K;if(g.ex.x=c+l+p.y*p.y*u+v.y*v.y*f,g.ey.x=-p.y*p.x*u-v.y*v.x*f,g.ez.x=-p.y*u-v.y*f,g.ex.y=g.ey.x,g.ey.y=c+l+p.x*p.x*u+v.x*v.x*f,g.ez.y=p.x*u+v.x*f,g.ex.z=g.ez.x,g.ey.z=g.ez.y,g.ez.z=u+f,this.m_frequencyHz>0){var y=bt.SubVV(bt.AddVV(r,v,bt.s_t0),bt.AddVV(n,p,bt.s_t1),e.SolvePositionConstraints_s_C1);d=y.Length(),m=0;var x=g.Solve22(y.x,y.y,e.SolvePositionConstraints_s_P).SelfNeg();n.SelfMulSub(c,x),i-=u*bt.CrossVV(p,x),r.SelfMulAdd(l,x),o+=f*bt.CrossVV(v,x)}else{var S=bt.SubVV(bt.AddVV(r,v,bt.s_t0),bt.AddVV(n,p,bt.s_t1),e.SolvePositionConstraints_s_C1),A=o-i-this.m_referenceAngle;d=S.Length(),m=it(A);var C=g.Solve33(S.x,S.y,A,e.SolvePositionConstraints_s_impulse).SelfNeg(),b=e.SolvePositionConstraints_s_P.Set(C.x,C.y);n.SelfMulSub(c,b),i-=u*(bt.CrossVV(this.m_rA,b)+C.z),r.SelfMulAdd(l,b),o+=f*(bt.CrossVV(this.m_rB,b)+C.z)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,d<=h&&m<=_},i.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.GetReactionForce=function(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e},i.GetReactionTorque=function(t){return t*this.m_impulse.z},i.GetLocalAnchorA=function(){return this.m_localAnchorA},i.GetLocalAnchorB=function(){return this.m_localAnchorB},i.GetReferenceAngle=function(){return this.m_referenceAngle},i.SetFrequency=function(t){this.m_frequencyHz=t},i.GetFrequency=function(){return this.m_frequencyHz},i.SetDampingRatio=function(t){this.m_dampingRatio=t},i.GetDampingRatio=function(){return this.m_dampingRatio},i.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2WeldJointDef = new b2WeldJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},e}(bi);Xi.InitVelocityConstraints_s_P=new bt,Xi.SolveVelocityConstraints_s_Cdot1=new bt,Xi.SolveVelocityConstraints_s_impulse1=new bt,Xi.SolveVelocityConstraints_s_impulse=new Et,Xi.SolveVelocityConstraints_s_P=new bt,Xi.SolvePositionConstraints_s_C1=new bt,Xi.SolvePositionConstraints_s_P=new bt,Xi.SolvePositionConstraints_s_impulse=new Et;var Yi=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_wheelJoint)||this).localAnchorA=new bt(0,0),n.localAnchorB=new bt(0,0),n.localAxisA=new bt(1,0),n.enableMotor=!1,n.maxMotorTorque=0,n.motorSpeed=0,n.frequencyHz=2,n.dampingRatio=.7,n}return F(n,e),n.prototype.Initialize=function(t,e,n,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.bodyA.GetLocalVector(i,this.localAxisA)},n}(Ci),Ki=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_frequencyHz=0,i.m_dampingRatio=0,i.m_localAnchorA=new bt,i.m_localAnchorB=new bt,i.m_localXAxisA=new bt,i.m_localYAxisA=new bt,i.m_impulse=0,i.m_motorImpulse=0,i.m_springImpulse=0,i.m_maxMotorTorque=0,i.m_motorSpeed=0,i.m_enableMotor=!1,i.m_indexA=0,i.m_indexB=0,i.m_localCenterA=new bt,i.m_localCenterB=new bt,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_ax=new bt,i.m_ay=new bt,i.m_sAx=0,i.m_sBx=0,i.m_sAy=0,i.m_sBy=0,i.m_mass=0,i.m_motorMass=0,i.m_springMass=0,i.m_bias=0,i.m_gamma=0,i.m_qA=new It,i.m_qB=new It,i.m_lalcA=new bt,i.m_lalcB=new bt,i.m_rA=new bt,i.m_rB=new bt,i.m_frequencyHz=n(e.frequencyHz,2),i.m_dampingRatio=n(e.dampingRatio,.7),i.m_localAnchorA.Copy(n(e.localAnchorA,bt.ZERO)),i.m_localAnchorB.Copy(n(e.localAnchorB,bt.ZERO)),i.m_localXAxisA.Copy(n(e.localAxisA,bt.UNITX)),bt.CrossOneV(i.m_localXAxisA,i.m_localYAxisA),i.m_maxMotorTorque=n(e.maxMotorTorque,0),i.m_motorSpeed=n(e.motorSpeed,0),i.m_enableMotor=n(e.enableMotor,!1),i.m_ax.SetZero(),i.m_ay.SetZero(),i}F(e,t);var i=e.prototype;return i.GetMotorSpeed=function(){return this.m_motorSpeed},i.GetMaxMotorTorque=function(){return this.m_maxMotorTorque},i.SetSpringFrequencyHz=function(t){this.m_frequencyHz=t},i.GetSpringFrequencyHz=function(){return this.m_frequencyHz},i.SetSpringDampingRatio=function(t){this.m_dampingRatio=t},i.GetSpringDampingRatio=function(){return this.m_dampingRatio},i.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=this.m_invMassA,i=this.m_invMassB,r=this.m_invIA,o=this.m_invIB,s=t.positions[this.m_indexA].c,c=t.positions[this.m_indexA].a,l=t.velocities[this.m_indexA].v,u=t.velocities[this.m_indexA].w,h=t.positions[this.m_indexB].c,_=t.positions[this.m_indexB].a,f=t.velocities[this.m_indexB].v,p=t.velocities[this.m_indexB].w,d=this.m_qA.SetAngle(c),m=this.m_qB.SetAngle(_);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var v=It.MulRV(d,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var g=It.MulRV(m,this.m_lalcB,this.m_rB),y=bt.SubVV(bt.AddVV(h,g,bt.s_t0),bt.AddVV(s,v,bt.s_t1),e.InitVelocityConstraints_s_d);if(It.MulRV(d,this.m_localYAxisA,this.m_ay),this.m_sAy=bt.CrossVV(bt.AddVV(y,v,bt.s_t0),this.m_ay),this.m_sBy=bt.CrossVV(g,this.m_ay),this.m_mass=n+i+r*this.m_sAy*this.m_sAy+o*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_frequencyHz>0){It.MulRV(d,this.m_localXAxisA,this.m_ax),this.m_sAx=bt.CrossVV(bt.AddVV(y,v,bt.s_t0),this.m_ax),this.m_sBx=bt.CrossVV(g,this.m_ax);var x=n+i+r*this.m_sAx*this.m_sAx+o*this.m_sBx*this.m_sBx;if(x>0){this.m_springMass=1/x;var S=bt.DotVV(y,this.m_ax),A=2*a*this.m_frequencyHz,C=2*this.m_springMass*this.m_dampingRatio*A,b=this.m_springMass*A*A,T=t.step.dt;this.m_gamma=T*(C+T*b),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=S*T*b*this.m_gamma,this.m_springMass=x+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=r+o,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_springImpulse*=t.step.dtRatio,this.m_motorImpulse*=t.step.dtRatio;var E=bt.AddVV(bt.MulSV(this.m_impulse,this.m_ay,bt.s_t0),bt.MulSV(this.m_springImpulse,this.m_ax,bt.s_t1),e.InitVelocityConstraints_s_P),w=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,P=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;l.SelfMulSub(this.m_invMassA,E),u-=this.m_invIA*w,f.SelfMulAdd(this.m_invMassB,E),p+=this.m_invIB*P}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;t.velocities[this.m_indexA].w=u,t.velocities[this.m_indexB].w=p},i.SolveVelocityConstraints=function(t){var n=this.m_invMassA,i=this.m_invMassB,r=this.m_invIA,o=this.m_invIB,a=t.velocities[this.m_indexA].v,s=t.velocities[this.m_indexA].w,c=t.velocities[this.m_indexB].v,l=t.velocities[this.m_indexB].w,u=bt.DotVV(this.m_ax,bt.SubVV(c,a,bt.s_t0))+this.m_sBx*l-this.m_sAx*s,h=-this.m_springMass*(u+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=h;var _=bt.MulSV(h,this.m_ax,e.SolveVelocityConstraints_s_P),f=h*this.m_sAx,p=h*this.m_sBx;a.SelfMulSub(n,_),s-=r*f,c.SelfMulAdd(i,_);var d=(l+=o*p)-s-this.m_motorSpeed,m=-this.m_motorMass*d,v=this.m_motorImpulse,g=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=at(this.m_motorImpulse+m,-g,g),s-=r*(m=this.m_motorImpulse-v),l+=o*m;var y=bt.DotVV(this.m_ay,bt.SubVV(c,a,bt.s_t0))+this.m_sBy*l-this.m_sAy*s,x=-this.m_mass*y;this.m_impulse+=x;var S=bt.MulSV(x,this.m_ay,e.SolveVelocityConstraints_s_P),A=x*this.m_sAy,C=x*this.m_sBy;a.SelfMulSub(n,S),s-=r*A,c.SelfMulAdd(i,S),l+=o*C,t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=l},i.SolvePositionConstraints=function(t){var n=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),s=this.m_qB.SetAngle(o);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var c=It.MulRV(a,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var l,u=It.MulRV(s,this.m_lalcB,this.m_rB),_=bt.AddVV(bt.SubVV(r,n,bt.s_t0),bt.SubVV(u,c,bt.s_t1),e.SolvePositionConstraints_s_d),f=It.MulRV(a,this.m_localYAxisA,this.m_ay),p=bt.CrossVV(bt.AddVV(_,c,bt.s_t0),f),d=bt.CrossVV(u,f),m=bt.DotVV(_,this.m_ay),v=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;l=0!==v?-m/v:0;var g=bt.MulSV(l,f,e.SolvePositionConstraints_s_P),y=l*p,x=l*d;return n.SelfMulSub(this.m_invMassA,g),i-=this.m_invIA*y,r.SelfMulAdd(this.m_invMassB,g),o+=this.m_invIB*x,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,it(m)<=h},i.GetDefinition=function(t){return t},i.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.GetReactionForce=function(t,e){return e.x=t*(this.m_impulse*this.m_ay.x+this.m_springImpulse*this.m_ax.x),e.y=t*(this.m_impulse*this.m_ay.y+this.m_springImpulse*this.m_ax.y),e},i.GetReactionTorque=function(t){return t*this.m_motorImpulse},i.GetLocalAnchorA=function(){return this.m_localAnchorA},i.GetLocalAnchorB=function(){return this.m_localAnchorB},i.GetLocalAxisA=function(){return this.m_localXAxisA},i.GetJointTranslation=function(){return this.GetPrismaticJointTranslation()},i.GetJointLinearSpeed=function(){return this.GetPrismaticJointSpeed()},i.GetJointAngle=function(){return this.GetRevoluteJointAngle()},i.GetJointAngularSpeed=function(){return this.GetRevoluteJointSpeed()},i.GetPrismaticJointTranslation=function(){var t=this.m_bodyA,e=this.m_bodyB,n=t.GetWorldPoint(this.m_localAnchorA,new bt),i=e.GetWorldPoint(this.m_localAnchorB,new bt),r=bt.SubVV(i,n,new bt),o=t.GetWorldVector(this.m_localXAxisA,new bt);return bt.DotVV(r,o)},i.GetPrismaticJointSpeed=function(){var t=this.m_bodyA,e=this.m_bodyB;bt.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);var n=It.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);var i=It.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),r=bt.AddVV(t.m_sweep.c,n,bt.s_t0),o=bt.AddVV(e.m_sweep.c,i,bt.s_t1),a=bt.SubVV(o,r,bt.s_t2),s=t.GetWorldVector(this.m_localXAxisA,new bt),c=t.m_linearVelocity,l=e.m_linearVelocity,u=t.m_angularVelocity,h=e.m_angularVelocity;return bt.DotVV(a,bt.CrossSV(u,s,bt.s_t0))+bt.DotVV(s,bt.SubVV(bt.AddVCrossSV(l,h,i,bt.s_t0),bt.AddVCrossSV(c,u,n,bt.s_t1),bt.s_t0))},i.GetRevoluteJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a},i.GetRevoluteJointSpeed=function(){var t=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-t},i.IsMotorEnabled=function(){return this.m_enableMotor},i.EnableMotor=function(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},i.SetMotorSpeed=function(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},i.SetMaxMotorTorque=function(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)},i.GetMotorTorque=function(t){return t*this.m_motorImpulse},i.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2WheelJointDef = new b2WheelJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},e}(bi);function Ji(t,e){return ht(t*e)}function Qi(t,e){return t>e?t:e}Ki.InitVelocityConstraints_s_d=new bt,Ki.InitVelocityConstraints_s_P=new bt,Ki.SolveVelocityConstraints_s_P=new bt,Ki.SolvePositionConstraints_s_d=new bt,Ki.SolvePositionConstraints_s_P=new bt;var Zi=function(){function t(t){this._other=null,this.prev=null,this.next=null,this.contact=t}return t.prototype.Reset=function(){this._other=null,this.prev=null,this.next=null},N(t,[{key:"other",get:function(){if(null===this._other)throw new Error;return this._other},set:function(t){if(null!==this._other)throw new Error;this._other=t}}]),t}(),$i=function(){function t(){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_prev=null,this.m_next=null,this.m_nodeA=new Zi(this),this.m_nodeB=new Zi(this),this.m_indexA=0,this.m_indexB=0,this.m_manifold=new ye,this.m_toiCount=0,this.m_toi=0,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_oldManifold=new ye}var e=t.prototype;return e.GetManifold=function(){return this.m_manifold},e.GetWorldManifold=function(t){var e=this.m_fixtureA.GetBody(),n=this.m_fixtureB.GetBody(),i=this.GetShapeA(),r=this.GetShapeB();t.Initialize(this.m_manifold,e.GetTransform(),i.m_radius,n.GetTransform(),r.m_radius)},e.IsTouching=function(){return this.m_touchingFlag},e.SetEnabled=function(t){this.m_enabledFlag=t},e.IsEnabled=function(){return this.m_enabledFlag},e.GetNext=function(){return this.m_next},e.GetFixtureA=function(){return this.m_fixtureA},e.GetChildIndexA=function(){return this.m_indexA},e.GetShapeA=function(){return this.m_fixtureA.GetShape()},e.GetFixtureB=function(){return this.m_fixtureB},e.GetChildIndexB=function(){return this.m_indexB},e.GetShapeB=function(){return this.m_fixtureB.GetShape()},e.FlagForFiltering=function(){this.m_filterFlag=!0},e.SetFriction=function(t){this.m_friction=t},e.GetFriction=function(){return this.m_friction},e.ResetFriction=function(){this.m_friction=Ji(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction)},e.SetRestitution=function(t){this.m_restitution=t},e.GetRestitution=function(){return this.m_restitution},e.ResetRestitution=function(){this.m_restitution=Qi(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},e.SetTangentSpeed=function(t){this.m_tangentSpeed=t},e.GetTangentSpeed=function(){return this.m_tangentSpeed},e.Reset=function(t,e,n,i){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!0,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_fixtureA=t,this.m_fixtureB=n,this.m_indexA=e,this.m_indexB=i,this.m_manifold.pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.Reset(),this.m_nodeB.Reset(),this.m_toiCount=0,this.m_friction=Ji(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=Qi(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},e.Update=function(t){var e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_enabledFlag=!0;var n=!1,i=this.m_touchingFlag,r=this.m_fixtureA.IsSensor(),o=this.m_fixtureB.IsSensor(),a=r||o,s=this.m_fixtureA.GetBody(),c=this.m_fixtureB.GetBody(),l=s.GetTransform(),u=c.GetTransform();if(a){var h=this.GetShapeA(),_=this.GetShapeB();n=De(h,this.m_indexA,_,this.m_indexB,l,u),this.m_manifold.pointCount=0}else{this.Evaluate(this.m_manifold,l,u),n=this.m_manifold.pointCount>0;for(var f=0;f<this.m_manifold.pointCount;++f){var p=this.m_manifold.points[f];p.normalImpulse=0,p.tangentImpulse=0;for(var d=p.id,m=0;m<this.m_oldManifold.pointCount;++m){var v=this.m_oldManifold.points[m];if(v.id.key===d.key){p.normalImpulse=v.normalImpulse,p.tangentImpulse=v.tangentImpulse;break}}}n!==i&&(s.SetAwake(!0),c.SetAwake(!0))}this.m_touchingFlag=n,!i&&n&&t&&t.BeginContact(this),i&&!n&&t&&t.EndContact(this),!a&&n&&t&&t.PreSolve(this,this.m_oldManifold)},e.ComputeTOI=function(e,n){var i=t.ComputeTOI_s_input;i.proxyA.SetShape(this.GetShapeA(),this.m_indexA),i.proxyB.SetShape(this.GetShapeB(),this.m_indexB),i.sweepA.Copy(e),i.sweepB.Copy(n),i.tMax=h;var r=t.ComputeTOI_s_output;return un(r,i),r.t},t}();$i.ComputeTOI_s_input=new Je,$i.ComputeTOI_s_output=new Ze;var tr=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,n){fn(t,this.GetShapeA(),e,this.GetShapeB(),n)},e}($i),er=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,n){Un(t,this.GetShapeA(),e,this.GetShapeB(),n)},e}($i),nr=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,n){vn(t,this.GetShapeA(),e,this.GetShapeB(),n)},e}($i),ir=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,n){Qn(t,this.GetShapeA(),e,this.GetShapeB(),n)},e}($i),rr=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,n){ri(t,this.GetShapeA(),e,this.GetShapeB(),n)},e}($i),or=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,n,i){var r=e.Evaluate_s_edge;this.GetShapeA().GetChildEdge(r,this.m_indexA),Qn(t,r,n,this.GetShapeB(),i)},e}($i);or.Evaluate_s_edge=new ui;var ar=function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,n,i){var r=e.Evaluate_s_edge;this.GetShapeA().GetChildEdge(r,this.m_indexA),ri(t,r,n,this.GetShapeB(),i)},e}($i);ar.Evaluate_s_edge=new ui;var sr=function(){this.pool=[],this.createFcn=null,this.destroyFcn=null,this.primary=!1},cr=function(){function e(){this.m_registers=[],this.InitializeRegisters()}var n=e.prototype;return n.AddType=function(t,e,n,i){var r=[];function o(){return r.pop()||t()}function a(t){r.push(t)}this.m_registers[n][i].pool=r,this.m_registers[n][i].createFcn=o,this.m_registers[n][i].destroyFcn=a,this.m_registers[n][i].primary=!0,n!==i&&(this.m_registers[i][n].pool=r,this.m_registers[i][n].createFcn=o,this.m_registers[i][n].destroyFcn=a,this.m_registers[i][n].primary=!1)},n.InitializeRegisters=function(){for(var e=0;e<t.b2ShapeType.e_shapeTypeCount;e++){this.m_registers[e]=[];for(var n=0;n<t.b2ShapeType.e_shapeTypeCount;n++)this.m_registers[e][n]=new sr}this.AddType(tr.Create,tr.Destroy,t.b2ShapeType.e_circleShape,t.b2ShapeType.e_circleShape),this.AddType(nr.Create,nr.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_circleShape),this.AddType(er.Create,er.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_polygonShape),this.AddType(ir.Create,ir.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_circleShape),this.AddType(rr.Create,rr.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_polygonShape),this.AddType(or.Create,or.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_circleShape),this.AddType(ar.Create,ar.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_polygonShape)},n.Create=function(t,e,n,i){var r=t.GetType(),o=n.GetType(),a=this.m_registers[r][o];if(a.createFcn){var s=a.createFcn();return a.primary?s.Reset(t,e,n,i):s.Reset(n,i,t,e),s}return null},n.Destroy=function(t){var e=t.m_fixtureA.GetType(),n=t.m_fixtureB.GetType(),i=this.m_registers[e][n];i.destroyFcn&&i.destroyFcn(t)},e}(),lr=function(){function t(){}var e=t.prototype;return e.SayGoodbyeJoint=function(){},e.SayGoodbyeFixture=function(){},e.SayGoodbyeParticleGroup=function(){},e.SayGoodbyeParticle=function(){},t}(),ur=function(){function e(){}var n=e.prototype;return n.ShouldCollide=function(e,n){var i=e.GetBody(),r=n.GetBody();if(r.GetType()===t.b2BodyType.b2_staticBody&&i.GetType()===t.b2BodyType.b2_staticBody)return!1;if(!r.ShouldCollideConnected(i))return!1;var o=e.GetFilterData(),a=n.GetFilterData();return o.groupIndex===a.groupIndex&&0!==o.groupIndex?o.groupIndex>0:0!=(o.maskBits&a.categoryBits)&&0!=(o.categoryBits&a.maskBits)},n.ShouldCollideFixtureParticle=function(){return!0},n.ShouldCollideParticleParticle=function(){return!0},e}();ur.b2_defaultFilter=new ur;var hr=function(){this.normalImpulses=$(s),this.tangentImpulses=$(s),this.count=0},_r=function(){function t(){}var e=t.prototype;return e.BeginContact=function(){},e.EndContact=function(){},e.BeginContactFixtureParticle=function(){},e.EndContactFixtureParticle=function(){},e.BeginContactParticleParticle=function(){},e.EndContactParticleParticle=function(){},e.PreSolve=function(){},e.PostSolve=function(){},t}();_r.b2_defaultListener=new _r;var fr=function(){function t(){}var e=t.prototype;return e.ReportFixture=function(){return!0},e.ReportParticle=function(){return!1},e.ShouldQueryParticleSystem=function(){return!0},t}(),pr=function(){function t(){}var e=t.prototype;return e.ReportFixture=function(t,e,n,i){return i},e.ReportParticle=function(){return 0},e.ShouldQueryParticleSystem=function(){return!0},t}(),dr=function(){function e(){this.m_broadPhase=new Ve,this.m_contactList=null,this.m_contactCount=0,this.m_contactFilter=ur.b2_defaultFilter,this.m_contactListener=_r.b2_defaultListener,this.m_contactFactory=new cr}var n=e.prototype;return n.AddPair=function(t,e){var n=t.fixture,i=e.fixture,r=t.childIndex,o=e.childIndex,a=n.GetBody(),s=i.GetBody();if(a!==s){for(var c=s.GetContactList();c;){if(c.other===a){var l=c.contact.GetFixtureA(),u=c.contact.GetFixtureB(),h=c.contact.GetChildIndexA(),_=c.contact.GetChildIndexB();if(l===n&&u===i&&h===r&&_===o)return;if(l===i&&u===n&&h===o&&_===r)return}c=c.next}if(!this.m_contactFilter||this.m_contactFilter.ShouldCollide(n,i)){var f=this.m_contactFactory.Create(n,r,i,o);null!==f&&(n=f.GetFixtureA(),i=f.GetFixtureB(),r=f.GetChildIndexA(),o=f.GetChildIndexB(),a=n.m_body,s=i.m_body,f.m_prev=null,f.m_next=this.m_contactList,null!==this.m_contactList&&(this.m_contactList.m_prev=f),this.m_contactList=f,f.m_nodeA.other=s,f.m_nodeA.prev=null,f.m_nodeA.next=a.m_contactList,null!==a.m_contactList&&(a.m_contactList.prev=f.m_nodeA),a.m_contactList=f.m_nodeA,f.m_nodeB.other=a,f.m_nodeB.prev=null,f.m_nodeB.next=s.m_contactList,null!==s.m_contactList&&(s.m_contactList.prev=f.m_nodeB),s.m_contactList=f.m_nodeB,n.IsSensor()||i.IsSensor()||(a.SetAwake(!0),s.SetAwake(!0)),++this.m_contactCount)}}},n.FindNewContacts=function(){var t=this;this.m_broadPhase.UpdatePairs((function(e,n){t.AddPair(e,n)}))},n.Destroy=function(t){var e=t.GetFixtureA(),n=t.GetFixtureB(),i=e.GetBody(),r=n.GetBody();this.m_contactListener&&t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_contactList&&(this.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA===i.m_contactList&&(i.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB===r.m_contactList&&(r.m_contactList=t.m_nodeB.next),t.m_manifold.pointCount>0&&!e.IsSensor()&&!n.IsSensor()&&(e.GetBody().SetAwake(!0),n.GetBody().SetAwake(!0)),this.m_contactFactory.Destroy(t),--this.m_contactCount},n.Collide=function(){for(var e=this.m_contactList;e;){var n=e.GetFixtureA(),i=e.GetFixtureB(),r=e.GetChildIndexA(),o=e.GetChildIndexB(),a=n.GetBody(),s=i.GetBody();if(e.m_filterFlag){if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(n,i)){var c=e;e=c.m_next,this.Destroy(c);continue}e.m_filterFlag=!1}var l=a.IsAwake()&&a.m_type!==t.b2BodyType.b2_staticBody,u=s.IsAwake()&&s.m_type!==t.b2BodyType.b2_staticBody;if(l||u){var h=n.m_proxies[r].treeNode,_=i.m_proxies[o].treeNode;if(Ee(h.aabb,_.aabb))e.Update(this.m_contactListener),e=e.m_next;else{var f=e;e=f.m_next,this.Destroy(f)}}else e=e.m_next}},e}(),mr=function(){function t(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}return t.prototype.Reset=function(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this},t}(),vr=function(){function t(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.particleIterations=0,this.warmStarting=!1}return t.prototype.Copy=function(t){return this.dt=t.dt,this.inv_dt=t.inv_dt,this.dtRatio=t.dtRatio,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.particleIterations=t.particleIterations,this.warmStarting=t.warmStarting,this},t}(),gr=function(){function t(){this.c=new bt,this.a=0}return t.MakeArray=function(e){return Q(e,(function(){return new t}))},t}(),yr=function(){function t(){this.v=new bt,this.w=0}return t.MakeArray=function(e){return Q(e,(function(){return new t}))},t}(),xr=function(){this.step=new vr},Sr=!1,Ar=function(){function t(){this.rA=new bt,this.rB=new bt,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}return t.MakeArray=function(e){return Q(e,(function(){return new t}))},t}(),Cr=function(){function t(){this.points=Ar.MakeArray(s),this.normal=new bt,this.tangent=new bt,this.normalMass=new wt,this.K=new wt,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}return t.MakeArray=function(e){return Q(e,(function(){return new t}))},t}(),br=function(){function e(){this.localPoints=bt.MakeArray(s),this.localNormal=new bt,this.localPoint=new bt,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new bt,this.localCenterB=new bt,this.invIA=0,this.invIB=0,this.type=t.b2ManifoldType.e_unknown,this.radiusA=0,this.radiusB=0,this.pointCount=0}return e.MakeArray=function(t){return Q(t,(function(){return new e}))},e}(),Tr=function(){this.step=new vr,this.count=0},Er=function(){function e(){this.normal=new bt,this.point=new bt,this.separation=0}return e.prototype.Initialize=function(n,i,r,o){var a=e.Initialize_s_pointA,s=e.Initialize_s_pointB,c=e.Initialize_s_planePoint,l=e.Initialize_s_clipPoint;switch(n.type){case t.b2ManifoldType.e_circles:Rt.MulXV(i,n.localPoint,a),Rt.MulXV(r,n.localPoints[0],s),bt.SubVV(s,a,this.normal).SelfNormalize(),bt.MidVV(a,s,this.point),this.separation=bt.DotVV(bt.SubVV(s,a,bt.s_t0),this.normal)-n.radiusA-n.radiusB;break;case t.b2ManifoldType.e_faceA:It.MulRV(i.q,n.localNormal,this.normal),Rt.MulXV(i,n.localPoint,c),Rt.MulXV(r,n.localPoints[o],l),this.separation=bt.DotVV(bt.SubVV(l,c,bt.s_t0),this.normal)-n.radiusA-n.radiusB,this.point.Copy(l);break;case t.b2ManifoldType.e_faceB:It.MulRV(r.q,n.localNormal,this.normal),Rt.MulXV(r,n.localPoint,c),Rt.MulXV(i,n.localPoints[o],l),this.separation=bt.DotVV(bt.SubVV(l,c,bt.s_t0),this.normal)-n.radiusA-n.radiusB,this.point.Copy(l),this.normal.SelfNeg()}},e}();Er.Initialize_s_pointA=new bt,Er.Initialize_s_pointB=new bt,Er.Initialize_s_planePoint=new bt,Er.Initialize_s_clipPoint=new bt;var wr=function(){function t(){this.m_step=new vr,this.m_positionConstraints=br.MakeArray(1024),this.m_velocityConstraints=Cr.MakeArray(1024),this.m_count=0}var e=t.prototype;return e.Initialize=function(t){if(this.m_step.Copy(t.step),this.m_count=t.count,this.m_positionConstraints.length<this.m_count)for(var e=ot(2*this.m_positionConstraints.length,this.m_count);this.m_positionConstraints.length<e;)this.m_positionConstraints[this.m_positionConstraints.length]=new br;if(this.m_velocityConstraints.length<this.m_count)for(var n=ot(2*this.m_velocityConstraints.length,this.m_count);this.m_velocityConstraints.length<n;)this.m_velocityConstraints[this.m_velocityConstraints.length]=new Cr;this.m_positions=t.positions,this.m_velocities=t.velocities,this.m_contacts=t.contacts;for(var i=0;i<this.m_count;++i){var r=this.m_contacts[i],o=r.m_fixtureA,a=r.m_fixtureB,s=o.GetShape(),c=a.GetShape(),l=s.m_radius,u=c.m_radius,h=o.GetBody(),_=a.GetBody(),f=r.GetManifold(),p=f.pointCount,d=this.m_velocityConstraints[i];d.friction=r.m_friction,d.restitution=r.m_restitution,d.tangentSpeed=r.m_tangentSpeed,d.indexA=h.m_islandIndex,d.indexB=_.m_islandIndex,d.invMassA=h.m_invMass,d.invMassB=_.m_invMass,d.invIA=h.m_invI,d.invIB=_.m_invI,d.contactIndex=i,d.pointCount=p,d.K.SetZero(),d.normalMass.SetZero();var m=this.m_positionConstraints[i];m.indexA=h.m_islandIndex,m.indexB=_.m_islandIndex,m.invMassA=h.m_invMass,m.invMassB=_.m_invMass,m.localCenterA.Copy(h.m_sweep.localCenter),m.localCenterB.Copy(_.m_sweep.localCenter),m.invIA=h.m_invI,m.invIB=_.m_invI,m.localNormal.Copy(f.localNormal),m.localPoint.Copy(f.localPoint),m.pointCount=p,m.radiusA=l,m.radiusB=u,m.type=f.type;for(var v=0;v<p;++v){var g=f.points[v],y=d.points[v];this.m_step.warmStarting?(y.normalImpulse=this.m_step.dtRatio*g.normalImpulse,y.tangentImpulse=this.m_step.dtRatio*g.tangentImpulse):(y.normalImpulse=0,y.tangentImpulse=0),y.rA.SetZero(),y.rB.SetZero(),y.normalMass=0,y.tangentMass=0,y.velocityBias=0,m.localPoints[v].Copy(g.localPoint)}}return this},e.InitializeVelocityConstraints=function(){for(var e=t.InitializeVelocityConstraints_s_xfA,n=t.InitializeVelocityConstraints_s_xfB,i=t.InitializeVelocityConstraints_s_worldManifold,r=1e3,o=0;o<this.m_count;++o){var a=this.m_velocityConstraints[o],s=this.m_positionConstraints[o],c=s.radiusA,l=s.radiusB,u=this.m_contacts[a.contactIndex].GetManifold(),h=a.indexA,_=a.indexB,f=a.invMassA,p=a.invMassB,d=a.invIA,v=a.invIB,g=s.localCenterA,y=s.localCenterB,x=this.m_positions[h].c,S=this.m_positions[h].a,A=this.m_velocities[h].v,C=this.m_velocities[h].w,b=this.m_positions[_].c,T=this.m_positions[_].a,E=this.m_velocities[_].v,w=this.m_velocities[_].w;e.q.SetAngle(S),n.q.SetAngle(T),bt.SubVV(x,It.MulRV(e.q,g,bt.s_t0),e.p),bt.SubVV(b,It.MulRV(n.q,y,bt.s_t0),n.p),i.Initialize(u,e,c,n,l),a.normal.Copy(i.normal),bt.CrossVOne(a.normal,a.tangent);for(var P=a.pointCount,I=0;I<P;++I){var R=a.points[I];bt.SubVV(i.points[I],x,R.rA),bt.SubVV(i.points[I],b,R.rB);var D=bt.CrossVV(R.rA,a.normal),B=bt.CrossVV(R.rB,a.normal),M=f+p+d*D*D+v*B*B;R.normalMass=M>0?1/M:0;var O=a.tangent,N=bt.CrossVV(R.rA,O),L=bt.CrossVV(R.rB,O),F=f+p+d*N*N+v*L*L;R.tangentMass=F>0?1/F:0,R.velocityBias=0;var z=bt.DotVV(a.normal,bt.SubVV(bt.AddVCrossSV(E,w,R.rB,bt.s_t0),bt.AddVCrossSV(A,C,R.rA,bt.s_t1),bt.s_t0));z<-m&&(R.velocityBias+=-a.restitution*z)}if(2===a.pointCount&&Sr){var V=a.points[0],G=a.points[1],U=bt.CrossVV(V.rA,a.normal),k=bt.CrossVV(V.rB,a.normal),H=bt.CrossVV(G.rA,a.normal),j=bt.CrossVV(G.rB,a.normal),W=f+p+d*U*U+v*k*k,q=f+p+d*H*H+v*j*j,X=f+p+d*U*H+v*k*j;W*W<r*(W*q-X*X)?(a.K.ex.Set(W,X),a.K.ey.Set(X,q),a.K.GetInverse(a.normalMass)):a.pointCount=1}}},e.WarmStart=function(){for(var e=t.WarmStart_s_P,n=0;n<this.m_count;++n){for(var i=this.m_velocityConstraints[n],r=i.indexA,o=i.indexB,a=i.invMassA,s=i.invIA,c=i.invMassB,l=i.invIB,u=i.pointCount,h=this.m_velocities[r].v,_=this.m_velocities[r].w,f=this.m_velocities[o].v,p=this.m_velocities[o].w,d=i.normal,m=i.tangent,v=0;v<u;++v){var g=i.points[v];bt.AddVV(bt.MulSV(g.normalImpulse,d,bt.s_t0),bt.MulSV(g.tangentImpulse,m,bt.s_t1),e),_-=s*bt.CrossVV(g.rA,e),h.SelfMulSub(a,e),p+=l*bt.CrossVV(g.rB,e),f.SelfMulAdd(c,e)}this.m_velocities[r].w=_,this.m_velocities[o].w=p}},e.SolveVelocityConstraints=function(){for(var e=t.SolveVelocityConstraints_s_dv,n=t.SolveVelocityConstraints_s_dv1,i=t.SolveVelocityConstraints_s_dv2,r=t.SolveVelocityConstraints_s_P,o=t.SolveVelocityConstraints_s_a,a=t.SolveVelocityConstraints_s_b,s=t.SolveVelocityConstraints_s_x,c=t.SolveVelocityConstraints_s_d,l=t.SolveVelocityConstraints_s_P1,u=t.SolveVelocityConstraints_s_P2,h=t.SolveVelocityConstraints_s_P1P2,_=0;_<this.m_count;++_){for(var f=this.m_velocityConstraints[_],p=f.indexA,d=f.indexB,m=f.invMassA,v=f.invIA,g=f.invMassB,y=f.invIB,x=f.pointCount,S=this.m_velocities[p].v,A=this.m_velocities[p].w,C=this.m_velocities[d].v,b=this.m_velocities[d].w,T=f.normal,E=f.tangent,w=f.friction,P=0;P<x;++P){var I=f.points[P];bt.SubVV(bt.AddVCrossSV(C,b,I.rB,bt.s_t0),bt.AddVCrossSV(S,A,I.rA,bt.s_t1),e);var R=bt.DotVV(e,E)-f.tangentSpeed,D=I.tangentMass*-R,B=w*I.normalImpulse,M=at(I.tangentImpulse+D,-B,B);D=M-I.tangentImpulse,I.tangentImpulse=M,bt.MulSV(D,E,r),S.SelfMulSub(m,r),A-=v*bt.CrossVV(I.rA,r),C.SelfMulAdd(g,r),b+=y*bt.CrossVV(I.rB,r)}if(1===f.pointCount||!1===Sr)for(var O=0;O<x;++O){var N=f.points[O];bt.SubVV(bt.AddVCrossSV(C,b,N.rB,bt.s_t0),bt.AddVCrossSV(S,A,N.rA,bt.s_t1),e);var L=bt.DotVV(e,T),F=-N.normalMass*(L-N.velocityBias),z=ot(N.normalImpulse+F,0);F=z-N.normalImpulse,N.normalImpulse=z,bt.MulSV(F,T,r),S.SelfMulSub(m,r),A-=v*bt.CrossVV(N.rA,r),C.SelfMulAdd(g,r),b+=y*bt.CrossVV(N.rB,r)}else{var V=f.points[0],G=f.points[1];o.Set(V.normalImpulse,G.normalImpulse),bt.SubVV(bt.AddVCrossSV(C,b,V.rB,bt.s_t0),bt.AddVCrossSV(S,A,V.rA,bt.s_t1),n),bt.SubVV(bt.AddVCrossSV(C,b,G.rB,bt.s_t0),bt.AddVCrossSV(S,A,G.rA,bt.s_t1),i);var U=bt.DotVV(n,T),k=bt.DotVV(i,T);for(a.x=U-V.velocityBias,a.y=k-G.velocityBias,a.SelfSub(wt.MulMV(f.K,o,bt.s_t0));;){if(wt.MulMV(f.normalMass,a,s).SelfNeg(),s.x>=0&&s.y>=0){bt.SubVV(s,o,c),bt.MulSV(c.x,T,l),bt.MulSV(c.y,T,u),bt.AddVV(l,u,h),S.SelfMulSub(m,h),A-=v*(bt.CrossVV(V.rA,l)+bt.CrossVV(G.rA,u)),C.SelfMulAdd(g,h),b+=y*(bt.CrossVV(V.rB,l)+bt.CrossVV(G.rB,u)),V.normalImpulse=s.x,G.normalImpulse=s.y;break}if(s.x=-V.normalMass*a.x,s.y=0,U=0,k=f.K.ex.y*s.x+a.y,s.x>=0&&k>=0){bt.SubVV(s,o,c),bt.MulSV(c.x,T,l),bt.MulSV(c.y,T,u),bt.AddVV(l,u,h),S.SelfMulSub(m,h),A-=v*(bt.CrossVV(V.rA,l)+bt.CrossVV(G.rA,u)),C.SelfMulAdd(g,h),b+=y*(bt.CrossVV(V.rB,l)+bt.CrossVV(G.rB,u)),V.normalImpulse=s.x,G.normalImpulse=s.y;break}if(s.x=0,s.y=-G.normalMass*a.y,U=f.K.ey.x*s.y+a.x,k=0,s.y>=0&&U>=0){bt.SubVV(s,o,c),bt.MulSV(c.x,T,l),bt.MulSV(c.y,T,u),bt.AddVV(l,u,h),S.SelfMulSub(m,h),A-=v*(bt.CrossVV(V.rA,l)+bt.CrossVV(G.rA,u)),C.SelfMulAdd(g,h),b+=y*(bt.CrossVV(V.rB,l)+bt.CrossVV(G.rB,u)),V.normalImpulse=s.x,G.normalImpulse=s.y;break}if(s.x=0,s.y=0,U=a.x,k=a.y,U>=0&&k>=0){bt.SubVV(s,o,c),bt.MulSV(c.x,T,l),bt.MulSV(c.y,T,u),bt.AddVV(l,u,h),S.SelfMulSub(m,h),A-=v*(bt.CrossVV(V.rA,l)+bt.CrossVV(G.rA,u)),C.SelfMulAdd(g,h),b+=y*(bt.CrossVV(V.rB,l)+bt.CrossVV(G.rB,u)),V.normalImpulse=s.x,G.normalImpulse=s.y;break}break}}this.m_velocities[p].w=A,this.m_velocities[d].w=b}},e.StoreImpulses=function(){for(var t=0;t<this.m_count;++t)for(var e=this.m_velocityConstraints[t],n=this.m_contacts[e.contactIndex].GetManifold(),i=0;i<e.pointCount;++i)n.points[i].normalImpulse=e.points[i].normalImpulse,n.points[i].tangentImpulse=e.points[i].tangentImpulse},e.SolvePositionConstraints=function(){for(var e=t.SolvePositionConstraints_s_xfA,n=t.SolvePositionConstraints_s_xfB,i=t.SolvePositionConstraints_s_psm,r=t.SolvePositionConstraints_s_rA,o=t.SolvePositionConstraints_s_rB,a=t.SolvePositionConstraints_s_P,s=0,c=0;c<this.m_count;++c){for(var l=this.m_positionConstraints[c],u=l.indexA,_=l.indexB,f=l.localCenterA,p=l.invMassA,d=l.invIA,m=l.localCenterB,g=l.invMassB,y=l.invIB,x=l.pointCount,S=this.m_positions[u].c,A=this.m_positions[u].a,b=this.m_positions[_].c,T=this.m_positions[_].a,E=0;E<x;++E){e.q.SetAngle(A),n.q.SetAngle(T),bt.SubVV(S,It.MulRV(e.q,f,bt.s_t0),e.p),bt.SubVV(b,It.MulRV(n.q,m,bt.s_t0),n.p),i.Initialize(l,e,n,E);var w=i.normal,P=i.point,I=i.separation;bt.SubVV(P,S,r),bt.SubVV(P,b,o),s=rt(s,I);var R=at(C*(I+h),-v,0),D=bt.CrossVV(r,w),B=bt.CrossVV(o,w),M=p+g+d*D*D+y*B*B,O=M>0?-R/M:0;bt.MulSV(O,w,a),S.SelfMulSub(p,a),A-=d*bt.CrossVV(r,a),b.SelfMulAdd(g,a),T+=y*bt.CrossVV(o,a)}this.m_positions[u].a=A,this.m_positions[_].a=T}return s>-3*h},e.SolveTOIPositionConstraints=function(e,n){for(var i=t.SolveTOIPositionConstraints_s_xfA,r=t.SolveTOIPositionConstraints_s_xfB,o=t.SolveTOIPositionConstraints_s_psm,a=t.SolveTOIPositionConstraints_s_rA,s=t.SolveTOIPositionConstraints_s_rB,c=t.SolveTOIPositionConstraints_s_P,l=0,u=0;u<this.m_count;++u){var _=this.m_positionConstraints[u],f=_.indexA,p=_.indexB,d=_.localCenterA,m=_.localCenterB,g=_.pointCount,y=0,x=0;f!==e&&f!==n||(y=_.invMassA,x=_.invIA);var S=0,A=0;p!==e&&p!==n||(S=_.invMassB,A=_.invIB);for(var C=this.m_positions[f].c,T=this.m_positions[f].a,E=this.m_positions[p].c,w=this.m_positions[p].a,P=0;P<g;++P){i.q.SetAngle(T),r.q.SetAngle(w),bt.SubVV(C,It.MulRV(i.q,d,bt.s_t0),i.p),bt.SubVV(E,It.MulRV(r.q,m,bt.s_t0),r.p),o.Initialize(_,i,r,P);var I=o.normal,R=o.point,D=o.separation;bt.SubVV(R,C,a),bt.SubVV(R,E,s),l=rt(l,D);var B=at(b*(D+h),-v,0),M=bt.CrossVV(a,I),O=bt.CrossVV(s,I),N=y+S+x*M*M+A*O*O,L=N>0?-B/N:0;bt.MulSV(L,I,c),C.SelfMulSub(y,c),T-=x*bt.CrossVV(a,c),E.SelfMulAdd(S,c),w+=A*bt.CrossVV(s,c)}this.m_positions[f].a=T,this.m_positions[p].a=w}return l>=-1.5*h},t}();wr.InitializeVelocityConstraints_s_xfA=new Rt,wr.InitializeVelocityConstraints_s_xfB=new Rt,wr.InitializeVelocityConstraints_s_worldManifold=new xe,wr.WarmStart_s_P=new bt,wr.SolveVelocityConstraints_s_dv=new bt,wr.SolveVelocityConstraints_s_dv1=new bt,wr.SolveVelocityConstraints_s_dv2=new bt,wr.SolveVelocityConstraints_s_P=new bt,wr.SolveVelocityConstraints_s_a=new bt,wr.SolveVelocityConstraints_s_b=new bt,wr.SolveVelocityConstraints_s_x=new bt,wr.SolveVelocityConstraints_s_d=new bt,wr.SolveVelocityConstraints_s_P1=new bt,wr.SolveVelocityConstraints_s_P2=new bt,wr.SolveVelocityConstraints_s_P1P2=new bt,wr.SolvePositionConstraints_s_xfA=new Rt,wr.SolvePositionConstraints_s_xfB=new Rt,wr.SolvePositionConstraints_s_psm=new Er,wr.SolvePositionConstraints_s_rA=new bt,wr.SolvePositionConstraints_s_rB=new bt,wr.SolvePositionConstraints_s_P=new bt,wr.SolveTOIPositionConstraints_s_xfA=new Rt,wr.SolveTOIPositionConstraints_s_xfB=new Rt,wr.SolveTOIPositionConstraints_s_psm=new Er,wr.SolveTOIPositionConstraints_s_rA=new bt,wr.SolveTOIPositionConstraints_s_rB=new bt,wr.SolveTOIPositionConstraints_s_P=new bt;var Pr,Ir=function(){function e(){this.m_bodies=[],this.m_contacts=[],this.m_joints=[],this.m_positions=gr.MakeArray(1024),this.m_velocities=yr.MakeArray(1024),this.m_bodyCount=0,this.m_jointCount=0,this.m_contactCount=0,this.m_bodyCapacity=0,this.m_contactCapacity=0,this.m_jointCapacity=0}var n=e.prototype;return n.Initialize=function(t,e,n,i){if(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=n,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_listener=i,this.m_positions.length<t)for(var r=ot(2*this.m_positions.length,t);this.m_positions.length<r;)this.m_positions[this.m_positions.length]=new gr;if(this.m_velocities.length<t)for(var o=ot(2*this.m_velocities.length,t);this.m_velocities.length<o;)this.m_velocities[this.m_velocities.length]=new yr},n.Clear=function(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0},n.AddBody=function(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t},n.AddContact=function(t){this.m_contacts[this.m_contactCount++]=t},n.AddJoint=function(t){this.m_joints[this.m_jointCount++]=t},n.Solve=function(n,r,o,a){for(var s=e.s_timer.Reset(),c=r.dt,l=0;l<this.m_bodyCount;++l){var u=this.m_bodies[l];this.m_positions[l].c.Copy(u.m_sweep.c);var h=u.m_sweep.a,_=this.m_velocities[l].v.Copy(u.m_linearVelocity),f=u.m_angularVelocity;u.m_sweep.c0.Copy(u.m_sweep.c),u.m_sweep.a0=u.m_sweep.a,u.m_type===t.b2BodyType.b2_dynamicBody&&(_.x+=c*(u.m_gravityScale*o.x+u.m_invMass*u.m_force.x),_.y+=c*(u.m_gravityScale*o.y+u.m_invMass*u.m_force.y),f+=c*u.m_invI*u.m_torque,_.SelfMul(1/(1+c*u.m_linearDamping)),f*=1/(1+c*u.m_angularDamping)),this.m_positions[l].a=h,this.m_velocities[l].w=f}s.Reset();var p=e.s_solverData;p.step.Copy(r),p.positions=this.m_positions,p.velocities=this.m_velocities;var d=e.s_contactSolverDef;d.step.Copy(r),d.contacts=this.m_contacts,d.count=this.m_contactCount,d.positions=this.m_positions,d.velocities=this.m_velocities;var m=e.s_contactSolver.Initialize(d);m.InitializeVelocityConstraints(),r.warmStarting&&m.WarmStart();for(var v=0;v<this.m_jointCount;++v)this.m_joints[v].InitVelocityConstraints(p);n.solveInit=s.GetMilliseconds(),s.Reset();for(var g=0;g<r.velocityIterations;++g){for(var C=0;C<this.m_jointCount;++C)this.m_joints[C].SolveVelocityConstraints(p);m.SolveVelocityConstraints()}m.StoreImpulses(),n.solveVelocity=s.GetMilliseconds();for(var b=0;b<this.m_bodyCount;++b){var T=this.m_positions[b].c,E=this.m_positions[b].a,w=this.m_velocities[b].v,P=this.m_velocities[b].w,I=bt.MulSV(c,w,e.s_translation);if(bt.DotVV(I,I)>x){var R=y/I.Length();w.SelfMul(R)}var D=c*P;D*D>A&&(P*=S/it(D)),T.x+=c*w.x,T.y+=c*w.y,E+=c*P,this.m_positions[b].a=E,this.m_velocities[b].w=P}s.Reset();for(var B=!1,M=0;M<r.positionIterations;++M){for(var O=m.SolvePositionConstraints(),N=!0,F=0;F<this.m_jointCount;++F){var G=this.m_joints[F].SolvePositionConstraints(p);N=N&&G}if(O&&N){B=!0;break}}for(var U=0;U<this.m_bodyCount;++U){var k=this.m_bodies[U];k.m_sweep.c.Copy(this.m_positions[U].c),k.m_sweep.a=this.m_positions[U].a,k.m_linearVelocity.Copy(this.m_velocities[U].v),k.m_angularVelocity=this.m_velocities[U].w,k.SynchronizeTransform()}if(n.solvePosition=s.GetMilliseconds(),this.Report(m.m_velocityConstraints),a){for(var H=i,j=z*z,W=V*V,q=0;q<this.m_bodyCount;++q){var X=this.m_bodies[q];X.GetType()!==t.b2BodyType.b2_staticBody&&(!X.m_autoSleepFlag||X.m_angularVelocity*X.m_angularVelocity>W||bt.DotVV(X.m_linearVelocity,X.m_linearVelocity)>j?(X.m_sleepTime=0,H=0):(X.m_sleepTime+=c,H=rt(H,X.m_sleepTime)))}if(H>=L&&B)for(var Y=0;Y<this.m_bodyCount;++Y)this.m_bodies[Y].SetAwake(!1)}},n.SolveTOI=function(t,n,i){for(var r=0;r<this.m_bodyCount;++r){var o=this.m_bodies[r];this.m_positions[r].c.Copy(o.m_sweep.c),this.m_positions[r].a=o.m_sweep.a,this.m_velocities[r].v.Copy(o.m_linearVelocity),this.m_velocities[r].w=o.m_angularVelocity}var a=e.s_contactSolverDef;a.contacts=this.m_contacts,a.count=this.m_contactCount,a.step.Copy(t),a.positions=this.m_positions,a.velocities=this.m_velocities;for(var s=e.s_contactSolver.Initialize(a),c=0;c<t.positionIterations&&!s.SolveTOIPositionConstraints(n,i);++c);this.m_bodies[n].m_sweep.c0.Copy(this.m_positions[n].c),this.m_bodies[n].m_sweep.a0=this.m_positions[n].a,this.m_bodies[i].m_sweep.c0.Copy(this.m_positions[i].c),this.m_bodies[i].m_sweep.a0=this.m_positions[i].a,s.InitializeVelocityConstraints();for(var l=0;l<t.velocityIterations;++l)s.SolveVelocityConstraints();for(var u=t.dt,h=0;h<this.m_bodyCount;++h){var _=this.m_positions[h].c,f=this.m_positions[h].a,p=this.m_velocities[h].v,d=this.m_velocities[h].w,m=bt.MulSV(u,p,e.s_translation);if(bt.DotVV(m,m)>x){var v=y/m.Length();p.SelfMul(v)}var g=u*d;g*g>A&&(d*=S/it(g)),_.SelfMulAdd(u,p),f+=u*d,this.m_positions[h].a=f,this.m_velocities[h].w=d;var C=this.m_bodies[h];C.m_sweep.c.Copy(_),C.m_sweep.a=f,C.m_linearVelocity.Copy(p),C.m_angularVelocity=d,C.SynchronizeTransform()}this.Report(s.m_velocityConstraints)},n.Report=function(t){if(null!==this.m_listener)for(var n=0;n<this.m_contactCount;++n){var i=this.m_contacts[n];if(i){var r=t[n],o=e.s_impulse;o.count=r.pointCount;for(var a=0;a<r.pointCount;++a)o.normalImpulses[a]=r.points[a].normalImpulse,o.tangentImpulses[a]=r.points[a].tangentImpulse;this.m_listener.PostSolve(i,o)}}},e}();Ir.s_timer=new Nt,Ir.s_solverData=new xr,Ir.s_contactSolverDef=new Tr,Ir.s_contactSolver=new wr,Ir.s_translation=new bt,Ir.s_impulse=new hr,(Pr=t.b2ParticleFlag||(t.b2ParticleFlag={}))[Pr.b2_waterParticle=0]="b2_waterParticle",Pr[Pr.b2_zombieParticle=2]="b2_zombieParticle",Pr[Pr.b2_wallParticle=4]="b2_wallParticle",Pr[Pr.b2_springParticle=8]="b2_springParticle",Pr[Pr.b2_elasticParticle=16]="b2_elasticParticle",Pr[Pr.b2_viscousParticle=32]="b2_viscousParticle",Pr[Pr.b2_powderParticle=64]="b2_powderParticle",Pr[Pr.b2_tensileParticle=128]="b2_tensileParticle",Pr[Pr.b2_colorMixingParticle=256]="b2_colorMixingParticle",Pr[Pr.b2_destructionListenerParticle=512]="b2_destructionListenerParticle",Pr[Pr.b2_barrierParticle=1024]="b2_barrierParticle",Pr[Pr.b2_staticPressureParticle=2048]="b2_staticPressureParticle",Pr[Pr.b2_reactiveParticle=4096]="b2_reactiveParticle",Pr[Pr.b2_repulsiveParticle=8192]="b2_repulsiveParticle",Pr[Pr.b2_fixtureContactListenerParticle=16384]="b2_fixtureContactListenerParticle",Pr[Pr.b2_particleContactListenerParticle=32768]="b2_particleContactListenerParticle",Pr[Pr.b2_fixtureContactFilterParticle=65536]="b2_fixtureContactFilterParticle",Pr[Pr.b2_particleContactFilterParticle=131072]="b2_particleContactFilterParticle";var Rr=function(){this.flags=0,this.position=new bt,this.velocity=new bt,this.color=new Mt(0,0,0,0),this.lifetime=0,this.userData=null,this.group=null};function Dr(t,e,n){var i=8,r=.01;return at(Math.ceil(Math.sqrt(t/(r*e))*n),1,i)}var Br,Mr=function(){function t(){this.m_index=T}var e=t.prototype;return e.GetIndex=function(){return this.m_index},e.SetIndex=function(t){this.m_index=t},t}();(Br=t.b2ParticleGroupFlag||(t.b2ParticleGroupFlag={}))[Br.b2_solidParticleGroup=1]="b2_solidParticleGroup",Br[Br.b2_rigidParticleGroup=2]="b2_rigidParticleGroup",Br[Br.b2_particleGroupCanBeEmpty=4]="b2_particleGroupCanBeEmpty",Br[Br.b2_particleGroupWillBeDestroyed=8]="b2_particleGroupWillBeDestroyed",Br[Br.b2_particleGroupNeedsUpdateDepth=16]="b2_particleGroupNeedsUpdateDepth",Br[Br.b2_particleGroupInternalMask=24]="b2_particleGroupInternalMask";var Or=function(){this.flags=0,this.groupFlags=0,this.position=new bt,this.angle=0,this.linearVelocity=new bt,this.angularVelocity=0,this.color=new Mt,this.strength=1,this.shapeCount=0,this.stride=0,this.particleCount=0,this.lifetime=0,this.userData=null,this.group=null},Nr=function(){function e(t){this.m_firstIndex=0,this.m_lastIndex=0,this.m_groupFlags=0,this.m_strength=1,this.m_prev=null,this.m_next=null,this.m_timestamp=-1,this.m_mass=0,this.m_inertia=0,this.m_center=new bt,this.m_linearVelocity=new bt,this.m_angularVelocity=0,this.m_transform=new Rt,this.m_userData=null,this.m_system=t}var n=e.prototype;return n.GetNext=function(){return this.m_next},n.GetParticleSystem=function(){return this.m_system},n.GetParticleCount=function(){return this.m_lastIndex-this.m_firstIndex},n.GetBufferIndex=function(){return this.m_firstIndex},n.ContainsParticle=function(t){return this.m_firstIndex<=t&&t<this.m_lastIndex},n.GetAllParticleFlags=function(){if(!this.m_system.m_flagsBuffer.data)throw new Error;for(var t=0,e=this.m_firstIndex;e<this.m_lastIndex;e++)t|=this.m_system.m_flagsBuffer.data[e];return t},n.GetGroupFlags=function(){return this.m_groupFlags},n.SetGroupFlags=function(e){e|=this.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupInternalMask,this.m_system.SetGroupFlags(this,e)},n.GetMass=function(){return this.UpdateStatistics(),this.m_mass},n.GetInertia=function(){return this.UpdateStatistics(),this.m_inertia},n.GetCenter=function(){return this.UpdateStatistics(),this.m_center},n.GetLinearVelocity=function(){return this.UpdateStatistics(),this.m_linearVelocity},n.GetAngularVelocity=function(){return this.UpdateStatistics(),this.m_angularVelocity},n.GetTransform=function(){return this.m_transform},n.GetPosition=function(){return this.m_transform.p},n.GetAngle=function(){return this.m_transform.q.GetAngle()},n.GetLinearVelocityFromWorldPoint=function(t,n){var i=e.GetLinearVelocityFromWorldPoint_s_t0;return this.UpdateStatistics(),bt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,bt.SubVV(t,this.m_center,i),n)},n.GetUserData=function(){return this.m_userData},n.SetUserData=function(t){this.m_userData=t},n.ApplyForce=function(t){this.m_system.ApplyForce(this.m_firstIndex,this.m_lastIndex,t)},n.ApplyLinearImpulse=function(t){this.m_system.ApplyLinearImpulse(this.m_firstIndex,this.m_lastIndex,t)},n.DestroyParticles=function(t){if(this.m_system.m_world.IsLocked())throw new Error;for(var e=this.m_firstIndex;e<this.m_lastIndex;e++)this.m_system.DestroyParticle(e,t)},n.UpdateStatistics=function(){if(!this.m_system.m_positionBuffer.data)throw new Error;if(!this.m_system.m_velocityBuffer.data)throw new Error;var t=new bt,e=new bt;if(this.m_timestamp!==this.m_system.m_timestamp){var n=this.m_system.GetParticleMass();this.m_mass=n*(this.m_lastIndex-this.m_firstIndex),this.m_center.SetZero(),this.m_linearVelocity.SetZero();for(var i=this.m_firstIndex;i<this.m_lastIndex;i++)this.m_center.SelfMulAdd(n,this.m_system.m_positionBuffer.data[i]),this.m_linearVelocity.SelfMulAdd(n,this.m_system.m_velocityBuffer.data[i]);if(this.m_mass>0){var r=1/this.m_mass;this.m_center.SelfMul(r),this.m_linearVelocity.SelfMul(r)}this.m_inertia=0,this.m_angularVelocity=0;for(var o=this.m_firstIndex;o<this.m_lastIndex;o++)bt.SubVV(this.m_system.m_positionBuffer.data[o],this.m_center,t),bt.SubVV(this.m_system.m_velocityBuffer.data[o],this.m_linearVelocity,e),this.m_inertia+=n*bt.DotVV(t,t),this.m_angularVelocity+=n*bt.CrossVV(t,e);this.m_inertia>0&&(this.m_angularVelocity*=1/this.m_inertia),this.m_timestamp=this.m_system.m_timestamp}},e}();Nr.GetLinearVelocityFromWorldPoint_s_t0=new bt;var Lr=function(){function t(t){this.m_buffer=[],this.m_front=0,this.m_back=0,this.m_buffer.fill(null,0,t)}var e=t.prototype;return e.Push=function(t){if(this.m_back>=this.m_capacity){for(var e=this.m_front;e<this.m_back;e++)this.m_buffer[e-this.m_front]=this.m_buffer[e];this.m_back-=this.m_front,this.m_front=0}this.m_buffer[this.m_back]=t,this.m_back++},e.Pop=function(){this.m_buffer[this.m_front]=null,this.m_front++},e.Empty=function(){return this.m_front===this.m_back},e.Front=function(){var t=this.m_buffer[this.m_front];if(!t)throw new Error;return t},N(t,[{key:"m_capacity",get:function(){return this.m_buffer.length}}]),t}(),Fr=function(){function t(t){this.m_generatorCapacity=0,this.m_generatorCount=0,this.m_countX=0,this.m_countY=0,this.m_diagram=[],this.m_generatorBuffer=Q(t,(function(){return new zr})),this.m_generatorCapacity=t}var e=t.prototype;return e.AddGenerator=function(t,e,n){var i=this.m_generatorBuffer[this.m_generatorCount++];i.center.Copy(t),i.tag=e,i.necessary=n},e.Generate=function(t,e){for(var n=1/t,r=new bt(+i,+i),o=new bt(-i,-i),a=0,s=0;s<this.m_generatorCount;s++){var c=this.m_generatorBuffer[s];c.necessary&&(bt.MinV(r,c.center,r),bt.MaxV(o,c.center,o),++a)}if(0===a)return this.m_countX=0,void(this.m_countY=0);r.x-=e,r.y-=e,o.x+=e,o.y+=e,this.m_countX=1+Math.floor(n*(o.x-r.x)),this.m_countY=1+Math.floor(n*(o.y-r.y)),this.m_diagram=[];for(var l=new Lr(4*this.m_countX*this.m_countY),u=0;u<this.m_generatorCount;u++){var h=this.m_generatorBuffer[u];h.center.SelfSub(r).SelfMul(n);var _=Math.floor(h.center.x),f=Math.floor(h.center.y);_>=0&&f>=0&&_<this.m_countX&&f<this.m_countY&&l.Push(new Vr(_,f,_+f*this.m_countX,h))}for(;!l.Empty();){var p=l.Front(),d=p.m_x,m=p.m_y,v=p.m_i,g=p.m_generator;l.Pop(),this.m_diagram[v]||(this.m_diagram[v]=g,d>0&&l.Push(new Vr(d-1,m,v-1,g)),m>0&&l.Push(new Vr(d,m-1,v-this.m_countX,g)),d<this.m_countX-1&&l.Push(new Vr(d+1,m,v+1,g)),m<this.m_countY-1&&l.Push(new Vr(d,m+1,v+this.m_countX,g)))}for(var y=0;y<this.m_countY;y++)for(var x=0;x<this.m_countX-1;x++){var S=x+y*this.m_countX,A=this.m_diagram[S],C=this.m_diagram[S+1];A!==C&&(l.Push(new Vr(x,y,S,C)),l.Push(new Vr(x+1,y,S+1,A)))}for(var b=0;b<this.m_countY-1;b++)for(var T=0;T<this.m_countX;T++){var E=T+b*this.m_countX,w=this.m_diagram[E],P=this.m_diagram[E+this.m_countX];w!==P&&(l.Push(new Vr(T,b,E,P)),l.Push(new Vr(T,b+1,E+this.m_countX,w)))}for(;!l.Empty();){var I=l.Front(),R=I.m_x,D=I.m_y,B=I.m_i,M=I.m_generator;l.Pop();var O=this.m_diagram[B],N=M;if(O!==N){var L=O.center.x-R,F=O.center.y-D,z=N.center.x-R,V=N.center.y-D;L*L+F*F>z*z+V*V&&(this.m_diagram[B]=N,R>0&&l.Push(new Vr(R-1,D,B-1,N)),D>0&&l.Push(new Vr(R,D-1,B-this.m_countX,N)),R<this.m_countX-1&&l.Push(new Vr(R+1,D,B+1,N)),D<this.m_countY-1&&l.Push(new Vr(R,D+1,B+this.m_countX,N)))}}},e.GetNodes=function(t){for(var e=0;e<this.m_countY-1;e++)for(var n=0;n<this.m_countX-1;n++){var i=n+e*this.m_countX,r=this.m_diagram[i],o=this.m_diagram[i+1],a=this.m_diagram[i+this.m_countX],s=this.m_diagram[i+1+this.m_countX];o!==a&&(r!==o&&r!==a&&(r.necessary||o.necessary||a.necessary)&&t(r.tag,o.tag,a.tag),s!==o&&s!==a&&(r.necessary||o.necessary||a.necessary)&&t(o.tag,s.tag,a.tag))}},t}(),zr=function(){this.center=new bt,this.tag=0,this.necessary=!1},Vr=function(t,e,n,i){this.m_x=t,this.m_y=e,this.m_i=n,this.m_generator=i};function Gr(t,e,n){var i=t[e];t[e]=t[n],t[n]=i}function Ur(t,e){return t<e}function kr(t,e,n,i){void 0===e&&(e=0),void 0===n&&(n=t.length-e),void 0===i&&(i=Ur);for(var r=e,o=[],a=0;;){for(;r+1<n;n++){var s=t[r+Math.floor(Math.random()*(n-r))];o[a++]=n;for(var c=r-1;;){for(;i(t[++c],s););for(;i(s,t[--n]););if(c>=n)break;Gr(t,c,n)}}if(0===a)break;r=n,n=o[--a]}return t}function Hr(t,e,n,i){return void 0===e&&(e=0),void 0===n&&(n=t.length-e),void 0===i&&(i=Ur),kr(t,e,n,i)}function jr(t,e,n){void 0===n&&(n=t.length);for(var i=0,r=0;r<n;++r)e(t[r])||(r!==i?Gr(t,i++,r):++i);return i}function Wr(t,e,n,i,r){for(var o=n-e;o>0;){var a=Math.floor(o/2),s=e+a;r(t[s],i)?(e=++s,o-=a+1):o=a}return e}function qr(t,e,n,i,r){for(var o=n-e;o>0;){var a=Math.floor(o/2),s=e+a;r(i,t[s])?o=a:(e=++s,o-=a+1)}return e}function Xr(t,e,n,i){for(var r=n;e!==r;)Gr(t,e++,r++),r===i?r=n:e===n&&(n=r)}function Yr(t,e,n,i){if(e===n)return n;for(var r=e;++e!==n;)i(t[r],t[e])||Gr(t,++r,e);return++r}var Kr=function(){function t(t){this.data=[],this.count=0,this.capacity=0,this.allocator=t}var e=t.prototype;return e.Append=function(){return this.count>=this.capacity&&this.Grow(),this.count++},e.Reserve=function(t){if(!(this.capacity>=t)){for(var e=this.capacity;e<t;++e)this.data[e]=this.allocator();this.capacity=t}},e.Grow=function(){var t=this.capacity?2*this.capacity:M;this.Reserve(t)},e.Free=function(){0!==this.data.length&&(this.data=[],this.capacity=0,this.count=0)},e.Shorten=function(){},e.Data=function(){return this.data},e.GetCount=function(){return this.count},e.SetCount=function(t){this.count=t},e.GetCapacity=function(){return this.capacity},e.RemoveIf=function(t){this.count=jr(this.data,t,this.count)},e.Unique=function(t){this.count=Yr(this.data,0,this.count,t)},t}(),Jr=function(t){function e(e){var n;return(n=t.call(this)||this).m_system=e,n}F(e,t);var n=e.prototype;return n.ShouldQueryParticleSystem=function(){return!1},n.ReportFixture=function(t){if(t.IsSensor())return!0;for(var e=t.GetShape().GetChildCount(),n=0;n<e;n++)for(var i=t.GetAABB(n),r=this.m_system.GetInsideBoundsEnumerator(i),o=void 0;(o=r.GetNext())>=0;)this.ReportFixtureAndParticle(t,n,o);return!0},n.ReportParticle=function(){return!1},n.ReportFixtureAndParticle=function(){},e}(fr),Qr=function(){function t(){this.indexA=0,this.indexB=0,this.weight=0,this.normal=new bt,this.flags=0}var e=t.prototype;return e.SetIndices=function(t,e){this.indexA=t,this.indexB=e},e.SetWeight=function(t){this.weight=t},e.SetNormal=function(t){this.normal.Copy(t)},e.SetFlags=function(t){this.flags=t},e.GetIndexA=function(){return this.indexA},e.GetIndexB=function(){return this.indexB},e.GetWeight=function(){return this.weight},e.GetNormal=function(){return this.normal},e.GetFlags=function(){return this.flags},e.IsEqual=function(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&this.weight===t.weight&&this.normal.x===t.normal.x&&this.normal.y===t.normal.y},e.IsNotEqual=function(t){return!this.IsEqual(t)},e.ApproximatelyEqual=function(t){var e=.01,n=1e-4;return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&it(this.weight-t.weight)<e&&bt.DistanceSquaredVV(this.normal,t.normal)<n},t}(),Zr=function(){this.index=0,this.weight=0,this.normal=new bt,this.mass=0},$r=function(){this.indexA=0,this.indexB=0,this.flags=0,this.strength=0,this.distance=0},to=function(){this.indexA=0,this.indexB=0,this.indexC=0,this.flags=0,this.strength=0,this.pa=new bt(0,0),this.pb=new bt(0,0),this.pc=new bt(0,0),this.ka=0,this.kb=0,this.kc=0,this.s=0},eo=function(){function t(){this.strictContactCheck=!1,this.density=1,this.gravityScale=1,this.radius=1,this.maxCount=0,this.pressureStrength=.005,this.dampingStrength=1,this.elasticStrength=.25,this.springStrength=.25,this.viscousStrength=.25,this.surfaceTensionPressureStrength=.2,this.surfaceTensionNormalStrength=.2,this.repulsiveStrength=1,this.powderStrength=.5,this.ejectionStrength=.5,this.staticPressureStrength=.2,this.staticPressureRelaxation=.2,this.staticPressureIterations=8,this.colorMixingStrength=.5,this.destroyByAge=!0,this.lifetimeGranularity=1/60}var e=t.prototype;return e.Copy=function(t){return this.strictContactCheck=t.strictContactCheck,this.density=t.density,this.gravityScale=t.gravityScale,this.radius=t.radius,this.maxCount=t.maxCount,this.pressureStrength=t.pressureStrength,this.dampingStrength=t.dampingStrength,this.elasticStrength=t.elasticStrength,this.springStrength=t.springStrength,this.viscousStrength=t.viscousStrength,this.surfaceTensionPressureStrength=t.surfaceTensionPressureStrength,this.surfaceTensionNormalStrength=t.surfaceTensionNormalStrength,this.repulsiveStrength=t.repulsiveStrength,this.powderStrength=t.powderStrength,this.ejectionStrength=t.ejectionStrength,this.staticPressureStrength=t.staticPressureStrength,this.staticPressureRelaxation=t.staticPressureRelaxation,this.staticPressureIterations=t.staticPressureIterations,this.colorMixingStrength=t.colorMixingStrength,this.destroyByAge=t.destroyByAge,this.lifetimeGranularity=t.lifetimeGranularity,this},e.Clone=function(){return(new t).Copy(this)},t}(),no=function(){function e(t,e){this.m_paused=!1,this.m_timestamp=0,this.m_allParticleFlags=0,this.m_needsUpdateAllParticleFlags=!1,this.m_allGroupFlags=0,this.m_needsUpdateAllGroupFlags=!1,this.m_hasForce=!1,this.m_iterationIndex=0,this.m_inverseDensity=0,this.m_particleDiameter=0,this.m_inverseDiameter=0,this.m_squaredDiameter=0,this.m_count=0,this.m_internalAllocatedCapacity=0,this.m_handleIndexBuffer=new io,this.m_flagsBuffer=new io,this.m_positionBuffer=new io,this.m_velocityBuffer=new io,this.m_forceBuffer=[],this.m_weightBuffer=[],this.m_staticPressureBuffer=[],this.m_accumulationBuffer=[],this.m_accumulation2Buffer=[],this.m_depthBuffer=[],this.m_colorBuffer=new io,this.m_groupBuffer=[],this.m_userDataBuffer=new io,this.m_stuckThreshold=0,this.m_lastBodyContactStepBuffer=new io,this.m_bodyContactCountBuffer=new io,this.m_consecutiveContactStepsBuffer=new io,this.m_stuckParticleBuffer=new Kr((function(){return 0})),this.m_proxyBuffer=new Kr((function(){return new ro})),this.m_contactBuffer=new Kr((function(){return new Qr})),this.m_bodyContactBuffer=new Kr((function(){return new Zr})),this.m_pairBuffer=new Kr((function(){return new $r})),this.m_triadBuffer=new Kr((function(){return new to})),this.m_expirationTimeBuffer=new io,this.m_indexByExpirationTimeBuffer=new io,this.m_timeElapsed=0,this.m_expirationTimeBufferRequiresSorting=!1,this.m_groupCount=0,this.m_groupList=null,this.m_def=new eo,this.m_prev=null,this.m_next=null,this.UpdateBodyContacts_callback=null,this.SolveCollision_callback=null,this.SetStrictContactCheck(t.strictContactCheck),this.SetDensity(t.density),this.SetGravityScale(t.gravityScale),this.SetRadius(t.radius),this.SetMaxParticleCount(t.maxCount),this.m_def=t.Clone(),this.m_world=e,this.SetDestructionByAge(this.m_def.destroyByAge)}e.computeTag=function(t,n){return(n+e.yOffset>>>0<<e.yShift)+(e.xScale*t+e.xOffset>>>0)>>>0},e.computeRelativeTag=function(t,n,i){return t+(i<<e.yShift)+(n<<e.xShift)>>>0};var r=e.prototype;return r.Drop=function(){for(;this.m_groupList;)this.DestroyParticleGroup(this.m_groupList);this.FreeUserOverridableBuffer(this.m_handleIndexBuffer),this.FreeUserOverridableBuffer(this.m_flagsBuffer),this.FreeUserOverridableBuffer(this.m_lastBodyContactStepBuffer),this.FreeUserOverridableBuffer(this.m_bodyContactCountBuffer),this.FreeUserOverridableBuffer(this.m_consecutiveContactStepsBuffer),this.FreeUserOverridableBuffer(this.m_positionBuffer),this.FreeUserOverridableBuffer(this.m_velocityBuffer),this.FreeUserOverridableBuffer(this.m_colorBuffer),this.FreeUserOverridableBuffer(this.m_userDataBuffer),this.FreeUserOverridableBuffer(this.m_expirationTimeBuffer),this.FreeUserOverridableBuffer(this.m_indexByExpirationTimeBuffer),this.FreeBuffer(this.m_forceBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_weightBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_staticPressureBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulationBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulation2Buffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_depthBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_groupBuffer,this.m_internalAllocatedCapacity)},r.CreateParticle=function(t){if(this.m_world.IsLocked())throw new Error;if(this.m_count>=this.m_internalAllocatedCapacity){var e=this.m_count?2*this.m_count:M;this.ReallocateInternalAllocatedBuffers(e)}if(this.m_count>=this.m_internalAllocatedCapacity){if(!this.m_def.destroyByAge)return T;this.DestroyOldestParticle(0,!1),this.SolveZombie()}var i=this.m_count++;this.m_flagsBuffer.data[i]=0,this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[i]=0),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[i]=0),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[i]=0),this.m_positionBuffer.data[i]=(this.m_positionBuffer.data[i]||new bt).Copy(n(t.position,bt.ZERO)),this.m_velocityBuffer.data[i]=(this.m_velocityBuffer.data[i]||new bt).Copy(n(t.velocity,bt.ZERO)),this.m_weightBuffer[i]=0,this.m_forceBuffer[i]=(this.m_forceBuffer[i]||new bt).SetZero(),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[i]=0),this.m_depthBuffer&&(this.m_depthBuffer[i]=0);var r=(new Mt).Copy(n(t.color,Mt.ZERO));!this.m_colorBuffer.data&&r.IsZero()||(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data[i]=(this.m_colorBuffer.data[i]||new Mt).Copy(r)),(this.m_userDataBuffer.data||t.userData)&&(this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data[i]=t.userData),this.m_handleIndexBuffer.data&&(this.m_handleIndexBuffer.data[i]=null);var o=this.m_proxyBuffer.data[this.m_proxyBuffer.Append()],a=n(t.lifetime,0),s=a>0;(this.m_expirationTimeBuffer.data||s)&&(this.SetParticleLifetime(i,s?a:this.ExpirationTimeToLifetime(-this.GetQuantizedTimeElapsed())),this.m_indexByExpirationTimeBuffer.data[i]=i),o.index=i;var c=n(t.group,null);return this.m_groupBuffer[i]=c,c&&(c.m_firstIndex<c.m_lastIndex?(this.RotateBuffer(c.m_firstIndex,c.m_lastIndex,i),c.m_lastIndex=i+1):(c.m_firstIndex=i,c.m_lastIndex=i+1)),this.SetParticleFlags(i,n(t.flags,0)),i},r.GetParticleHandleFromIndex=function(t){this.m_handleIndexBuffer.data=this.RequestBuffer(this.m_handleIndexBuffer.data);var e=this.m_handleIndexBuffer.data[t];return e||((e=new Mr).SetIndex(t),this.m_handleIndexBuffer.data[t]=e,e)},r.DestroyParticle=function(e,n){void 0===n&&(n=!1);var i=t.b2ParticleFlag.b2_zombieParticle;n&&(i|=t.b2ParticleFlag.b2_destructionListenerParticle),this.SetParticleFlags(e,this.m_flagsBuffer.data[e]|i)},r.DestroyOldestParticle=function(t,e){void 0===e&&(e=!1);var n=this.GetParticleCount(),i=this.m_indexByExpirationTimeBuffer.data[n-(t+1)],r=this.m_indexByExpirationTimeBuffer.data[t];this.DestroyParticle(this.m_expirationTimeBuffer.data[i]>0?i:r,e)},r.DestroyParticlesInShape=function(t,n,i){void 0===i&&(i=!1);var r=e.DestroyParticlesInShape_s_aabb;if(this.m_world.IsLocked())throw new Error;var o=new fo(this,t,n,i),a=r;return t.ComputeAABB(a,n,0),this.m_world.QueryAABB(o,a),o.Destroyed()},r.CreateParticleGroup=function(t){var i=e.CreateParticleGroup_s_transform;if(this.m_world.IsLocked())throw new Error;var r=i;r.SetPositionAngle(n(t.position,bt.ZERO),n(t.angle,0));var o=this.m_count;if(t.shape&&this.CreateParticlesWithShapeForGroup(t.shape,t,r),t.shapes&&this.CreateParticlesWithShapesForGroup(t.shapes,n(t.shapeCount,t.shapes.length),t,r),t.positionData)for(var a=n(t.particleCount,t.positionData.length),s=0;s<a;s++){var c=t.positionData[s];this.CreateParticleForGroup(t,r,c)}var l=this.m_count,u=new Nr(this);u.m_firstIndex=o,u.m_lastIndex=l,u.m_strength=n(t.strength,1),u.m_userData=t.userData,u.m_transform.Copy(r),u.m_prev=null,u.m_next=this.m_groupList,this.m_groupList&&(this.m_groupList.m_prev=u),this.m_groupList=u,++this.m_groupCount;for(var h=o;h<l;h++)this.m_groupBuffer[h]=u;this.SetGroupFlags(u,n(t.groupFlags,0));var _=new _o;return this.UpdateContacts(!0),this.UpdatePairsAndTriads(o,l,_),t.group&&(this.JoinParticleGroups(t.group,u),u=t.group),u},r.JoinParticleGroups=function(t,e){if(this.m_world.IsLocked())throw new Error;this.RotateBuffer(e.m_firstIndex,e.m_lastIndex,this.m_count),this.RotateBuffer(t.m_firstIndex,t.m_lastIndex,e.m_firstIndex);var n=new po(e.m_firstIndex);this.UpdateContacts(!0),this.UpdatePairsAndTriads(t.m_firstIndex,e.m_lastIndex,n);for(var i=e.m_firstIndex;i<e.m_lastIndex;i++)this.m_groupBuffer[i]=t;var r=t.m_groupFlags|e.m_groupFlags;this.SetGroupFlags(t,r),t.m_lastIndex=e.m_lastIndex,e.m_firstIndex=e.m_lastIndex,this.DestroyParticleGroup(e)},r.SplitParticleGroup=function(t){this.UpdateContacts(!0);var n=Q(t.GetParticleCount(),(function(){return new ao}));e.InitializeParticleLists(t,n),this.MergeParticleListsInContact(t,n);var i=e.FindLongestParticleList(t,n);this.MergeZombieParticleListNodes(t,n,i),this.CreateParticleGroupsFromParticleList(t,n,i),this.UpdatePairsAndTriadsWithParticleList(t,n)},r.GetParticleGroupList=function(){return this.m_groupList},r.GetParticleGroupCount=function(){return this.m_groupCount},r.GetParticleCount=function(){return this.m_count},r.GetMaxParticleCount=function(){return this.m_def.maxCount},r.SetMaxParticleCount=function(t){this.m_def.maxCount=t},r.GetAllParticleFlags=function(){return this.m_allParticleFlags},r.GetAllGroupFlags=function(){return this.m_allGroupFlags},r.SetPaused=function(t){this.m_paused=t},r.GetPaused=function(){return this.m_paused},r.SetDensity=function(t){this.m_def.density=t,this.m_inverseDensity=1/this.m_def.density},r.GetDensity=function(){return this.m_def.density},r.SetGravityScale=function(t){this.m_def.gravityScale=t},r.GetGravityScale=function(){return this.m_def.gravityScale},r.SetDamping=function(t){this.m_def.dampingStrength=t},r.GetDamping=function(){return this.m_def.dampingStrength},r.SetStaticPressureIterations=function(t){this.m_def.staticPressureIterations=t},r.GetStaticPressureIterations=function(){return this.m_def.staticPressureIterations},r.SetRadius=function(t){this.m_particleDiameter=2*t,this.m_squaredDiameter=this.m_particleDiameter*this.m_particleDiameter,this.m_inverseDiameter=1/this.m_particleDiameter},r.GetRadius=function(){return this.m_particleDiameter/2},r.GetPositionBuffer=function(){return this.m_positionBuffer.data},r.GetVelocityBuffer=function(){return this.m_velocityBuffer.data},r.GetColorBuffer=function(){return this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data},r.GetGroupBuffer=function(){return this.m_groupBuffer},r.GetWeightBuffer=function(){return this.m_weightBuffer},r.GetUserDataBuffer=function(){return this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data},r.GetFlagsBuffer=function(){return this.m_flagsBuffer.data},r.SetParticleFlags=function(e,n){this.m_flagsBuffer.data[e]&~n&&(this.m_needsUpdateAllParticleFlags=!0),~this.m_allParticleFlags&n&&(n&t.b2ParticleFlag.b2_tensileParticle&&(this.m_accumulation2Buffer=this.RequestBuffer(this.m_accumulation2Buffer)),n&t.b2ParticleFlag.b2_colorMixingParticle&&(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data)),this.m_allParticleFlags|=n),this.m_flagsBuffer.data[e]=n},r.GetParticleFlags=function(t){return this.m_flagsBuffer.data[t]},r.SetFlagsBuffer=function(t){this.SetUserOverridableBuffer(this.m_flagsBuffer,t)},r.SetPositionBuffer=function(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;for(var e=t.length/2,n=new Array(e),i=0;i<e;++i)n[i]=new bt(t.subarray(2*i,2*i+2));t=n}this.SetUserOverridableBuffer(this.m_positionBuffer,t)},r.SetVelocityBuffer=function(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;for(var e=t.length/2,n=new Array(e),i=0;i<e;++i)n[i]=new bt(t.subarray(2*i,2*i+2));t=n}this.SetUserOverridableBuffer(this.m_velocityBuffer,t)},r.SetColorBuffer=function(t){if(t instanceof Float32Array){if(t.length%4!=0)throw new Error;for(var e=t.length/4,n=new Array(e),i=0;i<e;++i)n[i]=new Mt(t.subarray(4*i,4*i+4));t=n}this.SetUserOverridableBuffer(this.m_colorBuffer,t)},r.SetUserDataBuffer=function(t){this.SetUserOverridableBuffer(this.m_userDataBuffer,t)},r.GetContacts=function(){return this.m_contactBuffer.data},r.GetContactCount=function(){return this.m_contactBuffer.count},r.GetBodyContacts=function(){return this.m_bodyContactBuffer.data},r.GetBodyContactCount=function(){return this.m_bodyContactBuffer.count},r.GetPairs=function(){return this.m_pairBuffer.data},r.GetPairCount=function(){return this.m_pairBuffer.count},r.GetTriads=function(){return this.m_triadBuffer.data},r.GetTriadCount=function(){return this.m_triadBuffer.count},r.SetStuckThreshold=function(t){this.m_stuckThreshold=t,t>0&&(this.m_lastBodyContactStepBuffer.data=this.RequestBuffer(this.m_lastBodyContactStepBuffer.data),this.m_bodyContactCountBuffer.data=this.RequestBuffer(this.m_bodyContactCountBuffer.data),this.m_consecutiveContactStepsBuffer.data=this.RequestBuffer(this.m_consecutiveContactStepsBuffer.data))},r.GetStuckCandidates=function(){return this.m_stuckParticleBuffer.Data()},r.GetStuckCandidateCount=function(){return this.m_stuckParticleBuffer.GetCount()},r.ComputeCollisionEnergy=function(){for(var t=e.ComputeCollisionEnergy_s_v,n=this.m_velocityBuffer.data,i=0,r=0;r<this.m_contactBuffer.count;r++){var o=this.m_contactBuffer.data[r],a=o.indexA,s=o.indexB,c=o.normal,l=bt.SubVV(n[s],n[a],t),u=bt.DotVV(l,c);u<0&&(i+=u*u)}return.5*this.GetParticleMass()*i},r.SetStrictContactCheck=function(t){this.m_def.strictContactCheck=t},r.GetStrictContactCheck=function(){return this.m_def.strictContactCheck},r.SetParticleLifetime=function(t,e){var n=null===this.m_indexByExpirationTimeBuffer.data;if(this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),n)for(var i=this.GetParticleCount(),r=0;r<i;++r)this.m_indexByExpirationTimeBuffer.data[r]=r;var o=e/this.m_def.lifetimeGranularity,a=o>0?this.GetQuantizedTimeElapsed()+o:o;a!==this.m_expirationTimeBuffer.data[t]&&(this.m_expirationTimeBuffer.data[t]=a,this.m_expirationTimeBufferRequiresSorting=!0)},r.GetParticleLifetime=function(t){return this.ExpirationTimeToLifetime(this.GetExpirationTimeBuffer()[t])},r.SetDestructionByAge=function(t){t&&this.GetExpirationTimeBuffer(),this.m_def.destroyByAge=t},r.GetDestructionByAge=function(){return this.m_def.destroyByAge},r.GetExpirationTimeBuffer=function(){return this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_expirationTimeBuffer.data},r.ExpirationTimeToLifetime=function(t){return(t>0?t-this.GetQuantizedTimeElapsed():t)*this.m_def.lifetimeGranularity},r.GetIndexByExpirationTimeBuffer=function(){return this.GetParticleCount()?this.SetParticleLifetime(0,this.GetParticleLifetime(0)):this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data},r.ParticleApplyLinearImpulse=function(t,e){this.ApplyLinearImpulse(t,t+1,e)},r.ApplyLinearImpulse=function(t,e,n){for(var i=this.m_velocityBuffer.data,r=(e-t)*this.GetParticleMass(),o=(new bt).Copy(n).SelfMul(1/r),a=t;a<e;a++)i[a].SelfAdd(o)},e.IsSignificantForce=function(t){return 0!==t.x||0!==t.y},r.ParticleApplyForce=function(t,n){e.IsSignificantForce(n)&&this.ForceCanBeApplied(this.m_flagsBuffer.data[t])&&(this.PrepareForceBuffer(),this.m_forceBuffer[t].SelfAdd(n))},r.ApplyForce=function(t,n,i){var r=(new bt).Copy(i).SelfMul(1/(n-t));if(e.IsSignificantForce(r)){this.PrepareForceBuffer();for(var o=t;o<n;o++)this.m_forceBuffer[o].SelfAdd(r)}},r.GetNext=function(){return this.m_next},r.QueryAABB=function(t,n){if(0!==this.m_proxyBuffer.count)for(var i=0,r=this.m_proxyBuffer.count,o=Wr(this.m_proxyBuffer.data,i,r,e.computeTag(this.m_inverseDiameter*n.lowerBound.x,this.m_inverseDiameter*n.lowerBound.y),ro.CompareProxyTag),a=qr(this.m_proxyBuffer.data,o,r,e.computeTag(this.m_inverseDiameter*n.upperBound.x,this.m_inverseDiameter*n.upperBound.y),ro.CompareTagProxy),s=this.m_positionBuffer.data,c=o;c<a;++c){var l=this.m_proxyBuffer.data[c].index,u=s[l];if(n.lowerBound.x<u.x&&u.x<n.upperBound.x&&n.lowerBound.y<u.y&&u.y<n.upperBound.y&&!t.ReportParticle(this,l))break}},r.QueryShapeAABB=function(t,n,i,r){void 0===r&&(r=0);var o=e.QueryShapeAABB_s_aabb;n.ComputeAABB(o,i,r),this.QueryAABB(t,o)},r.QueryPointAABB=function(t,n,i){void 0===i&&(i=h);var r=e.QueryPointAABB_s_aabb;r.lowerBound.Set(n.x-i,n.y-i),r.upperBound.Set(n.x+i,n.y+i),this.QueryAABB(t,r)},r.RayCast=function(t,n,i){var r=e.RayCast_s_aabb,o=e.RayCast_s_p,a=e.RayCast_s_v,s=e.RayCast_s_n,c=e.RayCast_s_point;if(0!==this.m_proxyBuffer.count){var l=this.m_positionBuffer.data,u=r;bt.MinV(n,i,u.lowerBound),bt.MaxV(n,i,u.upperBound);for(var h,_=1,f=bt.SubVV(i,n,a),p=bt.DotVV(f,f),d=this.GetInsideBoundsEnumerator(u);(h=d.GetNext())>=0;){var m=bt.SubVV(n,l[h],o),v=bt.DotVV(m,f),g=v*v-p*(bt.DotVV(m,m)-this.m_squaredDiameter);if(g>=0){var y=ht(g),x=(-v-y)/p;if(x>_)continue;if(x<0&&((x=(-v+y)/p)<0||x>_))continue;var S=bt.AddVMulSV(m,x,f,s);if(S.Normalize(),(_=rt(_,t.ReportParticle(this,h,bt.AddVMulSV(n,x,f,c),S,x)))<=0)break}}}},r.ComputeAABB=function(t){var e=this.GetParticleCount();t.lowerBound.x=+i,t.lowerBound.y=+i,t.upperBound.x=-i,t.upperBound.y=-i;for(var n=this.m_positionBuffer.data,r=0;r<e;r++){var o=n[r];bt.MinV(t.lowerBound,o,t.lowerBound),bt.MaxV(t.upperBound,o,t.upperBound)}t.lowerBound.x-=this.m_particleDiameter,t.lowerBound.y-=this.m_particleDiameter,t.upperBound.x+=this.m_particleDiameter,t.upperBound.y+=this.m_particleDiameter},r.FreeBuffer=function(t){null!==t&&(t.length=0)},r.FreeUserOverridableBuffer=function(t){0===t.userSuppliedCapacity&&this.FreeBuffer(t.data,this.m_internalAllocatedCapacity)},r.ReallocateBuffer3=function(t,e,n){if(n<=e)throw new Error;var i=t?t.slice():[];return i.length=n,i},r.ReallocateBuffer5=function(t,e,n,i,r){if(i<=n)throw new Error;if(e&&!(i<=e))throw new Error;return r&&!t||e||(t=this.ReallocateBuffer3(t,n,i)),t},r.ReallocateBuffer4=function(t,e,n,i){return this.ReallocateBuffer5(t.data,t.userSuppliedCapacity,e,n,i)},r.RequestBuffer=function(t){return t||(0===this.m_internalAllocatedCapacity&&this.ReallocateInternalAllocatedBuffers(M),(t=[]).length=this.m_internalAllocatedCapacity),t},r.ReallocateHandleBuffers=function(t){this.m_handleIndexBuffer.data=this.ReallocateBuffer4(this.m_handleIndexBuffer,this.m_internalAllocatedCapacity,t,!0)},r.ReallocateInternalAllocatedBuffers=function(t){function e(t,e){return e&&t>e?e:t}if(t=e(t,this.m_def.maxCount),t=e(t,this.m_flagsBuffer.userSuppliedCapacity),t=e(t,this.m_positionBuffer.userSuppliedCapacity),t=e(t,this.m_velocityBuffer.userSuppliedCapacity),t=e(t,this.m_colorBuffer.userSuppliedCapacity),t=e(t,this.m_userDataBuffer.userSuppliedCapacity),this.m_internalAllocatedCapacity<t){this.ReallocateHandleBuffers(t),this.m_flagsBuffer.data=this.ReallocateBuffer4(this.m_flagsBuffer,this.m_internalAllocatedCapacity,t,!1);var n=this.m_stuckThreshold>0;this.m_lastBodyContactStepBuffer.data=this.ReallocateBuffer4(this.m_lastBodyContactStepBuffer,this.m_internalAllocatedCapacity,t,n),this.m_bodyContactCountBuffer.data=this.ReallocateBuffer4(this.m_bodyContactCountBuffer,this.m_internalAllocatedCapacity,t,n),this.m_consecutiveContactStepsBuffer.data=this.ReallocateBuffer4(this.m_consecutiveContactStepsBuffer,this.m_internalAllocatedCapacity,t,n),this.m_positionBuffer.data=this.ReallocateBuffer4(this.m_positionBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_velocityBuffer.data=this.ReallocateBuffer4(this.m_velocityBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_forceBuffer=this.ReallocateBuffer5(this.m_forceBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_weightBuffer=this.ReallocateBuffer5(this.m_weightBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_staticPressureBuffer=this.ReallocateBuffer5(this.m_staticPressureBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_accumulationBuffer=this.ReallocateBuffer5(this.m_accumulationBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_accumulation2Buffer=this.ReallocateBuffer5(this.m_accumulation2Buffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_depthBuffer=this.ReallocateBuffer5(this.m_depthBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_colorBuffer.data=this.ReallocateBuffer4(this.m_colorBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_groupBuffer=this.ReallocateBuffer5(this.m_groupBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_userDataBuffer.data=this.ReallocateBuffer4(this.m_userDataBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_expirationTimeBuffer.data=this.ReallocateBuffer4(this.m_expirationTimeBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_indexByExpirationTimeBuffer.data=this.ReallocateBuffer4(this.m_indexByExpirationTimeBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_internalAllocatedCapacity=t}},r.CreateParticleForGroup=function(t,e,i){var r=new Rr;r.flags=n(t.flags,0),Rt.MulXV(e,i,r.position),bt.AddVV(n(t.linearVelocity,bt.ZERO),bt.CrossSV(n(t.angularVelocity,0),bt.SubVV(r.position,n(t.position,bt.ZERO),bt.s_t0),bt.s_t0),r.velocity),r.color.Copy(n(t.color,Mt.ZERO)),r.lifetime=n(t.lifetime,0),r.userData=t.userData,this.CreateParticle(r)},r.CreateParticlesStrokeShapeForGroup=function(i,r,o){var a=e.CreateParticlesStrokeShapeForGroup_s_edge,s=e.CreateParticlesStrokeShapeForGroup_s_d,c=e.CreateParticlesStrokeShapeForGroup_s_p,l=n(r.stride,0);0===l&&(l=this.GetParticleStride());for(var u=0,h=i.GetChildCount(),_=0;_<h;_++){var f=null;i.GetType()===t.b2ShapeType.e_edgeShape?f=i:(f=a,i.GetChildEdge(f,_));for(var p=bt.SubVV(f.m_vertex2,f.m_vertex1,s),d=p.Length();u<d;){var m=bt.AddVMulSV(f.m_vertex1,u/d,p,c);this.CreateParticleForGroup(r,o,m),u+=l}u-=d}},r.CreateParticlesFillShapeForGroup=function(t,i,r){var o=e.CreateParticlesFillShapeForGroup_s_aabb,a=e.CreateParticlesFillShapeForGroup_s_p,s=n(i.stride,0);0===s&&(s=this.GetParticleStride());var c=Rt.IDENTITY,l=o;t.ComputeAABB(l,c,0);for(var u=Math.floor(l.lowerBound.y/s)*s;u<l.upperBound.y;u+=s)for(var h=Math.floor(l.lowerBound.x/s)*s;h<l.upperBound.x;h+=s){var _=a.Set(h,u);t.TestPoint(c,_)&&this.CreateParticleForGroup(i,r,_)}},r.CreateParticlesWithShapeForGroup=function(e,n,i){switch(e.GetType()){case t.b2ShapeType.e_edgeShape:case t.b2ShapeType.e_chainShape:this.CreateParticlesStrokeShapeForGroup(e,n,i);break;case t.b2ShapeType.e_polygonShape:case t.b2ShapeType.e_circleShape:this.CreateParticlesFillShapeForGroup(e,n,i)}},r.CreateParticlesWithShapesForGroup=function(t,e,n,i){var r=new mo(t,e);this.CreateParticlesFillShapeForGroup(r,n,i)},r.CloneParticle=function(t,e){var n=new Rr;n.flags=this.m_flagsBuffer.data[t],n.position.Copy(this.m_positionBuffer.data[t]),n.velocity.Copy(this.m_velocityBuffer.data[t]),this.m_colorBuffer.data&&n.color.Copy(this.m_colorBuffer.data[t]),this.m_userDataBuffer.data&&(n.userData=this.m_userDataBuffer.data[t]),n.group=e;var i=this.CreateParticle(n);if(this.m_handleIndexBuffer.data){var r=this.m_handleIndexBuffer.data[t];r&&r.SetIndex(i),this.m_handleIndexBuffer.data[i]=r,this.m_handleIndexBuffer.data[t]=null}return this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[i]=this.m_lastBodyContactStepBuffer.data[t]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[i]=this.m_bodyContactCountBuffer.data[t]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[i]=this.m_consecutiveContactStepsBuffer.data[t]),this.m_hasForce&&this.m_forceBuffer[i].Copy(this.m_forceBuffer[t]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[i]=this.m_staticPressureBuffer[t]),this.m_depthBuffer&&(this.m_depthBuffer[i]=this.m_depthBuffer[t]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[i]=this.m_expirationTimeBuffer.data[t]),i},r.DestroyParticlesInGroup=function(t,e){void 0===e&&(e=!1);for(var n=t.m_firstIndex;n<t.m_lastIndex;n++)this.DestroyParticle(n,e)},r.DestroyParticleGroup=function(t){this.m_world.m_destructionListener&&this.m_world.m_destructionListener.SayGoodbyeParticleGroup(t),this.SetGroupFlags(t,0);for(var e=t.m_firstIndex;e<t.m_lastIndex;e++)this.m_groupBuffer[e]=null;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_groupList&&(this.m_groupList=t.m_next),--this.m_groupCount},e.ParticleCanBeConnected=function(e,n){return 0!=(e&(t.b2ParticleFlag.b2_wallParticle|t.b2ParticleFlag.b2_springParticle|t.b2ParticleFlag.b2_elasticParticle))||null!==n&&0!=(n.GetGroupFlags()&t.b2ParticleGroupFlag.b2_rigidParticleGroup)},r.UpdatePairsAndTriads=function(n,i,r){for(var o=e.UpdatePairsAndTriads_s_dab,a=e.UpdatePairsAndTriads_s_dbc,s=e.UpdatePairsAndTriads_s_dca,c=this.m_positionBuffer.data,l=0,u=n;u<i;u++)l|=this.m_flagsBuffer.data[u];if(l&e.k_pairFlags)for(var h=0;h<this.m_contactBuffer.count;h++){var _=this.m_contactBuffer.data[h],f=_.indexA,p=_.indexB,d=this.m_flagsBuffer.data[f],m=this.m_flagsBuffer.data[p],v=this.m_groupBuffer[f],g=this.m_groupBuffer[p];if(f>=n&&f<i&&p>=n&&p<i&&!((d|m)&t.b2ParticleFlag.b2_zombieParticle)&&(d|m)&e.k_pairFlags&&(r.IsNecessary(f)||r.IsNecessary(p))&&e.ParticleCanBeConnected(d,v)&&e.ParticleCanBeConnected(m,g)&&r.ShouldCreatePair(f,p)){var y=this.m_pairBuffer.data[this.m_pairBuffer.Append()];y.indexA=f,y.indexB=p,y.flags=_.flags,y.strength=rt(v?v.m_strength:1,g?g.m_strength:1),y.distance=bt.DistanceVV(c[f],c[p])}Hr(this.m_pairBuffer.data,0,this.m_pairBuffer.count,e.ComparePairIndices),this.m_pairBuffer.Unique(e.MatchPairIndices)}if(l&e.k_triadFlags){for(var x=new Fr(i-n),S=n;S<i;S++){var A=this.m_flagsBuffer.data[S],C=this.m_groupBuffer[S];A&t.b2ParticleFlag.b2_zombieParticle||!e.ParticleCanBeConnected(A,C)||x.AddGenerator(c[S],S,r.IsNecessary(S))}var b=this.GetParticleStride();x.Generate(b/2,2*b);var T=this,E=function(t,n,i){var l=T.m_flagsBuffer.data[t],u=T.m_flagsBuffer.data[n],h=T.m_flagsBuffer.data[i];if((l|u|h)&e.k_triadFlags&&r.ShouldCreateTriad(t,n,i)){var _=c[t],f=c[n],p=c[i],d=bt.SubVV(_,f,o),m=bt.SubVV(f,p,a),v=bt.SubVV(p,_,s),g=B*T.m_squaredDiameter;if(bt.DotVV(d,d)>g||bt.DotVV(m,m)>g||bt.DotVV(v,v)>g)return;var y=T.m_groupBuffer[t],x=T.m_groupBuffer[n],S=T.m_groupBuffer[i],A=T.m_triadBuffer.data[T.m_triadBuffer.Append()];A.indexA=t,A.indexB=n,A.indexC=i,A.flags=l|u|h,A.strength=rt(rt(y?y.m_strength:1,x?x.m_strength:1),S?S.m_strength:1);var C=(_.x+f.x+p.x)/3,b=(_.y+f.y+p.y)/3;A.pa.x=_.x-C,A.pa.y=_.y-b,A.pb.x=f.x-C,A.pb.y=f.y-b,A.pc.x=p.x-C,A.pc.y=p.y-b,A.ka=-bt.DotVV(v,d),A.kb=-bt.DotVV(d,m),A.kc=-bt.DotVV(m,v),A.s=bt.CrossVV(_,f)+bt.CrossVV(f,p)+bt.CrossVV(p,_)}};x.GetNodes(E),Hr(this.m_triadBuffer.data,0,this.m_triadBuffer.count,e.CompareTriadIndices),this.m_triadBuffer.Unique(e.MatchTriadIndices)}},r.UpdatePairsAndTriadsWithReactiveParticles=function(){var e=new vo(this.m_flagsBuffer);this.UpdatePairsAndTriads(0,this.m_count,e);for(var n=0;n<this.m_count;n++)this.m_flagsBuffer.data[n]&=~t.b2ParticleFlag.b2_reactiveParticle;this.m_allParticleFlags&=~t.b2ParticleFlag.b2_reactiveParticle},e.ComparePairIndices=function(t,e){var n=t.indexA-e.indexA;return 0!==n?n<0:t.indexB<e.indexB},e.MatchPairIndices=function(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB},e.CompareTriadIndices=function(t,e){var n=t.indexA-e.indexA;if(0!==n)return n<0;var i=t.indexB-e.indexB;return 0!==i?i<0:t.indexC<e.indexC},e.MatchTriadIndices=function(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB&&t.indexC===e.indexC},e.InitializeParticleLists=function(t,e){for(var n=t.GetBufferIndex(),i=t.GetParticleCount(),r=0;r<i;r++){var o=e[r];o.list=o,o.next=null,o.count=1,o.index=r+n}},r.MergeParticleListsInContact=function(t,n){for(var i=t.GetBufferIndex(),r=0;r<this.m_contactBuffer.count;r++){var o=this.m_contactBuffer.data[r],a=o.indexA,s=o.indexB;if(t.ContainsParticle(a)&&t.ContainsParticle(s)){var c=n[a-i].list,l=n[s-i].list;if(c!==l){if(c.count<l.count){var u=c;c=l,l=u}e.MergeParticleLists(c,l)}}}},e.MergeParticleLists=function(t,e){for(var n=e;;){n.list=t;var i=n.next;if(!i){n.next=t.next;break}n=i}t.next=e,t.count+=e.count,e.count=0},e.FindLongestParticleList=function(t,e){for(var n=t.GetParticleCount(),i=e[0],r=0;r<n;r++){var o=e[r];i.count<o.count&&(i=o)}return i},r.MergeZombieParticleListNodes=function(n,i,r){for(var o=n.GetParticleCount(),a=0;a<o;a++){var s=i[a];s!==r&&this.m_flagsBuffer.data[s.index]&t.b2ParticleFlag.b2_zombieParticle&&e.MergeParticleListAndNode(r,s)}},e.MergeParticleListAndNode=function(t,e){e.list=t,e.next=t.next,t.next=e,t.count++,e.count=0},r.CreateParticleGroupsFromParticleList=function(e,n,i){var r=e.GetParticleCount(),o=new Or;o.groupFlags=e.GetGroupFlags(),o.userData=e.GetUserData();for(var a=0;a<r;a++){var s=n[a];if(s.count&&s!==i)for(var c=this.CreateParticleGroup(o),l=s;l;l=l.next){var u=l.index,h=this.CloneParticle(u,c);this.m_flagsBuffer.data[u]|=t.b2ParticleFlag.b2_zombieParticle,l.index=h}}},r.UpdatePairsAndTriadsWithParticleList=function(t,e){for(var n=t.GetBufferIndex(),i=0;i<this.m_pairBuffer.count;i++){var r=this.m_pairBuffer.data[i],o=r.indexA,a=r.indexB;t.ContainsParticle(o)&&(r.indexA=e[o-n].index),t.ContainsParticle(a)&&(r.indexB=e[a-n].index)}for(var s=0;s<this.m_triadBuffer.count;s++){var c=this.m_triadBuffer.data[s],l=c.indexA,u=c.indexB,h=c.indexC;t.ContainsParticle(l)&&(c.indexA=e[l-n].index),t.ContainsParticle(u)&&(c.indexB=e[u-n].index),t.ContainsParticle(h)&&(c.indexC=e[h-n].index)}},r.ComputeDepth=function(){for(var e=[],n=0,r=0;r<this.m_contactBuffer.count;r++){var o=this.m_contactBuffer.data[r],a=o.indexA,s=o.indexB,c=this.m_groupBuffer[a],l=this.m_groupBuffer[s];c&&c===l&&c.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&(e[n++]=o)}for(var u=[],h=0,_=this.m_groupList;_;_=_.GetNext())if(_.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth){u[h++]=_,this.SetGroupFlags(_,_.m_groupFlags&~t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth);for(var f=_.m_firstIndex;f<_.m_lastIndex;f++)this.m_accumulationBuffer[f]=0}for(var p=0;p<n;p++){var d=e[p],m=d.indexA,v=d.indexB,g=d.weight;this.m_accumulationBuffer[m]+=g,this.m_accumulationBuffer[v]+=g}for(var y=0;y<h;y++)for(var x=u[y],S=x.m_firstIndex;S<x.m_lastIndex;S++){var A=this.m_accumulationBuffer[S];this.m_depthBuffer[S]=A<.8?0:i}for(var C=ht(this.m_count)>>0,b=0;b<C;b++){for(var T=!1,E=0;E<n;E++){var w=e[E],P=w.indexA,I=w.indexB,R=1-w.weight,D=this.m_depthBuffer[P],B=this.m_depthBuffer[I],M=B+R,O=D+R;D>M&&(this.m_depthBuffer[P]=M,T=!0),B>O&&(this.m_depthBuffer[I]=O,T=!0)}if(!T)break}for(var N=0;N<h;N++)for(var L=u[N],F=L.m_firstIndex;F<L.m_lastIndex;F++)this.m_depthBuffer[F]<i?this.m_depthBuffer[F]*=this.m_particleDiameter:this.m_depthBuffer[F]=0},r.GetInsideBoundsEnumerator=function(t){var n=e.computeTag(this.m_inverseDiameter*t.lowerBound.x-1,this.m_inverseDiameter*t.lowerBound.y-1),i=e.computeTag(this.m_inverseDiameter*t.upperBound.x+1,this.m_inverseDiameter*t.upperBound.y+1),r=0,o=this.m_proxyBuffer.count,a=Wr(this.m_proxyBuffer.data,r,o,n,ro.CompareProxyTag),s=qr(this.m_proxyBuffer.data,r,o,i,ro.CompareTagProxy);return new oo(this,n,i,a,s)},r.UpdateAllParticleFlags=function(){this.m_allParticleFlags=0;for(var t=0;t<this.m_count;t++)this.m_allParticleFlags|=this.m_flagsBuffer.data[t];this.m_needsUpdateAllParticleFlags=!1},r.UpdateAllGroupFlags=function(){this.m_allGroupFlags=0;for(var t=this.m_groupList;t;t=t.GetNext())this.m_allGroupFlags|=t.m_groupFlags;this.m_needsUpdateAllGroupFlags=!1},r.AddContact=function(t,n){var i=this.m_flagsBuffer.data,r=this.m_positionBuffer.data,o=bt.SubVV(r[n],r[t],e.AddContact_s_d),a=bt.DotVV(o,o);if(0<a&&a<this.m_squaredDiameter){var s=ut(a),c=this.m_contactBuffer.data[this.m_contactBuffer.Append()];c.indexA=t,c.indexB=n,c.flags=i[t]|i[n],c.weight=1-a*s*this.m_inverseDiameter,c.normal.x=s*o.x,c.normal.y=s*o.y}},r.FindContacts_Reference=function(){var t=0,n=this.m_proxyBuffer.count;this.m_contactBuffer.count=0;for(var i=t,r=t;i<n;i++){for(var o=e.computeRelativeTag(this.m_proxyBuffer.data[i].tag,1,0),a=i+1;a<n&&!(o<this.m_proxyBuffer.data[a].tag);a++)this.AddContact(this.m_proxyBuffer.data[i].index,this.m_proxyBuffer.data[a].index,this.m_contactBuffer);for(var s=e.computeRelativeTag(this.m_proxyBuffer.data[i].tag,-1,1);r<n&&!(s<=this.m_proxyBuffer.data[r].tag);r++);for(var c=e.computeRelativeTag(this.m_proxyBuffer.data[i].tag,1,1),l=r;l<n&&!(c<this.m_proxyBuffer.data[l].tag);l++)this.AddContact(this.m_proxyBuffer.data[i].index,this.m_proxyBuffer.data[l].index,this.m_contactBuffer)}},r.FindContacts=function(t){this.FindContacts_Reference(t)},r.UpdateProxies_Reference=function(){for(var t=this.m_positionBuffer.data,n=this.m_inverseDiameter,i=0;i<this.m_proxyBuffer.count;++i){var r=this.m_proxyBuffer.data[i],o=t[r.index];r.tag=e.computeTag(n*o.x,n*o.y)}},r.UpdateProxies=function(t){this.UpdateProxies_Reference(t)},r.SortProxies=function(){kr(this.m_proxyBuffer.data,0,this.m_proxyBuffer.count,ro.CompareProxyProxy)},r.FilterContacts=function(){var e=this.GetParticleContactFilter();if(null!==e){var n=this,i=function(i){return 0!=(i.flags&t.b2ParticleFlag.b2_particleContactFilterParticle)&&!e.ShouldCollideParticleParticle(n,i.indexA,i.indexB)};this.m_contactBuffer.RemoveIf(i)}},r.NotifyContactListenerPreContact=function(t){if(null!==this.GetParticleContactListener())throw t.Initialize(this.m_contactBuffer,this.m_flagsBuffer),new Error},r.NotifyContactListenerPostContact=function(){var t=this.GetParticleContactListener();if(null!==t){for(var e=0;e<this.m_contactBuffer.count;++e){var n=this.m_contactBuffer.data[e];t.BeginContactParticleParticle(this,n)}throw new Error}},e.b2ParticleContactIsZombie=function(e){return(e.flags&t.b2ParticleFlag.b2_zombieParticle)===t.b2ParticleFlag.b2_zombieParticle},r.UpdateContacts=function(t){this.UpdateProxies(this.m_proxyBuffer),this.SortProxies(this.m_proxyBuffer);var n=new ho;this.NotifyContactListenerPreContact(n),this.FindContacts(this.m_contactBuffer),this.FilterContacts(this.m_contactBuffer),this.NotifyContactListenerPostContact(n),t&&this.m_contactBuffer.RemoveIf(e.b2ParticleContactIsZombie)},r.NotifyBodyContactListenerPreContact=function(t){if(null!==this.GetFixtureContactListener())throw t.Initialize(this.m_bodyContactBuffer,this.m_flagsBuffer),new Error},r.NotifyBodyContactListenerPostContact=function(){var t=this.GetFixtureContactListener();if(null!==t){for(var e=0;e<this.m_bodyContactBuffer.count;e++){var n=this.m_bodyContactBuffer.data[e];t.BeginContactFixtureParticle(this,n)}throw new Error}},r.UpdateBodyContacts=function(){var t=e.UpdateBodyContacts_s_aabb,n=new lo;if(this.NotifyBodyContactListenerPreContact(n),this.m_stuckThreshold>0)for(var i=this.GetParticleCount(),r=0;r<i;r++)this.m_bodyContactCountBuffer.data[r]=0,this.m_timestamp>this.m_lastBodyContactStepBuffer.data[r]+1&&(this.m_consecutiveContactStepsBuffer.data[r]=0);this.m_bodyContactBuffer.SetCount(0),this.m_stuckParticleBuffer.SetCount(0);var o=t;this.ComputeAABB(o),null===this.UpdateBodyContacts_callback&&(this.UpdateBodyContacts_callback=new go(this));var a=this.UpdateBodyContacts_callback;a.m_contactFilter=this.GetFixtureContactFilter(),this.m_world.QueryAABB(a,o),this.m_def.strictContactCheck&&this.RemoveSpuriousBodyContacts(),this.NotifyBodyContactListenerPostContact(n)},r.Solve=function(n){var i=e.Solve_s_subStep;if(0!==this.m_count&&(this.m_expirationTimeBuffer.data&&this.SolveLifetimes(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_zombieParticle&&this.SolveZombie(),this.m_needsUpdateAllParticleFlags&&this.UpdateAllParticleFlags(),this.m_needsUpdateAllGroupFlags&&this.UpdateAllGroupFlags(),!this.m_paused))for(this.m_iterationIndex=0;this.m_iterationIndex<n.particleIterations;this.m_iterationIndex++){++this.m_timestamp;var r=i.Copy(n);r.dt/=n.particleIterations,r.inv_dt*=n.particleIterations,this.UpdateContacts(!1),this.UpdateBodyContacts(),this.ComputeWeight(),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&this.ComputeDepth(),this.m_allParticleFlags&t.b2ParticleFlag.b2_reactiveParticle&&this.UpdatePairsAndTriadsWithReactiveParticles(),this.m_hasForce&&this.SolveForce(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_viscousParticle&&this.SolveViscous(),this.m_allParticleFlags&t.b2ParticleFlag.b2_repulsiveParticle&&this.SolveRepulsive(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_powderParticle&&this.SolvePowder(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_tensileParticle&&this.SolveTensile(r),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SolveSolid(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_colorMixingParticle&&this.SolveColorMixing(),this.SolveGravity(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_staticPressureParticle&&this.SolveStaticPressure(r),this.SolvePressure(r),this.SolveDamping(r),this.m_allParticleFlags&e.k_extraDampingFlags&&this.SolveExtraDamping(),this.m_allParticleFlags&t.b2ParticleFlag.b2_elasticParticle&&this.SolveElastic(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_springParticle&&this.SolveSpring(r),this.LimitVelocity(r),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigidDamping(),this.m_allParticleFlags&t.b2ParticleFlag.b2_barrierParticle&&this.SolveBarrier(r),this.SolveCollision(r),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigid(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_wallParticle&&this.SolveWall();for(var o=0;o<this.m_count;o++)this.m_positionBuffer.data[o].SelfMulAdd(r.dt,this.m_velocityBuffer.data[o])}},r.SolveCollision=function(t){var n=e.SolveCollision_s_aabb,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=n;a.lowerBound.x=+i,a.lowerBound.y=+i,a.upperBound.x=-i,a.upperBound.y=-i;for(var s=0;s<this.m_count;s++){var c=o[s],l=r[s],u=l.x+t.dt*c.x,h=l.y+t.dt*c.y;a.lowerBound.x=rt(a.lowerBound.x,rt(l.x,u)),a.lowerBound.y=rt(a.lowerBound.y,rt(l.y,h)),a.upperBound.x=ot(a.upperBound.x,ot(l.x,u)),a.upperBound.y=ot(a.upperBound.y,ot(l.y,h))}null===this.SolveCollision_callback&&(this.SolveCollision_callback=new yo(this,t));var _=this.SolveCollision_callback;_.m_step=t,this.m_world.QueryAABB(_,a)},r.LimitVelocity=function(t){for(var e=this.m_velocityBuffer.data,n=this.GetCriticalVelocitySquared(t),i=0;i<this.m_count;i++){var r=e[i],o=bt.DotVV(r,r);o>n&&r.SelfMul(ht(n/o))}},r.SolveGravity=function(t){for(var n=e.SolveGravity_s_gravity,i=this.m_velocityBuffer.data,r=bt.MulSV(t.dt*this.m_def.gravityScale,this.m_world.GetGravity(),n),o=0;o<this.m_count;o++)i[o].SelfAdd(r)},r.SolveBarrier=function(n){for(var i=e.SolveBarrier_s_aabb,r=e.SolveBarrier_s_va,o=e.SolveBarrier_s_vb,a=e.SolveBarrier_s_pba,s=e.SolveBarrier_s_vba,c=e.SolveBarrier_s_vc,l=e.SolveBarrier_s_pca,u=e.SolveBarrier_s_vca,h=e.SolveBarrier_s_qba,_=e.SolveBarrier_s_qca,f=e.SolveBarrier_s_dv,p=e.SolveBarrier_s_f,d=this.m_positionBuffer.data,m=this.m_velocityBuffer.data,v=0;v<this.m_count;v++)0!=(this.m_flagsBuffer.data[v]&e.k_barrierWallFlags)&&m[v].SetZero();for(var g=O*n.dt,y=this.GetParticleMass(),x=0;x<this.m_pairBuffer.count;x++){var S=this.m_pairBuffer.data[x];if(S.flags&t.b2ParticleFlag.b2_barrierParticle){var A=S.indexA,C=S.indexB,b=d[A],T=d[C],E=i;bt.MinV(b,T,E.lowerBound),bt.MaxV(b,T,E.upperBound);for(var w=this.m_groupBuffer[A],P=this.m_groupBuffer[C],I=this.GetLinearVelocity(w,A,b,r),R=this.GetLinearVelocity(P,C,T,o),D=bt.SubVV(T,b,a),B=bt.SubVV(R,I,s),M=this.GetInsideBoundsEnumerator(E),N=void 0;(N=M.GetNext())>=0;){var L=d[N],F=this.m_groupBuffer[N];if(w!==F&&P!==F){var z=this.GetLinearVelocity(F,N,L,c),V=bt.SubVV(L,b,l),G=bt.SubVV(z,I,u),U=bt.CrossVV(B,G),k=bt.CrossVV(D,G)-bt.CrossVV(V,B),H=bt.CrossVV(D,V),j=void 0,W=void 0,q=h,X=_;if(0===U){if(0===k)continue;if(!((W=-H/k)>=0&&W<g))continue;if(bt.AddVMulSV(D,W,B,q),bt.AddVMulSV(V,W,G,X),!((j=bt.DotVV(q,X)/bt.DotVV(q,q))>=0&&j<=1))continue}else{var Y=k*k-4*H*U;if(Y<0)continue;var K=ht(Y),J=(-k-K)/(2*U),Q=(-k+K)/(2*U);if(J>Q){var Z=J;J=Q,Q=Z}if(W=J,bt.AddVMulSV(D,W,B,q),bt.AddVMulSV(V,W,G,X),j=bt.DotVV(q,X)/bt.DotVV(q,q),!(W>=0&&W<g&&j>=0&&j<=1)){if(!((W=Q)>=0&&W<g))continue;if(bt.AddVMulSV(D,W,B,q),bt.AddVMulSV(V,W,G,X),!((j=bt.DotVV(q,X)/bt.DotVV(q,q))>=0&&j<=1))continue}}var $=f;$.x=I.x+j*B.x-z.x,$.y=I.y+j*B.y-z.y;var tt=bt.MulSV(y,$,p);if(F&&this.IsRigidGroup(F)){var et=F.GetMass(),nt=F.GetInertia();et>0&&F.m_linearVelocity.SelfMulAdd(1/et,tt),nt>0&&(F.m_angularVelocity+=bt.CrossVV(bt.SubVV(L,F.GetCenter(),bt.s_t0),tt)/nt)}else m[N].SelfAdd($);this.ParticleApplyForce(N,tt.SelfMul(-n.inv_dt))}}}}},r.SolveStaticPressure=function(e){this.m_staticPressureBuffer=this.RequestBuffer(this.m_staticPressureBuffer);for(var n=this.GetCriticalPressure(e),i=this.m_def.staticPressureStrength*n,r=I*n,o=this.m_def.staticPressureRelaxation,a=0;a<this.m_def.staticPressureIterations;a++){for(var s=0;s<this.m_count;s++)this.m_accumulationBuffer[s]=0;for(var c=0;c<this.m_contactBuffer.count;c++){var l=this.m_contactBuffer.data[c];if(l.flags&t.b2ParticleFlag.b2_staticPressureParticle){var u=l.indexA,h=l.indexB,_=l.weight;this.m_accumulationBuffer[u]+=_*this.m_staticPressureBuffer[h],this.m_accumulationBuffer[h]+=_*this.m_staticPressureBuffer[u]}}for(var f=0;f<this.m_count;f++){var p=this.m_weightBuffer[f];if(this.m_flagsBuffer.data[f]&t.b2ParticleFlag.b2_staticPressureParticle){var d=(this.m_accumulationBuffer[f]+i*(p-P))/(p+o);this.m_staticPressureBuffer[f]=at(d,0,r)}else this.m_staticPressureBuffer[f]=0}}},r.ComputeWeight=function(){for(var t=0;t<this.m_count;t++)this.m_weightBuffer[t]=0;for(var e=0;e<this.m_bodyContactBuffer.count;e++){var n=this.m_bodyContactBuffer.data[e],i=n.index,r=n.weight;this.m_weightBuffer[i]+=r}for(var o=0;o<this.m_contactBuffer.count;o++){var a=this.m_contactBuffer.data[o],s=a.indexA,c=a.indexB,l=a.weight;this.m_weightBuffer[s]+=l,this.m_weightBuffer[c]+=l}},r.SolvePressure=function(n){for(var i=e.SolvePressure_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.GetCriticalPressure(n),s=this.m_def.pressureStrength*a,c=I*a,l=0;l<this.m_count;l++){var u=s*ot(0,this.m_weightBuffer[l]-P);this.m_accumulationBuffer[l]=rt(u,c)}if(this.m_allParticleFlags&e.k_noPressureFlags)for(var h=0;h<this.m_count;h++)this.m_flagsBuffer.data[h]&e.k_noPressureFlags&&(this.m_accumulationBuffer[h]=0);if(this.m_allParticleFlags&t.b2ParticleFlag.b2_staticPressureParticle)for(var _=0;_<this.m_count;_++)this.m_flagsBuffer.data[_]&t.b2ParticleFlag.b2_staticPressureParticle&&(this.m_accumulationBuffer[_]+=this.m_staticPressureBuffer[_]);for(var f=n.dt/(this.m_def.density*this.m_particleDiameter),p=this.GetParticleInvMass(),d=0;d<this.m_bodyContactBuffer.count;d++){var m=this.m_bodyContactBuffer.data[d],v=m.index,g=m.body,y=m.weight,x=m.mass,S=m.normal,A=r[v],C=this.m_accumulationBuffer[v]+s*y,b=bt.MulSV(f*y*x*C,S,i);o[v].SelfMulSub(p,b),g.ApplyLinearImpulse(b,A,!0)}for(var T=0;T<this.m_contactBuffer.count;T++){var E=this.m_contactBuffer.data[T],w=E.indexA,R=E.indexB,D=E.weight,B=E.normal,M=this.m_accumulationBuffer[w]+this.m_accumulationBuffer[R],O=bt.MulSV(f*D*M,B,i);o[w].SelfSub(O),o[R].SelfAdd(O)}},r.SolveDamping=function(t){for(var n=e.SolveDamping_s_v,i=e.SolveDamping_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.m_def.dampingStrength,s=1/this.GetCriticalVelocity(t),c=this.GetParticleInvMass(),l=0;l<this.m_bodyContactBuffer.count;l++){var u=this.m_bodyContactBuffer.data[l],h=u.index,_=u.body,f=u.weight,p=u.mass,d=u.normal,m=r[h],v=bt.SubVV(_.GetLinearVelocityFromWorldPoint(m,bt.s_t0),o[h],n),g=bt.DotVV(v,d);if(g<0){var y=ot(a*f,rt(-s*g,.5)),x=bt.MulSV(y*p*g,d,i);o[h].SelfMulAdd(c,x),_.ApplyLinearImpulse(x.SelfNeg(),m,!0)}}for(var S=0;S<this.m_contactBuffer.count;S++){var A=this.m_contactBuffer.data[S],C=A.indexA,b=A.indexB,T=A.weight,E=A.normal,w=bt.SubVV(o[b],o[C],n),P=bt.DotVV(w,E);if(P<0){var I=ot(a*T,rt(-s*P,.5)),R=bt.MulSV(I*P,E,i);o[C].SelfAdd(R),o[b].SelfSub(R)}}},r.SolveRigidDamping=function(){for(var t=e.SolveRigidDamping_s_t0,n=e.SolveRigidDamping_s_t1,i=e.SolveRigidDamping_s_p,r=e.SolveRigidDamping_s_v,o=[0],a=[0],s=[0],c=[0],l=[0],u=[0],h=this.m_positionBuffer.data,_=this.m_def.dampingStrength,f=0;f<this.m_bodyContactBuffer.count;f++){var p=this.m_bodyContactBuffer.data[f],d=p.index,m=this.m_groupBuffer[d];if(m&&this.IsRigidGroup(m)){var v=p.body,g=p.normal,y=p.weight,x=h[d],S=bt.SubVV(v.GetLinearVelocityFromWorldPoint(x,t),m.GetLinearVelocityFromWorldPoint(x,n),r),A=bt.DotVV(S,g);if(A<0){this.InitDampingParameterWithRigidGroupOrParticle(o,a,s,!0,m,d,x,g),this.InitDampingParameter(c,l,u,v.GetMass(),v.GetInertia()-v.GetMass()*v.GetLocalCenter().LengthSquared(),v.GetWorldCenter(),x,g);var C=_*rt(y,1)*this.ComputeDampingImpulse(o[0],a[0],s[0],c[0],l[0],u[0],A);this.ApplyDamping(o[0],a[0],s[0],!0,m,d,C,g),v.ApplyLinearImpulse(bt.MulSV(-C,g,bt.s_t0),x,!0)}}}for(var b=0;b<this.m_contactBuffer.count;b++){var T=this.m_contactBuffer.data[b],E=T.indexA,w=T.indexB,P=T.normal,I=T.weight,R=this.m_groupBuffer[E],D=this.m_groupBuffer[w],B=this.IsRigidGroup(R),M=this.IsRigidGroup(D);if(R!==D&&(B||M)){var O=bt.MidVV(h[E],h[w],i),N=bt.SubVV(this.GetLinearVelocity(D,w,O,t),this.GetLinearVelocity(R,E,O,n),r),L=bt.DotVV(N,P);if(L<0){this.InitDampingParameterWithRigidGroupOrParticle(o,a,s,B,R,E,O,P),this.InitDampingParameterWithRigidGroupOrParticle(c,l,u,M,D,w,O,P);var F=_*I*this.ComputeDampingImpulse(o[0],a[0],s[0],c[0],l[0],u[0],L);this.ApplyDamping(o[0],a[0],s[0],B,R,E,F,P),this.ApplyDamping(c[0],l[0],u[0],M,D,w,-F,P)}}}},r.SolveExtraDamping=function(){for(var t=e.SolveExtraDamping_s_v,n=e.SolveExtraDamping_s_f,i=this.m_velocityBuffer.data,r=this.m_positionBuffer.data,o=this.GetParticleInvMass(),a=0;a<this.m_bodyContactBuffer.count;a++){var s=this.m_bodyContactBuffer.data[a],c=s.index;if(this.m_flagsBuffer.data[c]&e.k_extraDampingFlags){var l=s.body,u=s.mass,h=s.normal,_=r[c],f=bt.SubVV(l.GetLinearVelocityFromWorldPoint(_,bt.s_t0),i[c],t),p=bt.DotVV(f,h);if(p<0){var d=bt.MulSV(.5*u*p,h,n);i[c].SelfMulAdd(o,d),l.ApplyLinearImpulse(d.SelfNeg(),_,!0)}}}},r.SolveWall=function(){for(var e=this.m_velocityBuffer.data,n=0;n<this.m_count;n++)this.m_flagsBuffer.data[n]&t.b2ParticleFlag.b2_wallParticle&&e[n].SetZero()},r.SolveRigid=function(n){for(var i=e.SolveRigid_s_position,r=e.SolveRigid_s_rotation,o=e.SolveRigid_s_transform,a=e.SolveRigid_s_velocityTransform,s=this.m_positionBuffer.data,c=this.m_velocityBuffer.data,l=this.m_groupList;l;l=l.GetNext())if(l.m_groupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup){l.UpdateStatistics();var u=r;u.SetAngle(n.dt*l.m_angularVelocity);var h=bt.AddVV(l.m_center,bt.SubVV(bt.MulSV(n.dt,l.m_linearVelocity,bt.s_t0),It.MulRV(u,l.m_center,bt.s_t1),bt.s_t0),i),_=o;_.SetPositionRotation(h,u),Rt.MulXX(_,l.m_transform,l.m_transform);var f=a;f.p.x=n.inv_dt*_.p.x,f.p.y=n.inv_dt*_.p.y,f.q.s=n.inv_dt*_.q.s,f.q.c=n.inv_dt*(_.q.c-1);for(var p=l.m_firstIndex;p<l.m_lastIndex;p++)Rt.MulXV(f,s[p],c[p])}},r.SolveElastic=function(n){for(var i=e.SolveElastic_s_pa,r=e.SolveElastic_s_pb,o=e.SolveElastic_s_pc,a=e.SolveElastic_s_r,s=e.SolveElastic_s_t0,c=this.m_positionBuffer.data,l=this.m_velocityBuffer.data,u=n.inv_dt*this.m_def.elasticStrength,h=0;h<this.m_triadBuffer.count;h++){var _=this.m_triadBuffer.data[h];if(_.flags&t.b2ParticleFlag.b2_elasticParticle){var f=_.indexA,p=_.indexB,d=_.indexC,m=_.pa,v=_.pb,g=_.pc,y=i.Copy(c[f]),x=r.Copy(c[p]),S=o.Copy(c[d]),A=l[f],C=l[p],b=l[d];y.SelfMulAdd(n.dt,A),x.SelfMulAdd(n.dt,C),S.SelfMulAdd(n.dt,b);var T=(y.x+x.x+S.x)/3,E=(y.y+x.y+S.y)/3;y.x-=T,y.y-=E,x.x-=T,x.y-=E,S.x-=T,S.y-=E;var w=a;w.s=bt.CrossVV(m,y)+bt.CrossVV(v,x)+bt.CrossVV(g,S),w.c=bt.DotVV(m,y)+bt.DotVV(v,x)+bt.DotVV(g,S);var P=ut(w.s*w.s+w.c*w.c);isFinite(P)||(P=198177537e11),w.s*=P,w.c*=P;var I=u*_.strength;It.MulRV(w,m,s),bt.SubVV(s,y,s),bt.MulSV(I,s,s),A.SelfAdd(s),It.MulRV(w,v,s),bt.SubVV(s,x,s),bt.MulSV(I,s,s),C.SelfAdd(s),It.MulRV(w,g,s),bt.SubVV(s,S,s),bt.MulSV(I,s,s),b.SelfAdd(s)}}},r.SolveSpring=function(n){for(var i=e.SolveSpring_s_pa,r=e.SolveSpring_s_pb,o=e.SolveSpring_s_d,a=e.SolveSpring_s_f,s=this.m_positionBuffer.data,c=this.m_velocityBuffer.data,l=n.inv_dt*this.m_def.springStrength,u=0;u<this.m_pairBuffer.count;u++){var h=this.m_pairBuffer.data[u];if(h.flags&t.b2ParticleFlag.b2_springParticle){var _=h.indexA,f=h.indexB,p=i.Copy(s[_]),d=r.Copy(s[f]),m=c[_],v=c[f];p.SelfMulAdd(n.dt,m),d.SelfMulAdd(n.dt,v);var g=bt.SubVV(d,p,o),y=h.distance,x=g.Length(),S=l*h.strength,A=bt.MulSV(S*(y-x)/x,g,a);m.SelfSub(A),v.SelfAdd(A)}}},r.SolveTensile=function(n){for(var i=e.SolveTensile_s_weightedNormal,r=e.SolveTensile_s_s,o=e.SolveTensile_s_f,a=this.m_velocityBuffer.data,s=0;s<this.m_count;s++)this.m_accumulation2Buffer[s]=new bt,this.m_accumulation2Buffer[s].SetZero();for(var c=0;c<this.m_contactBuffer.count;c++){var l=this.m_contactBuffer.data[c];if(l.flags&t.b2ParticleFlag.b2_tensileParticle){var u=l.indexA,h=l.indexB,_=l.weight,f=l.normal,p=bt.MulSV((1-_)*_,f,i);this.m_accumulation2Buffer[u].SelfSub(p),this.m_accumulation2Buffer[h].SelfAdd(p)}}for(var d=this.GetCriticalVelocity(n),m=this.m_def.surfaceTensionPressureStrength*d,v=this.m_def.surfaceTensionNormalStrength*d,g=R*d,y=0;y<this.m_contactBuffer.count;y++){var x=this.m_contactBuffer.data[y];if(x.flags&t.b2ParticleFlag.b2_tensileParticle){var S=x.indexA,A=x.indexB,C=x.weight,b=x.normal,T=this.m_weightBuffer[S]+this.m_weightBuffer[A],E=bt.SubVV(this.m_accumulation2Buffer[A],this.m_accumulation2Buffer[S],r),w=rt(m*(T-2)+v*bt.DotVV(E,b),g)*C,P=bt.MulSV(w,b,o);a[S].SelfSub(P),a[A].SelfAdd(P)}}},r.SolveViscous=function(){for(var n=e.SolveViscous_s_v,i=e.SolveViscous_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.m_def.viscousStrength,s=this.GetParticleInvMass(),c=0;c<this.m_bodyContactBuffer.count;c++){var l=this.m_bodyContactBuffer.data[c],u=l.index;if(this.m_flagsBuffer.data[u]&t.b2ParticleFlag.b2_viscousParticle){var h=l.body,_=l.weight,f=l.mass,p=r[u],d=bt.SubVV(h.GetLinearVelocityFromWorldPoint(p,bt.s_t0),o[u],n),m=bt.MulSV(a*f*_,d,i);o[u].SelfMulAdd(s,m),h.ApplyLinearImpulse(m.SelfNeg(),p,!0)}}for(var v=0;v<this.m_contactBuffer.count;v++){var g=this.m_contactBuffer.data[v];if(g.flags&t.b2ParticleFlag.b2_viscousParticle){var y=g.indexA,x=g.indexB,S=g.weight,A=bt.SubVV(o[x],o[y],n),C=bt.MulSV(a*S,A,i);o[y].SelfAdd(C),o[x].SelfSub(C)}}},r.SolveRepulsive=function(n){for(var i=e.SolveRepulsive_s_f,r=this.m_velocityBuffer.data,o=this.m_def.repulsiveStrength*this.GetCriticalVelocity(n),a=0;a<this.m_contactBuffer.count;a++){var s=this.m_contactBuffer.data[a];if(s.flags&t.b2ParticleFlag.b2_repulsiveParticle){var c=s.indexA,l=s.indexB;if(this.m_groupBuffer[c]!==this.m_groupBuffer[l]){var u=s.weight,h=s.normal,_=bt.MulSV(o*u,h,i);r[c].SelfSub(_),r[l].SelfAdd(_)}}}},r.SolvePowder=function(n){for(var i=e.SolvePowder_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.m_def.powderStrength*this.GetCriticalVelocity(n),s=1-w,c=this.GetParticleInvMass(),l=0;l<this.m_bodyContactBuffer.count;l++){var u=this.m_bodyContactBuffer.data[l],h=u.index;if(this.m_flagsBuffer.data[h]&t.b2ParticleFlag.b2_powderParticle){var _=u.weight;if(_>s){var f=u.body,p=u.mass,d=r[h],m=u.normal,v=bt.MulSV(a*p*(_-s),m,i);o[h].SelfMulSub(c,v),f.ApplyLinearImpulse(v,d,!0)}}}for(var g=0;g<this.m_contactBuffer.count;g++){var y=this.m_contactBuffer.data[g];if(y.flags&t.b2ParticleFlag.b2_powderParticle){var x=y.weight;if(x>s){var S=y.indexA,A=y.indexB,C=y.normal,b=bt.MulSV(a*(x-s),C,i);o[S].SelfSub(b),o[A].SelfAdd(b)}}}},r.SolveSolid=function(t){var n=e.SolveSolid_s_f,i=this.m_velocityBuffer.data;this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer);for(var r=t.inv_dt*this.m_def.ejectionStrength,o=0;o<this.m_contactBuffer.count;o++){var a=this.m_contactBuffer.data[o],s=a.indexA,c=a.indexB;if(this.m_groupBuffer[s]!==this.m_groupBuffer[c]){var l=a.weight,u=a.normal,h=this.m_depthBuffer[s]+this.m_depthBuffer[c],_=bt.MulSV(r*h*l,u,n);i[s].SelfSub(_),i[c].SelfAdd(_)}}},r.SolveForce=function(t){for(var e=this.m_velocityBuffer.data,n=t.dt*this.GetParticleInvMass(),i=0;i<this.m_count;i++)e[i].SelfMulAdd(n,this.m_forceBuffer[i]);this.m_hasForce=!1},r.SolveColorMixing=function(){var e=.5*this.m_def.colorMixingStrength;if(e)for(var n=0;n<this.m_contactBuffer.count;n++){var i=this.m_contactBuffer.data[n],r=i.indexA,o=i.indexB;if(this.m_flagsBuffer.data[r]&this.m_flagsBuffer.data[o]&t.b2ParticleFlag.b2_colorMixingParticle){var a=this.m_colorBuffer.data[r],s=this.m_colorBuffer.data[o];Mt.MixColors(a,s,e)}}},r.SolveZombie=function(){for(var e=0,n=[],i=0;i<this.m_count;i++)n[i]=T;for(var r=0,o=0;o<this.m_count;o++){var a=this.m_flagsBuffer.data[o];if(a&t.b2ParticleFlag.b2_zombieParticle){var s=this.m_world.m_destructionListener;if(a&t.b2ParticleFlag.b2_destructionListenerParticle&&s&&s.SayGoodbyeParticle(this,o),this.m_handleIndexBuffer.data){var c=this.m_handleIndexBuffer.data[o];c&&(c.SetIndex(T),this.m_handleIndexBuffer.data[o]=null)}n[o]=T}else{if(n[o]=e,o!==e){if(this.m_handleIndexBuffer.data){var l=this.m_handleIndexBuffer.data[o];l&&l.SetIndex(e),this.m_handleIndexBuffer.data[e]=l}this.m_flagsBuffer.data[e]=this.m_flagsBuffer.data[o],this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[e]=this.m_lastBodyContactStepBuffer.data[o]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[e]=this.m_bodyContactCountBuffer.data[o]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[e]=this.m_consecutiveContactStepsBuffer.data[o]),this.m_positionBuffer.data[e].Copy(this.m_positionBuffer.data[o]),this.m_velocityBuffer.data[e].Copy(this.m_velocityBuffer.data[o]),this.m_groupBuffer[e]=this.m_groupBuffer[o],this.m_hasForce&&this.m_forceBuffer[e].Copy(this.m_forceBuffer[o]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[e]=this.m_staticPressureBuffer[o]),this.m_depthBuffer&&(this.m_depthBuffer[e]=this.m_depthBuffer[o]),this.m_colorBuffer.data&&this.m_colorBuffer.data[e].Copy(this.m_colorBuffer.data[o]),this.m_userDataBuffer.data&&(this.m_userDataBuffer.data[e]=this.m_userDataBuffer.data[o]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[e]=this.m_expirationTimeBuffer.data[o])}e++,r|=a}}for(var u={IsProxyInvalid:function(t){return t.index<0},IsContactInvalid:function(t){return t.indexA<0||t.indexB<0},IsBodyContactInvalid:function(t){return t.index<0},IsPairInvalid:function(t){return t.indexA<0||t.indexB<0},IsTriadInvalid:function(t){return t.indexA<0||t.indexB<0||t.indexC<0}},h=0;h<this.m_proxyBuffer.count;h++){var _=this.m_proxyBuffer.data[h];_.index=n[_.index]}this.m_proxyBuffer.RemoveIf(u.IsProxyInvalid);for(var f=0;f<this.m_contactBuffer.count;f++){var p=this.m_contactBuffer.data[f];p.indexA=n[p.indexA],p.indexB=n[p.indexB]}this.m_contactBuffer.RemoveIf(u.IsContactInvalid);for(var d=0;d<this.m_bodyContactBuffer.count;d++){var m=this.m_bodyContactBuffer.data[d];m.index=n[m.index]}this.m_bodyContactBuffer.RemoveIf(u.IsBodyContactInvalid);for(var v=0;v<this.m_pairBuffer.count;v++){var g=this.m_pairBuffer.data[v];g.indexA=n[g.indexA],g.indexB=n[g.indexB]}this.m_pairBuffer.RemoveIf(u.IsPairInvalid);for(var y=0;y<this.m_triadBuffer.count;y++){var x=this.m_triadBuffer.data[y];x.indexA=n[x.indexA],x.indexB=n[x.indexB],x.indexC=n[x.indexC]}if(this.m_triadBuffer.RemoveIf(u.IsTriadInvalid),this.m_indexByExpirationTimeBuffer.data)for(var S=0,A=0;A<this.m_count;A++){var C=n[this.m_indexByExpirationTimeBuffer.data[A]];C!==T&&(this.m_indexByExpirationTimeBuffer.data[S++]=C)}for(var b=this.m_groupList;b;b=b.GetNext()){for(var E=e,w=0,P=!1,I=b.m_firstIndex;I<b.m_lastIndex;I++){var R=n[I];R>=0?(E=rt(E,R),w=ot(w,R+1)):P=!0}E<w?(b.m_firstIndex=E,b.m_lastIndex=w,P&&b.m_groupFlags&t.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SetGroupFlags(b,b.m_groupFlags|t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth)):(b.m_firstIndex=0,b.m_lastIndex=0,b.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupCanBeEmpty||this.SetGroupFlags(b,b.m_groupFlags|t.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed))}this.m_count=e,this.m_allParticleFlags=r,this.m_needsUpdateAllParticleFlags=!1;for(var D=this.m_groupList;D;){var B=D.GetNext();D.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed&&this.DestroyParticleGroup(D),D=B}},r.SolveLifetimes=function(t){this.m_timeElapsed=this.LifetimeToExpirationTime(t.dt);var e=this.GetQuantizedTimeElapsed(),n=this.m_expirationTimeBuffer.data,i=this.m_indexByExpirationTimeBuffer.data,r=this.GetParticleCount();this.m_expirationTimeBufferRequiresSorting&&(kr(i,0,r,(function(t,e){var i=n[t],r=n[e],o=i<=0;return o===r<=0?i>r:o})),this.m_expirationTimeBufferRequiresSorting=!1);for(var o=r-1;o>=0;--o){var a=i[o],s=n[a];if(e<s||s<=0)break;this.DestroyParticle(a)}},r.RotateBuffer=function(t,e,n){if(t!==e&&e!==n){if(Xr(this.m_flagsBuffer.data,t,e,n),this.m_lastBodyContactStepBuffer.data&&Xr(this.m_lastBodyContactStepBuffer.data,t,e,n),this.m_bodyContactCountBuffer.data&&Xr(this.m_bodyContactCountBuffer.data,t,e,n),this.m_consecutiveContactStepsBuffer.data&&Xr(this.m_consecutiveContactStepsBuffer.data,t,e,n),Xr(this.m_positionBuffer.data,t,e,n),Xr(this.m_velocityBuffer.data,t,e,n),Xr(this.m_groupBuffer,t,e,n),this.m_hasForce&&Xr(this.m_forceBuffer,t,e,n),this.m_staticPressureBuffer&&Xr(this.m_staticPressureBuffer,t,e,n),this.m_depthBuffer&&Xr(this.m_depthBuffer,t,e,n),this.m_colorBuffer.data&&Xr(this.m_colorBuffer.data,t,e,n),this.m_userDataBuffer.data&&Xr(this.m_userDataBuffer.data,t,e,n),this.m_handleIndexBuffer.data){Xr(this.m_handleIndexBuffer.data,t,e,n);for(var i=t;i<n;++i){var r=this.m_handleIndexBuffer.data[i];r&&r.SetIndex(y(r.GetIndex()))}}if(this.m_expirationTimeBuffer.data){Xr(this.m_expirationTimeBuffer.data,t,e,n);for(var o=this.GetParticleCount(),a=this.m_indexByExpirationTimeBuffer.data,s=0;s<o;++s)a[s]=y(a[s])}for(var c=0;c<this.m_proxyBuffer.count;c++){var l=this.m_proxyBuffer.data[c];l.index=y(l.index)}for(var u=0;u<this.m_contactBuffer.count;u++){var h=this.m_contactBuffer.data[u];h.indexA=y(h.indexA),h.indexB=y(h.indexB)}for(var _=0;_<this.m_bodyContactBuffer.count;_++){var f=this.m_bodyContactBuffer.data[_];f.index=y(f.index)}for(var p=0;p<this.m_pairBuffer.count;p++){var d=this.m_pairBuffer.data[p];d.indexA=y(d.indexA),d.indexB=y(d.indexB)}for(var m=0;m<this.m_triadBuffer.count;m++){var v=this.m_triadBuffer.data[m];v.indexA=y(v.indexA),v.indexB=y(v.indexB),v.indexC=y(v.indexC)}for(var g=this.m_groupList;g;g=g.GetNext())g.m_firstIndex=y(g.m_firstIndex),g.m_lastIndex=y(g.m_lastIndex-1)+1}function y(i){return i<t?i:i<e?i+n-e:i<n?i+t-e:i}},r.GetCriticalVelocity=function(t){return this.m_particleDiameter*t.inv_dt},r.GetCriticalVelocitySquared=function(t){var e=this.GetCriticalVelocity(t);return e*e},r.GetCriticalPressure=function(t){return this.m_def.density*this.GetCriticalVelocitySquared(t)},r.GetParticleStride=function(){return w*this.m_particleDiameter},r.GetParticleMass=function(){var t=this.GetParticleStride();return this.m_def.density*t*t},r.GetParticleInvMass=function(){var t=this.m_inverseDiameter*(1/w);return this.m_inverseDensity*t*t},r.GetFixtureContactFilter=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_fixtureContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null},r.GetParticleContactFilter=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_particleContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null},r.GetFixtureContactListener=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_fixtureContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null},r.GetParticleContactListener=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_particleContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null},r.SetUserOverridableBuffer=function(t,e){t.data=e,t.userSuppliedCapacity=e.length},r.SetGroupFlags=function(e,n){var i=e.m_groupFlags;(i^n)&t.b2ParticleGroupFlag.b2_solidParticleGroup&&(n|=t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth),i&~n&&(this.m_needsUpdateAllGroupFlags=!0),~this.m_allGroupFlags&n&&(n&t.b2ParticleGroupFlag.b2_solidParticleGroup&&(this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer)),this.m_allGroupFlags|=n),e.m_groupFlags=n},e.BodyContactCompare=function(t,e){return t.index===e.index?t.weight>e.weight:t.index<e.index},r.RemoveSpuriousBodyContacts=function(){kr(this.m_bodyContactBuffer.data,0,this.m_bodyContactBuffer.count,e.BodyContactCompare);var t=e.RemoveSpuriousBodyContacts_s_n,n=e.RemoveSpuriousBodyContacts_s_pos,i=e.RemoveSpuriousBodyContacts_s_normal,r=3,o=this,a=-1,s=0,c=function(e){if(e.index!==a&&(s=0,a=e.index),s++>r)return!0;var c=t.Copy(e.normal);c.SelfMul(o.m_particleDiameter*(1-e.weight));var l=bt.AddVV(o.m_positionBuffer.data[e.index],c,n);if(!e.fixture.TestPoint(l)){for(var u=e.fixture.GetShape().GetChildCount(),_=0;_<u;_++){var f=i;if(e.fixture.ComputeDistance(l,f,_)<h)return!1}return!0}return!1};this.m_bodyContactBuffer.count=jr(this.m_bodyContactBuffer.data,c,this.m_bodyContactBuffer.count)},r.DetectStuckParticle=function(t){this.m_stuckThreshold<=0||(++this.m_bodyContactCountBuffer.data[t],2===this.m_bodyContactCountBuffer.data[t]&&(++this.m_consecutiveContactStepsBuffer.data[t],this.m_consecutiveContactStepsBuffer.data[t]>this.m_stuckThreshold&&(this.m_stuckParticleBuffer.data[this.m_stuckParticleBuffer.Append()]=t)),this.m_lastBodyContactStepBuffer.data[t]=this.m_timestamp)},r.ValidateParticleIndex=function(t){return t>=0&&t<this.GetParticleCount()&&t!==T},r.GetQuantizedTimeElapsed=function(){return Math.floor(this.m_timeElapsed/4294967296)},r.LifetimeToExpirationTime=function(t){return this.m_timeElapsed+Math.floor(t/this.m_def.lifetimeGranularity*4294967296)},r.ForceCanBeApplied=function(e){return!(e&t.b2ParticleFlag.b2_wallParticle)},r.PrepareForceBuffer=function(){if(!this.m_hasForce){for(var t=0;t<this.m_count;t++)this.m_forceBuffer[t].SetZero();this.m_hasForce=!0}},r.IsRigidGroup=function(e){return null!==e&&0!=(e.m_groupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup)},r.GetLinearVelocity=function(t,e,n,i){return t&&this.IsRigidGroup(t)?t.GetLinearVelocityFromWorldPoint(n,i):i.Copy(this.m_velocityBuffer.data[e])},r.InitDampingParameter=function(t,e,n,i,r,o,a,s){t[0]=i>0?1/i:0,e[0]=r>0?1/r:0,n[0]=bt.CrossVV(bt.SubVV(a,o,bt.s_t0),s)},r.InitDampingParameterWithRigidGroupOrParticle=function(e,n,i,r,o,a,s,c){if(o&&r)this.InitDampingParameter(e,n,i,o.GetMass(),o.GetInertia(),o.GetCenter(),s,c);else{var l=this.m_flagsBuffer.data[a];this.InitDampingParameter(e,n,i,l&t.b2ParticleFlag.b2_wallParticle?0:this.GetParticleMass(),0,s,s,c)}},r.ComputeDampingImpulse=function(t,e,n,i,r,o,a){var s=t+e*n*n+i+r*o*o;return s>0?a/s:0},r.ApplyDamping=function(t,e,n,i,r,o,a,s){r&&i?(r.m_linearVelocity.SelfMulAdd(a*t,s),r.m_angularVelocity+=a*n*e):this.m_velocityBuffer.data[o].SelfMulAdd(a*t,s)},e}();no.xTruncBits=12,no.yTruncBits=12,no.tagBits=32,no.yOffset=1<<no.yTruncBits-1,no.yShift=no.tagBits-no.yTruncBits,no.xShift=no.tagBits-no.yTruncBits-no.xTruncBits,no.xScale=1<<no.xShift,no.xOffset=no.xScale*(1<<no.xTruncBits-1),no.yMask=(1<<no.yTruncBits)-1<<no.yShift,no.xMask=~no.yMask,no.DestroyParticlesInShape_s_aabb=new Te,no.CreateParticleGroup_s_transform=new Rt,no.ComputeCollisionEnergy_s_v=new bt,no.QueryShapeAABB_s_aabb=new Te,no.QueryPointAABB_s_aabb=new Te,no.RayCast_s_aabb=new Te,no.RayCast_s_p=new bt,no.RayCast_s_v=new bt,no.RayCast_s_n=new bt,no.RayCast_s_point=new bt,no.k_pairFlags=t.b2ParticleFlag.b2_springParticle,no.k_triadFlags=t.b2ParticleFlag.b2_elasticParticle,no.k_noPressureFlags=t.b2ParticleFlag.b2_powderParticle|t.b2ParticleFlag.b2_tensileParticle,no.k_extraDampingFlags=t.b2ParticleFlag.b2_staticPressureParticle,no.k_barrierWallFlags=t.b2ParticleFlag.b2_barrierParticle|t.b2ParticleFlag.b2_wallParticle,no.CreateParticlesStrokeShapeForGroup_s_edge=new ui,no.CreateParticlesStrokeShapeForGroup_s_d=new bt,no.CreateParticlesStrokeShapeForGroup_s_p=new bt,no.CreateParticlesFillShapeForGroup_s_aabb=new Te,no.CreateParticlesFillShapeForGroup_s_p=new bt,no.UpdatePairsAndTriads_s_dab=new bt,no.UpdatePairsAndTriads_s_dbc=new bt,no.UpdatePairsAndTriads_s_dca=new bt,no.AddContact_s_d=new bt,no.UpdateBodyContacts_s_aabb=new Te,no.Solve_s_subStep=new vr,no.SolveCollision_s_aabb=new Te,no.SolveGravity_s_gravity=new bt,no.SolveBarrier_s_aabb=new Te,no.SolveBarrier_s_va=new bt,no.SolveBarrier_s_vb=new bt,no.SolveBarrier_s_pba=new bt,no.SolveBarrier_s_vba=new bt,no.SolveBarrier_s_vc=new bt,no.SolveBarrier_s_pca=new bt,no.SolveBarrier_s_vca=new bt,no.SolveBarrier_s_qba=new bt,no.SolveBarrier_s_qca=new bt,no.SolveBarrier_s_dv=new bt,no.SolveBarrier_s_f=new bt,no.SolvePressure_s_f=new bt,no.SolveDamping_s_v=new bt,no.SolveDamping_s_f=new bt,no.SolveRigidDamping_s_t0=new bt,no.SolveRigidDamping_s_t1=new bt,no.SolveRigidDamping_s_p=new bt,no.SolveRigidDamping_s_v=new bt,no.SolveExtraDamping_s_v=new bt,no.SolveExtraDamping_s_f=new bt,no.SolveRigid_s_position=new bt,no.SolveRigid_s_rotation=new It,no.SolveRigid_s_transform=new Rt,no.SolveRigid_s_velocityTransform=new Rt,no.SolveElastic_s_pa=new bt,no.SolveElastic_s_pb=new bt,no.SolveElastic_s_pc=new bt,no.SolveElastic_s_r=new It,no.SolveElastic_s_t0=new bt,no.SolveSpring_s_pa=new bt,no.SolveSpring_s_pb=new bt,no.SolveSpring_s_d=new bt,no.SolveSpring_s_f=new bt,no.SolveTensile_s_weightedNormal=new bt,no.SolveTensile_s_s=new bt,no.SolveTensile_s_f=new bt,no.SolveViscous_s_v=new bt,no.SolveViscous_s_f=new bt,no.SolveRepulsive_s_f=new bt,no.SolvePowder_s_f=new bt,no.SolveSolid_s_f=new bt,no.RemoveSpuriousBodyContacts_s_n=new bt,no.RemoveSpuriousBodyContacts_s_pos=new bt,no.RemoveSpuriousBodyContacts_s_normal=new bt;var io=function(){function t(){this._data=null,this.userSuppliedCapacity=0}return N(t,[{key:"data",get:function(){return this._data},set:function(t){this._data=t}}]),t}(),ro=function(){function t(){this.index=T,this.tag=0}return t.CompareProxyProxy=function(t,e){return t.tag<e.tag},t.CompareTagProxy=function(t,e){return t<e.tag},t.CompareProxyTag=function(t,e){return t.tag<e},t}(),oo=function(){function t(t,e,n,i,r){this.m_system=t,this.m_xLower=(e&no.xMask)>>>0,this.m_xUpper=(n&no.xMask)>>>0,this.m_yLower=(e&no.yMask)>>>0,this.m_yUpper=(n&no.yMask)>>>0,this.m_first=i,this.m_last=r}return t.prototype.GetNext=function(){for(;this.m_first<this.m_last;){var t=(this.m_system.m_proxyBuffer.data[this.m_first].tag&no.xMask)>>>0;if(t>=this.m_xLower&&t<=this.m_xUpper)return this.m_system.m_proxyBuffer.data[this.m_first++].index;this.m_first++}return T},t}(),ao=function(){this.next=null,this.count=0,this.index=0},so=function(){function t(){}var e=t.prototype;return e.Allocate=function(t,e){return e},e.Clear=function(){},e.GetCount=function(){return 0},e.Invalidate=function(){},e.GetValidBuffer=function(){return[]},e.GetBuffer=function(){return[]},e.SetCount=function(){},t}(),co=function(t,e){this.second=T,this.first=t,this.second=e},lo=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.Initialize=function(){},n.Find=function(){return T},e}(so),uo=function(t,e){this.first=T,this.second=T,this.first=t,this.second=e},ho=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.Initialize=function(){},n.Find=function(){return T},e}(so),_o=function(){function t(){}var e=t.prototype;return e.IsNecessary=function(){return!0},e.ShouldCreatePair=function(){return!0},e.ShouldCreateTriad=function(){return!0},t}(),fo=function(t){function e(e,n,i,r){var o;return(o=t.call(this)||this).m_callDestructionListener=!1,o.m_destroyed=0,o.m_system=e,o.m_shape=n,o.m_xf=i,o.m_callDestructionListener=r,o.m_destroyed=0,o}F(e,t);var n=e.prototype;return n.ReportFixture=function(){return!1},n.ReportParticle=function(t,e){return t===this.m_system&&(this.m_shape.TestPoint(this.m_xf,this.m_system.m_positionBuffer.data[e])&&(this.m_system.DestroyParticle(e,this.m_callDestructionListener),this.m_destroyed++),!0)},n.Destroyed=function(){return this.m_destroyed},e}(fr),po=function(t){function e(e){var n;return(n=t.call(this)||this).m_threshold=0,n.m_threshold=e,n}F(e,t);var n=e.prototype;return n.ShouldCreatePair=function(t,e){return t<this.m_threshold&&this.m_threshold<=e||e<this.m_threshold&&this.m_threshold<=t},n.ShouldCreateTriad=function(t,e,n){return(t<this.m_threshold||e<this.m_threshold||n<this.m_threshold)&&(this.m_threshold<=t||this.m_threshold<=e||this.m_threshold<=n)},e}(_o),mo=function(e){function n(n,i){var r;return void 0===i&&(i=n.length),(r=e.call(this,t.b2ShapeType.e_unknown,0)||this).m_shapeCount=0,r.m_shapes=n,r.m_shapeCount=i,r}F(n,e);var r=n.prototype;return r.Clone=function(){throw new Error},r.GetChildCount=function(){return 1},r.TestPoint=function(t,e){for(var n=0;n<this.m_shapeCount;n++)if(this.m_shapes[n].TestPoint(t,e))return!0;return!1},r.ComputeDistance=function(){return 0},r.RayCast=function(){return!1},r.ComputeAABB=function(t,e){var n=new Te;t.lowerBound.x=+i,t.lowerBound.y=+i,t.upperBound.x=-i,t.upperBound.y=-i;for(var r=0;r<this.m_shapeCount;r++)for(var o=this.m_shapes[r].GetChildCount(),a=0;a<o;a++){var s=n;this.m_shapes[r].ComputeAABB(s,e,a),t.Combine1(s)}},r.ComputeMass=function(){},r.SetupDistanceProxy=function(){},r.ComputeSubmergedArea=function(){return 0},r.Dump=function(){},n}(si),vo=function(e){function n(t){var n;return(n=e.call(this)||this).m_flagsBuffer=t,n}return F(n,e),n.prototype.IsNecessary=function(e){return 0!=(this.m_flagsBuffer.data[e]&t.b2ParticleFlag.b2_reactiveParticle)},n}(_o),go=function(e){function n(t,n){var i;return void 0===n&&(n=null),(i=e.call(this,t)||this).m_contactFilter=null,i.m_contactFilter=n,i}F(n,e);var i=n.prototype;return i.ShouldCollideFixtureParticle=function(e,n,i){return!(this.m_contactFilter&&this.m_system.GetFlagsBuffer()[i]&t.b2ParticleFlag.b2_fixtureContactFilterParticle)||this.m_contactFilter.ShouldCollideFixtureParticle(e,this.m_system,i)},i.ReportFixtureAndParticle=function(e,i,r){var o=n.ReportFixtureAndParticle_s_n,a=n.ReportFixtureAndParticle_s_rp,s=this.m_system.m_positionBuffer.data[r],c=o,l=e.ComputeDistance(s,c,i);if(l<this.m_system.m_particleDiameter&&this.ShouldCollideFixtureParticle(e,this.m_system,r)){var u=e.GetBody(),h=u.GetWorldCenter(),_=u.GetMass(),f=u.GetInertia()-_*u.GetLocalCenter().LengthSquared(),p=_>0?1/_:0,d=f>0?1/f:0,m=this.m_system.m_flagsBuffer.data[r]&t.b2ParticleFlag.b2_wallParticle?0:this.m_system.GetParticleInvMass(),v=bt.SubVV(s,h,a),g=bt.CrossVV(v,c),y=m+p+d*g*g,x=this.m_system.m_bodyContactBuffer.data[this.m_system.m_bodyContactBuffer.Append()];x.index=r,x.body=u,x.fixture=e,x.weight=1-l*this.m_system.m_inverseDiameter,x.normal.Copy(c.SelfNeg()),x.mass=y>0?1/y:0,this.m_system.DetectStuckParticle(r)}},n}(Jr);go.ReportFixtureAndParticle_s_n=new bt,go.ReportFixtureAndParticle_s_rp=new bt;var yo=function(e){function n(t,n){var i;return(i=e.call(this,t)||this).m_step=n,i}F(n,e);var i=n.prototype;return i.ReportFixtureAndParticle=function(e,i,r){var o=n.ReportFixtureAndParticle_s_p1,a=n.ReportFixtureAndParticle_s_output,s=n.ReportFixtureAndParticle_s_input,c=n.ReportFixtureAndParticle_s_p,l=n.ReportFixtureAndParticle_s_v,u=n.ReportFixtureAndParticle_s_f,_=e.GetBody(),f=this.m_system.m_positionBuffer.data[r],p=this.m_system.m_velocityBuffer.data[r],d=a,m=s;if(0===this.m_system.m_iterationIndex){var v=Rt.MulTXV(_.m_xf0,f,o);e.GetShape().GetType()===t.b2ShapeType.e_circleShape&&(v.SelfSub(_.GetLocalCenter()),It.MulRV(_.m_xf0.q,v,v),It.MulTRV(_.m_xf.q,v,v),v.SelfAdd(_.GetLocalCenter())),Rt.MulXV(_.m_xf,v,m.p1)}else m.p1.Copy(f);if(bt.AddVMulSV(f,this.m_step.dt,p,m.p2),m.maxFraction=1,e.RayCast(d,m,i)){var g=d.normal,y=c;y.x=(1-d.fraction)*m.p1.x+d.fraction*m.p2.x+h*g.x,y.y=(1-d.fraction)*m.p1.y+d.fraction*m.p2.y+h*g.y;var x=l;x.x=this.m_step.inv_dt*(y.x-f.x),x.y=this.m_step.inv_dt*(y.y-f.y),this.m_system.m_velocityBuffer.data[r].Copy(x);var S=u;S.x=this.m_step.inv_dt*this.m_system.GetParticleMass()*(p.x-x.x),S.y=this.m_step.inv_dt*this.m_system.GetParticleMass()*(p.y-x.y),this.m_system.ParticleApplyForce(r,S)}},i.ReportParticle=function(){return!1},n}(Jr);yo.ReportFixtureAndParticle_s_p1=new bt,yo.ReportFixtureAndParticle_s_output=new be,yo.ReportFixtureAndParticle_s_input=new Ce,yo.ReportFixtureAndParticle_s_p=new bt,yo.ReportFixtureAndParticle_s_v=new bt,yo.ReportFixtureAndParticle_s_f=new bt;var xo=function(){function e(t){this.m_newFixture=!1,this.m_locked=!1,this.m_clearForces=!0,this.m_contactManager=new dr,this.m_bodyList=null,this.m_jointList=null,this.m_particleSystemList=null,this.m_bodyCount=0,this.m_jointCount=0,this.m_gravity=new bt,this.m_allowSleep=!0,this.m_destructionListener=null,this.m_debugDraw=null,this.m_inv_dt0=0,this.m_warmStarting=!0,this.m_continuousPhysics=!0,this.m_subStepping=!1,this.m_stepComplete=!0,this.m_profile=new mr,this.m_island=new Ir,this.s_stack=[],this.m_controllerList=null,this.m_controllerCount=0,this.m_gravity.Copy(t)}var n=e.prototype;return n.SetDestructionListener=function(t){this.m_destructionListener=t},n.SetContactFilter=function(t){this.m_contactManager.m_contactFilter=t},n.SetContactListener=function(t){this.m_contactManager.m_contactListener=t},n.SetDebugDraw=function(t){this.m_debugDraw=t},n.CreateBody=function(t){if(void 0===t&&(t={}),this.IsLocked())throw new Error;var e=new xi(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e},n.DestroyBody=function(t){if(this.IsLocked())throw new Error;for(var e=t.m_jointList;e;){var n=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(n.joint),this.DestroyJoint(n.joint),t.m_jointList=e}t.m_jointList=null;for(var i=t.m_controllerList;i;){var r=i;i=i.nextController,r.controller.RemoveBody(t)}for(var o=t.m_contactList;o;){var a=o;o=o.next,this.m_contactManager.Destroy(a.contact)}t.m_contactList=null;for(var s=t.m_fixtureList;s;){var c=s;s=s.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(c),c.DestroyProxies(),c.Reset(),t.m_fixtureList=s,t.m_fixtureCount-=1}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount},e._Joint_Create=function(e){switch(e.type){case t.b2JointType.e_distanceJoint:return new Ei(e);case t.b2JointType.e_mouseJoint:return new Li(e);case t.b2JointType.e_prismaticJoint:return new zi(e);case t.b2JointType.e_revoluteJoint:return new Hi(e);case t.b2JointType.e_pulleyJoint:return new Ui(e);case t.b2JointType.e_gearJoint:return new Bi(e);case t.b2JointType.e_wheelJoint:return new Ki(e);case t.b2JointType.e_weldJoint:return new Xi(e);case t.b2JointType.e_frictionJoint:return new Ri(e);case t.b2JointType.e_ropeJoint:return new Wi(e);case t.b2JointType.e_motorJoint:return new Oi(e);case t.b2JointType.e_areaJoint:return new Pi(e)}throw new Error},e._Joint_Destroy=function(){},n.CreateJoint=function(t){if(this.IsLocked())throw new Error;var n=e._Joint_Create(t);n.m_prev=null,n.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=n),this.m_jointList=n,++this.m_jointCount,n.m_edgeA.prev=null,n.m_edgeA.next=n.m_bodyA.m_jointList,n.m_bodyA.m_jointList&&(n.m_bodyA.m_jointList.prev=n.m_edgeA),n.m_bodyA.m_jointList=n.m_edgeA,n.m_edgeB.prev=null,n.m_edgeB.next=n.m_bodyB.m_jointList,n.m_bodyB.m_jointList&&(n.m_bodyB.m_jointList.prev=n.m_edgeB),n.m_bodyB.m_jointList=n.m_edgeB;var i=n.m_bodyA,r=n.m_bodyB;if(!n.m_collideConnected)for(var o=r.GetContactList();o;)o.other===i&&o.contact.FlagForFiltering(),o=o.next;return n},n.DestroyJoint=function(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_jointList&&(this.m_jointList=t.m_next);var n=t.m_bodyA,i=t.m_bodyB,r=t.m_collideConnected;if(n.SetAwake(!0),i.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA===n.m_jointList&&(n.m_jointList=t.m_edgeA.next),t.m_edgeA.Reset(),t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB===i.m_jointList&&(i.m_jointList=t.m_edgeB.next),t.m_edgeB.Reset(),e._Joint_Destroy(t),--this.m_jointCount,!r)for(var o=i.GetContactList();o;)o.other===n&&o.contact.FlagForFiltering(),o=o.next},n.CreateParticleSystem=function(t){if(this.IsLocked())throw new Error;var e=new no(t,this);return e.m_prev=null,e.m_next=this.m_particleSystemList,this.m_particleSystemList&&(this.m_particleSystemList.m_prev=e),this.m_particleSystemList=e,e},n.DestroyParticleSystem=function(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_particleSystemList&&(this.m_particleSystemList=t.m_next)},n.CalculateReasonableParticleIterations=function(t){if(null===this.m_particleSystemList)return 1;function e(t){for(var e=i,n=t.GetParticleSystemList();null!==n;n=n.m_next)e=rt(e,n.GetRadius());return e}return Dr(this.m_gravity.Length(),e(this),t)},n.Step=function(t,n,i,r){void 0===r&&(r=this.CalculateReasonableParticleIterations(t));var o=e.Step_s_stepTimer.Reset();this.m_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_newFixture=!1),this.m_locked=!0;var a=e.Step_s_step;a.dt=t,a.velocityIterations=n,a.positionIterations=i,a.particleIterations=r,a.inv_dt=t>0?1/t:0,a.dtRatio=this.m_inv_dt0*t,a.warmStarting=this.m_warmStarting;var s=e.Step_s_timer.Reset();if(this.m_contactManager.Collide(),this.m_profile.collide=s.GetMilliseconds(),this.m_stepComplete&&a.dt>0){for(var c=e.Step_s_timer.Reset(),l=this.m_particleSystemList;l;l=l.m_next)l.Solve(a);this.Solve(a),this.m_profile.solve=c.GetMilliseconds()}if(this.m_continuousPhysics&&a.dt>0){var u=e.Step_s_timer.Reset();this.SolveTOI(a),this.m_profile.solveTOI=u.GetMilliseconds()}a.dt>0&&(this.m_inv_dt0=a.inv_dt),this.m_clearForces&&this.ClearForces(),this.m_locked=!1,this.m_profile.step=o.GetMilliseconds()},n.ClearForces=function(){for(var t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0},n.DrawParticleSystem=function(t){if(null!==this.m_debugDraw){var e=t.GetParticleCount();if(e){var n=t.GetRadius(),i=t.GetPositionBuffer();if(t.m_colorBuffer.data){var r=t.GetColorBuffer();this.m_debugDraw.DrawParticles(i,n,r,e)}else this.m_debugDraw.DrawParticles(i,n,null,e)}}},n.DrawDebugData=function(){if(null!==this.m_debugDraw){var n=this.m_debugDraw.GetFlags(),i=e.DrawDebugData_s_color.SetRGB(0,0,0);if(n&t.b2DrawFlags.e_shapeBit)for(var r=this.m_bodyList;r;r=r.m_next){var o=r.m_xf;this.m_debugDraw.PushTransform(o);for(var a=r.GetFixtureList();a;a=a.m_next)r.IsActive()?r.GetType()===t.b2BodyType.b2_staticBody?(i.SetRGB(.5,.9,.5),this.DrawShape(a,i)):r.GetType()===t.b2BodyType.b2_kinematicBody?(i.SetRGB(.5,.5,.9),this.DrawShape(a,i)):r.IsAwake()?(i.SetRGB(.9,.7,.7),this.DrawShape(a,i)):(i.SetRGB(.6,.6,.6),this.DrawShape(a,i)):(i.SetRGB(.5,.5,.3),this.DrawShape(a,i));this.m_debugDraw.PopTransform(o)}if(n&t.b2DrawFlags.e_particleBit)for(var s=this.m_particleSystemList;s;s=s.m_next)this.DrawParticleSystem(s);if(n&t.b2DrawFlags.e_jointBit)for(var c=this.m_jointList;c;c=c.m_next)this.DrawJoint(c);if(n&t.b2DrawFlags.e_aabbBit){i.SetRGB(.9,.3,.9);for(var l=e.DrawDebugData_s_vs,u=this.m_bodyList;u;u=u.m_next)if(u.IsActive())for(var h=u.GetFixtureList();h;h=h.m_next)for(var _=0;_<h.m_proxyCount;++_){var f=h.m_proxies[_].treeNode.aabb;l[0].Set(f.lowerBound.x,f.lowerBound.y),l[1].Set(f.upperBound.x,f.lowerBound.y),l[2].Set(f.upperBound.x,f.upperBound.y),l[3].Set(f.lowerBound.x,f.upperBound.y),this.m_debugDraw.DrawPolygon(l,4,i)}}if(n&t.b2DrawFlags.e_centerOfMassBit)for(var p=this.m_bodyList;p;p=p.m_next){var d=e.DrawDebugData_s_xf;d.q.Copy(p.m_xf.q),d.p.Copy(p.GetWorldCenter()),this.m_debugDraw.DrawTransform(d)}if(n&t.b2DrawFlags.e_controllerBit)for(var m=this.m_controllerList;m;m=m.m_next)m.Draw(this.m_debugDraw)}},n.QueryAABB=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryAABB(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryAABB(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])},n._QueryAABB=function(t,e,n){if(this.m_contactManager.m_broadPhase.Query(e,(function(e){var i=e.userData.fixture;return t?t.ReportFixture(i):!n||n(i)})),t instanceof fr)for(var i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryAABB(t,e)},n.QueryAllAABB=function(t,e){return void 0===e&&(e=[]),this.QueryAABB(t,(function(t){return e.push(t),!0})),e},n.QueryPointAABB=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryPointAABB(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryPointAABB(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])},n._QueryPointAABB=function(t,e,n){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(function(e){var i=e.userData.fixture;return t?t.ReportFixture(i):!n||n(i)})),t instanceof fr)for(var i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryPointAABB(t,e)},n.QueryAllPointAABB=function(t,e){return void 0===e&&(e=[]),this.QueryPointAABB(t,(function(t){return e.push(t),!0})),e},n.QueryFixtureShape=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryFixtureShape(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3]):this._QueryFixtureShape(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3])},n._QueryFixtureShape=function(t,n,i,r,o){var a=e.QueryFixtureShape_s_aabb;if(n.ComputeAABB(a,r,i),this.m_contactManager.m_broadPhase.Query(a,(function(e){var a=e.userData,s=a.fixture;if(De(n,i,s.GetShape(),a.childIndex,r,s.GetBody().GetTransform())){if(t)return t.ReportFixture(s);if(o)return o(s)}return!0})),t instanceof fr)for(var s=this.m_particleSystemList;s;s=s.m_next)t.ShouldQueryParticleSystem(s)&&s.QueryAABB(t,a)},n.QueryAllFixtureShape=function(t,e,n,i){return void 0===i&&(i=[]),this.QueryFixtureShape(t,e,n,(function(t){return i.push(t),!0})),i},n.QueryFixturePoint=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryFixturePoint(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryFixturePoint(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])},n._QueryFixturePoint=function(t,e,n){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(function(i){var r=i.userData.fixture;if(r.TestPoint(e)){if(t)return t.ReportFixture(r);if(n)return n(r)}return!0})),t)for(var i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryPointAABB(t,e)},n.QueryAllFixturePoint=function(t,e){return void 0===e&&(e=[]),this.QueryFixturePoint(t,(function(t){return e.push(t),!0})),e},n.RayCast=function(){(arguments.length<=0?void 0:arguments[0])instanceof pr?this._RayCast(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2]):this._RayCast(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2])},n._RayCast=function(t,n,i,r){var o=e.RayCast_s_input;if(o.maxFraction=1,o.p1.Copy(n),o.p2.Copy(i),this.m_contactManager.m_broadPhase.RayCast(o,(function(o,a){var s=a.userData,c=s.fixture,l=s.childIndex,u=e.RayCast_s_output;if(c.RayCast(u,o,l)){var h=u.fraction,_=e.RayCast_s_point;if(_.Set((1-h)*n.x+h*i.x,(1-h)*n.y+h*i.y),t)return t.ReportFixture(c,_,u.normal,h);if(r)return r(c,_,u.normal,h)}return o.maxFraction})),t)for(var a=this.m_particleSystemList;a;a=a.m_next)t.ShouldQueryParticleSystem(a)&&a.RayCast(t,n,i)},n.RayCastOne=function(t,e){var n=null,i=1;return this.RayCast(t,e,(function(t,e,r,o){return o<i&&(i=o,n=t),i})),n},n.RayCastAll=function(t,e,n){return void 0===n&&(n=[]),this.RayCast(t,e,(function(t){return n.push(t),1})),n},n.GetBodyList=function(){return this.m_bodyList},n.GetJointList=function(){return this.m_jointList},n.GetParticleSystemList=function(){return this.m_particleSystemList},n.GetContactList=function(){return this.m_contactManager.m_contactList},n.SetAllowSleeping=function(t){if(t!==this.m_allowSleep&&(this.m_allowSleep=t,!this.m_allowSleep))for(var e=this.m_bodyList;e;e=e.m_next)e.SetAwake(!0)},n.GetAllowSleeping=function(){return this.m_allowSleep},n.SetWarmStarting=function(t){this.m_warmStarting=t},n.GetWarmStarting=function(){return this.m_warmStarting},n.SetContinuousPhysics=function(t){this.m_continuousPhysics=t},n.GetContinuousPhysics=function(){return this.m_continuousPhysics},n.SetSubStepping=function(t){this.m_subStepping=t},n.GetSubStepping=function(){return this.m_subStepping},n.GetProxyCount=function(){return this.m_contactManager.m_broadPhase.GetProxyCount()},n.GetBodyCount=function(){return this.m_bodyCount},n.GetJointCount=function(){return this.m_jointCount},n.GetContactCount=function(){return this.m_contactManager.m_contactCount},n.GetTreeHeight=function(){return this.m_contactManager.m_broadPhase.GetTreeHeight()},n.GetTreeBalance=function(){return this.m_contactManager.m_broadPhase.GetTreeBalance()},n.GetTreeQuality=function(){return this.m_contactManager.m_broadPhase.GetTreeQuality()},n.SetGravity=function(t,e){if(void 0===e&&(e=!0),!bt.IsEqualToV(this.m_gravity,t)&&(this.m_gravity.Copy(t),e))for(var n=this.m_bodyList;n;n=n.m_next)n.SetAwake(!0)},n.GetGravity=function(){return this.m_gravity},n.IsLocked=function(){return this.m_locked},n.SetAutoClearForces=function(t){this.m_clearForces=t},n.GetAutoClearForces=function(){return this.m_clearForces},n.ShiftOrigin=function(t){if(this.IsLocked())throw new Error;for(var e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.SelfSub(t),e.m_sweep.c0.SelfSub(t),e.m_sweep.c.SelfSub(t);for(var n=this.m_jointList;n;n=n.m_next)n.ShiftOrigin(t);this.m_contactManager.m_broadPhase.ShiftOrigin(t)},n.GetContactManager=function(){return this.m_contactManager},n.GetProfile=function(){return this.m_profile},n.Dump=function(e){if(!this.m_locked){e("const g: b2Vec2 = new b2Vec2(%.15f, %.15f);\n",this.m_gravity.x,this.m_gravity.y),e("this.m_world.SetGravity(g);\n"),e("const bodies: b2Body[] = [];\n"),e("const joints: b2Joint[] = [];\n");for(var n=0,i=this.m_bodyList;i;i=i.m_next)i.m_islandIndex=n,i.Dump(e),++n;n=0;for(var r=this.m_jointList;r;r=r.m_next)r.m_index=n,++n;for(var o=this.m_jointList;o;o=o.m_next)o.m_type!==t.b2JointType.e_gearJoint&&(e("{\n"),o.Dump(e),e("}\n"));for(var a=this.m_jointList;a;a=a.m_next)a.m_type===t.b2JointType.e_gearJoint&&(e("{\n"),a.Dump(e),e("}\n"))}},n.DrawJoint=function(n){if(null!==this.m_debugDraw){var i=n.GetBodyA(),r=n.GetBodyB(),o=i.m_xf,a=r.m_xf,s=o.p,c=a.p,l=n.GetAnchorA(e.DrawJoint_s_p1),u=n.GetAnchorB(e.DrawJoint_s_p2),h=e.DrawJoint_s_color.SetRGB(.5,.8,.8);switch(n.m_type){case t.b2JointType.e_distanceJoint:this.m_debugDraw.DrawSegment(l,u,h);break;case t.b2JointType.e_pulleyJoint:var _=n,f=_.GetGroundAnchorA(),p=_.GetGroundAnchorB();this.m_debugDraw.DrawSegment(f,l,h),this.m_debugDraw.DrawSegment(p,u,h),this.m_debugDraw.DrawSegment(f,p,h);break;case t.b2JointType.e_mouseJoint:var d=e.DrawJoint_s_c;d.Set(0,1,0),this.m_debugDraw.DrawPoint(l,4,d),this.m_debugDraw.DrawPoint(u,4,d),d.Set(.8,.8,.8),this.m_debugDraw.DrawSegment(l,u,d);break;default:this.m_debugDraw.DrawSegment(s,l,h),this.m_debugDraw.DrawSegment(l,u,h),this.m_debugDraw.DrawSegment(c,u,h)}}},n.DrawShape=function(n,i){if(null!==this.m_debugDraw){var r=n.GetShape();switch(r.m_type){case t.b2ShapeType.e_circleShape:var o=r,a=o.m_p,s=o.m_radius,c=bt.UNITX;this.m_debugDraw.DrawSolidCircle(a,s,c,i);break;case t.b2ShapeType.e_edgeShape:var l=r,u=l.m_vertex1,h=l.m_vertex2;this.m_debugDraw.DrawSegment(u,h,i);break;case t.b2ShapeType.e_chainShape:var _=r,f=_.m_count,p=_.m_vertices,d=e.DrawShape_s_ghostColor.SetRGBA(.75*i.r,.75*i.g,.75*i.b,i.a),m=p[0];if(this.m_debugDraw.DrawPoint(m,4,i),_.m_hasPrevVertex){var v=_.m_prevVertex;this.m_debugDraw.DrawSegment(v,m,d),this.m_debugDraw.DrawCircle(v,.1,d)}for(var g=1;g<f;++g){var y=p[g];this.m_debugDraw.DrawSegment(m,y,i),this.m_debugDraw.DrawPoint(y,4,i),m=y}if(_.m_hasNextVertex){var x=_.m_nextVertex;this.m_debugDraw.DrawSegment(x,m,d),this.m_debugDraw.DrawCircle(x,.1,d)}break;case t.b2ShapeType.e_polygonShape:var S=r,A=S.m_count,C=S.m_vertices;this.m_debugDraw.DrawSolidPolygon(C,A,i)}}},n.Solve=function(e){for(var n=this.m_bodyList;n;n=n.m_next)n.m_xf0.Copy(n.m_xf);for(var i=this.m_controllerList;i;i=i.m_next)i.Step(e);this.m_profile.solveInit=0,this.m_profile.solveVelocity=0,this.m_profile.solvePosition=0;var r=this.m_island;r.Initialize(this.m_bodyCount,this.m_contactManager.m_contactCount,this.m_jointCount,this.m_contactManager.m_contactListener);for(var o=this.m_bodyList;o;o=o.m_next)o.m_islandFlag=!1;for(var a=this.m_contactManager.m_contactList;a;a=a.m_next)a.m_islandFlag=!1;for(var s=this.m_jointList;s;s=s.m_next)s.m_islandFlag=!1;for(var c=this.s_stack,l=this.m_bodyList;l;l=l.m_next)if(!l.m_islandFlag&&l.IsAwake()&&l.IsActive()&&l.GetType()!==t.b2BodyType.b2_staticBody){r.Clear();var u=0;for(c[u++]=l,l.m_islandFlag=!0;u>0;){var h=c[--u];if(!h)throw new Error;if(r.AddBody(h),h.m_awakeFlag=!0,h.GetType()!==t.b2BodyType.b2_staticBody){for(var _=h.m_contactList;_;_=_.next){var f=_.contact;if(!f.m_islandFlag&&f.IsEnabled()&&f.IsTouching()){var p=f.m_fixtureA.m_isSensor,d=f.m_fixtureB.m_isSensor;if(!p&&!d){r.AddContact(f),f.m_islandFlag=!0;var m=_.other;m.m_islandFlag||(c[u++]=m,m.m_islandFlag=!0)}}}for(var v=h.m_jointList;v;v=v.next)if(!v.joint.m_islandFlag){var g=v.other;g.IsActive()&&(r.AddJoint(v.joint),v.joint.m_islandFlag=!0,g.m_islandFlag||(c[u++]=g,g.m_islandFlag=!0))}}}var y=new mr;r.Solve(y,e,this.m_gravity,this.m_allowSleep),this.m_profile.solveInit+=y.solveInit,this.m_profile.solveVelocity+=y.solveVelocity,this.m_profile.solvePosition+=y.solvePosition;for(var x=0;x<r.m_bodyCount;++x){var S=r.m_bodies[x];S.GetType()===t.b2BodyType.b2_staticBody&&(S.m_islandFlag=!1)}}for(var A=0;A<c.length&&c[A];++A)c[A]=null;for(var C=new Nt,b=this.m_bodyList;b;b=b.m_next)b.m_islandFlag&&b.GetType()!==t.b2BodyType.b2_staticBody&&b.SynchronizeFixtures();this.m_contactManager.FindNewContacts(),this.m_profile.broadphase=C.GetMilliseconds()},n.SolveTOI=function(n){var i=this.m_island;if(i.Initialize(2*d,d,0,this.m_contactManager.m_contactListener),this.m_stepComplete){for(var o=this.m_bodyList;o;o=o.m_next)o.m_islandFlag=!1,o.m_sweep.alpha0=0;for(var a=this.m_contactManager.m_contactList;a;a=a.m_next)a.m_toiFlag=!1,a.m_islandFlag=!1,a.m_toiCount=0,a.m_toi=1}for(;;){for(var s=null,c=1,l=this.m_contactManager.m_contactList;l;l=l.m_next)if(l.IsEnabled()&&!(l.m_toiCount>p)){var u=1;if(l.m_toiFlag)u=l.m_toi;else{var h=l.GetFixtureA(),_=l.GetFixtureB();if(h.IsSensor()||_.IsSensor())continue;var f=h.GetBody(),m=_.GetBody(),v=f.m_type,g=m.m_type,y=f.IsAwake()&&v!==t.b2BodyType.b2_staticBody,x=m.IsAwake()&&g!==t.b2BodyType.b2_staticBody;if(!y&&!x)continue;var S=f.IsBullet()||v!==t.b2BodyType.b2_dynamicBody,A=m.IsBullet()||g!==t.b2BodyType.b2_dynamicBody;if(!S&&!A)continue;var C=f.m_sweep.alpha0;f.m_sweep.alpha0<m.m_sweep.alpha0?(C=m.m_sweep.alpha0,f.m_sweep.Advance(C)):m.m_sweep.alpha0<f.m_sweep.alpha0&&(C=f.m_sweep.alpha0,m.m_sweep.Advance(C));var b=l.GetChildIndexA(),T=l.GetChildIndexB(),E=e.SolveTOI_s_toi_input;E.proxyA.SetShape(h.GetShape(),b),E.proxyB.SetShape(_.GetShape(),T),E.sweepA.Copy(f.m_sweep),E.sweepB.Copy(m.m_sweep),E.tMax=1;var w=e.SolveTOI_s_toi_output;un(w,E);var P=w.t;u=w.state===t.b2TOIOutputState.e_touching?rt(C+(1-C)*P,1):1,l.m_toi=u,l.m_toiFlag=!0}u<c&&(s=l,c=u)}if(null===s||1-10*r<c){this.m_stepComplete=!0;break}var I=s.GetFixtureA(),R=s.GetFixtureB(),D=I.GetBody(),B=R.GetBody(),M=e.SolveTOI_s_backup1.Copy(D.m_sweep),O=e.SolveTOI_s_backup2.Copy(B.m_sweep);if(D.Advance(c),B.Advance(c),s.Update(this.m_contactManager.m_contactListener),s.m_toiFlag=!1,++s.m_toiCount,s.IsEnabled()&&s.IsTouching()){D.SetAwake(!0),B.SetAwake(!0),i.Clear(),i.AddBody(D),i.AddBody(B),i.AddContact(s),D.m_islandFlag=!0,B.m_islandFlag=!0,s.m_islandFlag=!0;for(var N=0;N<2;++N){var L=0===N?D:B;if(L.m_type===t.b2BodyType.b2_dynamicBody)for(var F=L.m_contactList;F&&i.m_bodyCount!==i.m_bodyCapacity&&i.m_contactCount!==i.m_contactCapacity;F=F.next){var z=F.contact;if(!z.m_islandFlag){var V=F.other;if(V.m_type!==t.b2BodyType.b2_dynamicBody||L.IsBullet()||V.IsBullet()){var G=z.m_fixtureA.m_isSensor,U=z.m_fixtureB.m_isSensor;if(!G&&!U){var k=e.SolveTOI_s_backup.Copy(V.m_sweep);V.m_islandFlag||V.Advance(c),z.Update(this.m_contactManager.m_contactListener),z.IsEnabled()&&z.IsTouching()?(z.m_islandFlag=!0,i.AddContact(z),V.m_islandFlag||(V.m_islandFlag=!0,V.m_type!==t.b2BodyType.b2_staticBody&&V.SetAwake(!0),i.AddBody(V))):(V.m_sweep.Copy(k),V.SynchronizeTransform())}}}}}var H=e.SolveTOI_s_subStep;H.dt=(1-c)*n.dt,H.inv_dt=1/H.dt,H.dtRatio=1,H.positionIterations=20,H.velocityIterations=n.velocityIterations,H.particleIterations=n.particleIterations,H.warmStarting=!1,i.SolveTOI(H,D.m_islandIndex,B.m_islandIndex);for(var j=0;j<i.m_bodyCount;++j){var W=i.m_bodies[j];if(W.m_islandFlag=!1,W.m_type===t.b2BodyType.b2_dynamicBody){W.SynchronizeFixtures();for(var q=W.m_contactList;q;q=q.next)q.contact.m_toiFlag=!1,q.contact.m_islandFlag=!1}}if(this.m_contactManager.FindNewContacts(),this.m_subStepping){this.m_stepComplete=!1;break}}else s.SetEnabled(!1),D.m_sweep.Copy(M),B.m_sweep.Copy(O),D.SynchronizeTransform(),B.SynchronizeTransform()}},n.AddController=function(t){return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=t),this.m_controllerList=t,++this.m_controllerCount,t},n.RemoveController=function(t){return t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),this.m_controllerList===t&&(this.m_controllerList=t.m_next),--this.m_controllerCount,t.m_prev=null,t.m_next=null,t},e}();xo.Step_s_step=new vr,xo.Step_s_stepTimer=new Nt,xo.Step_s_timer=new Nt,xo.DrawDebugData_s_color=new Mt(0,0,0),xo.DrawDebugData_s_vs=bt.MakeArray(4),xo.DrawDebugData_s_xf=new Rt,xo.QueryFixtureShape_s_aabb=new Te,xo.RayCast_s_input=new Ce,xo.RayCast_s_output=new be,xo.RayCast_s_point=new bt,xo.DrawJoint_s_p1=new bt,xo.DrawJoint_s_p2=new bt,xo.DrawJoint_s_color=new Mt(.5,.8,.8),xo.DrawJoint_s_c=new Mt,xo.DrawShape_s_ghostColor=new Mt,xo.SolveTOI_s_subStep=new vr,xo.SolveTOI_s_backup=new Bt,xo.SolveTOI_s_backup1=new Bt,xo.SolveTOI_s_backup2=new Bt,xo.SolveTOI_s_toi_input=new Je,xo.SolveTOI_s_toi_output=new Ze;var So=function(t,e){this.prevBody=null,this.nextBody=null,this.prevController=null,this.nextController=null,this.controller=t,this.body=e},Ao=function(){function t(){this.m_bodyList=null,this.m_bodyCount=0,this.m_prev=null,this.m_next=null}var e=t.prototype;return e.GetNext=function(){return this.m_next},e.GetPrev=function(){return this.m_prev},e.GetBodyList=function(){return this.m_bodyList},e.AddBody=function(t){var e=new So(this,t);e.nextBody=this.m_bodyList,e.prevBody=null,this.m_bodyList&&(this.m_bodyList.prevBody=e),this.m_bodyList=e,++this.m_bodyCount,e.nextController=t.m_controllerList,e.prevController=null,t.m_controllerList&&(t.m_controllerList.prevController=e),t.m_controllerList=e,++t.m_controllerCount},e.RemoveBody=function(t){if(this.m_bodyCount<=0)throw new Error;for(var e=this.m_bodyList;e&&e.body!==t;)e=e.nextBody;if(null===e)throw new Error;e.prevBody&&(e.prevBody.nextBody=e.nextBody),e.nextBody&&(e.nextBody.prevBody=e.prevBody),this.m_bodyList===e&&(this.m_bodyList=e.nextBody),--this.m_bodyCount,e.nextController&&(e.nextController.prevController=e.prevController),e.prevController&&(e.prevController.nextController=e.nextController),t.m_controllerList===e&&(t.m_controllerList=e.nextController),--t.m_controllerCount},e.Clear=function(){for(;this.m_bodyList;)this.RemoveBody(this.m_bodyList.body);this.m_bodyCount=0},t}(),Co=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).normal=new bt(0,1),e.offset=0,e.density=0,e.velocity=new bt(0,0),e.linearDrag=0,e.angularDrag=0,e.useDensity=!1,e.useWorldGravity=!0,e.gravity=new bt(0,0),e}F(e,t);var n=e.prototype;return n.Step=function(){if(this.m_bodyList){this.useWorldGravity&&this.gravity.Copy(this.m_bodyList.body.GetWorld().GetGravity());for(var t=this.m_bodyList;t;t=t.nextBody){var e=t.body;if(e.IsAwake()){for(var n=new bt,i=new bt,o=0,a=0,s=e.GetFixtureList();s;s=s.m_next){var c=new bt,l=s.GetShape().ComputeSubmergedArea(this.normal,this.offset,e.GetTransform(),c);o+=l,n.x+=l*c.x,n.y+=l*c.y;var u=0;a+=l*(u=this.useDensity?s.GetDensity():1),i.x+=l*c.x*u,i.y+=l*c.y*u}if(n.x/=o,n.y/=o,i.x/=a,i.y/=a,!(o<r)){var h=this.gravity.Clone().SelfNeg();h.SelfMul(this.density*o),e.ApplyForce(h,i);var _=e.GetLinearVelocityFromWorldPoint(n,new bt);_.SelfSub(this.velocity),_.SelfMul(-this.linearDrag*o),e.ApplyForce(_,n),e.ApplyTorque(-e.GetInertia()/e.GetMass()*o*e.GetAngularVelocity()*this.angularDrag)}}}}},n.Draw=function(t){var e=100,n=new bt,i=new bt;n.x=this.normal.x*this.offset+this.normal.y*e,n.y=this.normal.y*this.offset-this.normal.x*e,i.x=this.normal.x*this.offset-this.normal.y*e,i.y=this.normal.y*this.offset+this.normal.x*e;var r=new Mt(0,0,.8);t.DrawSegment(n,i,r)},e}(Ao),bo=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).A=new bt(0,0),e}F(e,t);var n=e.prototype;return n.Step=function(t){for(var n=bt.MulSV(t.dt,this.A,e.Step_s_dtA),i=this.m_bodyList;i;i=i.nextBody){var r=i.body;r.IsAwake()&&r.SetLinearVelocity(bt.AddVV(r.GetLinearVelocity(),n,bt.s_t0))}},n.Draw=function(){},e}(Ao);bo.Step_s_dtA=new bt;var To=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).F=new bt(0,0),e}F(e,t);var n=e.prototype;return n.Step=function(){for(var t=this.m_bodyList;t;t=t.nextBody){var e=t.body;e.IsAwake()&&e.ApplyForce(this.F,e.GetWorldCenter())}},n.Draw=function(){},e}(Ao),Eo=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).G=1,e.invSqr=!0,e}F(e,t);var n=e.prototype;return n.Step=function(){if(this.invSqr)for(var t=this.m_bodyList;t;t=t.nextBody)for(var n=t.body,i=n.GetWorldCenter(),o=n.GetMass(),a=this.m_bodyList;a&&a!==t;a=a.nextBody){var s=a.body,c=s.GetWorldCenter(),l=s.GetMass(),u=c.x-i.x,h=c.y-i.y,_=u*u+h*h;if(!(_<r)){var f=e.Step_s_f.Set(u,h);f.SelfMul(this.G/_/ht(_)*o*l),n.IsAwake()&&n.ApplyForce(f,i),s.IsAwake()&&s.ApplyForce(f.SelfMul(-1),c)}}else for(var p=this.m_bodyList;p;p=p.nextBody)for(var d=p.body,m=d.GetWorldCenter(),v=d.GetMass(),g=this.m_bodyList;g&&g!==p;g=g.nextBody){var y=g.body,x=y.GetWorldCenter(),S=y.GetMass(),A=x.x-m.x,C=x.y-m.y,b=A*A+C*C;if(!(b<r)){var T=e.Step_s_f.Set(A,C);T.SelfMul(this.G/b*v*S),d.IsAwake()&&d.ApplyForce(T,m),y.IsAwake()&&y.ApplyForce(T.SelfMul(-1),x)}}},n.Draw=function(){},e}(Ao);Eo.Step_s_f=new bt;var wo=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).T=new wt,e.maxTimestep=0,e}F(e,t);var n=e.prototype;return n.Step=function(t){var n=t.dt;if(!(n<=r)){n>this.maxTimestep&&this.maxTimestep>0&&(n=this.maxTimestep);for(var i=this.m_bodyList;i;i=i.nextBody){var o=i.body;if(o.IsAwake()){var a=o.GetWorldVector(wt.MulMV(this.T,o.GetLocalVector(o.GetLinearVelocity(),bt.s_t0),bt.s_t1),e.Step_s_damping);o.SetLinearVelocity(bt.AddVV(o.GetLinearVelocity(),bt.MulSV(n,a,bt.s_t0),bt.s_t1))}}}},n.Draw=function(){},n.SetAxisAligned=function(t,e){this.T.ex.x=-t,this.T.ex.y=0,this.T.ey.x=0,this.T.ey.y=-e,this.maxTimestep=t>0||e>0?1/ot(t,e):0},e}(Ao);wo.Step_s_damping=new bt;var Po=function(){this.vertices=[],this.count=0,this.masses=[],this.gravity=new bt(0,0),this.damping=.1,this.k2=.9,this.k3=.1},Io=function(){function t(){this.m_count=0,this.m_ps=[],this.m_p0s=[],this.m_vs=[],this.m_ims=[],this.m_Ls=[],this.m_as=[],this.m_gravity=new bt,this.m_damping=0,this.m_k2=1,this.m_k3=.1}var e=t.prototype;return e.GetVertexCount=function(){return this.m_count},e.GetVertices=function(){return this.m_ps},e.Initialize=function(t){this.m_count=t.count,this.m_ps=bt.MakeArray(this.m_count),this.m_p0s=bt.MakeArray(this.m_count),this.m_vs=bt.MakeArray(this.m_count),this.m_ims=$(this.m_count);for(var e=0;e<this.m_count;++e){this.m_ps[e].Copy(t.vertices[e]),this.m_p0s[e].Copy(t.vertices[e]),this.m_vs[e].SetZero();var n=t.masses[e];this.m_ims[e]=n>0?1/n:0}var i=this.m_count-1,r=this.m_count-2;this.m_Ls=$(i),this.m_as=$(r);for(var o=0;o<i;++o){var a=this.m_ps[o],s=this.m_ps[o+1];this.m_Ls[o]=bt.DistanceVV(a,s)}for(var c=0;c<r;++c){var l=this.m_ps[c],u=this.m_ps[c+1],h=this.m_ps[c+2],_=bt.SubVV(u,l,bt.s_t0),f=bt.SubVV(h,u,bt.s_t1),p=bt.CrossVV(_,f),d=bt.DotVV(_,f);this.m_as[c]=yt(p,d)}this.m_gravity.Copy(t.gravity),this.m_damping=t.damping,this.m_k2=t.k2,this.m_k3=t.k3},e.Step=function(t,e){if(0!==t){for(var n=Math.exp(-t*this.m_damping),i=0;i<this.m_count;++i)this.m_p0s[i].Copy(this.m_ps[i]),this.m_ims[i]>0&&this.m_vs[i].SelfMulAdd(t,this.m_gravity),this.m_vs[i].SelfMul(n),this.m_ps[i].SelfMulAdd(t,this.m_vs[i]);for(var r=0;r<e;++r)this.SolveC2(),this.SolveC3(),this.SolveC2();for(var o=1/t,a=0;a<this.m_count;++a)bt.MulSV(o,bt.SubVV(this.m_ps[a],this.m_p0s[a],bt.s_t0),this.m_vs[a])}},e.SolveC2=function(){for(var e=this.m_count-1,n=0;n<e;++n){var i=this.m_ps[n],r=this.m_ps[n+1],o=bt.SubVV(r,i,t.s_d),a=o.Normalize(),s=this.m_ims[n],c=this.m_ims[n+1];if(s+c!==0){var l=s/(s+c),u=c/(s+c);i.SelfMulSub(this.m_k2*l*(this.m_Ls[n]-a),o),r.SelfMulAdd(this.m_k2*u*(this.m_Ls[n]-a),o)}}},e.SetAngle=function(t){for(var e=this.m_count-2,n=0;n<e;++n)this.m_as[n]=t},e.SolveC3=function(){for(var e=this.m_count-2,n=0;n<e;++n){var i=this.m_ps[n],r=this.m_ps[n+1],o=this.m_ps[n+2],s=this.m_ims[n],c=this.m_ims[n+1],l=this.m_ims[n+2],u=bt.SubVV(r,i,t.s_d1),h=bt.SubVV(o,r,t.s_d2),_=u.LengthSquared(),f=h.LengthSquared();if(_*f!=0){var p=bt.CrossVV(u,h),d=bt.DotVV(u,h),m=yt(p,d),v=bt.MulSV(-1/_,u.SelfSkew(),t.s_Jd1),g=bt.MulSV(1/f,h.SelfSkew(),t.s_Jd2),y=bt.NegV(v,t.s_J1),x=bt.SubVV(v,g,t.s_J2),S=g,A=s*bt.DotVV(y,y)+c*bt.DotVV(x,x)+l*bt.DotVV(S,S);if(0!==A){A=1/A;for(var C=m-this.m_as[n];C>a;)C=(m-=2*a)-this.m_as[n];for(;C<-a;)C=(m+=2*a)-this.m_as[n];var b=-this.m_k3*A*C;i.SelfMulAdd(s*b,y),r.SelfMulAdd(c*b,x),o.SelfMulAdd(l*b,S)}}}},e.Draw=function(t){for(var e=new Mt(.4,.5,.7),n=0;n<this.m_count-1;++n)t.DrawSegment(this.m_ps[n],this.m_ps[n+1],e)},t}();Io.s_d=new bt,Io.s_d1=new bt,Io.s_d2=new bt,Io.s_Jd1=new bt,Io.s_Jd2=new bt,Io.s_J1=new bt,Io.s_J2=new bt,t.b2AABB=Te,t.b2Abs=it,t.b2Acos=vt,t.b2Alloc=G,t.b2AreaJoint=Pi,t.b2AreaJointDef=wi,t.b2Asin=gt,t.b2Assert=e,t.b2Atan2=yt,t.b2BlockAllocator=zt,t.b2Body=xi,t.b2BodyDef=yi,t.b2BroadPhase=Ve,t.b2BuoyancyController=Co,t.b2CalculateParticleIterations=Dr,t.b2ChainAndCircleContact=or,t.b2ChainAndPolygonContact=ar,t.b2ChainShape=hi,t.b2CircleContact=tr,t.b2CircleShape=ci,t.b2Clamp=at,t.b2ClipSegmentToLine=we,t.b2ClipVertex=Ae,t.b2CollideCircles=fn,t.b2CollideEdgeAndCircle=Qn,t.b2CollideEdgeAndPolygon=ri,t.b2CollidePolygonAndCircle=vn,t.b2CollidePolygons=Un,t.b2Color=Mt,t.b2ConstantAccelController=bo,t.b2ConstantForceController=To,t.b2Contact=$i,t.b2ContactEdge=Zi,t.b2ContactFactory=cr,t.b2ContactFeature=de,t.b2ContactFilter=ur,t.b2ContactID=me,t.b2ContactImpulse=hr,t.b2ContactListener=_r,t.b2ContactManager=dr,t.b2ContactPositionConstraint=br,t.b2ContactRegister=sr,t.b2ContactSolver=wr,t.b2ContactSolverDef=Tr,t.b2ContactVelocityConstraint=Cr,t.b2Controller=Ao,t.b2ControllerEdge=So,t.b2Cos=dt,t.b2Counter=Lt,t.b2DegToRad=ft,t.b2DestructionListener=lr,t.b2Distance=ie,t.b2DistanceInput=kt,t.b2DistanceJoint=Ei,t.b2DistanceJointDef=Ti,t.b2DistanceOutput=Ht,t.b2DistanceProxy=Gt,t.b2Draw=Ot,t.b2DynamicTree=Oe,t.b2EdgeAndCircleContact=ir,t.b2EdgeAndPolygonContact=rr,t.b2EdgeShape=ui,t.b2Filter=_i,t.b2Fixture=mi,t.b2FixtureDef=fi,t.b2FixtureParticleQueryCallback=Jr,t.b2FixtureProxy=pi,t.b2Free=k,t.b2FrictionJoint=Ri,t.b2FrictionJointDef=Ii,t.b2GearJoint=Bi,t.b2GearJointDef=Di,t.b2GetPointStates=Se,t.b2GravityController=Eo,t.b2GrowableBuffer=Kr,t.b2GrowableStack=Ft,t.b2InvSqrt=ut,t.b2IsPowerOfTwo=St,t.b2IsValid=ct,t.b2Island=Ir,t.b2Jacobian=Si,t.b2Joint=bi,t.b2JointDef=Ci,t.b2JointEdge=Ai,t.b2Log=H,t.b2MakeArray=Q,t.b2MakeNullArray=Z,t.b2MakeNumberArray=$,t.b2Manifold=ye,t.b2ManifoldPoint=ve,t.b2MassData=ai,t.b2Mat22=wt,t.b2Mat33=Pt,t.b2Max=ot,t.b2Maybe=n,t.b2Min=rt,t.b2MixFriction=Ji,t.b2MixRestitution=Qi,t.b2MotorJoint=Oi,t.b2MotorJointDef=Mi,t.b2MouseJoint=Li,t.b2MouseJointDef=Ni,t.b2NextPowerOfTwo=xt,t.b2Pair=ze,t.b2PairLessThan=Ge,t.b2ParseInt=K,t.b2ParseUInt=J,t.b2ParticleBodyContact=Zr,t.b2ParticleContact=Qr,t.b2ParticleDef=Rr,t.b2ParticleGroup=Nr,t.b2ParticleGroupDef=Or,t.b2ParticleHandle=Mr,t.b2ParticlePair=$r,t.b2ParticlePairSet=ho,t.b2ParticleSystem=no,t.b2ParticleSystemDef=eo,t.b2ParticleSystem_CompositeShape=mo,t.b2ParticleSystem_ConnectionFilter=_o,t.b2ParticleSystem_DestroyParticlesInShapeCallback=fo,t.b2ParticleSystem_FixedSetAllocator=so,t.b2ParticleSystem_FixtureParticle=co,t.b2ParticleSystem_FixtureParticleSet=lo,t.b2ParticleSystem_InsideBoundsEnumerator=oo,t.b2ParticleSystem_JoinParticleGroupsFilter=po,t.b2ParticleSystem_ParticleListNode=ao,t.b2ParticleSystem_ParticlePair=uo,t.b2ParticleSystem_Proxy=ro,t.b2ParticleSystem_ReactiveFilter=vo,t.b2ParticleSystem_SolveCollisionCallback=yo,t.b2ParticleSystem_UpdateBodyContactsCallback=go,t.b2ParticleSystem_UserOverridableBuffer=io,t.b2ParticleTriad=to,t.b2PolygonAndCircleContact=nr,t.b2PolygonContact=er,t.b2PolygonShape=li,t.b2Position=gr,t.b2PositionSolverManifold=Er,t.b2Pow=_t,t.b2PrismaticJoint=zi,t.b2PrismaticJointDef=Fi,t.b2Profile=mr,t.b2PulleyJoint=Ui,t.b2PulleyJointDef=Gi,t.b2QueryCallback=fr,t.b2RadToDeg=pt,t.b2Random=At,t.b2RandomRange=Ct,t.b2RayCastCallback=pr,t.b2RayCastInput=Ce,t.b2RayCastOutput=be,t.b2RevoluteJoint=Hi,t.b2RevoluteJointDef=ki,t.b2Rope=Io,t.b2RopeDef=Po,t.b2RopeJoint=Wi,t.b2RopeJointDef=ji,t.b2Rot=It,t.b2SeparationFunction=$e,t.b2Shape=si,t.b2ShapeCast=fe,t.b2ShapeCastInput=jt,t.b2ShapeCastOutput=Wt,t.b2Simplex=Yt,t.b2SimplexCache=Ut,t.b2SimplexVertex=Xt,t.b2Sin=mt,t.b2SolverData=xr,t.b2Sq=lt,t.b2Sqrt=ht,t.b2StackAllocator=Vt,t.b2Swap=st,t.b2Sweep=Bt,t.b2TOIInput=Je,t.b2TOIOutput=Ze,t.b2TensorDampingController=wo,t.b2TestOverlapAABB=Ee,t.b2TestOverlapShape=De,t.b2TimeOfImpact=un,t.b2TimeStep=vr,t.b2Timer=Nt,t.b2Transform=Rt,t.b2TreeNode=Me,t.b2Vec2=bt,t.b2Vec2_zero=Tt,t.b2Vec3=Et,t.b2Velocity=yr,t.b2VelocityConstraintPoint=Ar,t.b2Version=j,t.b2WeldJoint=Xi,t.b2WeldJointDef=qi,t.b2WheelJoint=Ki,t.b2WheelJointDef=Yi,t.b2World=xo,t.b2WorldManifold=xe,t.b2_180_over_pi=et,t.b2_aabbExtension=l,t.b2_aabbMultiplier=u,t.b2_angularSleepTolerance=V,t.b2_angularSlop=_,t.b2_barrierCollisionTime=O,t.b2_baumgarte=C,t.b2_branch=X,t.b2_commit=Y,t.b2_epsilon=r,t.b2_epsilon_sq=o,t.b2_gjk_reset=qt,t.b2_invalidParticleIndex=T,t.b2_linearSleepTolerance=z,t.b2_linearSlop=h,t.b2_maxAngularCorrection=g,t.b2_maxFloat=i,t.b2_maxLinearCorrection=v,t.b2_maxManifoldPoints=s,t.b2_maxParticleForce=R,t.b2_maxParticleIndex=E,t.b2_maxParticlePressure=I,t.b2_maxPolygonVertices=c,t.b2_maxRotation=S,t.b2_maxRotationSquared=A,t.b2_maxSubSteps=p,t.b2_maxTOIContacts=d,t.b2_maxTranslation=y,t.b2_maxTranslationSquared=x,t.b2_maxTriadDistance=D,t.b2_maxTriadDistanceSquared=B,t.b2_minParticleSystemBufferCapacity=M,t.b2_minParticleWeight=P,t.b2_minPulleyLength=Vi,t.b2_particleStride=w,t.b2_pi=a,t.b2_pi_over_180=tt,t.b2_polygonRadius=f,t.b2_timeToSleep=L,t.b2_toiBaumgarte=b,t.b2_toi_reset=Ue,t.b2_two_pi=nt,t.b2_velocityThreshold=m,t.b2_version=q,t.g_blockSolve=Sr,Object.defineProperty(t,"__esModule",{value:!0})}(e)}(e={exports:{}},e.exports),e.exports}();(ort=art)&&ort.__esModule&&Object.prototype.hasOwnProperty.call(ort,"default")&&ort.default;var srt={};for(var crt in art)-1===crt.indexOf("b2_")&&(srt[crt.replace("b2","")]=art[crt]);var lrt,urt,hrt,_rt,frt,prt=srt;!function(t){t[t.Static=0]="Static",t[t.Kinematic=1]="Kinematic",t[t.Dynamic=2]="Dynamic",t[t.Animated=3]="Animated"}(lrt||(lrt=t("ERigidBody2DType",{}))),Jt(lrt),function(t){t[t.None=0]="None",t[t.BOX=1]="BOX",t[t.CIRCLE=2]="CIRCLE",t[t.POLYGON=3]="POLYGON"}(urt||(urt=t("ECollider2DType",{}))),Jt(urt),function(t){t[t.None=0]="None",t[t.DISTANCE=1]="DISTANCE",t[t.SPRING=2]="SPRING",t[t.WHEEL=3]="WHEEL",t[t.MOUSE=4]="MOUSE",t[t.FIXED=5]="FIXED",t[t.SLIDER=6]="SLIDER",t[t.RELATIVE=7]="RELATIVE",t[t.HINGE=8]="HINGE"}(hrt||(hrt=t("EJoint2DType",{}))),Jt(hrt),function(t){t[t.DEFAULT=1]="DEFAULT"}(_rt||(_rt=t("PhysicsGroup",{}))),Jt(_rt),function(t){t[t.Closest=0]="Closest",t[t.Any=1]="Any",t[t.AllClosest=2]="AllClosest",t[t.All=3]="All"}(frt||(frt=t("ERaycast2DType",{})));var drt,mrt=t("Contact2DType",{None:"none-contact",BEGIN_CONTACT:"begin-contact",END_CONTACT:"end-contact",PRE_SOLVE:"pre-solve",POST_SOLVE:"post-solve"});!function(t){t[t.None=0]="None",t[t.Shape=1]="Shape",t[t.Joint=2]="Joint",t[t.Aabb=4]="Aabb",t[t.Pair=8]="Pair",t[t.CenterOfMass=16]="CenterOfMass",t[t.Particle=32]="Particle",t[t.Controller=64]="Controller",t[t.All=63]="All"}(drt||(drt=t("EPhysics2DDrawFlags",{})));var vrt=t("PHYSICS_2D_PTM_RATIO",32),grt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._contactFixtures=[],e._BeginContact=null,e._EndContact=null,e._PreSolve=null,e._PostSolve=null,e}F(e,t);var n=e.prototype;return n.setBeginContact=function(t){this._BeginContact=t},n.setEndContact=function(t){this._EndContact=t},n.setPreSolve=function(t){this._PreSolve=t},n.setPostSolve=function(t){this._PostSolve=t},n.BeginContact=function(t){if(this._BeginContact){var e=t.GetFixtureA(),n=t.GetFixtureB(),i=this._contactFixtures;t._shouldReport=!1,-1===i.indexOf(e)&&-1===i.indexOf(n)||(t._shouldReport=!0,this._BeginContact(t))}},n.EndContact=function(t){this._EndContact&&t._shouldReport&&(t._shouldReport=!1,this._EndContact(t))},n.PreSolve=function(t,e){this._PreSolve&&t._shouldReport&&this._PreSolve(t,e)},n.PostSolve=function(t,e){this._PostSolve&&t._shouldReport&&this._PostSolve(t,e)},n.registerContactFixture=function(t){this._contactFixtures.push(t)},n.unregisterContactFixture=function(t){Q(this._contactFixtures,t)},e}(prt.ContactListener),yrt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._point=new prt.Vec2,e._isPoint=!1,e._fixtures=[],e}F(e,t);var n=e.prototype;return n.init=function(t){t?(this._isPoint=!0,this._point.x=t.x,this._point.y=t.y):this._isPoint=!1,this._fixtures.length=0},n.ReportFixture=function(t){return this._isPoint?t.TestPoint(this._point)&&this._fixtures.push(t):this._fixtures.push(t),!0},n.getFixture=function(){return this._fixtures[0]},n.getFixtures=function(){return this._fixtures},e}(prt.QueryCallback);function xrt(t,e){var n=e.length;return e[t<0?n- -t%n:t%n]}function Srt(t,e,n){for(var i=[];e<t;)e+=n.length;for(;t<=e;++t)i.push(xrt(t,n));return i}function Art(t){Rrt(t);for(var e,n,i,r,o,a,s=[],c=new li,l=new li,u=0,h=0,_=0;_<t.length;++_)if(brt(_,t)){n=i=1e8;for(var f=0;f<t.length;++f)Ert(xrt(_-1,t),xrt(_,t),xrt(f,t))&&Prt(xrt(_-1,t),xrt(_,t),xrt(f-1,t))&&(r=Brt(xrt(_-1,t),xrt(_,t),xrt(f,t),xrt(f-1,t)),Trt(xrt(_+1,t),xrt(_,t),r)&&(e=Irt(xrt(_,t),r))<n&&(n=e,c=r,u=f)),Ert(xrt(_+1,t),xrt(_,t),xrt(f+1,t))&&Prt(xrt(_+1,t),xrt(_,t),xrt(f,t))&&(r=Brt(xrt(_+1,t),xrt(_,t),xrt(f,t),xrt(f+1,t)),Ert(xrt(_-1,t),xrt(_,t),r)&&(e=Irt(xrt(_,t),r))<i&&(i=e,h=f,l=r));if(u==(h+1)%t.length){var p=c.add(l).multiplyScalar(.5);(o=Srt(_,h,t)).push(p),(a=Srt(u,_,t)).push(p)}else{for(var d=0,m=u;h<u;)h+=t.length;for(var v=u;v<=h;++v)if(Crt(_,v,t)){var g=1/(Irt(xrt(_,t),xrt(v,t))+1);brt(v,t)?Prt(xrt(v-1,t),xrt(v,t),xrt(_,t))&&wrt(xrt(v+1,t),xrt(v,t),xrt(_,t))?g+=3:g+=2:g+=1,g>d&&(m=v,d=g)}o=Srt(_,m,t),a=Srt(m,_,t)}return(s=s.concat(Art(o))).concat(Art(a))}s.push(t);for(var y=s.length-1;y>=0;y--)0==s[y].length&&s.splice(y,0);return s}function Crt(t,e,n){if(brt(t,n)){if(wrt(xrt(t,n),xrt(t-1,n),xrt(e,n))&&Prt(xrt(t,n),xrt(t+1,n),xrt(e,n)))return!1}else if(Prt(xrt(t,n),xrt(t+1,n),xrt(e,n))||wrt(xrt(t,n),xrt(t-1,n),xrt(e,n)))return!1;if(brt(e,n)){if(wrt(xrt(e,n),xrt(e-1,n),xrt(t,n))&&Prt(xrt(e,n),xrt(e+1,n),xrt(t,n)))return!1}else if(Prt(xrt(e,n),xrt(e+1,n),xrt(t,n))||wrt(xrt(e,n),xrt(e-1,n),xrt(t,n)))return!1;for(var i=0;i<n.length;++i)if((i+1)%n.length!=t&&i!=t&&(i+1)%n.length!=e&&i!=e){var r=new li;if(Mrt(xrt(t,n),xrt(e,n),xrt(i,n),xrt(i+1,n),r))return!1}return!0}function brt(t,e){return Trt(t,e)}function Trt(t,e,n){if(void 0===n){var i=t,r=e;t=xrt(i-1,r),e=xrt(i,r),n=xrt(i+1,r)}return Ort(t,e,n)<0}function Ert(t,e,n){return Ort(t,e,n)>0}function wrt(t,e,n){return Ort(t,e,n)>=0}function Prt(t,e,n){return Ort(t,e,n)<=0}function Irt(t,e){var n=e.x-t.x,i=e.y-t.y;return n*n+i*i}function Rrt(t){Drt(t)||t.reverse()}function Drt(t){return t.length<3||function(t){var e,n=0;for(e=0;e<t.length;e++){var i=(e+1)%t.length;n+=t[e].x*t[i].y,n-=t[e].y*t[i].x}return n/2}(t)>0}function Brt(t,e,n,i){var r,o=new li,a=e.y-t.y,s=t.x-e.x,c=a*t.x+s*t.y,l=i.y-n.y,u=n.x-i.x,h=l*n.x+u*n.y,_=a*u-l*s;return r=_,0,Math.abs(r-0)<=1e-6||(o.x=(u*c-s*h)/_,o.y=(a*h-l*c)/_),o}function Mrt(t,e,n,i,r){if(t==n||t==i||e==n||e==i)return!1;var o=t.x,a=t.y,s=e.x,c=e.y,l=n.x,u=n.y,h=i.x,_=i.y;if(Math.max(o,s)<Math.min(l,h)||Math.max(l,h)<Math.min(o,s))return!1;if(Math.max(a,c)<Math.min(u,_)||Math.max(u,_)<Math.min(a,c))return!1;var f=(h-l)*(a-u)-(_-u)*(o-l),p=(s-o)*(a-u)-(c-a)*(o-l),d=(_-u)*(s-o)-(h-l)*(c-a);return!(Math.abs(d)<1e-6)&&(p/=d,(f/=d)>0&&f<1&&p>0&&p<1&&(r.x=o+f*(s-o),r.y=a+f*(c-a),!0))}function Ort(t,e,n){return t.x*(e.y-n.y)+e.x*(n.y-t.y)+n.x*(t.y-e.y)}var Nrt=Object.freeze({__proto__:null,ConvexPartition:Art,ForceCounterClockWise:Rrt,IsCounterClockWise:Drt}),Lrt=function(){return 0},Frt={impl:null,rigidBody:null,isAwake:!1,isSleeping:!1,initialize:Lrt,setType:Lrt,setLinearDamping:Lrt,setAngularDamping:Lrt,setGravityScale:Lrt,setFixedRotation:Lrt,setAllowSleep:Lrt,isActive:Lrt,setActive:Lrt,wakeUp:Lrt,sleep:Lrt,getMass:Lrt,getInertia:Lrt,getLinearVelocity:Lrt,setLinearVelocity:Lrt,getLinearVelocityFromWorldPoint:Lrt,getAngularVelocity:Lrt,setAngularVelocity:Lrt,getLocalVector:Lrt,getWorldVector:Lrt,getLocalPoint:Lrt,getWorldPoint:Lrt,getLocalCenter:Lrt,getWorldCenter:Lrt,applyForce:Lrt,applyForceToCenter:Lrt,applyTorque:Lrt,applyLinearImpulse:Lrt,applyLinearImpulseToCenter:Lrt,applyAngularImpulse:Lrt,onEnable:Lrt,onDisable:Lrt,onDestroy:Lrt},zrt={INITED:!1};var Vrt,Grt,Urt,krt,Hrt,jrt,Wrt={INITED:!1},qrt={impl:null,initialize:Lrt,setDampingRatio:Lrt,setFrequency:Lrt,setMaxForce:Lrt,setTarget:Lrt,setDistance:Lrt,setAngularOffset:Lrt,setCorrectionFactor:Lrt,setLinearOffset:Lrt,setMaxLength:Lrt,setMaxTorque:Lrt,setLowerLimit:Lrt,setUpperLimit:Lrt,setMaxMotorForce:Lrt,setMaxMotorTorque:Lrt,setMotorSpeed:Lrt,enableLimit:Lrt,enableMotor:Lrt,setLowerAngle:Lrt,setUpperAngle:Lrt};!function(t){t[t.DYNAMIC=1]="DYNAMIC",t[t.STATIC=2]="STATIC",t[t.KINEMATIC=4]="KINEMATIC"}(Vrt||(Vrt={})),Jt(Vrt),function(t){t[t.X_AXIS=0]="X_AXIS",t[t.Y_AXIS=1]="Y_AXIS",t[t.Z_AXIS=2]="Z_AXIS"}(Grt||(Grt={})),Jt(Grt),function(t){t[t.VERTEX=1]="VERTEX",t[t.LINE=2]="LINE",t[t.TRIANGLE=3]="TRIANGLE",t[t.TETRAHEDRON=4]="TETRAHEDRON"}(Urt||(Urt={})),Jt(Urt),function(t){t[t.BOX=0]="BOX",t[t.SPHERE=1]="SPHERE",t[t.CAPSULE=2]="CAPSULE",t[t.CYLINDER=3]="CYLINDER",t[t.CONE=4]="CONE",t[t.MESH=5]="MESH",t[t.PLANE=6]="PLANE",t[t.SIMPLEX=7]="SIMPLEX",t[t.TERRAIN=8]="TERRAIN"}(krt||(krt={})),Jt(krt),function(t){t[t.POINT_TO_POINT=0]="POINT_TO_POINT",t[t.HINGE=1]="HINGE",t[t.CONE_TWIST=2]="CONE_TWIST"}(Hrt||(Hrt={})),Jt(Hrt),function(t){t[t.DEFAULT=1]="DEFAULT"}(jrt||(jrt={})),Jt(jrt);var Xrt,Yrt,Krt,Jrt,Qrt,Zrt,$rt,tot,eot,not,iot,rot,oot,aot,sot,cot,lot,uot,hot,_ot=function(t){if(1===t){for(var e=this,n=function(t){var n="_"+(1<<t);e[n]=0,e.updateArray=[],Object.defineProperty(e,1<<t,{get:function(){return this[n]},set:function(e){this[n]!==e&&(this[n]=e,this.updateArray.indexOf(t)<0&&this.updateArray.push(t))}})},i=0;i<32;i++)n(i);this._1=jrt.DEFAULT}else{for(var r=0;r<32;r++)this[""+(1<<r)]=0;this[1]=jrt.DEFAULT}},fot=null,pot=t("PhysicsSystem2D",function(t){function e(){var e;(e=t.call(this)||this).velocityIterations=10,e.positionIterations=10,e.physicsWorld=void 0,e.collisionMatrix=new _ot,e._enable=!0,e._allowSleep=!0,e._maxSubSteps=1,e._fixedTimeStep=1/60,e._autoSimulation=!0,e._accumulator=0,e._steping=!1,e._gravity=new li(0,-10*vrt),e._delayEvents=[];var n=mM.config?mM.config.physics:null;if(n){if(li.copy(e._gravity,n.gravity),e._gravity.multiplyScalar(vrt),e._allowSleep=n.allowSleep,e._fixedTimeStep=n.fixedTimeStep,e._maxSubSteps=n.maxSubSteps,e._autoSimulation=n.autoSimulation,n.collisionMatrix)for(var i in n.collisionMatrix){var r=parseInt(i),o=1<<parseInt(i);e.collisionMatrix[""+o]=n.collisionMatrix[r]}if(n.collisionGroups){var a=n.collisionGroups;a instanceof Array&&(a.forEach((function(t){_rt[t.name]=1<<t.index})),Jt.update(_rt))}}return e.physicsWorld=new ert.PhysicsWorld,e.gravity=e._gravity,e.allowSleep=e._allowSleep,e}F(e,t);var n=e.prototype;return n.postUpdate=function(t){if(this._enable&&this._autoSimulation){LM.emit(NM.EVENT_BEFORE_PHYSICS),this._steping=!0;var e=this._fixedTimeStep,n=this.velocityIterations,i=this.positionIterations;this._accumulator+=t;for(var r=0;r++<this._maxSubSteps&&this._accumulator>e;)this.physicsWorld.step(e,n,i),this._accumulator-=e;for(var o=this._delayEvents,a=0,s=o.length;a<s;a++){var c=o[a];c.func.call(c.target)}o.length=0,this.physicsWorld.syncPhysicsToScene(),this.debugDrawFlags&&this.physicsWorld.drawDebug(),this._steping=!1,LM.emit(NM.EVENT_AFTER_PHYSICS)}},n._callAfterStep=function(t,e){this._steping?this._delayEvents.push({target:t,func:e}):e.call(t)},n.resetAccumulator=function(t){void 0===t&&(t=0),this._accumulator=t},n.step=function(t){this.physicsWorld.step(t,this.velocityIterations,this.positionIterations)},n.raycast=function(t,e,n,i){return void 0===n&&(n=frt.Closest),void 0===i&&(i=4294967295),this.physicsWorld.raycast(t,e,n,i)},n.testPoint=function(t){return this.physicsWorld.testPoint(t)},n.testAABB=function(t){return this.physicsWorld.testAABB(t)},N(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable=t}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(t){this._allowSleep=t,this.physicsWorld.setAllowSleep(t)}},{key:"gravity",get:function(){return this._gravity},set:function(t){this._gravity.set(t),this.physicsWorld.setGravity(new li(t.x/vrt,t.y/vrt))}},{key:"maxSubSteps",get:function(){return this._maxSubSteps},set:function(t){this._maxSubSteps=t}},{key:"fixedTimeStep",get:function(){return this._fixedTimeStep},set:function(t){this._fixedTimeStep=t}},{key:"autoSimulation",get:function(){return this._autoSimulation},set:function(t){this._autoSimulation=t}},{key:"debugDrawFlags",get:function(){return this.physicsWorld.debugDrawFlags},set:function(t){this.physicsWorld.debugDrawFlags=t}},{key:"stepping",get:function(){return this._steping}}],[{key:"PHYSICS_NONE",get:function(){return!nrt}},{key:"PHYSICS_BUILTIN",get:function(){return"builtin"===nrt}},{key:"PHYSICS_BOX2D",get:function(){return"box2d"===nrt}},{key:"PhysicsGroup",get:function(){return _rt}},{key:"instance",get:function(){return fot||(fot=new e),fot}}]),e}(sn(bM)));pot.ID="PHYSICS_2D",LM.once(NM.EVENT_INIT,(function(){pot.PHYSICS_NONE||LM.registerSystem(pot.ID,pot.instance,bM.Priority.LOW)})),function(t){t[t.Circles=0]="Circles",t[t.FaceA=1]="FaceA",t[t.FaceB=2]="FaceB"}(Xrt||(Xrt=t("Physics2DManifoldType",{})));var dot,mot,vot,got,yot,xot,Sot,Aot,Cot,bot,Tot,Eot,wot,Pot,Iot,Rot,Dot,Bot,Mot,Oot,Not,Lot,Fot,zot,Vot,Got,Uot,kot,Hot,jot,Wot,qot,Xot,Yot,Kot,Jot,Qot,Zot,$ot,tat,eat,nat,iat,rat,oat,aat,sat,cat,lat,uat,hat,_at,fat,pat,dat,mat,vat,gat,yat,xat,Sat,Aat,Cat,bat,Tat,Eat,wat,Pat,Iat,Rat,Dat,Bat,Mat,Oat,Nat,Lat,Fat,zat,Vat,Gat,Uat,kat,Hat,jat,Wat,qat,Xat,Yat,Kat,Jat,Qat,Zat,$at=Jc,tst=El,est=rl,nst=t("RigidBody2D",(Yrt=qc("cc.RigidBody2D"),Krt=est(),Jrt=tst(jrt),Qrt=tst(lrt),Yrt(Zrt=Krt((X(($rt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"enabledContactListener",tot,H(e)),q(e,"bullet",eot,H(e)),q(e,"awakeOnLoad",not,H(e)),e._body=null,q(e,"_group",iot,H(e)),q(e,"_type",rot,H(e)),q(e,"_allowSleep",oot,H(e)),q(e,"_gravityScale",aot,H(e)),q(e,"_linearDamping",sot,H(e)),q(e,"_angularDamping",cot,H(e)),q(e,"_linearVelocity",lot,H(e)),q(e,"_angularVelocity",uot,H(e)),q(e,"_fixedRotation",hot,H(e)),e}F(e,t);var n=e.prototype;return n.isAwake=function(){return!!this._body&&this._body.isAwake},n.wakeUp=function(){this._body&&this._body.wakeUp()},n.sleep=function(){this._body&&this._body.sleep()},n.getMass=function(){return this._body?this._body.getMass():0},n.applyForce=function(t,e,n){this._body&&this._body.applyForce(t,e,n)},n.applyForceToCenter=function(t,e){this._body&&this._body.applyForceToCenter(t,e)},n.applyTorque=function(t,e){this._body&&this._body.applyTorque(t,e)},n.applyLinearImpulse=function(t,e,n){this._body&&this._body.applyLinearImpulse(t,e,n)},n.applyLinearImpulseToCenter=function(t,e){this._body&&this._body.applyLinearImpulseToCenter(t,e)},n.applyAngularImpulse=function(t,e){this._body&&this._body.applyAngularImpulse(t,e)},n.getLinearVelocityFromWorldPoint=function(t,e){return this._body?this._body.getLinearVelocityFromWorldPoint(t,e):e},n.getLocalVector=function(t,e){return this._body?this._body.getLocalVector(t,e):e},n.getWorldVector=function(t,e){return this._body?this._body.getWorldVector(t,e):e},n.getLocalPoint=function(t,e){return this._body?this._body.getLocalPoint(t,e):e},n.getWorldPoint=function(t,e){return this._body?this._body.getWorldPoint(t,e):e},n.getLocalCenter=function(t){return this._body?this._body.getLocalCenter(t):t},n.getWorldCenter=function(t){return this._body?this._body.getWorldCenter(t):t},n.getInertia=function(){return this._body&&this._body.getInertia(),0},n.onLoad=function(){this._body=i._global.CC_PHYSICS_2D_BUILTIN?Frt:new ert.RigidBody,this._body.initialize(this)},n.onEnable=function(){this._body&&this._body.onEnable()},n.onDisable=function(){this._body&&this._body.onDisable()},n.onDestroy=function(){this._body&&this._body.onDestroy()},N(e,[{key:"group",get:function(){return this._group},set:function(t){this._group=t}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._body&&(t===lrt.Animated?this._body.setType(lrt.Kinematic):this._body.setType(t))}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(t){this._allowSleep=t,this._body&&this._body.setAllowSleep(t)}},{key:"gravityScale",get:function(){return this._gravityScale},set:function(t){this._gravityScale=t,this._body&&this._body.setGravityScale(t)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(t){this._linearDamping=t,this._body&&this._body.setLinearDamping(t)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(t){this._angularDamping=t,this._body&&this._body.setAngularDamping(t)}},{key:"linearVelocity",get:function(){return this._body&&this._body.getLinearVelocity(this._linearVelocity),this._linearVelocity},set:function(t){this._linearVelocity=t,this._body&&this._body.setLinearVelocity(t)}},{key:"angularVelocity",get:function(){return this._body&&(this._angularVelocity=this._body.getAngularVelocity()),this._angularVelocity},set:function(t){this._angularVelocity=t,this._body&&this._body.setAngularVelocity(t)}},{key:"fixedRotation",get:function(){return this._fixedRotation},set:function(t){this._fixedRotation=t,this._body&&this._body.setFixedRotation(t)}},{key:"impl",get:function(){return this._body}}]),e}(ku)).prototype,"group",[Jrt],Object.getOwnPropertyDescriptor($rt.prototype,"group"),$rt.prototype),tot=X($rt.prototype,"enabledContactListener",[$at],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),eot=X($rt.prototype,"bullet",[$at],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X($rt.prototype,"type",[Qrt],Object.getOwnPropertyDescriptor($rt.prototype,"type"),$rt.prototype),X($rt.prototype,"allowSleep",[$at],Object.getOwnPropertyDescriptor($rt.prototype,"allowSleep"),$rt.prototype),X($rt.prototype,"gravityScale",[$at],Object.getOwnPropertyDescriptor($rt.prototype,"gravityScale"),$rt.prototype),X($rt.prototype,"linearDamping",[$at],Object.getOwnPropertyDescriptor($rt.prototype,"linearDamping"),$rt.prototype),X($rt.prototype,"angularDamping",[$at],Object.getOwnPropertyDescriptor($rt.prototype,"angularDamping"),$rt.prototype),X($rt.prototype,"linearVelocity",[$at],Object.getOwnPropertyDescriptor($rt.prototype,"linearVelocity"),$rt.prototype),X($rt.prototype,"angularVelocity",[$at],Object.getOwnPropertyDescriptor($rt.prototype,"angularVelocity"),$rt.prototype),X($rt.prototype,"fixedRotation",[$at],Object.getOwnPropertyDescriptor($rt.prototype,"fixedRotation"),$rt.prototype),not=X($rt.prototype,"awakeOnLoad",[$at],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),iot=X($rt.prototype,"_group",[$at],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jrt.DEFAULT}}),rot=X($rt.prototype,"_type",[$at],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lrt.Dynamic}}),oot=X($rt.prototype,"_allowSleep",[$at],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),aot=X($rt.prototype,"_gravityScale",[$at],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sot=X($rt.prototype,"_linearDamping",[$at],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cot=X($rt.prototype,"_angularDamping",[$at],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lot=X($rt.prototype,"_linearVelocity",[$at],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new li}}),uot=X($rt.prototype,"_angularVelocity",[$at],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hot=X($rt.prototype,"_fixedRotation",[$at],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zrt=$rt))||Zrt)||Zrt)),ist=t("Collider2D",(dot=qc("cc.Collider2D"),mot=El(jrt),dot((wot=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"editing",yot,H(e)),q(e,"tag",xot,H(e)),e.TYPE=urt.None,e._shape=null,e._body=null,q(e,"_group",Sot,H(e)),q(e,"_density",Aot,H(e)),q(e,"_sensor",Cot,H(e)),q(e,"_friction",bot,H(e)),q(e,"_restitution",Tot,H(e)),q(e,"_offset",Eot,H(e)),e}F(e,t);var n=e.prototype;return n.onLoad=function(){this._shape=function(t){return zrt.INITED||(zrt.INITED=!0,zrt[urt.BOX]=function(){return new ert.BoxShape},zrt[urt.CIRCLE]=function(){return new ert.CircleShape},zrt[urt.POLYGON]=function(){return new ert.PolygonShape}),zrt[t]()}(this.TYPE),this._shape.initialize(this),this._shape.onLoad&&this._shape.onLoad(),this._body=this.getComponent(nst)},n.onEnable=function(){this._shape&&this._shape.onEnable()},n.onDisable=function(){this._shape&&this._shape.onDisable&&this._shape.onDisable()},n.onDestroy=function(){this._shape&&this._shape.onDestroy&&this._shape.onDestroy()},n.apply=function(){this._shape&&this._shape.apply&&this._shape.apply()},N(e,[{key:"group",get:function(){return this._group},set:function(t){this._group=t,this._shape&&this._shape.onGroupChanged&&this._shape.onGroupChanged()}},{key:"density",get:function(){return this._density},set:function(t){this._density=t}},{key:"sensor",get:function(){return this._sensor},set:function(t){this._sensor=t}},{key:"friction",get:function(){return this._friction},set:function(t){this._friction=t}},{key:"restitution",get:function(){return this._restitution},set:function(t){this._restitution=t}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset=t}},{key:"body",get:function(){return this._body}},{key:"impl",get:function(){return this._shape}},{key:"worldAABB",get:function(){return this._shape?this._shape.worldAABB:new Mi}}]),e}(sn(ku)),yot=X((got=wot).prototype,"editing",[ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xot=X(got.prototype,"tag",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(got.prototype,"group",[mot],Object.getOwnPropertyDescriptor(got.prototype,"group"),got.prototype),X(got.prototype,"density",[Jc],Object.getOwnPropertyDescriptor(got.prototype,"density"),got.prototype),X(got.prototype,"sensor",[Jc],Object.getOwnPropertyDescriptor(got.prototype,"sensor"),got.prototype),X(got.prototype,"friction",[Jc],Object.getOwnPropertyDescriptor(got.prototype,"friction"),got.prototype),X(got.prototype,"restitution",[Jc],Object.getOwnPropertyDescriptor(got.prototype,"restitution"),got.prototype),X(got.prototype,"offset",[Jc],Object.getOwnPropertyDescriptor(got.prototype,"offset"),got.prototype),Sot=X(got.prototype,"_group",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jrt.DEFAULT}}),Aot=X(got.prototype,"_density",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Cot=X(got.prototype,"_sensor",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),bot=X(got.prototype,"_friction",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.2}}),Tot=X(got.prototype,"_restitution",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Eot=X(got.prototype,"_offset",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new li}}),vot=got))||vot)),rst=(t("BoxCollider2D",qc("cc.BoxCollider2D")(Pot=rl()((Dot=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_size",Rot,H(e)),e.TYPE=urt.BOX,e}return F(e,t),N(e,[{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"worldPoints",get:function(){return this._shape?this._shape.worldPoints:[]}}]),e}(ist),Rot=X((Iot=Dot).prototype,"_size",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Di(1,1)}}),X(Iot.prototype,"size",[Jc],Object.getOwnPropertyDescriptor(Iot.prototype,"size"),Iot.prototype),Pot=Iot))||Pot)||Pot),t("CircleCollider2D",qc("cc.CircleCollider2D")(Bot=rl()((Not=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_radius",Oot,H(e)),e.TYPE=urt.CIRCLE,e}return F(e,t),N(e,[{key:"radius",get:function(){return this._radius},set:function(t){this._radius=t<0?0:t}},{key:"worldPosition",get:function(){return this._shape?this._shape.worldPosition:new li}},{key:"worldRadius",get:function(){return this._shape?this._shape.worldRadius:0}}]),e}(ist),Oot=X((Mot=Not).prototype,"_radius",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),X(Mot.prototype,"radius",[Jc],Object.getOwnPropertyDescriptor(Mot.prototype,"radius"),Mot.prototype),Bot=Mot))||Bot)||Bot),t("PolygonCollider2D",(Lot=qc("cc.PolygonCollider2D"),Fot=rl(),zot=Jc({serializable:!1}),Vot=Jc({type:li}),Lot(Got=Fot((jot=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"threshold",kot,H(e)),q(e,"_points",Hot,H(e)),e.TYPE=urt.POLYGON,e}return F(e,t),N(e,[{key:"points",get:function(){return this._points},set:function(t){this._points=t}},{key:"worldPoints",get:function(){return this._shape?this._shape.worldPoints:[]}}]),e}(ist),kot=X((Uot=jot).prototype,"threshold",[zot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Hot=X(Uot.prototype,"_points",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new li(-1,-1),new li(1,-1),new li(1,1),new li(-1,1)]}}),X(Uot.prototype,"points",[Vot],Object.getOwnPropertyDescriptor(Uot.prototype,"points"),Uot.prototype),Got=Uot))||Got)||Got)),t("Joint2D",(Wot=qc("cc.Joint2D"),qot=El(nst),Wot(($ot=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"anchor",Kot,H(e)),q(e,"connectedAnchor",Jot,H(e)),q(e,"collideConnected",Qot,H(e)),q(e,"connectedBody",Zot,H(e)),e._body=null,e._joint=null,e.TYPE=hrt.None,e}F(e,t);var n=e.prototype;return n.onLoad=function(){this._joint=function(t){return function(){if(!Wrt.INITED){Wrt.INITED=!0;var t=i._global.CC_PHYSICS_2D_BUILTIN;Wrt[hrt.SPRING]=function(){return t?qrt:new ert.SpringJoint},Wrt[hrt.DISTANCE]=function(){return t?qrt:new ert.DistanceJoint},Wrt[hrt.FIXED]=function(){return t?qrt:new ert.FixedJoint},Wrt[hrt.MOUSE]=function(){return t?qrt:new ert.MouseJoint},Wrt[hrt.RELATIVE]=function(){return t?qrt:new ert.RelativeJoint},Wrt[hrt.SLIDER]=function(){return t?qrt:new ert.SliderJoint},Wrt[hrt.WHEEL]=function(){return t?qrt:new ert.WheelJoint},Wrt[hrt.HINGE]=function(){return t?qrt:new ert.HingeJoint}}}(),Wrt[t]()}(this.TYPE),this._joint.initialize(this),this._body=this.getComponent(nst)},n.onEnable=function(){this._joint&&this._joint.onEnable&&this._joint.onEnable()},n.onDisable=function(){this._joint&&this._joint.onDisable&&this._joint.onDisable()},n.start=function(){this._joint&&this._joint.start&&this._joint.start()},n.onDestroy=function(){this._joint&&this._joint.onDestroy&&this._joint.onDestroy()},N(e,[{key:"body",get:function(){return this._body}},{key:"impl",get:function(){return this._joint}}]),e}(ku),Kot=X((Yot=$ot).prototype,"anchor",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new li}}),Jot=X(Yot.prototype,"connectedAnchor",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new li}}),Qot=X(Yot.prototype,"collideConnected",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zot=X(Yot.prototype,"connectedBody",[qot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xot=Yot))||Xot))),ost=(t("DistanceJoint2D",qc("cc.DistanceJoint2D")(tat=rl()((X((eat=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=hrt.DISTANCE,q(e,"_maxLength",nat,H(e)),q(e,"_autoCalcDistance",iat,H(e)),e}return F(e,t),N(e,[{key:"maxLength",get:function(){return this._autoCalcDistance&&this.connectedBody?oi.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):this._maxLength},set:function(t){this._maxLength=t,this._joint&&this._joint.setMaxLength(t)}},{key:"autoCalcDistance",get:function(){return this._autoCalcDistance},set:function(t){this._autoCalcDistance=t}}]),e}(rst)).prototype,"maxLength",[Jc],Object.getOwnPropertyDescriptor(eat.prototype,"maxLength"),eat.prototype),X(eat.prototype,"autoCalcDistance",[Jc],Object.getOwnPropertyDescriptor(eat.prototype,"autoCalcDistance"),eat.prototype),nat=X(eat.prototype,"_maxLength",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),iat=X(eat.prototype,"_autoCalcDistance",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),tat=eat))||tat)||tat),t("SpringJoint2D",qc("cc.SpringJoint2D")(rat=rl()((X((oat=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=hrt.SPRING,q(e,"_frequency",aat,H(e)),q(e,"_dampingRatio",sat,H(e)),q(e,"_distance",cat,H(e)),q(e,"_autoCalcDistance",lat,H(e)),e}return F(e,t),N(e,[{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}},{key:"distance",get:function(){return this._autoCalcDistance&&this.connectedBody?oi.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):this._distance},set:function(t){this._distance=t,this._joint&&this._joint.setDistance(t)}},{key:"autoCalcDistance",get:function(){return this._autoCalcDistance},set:function(t){this._autoCalcDistance=t}}]),e}(rst)).prototype,"frequency",[Jc],Object.getOwnPropertyDescriptor(oat.prototype,"frequency"),oat.prototype),X(oat.prototype,"dampingRatio",[Jc],Object.getOwnPropertyDescriptor(oat.prototype,"dampingRatio"),oat.prototype),X(oat.prototype,"distance",[Jc],Object.getOwnPropertyDescriptor(oat.prototype,"distance"),oat.prototype),X(oat.prototype,"autoCalcDistance",[Jc],Object.getOwnPropertyDescriptor(oat.prototype,"autoCalcDistance"),oat.prototype),aat=X(oat.prototype,"_frequency",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),sat=X(oat.prototype,"_dampingRatio",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),cat=X(oat.prototype,"_distance",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),lat=X(oat.prototype,"_autoCalcDistance",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),rat=oat))||rat)||rat),t("MouseJoint2D",qc("cc.MouseJoint2D")(uat=rl()((X((hat=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=hrt.MOUSE,q(e,"_maxForce",_at,H(e)),q(e,"_dampingRatio",fat,H(e)),q(e,"_frequency",pat,H(e)),e._target=new li,e}return F(e,t),e.prototype.update=function(t){this._joint.update(t)},N(e,[{key:"target",get:function(){return this._target},set:function(t){this._target=t,this._joint&&this._joint.setTarget(t)}},{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}},{key:"maxForce",get:function(){return this._maxForce},set:function(t){this._maxForce=t,this._joint&&this._joint.setMaxForce(t)}}]),e}(rst)).prototype,"frequency",[Jc],Object.getOwnPropertyDescriptor(hat.prototype,"frequency"),hat.prototype),X(hat.prototype,"dampingRatio",[Jc],Object.getOwnPropertyDescriptor(hat.prototype,"dampingRatio"),hat.prototype),X(hat.prototype,"maxForce",[Jc],Object.getOwnPropertyDescriptor(hat.prototype,"maxForce"),hat.prototype),_at=X(hat.prototype,"_maxForce",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),fat=X(hat.prototype,"_dampingRatio",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),pat=X(hat.prototype,"_frequency",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),uat=hat))||uat)||uat),new oi),ast=new oi,sst=(t("RelativeJoint2D",qc("cc.RelativeJoint2D")(dat=rl()((X((mat=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=hrt.RELATIVE,q(e,"_maxForce",vat,H(e)),q(e,"_maxTorque",gat,H(e)),q(e,"_correctionFactor",yat,H(e)),q(e,"_angularOffset",xat,H(e)),q(e,"_linearOffset",Sat,H(e)),q(e,"_autoCalcOffset",Aat,H(e)),e}return F(e,t),N(e,[{key:"maxForce",get:function(){return this._maxForce},set:function(t){this._maxForce=t,this._joint&&this._joint.setMaxForce(t)}},{key:"maxTorque",get:function(){return this._maxTorque},set:function(t){this._maxTorque=t,this._joint&&this._joint.setMaxTorque(t)}},{key:"correctionFactor",get:function(){return this._correctionFactor},set:function(t){this._correctionFactor=t,this._joint&&this._joint.setCorrectionFactor(t)}},{key:"linearOffset",get:function(){return this._autoCalcOffset&&this.connectedBody?li.subtract(this._linearOffset,this.connectedBody.node.worldPosition,this.node.worldPosition):this._linearOffset},set:function(t){this._linearOffset.set(t),this._joint&&this._joint.setLinearOffset(t)}},{key:"angularOffset",get:function(){return this._autoCalcOffset&&this.connectedBody&&(gi.toEuler(ost,this.node.worldRotation),gi.toEuler(ast,this.connectedBody.node.worldRotation),this._angularOffset=ast.z-ost.z),this._angularOffset},set:function(t){this._angularOffset=t,this._joint&&this._joint.setAngularOffset(t)}},{key:"autoCalcOffset",get:function(){return this._autoCalcOffset},set:function(t){this._autoCalcOffset=t}}]),e}(rst)).prototype,"maxForce",[Jc],Object.getOwnPropertyDescriptor(mat.prototype,"maxForce"),mat.prototype),X(mat.prototype,"maxTorque",[Jc],Object.getOwnPropertyDescriptor(mat.prototype,"maxTorque"),mat.prototype),X(mat.prototype,"correctionFactor",[Jc],Object.getOwnPropertyDescriptor(mat.prototype,"correctionFactor"),mat.prototype),X(mat.prototype,"linearOffset",[Jc],Object.getOwnPropertyDescriptor(mat.prototype,"linearOffset"),mat.prototype),X(mat.prototype,"angularOffset",[Jc],Object.getOwnPropertyDescriptor(mat.prototype,"angularOffset"),mat.prototype),X(mat.prototype,"autoCalcOffset",[Jc],Object.getOwnPropertyDescriptor(mat.prototype,"autoCalcOffset"),mat.prototype),vat=X(mat.prototype,"_maxForce",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),gat=X(mat.prototype,"_maxTorque",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),yat=X(mat.prototype,"_correctionFactor",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),xat=X(mat.prototype,"_angularOffset",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Sat=X(mat.prototype,"_linearOffset",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new li}}),Aat=X(mat.prototype,"_autoCalcOffset",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),dat=mat))||dat)||dat),new li),cst=(t("SliderJoint2D",qc("cc.SliderJoint2D")(Cat=rl()((X((bat=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=hrt.SLIDER,q(e,"_angle",Tat,H(e)),q(e,"_autoCalcAngle",Eat,H(e)),q(e,"_enableMotor",wat,H(e)),q(e,"_maxMotorForce",Pat,H(e)),q(e,"_motorSpeed",Iat,H(e)),q(e,"_enableLimit",Rat,H(e)),q(e,"_lowerLimit",Dat,H(e)),q(e,"_upperLimit",Bat,H(e)),e}return F(e,t),N(e,[{key:"angle",get:function(){return this._autoCalcAngle&&this.connectedBody&&(li.subtract(sst,this.connectedBody.node.worldPosition,this.node.worldPosition),this._angle=Wn(Math.atan2(sst.y,sst.x))),this._angle},set:function(t){this._angle=t}},{key:"autoCalcAngle",get:function(){return this._autoCalcAngle},set:function(t){this._autoCalcAngle=t}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(t){this._enableMotor=t}},{key:"maxMotorForce",get:function(){return this._maxMotorForce},set:function(t){this._maxMotorForce=t,this._joint&&this._joint.setMaxMotorForce(t)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}},{key:"enableLimit",get:function(){return this._enableLimit},set:function(t){this._enableLimit=t}},{key:"lowerLimit",get:function(){return this._lowerLimit},set:function(t){this._lowerLimit=t,this._joint&&this._joint.setLowerLimit(t)}},{key:"upperLimit",get:function(){return this._upperLimit},set:function(t){this._upperLimit=t,this._joint&&this._joint.setUpperLimit(t)}}]),e}(rst)).prototype,"angle",[Jc],Object.getOwnPropertyDescriptor(bat.prototype,"angle"),bat.prototype),X(bat.prototype,"autoCalcAngle",[Jc],Object.getOwnPropertyDescriptor(bat.prototype,"autoCalcAngle"),bat.prototype),X(bat.prototype,"enableMotor",[Jc],Object.getOwnPropertyDescriptor(bat.prototype,"enableMotor"),bat.prototype),X(bat.prototype,"maxMotorForce",[Jc],Object.getOwnPropertyDescriptor(bat.prototype,"maxMotorForce"),bat.prototype),X(bat.prototype,"motorSpeed",[Jc],Object.getOwnPropertyDescriptor(bat.prototype,"motorSpeed"),bat.prototype),X(bat.prototype,"enableLimit",[Jc],Object.getOwnPropertyDescriptor(bat.prototype,"enableLimit"),bat.prototype),X(bat.prototype,"lowerLimit",[Jc],Object.getOwnPropertyDescriptor(bat.prototype,"lowerLimit"),bat.prototype),X(bat.prototype,"upperLimit",[Jc],Object.getOwnPropertyDescriptor(bat.prototype,"upperLimit"),bat.prototype),Tat=X(bat.prototype,"_angle",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Eat=X(bat.prototype,"_autoCalcAngle",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wat=X(bat.prototype,"_enableMotor",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Pat=X(bat.prototype,"_maxMotorForce",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),Iat=X(bat.prototype,"_motorSpeed",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),Rat=X(bat.prototype,"_enableLimit",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Dat=X(bat.prototype,"_lowerLimit",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bat=X(bat.prototype,"_upperLimit",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Cat=bat))||Cat)||Cat),t("FixedJoint2D",qc("cc.FixedJoint2D")(Mat=rl()((X((Oat=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=hrt.FIXED,q(e,"_frequency",Nat,H(e)),q(e,"_dampingRatio",Lat,H(e)),e}return F(e,t),N(e,[{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}}]),e}(rst)).prototype,"frequency",[Jc],Object.getOwnPropertyDescriptor(Oat.prototype,"frequency"),Oat.prototype),X(Oat.prototype,"dampingRatio",[Jc],Object.getOwnPropertyDescriptor(Oat.prototype,"dampingRatio"),Oat.prototype),Nat=X(Oat.prototype,"_frequency",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),Lat=X(Oat.prototype,"_dampingRatio",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Mat=Oat))||Mat)||Mat),t("WheelJoint2D",qc("cc.WheelJoint2D")(Fat=rl()((X((zat=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=hrt.WHEEL,q(e,"_angle",Vat,H(e)),q(e,"_enableMotor",Gat,H(e)),q(e,"_maxMotorTorque",Uat,H(e)),q(e,"_motorSpeed",kat,H(e)),q(e,"_frequency",Hat,H(e)),q(e,"_dampingRatio",jat,H(e)),e}return F(e,t),N(e,[{key:"angle",get:function(){return this._angle},set:function(t){this._angle=t}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(t){this._enableMotor=t,this._joint&&this._joint.enableMotor(t)}},{key:"maxMotorTorque",get:function(){return this._maxMotorTorque},set:function(t){this._maxMotorTorque=t,this._joint&&this._joint.setMaxMotorTorque(t)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}},{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}}]),e}(rst)).prototype,"angle",[Jc],Object.getOwnPropertyDescriptor(zat.prototype,"angle"),zat.prototype),X(zat.prototype,"enableMotor",[Jc],Object.getOwnPropertyDescriptor(zat.prototype,"enableMotor"),zat.prototype),X(zat.prototype,"maxMotorTorque",[Jc],Object.getOwnPropertyDescriptor(zat.prototype,"maxMotorTorque"),zat.prototype),X(zat.prototype,"motorSpeed",[Jc],Object.getOwnPropertyDescriptor(zat.prototype,"motorSpeed"),zat.prototype),X(zat.prototype,"frequency",[Jc],Object.getOwnPropertyDescriptor(zat.prototype,"frequency"),zat.prototype),X(zat.prototype,"dampingRatio",[Jc],Object.getOwnPropertyDescriptor(zat.prototype,"dampingRatio"),zat.prototype),Vat=X(zat.prototype,"_angle",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 90}}),Gat=X(zat.prototype,"_enableMotor",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Uat=X(zat.prototype,"_maxMotorTorque",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),kat=X(zat.prototype,"_motorSpeed",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hat=X(zat.prototype,"_frequency",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),jat=X(zat.prototype,"_dampingRatio",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),Fat=zat))||Fat)||Fat),t("HingeJoint2D",qc("cc.HingeJoint2D")(Wat=rl()((X((qat=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=hrt.HINGE,q(e,"_enableLimit",Xat,H(e)),q(e,"_lowerAngle",Yat,H(e)),q(e,"_upperAngle",Kat,H(e)),q(e,"_enableMotor",Jat,H(e)),q(e,"_maxMotorTorque",Qat,H(e)),q(e,"_motorSpeed",Zat,H(e)),e}return F(e,t),N(e,[{key:"enableLimit",get:function(){return this._enableLimit},set:function(t){this._enableLimit=t}},{key:"lowerAngle",get:function(){return this._lowerAngle},set:function(t){this._lowerAngle=t,this._joint&&this._joint.setLowerAngle(t)}},{key:"upperAngle",get:function(){return this._upperAngle},set:function(t){this._upperAngle=t,this._joint&&this._joint.setUpperAngle(t)}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(t){this._enableMotor=t,this._joint&&this._joint.enableMotor(t)}},{key:"maxMotorTorque",get:function(){return this._maxMotorTorque},set:function(t){this._maxMotorTorque=t,this._joint&&this._joint.setMaxMotorTorque(t)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}}]),e}(rst)).prototype,"enableLimit",[Jc],Object.getOwnPropertyDescriptor(qat.prototype,"enableLimit"),qat.prototype),X(qat.prototype,"lowerAngle",[Jc],Object.getOwnPropertyDescriptor(qat.prototype,"lowerAngle"),qat.prototype),X(qat.prototype,"upperAngle",[Jc],Object.getOwnPropertyDescriptor(qat.prototype,"upperAngle"),qat.prototype),X(qat.prototype,"enableMotor",[Jc],Object.getOwnPropertyDescriptor(qat.prototype,"enableMotor"),qat.prototype),X(qat.prototype,"maxMotorTorque",[Jc],Object.getOwnPropertyDescriptor(qat.prototype,"maxMotorTorque"),qat.prototype),X(qat.prototype,"motorSpeed",[Jc],Object.getOwnPropertyDescriptor(qat.prototype,"motorSpeed"),qat.prototype),Xat=X(qat.prototype,"_enableLimit",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Yat=X(qat.prototype,"_lowerAngle",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Kat=X(qat.prototype,"_upperAngle",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jat=X(qat.prototype,"_enableMotor",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qat=X(qat.prototype,"_maxMotorTorque",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),Zat=X(qat.prototype,"_motorSpeed",[Jc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wat=qat))||Wat)||Wat),t("Physics2DUtils",{PolygonSeparator:Nrt}),function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._type=frt.Closest,e._fixtures=[],e._points=[],e._normals=[],e._fractions=[],e._mask=4294967295,e}F(e,t);var n=e.prototype;return n.init=function(t,e){this._type=t,this._mask=e,this._fixtures.length=0,this._points.length=0,this._normals.length=0,this._fractions.length=0},n.ReportFixture=function(t,e,n,i){return 0==(t.GetFilterData().categoryBits&this._mask)?0:this._type===frt.Closest?(this._fixtures[0]=t,this._points[0]=e,this._normals[0]=n,this._fractions[0]=i,i):(this._fixtures.push(t),this._points.push(new li(e.x,e.y)),this._normals.push(new li(n.x,n.y)),this._fractions.push(i),this._type===frt.Any?0:this._type>=frt.All?1:i)},n.getFixtures=function(){return this._fixtures},n.getPoints=function(){return this._points},n.getNormals=function(){return this._normals},n.getFractions=function(){return this._fractions},e}(prt.RayCastCallback)),lst=[],ust=[new li,new li],hst=new prt.WorldManifold,_st={points:[],separations:[],normal:new li},fst=function(){this.localPoint=new li,this.normalImpulse=0,this.tangentImpulse=0},pst=[new fst,new fst],dst={type:0,localPoint:new li,localNormal:new li,points:[]},mst={normalImpulses:[],tangentImpulses:[]},vst=function(){function t(){this.colliderA=null,this.colliderB=null,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=null}t.get=function(e){var n=lst.pop();return n||(n=new t),n.init(e),n},t.put=function(t){var e=t.m_userData;e&&(lst.push(e),e.reset())};var e=t.prototype;return e._setImpulse=function(t){this._impulse=t},e.init=function(t){this.colliderA=t.m_fixtureA.m_userData.collider,this.colliderB=t.m_fixtureB.m_userData.collider,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=t,t.m_userData=this},e.reset=function(){this.setTangentSpeed(0),this.resetFriction(),this.resetRestitution(),this.colliderA=null,this.colliderB=null,this.disabled=!1,this._impulse=null,this._b2contact.m_userData=null,this._b2contact=null},e.getWorldManifold=function(){var t=_st.points,e=_st.separations,n=_st.normal;this._b2contact.GetWorldManifold(hst);var i=hst.points,r=hst.separations,o=this._b2contact.GetManifold().pointCount;t.length=e.length=o;for(var a=0;a<o;a++){var s=ust[a];s.x=i[a].x*vrt,s.y=i[a].y*vrt,t[a]=s,e[a]=r[a]*vrt}return n.x=hst.normal.x,n.y=hst.normal.y,this._inverted&&(n.x*=-1,n.y*=-1),_st},e.getManifold=function(){for(var t=dst.points,e=dst.localNormal,n=dst.localPoint,i=this._b2contact.GetManifold(),r=i.points,o=t.length=i.pointCount,a=0;a<o;a++){var s=pst[a],c=r[a];s.localPoint.x=c.localPoint.x*vrt,s.localPoint.y=c.localPoint.y*vrt,s.normalImpulse=c.normalImpulse*vrt,s.tangentImpulse=c.tangentImpulse,t[a]=s}return n.x=i.localPoint.x*vrt,n.y=i.localPoint.y*vrt,e.x=i.localNormal.x,e.y=i.localNormal.y,dst.type=i.type,this._inverted&&(e.x*=-1,e.y*=-1),dst},e.getImpulse=function(){var t=this._impulse;if(!t)return null;for(var e=mst.normalImpulses,n=mst.tangentImpulses,i=t.count,r=0;r<i;r++)e[r]=t.normalImpulses[r]*vrt,n[r]=t.tangentImpulses[r];return n.length=e.length=i,mst},e.emit=function(t){var e=this.colliderA,n=this.colliderB,i=e.body,r=n.body;i.enabledContactListener&&(null==e||e.emit(t,e,n,this)),r.enabledContactListener&&(null==n||n.emit(t,n,e,this)),(i.enabledContactListener||r.enabledContactListener)&&pot.instance.emit(t,e,n,this),(this.disabled||this.disabledOnce)&&(this.setEnabled(!1),this.disabledOnce=!1)},e.setEnabled=function(t){this._b2contact.SetEnabled(t)},e.isTouching=function(){return this._b2contact.IsTouching()},e.setTangentSpeed=function(t){this._b2contact.SetTangentSpeed(t)},e.getTangentSpeed=function(){return this._b2contact.GetTangentSpeed()},e.setFriction=function(t){this._b2contact.SetFriction(t)},e.getFriction=function(){return this._b2contact.GetFriction()},e.resetFriction=function(){return this._b2contact.ResetFriction()},e.setRestitution=function(t){this._b2contact.SetRestitution(t)},e.getRestitution=function(){return this._b2contact.GetRestitution()},e.resetRestitution=function(){return this._b2contact.ResetRestitution()},t}(),gst=new prt.Vec2,yst=new Li,xst=Li.GREEN,Sst=Li.RED,Ast=function(t){function e(e){var n;return(n=t.call(this)||this)._drawer=null,n._xf=new prt.Transform,n._dxf=new prt.Transform,n._drawer=e,n}F(e,t);var n=e.prototype;return n._DrawPolygon=function(t,e){for(var n=this._drawer,i=0;i<e;i++){prt.Transform.MulXV(this._xf,t[i],gst);var r=gst.x*vrt,o=gst.y*vrt;0===i?n.moveTo(r,o):n.lineTo(r,o)}n.close()},n.DrawPolygon=function(t,e,n){this._applyStrokeColor(n),this._DrawPolygon(t,e),this._drawer.stroke()},n.DrawSolidPolygon=function(t,e,n){this._applyFillColor(n),this._DrawPolygon(t,e),this._drawer.fill(),this._drawer.stroke()},n._DrawCircle=function(t,e){var n=this._xf.p;this._drawer.circle((t.x+n.x)*vrt,(t.y+n.y)*vrt,e*vrt)},n.DrawCircle=function(t,e,n){this._applyStrokeColor(n),this._DrawCircle(t,e),this._drawer.stroke()},n.DrawSolidCircle=function(t,e,n,i){this._applyFillColor(i),this._DrawCircle(t,e),this._drawer.fill()},n.DrawSegment=function(t,e,n){var i=this._drawer;if(t.x===e.x&&t.y===e.y)return this._applyFillColor(n),this._DrawCircle(t,2/vrt),void i.fill();this._applyStrokeColor(n),prt.Transform.MulXV(this._xf,t,gst),i.moveTo(gst.x*vrt,gst.y*vrt),prt.Transform.MulXV(this._xf,e,gst),i.lineTo(gst.x*vrt,gst.y*vrt),i.stroke()},n.DrawTransform=function(t){var e=this._drawer;e.strokeColor=Sst,gst.x=gst.y=0,prt.Transform.MulXV(t,gst,gst),e.moveTo(gst.x*vrt,gst.y*vrt),gst.x=1,gst.y=0,prt.Transform.MulXV(t,gst,gst),e.lineTo(gst.x*vrt,gst.y*vrt),e.stroke(),e.strokeColor=xst,gst.x=gst.y=0,prt.Transform.MulXV(t,gst,gst),e.moveTo(gst.x*vrt,gst.y*vrt),gst.x=0,gst.y=1,prt.Transform.MulXV(t,gst,gst),e.lineTo(gst.x*vrt,gst.y*vrt),e.stroke()},n.DrawPoint=function(){},n.DrawParticles=function(){},n._applyStrokeColor=function(t){this._drawer.strokeColor=yst.set(255*t.r,255*t.g,255*t.b,150)},n._applyFillColor=function(t){this._drawer.fillColor=yst.set(255*t.r,255*t.g,255*t.b,150)},n.PushTransform=function(t){this._xf=t},n.PopTransform=function(){this._xf=this._dxf},e}(prt.Draw),Cst=new oi,bst=new li,Tst=new li,Est=new prt.BodyDef,wst=new prt.AABB,Pst=[],Ist=function(){function t(){this._world=void 0,this._bodies=[],this._animatedBodies=[],this._rotationAxis=new oi,this._contactListener=void 0,this._aabbQueryCallback=void 0,this._raycastQueryCallback=void 0,this._debugGraphics=null,this._b2DebugDrawer=null,this._debugDrawFlags=0,this._world=new prt.World(new prt.Vec2(0,-10));var t=new grt;t.setBeginContact(this._onBeginContact),t.setEndContact(this._onEndContact),t.setPreSolve(this._onPreSolve),t.setPostSolve(this._onPostSolve),this._world.SetContactListener(t),this._contactListener=t,this._aabbQueryCallback=new yrt,this._raycastQueryCallback=new cst}var e=t.prototype;return e._checkDebugDrawValid=function(){if(!this._debugGraphics||!this._debugGraphics.isValid){var t=NR("Canvas");if(!t){var e=LM.getScene();if(!e)return;(t=new BT("Canvas")).addComponent(M$),t.parent=e}var n=new BT("PHYSICS_2D_DEBUG_DRAW");n.hideFlags|=Je.Flags.DontSave,n.parent=t,n.worldPosition=oi.ZERO,n.layer=fp.Enum.UI_2D,this._debugGraphics=n.addComponent($Q),this._debugGraphics.lineWidth=2;var i=new Ast(this._debugGraphics);this._b2DebugDrawer=i,this._world.SetDebugDraw(i)}var r=this._debugGraphics.node.parent;this._debugGraphics.node.setSiblingIndex(r.children.length-1),this._b2DebugDrawer&&this._b2DebugDrawer.SetFlags(this.debugDrawFlags)},e.setGravity=function(t){this._world.SetGravity(t)},e.setAllowSleep=function(){this._world.SetAllowSleeping(!0)},e.step=function(t,e,n){void 0===e&&(e=10),void 0===n&&(n=10);for(var i=this._animatedBodies,r=0,o=i.length;r<o;r++)i[r].animate(t);this._world.Step(t,e,n)},e.raycast=function(t,e,n,i){if(t.equals(e))return[];n=n||frt.Closest,bst.x=t.x/vrt,bst.y=t.y/vrt,Tst.x=e.x/vrt,Tst.y=e.y/vrt;var r=this._raycastQueryCallback;r.init(n,i),this._world.RayCast(r,bst,Tst);var o=r.getFixtures();if(o.length>0){for(var a=r.getPoints(),s=r.getNormals(),c=r.getFractions(),l=[],u=0,h=o.length;u<h;u++){var _=o[u],f=_.m_userData,p=f.collider;if(n===frt.AllClosest){for(var d=void 0,m=0;m<l.length;m++)l[m].collider===p&&(d=l[m]);if(d){c[u]<d.fraction&&(d.fixtureIndex=f.getFixtureIndex(_),d.point.x=a[u].x*vrt,d.point.y=a[u].y*vrt,d.normal.x=s[u].x,d.normal.y=s[u].y,d.fraction=c[u]);continue}}l.push({collider:p,fixtureIndex:f.getFixtureIndex(_),point:new li(a[u].x*vrt,a[u].y*vrt),normal:new li(s[u].x,s[u].y),fraction:c[u]})}return l}return[]},e.syncPhysicsToScene=function(){for(var t=this._bodies,e=0,n=t.length;e<n;e++){var i=t[e],r=i.rigidBody;if(r.type!==lrt.Animated){var o=r.node,a=i.impl,s=a.GetPosition();Cst.x=s.x*vrt,Cst.y=s.y*vrt,Cst.z=0,o.worldPosition=Cst;var c=Wn(a.GetAngle());o.setWorldRotationFromEuler(0,0,c)}else i.resetVelocity()}},e.syncSceneToPhysics=function(){for(var t=this._bodies,e=0;e<t.length;e++)t[e].syncRotationToPhysics(),t[e].syncPositionToPhysics()},e.addBody=function(t){if(!this._bodies.includes(t)){var e=Est,n=t.rigidBody;e.allowSleep=n.allowSleep,e.gravityScale=n.gravityScale,e.linearDamping=n.linearDamping,e.angularDamping=n.angularDamping,e.fixedRotation=n.fixedRotation,e.bullet=n.bullet;var i=n.node,r=i.worldPosition;e.position.Set(r.x/vrt,r.y/vrt),Cst.z=gi.getAxisAngle(this._rotationAxis,i.worldRotation),e.angle=Cst.z,e.awake=n.awakeOnLoad,n.type===lrt.Animated?(e.type=lrt.Kinematic,this._animatedBodies.push(t),t._animatedPos.set(e.position.x,e.position.y),t._animatedAngle=e.angle):e.type=n.type;var o=n,a=o._linearVelocity;e.linearVelocity.Set(a.x,a.y),e.angularVelocity=jn(o._angularVelocity);var s=this._world.CreateBody(e);s.m_userData=t,t._imp=s,this._bodies.push(t)}},e.removeBody=function(t){this._bodies.includes(t)&&(t.impl&&(t.impl.m_userData=null,this._world.DestroyBody(t.impl),t._imp=null),Ut.remove(this._bodies,t),t.rigidBody.type===lrt.Animated&&Ut.remove(this._animatedBodies,t))},e.registerContactFixture=function(t){this._contactListener.registerContactFixture(t)},e.unregisterContactFixture=function(t){this._contactListener.unregisterContactFixture(t)},e.testPoint=function(t){var e=bst.x=t.x/vrt,n=bst.y=t.y/vrt,i=.2/vrt;wst.lowerBound.x=e-i,wst.lowerBound.y=n-i,wst.upperBound.x=e+i,wst.upperBound.y=n+i;var r=this._aabbQueryCallback;r.init(bst),this._world.QueryAABB(r,wst);var o=r.getFixtures();Pst.length=0;for(var a=0;a<o.length;a++){var s=o[a].m_userData.collider;Pst.includes(s)||Pst.push(s)}return Pst},e.testAABB=function(t){wst.lowerBound.x=t.xMin/vrt,wst.lowerBound.y=t.yMin/vrt,wst.upperBound.x=t.xMax/vrt,wst.upperBound.y=t.yMax/vrt;var e=this._aabbQueryCallback;e.init(),this._world.QueryAABB(e,wst);var n=e.getFixtures();Pst.length=0;for(var i=0;i<n.length;i++){var r=n[i].m_userData.collider;Pst.includes(r)||Pst.push(r)}return Pst},e.drawDebug=function(){this._checkDebugDrawValid(),this._debugGraphics&&(this._debugGraphics.clear(),this._world.DrawDebugData())},e._onBeginContact=function(t){vst.get(t).emit(mrt.BEGIN_CONTACT)},e._onEndContact=function(t){var e=t.m_userData;e&&(e.emit(mrt.END_CONTACT),vst.put(t))},e._onPreSolve=function(t){var e=t.m_userData;e&&e.emit(mrt.PRE_SOLVE)},e._onPostSolve=function(t,e){var n=t.m_userData;n&&(n._setImpulse(e),n.emit(mrt.POST_SOLVE),n._setImpulse(null))},N(t,[{key:"impl",get:function(){return this._world}},{key:"debugDrawFlags",get:function(){return this._debugDrawFlags},set:function(t){t||this._debugGraphics&&(this._debugGraphics.node.parent=null),this._debugDrawFlags=t}}]),t}(),Rst=(new oi,new prt.Vec2),Dst=function(){function t(){this._animatedPos=new li,this._animatedAngle=0,this._body=null,this._inited=!1}var e=t.prototype;return e.initialize=function(t){this._rigidBody=t,pot.instance._callAfterStep(this,this._init)},e.onDestroy=function(){pot.instance._callAfterStep(this,this._destroy)},e.onEnable=function(){this.setActive(!0)},e.onDisable=function(){this.setActive(!1)},e._registerNodeEvents=function(){this.rigidBody.node.on(RC.TRANSFORM_CHANGED,this._onNodeTransformChanged,this)},e._unregisterNodeEvents=function(){this.rigidBody.node.off(RC.TRANSFORM_CHANGED,this._onNodeTransformChanged,this)},e._onNodeTransformChanged=function(t){if(!pot.instance.stepping){if(t&BT.TransformBit.SCALE)for(var e=this.rigidBody.getComponents(ist),n=0;n<e.length;n++)e[n].apply();t&BT.TransformBit.POSITION&&this.syncPositionToPhysics(!0),t&BT.TransformBit.ROTATION&&this.syncRotationToPhysics(!0)}},e._init=function(){this._inited||(this._registerNodeEvents(),pot.instance.physicsWorld.addBody(this),this._inited=!0)},e._destroy=function(){this._inited&&(pot.instance.physicsWorld.removeBody(this),this._unregisterNodeEvents(),this._inited=!1)},e.animate=function(t){var e=this._body;if(e){var n=e.GetPosition();e.SetAwake(!0);var i=1/t;Rst.x=(this._animatedPos.x-n.x)*i,Rst.y=(this._animatedPos.y-n.y)*i,e.SetLinearVelocity(Rst);var r=e.GetAngle();e.SetAngularVelocity((this._animatedAngle-r)*i)}},e.syncPositionToPhysics=function(t){void 0===t&&(t=!1);var e=this._body;if(e){var n,i=this._rigidBody.node.worldPosition,r=this._rigidBody.type;(n=r===lrt.Animated?e.GetLinearVelocity():e.GetPosition()).x=i.x/vrt,n.y=i.y/vrt,r===lrt.Animated&&t?this._animatedPos.set(n.x,n.y):e.SetTransformVec(n,e.GetAngle())}},e.syncRotationToPhysics=function(t){void 0===t&&(t=!1);var e=this._body;if(e){var n=jn(this._rigidBody.node.eulerAngles.z);this._rigidBody.type===lrt.Animated&&t?this._animatedAngle=n:e.SetTransformVec(e.GetPosition(),n)}},e.resetVelocity=function(){var t=this._body;if(t){var e=t.m_linearVelocity;e.Set(0,0),t.SetLinearVelocity(e),t.SetAngularVelocity(0)}},e.setType=function(t){this._body.SetType(t)},e.setLinearDamping=function(t){this._body.SetLinearDamping(t)},e.setAngularDamping=function(t){this._body.SetAngularDamping(t)},e.setGravityScale=function(t){this._body.SetGravityScale(t)},e.setFixedRotation=function(t){this._body.SetFixedRotation(t)},e.setAllowSleep=function(t){this._body.SetSleepingAllowed(t)},e.isActive=function(){return this._body.IsActive()},e.setActive=function(t){this._body.SetActive(t)},e.wakeUp=function(){this._body.SetAwake(!0)},e.sleep=function(){this._body.SetAwake(!1)},e.getMass=function(){return this._body.GetMass()},e.setLinearVelocity=function(t){this._body.SetLinearVelocity(t)},e.getLinearVelocity=function(t){var e=this._body.GetLinearVelocity();return t.x=e.x,t.y=e.y,t},e.getLinearVelocityFromWorldPoint=function(t,e){return Rst.Set(t.x/vrt,t.y/vrt),this._body.GetLinearVelocityFromWorldPoint(Rst,e),e.x*=vrt,e.y*=vrt,e},e.setAngularVelocity=function(t){this._body.SetAngularVelocity(t)},e.getAngularVelocity=function(){return Wn(this._body.GetAngularVelocity())},e.getLocalVector=function(t,e){return e=e||new li,Rst.Set(t.x/vrt,t.y/vrt),this._body.GetLocalVector(Rst,e),e.x*=vrt,e.y*=vrt,e},e.getWorldVector=function(t,e){return Rst.Set(t.x/vrt,t.y/vrt),this._body.GetWorldVector(Rst,e),e.x*=vrt,e.y*=vrt,e},e.getLocalPoint=function(t,e){return e=e||new li,Rst.Set(t.x/vrt,t.y/vrt),this._body.GetLocalPoint(Rst,e),e.x*=vrt,e.y*=vrt,e},e.getWorldPoint=function(t,e){return e=e||new li,Rst.Set(t.x/vrt,t.y/vrt),this._body.GetWorldPoint(Rst,e),e.x*=vrt,e.y*=vrt,e},e.getLocalCenter=function(t){t=t||new li;var e=this._body.GetLocalCenter();return t.x=e.x*vrt,t.y=e.y*vrt,t},e.getWorldCenter=function(t){t=t||new li;var e=this._body.GetWorldCenter();return t.x=e.x*vrt,t.y=e.y*vrt,t},e.getInertia=function(){return this._body.GetInertia()},e.applyForce=function(t,e,n){this._body&&(Rst.Set(e.x/vrt,e.y/vrt),this._body.ApplyForce(t,Rst,n))},e.applyForceToCenter=function(t,e){this._body&&this._body.ApplyForceToCenter(t,e)},e.applyTorque=function(t,e){this._body&&this._body.ApplyTorque(t,e)},e.applyLinearImpulse=function(t,e,n){this._body&&(Rst.Set(e.x/vrt,e.y/vrt),this._body.ApplyLinearImpulse(t,Rst,n))},e.applyLinearImpulseToCenter=function(t,e){this._body&&this._body.ApplyLinearImpulse(t,this._body.GetPosition(),e)},e.applyAngularImpulse=function(t,e){this._body&&this._body.ApplyAngularImpulse(t,e)},N(t,[{key:"impl",get:function(){return this._body}},{key:"_imp",set:function(t){this._body=t}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"isAwake",get:function(){return this._body.IsAwake()}},{key:"isSleeping",get:function(){return!this._body.IsAwake()}}]),t}(),Bst=new prt.Filter;function Mst(t){var e=t.collider;return Bst.categoryBits=e.group===jrt.DEFAULT?e.body.group:e.group,Bst.maskBits=pot.instance.collisionMatrix[Bst.categoryBits],Bst}var Ost,Nst=function(){function t(){this._shapes=[],this._fixtures=[],this._collider=null,this._body=null,this._inited=!1,this._rect=new Mi}var e=t.prototype;return e.initialize=function(t){this._collider=t},e.onLoad=function(){},e.onEnable=function(){pot.instance._callAfterStep(this,this._init)},e.onDisable=function(){pot.instance._callAfterStep(this,this._destroy)},e.start=function(){},e.onGroupChanged=function(){var t=Mst(this);this._fixtures.forEach((function(e){e.SetFilterData(t)}))},e.apply=function(){this._destroy(),this._init()},e.getFixtureIndex=function(t){return this._fixtures.indexOf(t)},e._createShapes=function(){return[]},e._init=function(){var t;if(!this._inited){var e=this.collider,n=e.getComponent(nst);if(n){var i=null===(t=n.impl)||void 0===t?void 0:t.impl;if(i){for(var r=n.node.worldScale,o=0===r.x&&0===r.y?[]:this._createShapes(r.x,r.y),a=Mst(this),s=0;s<o.length;s++){var c=o[s],l={density:e.density,isSensor:e.sensor,friction:e.friction,restitution:e.restitution,shape:c,filter:a},u=i.CreateFixture(l);u.m_userData=this,n.enabledContactListener&&pot.instance.physicsWorld.registerContactFixture(u),this._shapes.push(c),this._fixtures.push(u)}this._body=i,this._inited=!0}}}},e._destroy=function(){if(this._inited){for(var t=this._fixtures,e=this._body,n=t.length-1;n>=0;n--){var i=t[n];i.m_userData=null,pot.instance.physicsWorld.unregisterContactFixture(i),e&&e.DestroyFixture(i)}this._body=null,this._fixtures.length=0,this._shapes.length=0,this._inited=!1}},N(t,[{key:"impl",get:function(){return this._shapes}},{key:"collider",get:function(){return this._collider}},{key:"worldAABB",get:function(){for(var t=1e7,e=t,n=t,i=-t,r=-t,o=this._fixtures,a=0;a<o.length;a++)for(var s=o[a],c=s.GetShape().GetChildCount(),l=0;l<c;l++){var u=s.GetAABB(l);u.lowerBound.x<e&&(e=u.lowerBound.x),u.lowerBound.y<n&&(n=u.lowerBound.y),u.upperBound.x>i&&(i=u.upperBound.x),u.upperBound.y>r&&(r=u.upperBound.y)}e*=vrt,n*=vrt,i*=vrt,r*=vrt;var h=this._rect;return h.x=e,h.y=n,h.width=i-e,h.height=r-n,h}}]),t}(),Lst=new Mi,Fst=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._worldPoints=[new li,new li,new li,new li],e}return F(e,t),e.prototype._createShapes=function(t,e){t=Math.abs(t),e=Math.abs(e);var n=this.collider,i=n.size.width/2/vrt*t,r=n.size.height/2/vrt*e,o=n.offset.x/vrt*t,a=n.offset.y/vrt*e,s=new prt.PolygonShape;return s.SetAsBox(i,r,new prt.Vec2(o,a),0),[s]},N(e,[{key:"worldPoints",get:function(){var t=Lst,e=this.collider,n=e.size,i=e.offset;t.x=i.x-n.width/2,t.y=i.y-n.height/2,t.width=n.width,t.height=n.height;var r=this._worldPoints,o=r[0],a=r[1],s=r[2],c=r[3];return t.transformMat4ToPoints(e.node.worldMatrix,o,a,s,c),r}}]),e}(Nst),zst=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._worldPosition=new li,e}return F(e,t),e.prototype._createShapes=function(t,e){t=Math.abs(t),e=Math.abs(e);var n=this.collider,i=n.offset.x/vrt*t,r=n.offset.y/vrt*e,o=new prt.CircleShape;return o.m_radius=n.radius/vrt*t,o.m_p.Set(i,r),[o]},N(e,[{key:"worldRadius",get:function(){return this._shapes[0].m_radius*vrt}},{key:"worldPosition",get:function(){var t=this._shapes[0].m_p;return this._worldPosition.set(t.x*vrt,t.y*vrt)}}]),e}(Nst),Vst=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._worldPoints=[],e}return F(e,t),e.prototype._createShapes=function(t,e){var n=[],i=this.collider,r=i.points;r.length>0&&r[0].equals(r[r.length-1])&&(r.length-=1);for(var o=Art(r),a=i.offset,s=0;s<o.length;s++){for(var c=o[s],l=null,u=[],h=null,_=0,f=c.length;_<f;_++){l||(l=new prt.PolygonShape);var p=c[_],d=(p.x+a.x)/vrt*t,m=(p.y+a.y)/vrt*e,v=new prt.Vec2(d,m);u.push(v),h||(h=v),u.length===prt.maxPolygonVertices&&(l.Set(u,u.length),n.push(l),l=null,_<f-1&&(u=[h,u[u.length-1]]))}l&&(l.Set(u,u.length),n.push(l))}return n},N(e,[{key:"worldPoints",get:function(){for(var t=this.collider,e=t.points,n=this._worldPoints,i=t.node.worldMatrix,r=0;r<e.length;r++)n[r]||(n[r]=new li),li.transformMat4(n[r],e[r],i);return n.length=e.length,this._worldPoints}}]),e}(Nst),Gst=function(){function t(){this._b2joint=null,this._jointComp=null,this._body=null,this._inited=!1}var e=t.prototype;return e.initialize=function(t){this._jointComp=t},e.onEnable=function(){pot.instance._callAfterStep(this,this._init)},e.onDisable=function(){pot.instance._callAfterStep(this,this._destroy)},e.start=function(){pot.instance._callAfterStep(this,this._init)},e._init=function(){if(!this._inited){var t=this._jointComp;if(t.isValid){this._body=t.getComponent(nst);var e=this._createJointDef();if(e){var n=t.connectedBody;n&&n.enabledInHierarchy&&(e.bodyA=this._body.impl.impl,e.bodyB=n.impl.impl,e.collideConnected=t.collideConnected,this._b2joint=pot.instance.physicsWorld.impl.CreateJoint(e),this._inited=!0)}}}},e._destroy=function(){this._inited&&(pot.instance.physicsWorld.impl.DestroyJoint(this._b2joint),this._b2joint=null,this._inited=!1)},e._createJointDef=function(){return null},e.isValid=function(){return this._b2joint&&this._body&&this._body.impl&&this._jointComp&&this._jointComp.connectedBody&&this._jointComp.connectedBody.impl},N(t,[{key:"impl",get:function(){return this._b2joint}},{key:"comp",get:function(){return this._jointComp}},{key:"body",get:function(){return this._body}}]),t}(),Ust=new prt.Vec2;function kst(t,e,n,i){var r=(i.x-n.x)*(t.y-n.y)-(i.y-n.y)*(t.x-n.x),o=(e.x-t.x)*(t.y-n.y)-(e.y-t.y)*(t.x-n.x),a=(i.y-n.y)*(e.x-t.x)-(i.x-n.x)*(e.y-t.y);if(0!==a){var s=r/a,c=o/a;if(s>=0&&s<=1&&c>=0&&c<=1)return!0}return!1}Ost={PhysicsWorld:Ist,RigidBody:Dst,BoxShape:Fst,CircleShape:zst,PolygonShape:Vst,MouseJoint:function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._touchPoint=new li,e._isTouched=!1,e}F(e,t);var n=e.prototype;return n.setTarget=function(t){this._b2joint&&(Ust.x=t.x/vrt,Ust.y=t.y/vrt,this._b2joint.SetTarget(Ust))},n.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetDampingRatio(t)},n.setFrequency=function(t){this._b2joint&&this._b2joint.SetFrequency(t)},n.setMaxForce=function(t){this._b2joint&&this._b2joint.SetMaxForce(t)},n._createJointDef=function(){var t=new prt.MouseJointDef,e=this._jointComp;return t.target.Set(this._touchPoint.x/vrt,this._touchPoint.y/vrt),t.maxForce=e.maxForce,t.dampingRatio=e.dampingRatio,t.frequencyHz=e.frequency,t},n.initialize=function(e){t.prototype.initialize.call(this,e);var n=NR("Canvas");n&&(n.on(RC.TOUCH_START,this.onTouchBegan,this),n.on(RC.TOUCH_MOVE,this.onTouchMove,this),n.on(RC.TOUCH_END,this.onTouchEnd,this),n.on(RC.TOUCH_CANCEL,this.onTouchEnd,this))},n.onEnable=function(){},n.start=function(){},n.onTouchBegan=function(t){this._isTouched=!0;var e=this._touchPoint.set(t.getUILocation()),n=pot.instance.physicsWorld.testPoint(e);if(!(n.length<=0)){var i=n[0].body;i.wakeUp();var r=this._jointComp;r.connectedBody=i,this._init(),this.setMaxForce(r.maxForce*i.getMass()),this.setTarget(e)}},n.onTouchMove=function(t){this._touchPoint=t.getUILocation()},n.onTouchEnd=function(){this._destroy(),this._isTouched=!1},n.update=function(){this._isTouched&&this.isValid()&&this.setTarget(this._touchPoint)},e}(Gst),DistanceJoint:function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.setMaxLength=function(t){this._b2joint&&this._b2joint.SetMaxLength(t)},n._createJointDef=function(){var t=this._jointComp,e=new prt.RopeJointDef;return e.localAnchorA.Set(t.anchor.x/vrt,t.anchor.y/vrt),e.localAnchorB.Set(t.connectedAnchor.x/vrt,t.connectedAnchor.y/vrt),e.maxLength=t.maxLength/vrt,e},e}(Gst),SpringJoint:function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetDampingRatio(t)},n.setFrequency=function(t){this._b2joint&&this._b2joint.SetFrequency(t)},n.setDistance=function(t){this._b2joint&&this._b2joint.SetLength(t)},n._createJointDef=function(){var t=this._jointComp,e=new prt.DistanceJointDef;return e.localAnchorA.Set(t.anchor.x/vrt,t.anchor.y/vrt),e.localAnchorB.Set(t.connectedAnchor.x/vrt,t.connectedAnchor.y/vrt),e.length=t.distance/vrt,e.dampingRatio=t.dampingRatio,e.frequencyHz=t.frequency,e},e}(Gst),RelativeJoint:function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.setMaxForce=function(t){this._b2joint&&this._b2joint.SetMaxForce(t)},n.setAngularOffset=function(t){this._b2joint&&this._b2joint.SetAngularOffset(jn(t))},n.setLinearOffset=function(t){this._b2joint&&this._b2joint.SetLinearOffset(new prt.Vec2(t.x/vrt,t.y/vrt))},n.setCorrectionFactor=function(t){this._b2joint&&(this._b2joint.m_correctionFactor=t)},n.setMaxTorque=function(t){this._b2joint&&this._b2joint.SetMaxTorque(t)},n._createJointDef=function(){var t=this._jointComp,e=new prt.MotorJointDef;return e.linearOffset.Set(t.linearOffset.x/vrt,t.linearOffset.y/vrt),e.angularOffset=jn(t.angularOffset),e.maxForce=t.maxForce,e.maxTorque=t.maxTorque,e.correctionFactor=t.correctionFactor,e},e}(Gst),SliderJoint:function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.enableLimit=function(t){this._b2joint&&this._b2joint.EnableLimit(t)},n.setLowerLimit=function(){this.updateLimits()},n.setUpperLimit=function(){this.updateLimits()},n.updateLimits=function(){if(this._b2joint){var t=this._jointComp;this._b2joint.SetLimits(t.lowerLimit/vrt,t.upperLimit/vrt)}},n.enableMotor=function(t){this._b2joint&&this._b2joint.EnableMotor(t)},n.setMaxMotorForce=function(t){this._b2joint&&this._b2joint.SetMaxMotorForce(t)},n.setMotorSpeed=function(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)},n._createJointDef=function(){var t=this._jointComp,e=new prt.PrismaticJointDef;e.localAnchorA.Set(t.anchor.x/vrt,t.anchor.y/vrt),e.localAnchorB.Set(t.connectedAnchor.x/vrt,t.connectedAnchor.y/vrt);var n=jn(t.angle);return e.localAxisA.Set(Math.cos(n),Math.sin(n)),e.referenceAngle=0,e.enableLimit=t.enableLimit,e.lowerTranslation=t.lowerLimit/vrt,e.upperTranslation=t.upperLimit/vrt,e.enableMotor=t.enableMotor,e.maxMotorForce=t.maxMotorForce,e.motorSpeed=t.motorSpeed,e},e}(Gst),FixedJoint:function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.setFrequency=function(t){this._b2joint&&this._b2joint.SetFrequency(t)},n.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetDampingRatio(t)},n._createJointDef=function(){var t=this._jointComp,e=new prt.WeldJointDef;return e.localAnchorA.Set(t.anchor.x/vrt,t.anchor.y/vrt),e.localAnchorB.Set(t.connectedAnchor.x/vrt,t.connectedAnchor.y/vrt),e.referenceAngle=0,e.frequencyHz=t.frequency,e.dampingRatio=t.dampingRatio,e},e}(Gst),WheelJoint:function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetSpringDampingRatio(t)},n.setFrequency=function(t){this._b2joint&&this._b2joint.SetSpringFrequencyHz(t)},n.enableMotor=function(t){this._b2joint&&this._b2joint.EnableMotor(t)},n.setMaxMotorTorque=function(t){this._b2joint&&this._b2joint.SetMaxMotorTorque(t)},n.setMotorSpeed=function(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)},n._createJointDef=function(){var t=this._jointComp,e=new prt.WheelJointDef;e.localAnchorA.Set(t.anchor.x/vrt,t.anchor.y/vrt),e.localAnchorB.Set(t.connectedAnchor.x/vrt,t.connectedAnchor.y/vrt);var n=jn(t.angle);return e.localAxisA.Set(Math.cos(n),Math.sin(n)),e.maxMotorTorque=t.maxMotorTorque,e.motorSpeed=jn(t.motorSpeed),e.enableMotor=t.enableMotor,e.dampingRatio=t.dampingRatio,e.frequencyHz=t.frequency,e},e}(Gst),HingeJoint:function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.enableLimit=function(t){this._b2joint&&this._b2joint.EnableLimit(t)},n.setLowerAngle=function(){this.updateLimits()},n.setUpperAngle=function(){this.updateLimits()},n.updateLimits=function(){if(this._b2joint){var t=this._jointComp;this._b2joint.SetLimits(jn(t.lowerAngle),jn(t.upperAngle))}},n.enableMotor=function(t){this._b2joint&&this._b2joint.EnableMotor(t)},n.setMaxMotorTorque=function(t){this._b2joint&&this._b2joint.SetMaxMotorTorque(t)},n.setMotorSpeed=function(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)},n._createJointDef=function(){var t=this._jointComp,e=new prt.RevoluteJointDef;return e.localAnchorA.Set(t.anchor.x/vrt,t.anchor.y/vrt),e.localAnchorB.Set(t.connectedAnchor.x/vrt,t.connectedAnchor.y/vrt),e.enableMotor=t.enableMotor,e.maxMotorTorque=t.maxMotorTorque,e.motorSpeed=jn(t.motorSpeed),e.enableLimit=t.enableLimit,e.lowerAngle=t.lowerAngle,e.upperAngle=t.upperAngle,e},e}(Gst)},nrt="box2d",i._global.CC_PHYSICS_2D_BUILTIN=!1,i._global.CC_PHYSICS_2D_BOX2D=!0,ert=Ost;var Hst=new li,jst=new li,Wst=new li,qst=new li;function Xst(t,e,n){for(var i=n.length,r=0;r<i;++r)if(kst(t,e,n[r],n[(r+1)%i]))return!0;return!1}function Yst(t,e){for(var n=!1,i=t.x,r=t.y,o=e.length,a=0,s=o-1;a<o;s=a++){var c=e[a].x,l=e[a].y,u=e[s].x,h=e[s].y;l>r!=h>r&&i<(u-c)*(r-l)/(h-l)+c&&(n=!n)}return n}function Kst(t,e,n,i){var r,o=n.x-e.x,a=n.y-e.y,s=o*o+a*a,c=((t.x-e.x)*o+(t.y-e.y)*a)/s;return r=i?s?c<0?e:c>1?n:Hst.set(e.x+c*o,e.y+c*a):e:Hst.set(e.x+c*o,e.y+c*a),o=t.x-r.x,a=t.y-r.y,Math.sqrt(o*o+a*a)}var Jst=t("Intersection2D",(function(){}));Jst.lineLine=kst,Jst.lineRect=function(t,e,n){var i=Hst.set(n.x,n.y),r=jst.set(n.x,n.yMax),o=Wst.set(n.xMax,n.yMax),a=qst.set(n.xMax,n.y);return!!(kst(t,e,i,r)||kst(t,e,r,o)||kst(t,e,o,a)||kst(t,e,a,i))},Jst.linePolygon=Xst,Jst.rectRect=function(t,e){var n=t.x,i=t.y,r=t.x+t.width,o=t.y+t.height,a=e.x,s=e.y,c=e.x+e.width,l=e.y+e.height;return n<=c&&r>=a&&i<=l&&o>=s},Jst.rectPolygon=function(t,e){var n=Hst.set(t.x,t.y),i=jst.set(t.x,t.yMax),r=Wst.set(t.xMax,t.yMax),o=qst.set(t.xMax,t.y);if(Xst(n,i,e))return!0;if(Xst(i,r,e))return!0;if(Xst(r,o,e))return!0;if(Xst(o,n,e))return!0;for(var a=0,s=e.length;a<s;++a)if(t.contains(e[a]))return!0;return!!(Yst(n,e)||Yst(i,e)||Yst(r,e)||Yst(o,e))},Jst.rectCircle=function(t,e,n){var i=e.x,r=e.y,o=t.x,a=t.y,s=t.width,c=t.height,l=i,u=r;i<o?l=o:i>o+s&&(l=o+s),r<a?u=a:r>a+c&&(u=a+c);var h=i-l,_=r-u;return Math.sqrt(h*h+_*_)<=n},Jst.polygonPolygon=function(t,e){var n,i;for(n=0,i=t.length;n<i;++n)if(Xst(t[n],t[(n+1)%i],e))return!0;for(n=0,i=e.length;n<i;++n)if(Yst(e[n],t))return!0;for(n=0,i=t.length;n<i;++n)if(Yst(t[n],e))return!0;return!1},Jst.circleCircle=function(t,e,n,i){return li.distance(t,n)<e+i},Jst.polygonCircle=function(t,e,n){var i=e;if(Yst(i,t))return!0;for(var r=0,o=t.length;r<o;r++)if(Kst(i,0===r?t[t.length-1]:t[r-1],t[r],!0)<n)return!0;return!1},Jst.pointInPolygon=Yst,Jst.pointLineDistance=Kst;var Qst,Zst,$st,tct,ect,nct=function(){function t(){this._arrayBufferOrPaddings=[],this._length=0}var e=t.prototype;return e.setNextAlignment=function(t){if(0!==t){var e=this._length%t;if(0!==e){var n=t-e;this._arrayBufferOrPaddings.push(n),this._length+=n}}},e.addBuffer=function(t){var e=this._length;return this._arrayBufferOrPaddings.push(t),this._length+=t.byteLength,e},e.getLength=function(){return this._length},e.getCombined=function(){var t=new Uint8Array(this._length),e=0;return this._arrayBufferOrPaddings.forEach((function(n){"number"==typeof n?e+=n:(t.set(new Uint8Array(n),e),e+=n.byteLength)})),t.buffer},t}(),ict=function(){function t(t,e){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=t,this._mesh.struct.morph){var n=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(n).fill(null);for(var i=0;i<n;++i){var r=this._mesh.struct.morph.subMeshMorphs[i];r&&(r.targets.length>$p.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[i]=new oct(this._mesh,i,this._mesh.struct.morph,e):this._subMeshRenderings[i]=new rct(this._mesh,i,this._mesh.struct.morph,e))}}}return t.prototype.createInstance=function(){for(var t=this,e=this._mesh.struct.primitives.length,n=new Array(e),i=0;i<e;++i){var r,o;n[i]=null!==(r=null===(o=this._subMeshRenderings[i])||void 0===o?void 0:o.createInstance())&&void 0!==r?r:null}return{setWeights:function(t,e){var i;null===(i=n[t])||void 0===i||i.setWeights(e)},requiredPatches:function(e){t._mesh.struct.morph;var i=t._mesh.struct.morph.subMeshMorphs[e],r=n[e];if(null===r)return null;var o=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(Zr.ATTR_POSITION)&&o.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(Zr.ATTR_NORMAL)&&o.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(Zr.ATTR_TANGENT)&&o.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),o.push.apply(o,r.requiredPatches()),o},adaptPipelineState:function(t,e){var i;null===(i=n[t])||void 0===i||i.adaptPipelineState(e)},destroy:function(){for(var t,e=W(n);!(t=e()).done;){var i=t.value;null==i||i.destroy()}}}},t}(),rct=function(){function t(t,e,n,i){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=i;var r=n.subMeshMorphs[e];this._subMeshMorph=r,lct(t,e,i);var o=t.struct.vertexBundles[t.struct.primitives[e].vertexBundelIndices[0]].view.count;this._verticesCount=o;var a=r.targets.length,s=cct(i,o*a);this._textureInfo={width:s.width,height:s.height},this._attributes=r.attributes.map((function(e,n){var i=s.create(),a=i.valueView;return r.targets.forEach((function(e,i){for(var r=e.displacements[n],s=new Float32Array(t.data.buffer,t.data.byteOffset+r.offset,r.count),c=o*i*4,l=0;l<o;++l)a[c+4*l+0]=s[3*l+0],a[c+4*l+1]=s[3*l+1],a[c+4*l+2]=s[3*l+2]})),i.updatePixels(),{name:e,morphTexture:i}}))}var e=t.prototype;return e.destroy=function(){for(var t,e=W(this._attributes);!(t=e()).done;)t.value.morphTexture.destroy()},e.createInstance=function(){var t=this,e=new sct(this._gfxDevice,this._subMeshMorph.targets.length);return e.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),e.setVerticesCount(this._verticesCount),e.commit(),{setWeights:function(t){e.setWeights(t),e.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(n){for(var i,r=W(t._attributes);!(i=r()).done;){var o=i.value,a=void 0;switch(o.name){case Zr.ATTR_POSITION:a=rd;break;case Zr.ATTR_NORMAL:a=sd;break;case Zr.ATTR_TANGENT:a=ud;break;default:p("Unexpected attribute!")}void 0!==a&&(n.bindSampler(a,o.morphTexture.sampler),n.bindTexture(a,o.morphTexture.texture))}n.bindBuffer($p.BINDING,e.buffer),n.update()},destroy:function(){}}},t}(),oct=function(){function t(t,e,n,i){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=i;var r=n.subMeshMorphs[e];lct(t,e,i),this._attributes=r.attributes.map((function(e,n){return{name:e,targets:r.targets.map((function(e){return{displacements:new Float32Array(t.data.buffer,t.data.byteOffset+e.displacements[n].offset,e.displacements[n].count)}}))}}))}return t.prototype.createInstance=function(){return new act(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},N(t,[{key:"data",get:function(){return this._attributes}}]),t}(),act=function(){function t(t,e,n){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=t,this._morphUniforms=new sct(n,0);var i=cct(n,e);this._morphUniforms.setMorphTextureInfo(i.width,i.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(t){var e=i.create();return{attributeName:t.name,morphTexture:e}}))}var e=t.prototype;return e.setWeights=function(t){for(var e=0;e<this._attributes.length;++e){var n=this._attributes[e],i=n.morphTexture.valueView,r=this._owner.data[e];t.length,r.targets.length;for(var o=0;o<r.targets.length;++o){var a=r.targets[o].displacements,s=t[o],c=a.length/3;if(0===o)for(var l=0;l<c;++l)i[4*l+0]=a[3*l+0]*s,i[4*l+1]=a[3*l+1]*s,i[4*l+2]=a[3*l+2]*s;else if(0!==s)for(var u=0;u<c;++u)i[4*u+0]+=a[3*u+0]*s,i[4*u+1]+=a[3*u+1]*s,i[4*u+2]+=a[3*u+2]*s}n.morphTexture.updatePixels()}},e.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},e.adaptPipelineState=function(t){for(var e,n=W(this._attributes);!(e=n()).done;){var i=e.value,r=void 0;switch(i.attributeName){case Zr.ATTR_POSITION:r=rd;break;case Zr.ATTR_NORMAL:r=sd;break;case Zr.ATTR_TANGENT:r=ud;break;default:p("Unexpected attribute!")}void 0!==r&&(t.bindSampler(r,i.morphTexture.sampler),t.bindTexture(r,i.morphTexture.texture))}t.bindBuffer($p.BINDING,this._morphUniforms.buffer),t.update()},e.destroy=function(){this._morphUniforms.destroy();for(var t=0;t<this._attributes.length;++t)this._attributes[t].morphTexture.destroy()},t}(),sct=function(){function t(t,e){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=e,this._localBuffer=new DataView(new ArrayBuffer($p.SIZE)),this._remoteBuffer=t.createBuffer(new po(mr.UNIFORM|mr.TRANSFER_DST,yr.HOST|yr.DEVICE,$p.SIZE,$p.SIZE))}var e=t.prototype;return e.destroy=function(){this._remoteBuffer.destroy()},e.setWeights=function(t){t.length,this._targetCount;for(var e=0;e<t.length;++e)this._localBuffer.setFloat32($p.OFFSET_OF_WEIGHTS+4*e,t[e],i.sys.isLittleEndian)},e.setMorphTextureInfo=function(t,e){this._localBuffer.setFloat32($p.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,t,i.sys.isLittleEndian),this._localBuffer.setFloat32($p.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,e,i.sys.isLittleEndian)},e.setVerticesCount=function(t){this._localBuffer.setFloat32($p.OFFSET_OF_VERTICES_COUNT,t,i.sys.isLittleEndian)},e.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer)},N(t,[{key:"buffer",get:function(){return this._remoteBuffer}}]),t}();function cct(t,e){var n,i,r,o;t.hasFeature(_r.TEXTURE_FLOAT)?(n=e,r=16,i=jm.PixelFormat.RGBA32F,o=Float32Array):(n=4*e,r=4,i=jm.PixelFormat.RGBA8888,o=Uint8Array);var a=function(t){t<5&&(t=5);var e=Dn(Mn(t)),n=e>>1;return{width:1<<(1&e?n+1:n),height:1<<n}}(n),s=a.width,c=a.height;return{width:s,height:c,create:function(){var e=new ArrayBuffer(s*c*r),n=new Float32Array(e),a=o===Float32Array?n:new o(e),l=new ym({width:s,height:c,_data:a,_compressed:!1,format:i}),u=new jm;u.setFilters(jm.Filter.NEAREST,jm.Filter.NEAREST),u.setMipFilter(jm.Filter.NONE),u.setWrapMode(jm.WrapMode.CLAMP_TO_EDGE,jm.WrapMode.CLAMP_TO_EDGE,jm.WrapMode.CLAMP_TO_EDGE),u.image=l,u.getGFXTexture()||p("Unexpected: failed to create morph texture?");var h=t.getSampler(u.getSamplerInfo());return{get texture(){return u.getGFXTexture()},get sampler(){return h},get valueView(){return n},destroy:function(){u.destroy()},updatePixels:function(){u.uploadData(a)}}}}}function lct(t,e,n){t.renderingSubMeshes[e].enableVertexIdChannel(n)}function uct(t){switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var hct=new oi,_ct=new oi,fct=new Uint8Array,pct=qc("cc.Mesh")((ect=function(t){function e(){var e;return(e=t.call(this)||this).morphRendering=null,q(e,"_struct",$st,H(e)),q(e,"_hash",tct,H(e)),e._data=fct,e._initialized=!1,e._renderingSubMeshes=null,e._boneSpaceBounds=new Map,e._jointBufferIndices=null,e}F(e,t);var n=e.prototype;return n.onLoaded=function(){this.initialize()},n.initialize=function(){if(!this._initialized){this._initialized=!0;for(var t=this._data.buffer,e=i.director.root.device,n=this._createVertexBuffers(e,t),r=[],o=0;o<this._struct.primitives.length;o++){var a=this._struct.primitives[o];if(0!==a.vertexBundelIndices.length){var s=null,c=null;if(a.indexView){var l=a.indexView,u=l.stride,h=l.length;if(4===u&&!e.hasFeature(_r.ELEMENT_INDEX_UINT)){var _=this._struct.vertexBundles[a.vertexBundelIndices[0]].view.count;if(_>=65536){b(10001,_,65536);continue}u>>=1,h>>=1}s=e.createBuffer(new po(mr.INDEX,yr.DEVICE,h,u)),c=new(uct(l.stride))(t,l.offset,l.count),l.stride!==u&&(c=uct(u).from(c)),s.update(c)}var f=a.vertexBundelIndices.map((function(t){return n[t]})),p=[];if(a.vertexBundelIndices.length>0)for(var d=a.vertexBundelIndices[0],m=this._struct.vertexBundles[d].attributes,v=0;v<m.length;++v){var g=m[v];p[v]=new Bo(g.name,g.format,g.isNormalized,g.stream,g.isInstanced,g.location)}var y=new PE(f,p,a.primitiveMode,s);y.mesh=this,y.subMeshIdx=o,r.push(y)}}this._renderingSubMeshes=r,this._struct.morph&&(this.morphRendering=function(t,e){return new ict(t,e)}(this,e))}},n.destroy=function(){return this.destroyRenderingMesh(),t.prototype.destroy.call(this)},n.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var t=0;t<this._renderingSubMeshes.length;t++)this._renderingSubMeshes[t].destroy();this._renderingSubMeshes=null,this._initialized=!1}},n.assign=function(t,e){this.reset({struct:t,data:e})},n.reset=function(t){this.destroyRenderingMesh(),this._struct=t.struct,this._data=t.data,this._hash=0},n.getBoneSpaceBounds=function(t){if(this._boneSpaceBounds.has(t.hash))return this._boneSpaceBounds.get(t.hash);var e=[];this._boneSpaceBounds.set(t.hash,e);for(var n=[],i=t.bindposes,r=0;r<i.length;r++)e.push(new Cc(1/0,1/0,1/0,-1/0,-1/0,-1/0)),n.push(!1);for(var o=this._struct.primitives,a=0;a<o.length;a++){var s=this.readAttribute(a,Zr.ATTR_JOINTS),c=this.readAttribute(a,Zr.ATTR_WEIGHTS),l=this.readAttribute(a,Zr.ATTR_POSITION);if(s&&c&&l)for(var u=Math.min(s.length/4,c.length/4,l.length/3),h=0;h<u;h++){oi.set(hct,l[3*h+0],l[3*h+1],l[3*h+2]);for(var _=0;_<4;++_){var f=4*h+_,p=s[f];if(!(0===c[f]||p>=i.length)){oi.transformMat4(_ct,hct,i[p]),n[p]=!0;var d=e[p];oi.min(d.center,d.center,_ct),oi.max(d.halfExtents,d.halfExtents,_ct)}}}}for(var m=0;m<i.length;m++){var v=e[m];n[m]?Cc.fromPoints(v,v.center,v.halfExtents):e[m]=null}return e},n.merge=function(t,e,n){if(n&&!this.validateMergingMesh(t))return!1;var i=new oi,r=e&&new gi,o=e&&new Cc;if(r&&e.getRotation(r),!this._initialized){var a=JSON.parse(JSON.stringify(t._struct)),s=t._data.slice();if(e){a.maxPosition&&a.minPosition&&(oi.add(o.center,a.maxPosition,a.minPosition),oi.multiplyScalar(o.center,o.center,.5),oi.subtract(o.halfExtents,a.maxPosition,a.minPosition),oi.multiplyScalar(o.halfExtents,o.halfExtents,.5),Cc.transform(o,o,e),oi.add(a.maxPosition,o.center,o.halfExtents),oi.subtract(a.minPosition,o.center,o.halfExtents));for(var c=0;c<a.vertexBundles.length;c++)for(var l=a.vertexBundles[c],u=0;u<l.attributes.length;u++)if(l.attributes[u].name===Zr.ATTR_POSITION||l.attributes[u].name===Zr.ATTR_NORMAL){var h=l.attributes[u].format,_=new DataView(s.buffer,l.view.offset+dct(l.attributes,u)),f=gct(_,h),p=yct(_,h);if(!f||!p)continue;for(var d=l.view.count,m=l.view.stride,v=vct(h),g=0;g<d;g++){var y=g*m,x=y+v,S=x+v;switch(i.set(f(y),f(x),f(S)),l.attributes[u].name){case Zr.ATTR_POSITION:i.transformMat4(e);break;case Zr.ATTR_NORMAL:oi.transformQuat(i,i,r)}p(y,i.x),p(x,i.y),p(S,i.z)}}}return this.reset({struct:a,data:s}),this.initialize(),!0}for(var A,C,b,T,E,w=new nct,P=0,I=0,R=0,D=0,B=0,M=0,O=0,N=0,L=!1,F=new Array(this._struct.vertexBundles.length),z=0;z<this._struct.vertexBundles.length;++z){var V=this._struct.vertexBundles[z],G=t._struct.vertexBundles[z];R=V.view.offset,D=G.view.offset,I=V.view.stride,P=V.view.count+G.view.count,A=new ArrayBuffer(P*I),C=new Uint8Array(A),R+=(b=this._data.subarray(R,R+V.view.length)).length,D+=(T=t._data.subarray(D,D+G.view.length)).length,C.set(b),B=0;for(var U,k=W(V.attributes);!(U=k()).done;){var H=U.value;O=0,L=!1;for(var j,q=W(G.attributes);!(j=q()).done;){var X=j.value;if(H.name===X.name&&H.format===X.format){L=!0;break}O+=na[X.format].size}if(L){N=na[H.format].size,M=V.view.length+B;for(var Y=0;Y<G.view.count;++Y){if(E=T.subarray(O,O+N),C.set(E,M),(H.name===Zr.ATTR_POSITION||H.name===Zr.ATTR_NORMAL)&&e){var K=new Float32Array(C.buffer,M,3);switch(i.set(K[0],K[1],K[2]),H.name){case Zr.ATTR_POSITION:i.transformMat4(e);break;case Zr.ATTR_NORMAL:oi.transformQuat(i,i,r)}K[0]=i.x,K[1]=i.y,K[2]=i.z}M+=V.view.stride,O+=G.view.stride}}B+=na[H.format].size}F[z]={attributes:V.attributes,view:{offset:w.getLength(),length:A.byteLength,count:P,stride:I}},w.addBuffer(A)}for(var J,Q,Z,$=0,tt=2,et=0,nt=new Array(this._struct.primitives.length),it=0;it<this._struct.primitives.length;++it){var rt=this._struct.primitives[it],ot=t._struct.primitives[it];nt[it]={primitiveMode:rt.primitiveMode,vertexBundelIndices:rt.vertexBundelIndices};for(var at,st=W(rt.vertexBundelIndices);!(at=st()).done;){var ct=at.value;et=Math.max(et,this._struct.vertexBundles[ct].view.count)}if(rt.indexView&&ot.indexView){$=rt.indexView.count,$+=ot.indexView.count,R=rt.indexView.offset,D=ot.indexView.offset,tt=$<256?1:$<65536?2:4;var lt=new ArrayBuffer($*tt);if(J=2===tt?new Uint16Array(lt):1===tt?new Uint8Array(lt):new Uint32Array(lt),Q=2===rt.indexView.stride?new Uint16Array(this._data.buffer,R,rt.indexView.count):1===rt.indexView.stride?new Uint8Array(this._data.buffer,R,rt.indexView.count):new Uint32Array(this._data.buffer,R,rt.indexView.count),tt===rt.indexView.stride)J.set(Q);else for(var ut=0;ut<rt.indexView.count;++ut)J[ut]=Q[ut];R+=rt.indexView.length,Z=2===ot.indexView.stride?new Uint16Array(t._data.buffer,D,ot.indexView.count):1===ot.indexView.stride?new Uint8Array(t._data.buffer,D,ot.indexView.count):new Uint32Array(t._data.buffer,D,ot.indexView.count);for(var ht=0;ht<ot.indexView.count;++ht)J[rt.indexView.count+ht]=et+Z[ht];D+=ot.indexView.length,nt[it].indexView={offset:w.getLength(),length:lt.byteLength,count:$,stride:tt},w.setNextAlignment(tt),w.addBuffer(lt)}}var _t={vertexBundles:F,primitives:nt,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return _t.minPosition&&t._struct.minPosition&&_t.maxPosition&&t._struct.maxPosition&&(e?(oi.add(o.center,t._struct.maxPosition,t._struct.minPosition),oi.multiplyScalar(o.center,o.center,.5),oi.subtract(o.halfExtents,t._struct.maxPosition,t._struct.minPosition),oi.multiplyScalar(o.halfExtents,o.halfExtents,.5),Cc.transform(o,o,e),oi.add(i,o.center,o.halfExtents),oi.max(_t.maxPosition,_t.maxPosition,i),oi.subtract(i,o.center,o.halfExtents),oi.min(_t.minPosition,_t.minPosition,i)):(oi.min(_t.minPosition,_t.minPosition,t._struct.minPosition),oi.max(_t.maxPosition,_t.maxPosition,t._struct.maxPosition))),this.reset({struct:_t,data:new Uint8Array(w.getCombined())}),this.initialize(),!0},n.validateMergingMesh=function(t){if(this._struct.vertexBundles.length!==t._struct.vertexBundles.length)return!1;for(var e=0;e<this._struct.vertexBundles.length;++e){var n=this._struct.vertexBundles[e],i=t._struct.vertexBundles[e];if(n.attributes.length!==i.attributes.length)return!1;for(var r=0;r<n.attributes.length;++r)if(n.attributes[r].format!==i.attributes[r].format)return!1}if(this._struct.primitives.length!==t._struct.primitives.length)return!1;for(var o=0;o<this._struct.primitives.length;++o){var a=this._struct.primitives[o],s=t._struct.primitives[o];if(a.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var c=0;c<a.vertexBundelIndices.length;++c)if(a.vertexBundelIndices[c]!==s.vertexBundelIndices[c])return!1;if(a.primitiveMode!==s.primitiveMode)return!1;if(a.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0},n.readAttribute=function(t,e){var n=this,i=null;return this._accessAttribute(t,e,(function(t,e){var r=t.view.count,o=t.attributes[e].format,a=ha(na[o]);if(0!==r){var s=new DataView(n._data.buffer,t.view.offset+dct(t.attributes,e)),c=na[o],l=gct(s,o);if(a&&l){for(var u=c.count,h=new a(r*u),_=t.view.stride,f=0;f<r;++f)for(var p=0;p<u;++p)h[u*f+p]=l(_*f+h.BYTES_PER_ELEMENT*p);i=h}}})),i},n.copyAttribute=function(t,e,n,i,r){var o=this,a=!1;return this._accessAttribute(t,e,(function(t,e){var s=t.view.count;if(0!==s){var c=t.attributes[e].format,l=new DataView(o._data.buffer,t.view.offset+dct(t.attributes,e)),u=new DataView(n,r),h=na[c],_=gct(l,c),f=yct(u,c);if(_&&f){for(var p=h.count,d=t.view.stride,m=vct(c),v=i,g=m,y=0;y<s;++y)for(var x=0;x<p;++x)f(v*y+g*x,_(d*y+m*x));a=!0}}else a=!0})),a},n.readIndices=function(t){if(t>=this._struct.primitives.length)return null;var e=this._struct.primitives[t];if(!e.indexView)return null;var n=e.indexView.stride;return new(1===n?Uint8Array:2===n?Uint16Array:Uint32Array)(this._data.buffer,e.indexView.offset,e.indexView.count)},n.copyIndices=function(t,e){if(t>=this._struct.primitives.length)return!1;var n=this._struct.primitives[t];if(!n.indexView)return!1;for(var i=n.indexView.count,r=1===n.indexView.stride?fr.R8UI:2===n.indexView.stride?fr.R16UI:fr.R32UI,o=gct(new DataView(this._data.buffer),r),a=0;a<i;++a)e[a]=o(n.indexView.offset+na[r].size*a);return!0},n._accessAttribute=function(t,e,n){if(!(t>=this._struct.primitives.length))for(var i,r=W(this._struct.primitives[t].vertexBundelIndices);!(i=r()).done;){var o=i.value,a=this._struct.vertexBundles[o],s=a.attributes.findIndex((function(t){return t.name===e}));if(!(s<0)){n(a,s);break}}},n._createVertexBuffers=function(t,e){return this._struct.vertexBundles.map((function(n){var i=t.createBuffer(new po(mr.VERTEX,yr.DEVICE,n.view.length,n.view.stride)),r=new Uint8Array(e,n.view.offset,n.view.length);return i.update(r),i}))},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.reset({struct:{vertexBundles:[],primitives:[]},data:fct})},N(e,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(t){this._data=new Uint8Array(t)}},{key:"subMeshCount",get:function(){var t=this.renderingSubMeshes;return t?t.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=xa(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(t){return t.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),e}(Su),$st=X((Zst=ect).prototype,"_struct",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),tct=X(Zst.prototype,"_hash",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Qst=Zst))||Qst;function dct(t,e){for(var n=0,i=0;i<e;++i){var r=t[i];n+=na[r.format].size}return n}i.Mesh=pct;var mct=Zu.isLittleEndian;function vct(t){var e=na[t];return e.size/e.count}function gct(t,e){var n=na[e],i=n.size/n.count;switch(n.type){case pr.UNORM:switch(i){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,mct)};case 4:return function(e){return t.getUint32(e,mct)}}break;case pr.SNORM:case pr.INT:switch(i){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,mct)};case 4:return function(e){return t.getInt32(e,mct)}}break;case pr.UINT:switch(i){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,mct)};case 4:return function(e){return t.getUint32(e,mct)}}break;case pr.FLOAT:return function(e){return t.getFloat32(e,mct)}}return null}function yct(t,e){var n=na[e],i=n.size/n.count;switch(n.type){case pr.UNORM:switch(i){case 1:return function(e,n){return t.setUint8(e,n)};case 2:return function(e,n){return t.setUint16(e,n,mct)};case 4:return function(e,n){return t.setUint32(e,n,mct)}}break;case pr.SNORM:case pr.INT:switch(i){case 1:return function(e,n){return t.setInt8(e,n)};case 2:return function(e,n){return t.setInt16(e,n,mct)};case 4:return function(e,n){return t.setInt32(e,n,mct)}}break;case pr.UINT:switch(i){case 1:return function(e,n){return t.setUint8(e,n)};case 2:return function(e,n){return t.setUint16(e,n,mct)};case 4:return function(e,n){return t.setUint32(e,n,mct)}}break;case pr.FLOAT:return function(e,n){return t.setFloat32(e,n,mct)}}return null}var xct,Sct,Act,Cct,bct,Tct,Ect,wct,Pct,Ict,Rct,Dct,Bct,Mct,Oct,Nct,Lct,Fct,zct,Vct,Gct,Uct,kct,Hct,jct,Wct,qct,Xct,Yct,Kct,Jct,Qct,Zct=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._morphRenderingInstance=null,e._usedMaterials=new Set,e}F(e,t);var n=e.prototype;return n.getMacroPatches=function(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):t.prototype.getMacroPatches.call(this,e)},n.initSubModel=function(e,n,i){return t.prototype.initSubModel.call(this,e,n,this._launderMaterial(i))},n.destroy=function(){t.prototype.destroy.call(this),this._morphRenderingInstance=null},n.setSubModelMaterial=function(e,n){return t.prototype.setSubModelMaterial.call(this,e,this._launderMaterial(n))},n._updateLocalDescriptors=function(e,n){t.prototype._updateLocalDescriptors.call(this,e,n),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(e,n)},n._launderMaterial=function(t){return t},n.setMorphRendering=function(t){this._morphRenderingInstance=t},e}(qv),$ct=Jt({OFF:0,ON:1}),tlt=Jt({OFF:0,ON:1}),elt=(xct=qc("cc.ModelLightmapSettings"),Sct=$c("_recieveShadow"),xct((Rct=function(){function t(){q(this,"texture",bct,this),q(this,"uvParam",Tct,this),q(this,"_bakeable",Ect,this),q(this,"_castShadow",wct,this),q(this,"_receiveShadow",Pct,this),q(this,"_lightmapSize",Ict,this)}return N(t,[{key:"bakeable",get:function(){return this._bakeable},set:function(t){this._bakeable=t}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._receiveShadow=t}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(t){this._lightmapSize=t}}]),t}(),bct=X((Cct=Rct).prototype,"texture",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tct=X(Cct.prototype,"uvParam",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new fi}}),Ect=X(Cct.prototype,"_bakeable",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wct=X(Cct.prototype,"_castShadow",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Pct=X(Cct.prototype,"_receiveShadow",[Sct],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ict=X(Cct.prototype,"_lightmapSize",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),X(Cct.prototype,"bakeable",[ll],Object.getOwnPropertyDescriptor(Cct.prototype,"bakeable"),Cct.prototype),X(Cct.prototype,"castShadow",[ll],Object.getOwnPropertyDescriptor(Cct.prototype,"castShadow"),Cct.prototype),X(Cct.prototype,"receiveShadow",[ll],Object.getOwnPropertyDescriptor(Cct.prototype,"receiveShadow"),Cct.prototype),X(Cct.prototype,"lightmapSize",[ll],Object.getOwnPropertyDescriptor(Cct.prototype,"lightmapSize"),Cct.prototype),Act=Cct))||Act),nlt=(Dct=qc("cc.MeshRenderer"),Bct=cl(),Mct=Yc(100),Oct=rl(),Nct=El($ct),Lct=fl(),Fct=El(tlt),zct=fl(),Vct=El(pct),Gct=fl(),Uct=ul(),Dct(kct=Bct(kct=Mct(kct=Oct(kct=il((Jct=Kct=function(t){function e(){var e;return q(e=t.call(this)||this,"lightmapSettings",jct,H(e)),q(e,"_mesh",Wct,H(e)),q(e,"_shadowCastingMode",qct,H(e)),q(e,"_shadowReceivingMode",Xct,H(e)),e._subMeshShapesWeights=[],e._modelType=void 0,e._model=null,e._morphInstance=null,q(e,"_enableMorph",Yct,H(e)),e._modelType=qv,e}F(e,t);var n=e.prototype;return n.onLoad=function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onRestore=function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onEnable=function(){this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._attachToScene()},n.onDisable=function(){this._model&&this._detachFromScene()},n.onDestroy=function(){this._model&&(i.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},n.getWeight=function(t,e){this._subMeshShapesWeights.length;var n=this._subMeshShapesWeights[t];return n.length,n[e]},n.setWeights=function(t,e){var n=this._subMeshShapesWeights;e>=n.length||n[e].length===t.length&&(n[e]=t.slice(0),this._uploadSubMeshShapesWeights(e))},n.setWeight=function(t,e,n){var i=this._subMeshShapesWeights;if(!(e>=i.length)){var r=i[e];n>=r.length||(r[n]=t,this._uploadSubMeshShapesWeights(e))}},n.setInstancedAttribute=function(t,e){if(this.model)for(var n=this.model.instancedAttributes,i=n.attributes,r=n.views,o=0;o<i.length;o++)if(i[o].name===t){r[o].set(e);break}},n._updateLightmap=function(t,e,n,i,r){this.lightmapSettings.texture=t,this.lightmapSettings.uvParam.x=e,this.lightmapSettings.uvParam.y=n,this.lightmapSettings.uvParam.z=i,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()},n._updateModels=function(){if(this.enabledInHierarchy&&this._mesh){var t=this._model;t?(t.destroy(),t.initialize(),t.node=t.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}},n._createModel=function(){var t=this._morphInstance&&this._modelType===qv?Zct:this._modelType,e=this._model=i.director.root.createModel(t);e.visFlags=this.visibility,e.node=e.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&e instanceof Zct&&e.setMorphRendering(this._morphInstance)},n._attachToScene=function(){if(this.node.scene&&this._model){var t=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),t.addModel(this._model)}},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=Nd.POSITION,this._model.transform.hasChangedFlags|=Nd.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var t=this._mesh?this._mesh.renderingSubMeshes.length:0,e=this._mesh.renderingSubMeshes;if(e)for(var n=0;n<t;++n){var i=this.getRenderMaterial(n);i&&!i.isValid&&(i=null);var r=e[n];r&&this._model.initSubModel(n,r,i||this._getBuiltinMaterial())}this._model.enabled=!0}},n._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},n._onMaterialModified=function(t,e){this._model&&this._model.inited&&this._onRebuildPSO(t,e||this._getBuiltinMaterial())},n._onRebuildPSO=function(t,e){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(t,e),this._onUpdateLightingmap())},n._onMeshChanged=function(){},n._clearMaterials=function(){if(this._model)for(var t=this._model.subModels,e=0;e<t.length;++e)this._onMaterialModified(e,null)},n._getBuiltinMaterial=function(){return Cv.get("missing-material")},n._onVisibilityChange=function(t){this._model&&(this._model.visFlags=t)},n._updateCastShadow=function(){this._model&&(this._shadowCastingMode===$ct.OFF?this._model.castShadow=!1:(this._shadowCastingMode,$ct.ON,this._shadowCastingMode,this._model.castShadow=!0))},n._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===tlt.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},n._isBatchingEnabled=function(){for(var t=0;t<this._materials.length;++t){var e=this._materials[t];if(e)for(var n=0;n<e.passes.length;++n)if(e.passes[n].batchingScheme)return!0}return!1},n._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var t=this._mesh.struct.primitives.length,e=0;e<t;++e)this._uploadSubMeshShapesWeights(e);this._model&&this._model instanceof Zct&&this._model.setMorphRendering(this._morphInstance)}},n._initSubMeshShapesWeights=function(){var t=this._mesh;if(this._subMeshShapesWeights.length=0,t){var e=t.struct.morph;if(e){var n=e.weights;this._subMeshShapesWeights=e.subMeshMorphs.map((function(t){return t?t.weights?t.weights.slice(0):n?(n.length,t.targets.length,n.slice(0)):new Array(t.targets.length).fill(0):[]}))}}},n._validateShapeWeights=function(){var t=this._mesh,e=this._subMeshShapesWeights;if(!t||!t.struct.morph)return 0===e.length;var n=t.struct.morph;return n.subMeshMorphs.length===e.length&&e.every((function(t,e){var i,r,o=t.length;return(null!==(i=null===(r=n.subMeshMorphs[e])||void 0===r?void 0:r.targets.length)&&void 0!==i?i:0)===o}))},n._uploadSubMeshShapesWeights=function(t){var e;null===(e=this._morphInstance)||void 0===e||e.setWeights(t,this._subMeshShapesWeights[t])},N(e,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(t){this._shadowCastingMode=t,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(t){this._shadowReceivingMode=t,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(t){var e=this._mesh,n=this._mesh=t;null==n||n.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(e),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(t){this._enableMorph=t}}]),e}(VL),Kct.ShadowCastingMode=$ct,Kct.ShadowReceivingMode=tlt,jct=X((Hct=Jct).prototype,"lightmapSettings",[Zc,ll,Sl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new elt}}),Wct=X(Hct.prototype,"_mesh",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qct=X(Hct.prototype,"_shadowCastingMode",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $ct.OFF}}),Xct=X(Hct.prototype,"_shadowReceivingMode",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tlt.ON}}),X(Hct.prototype,"shadowCastingMode",[Nct,Lct,Sl],Object.getOwnPropertyDescriptor(Hct.prototype,"shadowCastingMode"),Hct.prototype),X(Hct.prototype,"receiveShadow",[Fct,zct,Sl],Object.getOwnPropertyDescriptor(Hct.prototype,"receiveShadow"),Hct.prototype),X(Hct.prototype,"mesh",[Vct,Gct],Object.getOwnPropertyDescriptor(Hct.prototype,"mesh"),Hct.prototype),X(Hct.prototype,"enableMorph",[Uct,Sl],Object.getOwnPropertyDescriptor(Hct.prototype,"enableMorph"),Hct.prototype),Yct=X(Hct.prototype,"_enableMorph",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),kct=Hct))||kct)||kct)||kct)||kct)||kct);!function(t){t[t.positions=Zr.ATTR_POSITION]="positions",t[t.normals=Zr.ATTR_NORMAL]="normals",t[t.uvs=Zr.ATTR_TEX_COORD]="uvs",t[t.colors=Zr.ATTR_COLOR]="colors"}(Qct||(Qct={}));var ilt,rlt=[new Bo(Zr.ATTR_POSITION,fr.RGB32F),new Bo(Zr.ATTR_NORMAL,fr.RGB32F),new Bo(Zr.ATTR_TEX_COORD,fr.RG32F),new Bo(Zr.ATTR_TANGENT,fr.RGBA32F),new Bo(Zr.ATTR_COLOR,fr.RGBA32F)],olt=new oi,alt=function(){function t(t,e,n){this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=t,this._opts=e,this._accumStart=n}var e=t.prototype;return e.sample=function(t){this._average(this._value,t)},e.human=function(){var t=this._opts,e=t.average,n=t.isInteger,i=e?this._averageValue:this._value;return n?Math.round(i):Math.round(100*i)/100},e.alarm=function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over},e._average=function(t,e){if(void 0===e&&(e=0),this._opts.average){this._accumValue+=t,++this._accumSamples;var n=e;n-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=n,this._accumSamples=0)}},N(t,[{key:"value",get:function(){return this._value},set:function(t){this._value=t}}]),t}(),slt=qc("cc.PerfCounter")(ilt=function(t){function e(e,n,i){var r;return(r=t.call(this,e,n,i)||this)._time=void 0,r._time=i,r}F(e,t);var n=e.prototype;return n.start=function(t){void 0===t&&(t=0),this._time=t},n.end=function(t){void 0===t&&(t=0),this._value=t-this._time,this._average(this._value)},n.tick=function(){this.end(),this.start()},n.frame=function(t){var e=t,n=e-this._time;this._total++,n>(this._opts.average||1e3)&&(this._value=1e3*this._total/n,this._total=0,this._time=e,this._average(this._value))},e}(alt))||ilt,clt="0123456789. ",llt=500,ult={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},hlt={fps:{desc:"Framerate (FPS)",below:30,average:llt,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:llt},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:llt,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:llt},render:{desc:"Renderer (ms)",min:0,max:50,average:llt,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},_lt=t("Profiler",function(){function t(){this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._pipeline=null,this._meshRenderer=null,this._canvas=null,this._ctx=null,this._texture=null,this._region=new co,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=256/(Object.keys(hlt).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas)}var e=t.prototype;return e.reset=function(){this._stats=null,this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._pipeline=null,this._meshRenderer&&this._meshRenderer.destroy(),this._meshRenderer=null,this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=256/(Object.keys(hlt).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0},e.isShowingStats=function(){return this._showFPS},e.hideStats=function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),i.director.off(i.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),i.director.off(i.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),i.director.off(i.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),i.director.off(i.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),i.director.off(i.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),i.director.off(i.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1,this._pipeline.profiler=null,i.game.config.showFPS=!1)},e.showStats=function(){if(!this._showFPS){if(!this._device){var t=i.director.root;this._device=t.device,this._swapchain=t.mainWindow.swapchain,this._pipeline=t.pipeline}this.generateCanvas(),this.generateStats(),i.game.once(i.Game.EVENT_ENGINE_INITED,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),i.director.on(i.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),i.director.on(i.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),i.director.on(i.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),i.director.on(i.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),i.director.on(i.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),i.director.on(i.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0,i.game.config.showFPS=!0}},e.generateCanvas=function(){if(!this._canvasDone){this._ctx&&this._canvas&&(this._canvas.width=256,this._canvas.height=256,this._canvas.style.width=""+this._canvas.width,this._canvas.style.height=""+this._canvas.height,this._ctx.font="23px Arial",this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new xo(xr.TEX2D,Sr.SAMPLED|Sr.TRANSFER_DST,fr.RGBA8,256,256)),this._region.texExtent.width=256,this._region.texExtent.height=256)}},e.generateStats=function(){if(!this._statsDone&&this._ctx&&this._canvas){this._stats=null;var t=performance.now();this._ctx.textAlign="left";var e=0;for(var n in hlt){var i=hlt[n];this._ctx.fillText(i.desc,0,e*this._lineHeight),i.counter=new slt(n,i,t),e++}this._totalLines=e,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(var r=0;r<clt.length;++r){var o=this._ctx.measureText(clt[r]).width;this._eachNumWidth=Math.max(this._eachNumWidth,o)}for(var a=0;a<clt.length;++a)this._ctx.fillText(clt[a],a*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=hlt,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}},e.generateNode=function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new BT("PROFILER_NODE"),i.game.addPersistRootNode(this._rootNode);var t=new BT("Profiler_Root");t.parent=this._rootNode;for(var e=.4,n=e/this._totalLines,r=e/this._wordHeight,o=n/23,a=this._eachNumWidth*this._canvas.width*o,s=[0,e,0,r,e,0,r,0,0,0,0,0],c=[0,2,1,0,3,2],l=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0],u=0,h=0;h<this._totalLines;h++)for(var _=0;_<8;_++){s.push(r+_*a,e-h*n,0),s.push(r+(_+1)*a,e-h*n,0),s.push(r+(_+1)*a,e-(h+1)*n,0),s.push(r+_*a,e-(h+1)*n,0),u=4*(8*h+_+1),c.push(0+u,2+u,1+u,0+u,3+u,2+u);var f=8*h+_,p=Math.floor(f/4),d=f-4*p;l.push(0,this._wordHeight,p,d),l.push(this._eachNumWidth,this._wordHeight,p,d),l.push(this._eachNumWidth,1,p,d),l.push(0,1,p,d)}this._meshRenderer=t.addComponent(nlt),this._meshRenderer.mesh=function(t,e,n){n=n||{};var i,r=[],o=0,a=[],s=0,c=t.positions.slice();if(c.length>0){if(i=null,t.attributes)for(var l,u=W(t.attributes);!(l=u()).done;){var h=l.value;if(h.name===Zr.ATTR_POSITION){i=h;break}}i||(i=rlt[0]),r.push(i);var _=na[i.format];s=Math.max(s,Math.floor(c.length/_.count)),a.push({offset:o,data:c,attribute:i}),o+=_.size}if(t.normals&&t.normals.length>0){if(i=null,t.attributes)for(var f,p=W(t.attributes);!(f=p()).done;){var d=f.value;if(d.name===Zr.ATTR_NORMAL){i=d;break}}i||(i=rlt[1]);var m=na[i.format];r.push(i),s=Math.max(s,Math.floor(t.normals.length/m.count)),a.push({offset:o,data:t.normals,attribute:i}),o+=m.size}if(t.uvs&&t.uvs.length>0){if(i=null,t.attributes)for(var v,g=W(t.attributes);!(v=g()).done;){var y=v.value;if(y.name===Zr.ATTR_TEX_COORD){i=y;break}}i||(i=rlt[2]);var x=na[i.format];r.push(i),s=Math.max(s,Math.floor(t.uvs.length/x.count)),a.push({offset:o,data:t.uvs,attribute:i}),o+=x.size}if(t.tangents&&t.tangents.length>0){if(i=null,t.attributes)for(var S,A=W(t.attributes);!(S=A()).done;){var C=S.value;if(C.name===Zr.ATTR_TANGENT){i=C;break}}i||(i=rlt[3]);var b=na[i.format];r.push(i),s=Math.max(s,Math.floor(t.tangents.length/b.count)),a.push({offset:o,data:t.tangents,attribute:i}),o+=b.size}if(t.colors&&t.colors.length>0){if(i=null,t.attributes)for(var T,E=W(t.attributes);!(T=E()).done;){var w=T.value;if(w.name===Zr.ATTR_COLOR){i=w;break}}i||(i=rlt[4]);var P=na[i.format];r.push(i),s=Math.max(s,Math.floor(t.colors.length/P.count)),a.push({offset:o,data:t.colors,attribute:i}),o+=P.size}if(t.customAttributes)for(var I,R=W(t.customAttributes);!(I=R()).done;){var D=I.value,B=na[D.attr.format];r.push(D.attr),s=Math.max(s,Math.floor(D.values.length/B.count)),a.push({offset:o,data:D.values,attribute:D.attr}),o+=B.size}for(var M=new nct,O=new ArrayBuffer(s*o),N=new DataView(O),L=0,F=a;L<F.length;L++){var z=F[L];bE(N,z.data,z.attribute.format,z.offset,o)}M.setNextAlignment(0);var V={attributes:r,view:{offset:M.getLength(),length:O.byteLength,count:s,stride:o}};M.addBuffer(O);var G=null,U=0;if(t.indices){var k=t.indices;U=k.length,G=new ArrayBuffer(2*U),bE(new DataView(G),k,fr.R16UI)}var H={primitiveMode:t.primitiveMode||zr.TRIANGLE_LIST,vertexBundelIndices:[0]};G&&(M.setNextAlignment(2),H.indexView={offset:M.getLength(),length:G.byteLength,count:U,stride:2},M.addBuffer(G));var j=t.minPos;if(!j&&n.calculateBounds){j=oi.set(new oi,1/0,1/0,1/0);for(var q=0;q<s;++q)oi.set(olt,c[3*q+0],c[3*q+1],c[3*q+2]),oi.min(j,j,olt)}var X=t.maxPos;if(!X&&n.calculateBounds){X=oi.set(new oi,-1/0,-1/0,-1/0);for(var Y=0;Y<s;++Y)oi.set(olt,c[3*Y+0],c[3*Y+1],c[3*Y+2]),oi.max(X,X,olt)}var K={vertexBundles:[V],primitives:[H]};return j&&(K.minPosition=new oi(j.x,j.y,j.z)),X&&(K.maxPosition=new oi(X.x,X.y,X.z)),e||(e=new pct),e.reset({struct:K,data:new Uint8Array(M.getCombined())}),e}({positions:s,indices:c,colors:l});var m=new hg;m.initialize({effectName:"profiler"});var v=this.pass=m.passes[0],g=v.getBinding("mainTexture"),y=v.getBinding("digits"),x=v.getBinding("offset");v.bindTexture(g,this._texture),this.digitsData=v.blocks[y],this.offsetData=v.blocks[x],this.offsetData[3]=-1,this._meshRenderer.material=m,this._meshRenderer.node.layer=fp.Enum.PROFILER,this._inited=!0}},e.beforeUpdate=function(){if(this._stats){var t=performance.now();this._stats.frame.counter.start(t),this._stats.logic.counter.start(t)}},e.afterUpdate=function(){if(this._stats){var t=performance.now();i.director.isPaused()?this._stats.frame.counter.start(t):this._stats.logic.counter.end(t)}},e.beforePhysics=function(){if(this._stats){var t=performance.now();this._stats.physics.counter.start(t)}},e.afterPhysics=function(){if(this._stats){var t=performance.now();this._stats.physics.counter.end(t)}},e.beforeDraw=function(){if(this._stats&&this._inited){var t=this._swapchain.surfaceTransform,e=this._device.capabilities.clipSpaceSignY;if(t!==this.offsetData[3]){var n=Ti[t],i=-.9*e;this.offsetData[0]=-.9*n[0]+i*n[2],this.offsetData[1]=-.9*n[1]+i*n[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=t}this.pass._setRootBufferDirty(!0),this._meshRenderer.model&&(this._pipeline.profiler=this._meshRenderer.model);var r=performance.now();this._stats.render.counter.start(r)}},e.afterDraw=function(){if(this._stats&&this._inited){var t=performance.now();if(this._stats.frame.counter.end(t),this._stats.fps.counter.frame(t),this._stats.render.counter.end(t),!(t-this.lastTime<llt)){this.lastTime=t;var e=this._device;this._stats.draws.counter.value=e.numDrawCalls,this._stats.instances.counter.value=e.numInstances,this._stats.bufferMemory.counter.value=e.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=e.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=e.numTris;var n=0,i=this.digitsData;for(var r in this._stats){var o=this._stats[r];o.counter.sample(t);for(var a=o.counter.human().toString(),s=7;s>=0;s--){var c=8*n+s,l=a[a.length-(8-s)],u=ult[l];void 0===u&&(u=11),i[c]=u}n++}}}},t}()),flt=t("profiler",new _lt);i.profiler=flt;var plt,dlt,mlt,vlt,glt=Jt({GRAVITY:0,RADIUS:1}),ylt=Jt({FREE:0,RELATIVE:1,GROUPED:2}),xlt=new li(0,0),Slt=new li,Alt=new li,Clt=new li,blt=new li,Tlt=fX(hX),Elt=function(){this.pos=new li(0,0),this.startPos=new li(0,0),this.color=new Li(0,0,0,255),this.deltaColor={r:0,g:0,b:0,a:255},this.size=0,this.deltaSize=0,this.rotation=0,this.deltaRotation=0,this.timeToLive=0,this.drawPos=new li(0,0),this.aspectRatio=1,this.dir=new li(0,0),this.radialAccel=0,this.tangentialAccel=0,this.angle=0,this.degreesPerSecond=0,this.radius=0,this.deltaRadius=0},wlt=new(function(t){function e(){return t.apply(this,arguments)||this}return F(e,t),e.prototype.get=function(){return this._get()||new Elt},e}(Gt))((function(t){t.pos.set(xlt),t.startPos.set(xlt),t.color._val=4278190080,t.deltaColor.r=t.deltaColor.g=t.deltaColor.b=0,t.deltaColor.a=255,t.size=0,t.deltaSize=0,t.rotation=0,t.deltaRotation=0,t.timeToLive=0,t.drawPos.set(xlt),t.aspectRatio=1,t.dir.set(xlt),t.radialAccel=0,t.tangentialAccel=0,t.angle=0,t.degreesPerSecond=0,t.radius=0,t.deltaRadius=0}),1024),Plt=function(){function t(t){this.particles=[],this.active=!1,this.uvFilled=0,this.finished=!1,this.readyToPlay=!0,this.elapsed=0,this.emitCounter=0,this._worldRotation=0,this.sys=t,this.particles=[],this.active=!1,this.readyToPlay=!0,this.finished=!1,this.elapsed=0,this.emitCounter=0,this.uvFilled=0,this._worldRotation=0}var e=t.prototype;return e.stop=function(){this.active=!1,this.readyToPlay=!1,this.elapsed=this.sys.duration,this.emitCounter=0},e.reset=function(){this.active=!0,this.readyToPlay=!0,this.elapsed=0,this.emitCounter=0,this.finished=!1;for(var t=this.particles,e=0;e<t.length;++e)wlt.put(t[e]);t.length=0},e.emitParticle=function(t){var e=this.sys,n=wlt.get();this.particles.push(n),n.timeToLive=e.life+e.lifeVar*(Math.random()-.5)*2;var i=n.timeToLive=Math.max(0,n.timeToLive);n.pos.x=e.sourcePos.x+e.posVar.x*(Math.random()-.5)*2,n.pos.y=e.sourcePos.y+e.posVar.y*(Math.random()-.5)*2;var r,o,a,s,c=e.startColor,l=e.startColorVar,u=e.endColor,h=e.endColorVar;n.color.r=r=fe(c.r+l.r*(Math.random()-.5)*2,0,255),n.color.g=o=fe(c.g+l.g*(Math.random()-.5)*2,0,255),n.color.b=a=fe(c.b+l.b*(Math.random()-.5)*2,0,255),n.color.a=s=fe(c.a+l.a*(Math.random()-.5)*2,0,255),n.deltaColor.r=(fe(u.r+h.r*(Math.random()-.5)*2,0,255)-r)/i,n.deltaColor.g=(fe(u.g+h.g*(Math.random()-.5)*2,0,255)-o)/i,n.deltaColor.b=(fe(u.b+h.b*(Math.random()-.5)*2,0,255)-a)/i,n.deltaColor.a=(fe(u.a+h.a*(Math.random()-.5)*2,0,255)-s)/i;var _=e.startSize+e.startSizeVar*(Math.random()-.5)*2;if(_=Math.max(0,_),n.size=_,-1===e.endSize)n.deltaSize=0;else{var f=e.endSize+e.endSizeVar*(Math.random()-.5)*2;f=Math.max(0,f),n.deltaSize=(f-_)/i}var p=e.startSpin+e.startSpinVar*(Math.random()-.5)*2,d=e.endSpin+e.endSpinVar*(Math.random()-.5)*2;n.rotation=p,n.deltaRotation=(d-p)/i,n.startPos.x=t.x,n.startPos.y=t.y,n.aspectRatio=e.aspectRatio||1;var m=pe(e.angle+this._worldRotation+e.angleVar*(Math.random()-.5)*2);if(e.emitterMode===glt.GRAVITY){var v=e.speed+e.speedVar*(Math.random()-.5)*2;n.dir.x=Math.cos(m),n.dir.y=Math.sin(m),n.dir.multiplyScalar(v),n.radialAccel=e.radialAccel+e.radialAccelVar*(Math.random()-.5)*2,n.tangentialAccel=e.tangentialAccel+e.tangentialAccelVar*(Math.random()-.5)*2,e.rotationIsDir&&(n.rotation=-de(Math.atan2(n.dir.y,n.dir.x)))}else{var g=e.startRadius+e.startRadiusVar*(Math.random()-.5)*2,y=e.endRadius+e.endRadiusVar*(Math.random()-.5)*2;n.radius=g,n.deltaRadius=-1===e.endRadius?0:(y-g)/i,n.angle=m,n.degreesPerSecond=pe(e.rotatePerS+e.rotatePerSVar*(Math.random()-.5)*2)}},e.updateUVs=function(t){var e=this.renderData;if(e&&this.sys._renderSpriteFrame){for(var n=e.vData,i=this.sys._renderSpriteFrame.uv,r=t?0:this.uvFilled,o=this.particles.length,a=r;a<o;a++){var s=a*Tlt*4;n[s+3]=i[0],n[s+4]=i[1],n[s+12]=i[2],n[s+13]=i[3],n[s+21]=i[4],n[s+22]=i[5],n[s+30]=i[6],n[s+31]=i[7]}this.uvFilled=o}},e.updateParticleBuffer=function(t,e,n,i){var r=n.vData,o=e.x,a=e.y,s=t.size,c=s,l=t.aspectRatio;l>1?c=s/l:s=c*l;var u=s/2,h=c/2;if(t.rotation){var _=-u,f=-h,p=u,d=h,m=-pe(t.rotation),v=Math.cos(m),g=Math.sin(m);r[i]=_*v-f*g+o,r[i+1]=_*g+f*v+a,r[i+2]=0,r[i+9]=p*v-f*g+o,r[i+10]=p*g+f*v+a,r[i+11]=0,r[i+18]=_*v-d*g+o,r[i+19]=_*g+d*v+a,r[i+20]=0,r[i+27]=p*v-d*g+o,r[i+28]=p*g+d*v+a,r[i+29]=0}else r[i]=o-u,r[i+1]=a-h,r[i+2]=0,r[i+9]=o+u,r[i+10]=a-h,r[i+11]=0,r[i+18]=o-u,r[i+19]=a+h,r[i+20]=0,r[i+27]=o+u,r[i+28]=a+h,r[i+29]=0;Li.toArray(r,t.color,i+5),Li.toArray(r,t.color,i+14),Li.toArray(r,t.color,i+23),Li.toArray(r,t.color,i+32)},e.step=function(t){var e=this.sys.assembler,n=this.sys,i=n.node,r=this.particles;if(t=t>e.maxParticleDeltaTime?e.maxParticleDeltaTime:t,i.updateWorldTransform(),n.positionType===ylt.FREE){this._worldRotation=function(t){for(var e=0,n=t;n;)e+=n.eulerAngles.z,n=n.parent;return e}(i);var o=i.worldMatrix;Slt.x=o.m12,Slt.y=o.m13}else n.positionType===ylt.RELATIVE?(this._worldRotation=i.eulerAngles.z,Slt.x=i.position.x,Slt.y=i.position.y):this._worldRotation=0;if(this.active&&n.emissionRate){var a=1/n.emissionRate;for(r.length<n.totalParticles&&(this.emitCounter+=t);r.length<n.totalParticles&&this.emitCounter>a;)this.emitParticle(Slt),this.emitCounter-=a;this.elapsed+=t,-1!==n.duration&&n.duration<this.elapsed&&n.stopSystem()}var s=this.renderData,c=r.length;s.reset(),this.requestData(4*c,6*c),c>this.uvFilled&&this.updateUVs();for(var l=0;l<r.length;){Alt.x=Alt.y=Clt.x=Clt.y=blt.x=blt.y=0;var u=r[l];if(u.timeToLive-=t,u.timeToLive>0){if(n.emitterMode===glt.GRAVITY){var h=blt,_=Alt,f=Clt;(u.pos.x||u.pos.y)&&(_.set(u.pos),_.normalize()),f.set(_),_.multiplyScalar(u.radialAccel);var p=f.x;f.x=-f.y,f.y=p,f.multiplyScalar(u.tangentialAccel),h.set(_),h.add(f),h.add(n.gravity),h.multiplyScalar(t),u.dir.add(h),h.set(u.dir),h.multiplyScalar(t),u.pos.add(h)}else u.angle+=u.degreesPerSecond*t,u.radius+=u.deltaRadius*t,u.pos.x=-Math.cos(u.angle)*u.radius,u.pos.y=-Math.sin(u.angle)*u.radius;u.color.r+=u.deltaColor.r*t,u.color.g+=u.deltaColor.g*t,u.color.b+=u.deltaColor.b*t,u.color.a+=u.deltaColor.a*t,u.size+=u.deltaSize*t,u.size<0&&(u.size=0),u.rotation+=u.deltaRotation*t;var d=Alt;d.set(u.pos),n.positionType!==ylt.GROUPED&&d.add(u.startPos);var m=Tlt*l*4;this.updateParticleBuffer(u,d,s,m),++l}else{var v=r[l];l!==r.length-1&&(r[l]=r[r.length-1]),wlt.put(v),r.length--,s.resize(s.vertexCount-4,s.indexCount-6)}}0!==r.length||this.active||this.readyToPlay||(this.finished=!0,n._finishedSimulation())},e.requestData=function(t,e){var n=this.renderData.indexCount;this.renderData.request(t,e);for(var i=this.renderData.indexCount/6,r=this.renderData.iData,o=n;o<i;o++){var a=4*o;r[n++]=a,r[n++]=a+1,r[n++]=a+2,r[n++]=a+1,r[n++]=a+3,r[n++]=a+2}},t}(),Ilt=t("ParticleAsset",qc("cc.ParticleAsset")((vlt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"spriteFrame",mlt,H(e)),e}return F(e,t),e}(Su),mlt=X((dlt=vlt).prototype,"spriteFrame",[Zc,ll],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),plt=dlt))||plt);i.ParticleAsset=Ilt;
/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */
var Rlt={};(function(){function t(t){throw t}var e=void 0,n=!0,i=this;function r(t,n){var r,o=t.split("."),a=i;!(o[0]in a)&&a.execScript&&a.execScript("var "+o[0]);for(;o.length&&(r=o.shift());)o.length||n===e?a=a[r]?a[r]:a[r]={}:a[r]=n}var o="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array;function a(t){if("string"==typeof t){var e,n,i=t.split("");for(e=0,n=i.length;e<n;e++)i[e]=(255&i[e].charCodeAt(0))>>>0;t=i}for(var r,o=1,a=0,s=t.length,c=0;0<s;){s-=r=1024<s?1024:s;do{a+=o+=t[c++]}while(--r);o%=65521,a%=65521}return(a<<16|o)>>>0}function s(e,n){this.index="number"==typeof n?n:0,this.i=0,this.buffer=e instanceof(o?Uint8Array:Array)?e:new(o?Uint8Array:Array)(32768),2*this.buffer.length<=this.index&&t(Error("invalid index")),this.buffer.length<=this.index&&this.f()}s.prototype.f=function(){var t,e=this.buffer,n=e.length,i=new(o?Uint8Array:Array)(n<<1);if(o)i.set(e);else for(t=0;t<n;++t)i[t]=e[t];return this.buffer=i},s.prototype.d=function(t,e,n){var i,r=this.buffer,o=this.index,a=this.i,s=r[o];if(n&&1<e&&(t=8<e?(f[255&t]<<24|f[t>>>8&255]<<16|f[t>>>16&255]<<8|f[t>>>24&255])>>32-e:f[t]>>8-e),8>e+a)s=s<<e|t,a+=e;else for(i=0;i<e;++i)s=s<<1|t>>e-i-1&1,8==++a&&(a=0,r[o++]=f[s],s=0,o===r.length&&(r=this.f()));r[o]=s,this.buffer=r,this.i=a,this.index=o},s.prototype.finish=function(){var t,e=this.buffer,n=this.index;return 0<this.i&&(e[n]<<=8-this.i,e[n]=f[e[n]],n++),o?t=e.subarray(0,n):(e.length=n,t=e),t};var c,l=new(o?Uint8Array:Array)(256);for(c=0;256>c;++c){for(var u=_=c,h=7,_=_>>>1;_;_>>>=1)u<<=1,u|=1&_,--h;l[c]=(u<<h&255)>>>0}var f=l;function p(t){this.buffer=new(o?Uint16Array:Array)(2*t),this.length=0}function d(t){var e,n,i,r,a,s,c,l,u,h=t.length,_=0,f=Number.POSITIVE_INFINITY;for(l=0;l<h;++l)t[l]>_&&(_=t[l]),t[l]<f&&(f=t[l]);for(e=1<<_,n=new(o?Uint32Array:Array)(e),i=1,r=0,a=2;i<=_;){for(l=0;l<h;++l)if(t[l]===i){for(s=0,c=r,u=0;u<i;++u)s=s<<1|1&c,c>>=1;for(u=s;u<e;u+=a)n[u]=i<<16|l;++r}++i,r<<=1,a<<=1}return[n,_,f]}function m(t,e){this.h=g,this.w=0,this.input=t,this.b=0,e&&(e.lazy&&(this.w=e.lazy),"number"==typeof e.compressionType&&(this.h=e.compressionType),e.outputBuffer&&(this.a=o&&e.outputBuffer instanceof Array?new Uint8Array(e.outputBuffer):e.outputBuffer),"number"==typeof e.outputIndex&&(this.b=e.outputIndex)),this.a||(this.a=new(o?Uint8Array:Array)(32768))}p.prototype.getParent=function(t){return 2*((t-2)/4|0)},p.prototype.push=function(t,e){var n,i,r,o=this.buffer;for(n=this.length,o[this.length++]=e,o[this.length++]=t;0<n&&(i=this.getParent(n),o[n]>o[i]);)r=o[n],o[n]=o[i],o[i]=r,r=o[n+1],o[n+1]=o[i+1],o[i+1]=r,n=i;return this.length},p.prototype.pop=function(){var t,e,n,i,r,o=this.buffer;for(e=o[0],t=o[1],this.length-=2,o[0]=o[this.length],o[1]=o[this.length+1],r=0;!((i=2*r+2)>=this.length)&&(i+2<this.length&&o[i+2]>o[i]&&(i+=2),o[i]>o[r]);)n=o[r],o[r]=o[i],o[i]=n,n=o[r+1],o[r+1]=o[i+1],o[i+1]=n,r=i;return{index:t,value:e,length:this.length}};var v,g=2,y={NONE:0,r:1,j:g,N:3},x=[];for(v=0;288>v;v++)switch(n){case 143>=v:x.push([v+48,8]);break;case 255>=v:x.push([v-144+400,9]);break;case 279>=v:x.push([v-256+0,7]);break;case 287>=v:x.push([v-280+192,8]);break;default:t("invalid literal: "+v)}function S(t,e){this.length=t,this.G=e}function A(){var e=C;switch(n){case 3===e:return[257,e-3,0];case 4===e:return[258,e-4,0];case 5===e:return[259,e-5,0];case 6===e:return[260,e-6,0];case 7===e:return[261,e-7,0];case 8===e:return[262,e-8,0];case 9===e:return[263,e-9,0];case 10===e:return[264,e-10,0];case 12>=e:return[265,e-11,1];case 14>=e:return[266,e-13,1];case 16>=e:return[267,e-15,1];case 18>=e:return[268,e-17,1];case 22>=e:return[269,e-19,2];case 26>=e:return[270,e-23,2];case 30>=e:return[271,e-27,2];case 34>=e:return[272,e-31,2];case 42>=e:return[273,e-35,3];case 50>=e:return[274,e-43,3];case 58>=e:return[275,e-51,3];case 66>=e:return[276,e-59,3];case 82>=e:return[277,e-67,4];case 98>=e:return[278,e-83,4];case 114>=e:return[279,e-99,4];case 130>=e:return[280,e-115,4];case 162>=e:return[281,e-131,5];case 194>=e:return[282,e-163,5];case 226>=e:return[283,e-195,5];case 257>=e:return[284,e-227,5];case 258===e:return[285,e-258,0];default:t("invalid length: "+e)}}m.prototype.n=function(){var i,r,a,c,l=this.input;switch(this.h){case 0:for(a=0,c=l.length;a<c;){var u,h,_,f=r=o?l.subarray(a,a+65535):l.slice(a,a+65535),p=(a+=r.length)===c,d=e,m=e,v=this.a,y=this.b;if(o){for(v=new Uint8Array(this.a.buffer);v.length<=y+f.length+5;)v=new Uint8Array(v.length<<1);v.set(this.a)}if(u=p?1:0,v[y++]=0|u,_=65536+~(h=f.length)&65535,v[y++]=255&h,v[y++]=h>>>8&255,v[y++]=255&_,v[y++]=_>>>8&255,o)v.set(f,y),y+=f.length,v=v.subarray(0,y);else{for(d=0,m=f.length;d<m;++d)v[y++]=f[d];v.length=y}this.b=y,this.a=v}break;case 1:var S=new s(new Uint8Array(this.a.buffer),this.b);S.d(1,1,n),S.d(1,2,n);var A,C,b,T=w(this,l);for(A=0,C=T.length;A<C;A++)if(b=T[A],s.prototype.d.apply(S,x[b]),256<b)S.d(T[++A],T[++A],n),S.d(T[++A],5),S.d(T[++A],T[++A],n);else if(256===b)break;this.a=S.finish(),this.b=this.a.length;break;case g:var E,R,D,B,M,O,N,L,F,z,V,G,U,k,H,j=new s(new Uint8Array(this.a),this.b),W=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],q=Array(19);for(E=g,j.d(1,1,n),j.d(E,2,n),R=w(this,l),N=I(O=P(this.L,15)),F=I(L=P(this.K,7)),D=286;257<D&&0===O[D-1];D--);for(B=30;1<B&&0===L[B-1];B--);var X,Y,K,J,Q,Z,$=D,tt=B,et=new(o?Uint32Array:Array)($+tt),nt=new(o?Uint32Array:Array)(316),it=new(o?Uint8Array:Array)(19);for(X=Y=0;X<$;X++)et[Y++]=O[X];for(X=0;X<tt;X++)et[Y++]=L[X];if(!o)for(X=0,J=it.length;X<J;++X)it[X]=0;for(X=Q=0,J=et.length;X<J;X+=Y){for(Y=1;X+Y<J&&et[X+Y]===et[X];++Y);if(K=Y,0===et[X])if(3>K)for(;0<K--;)nt[Q++]=0,it[0]++;else for(;0<K;)(Z=138>K?K:138)>K-3&&Z<K&&(Z=K-3),10>=Z?(nt[Q++]=17,nt[Q++]=Z-3,it[17]++):(nt[Q++]=18,nt[Q++]=Z-11,it[18]++),K-=Z;else if(nt[Q++]=et[X],it[et[X]]++,3>--K)for(;0<K--;)nt[Q++]=et[X],it[et[X]]++;else for(;0<K;)(Z=6>K?K:6)>K-3&&Z<K&&(Z=K-3),nt[Q++]=16,nt[Q++]=Z-3,it[16]++,K-=Z}for(i=o?nt.subarray(0,Q):nt.slice(0,Q),z=P(it,7),k=0;19>k;k++)q[k]=z[W[k]];for(M=19;4<M&&0===q[M-1];M--);for(V=I(z),j.d(D-257,5,n),j.d(B-1,5,n),j.d(M-4,4,n),k=0;k<M;k++)j.d(q[k],3,n);for(k=0,H=i.length;k<H;k++)if(G=i[k],j.d(V[G],z[G],n),16<=G){switch(k++,G){case 16:U=2;break;case 17:U=3;break;case 18:U=7;break;default:t("invalid code: "+G)}j.d(i[k],U,n)}var rt,ot,at,st,ct,lt,ut,ht,_t=[N,O],ft=[F,L];for(ct=_t[0],lt=_t[1],ut=ft[0],ht=ft[1],rt=0,ot=R.length;rt<ot;++rt)if(at=R[rt],j.d(ct[at],lt[at],n),256<at)j.d(R[++rt],R[++rt],n),st=R[++rt],j.d(ut[st],ht[st],n),j.d(R[++rt],R[++rt],n);else if(256===at)break;this.a=j.finish(),this.b=this.a.length;break;default:t("invalid compression type")}return this.a};var C,b,T=[];for(C=3;258>=C;C++)b=A(),T[C]=b[2]<<24|b[1]<<16|b[0];var E=o?new Uint32Array(T):T;function w(i,r){function a(e,i){var r,o,a,s,c=e.G,l=[],u=0;switch(r=E[e.length],l[u++]=65535&r,l[u++]=r>>16&255,l[u++]=r>>24,n){case 1===c:o=[0,c-1,0];break;case 2===c:o=[1,c-2,0];break;case 3===c:o=[2,c-3,0];break;case 4===c:o=[3,c-4,0];break;case 6>=c:o=[4,c-5,1];break;case 8>=c:o=[5,c-7,1];break;case 12>=c:o=[6,c-9,2];break;case 16>=c:o=[7,c-13,2];break;case 24>=c:o=[8,c-17,3];break;case 32>=c:o=[9,c-25,3];break;case 48>=c:o=[10,c-33,4];break;case 64>=c:o=[11,c-49,4];break;case 96>=c:o=[12,c-65,5];break;case 128>=c:o=[13,c-97,5];break;case 192>=c:o=[14,c-129,6];break;case 256>=c:o=[15,c-193,6];break;case 384>=c:o=[16,c-257,7];break;case 512>=c:o=[17,c-385,7];break;case 768>=c:o=[18,c-513,8];break;case 1024>=c:o=[19,c-769,8];break;case 1536>=c:o=[20,c-1025,9];break;case 2048>=c:o=[21,c-1537,9];break;case 3072>=c:o=[22,c-2049,10];break;case 4096>=c:o=[23,c-3073,10];break;case 6144>=c:o=[24,c-4097,11];break;case 8192>=c:o=[25,c-6145,11];break;case 12288>=c:o=[26,c-8193,12];break;case 16384>=c:o=[27,c-12289,12];break;case 24576>=c:o=[28,c-16385,13];break;case 32768>=c:o=[29,c-24577,13];break;default:t("invalid distance")}for(r=o,l[u++]=r[0],l[u++]=r[1],l[u++]=r[2],a=0,s=l.length;a<s;++a)v[g++]=l[a];x[l[0]]++,A[l[3]]++,y=e.length+i-1,p=null}var s,c,l,u,h,_,f,p,d,m={},v=o?new Uint16Array(2*r.length):[],g=0,y=0,x=new(o?Uint32Array:Array)(286),A=new(o?Uint32Array:Array)(30),C=i.w;if(!o){for(l=0;285>=l;)x[l++]=0;for(l=0;29>=l;)A[l++]=0}for(x[256]=1,s=0,c=r.length;s<c;++s){for(l=h=0,u=3;l<u&&s+l!==c;++l)h=h<<8|r[s+l];if(m[h]===e&&(m[h]=[]),_=m[h],!(0<y--)){for(;0<_.length&&32768<s-_[0];)_.shift();if(s+3>=c){for(p&&a(p,-1),l=0,u=c-s;l<u;++l)d=r[s+l],v[g++]=d,++x[d];break}if(0<_.length){var b=e,T=e,w=0,P=e,I=e,R=e,D=r.length,B=(I=0,_.length);t:for(;I<B;I++){if(b=_[B-I-1],P=3,3<w){for(R=w;3<R;R--)if(r[b+R-1]!==r[s+R-1])continue t;P=w}for(;258>P&&s+P<D&&r[b+P]===r[s+P];)++P;if(P>w&&(T=b,w=P),258===P)break}f=new S(w,s-T),p?p.length<f.length?(d=r[s-1],v[g++]=d,++x[d],a(f,0)):a(p,-1):f.length<C?p=f:a(f,0)}else p?a(p,-1):(d=r[s],v[g++]=d,++x[d])}_.push(s)}return v[g++]=256,x[256]++,i.L=x,i.K=A,o?v.subarray(0,g):v}function P(t,e){function n(t){var e=C[t][b[t]];e===g?(n(t+1),n(t+1)):--S[e],++b[t]}var i,r,a,s,c,l=t.length,u=new p(572),h=new(o?Uint8Array:Array)(l);if(!o)for(s=0;s<l;s++)h[s]=0;for(s=0;s<l;++s)0<t[s]&&u.push(s,t[s]);if(i=Array(u.length/2),r=new(o?Uint32Array:Array)(u.length/2),1===i.length)return h[u.pop().index]=1,h;for(s=0,c=u.length/2;s<c;++s)i[s]=u.pop(),r[s]=i[s].value;var _,f,d,m,v,g=r.length,y=new(o?Uint16Array:Array)(e),x=new(o?Uint8Array:Array)(e),S=new(o?Uint8Array:Array)(g),A=Array(e),C=Array(e),b=Array(e),T=(1<<e)-g,E=1<<e-1;for(y[e-1]=g,f=0;f<e;++f)T<E?x[f]=0:(x[f]=1,T-=E),T<<=1,y[e-2-f]=(y[e-1-f]/2|0)+g;for(y[0]=x[0],A[0]=Array(y[0]),C[0]=Array(y[0]),f=1;f<e;++f)y[f]>2*y[f-1]+x[f]&&(y[f]=2*y[f-1]+x[f]),A[f]=Array(y[f]),C[f]=Array(y[f]);for(_=0;_<g;++_)S[_]=e;for(d=0;d<y[e-1];++d)A[e-1][d]=r[d],C[e-1][d]=d;for(_=0;_<e;++_)b[_]=0;for(1===x[e-1]&&(--S[0],++b[e-1]),f=e-2;0<=f;--f){for(m=_=0,v=b[f+1],d=0;d<y[f];d++)(m=A[f+1][v]+A[f+1][v+1])>r[_]?(A[f][d]=m,C[f][d]=g,v+=2):(A[f][d]=r[_],C[f][d]=_,++_);b[f]=0,1===x[f]&&n(f)}for(a=S,s=0,c=i.length;s<c;++s)h[i[s].index]=a[s];return h}function I(e){var n,i,r,a,s=new(o?Uint16Array:Array)(e.length),c=[],l=[],u=0;for(n=0,i=e.length;n<i;n++)c[e[n]]=1+(0|c[e[n]]);for(n=1,i=16;n<=i;n++)l[n]=u,(u+=0|c[n])>1<<n&&t("overcommitted"),u<<=1;for(65536>u&&t("undercommitted"),n=0,i=e.length;n<i;n++)for(u=l[e[n]],l[e[n]]+=1,r=s[n]=0,a=e[n];r<a;r++)s[n]=s[n]<<1|1&u,u>>>=1;return s}function R(t,e){this.input=t,this.a=new(o?Uint8Array:Array)(32768),this.h=D.j;var n,i={};for(n in!e&&(e={})||"number"!=typeof e.compressionType||(this.h=e.compressionType),e)i[n]=e[n];i.outputBuffer=this.a,this.z=new m(this.input,i)}var D=y;function B(e,n){switch(this.k=[],this.l=32768,this.e=this.g=this.c=this.q=0,this.input=o?new Uint8Array(e):e,this.s=!1,this.m=O,this.B=!1,!n&&(n={})||(n.index&&(this.c=n.index),n.bufferSize&&(this.l=n.bufferSize),n.bufferType&&(this.m=n.bufferType),n.resize&&(this.B=n.resize)),this.m){case M:this.b=32768,this.a=new(o?Uint8Array:Array)(32768+this.l+258);break;case O:this.b=0,this.a=new(o?Uint8Array:Array)(this.l),this.f=this.J,this.t=this.H,this.o=this.I;break;default:t(Error("invalid inflate mode"))}}R.prototype.n=function(){var e,n,i,r,s,c,l,u=0;switch(l=this.a,e=ut){case ut:n=Math.LOG2E*Math.log(32768)-8;break;default:t(Error("invalid compression method"))}switch(i=n<<4|e,l[u++]=i,e){case ut:switch(this.h){case D.NONE:s=0;break;case D.r:s=1;break;case D.j:s=2;break;default:t(Error("unsupported compression type"))}break;default:t(Error("invalid compression method"))}return r=s<<6|0,l[u++]=r|31-(256*i+r)%31,c=a(this.input),this.z.b=u,u=(l=this.z.n()).length,o&&((l=new Uint8Array(l.buffer)).length<=u+4&&(this.a=new Uint8Array(l.length+4),this.a.set(l),l=this.a),l=l.subarray(0,u+4)),l[u++]=c>>24&255,l[u++]=c>>16&255,l[u++]=c>>8&255,l[u++]=255&c,l},r("Zlib.Deflate",R),r("Zlib.Deflate.compress",(function(t,e){return new R(t,e).n()})),r("Zlib.Deflate.CompressionType",D),r("Zlib.Deflate.CompressionType.NONE",D.NONE),r("Zlib.Deflate.CompressionType.FIXED",D.r),r("Zlib.Deflate.CompressionType.DYNAMIC",D.j);var M=0,O=1,N={D:M,C:O};B.prototype.p=function(){for(;!this.s;){var i=tt(this,3);switch(1&i&&(this.s=n),i>>>=1){case 0:var r=this.input,a=this.c,s=this.a,c=this.b,l=e,u=e,h=e,_=s.length,f=e;switch(this.e=this.g=0,(l=r[a++])===e&&t(Error("invalid uncompressed block header: LEN (first byte)")),u=l,(l=r[a++])===e&&t(Error("invalid uncompressed block header: LEN (second byte)")),u|=l<<8,(l=r[a++])===e&&t(Error("invalid uncompressed block header: NLEN (first byte)")),h=l,(l=r[a++])===e&&t(Error("invalid uncompressed block header: NLEN (second byte)")),u===~(h|=l<<8)&&t(Error("invalid uncompressed block header: length verify")),a+u>r.length&&t(Error("input buffer is broken")),this.m){case M:for(;c+u>s.length;){if(u-=f=_-c,o)s.set(r.subarray(a,a+f),c),c+=f,a+=f;else for(;f--;)s[c++]=r[a++];this.b=c,s=this.f(),c=this.b}break;case O:for(;c+u>s.length;)s=this.f({v:2});break;default:t(Error("invalid inflate mode"))}if(o)s.set(r.subarray(a,a+u),c),c+=u,a+=u;else for(;u--;)s[c++]=r[a++];this.c=a,this.b=c,this.a=s;break;case 1:this.o(Q,$);break;case 2:nt(this);break;default:t(Error("unknown BTYPE: "+i))}}return this.t()};var L,F,z=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],V=o?new Uint16Array(z):z,G=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],U=o?new Uint16Array(G):G,k=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],H=o?new Uint8Array(k):k,j=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],W=o?new Uint16Array(j):j,q=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],X=o?new Uint8Array(q):q,Y=new(o?Uint8Array:Array)(288);for(L=0,F=Y.length;L<F;++L)Y[L]=143>=L?8:255>=L?9:279>=L?7:8;var K,J,Q=d(Y),Z=new(o?Uint8Array:Array)(30);for(K=0,J=Z.length;K<J;++K)Z[K]=5;var $=d(Z);function tt(n,i){for(var r,o=n.g,a=n.e,s=n.input,c=n.c;a<i;)(r=s[c++])===e&&t(Error("input buffer is broken")),o|=r<<a,a+=8;return r=o&(1<<i)-1,n.g=o>>>i,n.e=a-i,n.c=c,r}function et(n,i){for(var r,o,a,s=n.g,c=n.e,l=n.input,u=n.c,h=i[0],_=i[1];c<_;)(r=l[u++])===e&&t(Error("input buffer is broken")),s|=r<<c,c+=8;return a=(o=h[s&(1<<_)-1])>>>16,n.g=s>>a,n.e=c-a,n.c=u,65535&o}function nt(t){function e(t,e,n){var i,r,o,a;for(a=0;a<t;)switch(i=et(this,e)){case 16:for(o=3+tt(this,2);o--;)n[a++]=r;break;case 17:for(o=3+tt(this,3);o--;)n[a++]=0;r=0;break;case 18:for(o=11+tt(this,7);o--;)n[a++]=0;r=0;break;default:r=n[a++]=i}return n}var n,i,r,a,s=tt(t,5)+257,c=tt(t,5)+1,l=tt(t,4)+4,u=new(o?Uint8Array:Array)(V.length);for(a=0;a<l;++a)u[V[a]]=tt(t,3);n=d(u),i=new(o?Uint8Array:Array)(s),r=new(o?Uint8Array:Array)(c),t.o(d(e.call(t,s,n,i)),d(e.call(t,c,n,r)))}function it(e,n){var i,r;switch(this.input=e,this.c=0,!n&&(n={})||(n.index&&(this.c=n.index),n.verify&&(this.M=n.verify)),i=e[this.c++],r=e[this.c++],15&i){case ut:this.method=ut;break;default:t(Error("unsupported compression method"))}0!=((i<<8)+r)%31&&t(Error("invalid fcheck flag:"+((i<<8)+r)%31)),32&r&&t(Error("fdict flag is not supported")),this.A=new B(e,{index:this.c,bufferSize:n.bufferSize,bufferType:n.bufferType,resize:n.resize})}B.prototype.o=function(t,e){var n=this.a,i=this.b;this.u=t;for(var r,o,a,s,c=n.length-258;256!==(r=et(this,t));)if(256>r)i>=c&&(this.b=i,n=this.f(),i=this.b),n[i++]=r;else for(s=U[o=r-257],0<H[o]&&(s+=tt(this,H[o])),r=et(this,e),a=W[r],0<X[r]&&(a+=tt(this,X[r])),i>=c&&(this.b=i,n=this.f(),i=this.b);s--;)n[i]=n[i++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=i},B.prototype.I=function(t,e){var n=this.a,i=this.b;this.u=t;for(var r,o,a,s,c=n.length;256!==(r=et(this,t));)if(256>r)i>=c&&(c=(n=this.f()).length),n[i++]=r;else for(s=U[o=r-257],0<H[o]&&(s+=tt(this,H[o])),r=et(this,e),a=W[r],0<X[r]&&(a+=tt(this,X[r])),i+s>c&&(c=(n=this.f()).length);s--;)n[i]=n[i++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=i},B.prototype.f=function(){var t,e,n=new(o?Uint8Array:Array)(this.b-32768),i=this.b-32768,r=this.a;if(o)n.set(r.subarray(32768,n.length));else for(t=0,e=n.length;t<e;++t)n[t]=r[t+32768];if(this.k.push(n),this.q+=n.length,o)r.set(r.subarray(i,i+32768));else for(t=0;32768>t;++t)r[t]=r[i+t];return this.b=32768,r},B.prototype.J=function(t){var e,n,i,r=this.input.length/this.c+1|0,a=this.input,s=this.a;return t&&("number"==typeof t.v&&(r=t.v),"number"==typeof t.F&&(r+=t.F)),n=2>r?(i=(a.length-this.c)/this.u[2]/2*258|0)<s.length?s.length+i:s.length<<1:s.length*r,o?(e=new Uint8Array(n)).set(s):e=s,this.a=e},B.prototype.t=function(){var t,e,n,i,r,a=0,s=this.a,c=this.k,l=new(o?Uint8Array:Array)(this.q+(this.b-32768));if(0===c.length)return o?this.a.subarray(32768,this.b):this.a.slice(32768,this.b);for(e=0,n=c.length;e<n;++e)for(i=0,r=(t=c[e]).length;i<r;++i)l[a++]=t[i];for(e=32768,n=this.b;e<n;++e)l[a++]=s[e];return this.k=[],this.buffer=l},B.prototype.H=function(){var t,e=this.b;return o?this.B?(t=new Uint8Array(e)).set(this.a.subarray(0,e)):t=this.a.subarray(0,e):(this.a.length>e&&(this.a.length=e),t=this.a),this.buffer=t},it.prototype.p=function(){var e,n=this.input;return e=this.A.p(),this.c=this.A.c,this.M&&(n[this.c++]<<24|n[this.c++]<<16|n[this.c++]<<8|n[this.c++])>>>0!==a(e)&&t(Error("invalid adler-32 checksum")),e},r("Zlib.Inflate",it),r("Zlib.Inflate.BufferType",N),N.ADAPTIVE=N.C,N.BLOCK=N.D,r("Zlib.Inflate.prototype.decompress",it.prototype.p);var rt,ot,at=new(o?Uint8Array:Array)(288);for(rt=0,ot=at.length;rt<ot;++rt)at[rt]=143>=rt?8:255>=rt?9:279>=rt?7:8;d(at);var st,ct,lt=new(o?Uint8Array:Array)(30);for(st=0,ct=lt.length;st<ct;++st)lt[st]=5;d(lt);var ut=8}).call(Rlt);var Dlt=Rlt.Zlib;Dlt.Deflate=Dlt.Deflate,Dlt.Deflate.compress=Dlt.Deflate.compress,Dlt.Inflate=Dlt.Inflate,Dlt.Inflate.BufferType=Dlt.Inflate.BufferType,Dlt.Inflate.prototype.decompress=Dlt.Inflate.prototype.decompress;for(var Blt=function(){function t(t){var e,n=this;this.pos=8,this.palette=[],this.imgData=[],this.text={},this.width=0,this.height=0,this.bits=0,this.colorType=0,this.compressionMethod=0,this.filterMethod=0,this.interlaceMethod=0,this.colors=0,this.hasAlphaChannel=!1,this.pixelBitlength=0,this.data=t,this.transparency={indexed:[],rgb:0,grayscale:0};for(var i=0,r=0,o=0;;){o=this.readUInt32();var a=function(){var t=[];for(i=0;i<4;++i)t.push(String.fromCharCode(n.data[n.pos++]));return t}.call(this).join("");switch(a){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||1/0,frames:[]};break;case"PLTE":this.palette=this.read(o);break;case"fcTL":e&&this.animation.frames.push(e),this.pos+=4,e={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()};var s=this.readUInt16(),c=this.readUInt16()||100;e.delay=1e3*s/c,e.disposeOp=this.data[this.pos++],e.blendOp=this.data[this.pos++],e.data=[];break;case"IDAT":case"fdAT":for("fdAT"===a&&(this.pos+=4,o-=4),t=(null!=e?e.data:void 0)||this.imgData,i=0;o>=0?i<o:i>o;o>=0?++i:--i)t.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:this.transparency.indexed=this.read(o);var l=255-this.transparency.indexed.length;if(l>0)for(r=0;l>=0?r<l:r>l;l>=0?++r:--r)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(o)[0];break;case 2:this.transparency.rgb=this.read(o)}break;case"tEXt":var u=this.read(o),h=u.indexOf(0),_=String.fromCharCode.apply(String,u.slice(0,h));this.text[_]=String.fromCharCode.apply(String,u.slice(h+1));break;case"IEND":e&&this.animation.frames.push(e),this.colors=function(){switch(n.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}.call(this);var f=this.colorType;this.hasAlphaChannel=4===f||6===f;var p=this.colors+(this.hasAlphaChannel?1:0);return this.pixelBitlength=this.bits*p,this.colorSpace=function(){switch(n.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}.call(this),void(this.imgData instanceof Uint8Array||(this.imgData=new Uint8Array(this.imgData)));default:this.pos+=o}if(this.pos+=4,this.pos>this.data.length)throw new Error(R(6017))}}var e=t.prototype;return e.read=function(t){var e=0,n=[];for(e=0;t>=0?e<t:e>t;t>=0?++e:--e)n.push(this.data[this.pos++]);return n},e.readUInt32=function(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]},e.readUInt16=function(){return this.data[this.pos++]<<8|this.data[this.pos++]},e.decodePixels=function(t){if(null==t&&(t=this.imgData),0===t.length)return new Uint8Array(0);t=new Dlt.Inflate(t,{index:0,verify:!1}).decompress();for(var e=this.pixelBitlength/8,n=e*this.width,i=new Uint8Array(n*this.height),r=t.length,o=0,a=0,s=0,c=0,l=0,u=0,h=0,_=0,f=0,p=0,d=0,m=0,v=0,g=0,y=0,x=0,S=0,A=0,C=0;a<r;){switch(t[a++]){case 0:for(u=h=0;h<n;u=h+=1)i[s++]=t[a++];break;case 1:for(u=_=0;_<n;u=_+=1)c=t[a++],m=u<e?0:i[s-e],i[s++]=(c+m)%256;break;case 2:for(u=f=0;f<n;u=f+=1)c=t[a++],l=(u-u%e)/e,A=o&&i[(o-1)*n+l*e+u%e],i[s++]=(A+c)%256;break;case 3:for(u=p=0;p<n;u=p+=1)c=t[a++],l=(u-u%e)/e,m=u<e?0:i[s-e],A=o&&i[(o-1)*n+l*e+u%e],i[s++]=(c+Math.floor((m+A)/2))%256;break;case 4:for(u=d=0;d<n;u=d+=1)c=t[a++],l=(u-u%e)/e,m=u<e?0:i[s-e],0===o?A=C=0:(A=i[(o-1)*n+l*e+u%e],C=l&&i[(o-1)*n+(l-1)*e+u%e]),v=m+A-C,g=Math.abs(v-m),x=Math.abs(v-A),S=Math.abs(v-C),y=g<=x&&g<=S?m:x<=S?A:C,i[s++]=(c+y)%256;break;default:throw new Error(R(6018,t[a-1]))}o++}return i},e.copyToImageData=function(t,e){var n,i=this.hasAlphaChannel,r=this.colors;this.palette.length&&(n=null!=this._decodedPalette?this._decodedPalette:this._decodedPalette=this.decodePalette(),r=4,i=!0);var o=t.data||t,a=o.length,s=n||e,c=0,l=0,u=0,h=0;if(1===r)for(;c<a;)u=n?4*e[c/4]:l,h=s[u++],o[c++]=h,o[c++]=h,o[c++]=h,o[c++]=i?s[u++]:255,l=u;else for(;c<a;)u=n?4*e[c/4]:l,o[c++]=s[u++],o[c++]=s[u++],o[c++]=s[u++],o[c++]=i?s[u++]:255,l=u},e.decodePalette=function(){for(var t=this.palette,e=this.transparency.indexed||[],n=new Uint8Array((e.length||0)+t.length),i=0,r=0,o=0,a=0,s=0,c=t.length;s<c;a=s+=3)n[i++]=t[a],n[i++]=t[a+1],n[i++]=t[a+2],o=e[r++],n[i++]=null!=o?o:255;return n},e.render=function(t){t.width=this.width,t.height=this.height;var e=t.getContext("2d"),n=e.createImageData(this.width,this.height);return this.copyToImageData(n,this.decodePixels(null)),e.putImageData(n,0,0)},t}(),Mlt=function(){function t(){this._littleEndian=!1,this._tiffData=[],this._fileDirectories=[]}var e=t.prototype;return e.getUint8=function(t){return this._tiffData[t]},e.getUint16=function(t){return this._littleEndian?this._tiffData[t+1]<<8|this._tiffData[t]:this._tiffData[t]<<8|this._tiffData[t+1]},e.getUint32=function(t){var e=this._tiffData;return this._littleEndian?e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t]:e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]},e.checkLittleEndian=function(){var t=this.getUint16(0);if(18761===t)this._littleEndian=!0;else{if(19789!==t)throw console.log(t),TypeError(R(6019));this._littleEndian=!1}return this._littleEndian},e.hasTowel=function(){if(42!==this.getUint16(2))throw RangeError(R(6020));return!0},e.getFieldTypeName=function(t){return t in Nlt?Nlt[t]:null},e.getFieldTagName=function(t){return t in Olt?Olt[t]:(A(6021,t),"Tag"+t)},e.getFieldTypeLength=function(t){return-1!==["BYTE","ASCII","SBYTE","UNDEFINED"].indexOf(t)?1:-1!==["SHORT","SSHORT"].indexOf(t)?2:-1!==["LONG","SLONG","FLOAT"].indexOf(t)?4:-1!==["RATIONAL","SRATIONAL","DOUBLE"].indexOf(t)?8:0},e.getFieldValues=function(t,e,n,i){var r=[],o=this.getFieldTypeLength(e);if(o*n<=4)!1===this._littleEndian?r.push(i>>>8*(4-o)):r.push(i);else for(var a=0;a<n;a++){var s=o*a;o>=8?-1!==["RATIONAL","SRATIONAL"].indexOf(e)?(r.push(this.getUint32(i+s)),r.push(this.getUint32(i+s+4))):A(8e3):r.push(this.getBytes(o,i+s))}return"ASCII"===e&&r.forEach((function(t,e,n){n[e]=String.fromCharCode(t)})),r},e.getBytes=function(t,e){if(t<=0)A(8001);else{if(t<=1)return this.getUint8(e);if(t<=2)return this.getUint16(e);if(t<=3)return this.getUint32(e)>>>8;if(t<=4)return this.getUint32(e);A(8002)}return 0},e.getBits=function(t,e,n){n=n||0;var i=e+Math.floor(n/8),r=n+t,o=32-t,a=0,s=0;return r<=0?A(6023):r<=8?(a=24+n,s=this.getUint8(i)):r<=16?(a=16+n,s=this.getUint16(i)):r<=32?(a=n,s=this.getUint32(i)):A(6022),{bits:s<<a>>>o,byteOffset:i+Math.floor(r/8),bitOffset:r%8}},e.parseFileDirectory=function(t){var e=this.getUint16(t),n=[],i=0,r=0;for(i=t+2,r=0;r<e;i+=12,r++){var o=this.getUint16(i),a=this.getUint16(i+2),s=this.getUint32(i+4),c=this.getUint32(i+8),l=this.getFieldTagName(o),u=this.getFieldTypeName(a),h=this.getFieldValues(l,u,s,c);n[l]={type:u,values:h}}this._fileDirectories.push(n);var _=this.getUint32(i);0!==_&&this.parseFileDirectory(_)},e.clampColorSample=function(t,e){var n=Math.pow(2,8-e);return Math.floor(t*n+(n-1))},e.parseTIFF=function(t,e){var n=this;if(e=e||document.createElement("canvas"),this._tiffData=t,this._canvas=e,this.checkLittleEndian(),this.hasTowel()){var i=this.getUint32(4);this._fileDirectories.length=0,this.parseFileDirectory(i);var r=this._fileDirectories[0],o=r.ImageWidth.values[0],a=r.ImageLength.values[0];this._canvas.width=o,this._canvas.height=a;var s=[],c=r.Compression?r.Compression.values[0]:1,l=r.SamplesPerPixel.values[0],u=[],h=0,_=!1;r.BitsPerSample.values.forEach((function(t,e){u[e]={bitsPerSample:t,hasBytesPerSample:!1,bytesPerSample:void 0},t%8==0&&(u[e].hasBytesPerSample=!0,u[e].bytesPerSample=t/8),h+=t}),this);var f=0;h%8==0&&(_=!0,f=h/8);var p,d=r.StripOffsets.values,m=d.length;if(r.StripByteCounts)p=r.StripByteCounts.values;else{if(A(8003),1!==m)throw Error(R(6024));p=[Math.ceil(o*a*h/8)]}for(var v=1,g=1,y=0;y<m;y++){var x=d[y];s[y]=[];for(var S=p[y],C=0,b=0,T=1,E=!0,w=[],P=0,I=0,D=0;C<S;C+=T)switch(c){case 1:w=[];for(var B=0;B<l;B++){var M=u[B];if(!M.hasBytesPerSample){var O=this.getBits(M.bitsPerSample,x+C,b);throw w.push(O.bits),C=O.byteOffset-x,b=O.bitOffset,RangeError(R(6025))}var N=M.bytesPerSample*B;w.push(this.getBytes(M.bytesPerSample,x+C+N))}if(s[y].push(w),!_)throw T=0,RangeError(R(6026));T=f;break;case 2:case 3:case 4:case 5:case 6:case 7:break;case 32773:if(E){E=!1;var L=this.getUint8(x+C);L>=0&&L<=127?v=L+1:L>=-127&&L<=-1?g=1-L:E=!0}else{for(var F=this.getUint8(x+C),z=0;z<g;z++){var V=u[I];if(!V.hasBytesPerSample)throw RangeError(R(6025));D=D<<8*P|F,++P===V.bytesPerSample&&(w.push(D),D=P=0,I++),I===l&&(s[y].push(w),w=[],I=0)}0==--v&&(E=!0)}T=1}}if(e.getContext){var G=this._canvas.getContext("2d");G.fillStyle="rgba(255, 255, 255, 0)";var U=r.RowsPerStrip?r.RowsPerStrip.values[0]:a,k=s.length,H=a%U,j=0===H?U:H,W=U,q=0,X=r.PhotometricInterpretation.values[0],Y=[],K=0;r.ExtraSamples&&(K=(Y=r.ExtraSamples.values).length);var J=[],Q=0;r.ColorMap&&(J=r.ColorMap.values,Q=Math.pow(2,u[0].bitsPerSample));for(var Z=0;Z<k;Z++){Z+1===k&&(W=j);for(var $=s[Z].length,tt=q*Z,et=0,nt=0;et<W&&nt<$;et++)for(var it=0;it<o;it++,nt++){var rt=s[Z][nt],ot=0,at=0,st=0,ct=1;if(K>0)for(var lt=0;lt<K;lt++)if(1===Y[lt]||2===Y[lt]){ct=rt[3+lt]/256;break}!function(){switch(X){case 0:var t=0;u[0].hasBytesPerSample&&(t=Math.pow(16,2*u[0].bytesPerSample)),rt.forEach((function(e,n,i){i[n]=t-e}));case 1:ot=at=st=n.clampColorSample(rt[0],u[0].bitsPerSample);break;case 2:ot=n.clampColorSample(rt[0],u[0].bitsPerSample),at=n.clampColorSample(rt[1],u[1].bitsPerSample),st=n.clampColorSample(rt[2],u[2].bitsPerSample);break;case 3:if(void 0===J)throw Error(R(6027));var e=rt[0];ot=n.clampColorSample(J[e],16),at=n.clampColorSample(J[Q+e],16),st=n.clampColorSample(J[2*Q+e],16);break;default:throw RangeError(R(6028,X))}}(),G.fillStyle="rgba("+ot+", "+at+", "+st+", "+ct+")",G.fillRect(it,tt+et,1,1)}q=W}}return this._canvas}},t}(),Olt={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop"},Nlt={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE"},Llt=new Array(123),Flt=0;Flt<123;++Flt)Llt[Flt]=64;for(var zlt=0;zlt<64;++zlt)Llt["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(zlt)]=zlt;var Vlt={name:"Jacob__Codec__Base64",decode:function(t){var e,n,i,r,o,a,s=[],c=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");c<t.length;)e=Llt[t.charCodeAt(c++)]<<2|(r=Llt[t.charCodeAt(c++)])>>4,n=(15&r)<<4|(o=Llt[t.charCodeAt(c++)])>>2,i=(3&o)<<6|(a=Llt[t.charCodeAt(c++)]),s.push(String.fromCharCode(e)),64!==o&&s.push(String.fromCharCode(n)),64!==a&&s.push(String.fromCharCode(i));return s.join("")},decodeAsArray:function(t,e){var n,i,r,o=this.decode(t),a=[];for(n=0,r=o.length/e;n<r;n++)for(a[n]=0,i=e-1;i>=0;--i)a[n]+=o.charCodeAt(n*e+i)<<8*i;return a}},Glt=function(t){this.data=t,this.debug=!1,this.gpflags=void 0,this.files=0,this.unzipped=[],this.buf32k=new Array(32768),this.bIdx=0,this.modeZIP=!1,this.bytepos=0,this.bb=1,this.bits=0,this.nameBuf=[],this.fileout=void 0,this.literalTree=new Array(Glt.LITERALS),this.distanceTree=new Array(32),this.treepos=0,this.Places=null,this.len=0,this.fpos=new Array(17),this.fpos[0]=0,this.flens=void 0,this.fmax=void 0};Glt.gunzip=function(t){return t.constructor===Array||t.constructor,new Glt(t).gunzip()[0][0]},Glt.HufNode=function(){this.b0=0,this.b1=0,this.jump=null,this.jumppos=-1},Glt.LITERALS=288,Glt.NAMEMAX=256,Glt.bitReverse=[0,128,64,192,32,160,96,224,16,144,80,208,48,176,112,240,8,136,72,200,40,168,104,232,24,152,88,216,56,184,120,248,4,132,68,196,36,164,100,228,20,148,84,212,52,180,116,244,12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254,1,129,65,193,33,161,97,225,17,145,81,209,49,177,113,241,9,137,73,201,41,169,105,233,25,153,89,217,57,185,121,249,5,133,69,197,37,165,101,229,21,149,85,213,53,181,117,245,13,141,77,205,45,173,109,237,29,157,93,221,61,189,125,253,3,131,67,195,35,163,99,227,19,147,83,211,51,179,115,243,11,139,75,203,43,171,107,235,27,155,91,219,59,187,123,251,7,135,71,199,39,167,103,231,23,151,87,215,55,183,119,247,15,143,79,207,47,175,111,239,31,159,95,223,63,191,127,255],Glt.cplens=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],Glt.cplext=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,99,99],Glt.cpdist=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],Glt.cpdext=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],Glt.border=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Glt.prototype.gunzip=function(){return this.outputArr=[],this.nextFile(),this.unzipped},Glt.prototype.readByte=function(){return this.bits+=8,this.bytepos<this.data.length?this.data.charCodeAt(this.bytepos++):-1},Glt.prototype.byteAlign=function(){this.bb=1},Glt.prototype.readBit=function(){var t;return this.bits++,t=1&this.bb,this.bb>>=1,0===this.bb&&(this.bb=this.readByte(),t=1&this.bb,this.bb=this.bb>>1|128),t},Glt.prototype.readBits=function(t){for(var e=0,n=t;n--;)e=e<<1|this.readBit();return t&&(e=Glt.bitReverse[e]>>8-t),e},Glt.prototype.flushBuffer=function(){this.bIdx=0},Glt.prototype.addBuffer=function(t){this.buf32k[this.bIdx++]=t,this.outputArr.push(String.fromCharCode(t)),32768===this.bIdx&&(this.bIdx=0)},Glt.prototype.IsPat=function(){for(;;){if(this.fpos[this.len]>=this.fmax)return-1;if(this.flens[this.fpos[this.len]]===this.len)return this.fpos[this.len]++;this.fpos[this.len]++}},Glt.prototype.Rec=function(){var t,e=this.Places[this.treepos];if(17===this.len)return-1;if(this.treepos++,this.len++,(t=this.IsPat())>=0)e.b0=t;else if(e.b0=32768,this.Rec())return-1;if((t=this.IsPat())>=0)e.b1=t,e.jump=null;else if(e.b1=32768,e.jump=this.Places[this.treepos],e.jumppos=this.treepos,this.Rec())return-1;return this.len--,0},Glt.prototype.CreateTree=function(t,e,n){var i;for(this.Places=t,this.treepos=0,this.flens=n,this.fmax=e,i=0;i<17;i++)this.fpos[i]=0;return this.len=0,this.Rec()?-1:0},Glt.prototype.DecodeValue=function(t){for(var e,n,i=0,r=t[i];;)if(this.readBit()){if(!(32768&r.b1))return r.b1;for(r=r.jump,e=t.length,n=0;n<e;n++)if(t[n]===r){i=n;break}}else{if(!(32768&r.b0))return r.b0;r=t[++i]}return-1},Glt.prototype.DeflateLoop=function(){var t,e,n;do{var i,r;if(t=this.readBit(),0===(e=this.readBits(2)))for(this.byteAlign(),i=this.readByte(),i|=this.readByte()<<8,r=this.readByte(),65535&(i^~(r|=this.readByte()<<8))&&document.write("BlockLen checksum mismatch\n");i--;)o=this.readByte(),this.addBuffer(o);else if(1===e)for(;;)if((a=Glt.bitReverse[this.readBits(7)]>>1)>23?(a=a<<1|this.readBit())>199?a=(a-=128)<<1|this.readBit():(a-=48)>143&&(a+=136):a+=256,a<256)this.addBuffer(a);else{if(256===a)break;for(a-=257,p=this.readBits(Glt.cplext[a])+Glt.cplens[a],a=Glt.bitReverse[this.readBits(5)]>>3,Glt.cpdext[a]>8?(d=this.readBits(8),d|=this.readBits(Glt.cpdext[a]-8)<<8):d=this.readBits(Glt.cpdext[a]),d+=Glt.cpdist[a],a=0;a<p;a++){var o=this.buf32k[this.bIdx-d&32767];this.addBuffer(o)}}else if(2===e){var a,s,c,l,u,h=new Array(320);for(c=257+this.readBits(5),l=1+this.readBits(5),u=4+this.readBits(4),a=0;a<19;a++)h[a]=0;for(a=0;a<u;a++)h[Glt.border[a]]=this.readBits(3);for(p=this.distanceTree.length,n=0;n<p;n++)this.distanceTree[n]=new Glt.HufNode;if(this.CreateTree(this.distanceTree,19,h,0))return this.flushBuffer(),1;for(s=c+l,n=0;n<s;)if((a=this.DecodeValue(this.distanceTree))<16)h[n++]=a;else if(16===a){var _;if(n+(a=3+this.readBits(2))>s)return this.flushBuffer(),1;for(_=n?h[n-1]:0;a--;)h[n++]=_}else{if(n+(a=17===a?3+this.readBits(3):11+this.readBits(7))>s)return this.flushBuffer(),1;for(;a--;)h[n++]=0}for(p=this.literalTree.length,n=0;n<p;n++)this.literalTree[n]=new Glt.HufNode;if(this.CreateTree(this.literalTree,c,h,0))return this.flushBuffer(),1;for(p=this.literalTree.length,n=0;n<p;n++)this.distanceTree[n]=new Glt.HufNode;var f=new Array;for(n=c;n<h.length;n++)f[n-c]=h[n];if(this.CreateTree(this.distanceTree,l,f,0))return this.flushBuffer(),1;for(;;)if((a=this.DecodeValue(this.literalTree))>=256){var p,d;if(0==(a-=256))break;for(a--,p=this.readBits(Glt.cplext[a])+Glt.cplens[a],a=this.DecodeValue(this.distanceTree),Glt.cpdext[a]>8?(d=this.readBits(8),d|=this.readBits(Glt.cpdext[a]-8)<<8):d=this.readBits(Glt.cpdext[a]),d+=Glt.cpdist[a];p--;)o=this.buf32k[this.bIdx-d&32767],this.addBuffer(o)}else this.addBuffer(a)}}while(!t);return this.flushBuffer(),this.byteAlign(),0},Glt.prototype.unzipFile=function(t){var e;for(this.gunzip(),e=0;e<this.unzipped.length;e++)if(this.unzipped[e][1]===t)return this.unzipped[e][0]},Glt.prototype.nextFile=function(){this.outputArr=[],this.modeZIP=!1;var t=[];if(t[0]=this.readByte(),t[1]=this.readByte(),120===t[0]&&218===t[1]&&(this.DeflateLoop(),this.unzipped[this.files]=[this.outputArr.join(""),"geonext.gxt"],this.files++),31===t[0]&&139===t[1]&&(this.skipdir(),this.unzipped[this.files]=[this.outputArr.join(""),"file"],this.files++),80===t[0]&&75===t[1]&&(this.modeZIP=!0,t[2]=this.readByte(),t[3]=this.readByte(),3===t[2]&&4===t[3])){t[0]=this.readByte(),t[1]=this.readByte(),this.gpflags=this.readByte(),this.gpflags|=this.readByte()<<8;var e=this.readByte();e|=this.readByte()<<8,this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte();var n=this.readByte();n|=this.readByte()<<8;var i=this.readByte();for(i|=this.readByte()<<8,o=0,this.nameBuf=[];n--;){var r=this.readByte();"/"===r|":"===r?o=0:o<Glt.NAMEMAX-1&&(this.nameBuf[o++]=String.fromCharCode(r))}this.fileout||(this.fileout=this.nameBuf);for(var o=0;o<i;)r=this.readByte(),o++;8===e&&(this.DeflateLoop(),this.unzipped[this.files]=[this.outputArr.join(""),this.nameBuf.join("")],this.files++),this.skipdir()}},Glt.prototype.skipdir=function(){var t,e,n=[];if(8&this.gpflags&&(n[0]=this.readByte(),n[1]=this.readByte(),n[2]=this.readByte(),n[3]=this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte()),this.modeZIP&&this.nextFile(),n[0]=this.readByte(),8!==n[0])return 0;if(this.gpflags=this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),4&this.gpflags)for(n[0]=this.readByte(),n[2]=this.readByte(),this.len=n[0]+256*n[1],t=0;t<this.len;t++)this.readByte();if(8&this.gpflags)for(t=0,this.nameBuf=[];e=this.readByte();)"7"!==e&&":"!==e||(t=0),t<Glt.NAMEMAX-1&&(this.nameBuf[t++]=e);if(16&this.gpflags)for(;e=this.readByte(););2&this.gpflags&&(this.readByte(),this.readByte()),this.DeflateLoop(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.modeZIP&&this.nextFile()};var Ult,klt,Hlt,jlt,Wlt,qlt,Xlt,Ylt,Klt,Jlt,Qlt,Zlt,$lt,tut,eut,nut,iut,rut,out,aut,sut,cut,lut,uut,hut,_ut,fut,put,dut,mut,vut,gut,yut,xut,Sut,Aut,Cut,but,Tut,Eut,wut,Put,Iut,Rut,Dut,But,Mut,Out,Nut,Lut,Fut,zut,Vut,Gut,Uut,kut,Hut,jut,Wut,qut,Xut,Yut,Kut,Jut,Qut,Zut,$ut,tht,eht,nht,iht,rht,oht,aht,sht,cht,lht,uht,hht,_ht,fht,pht,dht,mht,vht,ght,yht,xht,Sht,Aht,Cht,bht,Tht,Eht,wht,Pht,Iht,Rht,Dht={name:"Jacob__Codec"};function Bht(t){var e=t.parent,n=t.getComponent(Xht);return e&&n?Bht(e):t.getComponentsInChildren(Xht)}Dht.Base64=Vlt,Dht.GZip=Glt,Dht.unzip=function(){return Dht.GZip.gunzip.apply(Dht.GZip,arguments)},Dht.unzipBase64=function(){var t=Dht.Base64.decode.apply(Dht.Base64,arguments);try{return Dht.GZip.gunzip.call(Dht.GZip,t)}catch(e){return t.slice(7)}},Dht.unzipBase64AsArray=function(t,e){e=e||1;var n,i,r,o=this.unzipBase64(t),a=[];for(n=0,r=o.length/e;n<r;n++)for(a[n]=0,i=e-1;i>=0;--i)a[n]+=o.charCodeAt(n*e+i)<<8*i;return a},Dht.unzipAsArray=function(t,e){e=e||1;var n,i,r,o=this.unzip(t),a=[];for(n=0,r=o.length/e;n<r;n++)for(a[n]=0,i=e-1;i>=0;--i)a[n]+=o.charCodeAt(n*e+i)<<8*i;return a},function(t){t[t.JPG=0]="JPG",t[t.PNG=1]="PNG",t[t.TIFF=2]="TIFF",t[t.WEBP=3]="WEBP",t[t.PVR=4]="PVR",t[t.ETC=5]="ETC",t[t.S3TC=6]="S3TC",t[t.ATITC=7]="ATITC",t[t.TGA=8]="TGA",t[t.RAWDATA=9]="RAWDATA",t[t.UNKNOWN=10]="UNKNOWN"}(Rht||(Rht={}));var Mht,Oht,Nht,Lht,Fht,zht,Vht,Ght,Uht,kht,Hht,jht,Wht,qht,Xht=t("ParticleSystem2D",(Ult=qc("cc.ParticleSystem2D"),klt=rl(),Hlt=fl(),jlt=El(Ilt),Wlt=fl(),qlt=El(RX),Xlt=fl(),Ylt=fl(),Klt=fl(),Jlt=fl(),Qlt=fl(),Zlt=fl(),$lt=fl(),tut=fl(),eut=ul(),nut=fl(),iut=fl(),rut=fl(),out=fl(),aut=fl(),sut=fl(),cut=fl(),lut=fl(),uut=fl(),hut=fl(),_ut=fl(),fut=fl(),put=fl(),dut=El(ylt),mut=fl(),vut=fl(),gut=El(glt),yut=fl(),xut=fl(),Sut=fl(),Aut=fl(),Cut=fl(),but=fl(),Tut=fl(),Eut=fl(),wut=fl(),Put=fl(),Iut=fl(),Rut=fl(),Dut=fl(),But=fl(),Mut=fl(),Out=fl(),Nut=fl(),Lut=$c("preview"),Ult(Fut=klt(Fut=ol(Fut=il((Iht=Pht=function(t){function e(){var e;return q(e=t.call(this)||this,"duration",Vut,H(e)),q(e,"emissionRate",Gut,H(e)),q(e,"life",Uut,H(e)),q(e,"lifeVar",kut,H(e)),q(e,"angle",Hut,H(e)),q(e,"angleVar",jut,H(e)),q(e,"startSize",Wut,H(e)),q(e,"startSizeVar",qut,H(e)),q(e,"endSize",Xut,H(e)),q(e,"endSizeVar",Yut,H(e)),q(e,"startSpin",Kut,H(e)),q(e,"startSpinVar",Jut,H(e)),q(e,"endSpin",Qut,H(e)),q(e,"endSpinVar",Zut,H(e)),q(e,"sourcePos",$ut,H(e)),q(e,"posVar",tht,H(e)),q(e,"emitterMode",eht,H(e)),q(e,"gravity",nht,H(e)),q(e,"speed",iht,H(e)),q(e,"speedVar",rht,H(e)),q(e,"tangentialAccel",oht,H(e)),q(e,"tangentialAccelVar",aht,H(e)),q(e,"radialAccel",sht,H(e)),q(e,"radialAccelVar",cht,H(e)),q(e,"rotationIsDir",lht,H(e)),q(e,"startRadius",uht,H(e)),q(e,"startRadiusVar",hht,H(e)),q(e,"endRadius",_ht,H(e)),q(e,"endRadiusVar",fht,H(e)),q(e,"rotatePerS",pht,H(e)),q(e,"rotatePerSVar",dht,H(e)),e.aspectRatio=1,q(e,"playOnLoad",mht,H(e)),q(e,"autoRemoveOnFinish",vht,H(e)),q(e,"_preview",ght,H(e)),q(e,"_custom",yht,H(e)),q(e,"_file",xht,H(e)),q(e,"_spriteFrame",Sht,H(e)),q(e,"_totalParticles",Aht,H(e)),q(e,"_startColor",Cht,H(e)),q(e,"_startColorVar",bht,H(e)),q(e,"_endColor",Tht,H(e)),q(e,"_endColorVar",Eht,H(e)),q(e,"_positionType",wht,H(e)),e._stopped=!0,e.initProperties(),e}F(e,t);var n=e.prototype;return n.onEnable=function(){t.prototype.onEnable.call(this),this._updateMaterial()},n.onDestroy=function(){t.prototype.onDestroy.call(this),this.autoRemoveOnFinish&&(this.autoRemoveOnFinish=!1),this._simulator.uvFilled=0,this._simulator.renderData&&this._assembler&&this._assembler.removeData(this._simulator.renderData)},n.initProperties=function(){this._previewTimer=null,this._focused=!1,this.aspectRatio=1,this._simulator=new Plt(this)},n.onFocusInEditor=function(){this._focused=!0;for(var t=Bht(this.node),e=0;e<t.length;++e)t[e]._startPreview()},n.onLostFocusInEditor=function(){this._focused=!1;for(var t=Bht(this.node),e=0;e<t.length;++e)t[e]._stopPreview()},n._startPreview=function(){this._preview&&this.resetSystem()},n._stopPreview=function(){this._preview&&(this.resetSystem(),this.stopSystem()),this._previewTimer&&clearInterval(this._previewTimer)},n.__preload=function(){t.prototype.__preload.call(this),this._custom&&this.spriteFrame&&!this._renderSpriteFrame?this._applySpriteFrame():this._file&&(this._custom?!this._getTexture()&&this._applyFile():this._applyFile()),this.playOnLoad&&this.resetSystem()},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this._assembler=t),this._assembler&&this._assembler.createData&&(this._simulator.renderData=this._assembler.createData(this))},n.lateUpdate=function(t){this._simulator.finished||this._simulator.step(t)},n.addParticle=function(){},n.stopSystem=function(){this._stopped=!0,this._simulator.stop()},n.resetSystem=function(){this._stopped=!1,this._simulator.reset(),this._renderFlag=this._canRender()},n.isFull=function(){return this.particleCount>=this.totalParticles},n._applyFile=function(){var t=this._file;if(t){if(!t)return void E(6029);if(!this.isValid)return;this._plistFile=t.nativeUrl,this._custom||(this._spriteFrame!==t.spriteFrame&&(this.spriteFrame=t.spriteFrame),this._initWithDictionary(t._nativeAsset)),this._spriteFrame?!this._renderSpriteFrame&&this._spriteFrame&&this._applySpriteFrame():t.spriteFrame?this.spriteFrame=t.spriteFrame:this._custom&&this._initTextureWithDictionary(t._nativeAsset)}},n._initTextureWithDictionary=function(t){var e,n=this;if(t.spriteFrameUuid){var i=t.spriteFrameUuid;QO.loadAny(i,(function(e,i){e?(t.spriteFrameUuid=void 0,n._initTextureWithDictionary(t),d(e)):n.spriteFrame=i}))}else{var r=Tn(this._plistFile,t.textureFileName||"");if(t.textureFileName)QO.loadRemote(r,(function(e,i){e?(t.textureFileName=void 0,n._initTextureWithDictionary(t),d(e)):n.spriteFrame=i?RX.createWithImage(i):RX.createWithImage(Cv.get("white-texture"))}));else if(t.textureImageData){var o=t.textureImageData;if(!(o&&o.length>0))return!1;var a=QO.assets.get(r);if(!a){var s=Dht.unzipBase64AsArray(o,1);if(!s)return b(6030,this._file.name),!1;var c=(e=s).length>8&&137===e[0]&&80===e[1]&&78===e[2]&&71===e[3]&&13===e[4]&&10===e[5]&&26===e[6]&&10===e[7]?Rht.PNG:e.length>2&&(73===e[0]&&73===e[1]||77===e[0]&&77===e[1]||255===e[0]&&216===e[1])?Rht.TIFF:Rht.UNKNOWN;if(c!==Rht.TIFF&&c!==Rht.PNG)return b(6031,this._file.name),!1;var l=document.createElement("canvas");c===Rht.PNG?new Blt(s).render(l):(this._tiffReader||(this._tiffReader=new Mlt),this._tiffReader.parseTIFF(s,l)),a=new ym(l),QO.assets.add(r,a)}a||b(6032,this._file.name),this.spriteFrame=a?RX.createWithImage(a):RX.createWithImage(Cv.get("white-texture"))}}return!0},n._initWithDictionary=function(t){this.totalParticles=parseInt(t.maxParticles||0),this.life=parseFloat(t.particleLifespan||0),this.lifeVar=parseFloat(t.particleLifespanVariance||0);var e=t.emissionRate;this.emissionRate=e||Math.min(this.totalParticles/this.life,Number.MAX_VALUE),this.duration=parseFloat(t.duration||0),this._srcBlendFactor=parseInt(t.blendFuncSource||Ir.SRC_ALPHA),this._dstBlendFactor=parseInt(t.blendFuncDestination||Ir.ONE_MINUS_SRC_ALPHA);var n=this._startColor;n.r=255*parseFloat(t.startColorRed||0),n.g=255*parseFloat(t.startColorGreen||0),n.b=255*parseFloat(t.startColorBlue||0),n.a=255*parseFloat(t.startColorAlpha||0);var i=this._startColorVar;i.r=255*parseFloat(t.startColorVarianceRed||0),i.g=255*parseFloat(t.startColorVarianceGreen||0),i.b=255*parseFloat(t.startColorVarianceBlue||0),i.a=255*parseFloat(t.startColorVarianceAlpha||0);var r=this._endColor;r.r=255*parseFloat(t.finishColorRed||0),r.g=255*parseFloat(t.finishColorGreen||0),r.b=255*parseFloat(t.finishColorBlue||0),r.a=255*parseFloat(t.finishColorAlpha||0);var o=this._endColorVar;if(o.r=255*parseFloat(t.finishColorVarianceRed||0),o.g=255*parseFloat(t.finishColorVarianceGreen||0),o.b=255*parseFloat(t.finishColorVarianceBlue||0),o.a=255*parseFloat(t.finishColorVarianceAlpha||0),this.startSize=parseFloat(t.startParticleSize||0),this.startSizeVar=parseFloat(t.startParticleSizeVariance||0),this.endSize=parseFloat(t.finishParticleSize||0),this.endSizeVar=parseFloat(t.finishParticleSizeVariance||0),this.positionType=parseFloat(void 0!==t.positionType?t.positionType:ylt.FREE),this.sourcePos.set(0,0),this.posVar.set(parseFloat(t.sourcePositionVariancex||0),parseFloat(t.sourcePositionVariancey||0)),this.angle=parseFloat(t.angle||0),this.angleVar=parseFloat(t.angleVariance||0),this.startSpin=parseFloat(t.rotationStart||0),this.startSpinVar=parseFloat(t.rotationStartVariance||0),this.endSpin=parseFloat(t.rotationEnd||0),this.endSpinVar=parseFloat(t.rotationEndVariance||0),this.emitterMode=parseInt(t.emitterType||glt.GRAVITY),this.emitterMode===glt.GRAVITY){this.gravity.set(parseFloat(t.gravityx||0),parseFloat(t.gravityy||0)),this.speed=parseFloat(t.speed||0),this.speedVar=parseFloat(t.speedVariance||0),this.radialAccel=parseFloat(t.radialAcceleration||0),this.radialAccelVar=parseFloat(t.radialAccelVariance||0),this.tangentialAccel=parseFloat(t.tangentialAcceleration||0),this.tangentialAccelVar=parseFloat(t.tangentialAccelVariance||0);var a=t.rotationIsDir||"";null!==a?(a=a.toString().toLowerCase(),this.rotationIsDir="true"===a||"1"===a):this.rotationIsDir=!1}else{if(this.emitterMode!==glt.RADIUS)return b(6009),!1;this.startRadius=parseFloat(t.maxRadius||0),this.startRadiusVar=parseFloat(t.maxRadiusVariance||0),this.endRadius=parseFloat(t.minRadius||0),this.endRadiusVar=parseFloat(t.minRadiusVariance||0),this.rotatePerS=parseFloat(t.rotatePerSecond||0),this.rotatePerSVar=parseFloat(t.rotatePerSecondVariance||0)}return this._initTextureWithDictionary(t),!0},n._syncAspect=function(){if(this._renderSpriteFrame){var t=this._renderSpriteFrame.rect;this.aspectRatio=t.width/t.height}},n._applySpriteFrame=function(){this._renderSpriteFrame=this._renderSpriteFrame||this._spriteFrame,this._renderSpriteFrame?this._renderSpriteFrame.texture&&(this._simulator.updateUVs(!0),this._syncAspect(),this._updateMaterial(),this._stopped=!1,this._renderFlag=this._canRender()):this.resetSystem()},n._getTexture=function(){return this._renderSpriteFrame&&this._renderSpriteFrame.texture},n._updateMaterial=function(){var t=this.getMaterialInstance(0);t&&t.recompileShaders({USE_LOCAL:this._positionType!==ylt.FREE})},n._finishedSimulation=function(){this.resetSystem(),this.stopSystem(),this._renderFlag=this._canRender(),this.autoRemoveOnFinish&&this._stopped&&this.node.destroy()},n._canRender=function(){return t.prototype._canRender.call(this)&&!this._stopped&&null!==this._renderSpriteFrame},n._render=function(t){this._positionType===ylt.RELATIVE?t.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,this.node.parent):this.positionType===ylt.GROUPED?t.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,this.node):t.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,null)},N(e,[{key:"custom",get:function(){return this._custom},set:function(t){this._custom!==t&&(this._custom=t,this._applyFile())}},{key:"file",get:function(){return this._file},set:function(t){this._file!==t&&(this._file=t,t?this._applyFile():this.custom=!0)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){this._renderSpriteFrame!==t&&(this._renderSpriteFrame=t,t&&!t._uuid||(this._spriteFrame=t),this._applySpriteFrame())}},{key:"particleCount",get:function(){return this._simulator.particles.length}},{key:"totalParticles",get:function(){return this._totalParticles},set:function(t){this._totalParticles!==t&&(this._totalParticles=t)}},{key:"startColor",get:function(){return this._startColor},set:function(t){this._startColor.r=t.r,this._startColor.g=t.g,this._startColor.b=t.b,this._startColor.a=t.a}},{key:"startColorVar",get:function(){return this._startColorVar},set:function(t){this._startColorVar.r=t.r,this._startColorVar.g=t.g,this._startColorVar.b=t.b,this._startColorVar.a=t.a}},{key:"color",get:function(){return this._color},set:function(){}},{key:"endColor",get:function(){return this._endColor},set:function(t){this._endColor.r=t.r,this._endColor.g=t.g,this._endColor.b=t.b,this._endColor.a=t.a}},{key:"endColorVar",get:function(){return this._endColorVar},set:function(t){this._endColorVar.r=t.r,this._endColorVar.g=t.g,this._endColorVar.b=t.b,this._endColorVar.a=t.a}},{key:"positionType",get:function(){return this._positionType},set:function(t){this._positionType=t,this._updateMaterial()}},{key:"preview",get:function(){return this._preview},set:function(t){t?this._startPreview():this._stopPreview(),this._preview=t}},{key:"stopped",get:function(){return this._stopped}},{key:"active",get:function(){return this._simulator.active}},{key:"assembler",get:function(){return this._assembler}}]),e}(FJ),Pht.EmitterMode=glt,Pht.PositionType=ylt,Pht.DURATION_INFINITY=-1,Pht.START_SIZE_EQUAL_TO_END_SIZE=-1,Pht.START_RADIUS_EQUAL_TO_END_RADIUS=-1,X((zut=Iht).prototype,"custom",[ll,Hlt],Object.getOwnPropertyDescriptor(zut.prototype,"custom"),zut.prototype),X(zut.prototype,"file",[jlt,Wlt],Object.getOwnPropertyDescriptor(zut.prototype,"file"),zut.prototype),X(zut.prototype,"spriteFrame",[qlt,Xlt],Object.getOwnPropertyDescriptor(zut.prototype,"spriteFrame"),zut.prototype),X(zut.prototype,"totalParticles",[ll,Ylt],Object.getOwnPropertyDescriptor(zut.prototype,"totalParticles"),zut.prototype),Vut=X(zut.prototype,"duration",[Zc,ll,Klt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Gut=X(zut.prototype,"emissionRate",[Zc,ll,Jlt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),Uut=X(zut.prototype,"life",[Zc,ll,Qlt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),kut=X(zut.prototype,"lifeVar",[Zc,ll,Zlt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(zut.prototype,"startColor",[ll,$lt],Object.getOwnPropertyDescriptor(zut.prototype,"startColor"),zut.prototype),X(zut.prototype,"startColorVar",[ll,tut],Object.getOwnPropertyDescriptor(zut.prototype,"startColorVar"),zut.prototype),X(zut.prototype,"color",[eut],Object.getOwnPropertyDescriptor(zut.prototype,"color"),zut.prototype),X(zut.prototype,"endColor",[ll,nut],Object.getOwnPropertyDescriptor(zut.prototype,"endColor"),zut.prototype),X(zut.prototype,"endColorVar",[ll,iut],Object.getOwnPropertyDescriptor(zut.prototype,"endColorVar"),zut.prototype),Hut=X(zut.prototype,"angle",[Zc,ll,rut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 90}}),jut=X(zut.prototype,"angleVar",[Zc,ll,out],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),Wut=X(zut.prototype,"startSize",[Zc,ll,aut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),qut=X(zut.prototype,"startSizeVar",[Zc,ll,sut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xut=X(zut.prototype,"endSize",[Zc,ll,cut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Yut=X(zut.prototype,"endSizeVar",[Zc,ll,lut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Kut=X(zut.prototype,"startSpin",[Zc,ll,uut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jut=X(zut.prototype,"startSpinVar",[Zc,ll,hut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Qut=X(zut.prototype,"endSpin",[Zc,ll,_ut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Zut=X(zut.prototype,"endSpinVar",[Zc,ll,fut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$ut=X(zut.prototype,"sourcePos",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return li.ZERO.clone()}}),tht=X(zut.prototype,"posVar",[Zc,ll,put],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return li.ZERO.clone()}}),X(zut.prototype,"positionType",[dut,mut],Object.getOwnPropertyDescriptor(zut.prototype,"positionType"),zut.prototype),X(zut.prototype,"preview",[ll,vut],Object.getOwnPropertyDescriptor(zut.prototype,"preview"),zut.prototype),eht=X(zut.prototype,"emitterMode",[Zc,ll,gut,yut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return glt.GRAVITY}}),nht=X(zut.prototype,"gravity",[Zc,ll,xut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return li.ZERO.clone()}}),iht=X(zut.prototype,"speed",[Zc,ll,Sut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 180}}),rht=X(zut.prototype,"speedVar",[Zc,ll,Aut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),oht=X(zut.prototype,"tangentialAccel",[Zc,ll,Cut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 80}}),aht=X(zut.prototype,"tangentialAccelVar",[Zc,ll,but],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sht=X(zut.prototype,"radialAccel",[Zc,ll,Tut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cht=X(zut.prototype,"radialAccelVar",[Zc,ll,Eut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lht=X(zut.prototype,"rotationIsDir",[Zc,ll,wut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),uht=X(zut.prototype,"startRadius",[Zc,ll,Put],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hht=X(zut.prototype,"startRadiusVar",[Zc,ll,Iut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_ht=X(zut.prototype,"endRadius",[Zc,ll,Rut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fht=X(zut.prototype,"endRadiusVar",[Zc,ll,Dut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pht=X(zut.prototype,"rotatePerS",[Zc,ll,But],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dht=X(zut.prototype,"rotatePerSVar",[Zc,ll,Mut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mht=X(zut.prototype,"playOnLoad",[Zc,ll,Out],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),vht=X(zut.prototype,"autoRemoveOnFinish",[Zc,ll,Nut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ght=X(zut.prototype,"_preview",[Lut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),yht=X(zut.prototype,"_custom",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xht=X(zut.prototype,"_file",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sht=X(zut.prototype,"_spriteFrame",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Aht=X(zut.prototype,"_totalParticles",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 150}}),Cht=X(zut.prototype,"_startColor",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Li(255,255,255,255)}}),bht=X(zut.prototype,"_startColorVar",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Li(0,0,0,0)}}),Tht=X(zut.prototype,"_endColor",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Li(255,255,255,0)}}),Eht=X(zut.prototype,"_endColorVar",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Li(0,0,0,0)}}),wht=X(zut.prototype,"_positionType",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ylt.FREE}}),Fut=zut))||Fut)||Fut)||Fut)||Fut)),Yht=function(){function t(t,e){this.point=new li,this.dir=new li,this.distance=0,this.time=0,t&&this.point.set(t),e&&this.dir.set(e)}var e=t.prototype;return e.setPoint=function(t,e){this.point.x=t,this.point.y=e},e.setDir=function(t,e){this.dir.x=t,this.dir.y=e},t}(),Kht=t("MotionStreak",(Mht=qc("cc.MotionStreak"),Oht=rl(),Nht=cl(),Lht=El(jm),Mht(Fht=il(Fht=ol(Fht=Oht(Fht=Nht((qht=Wht=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_preview",Vht,H(e)),q(e,"_fadeTime",Ght,H(e)),q(e,"_minSeg",Uht,H(e)),q(e,"_stroke",kht,H(e)),q(e,"_texture",Hht,H(e)),q(e,"_fastMode",jht,H(e)),e._points=[],e}F(e,t);var n=e.prototype;return n.onEnable=function(){t.prototype.onEnable.call(this),this.reset()},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},n.onFocusInEditor=function(){this._preview&&this.reset()},n.onLostFocusInEditor=function(){this._preview&&this.reset()},n.reset=function(){this._points.length=0,this._renderData&&this._renderData.clear()},n.lateUpdate=function(t){this._assembler&&this._assembler.update(this,t)},n._render=function(t){t.commitComp(this,this.renderData,this._texture,this._assembler,null)},N(e,[{key:"preview",get:function(){return this._preview},set:function(t){this._preview=t,this.reset()}},{key:"fadeTime",get:function(){return this._fadeTime},set:function(t){this._fadeTime=t,this.reset()}},{key:"minSeg",get:function(){return this._minSeg},set:function(t){this._minSeg=t}},{key:"stroke",get:function(){return this._stroke},set:function(t){this._stroke=t}},{key:"texture",get:function(){return this._texture},set:function(t){this._texture!==t&&(this._texture=t)}},{key:"fastMode",get:function(){return this._fastMode},set:function(t){this._fastMode=t}},{key:"points",get:function(){return this._points}}]),e}(FJ),Wht.Point=Yht,X((zht=qht).prototype,"preview",[ll],Object.getOwnPropertyDescriptor(zht.prototype,"preview"),zht.prototype),X(zht.prototype,"fadeTime",[ll],Object.getOwnPropertyDescriptor(zht.prototype,"fadeTime"),zht.prototype),X(zht.prototype,"minSeg",[ll],Object.getOwnPropertyDescriptor(zht.prototype,"minSeg"),zht.prototype),X(zht.prototype,"stroke",[ll],Object.getOwnPropertyDescriptor(zht.prototype,"stroke"),zht.prototype),X(zht.prototype,"texture",[Lht],Object.getOwnPropertyDescriptor(zht.prototype,"texture"),zht.prototype),X(zht.prototype,"fastMode",[ll],Object.getOwnPropertyDescriptor(zht.prototype,"fastMode"),zht.prototype),Vht=X(zht.prototype,"_preview",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ght=X(zht.prototype,"_fadeTime",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Uht=X(zht.prototype,"_minSeg",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),kht=X(zht.prototype,"_stroke",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),Hht=X(zht.prototype,"_texture",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jht=X(zht.prototype,"_fastMode",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Fht=zht))||Fht)||Fht)||Fht)||Fht)||Fht)),Jht=(new li,new li),Qht=new li;function Zht(t,e){return t.x=-e.y,t.y=e.x,t}var $ht={createData:function(t){var e=t.requestRenderData();return e.dataLength=4,e.resize(16,42),e},update:function(t,e){var n,i=t.stroke/2,r=t.node.worldMatrix,o=r.m12,a=r.m13,s=t.points;if(s.length>1){var c=s[0],l=c.point.x-o,u=c.point.y-a;l*l+u*u<t.minSeg&&(n=c)}n||(n=new Kht.Point,s.unshift(n)),n.setPoint(o,a),n.time=t.fadeTime+e;var h,_=0;if(!(s.length<2)){var f=t.renderData;this.updateRenderDataCache(t,f);var p=t.color,d=p.r,m=p.g,v=p.b,g=p.a,y=s[1];y.distance=li.subtract(Qht,n.point,y.point).length(),Qht.normalize(),y.setDir(Qht.x,Qht.y),n.setDir(Qht.x,Qht.y),f.dataLength=2*s.length;for(var x=f.data,S=t.fadeTime,A=!1,C=s.length-1;C>=0;C--){var b=s[C],T=b.point,E=b.dir;if(b.time-=e,b.time<0)s.splice(C,1);else{var w=b.time/S,P=s[C-1];if(!A){if(!P){s.splice(C,1);continue}T.x=P.point.x-E.x*w,T.y=P.point.y-E.y*w}A=!0,Zht(Jht,E);var I=(w*g<<24>>>0)+(v<<16)+(m<<8)+d,R=_;x[R].x=T.x+Jht.x*i,x[R].y=T.y+Jht.y*i,x[R].u=1,x[R].v=w,x[R].color._val=I,x[R+=1].x=T.x-Jht.x*i,x[R].y=T.y-Jht.y*i,x[R].u=0,x[R].v=w,x[R].color._val=I,_+=2}}h=_<=2?0:3*(_-2),f.resize(_,h)}},updateRenderDataCache:function(t,e){e.passDirty&&e.updatePass(t),e.nodeDirty&&e.updateNode(t),e.textureDirty&&t.texture&&(e.updateTexture(t.texture),e.material=t.getRenderMaterial(0)),e.hashDirty&&e.updateHash()},updateRenderData:function(){},fillBuffers:function(t){for(var e=t.renderData,n=e.chunk,i=e.data,r=e.vertexCount,o=e.indexCount,a=n.vb,s=0,c=0;c<r;c++){var l=i[c];a[s++]=l.x,a[s++]=l.y,a[s++]=l.z,a[s++]=l.u,a[s++]=l.v,Li.toArray(a,l.color,s),s+=4}for(var u=n.bufferId,h=n.vertexOffset,_=n.vertexAccessor.getMeshBuffer(n.bufferId),f=n.vertexAccessor.getIndexBuffer(u),p=_.indexOffset,d=0,m=o;d<m;d+=2){var v=h+d;f[p++]=v,f[p++]=v+2,f[p++]=v+1,f[p++]=v+1,f[p++]=v+2,f[p++]=v+3}_.indexOffset+=e.indexCount,_.setDirty()}},t_t=t("MotionStreakAssemblerManager",{getAssembler:function(){return $ht}});Kht.Assembler=t_t;var e_t,n_t,i_t,r_t={maxParticleDeltaTime:0,createData:function(){return GY.add()},removeData:function(t){GY.remove(t)},updateRenderData:function(){},fillBuffers:function(){}},o_t=t("ParticleSystem2DAssembler",{getAssembler:function(){return r_t.maxParticleDeltaTime||(r_t.maxParticleDeltaTime=i.game.frameTime/1e3*2),r_t}});Xht.Assembler=o_t,function(t){t.PLAYED="play",t.PAUSED="pause",t.STOPPED="stop",t.SEEKED="seeked",t.ENDED="ended",t.INTERRUPTION_BEGIN="interruptionBegin",t.INTERRUPTION_END="interruptionEnd",t.USER_GESTURE="on_gesture"}(e_t||(e_t={})),function(t){t[t.DOM_AUDIO=0]="DOM_AUDIO",t[t.WEB_AUDIO=1]="WEB_AUDIO",t[t.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",t[t.NATIVE_AUDIO=3]="NATIVE_AUDIO",t[t.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(n_t||(n_t={})),function(t){t[t.INIT=0]="INIT",t[t.PLAYING=1]="PLAYING",t[t.PAUSED=2]="PAUSED",t[t.STOPPED=3]="STOPPED",t[t.INTERRUPTED=4]="INTERRUPTED"}(i_t||(i_t={}));var a_t,s_t=0;function c_t(t,e){var n;e.invoking||(e.invoking=!0,(n=e.func).call.apply(n,[t].concat(e.args)).then((function(){e.invoking=!1,t._operationQueue.shift(),t._eventTarget.emit(e.id.toString());var n=t._operationQueue[0];n&&c_t(t,n)})).catch((function(){})))}function l_t(t,e,n){var i=n.value;n.value=function(){for(var t=this,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return new Promise((function(e){var r=s_t++,o=t;o._operationQueue.push({id:r,func:i,args:n,invoking:!1}),o._eventTarget.once(r.toString(),e),c_t(o,o._operationQueue[0])}))}}function u_t(t){return new Promise((function(e){var n=t.play();return void 0===n?e():(n.then(e).catch((function(){var n=function(){t.play().catch((function(){})),e()},i=document.getElementById("GameCanvas");null==i||i.addEventListener("touchend",n,{once:!0}),null==i||i.addEventListener("mousedown",n,{once:!0})})),null)}))}var h_t,__t,f_t=function(){function t(t,e){this._domAudio=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._domAudio=t,t.volume=e}var e=t.prototype;return e.play=function(){var t=this;u_t(this._domAudio).then((function(){var e;null===(e=t.onPlay)||void 0===e||e.call(t)})).catch((function(){}))},e.stop=function(){this._domAudio.pause()},N(t,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(t){this._onPlayCb=t}},{key:"onEnd",get:function(){return this._onEndCb},set:function(t){this._onEndCb&&this._domAudio.removeEventListener("ended",this._onEndCb),this._onEndCb=t,t&&this._domAudio.addEventListener("ended",t)}}]),t}(),p_t=(X((a_t=function(){function t(t){var e=this;this._domAudio=void 0,this._state=i_t.INIT,this._onEnded=void 0,this._eventTarget=new pn,this._operationQueue=[],this._domAudio=t,dn.on("hide",this._onHide,this),dn.on("show",this._onShow,this),this._onEnded=function(){e.seek(0).catch((function(){})),e._state=i_t.INIT,e._eventTarget.emit(e_t.ENDED)},this._domAudio.addEventListener("ended",this._onEnded)}var e=t.prototype;return e.destroy=function(){dn.off("hide",this._onHide,this),dn.off("show",this._onShow,this),this._domAudio.removeEventListener("ended",this._onEnded),this._domAudio=null},t.load=function(e){return new Promise((function(n){t.loadNative(e).then((function(e){n(new t(e))})).catch((function(){}))}))},t.loadNative=function(t){return new Promise((function(e,n){var i=document.createElement("audio"),r="canplaythrough";dn.os===hn.IOS?r="loadedmetadata":dn.browserType===cn.FIREFOX&&(r="canplay");var o=setTimeout((function(){0===i.readyState?c():s()}),8e3),a=function(){clearTimeout(o),i.removeEventListener(r,s,!1),i.removeEventListener("error",c,!1)},s=function(){a(),e(i)},c=function(){a(),n("load audio failure - "+t)};i.addEventListener(r,s,!1),i.addEventListener("error",c,!1),i.src=t}))},t.loadOneShotAudio=function(e,n){return new Promise((function(i,r){t.loadNative(e).then((function(t){var e=new f_t(t,n);i(e)})).catch(r)}))},e._onHide=function(){var t=this;this._state===i_t.PLAYING&&this.pause().then((function(){t._state=i_t.INTERRUPTED,t._eventTarget.emit(e_t.INTERRUPTION_BEGIN)})).catch((function(){}))},e._onShow=function(){var t=this;this._state===i_t.INTERRUPTED&&this.play().then((function(){t._eventTarget.emit(e_t.INTERRUPTION_END)})).catch((function(){}))},e.seek=function(t){return t=Un(t,0,this.duration),this._domAudio.currentTime=t,Promise.resolve()},e.play=function(){var t=this;return new Promise((function(e){u_t(t._domAudio).then((function(){t._state=i_t.PLAYING,e()})).catch((function(){}))}))},e.pause=function(){return this._domAudio.pause(),this._state=i_t.PAUSED,Promise.resolve()},e.stop=function(){var t=this;return new Promise((function(e){t._domAudio.pause(),t._domAudio.currentTime=0,t._state=i_t.STOPPED,e()}))},e.onInterruptionBegin=function(t){this._eventTarget.on(e_t.INTERRUPTION_BEGIN,t)},e.offInterruptionBegin=function(t){this._eventTarget.off(e_t.INTERRUPTION_BEGIN,t)},e.onInterruptionEnd=function(t){this._eventTarget.on(e_t.INTERRUPTION_END,t)},e.offInterruptionEnd=function(t){this._eventTarget.off(e_t.INTERRUPTION_END,t)},e.onEnded=function(t){this._eventTarget.on(e_t.ENDED,t)},e.offEnded=function(t){this._eventTarget.off(e_t.ENDED,t)},N(t,[{key:"src",get:function(){return this._domAudio?this._domAudio.src:""}},{key:"type",get:function(){return n_t.DOM_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._domAudio.loop},set:function(t){this._domAudio.loop=t}},{key:"volume",get:function(){return this._domAudio.volume},set:function(t){t=kn(t),this._domAudio.volume=t}},{key:"duration",get:function(){return this._domAudio.duration}},{key:"currentTime",get:function(){return this._domAudio.currentTime}}]),t}()).prototype,"seek",[l_t],Object.getOwnPropertyDescriptor(a_t.prototype,"seek"),a_t.prototype),X(a_t.prototype,"play",[l_t],Object.getOwnPropertyDescriptor(a_t.prototype,"play"),a_t.prototype),X(a_t.prototype,"pause",[l_t],Object.getOwnPropertyDescriptor(a_t.prototype,"pause"),a_t.prototype),X(a_t.prototype,"stop",[l_t],Object.getOwnPropertyDescriptor(a_t.prototype,"stop"),a_t.prototype),a_t),d_t=function(){function t(t){this._nativeAudio=void 0,this._startTime=0,this._startOffset=0,this._isPaused=!0,this._nativeAudio=t}var e=t.prototype;return e.destroy=function(){this._nativeAudio=void 0},e._now=function(){return performance.now()/1e3},e._calculateCurrentTime=function(){var t=this._now()-this._startTime,e=this._startOffset+t;return e>=this.duration&&(this._startTime=this._now(),this._startOffset=0),e%this.duration},e.start=function(){this._isPaused=!1,this._startTime=this._now()},e.pause=function(){this._isPaused||(this._isPaused=!0,this._startOffset=this._calculateCurrentTime())},e.stop=function(){this._isPaused=!0,this._startOffset=0},e.seek=function(t){this._startTime=this._now(),this._startOffset=Un(t,0,this.duration)},N(t,[{key:"duration",get:function(){return this._nativeAudio.duration}},{key:"currentTime",get:function(){return this._isPaused?this._startOffset:this._calculateCurrentTime()}}]),t}(),m_t=new(function(){function t(){this._audioBufferDataMap={}}var e=t.prototype;return e.addCache=function(t,e){this._audioBufferDataMap[t]?console.warn("Audio buffer "+t+" has been cached"):this._audioBufferDataMap[t]={usedCount:1,audioBuffer:e}},e.retainCache=function(t){var e=this._audioBufferDataMap[t];e?e.usedCount++:console.warn("Audio buffer cache "+t+" has not been added.")},e.getCache=function(t){var e=this._audioBufferDataMap[t];return null==e?void 0:e.audioBuffer},e.tryReleasingCache=function(t){var e=this._audioBufferDataMap[t];e?--e.usedCount<=0&&delete this._audioBufferDataMap[t]:console.warn("Audio buffer cache "+t+" has not been added.")},t}()),v_t=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,g_t=function(){function t(){this._context=void 0,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}var e=t.prototype;return e.decodeAudioData=function(t){var e=this;return new Promise((function(n){var i=e._context.decodeAudioData(t,(function(t){n(t)}),(function(t){console.error("failed to load Web Audio",t)}));null==i||i.catch((function(){}))}))},e.runContext=function(){var t=this;return new Promise((function(e){var n=t._context;if(n.resume)if("running"!==n.state){var i=document.getElementById("GameCanvas"),r=function(){n.resume().then(e).catch((function(){}))};null==i||i.addEventListener("touchend",r,{once:!0,capture:!0}),null==i||i.addEventListener("mouseup",r,{once:!0,capture:!0})}else e();else e()}))},e.createBufferSource=function(t,e){var n=this._context.createBufferSource();return void 0!==t&&(n.buffer=t),void 0!==e&&(n.loop=e),n},e.createGain=function(t){void 0===t&&(t=1);var e=this._context.createGain();return this.setGainValue(e,t),e},e.setGainValue=function(t,e){if(t.gain.setTargetAtTime)try{t.gain.setTargetAtTime(e,this._context.currentTime,0)}catch(n){t.gain.setTargetAtTime(e,this._context.currentTime,.01)}else t.gain.value=e},e.connectContext=function(t){this._context&&t.connect(this._context.destination)},N(t,[{key:"currentTime",get:function(){return this._context.currentTime}}]),t}();g_t.support=!!v_t,g_t.support&&(__t=new g_t);var y_t,x_t,S_t,A_t,C_t,b_t=function(){function t(t,e,n){this._duration=void 0,this._bufferSourceNode=void 0,this._onPlayCb=void 0,this._currentTimer=0,this._url=void 0,this._onEndCb=void 0,this._duration=t.duration,this._url=n,this._bufferSourceNode=__t.createBufferSource(t,!1);var i=__t.createGain(e);this._bufferSourceNode.connect(i),__t.connectContext(i)}var e=t.prototype;return e.play=function(){var t=this;this._bufferSourceNode.start(),__t.runContext().then((function(){var e;null===(e=t.onPlay)||void 0===e||e.call(t),t._currentTimer=window.setTimeout((function(){var e;m_t.tryReleasingCache(t._url),null===(e=t.onEnd)||void 0===e||e.call(t)}),1e3*t._duration)})).catch((function(){}))},e.stop=function(){clearTimeout(this._currentTimer),m_t.tryReleasingCache(this._url),this._bufferSourceNode.stop(),this._bufferSourceNode.buffer=null},N(t,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(t){this._onPlayCb=t}},{key:"onEnd",get:function(){return this._onEndCb},set:function(t){this._onEndCb=t}}]),t}(),T_t=(X((h_t=function(){function t(t,e){this._src=void 0,this._audioBuffer=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._currentTimer=0,this._volume=1,this._loop=!1,this._state=i_t.INIT,this._audioTimer=void 0,this._eventTarget=new pn,this._operationQueue=[],this._audioBuffer=t,this._audioTimer=new d_t(t),this._gainNode=__t.createGain(),__t.connectContext(this._gainNode),this._src=e,dn.on("hide",this._onHide,this),dn.on("show",this._onShow,this)}var e=t.prototype;return e.destroy=function(){this._audioTimer.destroy(),this._audioBuffer&&(this._audioBuffer=null),m_t.tryReleasingCache(this._src),dn.off("hide",this._onHide,this),dn.off("show",this._onShow,this)},t.load=function(e){return new Promise((function(n){t.loadNative(e).then((function(i){n(new t(i,e))})).catch((function(){}))}))},t.loadNative=function(t){return new Promise((function(e,n){var i=m_t.getCache(t);if(i)return m_t.retainCache(t),void e(i);var r=new XMLHttpRequest,o="load audio failed: "+t+", status: ";r.open("GET",t,!0),r.responseType="arraybuffer",r.onload=function(){200===r.status||0===r.status?__t.decodeAudioData(r.response).then((function(n){m_t.addCache(t,n),e(n)})).catch((function(){})):n(new Error(""+o+r.status+"(no response)"))},r.onerror=function(){n(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){n(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){n(new Error(""+o+r.status+"(abort)"))},r.send(null)}))},t.loadOneShotAudio=function(e,n){return new Promise((function(i,r){t.loadNative(e).then((function(t){var r=new b_t(t,n,e);i(r)})).catch(r)}))},e._onHide=function(){var t=this;this._state===i_t.PLAYING&&this.pause().then((function(){t._state=i_t.INTERRUPTED,t._eventTarget.emit(e_t.INTERRUPTION_BEGIN)})).catch((function(){}))},e._onShow=function(){var t=this;this._state===i_t.INTERRUPTED&&this.play().then((function(){t._eventTarget.emit(e_t.INTERRUPTION_END)})).catch((function(){}))},e.seek=function(t){var e=this;return new Promise((function(n){e._audioTimer.seek(t),e._state===i_t.PLAYING?e._doPlay().then(n).catch((function(){})):n()}))},e.play=function(){return this._doPlay()},e._doPlay=function(){var t=this;return new Promise((function(e){t._stopSourceNode(),t._sourceNode=__t.createBufferSource(t._audioBuffer,t.loop),t._sourceNode.connect(t._gainNode),t._sourceNode.start(0,t._audioTimer.currentTime),__t.runContext().then((function(){t._state=i_t.PLAYING,t._audioTimer.start(),window.clearTimeout(t._currentTimer),t._currentTimer=window.setTimeout((function e(){t.loop?t._currentTimer=window.setTimeout(e,1e3*t._audioBuffer.duration):(t._audioTimer.stop(),t._eventTarget.emit(e_t.ENDED),t._state=i_t.INIT)}),1e3*(t._audioBuffer.duration-t._audioTimer.currentTime)),e()})).catch((function(){}))}))},e._stopSourceNode=function(){try{this._sourceNode&&(this._sourceNode.stop(),this._sourceNode.buffer=null)}catch(t){}},e.pause=function(){return this._state===i_t.PLAYING&&this._sourceNode?(this._audioTimer.pause(),this._state=i_t.PAUSED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},e.stop=function(){return this._sourceNode?(this._audioTimer.stop(),this._state=i_t.STOPPED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},e.onInterruptionBegin=function(t){this._eventTarget.on(e_t.INTERRUPTION_BEGIN,t)},e.offInterruptionBegin=function(t){this._eventTarget.off(e_t.INTERRUPTION_BEGIN,t)},e.onInterruptionEnd=function(t){this._eventTarget.on(e_t.INTERRUPTION_END,t)},e.offInterruptionEnd=function(t){this._eventTarget.off(e_t.INTERRUPTION_END,t)},e.onEnded=function(t){this._eventTarget.on(e_t.ENDED,t)},e.offEnded=function(t){this._eventTarget.off(e_t.ENDED,t)},N(t,[{key:"src",get:function(){return this._src}},{key:"type",get:function(){return n_t.WEB_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._loop},set:function(t){this._loop=t,this._sourceNode&&(this._sourceNode.loop=t)}},{key:"volume",get:function(){return this._volume},set:function(t){t=kn(t),this._volume=t,__t.setGainValue(this._gainNode,t)}},{key:"duration",get:function(){return this._audioBuffer.duration}},{key:"currentTime",get:function(){return this._audioTimer.currentTime}}]),t}()).prototype,"seek",[l_t],Object.getOwnPropertyDescriptor(h_t.prototype,"seek"),h_t.prototype),X(h_t.prototype,"play",[l_t],Object.getOwnPropertyDescriptor(h_t.prototype,"play"),h_t.prototype),X(h_t.prototype,"pause",[l_t],Object.getOwnPropertyDescriptor(h_t.prototype,"pause"),h_t.prototype),X(h_t.prototype,"stop",[l_t],Object.getOwnPropertyDescriptor(h_t.prototype,"stop"),h_t.prototype),h_t),E_t=function(){function t(t){this._audio=void 0,this._audio=t}var e=t.prototype;return e.play=function(){this._audio.play()},e.stop=function(){this._audio.stop()},N(t,[{key:"onPlay",get:function(){return this._audio.onPlay},set:function(t){this._audio.onPlay=t}},{key:"onEnd",get:function(){return this._audio.onEnd},set:function(t){this._audio.onEnd=t}}]),t}(),w_t=function(){function t(t){this._player=void 0,this._player=t}t.load=function(e,n){return new Promise((function(i){(null==n?void 0:n.audioLoadMode)!==n_t.DOM_AUDIO&&g_t.support?T_t.load(e).then((function(e){i(new t(e))})).catch((function(){})):(g_t.support||b(5201),p_t.load(e).then((function(e){i(new t(e))})).catch((function(){})))}))};var e=t.prototype;return e.destroy=function(){this._player.destroy()},t.loadNative=function(t,e){return(null==e?void 0:e.audioLoadMode)!==n_t.DOM_AUDIO&&g_t.support?T_t.loadNative(t):(g_t.support||b(5201),p_t.loadNative(t))},t.loadOneShotAudio=function(t,e,n){return new Promise((function(i,r){(null==n?void 0:n.audioLoadMode)!==n_t.DOM_AUDIO&&g_t.support?T_t.loadOneShotAudio(t,e).then((function(t){i(new E_t(t))})).catch(r):(g_t.support||b(5201),p_t.loadOneShotAudio(t,e).then((function(t){i(new E_t(t))})).catch(r))}))},e.seek=function(t){return this._player.seek(t)},e.play=function(){return this._player.play()},e.pause=function(){return this._player.pause()},e.stop=function(){return this._player.stop()},e.onInterruptionBegin=function(t){this._player.onInterruptionBegin(t)},e.offInterruptionBegin=function(t){this._player.offInterruptionBegin(t)},e.onInterruptionEnd=function(t){this._player.onInterruptionEnd(t)},e.offInterruptionEnd=function(t){this._player.offInterruptionEnd(t)},e.onEnded=function(t){this._player.onEnded(t)},e.offEnded=function(t){this._player.offEnded(t)},N(t,[{key:"src",get:function(){return this._player.src}},{key:"type",get:function(){return this._player.type}},{key:"state",get:function(){return this._player.state}},{key:"loop",get:function(){return this._player.loop},set:function(t){this._player.loop=t}},{key:"volume",get:function(){return this._player.volume},set:function(t){this._player.volume=t}},{key:"duration",get:function(){return this._player.duration}},{key:"currentTime",get:function(){return this._player.currentTime}}]),t}();w_t.maxAudioChannel=24;var P_t=t("AudioClip",qc("cc.AudioClip")((C_t=A_t=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_duration",S_t,H(e)),e._loadMode=n_t.UNKNOWN_AUDIO,e._meta=null,e._player=null,e}F(e,t);var n=e.prototype;return n.destroy=function(){var e,n=t.prototype.destroy.call(this);return null===(e=this._player)||void 0===e||e.destroy(),this._player=null,this._meta&&(this._meta.player=null),n},n.validate=function(){return!!this._meta},n.getDuration=function(){return this._duration?this._duration:this._meta?this._meta.duration:0},n.getCurrentTime=function(){return this._player?this._player.currentTime:0},n.getVolume=function(){return this._player?this._player.volume:0},n.getLoop=function(){return!!this._player&&this._player.loop},n.setCurrentTime=function(t){var e;null===(e=this._player)||void 0===e||e.seek(t).catch((function(){}))},n.setVolume=function(t){this._player&&(this._player.volume=t)},n.setLoop=function(t){this._player&&(this._player.loop=t)},n.play=function(){var t;null===(t=this._player)||void 0===t||t.play().catch((function(){}))},n.pause=function(){var t;null===(t=this._player)||void 0===t||t.pause().catch((function(){}))},n.stop=function(){var t;null===(t=this._player)||void 0===t||t.stop().catch((function(){}))},n.playOneShot=function(t){void 0===t&&(t=1),this._nativeAsset&&w_t.loadOneShotAudio(this._nativeAsset.url,t).then((function(t){t.play()})).catch((function(){}))},N(e,[{key:"_nativeAsset",get:function(){return this._meta},set:function(t){this._meta=t,t?(this._loadMode=t.type,this._player=t.player):(this._meta=null,this._loadMode=n_t.UNKNOWN_AUDIO,this._duration=0)}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.state:i_t.INIT}}]),e}(Su),A_t.AudioType=n_t,S_t=X((x_t=C_t).prototype,"_duration",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(x_t.prototype,"_nativeDep",[Ll],Object.getOwnPropertyDescriptor(x_t.prototype,"_nativeDep"),x_t.prototype),y_t=x_t))||y_t);function I_t(t,e,n){w_t.load(t,{audioLoadMode:e.audioLoadMode}).then((function(e){var i={player:e,url:t,duration:e.duration,type:e.type};n(null,i)})).catch((function(t){n(t)}))}function R_t(t,e,n,i){var r=new P_t;r._nativeUrl=t,r._nativeAsset=e,r._duration=e.duration,i(null,r)}i.AudioClip=P_t,dO.register({".mp3":I_t,".ogg":I_t,".wav":I_t,".m4a":I_t}),AO.register({".mp3":R_t,".ogg":R_t,".wav":R_t,".m4a":R_t});var D_t,B_t,M_t,O_t,N_t,L_t,F_t,z_t,V_t,G_t,U_t,k_t,H_t,j_t,W_t,q_t,X_t,Y_t,K_t,J_t=new(function(){function t(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}var e=t.prototype;return e._findIndex=function(t,e){return t.findIndex((function(t){return t.audio===e}))},e._tryAddPlaying=function(t,e){var n=this._findIndex(t,e);return n>-1?(t[n].playTime=performance.now(),!1):(t.push({audio:e,playTime:performance.now()}),!0)},e.addPlaying=function(t){if(t instanceof w_t){if(this._tryAddPlaying(this._audioPlayerInfoList,t))return}else this._tryAddPlaying(this._oneShotAudioInfoList,t)},e._tryRemovePlaying=function(t,e){var n=this._findIndex(t,e);return-1!==n&&(J(t,n),!0)},e.removePlaying=function(t){if(t instanceof w_t){if(this._tryRemovePlaying(this._audioPlayerInfoList,t))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,t)},e.discardOnePlayingIfNeeded=function(){var t;this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<w_t.maxAudioChannel||(this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((function(e){(!t||e.playTime<t.playTime)&&(t=e)})):this._audioPlayerInfoList.forEach((function(e){(!t||e.playTime<t.playTime)&&(t=e)})),t&&(t.audio.stop(),this.removePlaying(t.audio)))},t}());!function(t){t.STARTED="started",t.ENDED="ended"}(K_t||(K_t={}));var Q_t,Z_t,$_t=(D_t=qc("cc.AudioSource"),B_t=cl(),M_t=rl(),O_t=El(P_t),N_t=El(P_t),L_t=fl(),F_t=fl(),z_t=fl(),V_t=pl(),G_t=fl(),Q_t=D_t(U_t=B_t(U_t=M_t((Y_t=X_t=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_clip",H_t,H(e)),e._player=null,q(e,"_loop",j_t,H(e)),q(e,"_playOnAwake",W_t,H(e)),q(e,"_volume",q_t,H(e)),e._cachedCurrentTime=0,e._operationsBeforeLoading=[],e._isLoaded=!1,e._lastSetClip=null,e}F(e,t);var n=e.prototype;return n._syncPlayer=function(){var t=this,e=this._clip;this._isLoaded=!1,this._lastSetClip!==e&&(e?e._nativeAsset?(this._lastSetClip=e,w_t.load(e._nativeAsset.url,{audioLoadMode:e.loadMode}).then((function(n){t._lastSetClip===e?(t._isLoaded=!0,t._player&&(t._player.offEnded(),t._player.offInterruptionBegin(),t._player.offInterruptionEnd(),t._player.destroy()),t._player=n,n.onEnded((function(){J_t.removePlaying(n),t.node.emit(K_t.ENDED,t)})),n.onInterruptionBegin((function(){J_t.removePlaying(n)})),n.onInterruptionEnd((function(){J_t.addPlaying(n)})),t._syncStates()):n.destroy()})).catch((function(){}))):console.error("Invalid audio clip"):this._lastSetClip=null)},n.onLoad=function(){this._syncPlayer()},n.onEnable=function(){this._playOnAwake&&!this.playing&&this.play()},n.onDisable=function(){var t=this._getRootNode();(null==t?void 0:t._persistNode)||this.pause()},n.onDestroy=function(){var t;this.stop(),null===(t=this._player)||void 0===t||t.destroy(),this._player=null},n._getRootNode=function(){for(var t,e,n=this.node,i=null===(t=n)||void 0===t||null===(e=t.parent)||void 0===e?void 0:e.parent;i;){var r,o,a;i=null===(o=n=null===(r=n)||void 0===r?void 0:r.parent)||void 0===o||null===(a=o.parent)||void 0===a?void 0:a.parent}return n},n.play=function(){var t,e,n=this;this._isLoaded?(J_t.discardOnePlayingIfNeeded(),this.state===i_t.PLAYING&&(null===(e=this._player)||void 0===e||e.stop().catch((function(){}))),null===(t=this._player)||void 0===t||t.play().then((function(){J_t.addPlaying(n._player),n.node.emit(K_t.STARTED,n)})).catch((function(){}))):this._operationsBeforeLoading.push("play")},n.pause=function(){var t,e=this;this._isLoaded?null===(t=this._player)||void 0===t||t.pause().then((function(){J_t.removePlaying(e._player)})).catch((function(){})):this._operationsBeforeLoading.push("pause")},n.stop=function(){var t,e=this;this._isLoaded?null===(t=this._player)||void 0===t||t.stop().then((function(){J_t.removePlaying(e._player)})).catch((function(){})):this._operationsBeforeLoading.push("stop")},n.playOneShot=function(t,e){void 0===e&&(e=1),t._nativeAsset?w_t.loadOneShotAudio(t._nativeAsset.url,this._volume*e,{audioLoadMode:t.loadMode}).then((function(t){J_t.discardOnePlayingIfNeeded(),t.onPlay=function(){J_t.addPlaying(t)},t.onEnd=function(){J_t.removePlaying(t)},t.play()})).catch((function(){})):console.error("Invalid audio clip")},n._syncStates=function(){var t=this;this._player&&this._player.seek(this._cachedCurrentTime).then((function(){t._player&&(t._player.loop=t._loop,t._player.volume=t._volume,t._operationsBeforeLoading.forEach((function(e){var n;null===(n=t[e])||void 0===n||n.call(t)})),t._operationsBeforeLoading.length=0)})).catch((function(){}))},N(e,[{key:"clip",get:function(){return this._clip},set:function(t){t!==this._clip&&(this._clip=t,this._syncPlayer())}},{key:"loop",get:function(){return this._loop},set:function(t){this._loop=t,this._player&&(this._player.loop=t)}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(t){this._playOnAwake=t}},{key:"volume",get:function(){return this._volume},set:function(t){Number.isNaN(t)?console.warn("illegal audio volume!"):(t=Un(t,0,1),this._player?(this._player.volume=t,this._volume=this._player.volume):this._volume=t)}},{key:"currentTime",get:function(){return this._player?this._player.currentTime:this._cachedCurrentTime},set:function(t){var e;Number.isNaN(t)?console.warn("illegal audio time!"):(t=Un(t,0,this.duration),this._cachedCurrentTime=t,null===(e=this._player)||void 0===e||e.seek(this._cachedCurrentTime).catch((function(){})))}},{key:"duration",get:function(){var t,e;return null!==(t=null===(e=this._clip)||void 0===e?void 0:e.getDuration())&&void 0!==t?t:this._player?this._player.currentTime:0}},{key:"state",get:function(){return this._player?this._player.state:i_t.INIT}},{key:"playing",get:function(){return this.state===e.AudioState.PLAYING}}],[{key:"maxAudioChannel",get:function(){return w_t.maxAudioChannel}}]),e}(ku),X_t.AudioState=i_t,X_t.EventType=K_t,H_t=X((k_t=Y_t).prototype,"_clip",[O_t],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),j_t=X(k_t.prototype,"_loop",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),W_t=X(k_t.prototype,"_playOnAwake",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),q_t=X(k_t.prototype,"_volume",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),X(k_t.prototype,"clip",[N_t,L_t],Object.getOwnPropertyDescriptor(k_t.prototype,"clip"),k_t.prototype),X(k_t.prototype,"loop",[F_t],Object.getOwnPropertyDescriptor(k_t.prototype,"loop"),k_t.prototype),X(k_t.prototype,"playOnAwake",[z_t],Object.getOwnPropertyDescriptor(k_t.prototype,"playOnAwake"),k_t.prototype),X(k_t.prototype,"volume",[V_t,G_t],Object.getOwnPropertyDescriptor(k_t.prototype,"volume"),k_t.prototype),U_t=k_t))||U_t)||U_t)||U_t,t({AudioSource:Q_t,AudioSourceComponent:Q_t}),Q_t);i.AudioSourceComponent=$_t,kt.setClassAlias($_t,"cc.AudioSourceComponent"),function(t){t.NONE="none",t.LOADING="loading",t.LOADED="loaded",t.ERROR="error"}(Z_t||(Z_t={}));var tft=function(){function t(t){this._componentEventList=new Map,this._state=Z_t.NONE,this._wrapper=void 0,this._webview=null,this._loaded=!1,this._forceUpdate=!1,this._component=null,this._uiTrans=null,this._node=null,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._component=t,this._node=t.node,this._uiTrans=t.node.getComponent($Y),this.reset(),this.createWebView()}var e=t.prototype;return e.reset=function(){this._wrapper=null,this._webview=null,this._loaded=!1,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._state=Z_t.NONE,this._forceUpdate=!1},e.dispatchEvent=function(t){var e=this._componentEventList.get(t);if(e){this._state=t;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];e.call(this,i)}},e.destroy=function(){this.removeWebView(),this._wrapper=null,this._webview=null,this._loaded=!1,this._component=null,this._uiTrans=null,this._forceUpdate=!1,this._componentEventList.clear()},N(t,[{key:"loaded",get:function(){return this._loaded}},{key:"componentEventList",get:function(){return this._componentEventList}},{key:"webview",get:function(){return this._webview}},{key:"state",get:function(){return this._state}},{key:"UICamera",get:function(){return LM.root.batcher2D.getFirstRenderCamera(this._node)}}]),t}();i.internal.WebViewImpl=tft;var eft,nft,ift,rft,oft,aft,sft,cft,lft,uft,hft,_ft,fft,pft,dft=Ii(),mft=function(t){function e(e){return t.call(this,e)||this}F(e,t);var n=e.prototype;return n._bindDomEvent=function(){var t=this;this.webview&&this.webview.addEventListener("load",(function(e){t._forceUpdate=!0,t.dispatchEvent(Z_t.LOADED);var n=e.target,i=n.contentDocument&&n.contentDocument.body;i&&i.innerHTML.includes("404")&&t.dispatchEvent(Z_t.ERROR,i.innerHTML)}))},n.loadURL=function(t){this.webview&&(this.webview.src=t,this.dispatchEvent(Z_t.LOADING))},n.createWebView=function(){var t=document.createElement("div");this._wrapper=t,t.id="webview-wrapper",t.style["-webkit-overflow"]="auto",t.style["-webkit-overflow-scrolling"]="touch",t.style.position="absolute",t.style.bottom="0px",t.style.left="0px",t.style.transformOrigin="0px 100% 0px",t.style["-webkit-transform-origin"]="0px 100% 0px",mM.container.appendChild(t);var e=document.createElement("iframe");this._webview=e,e.id="webview",e.style.border="none",e.style.width="100%",e.style.height="100%",t.appendChild(e),this._bindDomEvent()},n.removeWebView=function(){var t=this._wrapper;le(mM.container,t)&&mM.container.removeChild(t),this.reset()},n.enable=function(){this._wrapper&&(this._wrapper.style.visibility="visible")},n.disable=function(){this._wrapper&&(this._wrapper.style.visibility="hidden")},n.evaluateJS=function(t){if(this.webview){var e=this.webview.contentWindow;if(e)try{e.eval(t)}catch(t){this.dispatchEvent(Z_t.ERROR,t),d(t)}}},n.setOnJSCallback=function(){p("The platform does not support")},n.setJavascriptInterfaceScheme=function(){p("The platform does not support")},n.syncMatrix=function(){if(this._wrapper&&this._uiTrans&&this._component&&"hidden"!==this._wrapper.style.visibility){var t=this.UICamera;if(t){this._component.node.getWorldMatrix(dft),t.update(!0),t.worldMatrixToScreen(dft,dft,mM.canvas.width,mM.canvas.height);var e=this._uiTrans.contentSize,n=e.width,i=e.height;if(this._forceUpdate||this._m00!==dft.m00||this._m01!==dft.m01||this._m04!==dft.m04||this._m05!==dft.m05||this._m12!==dft.m12||this._m13!==dft.m13||this._w!==n||this._h!==i){this._m00=dft.m00,this._m01=dft.m01,this._m04=dft.m04,this._m05=dft.m05,this._m12=dft.m12,this._m13=dft.m13,this._w=n,this._h=i;var r=Ku.devicePixelRatio,o=1/r,a=1/r,s=mM.container,c=dft.m00*o,l=dft.m01,u=dft.m04,h=dft.m05*a;this._wrapper.style.width=n+"px",this._wrapper.style.height=i+"px";var _=this._w*o,f=this._h*a,p=_*dft.m00*this._uiTrans.anchorX,d=f*dft.m05*this._uiTrans.anchorY,m=s&&s.style.paddingLeft?parseInt(s.style.paddingLeft):0,v=s&&s.style.paddingBottom?parseInt(s.style.paddingBottom):0,g="matrix("+c+","+-l+","+-u+","+h+","+(dft.m12*o-p+m)+","+-(dft.m13*a-d+v)+")";this._wrapper.style.transform=g,this._wrapper.style["-webkit-transform"]=g,this._forceUpdate=!1}}}},e}(tft),vft=function(){function t(){}return t.getImpl=function(t){return new mft(t)},t}();i.internal.WebViewImplManager=vft;var gft=t("WebView",(eft=qc("cc.WebView"),nft=cl(),ift=rl(),rft=Xc($Y),oft=fl(),aft=El([hL]),sft=yl(),cft=fl(),eft(lft=nft(lft=ift(lft=rft(lft=il((pft=fft=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(e=t.call.apply(t,[this].concat(i))||this,"_url",hft,H(e)),e._impl=null,q(e,"webviewEvents",_ft,H(e)),e}F(e,t);var n=e.prototype;return n.setJavascriptInterfaceScheme=function(t){this._impl&&this._impl.setJavascriptInterfaceScheme(t)},n.setOnJSCallback=function(t){this._impl&&this._impl.setOnJSCallback(t)},n.evaluateJS=function(t){this._impl&&this._impl.evaluateJS(t)},n.__preload=function(){this._impl=vft.getImpl(this),this._impl.componentEventList.set(Z_t.LOADING,this.onLoading.bind(this)),this._impl.componentEventList.set(Z_t.LOADED,this.onLoaded.bind(this)),this._impl.componentEventList.set(Z_t.ERROR,this.onError.bind(this)),this._impl.loadURL(this._url)},n.onLoading=function(){hL.emitEvents(this.webviewEvents,this,Z_t.LOADING),this.node.emit(Z_t.LOADING,this)},n.onLoaded=function(){hL.emitEvents(this.webviewEvents,this,Z_t.LOADED),this.node.emit(Z_t.LOADED,this)},n.onError=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];hL.emitEvents(this.webviewEvents,this,Z_t.ERROR,e),this.node.emit(Z_t.ERROR,this,e)},n.onEnable=function(){this._impl&&this._impl.enable()},n.onDisable=function(){this._impl&&this._impl.disable()},n.onDestroy=function(){this._impl&&(this._impl.destroy(),this._impl=null)},n.update=function(){this._impl&&this._impl.syncMatrix()},N(e,[{key:"url",get:function(){return this._url},set:function(t){this._url=t,this._impl&&this._impl.loadURL(t)}},{key:"nativeWebView",get:function(){return this._impl&&this._impl.webview||null}},{key:"state",get:function(){return this._impl?this._impl.state:Z_t.NONE}}]),e}(ku),fft.EventType=Z_t,hft=X((uft=pft).prototype,"_url",[Zc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"https://cocos.com"}}),X(uft.prototype,"url",[oft],Object.getOwnPropertyDescriptor(uft.prototype,"url"),uft.prototype),_ft=X(uft.prototype,"webviewEvents",[Zc,aft,sft,cft],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lft=uft))||lft)||lft)||lft)||lft)||lft));i.internal.WebView=gft;var yft=function(){function t(){this.originalTarget=null,this.target=null,this.tag=t.TAG_INVALID}var e=t.prototype;return e.clone=function(){var e=new t;return e.originalTarget=null,e.target=null,e.tag=this.tag,e},e.isDone=function(){return!0},e.startWithTarget=function(t){this.originalTarget=t,this.target=t},e.stop=function(){this.target=null},e.step=function(){A(1006)},e.update=function(){A(1007)},e.getTarget=function(){return this.target},e.setTarget=function(t){this.target=t},e.getOriginalTarget=function(){return this.originalTarget},e.setOriginalTarget=function(t){this.originalTarget=t},e.getTag=function(){return this.tag},e.setTag=function(t){this.tag=t},e.reverse=function(){return A(1008),null},e.retain=function(){},e.release=function(){},t}();yft.TAG_INVALID=-1;var xft=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._duration=0,e._timesForRepeat=1,e}F(e,t);var n=e.prototype;return n.getDuration=function(){return this._duration*(this._timesForRepeat||1)},n.setDuration=function(t){this._duration=t},n.clone=function(){return new e},e}(yft),Sft=(function(t){function e(e,n){var i;return void 0===n&&(n=1),(i=t.call(this)||this)._speed=0,i._innerAction=null,e&&i.initWithAction(e,n),i}F(e,t);var n=e.prototype;n.getSpeed=function(){return this._speed},n.setSpeed=function(t){this._speed=t},n.initWithAction=function(t,e){return t?(this._innerAction=t,this._speed=e,!0):(E(1021),!1)},n.clone=function(){var t=new e;return t.initWithAction(this._innerAction.clone(),this._speed),t},n.startWithTarget=function(t){yft.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)},n.stop=function(){this._innerAction.stop(),yft.prototype.stop.call(this)},n.step=function(t){this._innerAction.step(t*this._speed)},n.isDone=function(){return this._innerAction.isDone()},n.reverse=function(){return new e(this._innerAction.reverse(),this._speed)},n.setInnerAction=function(t){this._innerAction!==t&&(this._innerAction=t)},n.getInnerAction=function(){return this._innerAction}}(yft),0),Aft=function(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1},Cft=function(){function t(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}var e=t.prototype;return e._searchElementByTarget=function(t,e){for(var n=0;n<t.length;n++)if(e===t[n].target)return t[n];return null},e._getElement=function(t,e){var n=this._elementPool.pop();return n||(n=new Aft),n.target=t,n.paused=!!e,n},e._putElement=function(t){t.actions.length=0,t.actionIndex=0,t.currentAction=null,t.paused=!1,t.target=null,t.lock=!1,this._elementPool.push(t)},e.addAction=function(t,e,n){if(t&&e){null==e.uuid&&(e.uuid="_TWEEN_UUID_"+Sft++);var i=this._hashTargets.get(e);i?i.actions||(i.actions=[]):(i=this._getElement(e,n),this._hashTargets.set(e,i),this._arrayTargets.push(i)),i.target=e,i.actions.push(t),t.startWithTarget(e)}else E(1e3)},e.removeAllActions=function(){for(var t=this._arrayTargets,e=0;e<t.length;e++){var n=t[e];n&&this._putElement(n)}this._arrayTargets.length=0,this._hashTargets=new Map},e.removeAllActionsFromTarget=function(t){if(null!=t){var e=this._hashTargets.get(t);e&&(e.actions.length=0,this._deleteHashElement(e))}},e.removeAction=function(t){if(null!=t){var e=t.getOriginalTarget(),n=this._hashTargets.get(e);if(n)for(var i=0;i<n.actions.length;i++)if(n.actions[i]===t){n.actions.splice(i,1),n.actionIndex>=i&&n.actionIndex--;break}}},e._removeActionByTag=function(t,e,n){for(var i=0,r=e.actions.length;i<r;++i){var o=e.actions[i];if(o&&o.getTag()===t){if(n&&o.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,e);break}}},e._removeAllActionsByTag=function(t,e,n){for(var i=e.actions.length-1;i>=0;--i){var r=e.actions[i];if(r&&r.getTag()===t){if(n&&r.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,e)}}},e.removeActionByTag=function(t,e){var n=this;t===yft.TAG_INVALID&&A(1002);var i=this._hashTargets;if(e){var r=i.get(e);r&&this._removeActionByTag(t,r,e)}else i.forEach((function(e){n._removeActionByTag(t,e)}))},e.removeAllActionsByTag=function(t,e){var n=this;t===yft.TAG_INVALID&&A(1002);var i=this._hashTargets;if(e){var r=i.get(e);r&&this._removeAllActionsByTag(t,r,e)}else i.forEach((function(e){n._removeAllActionsByTag(t,e)}))},e.getActionByTag=function(t,e){t===yft.TAG_INVALID&&A(1004);var n=this._hashTargets.get(e);if(n){if(null!=n.actions)for(var i=0;i<n.actions.length;++i){var r=n.actions[i];if(r&&r.getTag()===t)return r}A(1005,t)}return null},e.getNumberOfRunningActionsInTarget=function(t){var e=this._hashTargets.get(t);return e&&e.actions?e.actions.length:0},e.pauseTarget=function(t){var e=this._hashTargets.get(t);e&&(e.paused=!0)},e.resumeTarget=function(t){var e=this._hashTargets.get(t);e&&(e.paused=!1)},e.pauseAllRunningActions=function(){for(var t=[],e=this._arrayTargets,n=0;n<e.length;n++){var i=e[n];i&&!i.paused&&(i.paused=!0,t.push(i.target))}return t},e.resumeTargets=function(t){if(t)for(var e=0;e<t.length;e++)t[e]&&this.resumeTarget(t[e])},e.pauseTargets=function(t){if(t)for(var e=0;e<t.length;e++)t[e]&&this.pauseTarget(t[e])},e.purgeSharedManager=function(){i.director.getScheduler().unscheduleUpdate(this)},e._removeActionAtIndex=function(t,e){e.actions[t],e.actions.splice(t,1),e.actionIndex>=t&&e.actionIndex--,0===e.actions.length&&this._deleteHashElement(e)},e._deleteHashElement=function(t){var e=!1;if(t&&!t.lock&&this._hashTargets.get(t.target)){this._hashTargets.delete(t.target);for(var n=this._arrayTargets,i=0,r=n.length;i<r;i++)if(n[i]===t){n.splice(i,1);break}this._putElement(t),e=!0}return e},e.update=function(t){for(var e,n=this._arrayTargets,i=0;i<n.length;i++){this._currentTarget=n[i];var r=(e=this._currentTarget).target;if(r instanceof Je&&!r.isValid)this.removeAllActionsFromTarget(r),i--;else{if(!e.paused&&e.actions){for(e.lock=!0,e.actionIndex=0;e.actionIndex<e.actions.length;e.actionIndex++)if(e.currentAction=e.actions[e.actionIndex],e.currentAction){if(e.currentAction.step(t*(e.currentAction._speedMethod?e.currentAction._speed:1)),e.currentAction&&e.currentAction.isDone()){e.currentAction.stop();var o=e.currentAction;e.currentAction=null,this.removeAction(o)}e.currentAction=null}e.lock=!1}0===e.actions.length&&this._deleteHashElement(e)&&i--}}},t}(),bft=t("TweenSystem",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).actionMgr=new Cft,e}return F(e,t),e.prototype.update=function(t){this.actionMgr.update(t)},N(e,[{key:"ActionManager",get:function(){return this.actionMgr}}]),e}(bM));bft.ID="TWEEN",bft.instance=void 0,LM.on(NM.EVENT_INIT,(function(){var t=new bft;bft.instance=t,LM.registerSystem(bft.ID,t,bM.Priority.MEDIUM)}));var Tft=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.isDone=function(){return!0},n.step=function(){this.update(1)},n.update=function(){},n.reverse=function(){return this.clone()},n.clone=function(){return new e},e}(xft),Eft=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.update=function(){for(var t=this.target.getComponentsInChildren(VL),e=0;e<t.length;++e)t[e].enabled=!0},n.reverse=function(){return new wft},n.clone=function(){return new e},e}(Tft),wft=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.update=function(){for(var t=this.target.getComponentsInChildren(VL),e=0;e<t.length;++e)t[e].enabled=!1},n.reverse=function(){return new Eft},n.clone=function(){return new e},e}(Tft);!function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;n.update=function(){for(var t=this.target.getComponentsInChildren(VL),e=0;e<t.length;++e){var n=t[e];n.enabled=!n.enabled}},n.reverse=function(){return new e},n.clone=function(){return new e}}(Tft);var Pft=function(t){function e(e){var n;return(n=t.call(this)||this)._isNeedCleanUp=!0,void 0!==e&&n.init(e),n}F(e,t);var n=e.prototype;return n.update=function(){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()},n.init=function(t){return this._isNeedCleanUp=t,!0},n.reverse=function(){return new e(this._isNeedCleanUp)},n.clone=function(){return new e(this._isNeedCleanUp)},e}(Tft),Ift=function(t){function e(e,n,i){var r;return(r=t.call(this)||this)._selectorTarget=null,r._function=null,r._data=null,r.initWithFunction(e,n,i),r}F(e,t);var n=e.prototype;return n.initWithFunction=function(t,e,n){return t&&(this._function=t),e&&(this._selectorTarget=e),void 0!==n&&(this._data=n),!0},n.execute=function(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)},n.update=function(){this.execute()},n.getTargetCallback=function(){return this._selectorTarget},n.setTargetCallback=function(t){t!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=t)},n.clone=function(){var t=new e;return t.initWithFunction(this._function,this._selectorTarget,this._data),t},e}(Tft),Rft=function(t){function e(e){var n;return(n=t.call(this)||this).MAX_VALUE=2,n._elapsed=0,n._firstTick=!1,n._easeList=[],n._speed=1,n._repeatForever=!1,n._repeatMethod=!1,n._speedMethod=!1,void 0===e||isNaN(e)||n.initWithDuration(e),n}F(e,t);var n=e.prototype;return n.getElapsed=function(){return this._elapsed},n.initWithDuration=function(t){return this._duration=0===t?ee.FLT_EPSILON:t,this._elapsed=0,this._firstTick=!0,!0},n.isDone=function(){return this._elapsed>=this._duration},n._cloneDecoration=function(t){t._repeatForever=this._repeatForever,t._speed=this._speed,t._timesForRepeat=this._timesForRepeat,t._easeList=this._easeList,t._speedMethod=this._speedMethod,t._repeatMethod=this._repeatMethod},n._reverseEaseList=function(t){if(this._easeList){t._easeList=[];for(var e=0;e<this._easeList.length;e++)t._easeList.push(this._easeList[e])}},n.clone=function(){var t=new e(this._duration);return this._cloneDecoration(t),t},n.easing=function(t){this._easeList?this._easeList.length=0:this._easeList=[];for(var e=0;e<arguments.length;e++)this._easeList.push(arguments[e]);return this},n._computeEaseTime=function(t){return t},n.step=function(t){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=t;var e=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);e=e<1?e:1,this.update(e>0?e:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))},n.startWithTarget=function(t){yft.prototype.startWithTarget.call(this,t),this._elapsed=0,this._firstTick=!0},n.reverse=function(){return A(1010),this},n.setAmplitudeRate=function(){A(1011)},n.getAmplitudeRate=function(){return A(1012),0},n.speed=function(t){return t<=0?(A(1013),this):(this._speedMethod=!0,this._speed*=t,this)},n.getSpeed=function(){return this._speed},n.setSpeed=function(t){return this._speed=t,this},n.repeat=function(t){return t=Math.round(t),isNaN(t)||t<1?(A(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=t,this)},n.repeatForever=function(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this},e}(xft),Dft=function(t){function e(n){var i;(i=t.call(this)||this)._actions=[],i._split=0,i._last=0,i._reversed=!1;var r=n instanceof Array?n:arguments;if(1===r.length)return E(1019),H(i);var o=r.length-1;if(o>=0&&null==r[o]&&A(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=e._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}F(e,t);var n=e.prototype;return n.initWithTwoActions=function(t,e){if(!t||!e)return E(1025),!1;var n=t._duration,i=e._duration,r=(n*=t._repeatMethod?t._timesForRepeat:1)+(i*=e._repeatMethod?e._timesForRepeat:1);return this.initWithDuration(r),this._actions[0]=t,this._actions[1]=e,!0},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),t},n.startWithTarget=function(t){Rft.prototype.startWithTarget.call(this,t),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1},n.stop=function(){-1!==this._last&&this._actions[this._last].stop(),yft.prototype.stop.call(this)},n.update=function(t){var e,n,i=0,r=this._split,o=this._actions,a=this._last;(t=this._computeEaseTime(t))<r?(e=0!==r?t/r:1,0===i&&1===a&&this._reversed&&(o[1].update(0),o[1].stop())):(i=1,e=1===r?1:(t-r)/(1-r),-1===a&&(o[0].startWithTarget(this.target),o[0].update(1),o[0].stop()),0===a&&(o[0].update(1),o[0].stop())),n=o[i],a===i&&n.isDone()||(a!==i&&n.startWithTarget(this.target),e*=n._timesForRepeat,n.update(e>1?e%1:e),this._last=i)},n.reverse=function(){var t=e._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t._reversed=!0,t},e}(Rft);function Bft(t){var e=t instanceof Array?t:arguments;if(1===e.length)return E(1019),null;var n=e.length-1;n>=0&&null==e[n]&&A(1015);var i=null;if(n>=0){i=e[0];for(var r=1;r<=n;r++)e[r]&&(i=Dft._actionOneTwo(i,e[r]))}return i}Dft._actionOneTwo=function(t,e){var n=new Dft;return n.initWithTwoActions(t,e),n};var Mft=function(t){function e(e,n){var i;return(i=t.call(this)||this)._times=0,i._total=0,i._nextDt=0,i._actionInstant=!1,i._innerAction=null,void 0!==n&&i.initWithAction(e,n),i}F(e,t);var n=e.prototype;return n.initWithAction=function(t,e){var n=t._duration*e;return!!this.initWithDuration(n)&&(this._times=e,this._innerAction=t,t instanceof Tft&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithAction(this._innerAction.clone(),this._times),t},n.startWithTarget=function(t){this._total=0,this._nextDt=this._innerAction._duration/this._duration,Rft.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)},n.stop=function(){this._innerAction.stop(),yft.prototype.stop.call(this)},n.update=function(t){t=this._computeEaseTime(t);var e=this._innerAction,n=this._duration,i=this._times,r=this._nextDt;if(t>=r){for(;t>r&&this._total<i;)e.update(1),this._total++,e.stop(),e.startWithTarget(this.target),r+=e._duration/n,this._nextDt=r>1?1:r;t>=1&&this._total<i&&(e.update(1),this._total++),this._actionInstant||(this._total===i?e.stop():e.update(t-(r-e._duration/n)))}else e.update(t*i%1)},n.isDone=function(){return this._total===this._times},n.reverse=function(){var t=new e(this._innerAction.reverse(),this._times);return this._cloneDecoration(t),this._reverseEaseList(t),t},n.setInnerAction=function(t){this._innerAction!==t&&(this._innerAction=t)},n.getInnerAction=function(){return this._innerAction},e}(Rft),Oft=function(t){function e(e){var n;return(n=t.call(this)||this)._innerAction=null,e&&n.initWithAction(e),n}F(e,t);var n=e.prototype;return n.initWithAction=function(t){return t?(this._innerAction=t,!0):(E(1026),!1)},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithAction(this._innerAction.clone()),t},n.startWithTarget=function(t){Rft.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)},n.step=function(t){var e=this._innerAction;e.step(t),e.isDone()&&(e.startWithTarget(this.target),e.step(e.getElapsed()-e._duration))},n.isDone=function(){return!1},n.reverse=function(){var t=new e(this._innerAction.reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t},n.setInnerAction=function(t){this._innerAction!==t&&(this._innerAction=t)},n.getInnerAction=function(){return this._innerAction},e}(Rft),Nft=function(t){function e(n){var i;(i=t.call(this)||this)._one=null,i._two=null;var r=n instanceof Array?n:arguments;if(1===r.length)return E(1020),H(i);var o=r.length-1;if(o>=0&&null==r[o]&&A(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=e._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}F(e,t);var n=e.prototype;return n.initWithTwoActions=function(t,e){if(!t||!e)return E(1027),!1;var n=!1,i=t._duration,r=e._duration;return this.initWithDuration(Math.max(i,r))&&(this._one=t,this._two=e,i>r?this._two=Dft._actionOneTwo(e,zft(i-r)):i<r&&(this._one=Dft._actionOneTwo(t,zft(r-i))),n=!0),n},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithTwoActions(this._one.clone(),this._two.clone()),t},n.startWithTarget=function(t){Rft.prototype.startWithTarget.call(this,t),this._one.startWithTarget(t),this._two.startWithTarget(t)},n.stop=function(){this._one.stop(),this._two.stop(),yft.prototype.stop.call(this)},n.update=function(t){t=this._computeEaseTime(t),this._one&&this._one.update(t),this._two&&this._two.update(t)},n.reverse=function(){var t=e._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t},e}(Rft);function Lft(t){var e=t instanceof Array?t:arguments;if(1===e.length)return E(1020),null;e.length>0&&null==e[e.length-1]&&A(1015);for(var n=e[0],i=1;i<e.length;i++)null!=e[i]&&(n=Nft._actionOneTwo(n,e[i]));return n}Nft._actionOneTwo=function(t,e){var n=new Nft;return n.initWithTwoActions(t,e),n};var Fft=function(t){function e(){return t.apply(this,arguments)||this}F(e,t);var n=e.prototype;return n.update=function(){},n.reverse=function(){var t=new e(this._duration);return this._cloneDecoration(t),this._reverseEaseList(t),t},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithDuration(this._duration),t},e}(Rft);function zft(t){return new Fft(t)}var Vft=function(t){function e(e){var n;return(n=t.call(this)||this)._other=null,e&&n.initWithAction(e),n}F(e,t);var n=e.prototype;return n.initWithAction=function(t){return t?t===this._other?(E(1029),!1):!!Rft.prototype.initWithDuration.call(this,t._duration)&&(this._other=t,!0):(E(1028),!1)},n.clone=function(){var t=new e;return this._cloneDecoration(t),t.initWithAction(this._other.clone()),t},n.startWithTarget=function(t){Rft.prototype.startWithTarget.call(this,t),this._other.startWithTarget(t)},n.update=function(t){t=this._computeEaseTime(t),this._other&&this._other.update(1-t)},n.reverse=function(){return this._other.clone()},n.stop=function(){this._other.stop(),yft.prototype.stop.call(this)},e}(Rft),Gft=t("TweenAction",function(t){function e(e,n,i){var o;if((o=t.call(this)||this)._opts=void 0,o._props=void 0,o._originProps=void 0,null==i)i=Object.create(null);else if(function(t){var e=" [Tween:] ",n=" option is not support in v + "+r,i=t;i.delay&&p(e+"delay"+n),i.repeat&&p(e+"repeat"+n),i.repeatDelay&&p(e+"repeatDelay"+n),i.interpolation&&p(e+"interpolation"+n),i.onStop&&p(e+"onStop"+n)}(i),i.easing&&"string"==typeof i.easing&&(i.easing=function(t){var e=t.charAt(0);if(/[A-Z]/.test(e)){var n=(t=t.replace(e,e.toLowerCase())).split("-");if(2===n.length){var i=n[0];if("linear"===i)t="linear";else{var r=n[1];switch(i){case"quadratic":t="quad"+r;break;case"quartic":t="quart"+r;break;case"quintic":t="quint"+r;break;case"sinusoidal":t="sine"+r;break;case"exponential":t="expo"+r;break;case"circular":t="circ"+r;break;default:t=i+r}}}}return t}(i.easing)),i.progress||(i.progress=o.progress),i.easing&&"string"==typeof i.easing){var a=i.easing;i.easing=H_[a],i.easing||b(1031,a)}for(var s in o._opts=i,o._props=Object.create(null),n)if(n.hasOwnProperty(s)){var c=n[s];if("function"==typeof c&&(c=c()),null!=c&&"string"!=typeof c){var l=void 0,u=void 0;void 0!==c.value&&(c.easing||c.progress)&&("string"==typeof c.easing?(l=H_[c.easing])||b(1031,c.easing):l=c.easing,u=c.progress,c=c.value);var h=Object.create(null);h.value=c,h.easing=l,h.progress=u,o._props[s]=h}}return o._originProps=n,o.initWithDuration(e),o}F(e,t);var n=e.prototype;return n.clone=function(){var t=new e(this._duration,this._originProps,this._opts);return this._cloneDecoration(t),t},n.startWithTarget=function(t){Rft.prototype.startWithTarget.call(this,t);var e=!!this._opts.relative,n=this._props;for(var i in n){var r=t[i];if(void 0!==r){var o=n[i],a=o.value;if("number"==typeof r)o.start=r,o.current=r,o.end=e?r+a:a;else if("object"==typeof r)for(var s in null==o.start&&(o.start={},o.current={},o.end={}),a)isNaN(r[s])||(o.start[s]=r[s],o.current[s]=r[s],o.end[s]=e?r[s]+a[s]:a[s])}}this._opts.onStart&&this._opts.onStart(this.target)},n.update=function(t){var e=this.target;if(e){var n=this._props,i=this._opts,r=t;i.easing&&(r=i.easing(t));var o=i.progress;for(var a in n){var s=n[a],c=s.easing?s.easing(t):r,l=s.progress?s.progress:o,u=s.start,h=s.end;if("number"==typeof u)s.current=l(u,h,s.current,c);else if("object"==typeof u)for(var _ in u)s.current[_]=l(u[_],h[_],s.current[_],c);e[a]=s.current}i.onUpdate&&i.onUpdate(this.target,t),1===t&&i.onComplete&&i.onComplete(this.target)}},n.progress=function(t,e,n,i){return t+(e-t)*i},e}(Rft)),Uft=function(t){function e(e){var n;return(n=t.call(this)||this)._props=void 0,n._props={},void 0!==e&&n.init(e),n}F(e,t);var n=e.prototype;return n.init=function(t){for(var e in t)this._props[e]=t[e];return!0},n.update=function(){var t=this._props,e=this.target;for(var n in t)e[n]=t[n]},n.clone=function(){var t=new e;return t.init(this._props),t},e}(Tft),kft=t("Tween",function(){function t(t){this._actions=[],this._finalAction=null,this._target=null,this._tag=yft.TAG_INVALID,this._target=void 0===t?null:t}var e=t.prototype;return e.tag=function(t){return this._tag=t,this},e.then=function(t){return t instanceof yft?this._actions.push(t.clone()):this._actions.push(t._union()),this},e.target=function(t){return this._target=t,this},e.start=function(){return this._target?(this._finalAction&&bft.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),bft.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(p("Please set target to tween first"),this)},e.stop=function(){return this._finalAction&&bft.instance.ActionManager.removeAction(this._finalAction),this},e.clone=function(t){var e=this._union();return Hft(t).then(e.clone())},e.union=function(){var t=this._union();return this._actions.length=0,this._actions.push(t),this},e.to=function(t,e,n){(n=n||Object.create(null)).relative=!1;var i=new Gft(t,e,n);return this._actions.push(i),this},e.by=function(t,e,n){(n=n||Object.create(null)).relative=!0;var i=new Gft(t,e,n);return this._actions.push(i),this},e.set=function(t){var e=new Uft(t);return this._actions.push(e),this},e.delay=function(t){var e=zft(t);return this._actions.push(e),this},e.call=function(t){var e=new Ift(t,undefined,undefined);return this._actions.push(e),this},e.sequence=function(){var e=t._wrappedSequence.apply(t,arguments);return this._actions.push(e),this},e.parallel=function(){var e=t._wrappedParallel.apply(t,arguments);return this._actions.push(e),this},e.repeat=function(e,n){if(e===1/0)return this.repeatForever(n);var i,r=this._actions;return i=n instanceof t?n._union():r.pop(),r.push(function(t,e){return new Mft(t,e)}(i,e)),this},e.repeatForever=function(e){var n,i=this._actions;return n=e instanceof t?e._union():i.pop(),i.push(function(t){return new Oft(t)}(n)),this},e.reverseTime=function(e){var n,i=this._actions;return n=e instanceof t?e._union():i.pop(),i.push(function(t){return new Vft(t)}(n)),this},e.hide=function(){var t=new wft;return this._actions.push(t),this},e.show=function(){var t=new Eft;return this._actions.push(t),this},e.removeSelf=function(){var t=new Pft(!1);return this._actions.push(t),this},t.stopAll=function(){bft.instance.ActionManager.removeAllActions()},t.stopAllByTag=function(t,e){bft.instance.ActionManager.removeAllActionsByTag(t,e)},t.stopAllByTarget=function(t){bft.instance.ActionManager.removeAllActionsFromTarget(t)},e._union=function(){var t=this._actions;return 1===t.length?t[0]:Bft(t)},e._destroy=function(){this.stop()},t._wrappedSequence=function(){var e=t._tmp_args;e.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=e[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof t&&(e[i]=r._union())}return Bft.apply(Bft,e)},t._wrappedParallel=function(){var e=t._tmp_args;e.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=e[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof t&&(e[i]=r._union())}return Lft.apply(Lft,e)},t}());function Hft(t){return new kft(t)}function jft(t){return p("tweenUtil' is deprecated, please use 'tween' instead "),new kft(t)}kft._tmp_args=[],i.Tween=kft,i.tween=Hft,i.tweenUtil=jft}}}));
